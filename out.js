(()=>{var Gl=Object.create;var El=Object.defineProperty;var Vl=Object.getOwnPropertyDescriptor;var Ul=Object.getOwnPropertyNames;var Hl=Object.getPrototypeOf,zl=Object.prototype.hasOwnProperty;var Wl=(l,e)=>()=>(e||l((e={exports:{}}).exports,e),e.exports);var Yl=(l,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Ul(e))!zl.call(l,r)&&r!==t&&El(l,r,{get:()=>e[r],enumerable:!(i=Vl(e,r))||i.enumerable});return l};var wl=(l,e,t)=>(t=l!=null?Gl(Hl(l)):{},Yl(e||!l||!l.__esModule?El(t,"default",{value:l,enumerable:!0}):t,l));var gl=Wl((DI,Za)=>{var pl=(function(){var l=String.fromCharCode,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",i={};function r(o,a){if(!i[o]){i[o]={};for(var h=0;h<o.length;h++)i[o][o.charAt(h)]=h}return i[o][a]}var s={compressToBase64:function(o){if(o==null)return"";var a=s._compress(o,6,function(h){return e.charAt(h)});switch(a.length%4){default:case 0:return a;case 1:return a+"===";case 2:return a+"==";case 3:return a+"="}},decompressFromBase64:function(o){return o==null?"":o==""?null:s._decompress(o.length,32,function(a){return r(e,o.charAt(a))})},compressToUTF16:function(o){return o==null?"":s._compress(o,15,function(a){return l(a+32)})+" "},decompressFromUTF16:function(o){return o==null?"":o==""?null:s._decompress(o.length,16384,function(a){return o.charCodeAt(a)-32})},compressToUint8Array:function(o){for(var a=s.compress(o),h=new Uint8Array(a.length*2),m=0,p=a.length;m<p;m++){var f=a.charCodeAt(m);h[m*2]=f>>>8,h[m*2+1]=f%256}return h},decompressFromUint8Array:function(o){if(o==null)return s.decompress(o);for(var a=new Array(o.length/2),h=0,m=a.length;h<m;h++)a[h]=o[h*2]*256+o[h*2+1];var p=[];return a.forEach(function(f){p.push(l(f))}),s.decompress(p.join(""))},compressToEncodedURIComponent:function(o){return o==null?"":s._compress(o,6,function(a){return t.charAt(a)})},decompressFromEncodedURIComponent:function(o){return o==null?"":o==""?null:(o=o.replace(/ /g,"+"),s._decompress(o.length,32,function(a){return r(t,o.charAt(a))}))},compress:function(o){return s._compress(o,16,function(a){return l(a)})},_compress:function(o,a,h){if(o==null)return"";var m,p,f={},N={},T="",C="",w="",E=2,P=3,S=2,A=[],_=0,L=0,W;for(W=0;W<o.length;W+=1)if(T=o.charAt(W),Object.prototype.hasOwnProperty.call(f,T)||(f[T]=P++,N[T]=!0),C=w+T,Object.prototype.hasOwnProperty.call(f,C))w=C;else{if(Object.prototype.hasOwnProperty.call(N,w)){if(w.charCodeAt(0)<256){for(m=0;m<S;m++)_=_<<1,L==a-1?(L=0,A.push(h(_)),_=0):L++;for(p=w.charCodeAt(0),m=0;m<8;m++)_=_<<1|p&1,L==a-1?(L=0,A.push(h(_)),_=0):L++,p=p>>1}else{for(p=1,m=0;m<S;m++)_=_<<1|p,L==a-1?(L=0,A.push(h(_)),_=0):L++,p=0;for(p=w.charCodeAt(0),m=0;m<16;m++)_=_<<1|p&1,L==a-1?(L=0,A.push(h(_)),_=0):L++,p=p>>1}E--,E==0&&(E=Math.pow(2,S),S++),delete N[w]}else for(p=f[w],m=0;m<S;m++)_=_<<1|p&1,L==a-1?(L=0,A.push(h(_)),_=0):L++,p=p>>1;E--,E==0&&(E=Math.pow(2,S),S++),f[C]=P++,w=String(T)}if(w!==""){if(Object.prototype.hasOwnProperty.call(N,w)){if(w.charCodeAt(0)<256){for(m=0;m<S;m++)_=_<<1,L==a-1?(L=0,A.push(h(_)),_=0):L++;for(p=w.charCodeAt(0),m=0;m<8;m++)_=_<<1|p&1,L==a-1?(L=0,A.push(h(_)),_=0):L++,p=p>>1}else{for(p=1,m=0;m<S;m++)_=_<<1|p,L==a-1?(L=0,A.push(h(_)),_=0):L++,p=0;for(p=w.charCodeAt(0),m=0;m<16;m++)_=_<<1|p&1,L==a-1?(L=0,A.push(h(_)),_=0):L++,p=p>>1}E--,E==0&&(E=Math.pow(2,S),S++),delete N[w]}else for(p=f[w],m=0;m<S;m++)_=_<<1|p&1,L==a-1?(L=0,A.push(h(_)),_=0):L++,p=p>>1;E--,E==0&&(E=Math.pow(2,S),S++)}for(p=2,m=0;m<S;m++)_=_<<1|p&1,L==a-1?(L=0,A.push(h(_)),_=0):L++,p=p>>1;for(;;)if(_=_<<1,L==a-1){A.push(h(_));break}else L++;return A.join("")},decompress:function(o){return o==null?"":o==""?null:s._decompress(o.length,32768,function(a){return o.charCodeAt(a)})},_decompress:function(o,a,h){var m=[],p,f=4,N=4,T=3,C="",w=[],E,P,S,A,_,L,W,x={val:h(0),position:a,index:1};for(E=0;E<3;E+=1)m[E]=E;for(S=0,_=Math.pow(2,2),L=1;L!=_;)A=x.val&x.position,x.position>>=1,x.position==0&&(x.position=a,x.val=h(x.index++)),S|=(A>0?1:0)*L,L<<=1;switch(p=S){case 0:for(S=0,_=Math.pow(2,8),L=1;L!=_;)A=x.val&x.position,x.position>>=1,x.position==0&&(x.position=a,x.val=h(x.index++)),S|=(A>0?1:0)*L,L<<=1;W=l(S);break;case 1:for(S=0,_=Math.pow(2,16),L=1;L!=_;)A=x.val&x.position,x.position>>=1,x.position==0&&(x.position=a,x.val=h(x.index++)),S|=(A>0?1:0)*L,L<<=1;W=l(S);break;case 2:return""}for(m[3]=W,P=W,w.push(W);;){if(x.index>o)return"";for(S=0,_=Math.pow(2,T),L=1;L!=_;)A=x.val&x.position,x.position>>=1,x.position==0&&(x.position=a,x.val=h(x.index++)),S|=(A>0?1:0)*L,L<<=1;switch(W=S){case 0:for(S=0,_=Math.pow(2,8),L=1;L!=_;)A=x.val&x.position,x.position>>=1,x.position==0&&(x.position=a,x.val=h(x.index++)),S|=(A>0?1:0)*L,L<<=1;m[N++]=l(S),W=N-1,f--;break;case 1:for(S=0,_=Math.pow(2,16),L=1;L!=_;)A=x.val&x.position,x.position>>=1,x.position==0&&(x.position=a,x.val=h(x.index++)),S|=(A>0?1:0)*L,L<<=1;m[N++]=l(S),W=N-1,f--;break;case 2:return w.join("")}if(f==0&&(f=Math.pow(2,T),T++),m[W])C=m[W];else if(W===N)C=P+P.charAt(0);else return null;w.push(C),m[N++]=P+C.charAt(0),f--,P=C,f==0&&(f=Math.pow(2,T),T++)}}};return s})();typeof define=="function"&&define.amd?define(function(){return pl}):typeof Za<"u"&&Za!=null?Za.exports=pl:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return pl})});var Se=class{constructor(e,t,i){this.id=e,this.spriteName=t,this.brainId=i}};var n={};n.time={defaultFramesPerSecond:60,defaultMillisPerFrame:1e3/60,turnsPerSecond:4,secondsPerTurn:.25,millisPerTurn:250,turnFrames:15};n.target={minTargetRow:5};n.damage={baseDamagePerSecond:30,baseDamagePerTurn:30*n.time.secondsPerTurn};n.tile={size:16,halfSize:8,halfSizeSquared:64,threeQuarterSize:12,quarterSize:4,eighthSize:2,doubleSize:32};n.skillGraph={cellWidth:260,cellHeight:110,connectorOffsetX:100,connectorOffsetY:40,minZoom:20,maxZoom:100,zoomStep:10,nodeViewWidth:180};n.physics={gravityRatePerFrame:4,walkRatePerFrame:2,jumpRatePerFrame:2};n.character={jumpPower:2.5*n.tile.size,maxJumpPixelsPerFrame:2,halfWidth:5};n.combat={critialHitMultiplier:1.5};n.input={panning:{decayFactor:.95}};n.projection={zoomInScaleLimit:8,zoomOutScaleLimit:1.5,zoomDefault:2,zoomStep:.25,startCenterX:0,startCenterY:0};n.text={maxInfoTextCount:7,maxDamageTextCount:4,textFrameDuration:45};n.grid={numZoneColsInGrid:3,numZoneRowsInGrid:3,numRegionColsInZone:2,numRegionRowsInZone:2,numTileColsInRegion:5,numTileRowsInRegion:5};n.grid.regionTileWidth=n.grid.numTileColsInRegion;n.grid.regionTileHeight=n.grid.numTileRowsInRegion;n.grid.zoneTileWidth=n.grid.numRegionColsInZone*n.grid.regionTileWidth;n.grid.zoneTileHeight=n.grid.numRegionRowsInZone*n.grid.regionTileHeight;n.grid.gridTileWidth=n.grid.numZoneColsInGrid*n.grid.zoneTileWidth;n.grid.gridTileHeight=n.grid.numZoneRowsInGrid*n.grid.zoneTileHeight;n.grid.regionPixelWidth=n.grid.regionTileWidth*n.tile.size;n.grid.regionPixelHeight=n.grid.regionTileHeight*n.tile.size;n.grid.zonePixelWidth=n.grid.zoneTileWidth*n.tile.size;n.grid.zonePixelHeight=n.grid.zoneTileHeight*n.tile.size;n.grid.gridPixelWidth=n.grid.gridTileWidth*n.tile.size;n.grid.gridPixelHeight=n.grid.gridTileHeight*n.tile.size;n.start={startX:2e4,startY:-100*n.tile.size};n.effect={effectTravelPixlesPerFrame:5.5,fastEffectTravelPixelsPerFrame:6.5,slowEffectTravelPixelsPerFrame:3,lightningFrames:n.time.turnFrames*2};n.lighting={lightSourceRadius:5};n.skill={};n.bonus={newBonusTurns:n.time.turnsPerSecond*900,activationTurns:n.time.turnsPerSecond*300,activationCost:1e3};n.prestige={multiplierPerPrestige:.2,incrementBonusPerUpgrade:.2,baseBonusPerUpgrade:.2};n.depth={multiplierPerDepth:.025,incrementBonusPerUpgrade:.025,baseBonusPerUpgrade:.025};n.minedDamage={incrementBonusPerUpgrade:.5,baseBonusPerUpgrade:.5};n.gold={upgradeBaseCost:25e3,damageMultiplierPerUpgrade:10,oreBonusMultiplierPerUpgrade:10};n.skill.costs={addDrill1:0,addOrbit1:1,addMissile1:2,addLaser1:3,addMiner1:5,addMiner2:20,addMiner3:40,addMiner4:60,increment:2};n.skill.fissure={delayMillis:2500,forkChance:75,secondForkChance:85,minBlocks:3,blocksPerUpgrade:2};n.skill.lightning={minRange:3,delayMillis:2500,forkChance:75,secondForkChance:85,minBlocks:3,blocksPerUpgrade:1,tilesPerUpgrade:1};n.skill.chain={minRange:3,minSize:3,delayMillis:2500,blocksPerUpgrade:1,tilesPerUpgrade:1};n.skill.laser={minRange:3,tilesPerUpgrade:1};n.skill.drill={minRange:3,tilesPerUpgrade:1};n.skill.missiles={initialMissiles:5,missilesPerUpgrade:3};n.skill.orbit={minRangePixels:2*n.tile.size,rangePixelsPerUpgrade:n.tile.halfSize};n.skill.bonus={oreBonusMultiplierPerUpgrade:10,additiveUpgradeBonusMultiplerPerUpgrade:2,multiplicativeUpgradeBonusMultiplerPerUpgrade:10,minedOreBaseTiles:5,minedOreBonusPerUpgrade:1};n.skill.common={damagePercentPerUpgrade:25,damagePerUpgrade:.25,baseActivationTurns:n.time.turnsPerSecond*10,baseCoolDownTurns:n.time.turnsPerSecond*60,activationSecondsPerUpgrade:3,coolDownSecondsPerUpgrade:5,activationTurnsPerUpgrade:n.time.turnsPerSecond*3,coolDownTurnsPerUpgrade:n.time.turnsPerSecond*5};n.automation={minDelayTurns:n.time.turnsPerSecond*2,baseUpgradeDelayTurns:n.time.turnsPerSecond*61,turnsPerRateUpgrade:n.time.turnsPerSecond*5,prestigeUpgradeDelayTurns:n.time.turnsPerSecond*3660,prestigeTurnsPerRateUpgrade:n.time.turnsPerSecond*300,prestigeMinTurnsSinceLastChange:n.time.turnsPerSecond*600,secondsPerRateUpgrade:5,minutesPerPrestigeRateUpgrade:5};n.offline={defaultOfflineMinutes:30,defaultOfflineTurns:1800*n.time.turnsPerSecond,minutesPerUpgrade:30,turnsPerUpgrade:30*(60*n.time.turnsPerSecond)};var ti=class{constructor(e,t){this.spriteX=e,this.spriteY=t}getImage(){}getSize(){return n.tile.size}};var mt=class{constructor(){this.finishedAndAvailable=!0,this.listener=null}isFinishedAndAvailable(){return this.finishedAndAvailable}reset(e){this.finishedAndAvailable!=e&&this.listener&&this.listener.onAvailabilityChanged(e),this.finishedAndAvailable=e}setCycleCacheListener(e){this.listener=e}};var b=class l{constructor(e,t){this.x=e,this.y=t}set(e,t){this.x=e,this.y=t}copy(e){this.x=e.x,this.y=e.y}clone(){return new l(this.x,this.y)}add(e){this.x+=e.x,this.y+=e.y}addXY(e,t){this.x+=e,this.y+=t}subtract(e){this.x-=e.x,this.y-=e.y}subtractXY(e,t){this.x-=e,this.y-=t}scale(e){this.x*=e,this.y*=e}distance(e){let t=e.x-this.x,i=e.y-this.y;return Math.sqrt(t*t+i*i)}distanceSquared(e){let t=e.x-this.x,i=e.y-this.y;return t*t+i*i}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}equals(e){return e&&this.x===e.x&&this.y===e.y}toString(){return"("+this.x+", "+this.y+")"}hash(){let e=23;return e=e*31+this.x,e=e*31+this.y,e}};var pt=class{constructor(e){this.origin=e}getOrigin(){return this.origin}getPixelWidth(){return 0}getPixelHeight(){return 0}getOriginTileCol(){return this.origin.x/n.tile.size}getOriginTileRow(){return this.origin.y/n.tile.size}contains(e){return e.x>=this.origin.x&&e.x<this.origin.x+this.getPixelWidth()&&e.y>=this.origin.y&&e.y<this.origin.y+this.getPixelHeight()}containsXY(e,t){return e>=this.origin.x&&e<this.origin.x+this.getPixelWidth()&&t>=this.origin.y&&t<this.origin.y+this.getPixelHeight()}intersects(e,t,i){return!(e+i<this.origin.x||e-i>this.origin.x+this.getPixelWidth()||t+i<this.origin.y||t-i>this.origin.y+this.getPixelHeight())}};var vi=class{constructor(e,t){this.m=e,this.e=t}set(e,t){return this.m=e,this.e=t,this}setZero(){return this.m=0,this.e=0,this}copy(e){return typeof e=="number"&&(console.log("ManExp.copy() passed number instead of ManExp"),console.trace()),this.m=e.m,this.e=e.e,this}lessThan(e){return typeof e=="number"&&(console.log("ManExp.lessThan() passed number instead of ManExp"),console.trace()),this.m===0?e.m>0:e.m===0?this.m<=0:this.e===e.e?this.m<e.m:this.m>0?e.m>0&&this.e<e.e:e.m>0||this.e>e.e}lessThanEquals(e){return!this.greaterThan(e)}greaterThan(e){return typeof e=="number"&&(console.log("ManExp.greaterThan() passed number instead of ManExp"),console.trace()),this.m===0?e.m<0:e.m===0?this.m>0:this.e===e.e?this.m>e.m:this.m>0?e.m<0||this.e>e.e:e.m<0&&this.e<e.e}greaterThanEquals(e){return!this.lessThan(e)}compare(e){if(typeof e=="number"&&(console.log("ManExp.compare() passed number instead of ManExp"),console.trace()),this.m===0){if(e.m===0)return 0;if(e.m<0)return 1;if(e.m>0)return-1}if(e.m===0){if(this.m<0)return-1;if(this.m>0)return 1}if(this.m>0)return e.m<0||this.e>e.e?1:this.e<e.e?-1:this.m>e.m?1:this.m<e.m?-1:0;if(this.m<0)return e.m>0||this.e>e.e?-1:this.e<e.e||this.m>e.m?1:this.m<e.m?-1:0}equals(e){return this.e===e.e&&this.m===e.m}equalsZero(){return this.e===0&&this.m===0}};var ii=17,Kt=9e15,al=308,xi=-324,Kl=1e-10,Cl=[];for(let l=xi+1;l<=al;l++)Cl.push(+("1e"+l));var ee=class l{constructor(){}static powerOf10(e){return Cl[e+323]}static fromNumber(e,t){return isNaN(t)?(e.m=Number.NaN,e.e=Number.NaN):t===Number.POSITIVE_INFINITY?(e.m=1,e.e=Kt):t===Number.NEGATIVE_INFINITY?(e.m=-1,e.e=Kt):t===0?(e.m=0,e.e=0):(e.e=Math.floor(Math.log10(Math.abs(t))),e.m=e.e===xi?t*10/1e-323:t/l.powerOf10(e.e),l.normalize(e)),e}static negate(e){return typeof value=="number"&&(console.log("BigNumMath.negate() passed number instead of BigNum"),console.trace()),e.m=-e.m,e}static copy(e,t){return typeof t=="number"&&(console.log("BigNumMath.copy() passed number instead of BigNum"),console.trace()),e.m=t.m,e.e=t.e,e}static normalize(e){if(e.m>=1&&e.m<10)return e;if(e.m===0)return e.m=0,e.e=0,e;let t=Math.floor(Math.log10(Math.abs(e.m)));return e.m=t===xi?e.m*10/1e-323:e.m/l.powerOf10(t),e.e+=t,e}static multiply(e,t){return typeof t=="number"&&(console.log("BigNumMath.multiply() passed number instead of BigNum"),console.trace()),e.m*=t.m,e.e+=t.e,l.normalize(e)}static add(e,t){if(typeof t=="number"&&(console.log("BigNumMath.add() passed number instead of BigNum"),console.trace()),e.m===0)return e.m=t.m,e.e=t.e,e;if(t.m===0)return e;let i,r,s,o;if(e.e>=t.e?(i=e.m,r=e.e,s=t.m,o=t.e):(i=t.m,r=t.e,s=e.m,o=e.e),r-o>ii)return e.m=i,e.e=r,e;let a=Math.round(1e14*i+1e14*s*l.powerOf10(o-r));return e.m=a,e.e=r-14,l.normalize(e)}static log10(e){return typeof e=="number"&&(console.log("BigNumMath.log10() passed number instead of BigNum"),console.trace()),e.e+Math.log10(e.m)}static log2(e){return 3.321928094887362*l.log10(e)}static ln(e){return 2.302585092994045*l.log10(e)}static log(e,t){return Math.LN10/Math.log(t)*l.log10(e)}static pow10(e,t){return Number.isInteger(t)?(e.set(1,t),e):(e.set(Math.pow(10,t%1),Math.trunc(t)),l.normalize(e))}static pow(e,t){let i=t,r=e.e*i,s;if(Number.isSafeInteger(r)&&(s=Math.pow(e.m,i),isFinite(s)&&s!==0))return e.m=s,e.e=r,l.normalize(e);let o=Math.trunc(r),a=r-o;return s=Math.pow(10,i*Math.log10(e.m)+a),isFinite(s)&&s!==0?(e.m=s,e.e=o,l.normalize(e)):(l.pow10(e,i*l.absLog10(e)),l.sign(e)===-1?Math.abs(i%2)===1?l.negate(e):(Math.abs(i%2)===0||(e.m=Number.NaN,e.e=Number.NaN),e):e)}static toString(e){return typeof e=="number"&&(console.log("BigNumMath.toString() passed number instead of BigNum"),console.trace()),isNaN(e.m)||isNaN(e.e)?"NaN":e.e>=Kt?e.m>0?"Infinity":"-Infinity":e.e<=-Kt||e.m===0?"0":e.e<21&&e.e>-7?l.toNumber(e).toString():e.m+"e"+(e.e>=0?"+":"")+e.e}static toNumber(e){if(typeof e=="number"&&(console.log("BigNumMath.toNumber() passed number instead of BigNum"),console.trace()),!isFinite(e.e))return Number.NaN;if(e.e>al)return e.m>0?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY;if(e.e<xi)return 0;if(e.e===xi)return e.m>0?5e-324:-5e-324;let t=e.m*l.powerOf10(e.e);if(!isFinite(t)||e.e<0)return t;let i=Math.round(t);return Math.abs(i-t)<Kl?i:t}static toExponential(e,t){if(typeof e=="number"&&(console.log("BigNumMath.toExponential() passed number instead of BigNum"),console.trace()),isNaN(e.m)||isNaN(e.e))return"NaN";if(e.e>=Kt)return e.m>0?"Infinity":"-Infinity";if(e.e<=-Kt||e.m===0)return"0"+(t>0?l.padEnd(".",t+1,"0"):"")+"e+0";if(e.e>xi&&e.e<al)return l.toNumber(e).toExponential(t);isFinite(t)||(t=ii);let i=t+1,r=Math.max(1,Math.ceil(Math.log10(Math.abs(e.m))));return(Math.round(e.m*Math.pow(10,i-r))*Math.pow(10,r-i)).toFixed(Math.max(i-r,0))+"e"+(e.e>=0?"+":"")+e.e}static toFixed(e,t){return typeof e=="number"&&(console.log("BigNumMath.toFixed() passed number instead of BigNum"),console.trace()),isNaN(e.m)||isNaN(e.e)?"NaN":e.e>=Kt?e.m>0?"Infinity":"-Infinity":e.e<=-Kt||e.m===0?"0"+(t>0?l.padEnd(".",t+1,"0"):""):e.e>=ii?e.m.toString().replace(".","").padEnd(e.e+1,"0")+(t>0?l.padEnd(".",t+1,"0"):""):l.toNumber(e).toFixed(t)}static toPrecision(e,t){return typeof e=="number"&&(console.log("BigNumMath.toPrecision() passed number instead of BigNum"),console.trace()),e.e<=-7?l.toExponential(e,t-1):t>e.e?l.toFixed(e,t-e.e-1):l.toExponential(e,t-1)}static valueOf(e){return l.toString(e)}static toJSON(e){return l.toString(e)}static toStringWithDecimalPlaces(e,t){return l.toExponential(e,t)}static abs(e){return typeof value=="number"&&(console.log("BigNumMath.abs() passed number instead of BigNum"),console.trace()),e.m=Math.abs(e.m),e}static sign(e){return typeof e=="number"&&(console.log("BigNumMath.sign() passed number instead of BigNum"),console.trace()),Math.sign(e.m)}static round(e){return e.e<-1?e.setZero():e.e<ii?l.fromNumber(e,Math.round(l.toNumber(e))):e}static floor(e){return e.e<-1?Math.sign(e.m)>=0?e.setZero():l.fromNumber(e,-1):e.e<ii?l.fromNumber(e,Math.floor(l.toNumber(e))):e}static ceil(e){return e.e<-1?Math.sign(e.m)>0?l.fromNumber(e,1):e.setZero():e.e<ii?l.fromNumber(e,Math.ceil(l.toNumber(e))):e}static trunc(e){return e.e<0?e.setZero():e.e<ii?l.fromNumber(e,Math.trunc(l.toNumber(e))):e}static recip(e){return e.m=1/e.m,e.e=-e.e,l.normalize(e)}static absLog10(e){return e.e+Math.log10(Math.abs(e.m))}static padEnd(e,t,i){if(e==null||t==null)return e;let r=String(e),s=typeof t=="number"?t:parseInt(t,10);if(isNaN(s)||!isFinite(s))return r;let o=r.length;if(o>=s)return r;let a=i==null?"":String(i);a===""&&(a=" ");let h=s-o;for(;a.length<h;)a+=a;let m=a.length>h?a.substr(0,h):a;return r+m}};var pe=new vi(0,0),d=class l extends vi{constructor(e){super(0,0),this.setValue(e)}setValue(e){return ee.fromNumber(this,e),this}multiplyNumber(e){return e instanceof l&&(console.log("BigNum.multiplyNumber() passed BigNum instead of number"),console.trace()),ee.fromNumber(pe,e),ee.multiply(this,pe)}mulNumber(e){return this.multiplyNumber(e)}multiply(e){return ee.multiply(this,e)}mul(e){return this.multiply(e)}addNumber(e){return e instanceof l&&(console.log("BigNum.addNumber() passed BigNum instead of number"),console.trace()),ee.fromNumber(pe,e),ee.add(this,pe)}add(e){return ee.add(this,e)}subNumber(e){return e instanceof l&&(console.log("BigNum.subNumber() passed BigNum instead of number"),console.trace()),ee.fromNumber(pe,-e),ee.add(this,pe)}subtractNumber(e){return this.subNumber(e)}sub(e){return ee.copy(pe,e),ee.negate(pe),ee.add(this,pe)}subtract(e){return this.sub(e)}recip(){return ee.recip(this)}divideNumber(e){return e instanceof l&&(console.log("BigNum.divideNumber() passed BigNum instead of number"),console.trace()),ee.fromNumber(pe,e),ee.recip(pe),ee.multiply(this,pe)}divNumber(e){return this.divideNumber(e)}divide(e){return ee.copy(pe,e),ee.recip(pe),ee.multiply(this,pe)}div(e){return this.divide(e)}round(){return ee.round(this)}floor(){return ee.floor(this)}ceil(){return ee.ceil(this)}trunc(){return ee.trunc(this)}abs(){return ee.abs(this)}log10(){return ee.log10(this)}log2(){return ee.log2(this)}ln(){return ee.ln(this)}log(e){return ee.log(this,e)}pow(e){return ee.pow(this,e)}toString(){return ee.toString(this)}toDebugString(){return this.toString()+", (m="+this.m+", e="+this.e+")"}toNumber(){return ee.toNumber(this)}toExponential(e){return ee.toExponential(this,e)}toFixed(e){return ee.toFixed(this,e)}toPrecision(e){return ee.toPrecision(this,e)}valueOf(){return ee.valueOf(this)}toJSON(){return ee.toJSON(this)}toStringWithDecimalPlaces(e){return ee.toStringWithDecimalPlaces(this,e)}sign(){return ee.sign(this)}equalsNumber(e){return e instanceof l&&(console.log("BigNum.equalsNumber() passed BigNum instead of number"),console.trace()),ee.fromNumber(pe,e),this.equals(pe)}lessThanNumber(e){return e instanceof l&&(console.log("BigNum.lessThanNumber() passed BigNum instead of number"),console.trace()),ee.fromNumber(pe,e),this.lessThan(pe)}lessThanZero(){return pe.setZero(),this.lessThan(pe)}lessThanEqualsZero(){return pe.setZero(),!this.greaterThan(pe)}lessThanEqualsNumber(e){return e instanceof l&&(console.log("BigNum.lessThanEqualsNumber() passed BigNum instead of number"),console.trace()),ee.fromNumber(pe,e),this.lessThanEquals(pe)}greaterThanNumber(e){return e instanceof l&&(console.log("BigNum.greaterThanNumber() passed BigNum instead of number"),console.trace()),ee.fromNumber(pe,e),this.greaterThan(pe)}greaterThanEqualsNumber(e){return e instanceof l&&(console.log("BigNum.greaterThanEqualsNumber() passed BigNum instead of number"),console.trace()),ee.fromNumber(pe,e),!this.lessThan(pe)}equalsZero(){return pe.setZero(),this.equals(pe)}greaterThanZero(){return pe.setZero(),this.greaterThan(pe)}greaterThanEqualsZero(){return pe.setZero(),!this.lessThan(pe)}};var dr=class{constructor(){this.working=new d(0),this.hundredThousand=new d(1e5),this.noDecimalPlacesOptions={maximumFractionDigits:0}}formatNumber(e){return e<1e5?this.formatSmallNumber(e):(ee.fromNumber(this.working,e),this.bigNumToGameString(this.working))}formatBigNum(e){return e.lessThan(this.hundredThousand)?this.formatSmallNumber(e.toNumber()):this.bigNumToGameString(e)}formatSmallNumber(e){return e<100?Number.isInteger(e)?e.toFixed(0):e.toFixed(2):e<1e3?Number.isInteger(e)?e.toFixed(0):e.toFixed(1):e.toLocaleString(void 0,this.noDecimalPlacesOptions)}bigNumToGameString(e){return typeof e=="number"&&(console.log("BigNumMath.toGameString() passed number instead of BigNum"),console.trace()),isNaN(e.m)||isNaN(e.e)?"NaN":e.e<10?e.m.toFixed(3)+"E"+e.e:e.e<100?e.m.toFixed(2)+"E"+e.e:e.m.toFixed(1)+"E"+e.e}};var Sl=new dr,I=class{constructor(){}static formatBigNum(e){return typeof e=="number"&&(console.log("NumberFormatter.formatBigNum() passed number instead of BigNum"),console.trace()),e?Sl.formatBigNum(e):"0"}static formatNumber(e){return e instanceof d&&(console.log("NumberFormatter.formatNumber() passed BigNum instead of number"),console.trace()),Sl.formatNumber(e)}};var R={UNSET:0,COMMON:1,ORE:2,GOLD:3,UPGRADE:4,RUBY:5};var hr=new d(0),Xt=class{constructor(e,t){this.primaryTileType=e,this.id=e.id,this.name=e.name,this.nominalIndex=t,this.iconFileName=e.iconFileName,this.minDepth=0,this.maxDepth=0,this.oreStep=new d(0),this.baseOre=new d(0),this.healthStep=new d(0),this.baseHealth=new d(0),this.baseGold=null,this.additiveBonusFactor=0,this.multiplicativeBonusFactor=0,this.maxHealth=new d(0),this.oreTileType=pr(e),this.goldTileType=ur(e),this.upgradeTileType=mr(e),this.rubyTileType=cr(e),this.prevLayer=null,this.nextLayer=null,this.monsterDescriptions=[],e.layerDescription&&console.log("LayerDescription ERROR: primary tile type already has a layer desc. Tile Reuse? layer: "+this.id+" tileType="+e.id),e.layerDescription=this,this.oreTileType&&(this.oreTileType.layerDescription&&console.log("LayerDescription ERROR: ore tile type already has a layer desc. Tile Reuse? layer: "+this.id+" tileType="+this.oreTileType.id),this.oreTileType.rarityModifier!==R.ORE&&console.log("LayerDescription ERROR layer="+this.name+": ORE tile type with rarity: "+this.oreTileType.rarityModifier),this.oreTileType.layerDescription=this),this.goldTileType&&(this.goldTileType.layerDescription&&console.log("LayerDescription ERROR: GOLD tile type already has a layer desc. Tile Reuse? layer: "+this.id+" tileType="+this.goldTileType.id),this.goldTileType.rarityModifier!==R.GOLD&&console.log("LayerDescription ERROR layer="+this.name+": GOLD tile type with rarity: "+this.goldTileType.rarityModifier),this.goldTileType.layerDescription=this),this.upgradeTileType&&(this.upgradeTileType.layerDescription&&console.log("LayerDescription ERROR: upgrade tile type already has a layer desc. Tile Reuse? "+this.id+" tileType="+this.upgradeTileType.id),this.upgradeTileType.rarityModifier!==R.UPGRADE&&console.log("LayerDescription ERROR layer="+this.name+": UPGRADE tile type with rarity: "+this.upgradeTileType.rarityModifier),this.upgradeTileType.layerDescription=this),this.rubyTileType&&(this.rubyTileType.layerDescription&&console.log("LayerDescription ERROR: RUBY tile type already has a layer desc. Tile Reuse? "+this.id+" tileType="+this.rubyTileType.id),this.rubyTileType.rarityModifier!==R.RUBY&&console.log("LayerDescription ERROR layer="+this.name+": RUBY tile type with rarity: "+this.rubyTileType.rarityModifier),this.rubyTileType.layerDescription=this)}isDeeperThan(e){return this.minDepth>e.minDepth}getDepthPercent(e){if(e<=this.minDepth)return 0;if(e>=this.maxDepth)return 100;let t=e-this.minDepth,i=this.maxDepth-this.minDepth;return t/i*100}initializeLayerValues(e,t,i,r,s){this.oreStep.copy(r),this.healthStep.copy(s),this.baseGold=new d(e),this.additiveBonusFactor=t,this.multiplicativeBonusFactor=i}initializeLayer(e,t){if(this.prevLayer=e,this.prevLayer&&(this.prevLayer.nextLayer=this),this.minDepth=e.maxDepth,t===-1?this.maxDepth=this.minDepth+1e7:this.maxDepth=this.minDepth+t,e){let i=e.maxDepth-e.minDepth;this.baseHealth.setValue(i),this.baseHealth.mul(e.healthStep),this.baseHealth.add(e.baseHealth),this.baseHealth.add(this.healthStep),this.baseOre.setValue(i),this.baseOre.mul(e.oreStep),this.baseOre.add(e.baseOre),this.baseOre.add(this.oreStep)}else this.baseHealth.setValue(1),this.baseOre.setValue(1);this.calculateTileHealth(this.maxDepth,this.maxHealth),console.log("Layer: "+this.name+" minDepth="+this.minDepth+" maxDepth="+this.maxDepth+" baseHealth="+I.formatBigNum(this.baseHealth)+" maxHealth="+I.formatBigNum(this.maxHealth)+" baseOre="+I.formatBigNum(this.baseOre))}calculateTileOre(e,t){let i=Math.max(1,e)-this.minDepth;i<=0?t.copy(this.baseOre):(t.copy(this.oreStep),t.mulNumber(i),t.add(this.baseOre))}calculateTileHealth(e,t){let i=Math.max(1,e)-this.minDepth;i<=0?t.copy(this.baseHealth):(t.copy(this.healthStep),t.mulNumber(i),t.add(this.baseHealth))}calculateTileDepth(e){return e.lessThanEquals(this.baseHealth)?this.minDepth:e.greaterThanEquals(this.maxHealth)?this.maxDepth:(hr.copy(e),hr.sub(this.baseHealth),hr.div(this.healthStep),hr.addNumber(this.minDepth),Math.max(0,hr.toNumber()|0))}containsRow(e){return this.maxDepth<=e&&this.maxDepth>e}};var it=class{constructor(e,t){this.fileName=e,this.loaded=!1,this.spriteSize=t;let i=this;this.image=new Image,this.image.onload=function(){i.populateSpriteMap()}}loadImage(){this.image.src=this.fileName}populateSpriteMap(){}};var gr=class{constructor(){this.defaultFrameIncrement=0,this.defaultElapsedFrameCount=0,this.defaultAnimationFramesPerFrame=30,this.defaultMillisPerFrame=150,this.slowMillisPerFrame=250,this.fastMillisPerFrame=80,this.superFastMillisPerFrame=30}updateForFrame(e){this.defaultElapsedFrameCount+=e,this.defaultElapsedFrameCount>=this.defaultAnimationFramesPerFrame&&(this.defaultFrameIncrement++,this.defaultElapsedFrameCount=0,this.defaultFrameIncrement>=5e4&&(this.defaultFrameIncrement=0))}getDefaultFrameIndex(e){return this.defaultFrameIncrement%e|0}getFrameIndex(e,t,i,r){return this.getFrameIndexInternal(e,t,i,r,this.defaultMillisPerFrame)}getFastFrameIndex(e,t,i,r){return this.getFrameIndexInternal(e,t,i,r,this.fastMillisPerFrame)}getSlowFrameIndex(e,t,i,r){return this.getFrameIndexInternal(e,t,i,r,this.slowMillisPerFrame)}getSuperFastFrameIndex(e,t,i,r){return this.getFrameIndexInternal(e,t,i,r,this.superFastMillisPerFrame)}getFrameIndexInternal(e,t,i,r,s){let o=this.calculateElapsedFrameCount(e,t,s);return r?o%i|0:o<i?o:-1}calculateElapsedFrameCount(e,t,i){return Math.max(0,e-t)/i|0}isDefaultAnimationLoopCompleted(e,t,i){return this.calculateElapsedFrameCount(e,t,this.defaultMillisPerFrame)>=i}isFastAnimationLoopCompleted(e,t,i){return this.calculateElapsedFrameCount(e,t,this.fastMillisPerFrame)>=i}isSuperFastAnimationLoopCompleted(e,t,i){return this.calculateElapsedFrameCount(e,t,this.superFastMillisPerFrame)>=i}};var gt=class{constructor(e,t,i,r){this.sprites=e,this.spriteAnimationManager=t,this.fastAnimation=i,this.loopingAnimation=r}getSpriteAsOf(e,t){return this.sprites.length===1?this.sprites[0]:this.fastAnimation?this.getFastCurrentSpriteAsOf(e,t):this.getCurrentSpriteAsOf(e,t)}getSpriteAtIndex(e){return e<0||e>=this.sprites.length?null:this.sprites[e]}getCurrentSpriteDefault(){let e=this.spriteAnimationManager.getDefaultFrameIndex(this.sprites.length);return this.sprites[e]}getCurrentSpriteAsOf(e,t){let i=this.spriteAnimationManager.getFrameIndex(e,t,this.sprites.length,this.loopingAnimation);return i<0?null:this.sprites[i]}getCurrentSpriteAsOfNoLooping(e,t){let i=this.spriteAnimationManager.getFrameIndex(e,t,this.sprites.length,!1);return i<0?null:this.sprites[i]}getSlowCurrentSpriteAsOfNoLooping(e,t){let i=this.spriteAnimationManager.getSlowFrameIndex(e,t,this.sprites.length,!1);return i<0?null:this.sprites[i]}getFastCurrentSpriteAsOf(e,t){let i=this.spriteAnimationManager.getFastFrameIndex(e,t,this.sprites.length,this.loopingAnimation);return i<0?null:this.sprites[i]}getSuperFastCurrentSpriteAsOf(e,t){let i=this.spriteAnimationManager.getSuperFastFrameIndex(e,t,this.sprites.length,this.loopingAnimation);return i<0?null:this.sprites[i]}isAnimationLoopCompleted(e){return this.fastAnimation?this.spriteAnimationManager.isFastAnimationLoopCompleted(Date.now(),e,this.sprites.length):this.spriteAnimationManager.isDefaultAnimationLoopCompleted(Date.now(),e,this.sprites.length)}getDirectionSprite(e){return this.sprites[e]}isDirectionalSprite(){return!1}};var Me=class extends ti{constructor(e,t,i){super(t,i),this.spritesheet=e}getImage(){return this.spritesheet.image}getSize(){return this.spritesheet.spriteSize}};var vt=class extends it{constructor(e,t){super(e,t),this.step=this.calculateSpriteStep(t)}calculateSpriteStep(e){}parseRow(e,t){let i=[],r=e*this.step,s=0;for(let o=0;o<t;o++)i.push(new Me(this,s,r)),s+=this.step;return i}};var Q={STAND:"0",WALK:"1",JUMP:"2",FALL:"3",MINE:"4",ATTACK:"5"};var fr=class extends vt{constructor(e,t,i){super(e,t),this.spriteAnimationManager=i,this.defaultAnimation=null,this.spriteAnimationMap={},this.loadImage()}getSpriteAnimation(e){let t=this.spriteAnimationMap[e];return t||this.defaultAnimation}calculateSpriteStep(e){return e+1}populateSpriteMap(){let e=0;this.defaultAnimation=this.populateSpriteAnimation(e++,1,!1,!0),this.spriteAnimationManager[Q.STAND]=this.defaultAnimation,this.spriteAnimationManager[Q.FALL]=this.defaultAnimation,this.spriteAnimationManager[Q.MINE]=this.defaultAnimation,this.spriteAnimationManager[Q.ATTACK]=this.defaultAnimation,this.spriteAnimationManager[Q.JUMP]=this.populateSpriteAnimation(e++,1,!1,!0),this.spriteAnimationManager[Q.WALK]=this.populateSpriteAnimation(e++,2,!1,!0),this.loaded=!0}populateSpriteAnimation(e,t,i,r){let s=this.parseRow(e,t);return new gt(s,this.spriteAnimationManager,i,r)}};var Tr=class extends it{constructor(e,t){super(e,t),this.goldRow=0,this.oreRow=1,this.rubyRow=2,this.upgradeRow=3,this.loadImage()}populateSpriteMap(){let e=4;this.loadTileType(ge.SKY,e),e++,this.loadTileTypePlusSpecial(ge.GRASS,e),e++,this.loadTileTypePlusSpecial(ge.DIRT,e),e++;for(let t=0;t<ft.length;t++)this.loadTileTypePlusSpecial(ft[t],e),e++;this.loaded=!0}loadTileTypePlusSpecial(e,t){this.loadTileType(e,t),this.loadTileType(ur(e),this.goldRow),this.loadTileType(pr(e),this.oreRow),this.loadTileType(mr(e),this.upgradeRow),this.loadTileType(cr(e),this.rubyRow)}loadTileType(e,t){let i=(this.spriteSize+1)*16,r=0,s=i,o=2*i;e.tileTemplate=this.parseTileTemplate(r,t),e.tileTemplate2=this.parseTileTemplate(s,t),e.tileTemplate3=this.parseTileTemplate(o,t)}parseTileTemplate(e,t){let i=this.spriteSize+1,r=t*i,s=new Er;return s.northBorder=new Me(this,e,r),e+=i,s.eastBorder=new Me(this,e,r),e+=i,s.southBorder=new Me(this,e,r),e+=i,s.westBorder=new Me(this,e,r),e+=i,s.northEastBorder=new Me(this,e,r),e+=i,s.northSouthBorder=new Me(this,e,r),e+=i,s.northWestBorder=new Me(this,e,r),e+=i,s.southEastBorder=new Me(this,e,r),e+=i,s.eastWestBorder=new Me(this,e,r),e+=i,s.southWestBorder=new Me(this,e,r),e+=i,s.northEastSouthBorder=new Me(this,e,r),e+=i,s.northSouthWestBorder=new Me(this,e,r),e+=i,s.northEastWestBorder=new Me(this,e,r),e+=i,s.eastWestSouthBorder=new Me(this,e,r),e+=i,s.northEastSouthWestBorder=new Me(this,e,r),e+=i,s.noBorder=new Me(this,e,r),s}};var wr=class{constructor(){this.sprites=[]}};var Cr=class extends it{constructor(e,t){super(e,t),this.loadImage()}populateSpriteMap(){let e=4;this.loadTileType(ge.SKY,e),e++,this.loadTileType(ge.GRASS,e),e++,this.loadTileType(ge.DIRT,e),e++;for(let t=0;t<ft.length;t++)this.loadTileType(ft[t],e),e++;this.loaded=!0}loadTileType(e,t){e.tileTypeBackground=this.parseRow(t)}parseRow(e){let t=this.spriteSize+1,i=48,r=e*t,s=0,o=new wr;for(let a=0;a<i;a++)o.sprites.push(new Me(this,s,r)),s+=t;return o}};var Le={thruster:{icon:"",staticOverlay:"",activeOverlay:"thruster"},pick:{icon:"",staticOverlay:"pick_s",activeOverlay:"pick_a"},club:{icon:"",staticOverlay:"club_s",activeOverlay:"club_a"},axe:{icon:"",staticOverlay:"axe_s",activeOverlay:"axe_a"},broadSword:{icon:"",staticOverlay:"broad_sword_s",activeOverlay:"broad_sword_a"},mace:{icon:"",staticOverlay:"mace_s",activeOverlay:"mace_a"},twoHandedAxe:{icon:"",staticOverlay:"two_handed_axe_s",activeOverlay:"two_handed_axe_a"},twoHandedClub:{icon:"",staticOverlay:"two_handed_club_s",activeOverlay:"two_handed_club_a"},darkSword:{icon:"",staticOverlay:"dark_sword_s",activeOverlay:"dark_sword_a"},redSword:{icon:"",staticOverlay:"red_sword_s",activeOverlay:"red_sword_a"}};var Sr=class extends vt{constructor(e,t,i){super(e,t),this.spriteAnimationManager=i,this.spriteAnimationMap={},this.loadImage()}getSpriteAnimation(e){return this.spriteAnimationMap[e]}calculateSpriteStep(e){return e}populateSpriteMap(){let e=0;this.populateSpriteAnimation(Le.thruster.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(Le.pick.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(Le.pick.activeOverlay,e,4,!0,!0),e++,this.populateSpriteAnimation(Le.club.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(Le.club.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(Le.axe.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(Le.axe.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(Le.broadSword.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(Le.broadSword.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(Le.mace.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(Le.mace.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(Le.twoHandedAxe.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(Le.twoHandedAxe.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(Le.twoHandedClub.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(Le.twoHandedClub.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(Le.darkSword.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(Le.darkSword.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(Le.redSword.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(Le.redSword.activeOverlay,e,5,!0,!0),this.loaded=!0}populateSpriteAnimation(e,t,i,r,s){let o=new gt(this.parseRow(t,i),this.spriteAnimationManager,r,s);this.spriteAnimationMap[e]=o}};var ll={GREEN_DARK_GREEN1_DARK_GREEN2:"A0",DARK_BROWN1_GREY_ORANGE_BROWN:"A1",LIGHT_BROWN2_BROWN3_YELLOW_BROWN:"A2",LIGHT_YELLOW_YELLOW_ORANGE_YELLOW:"A3",LIGHT_PINK_DARK_PURPLE_YELLOW:"A4",GRAY_DARK_GRAY_LIGHTER_GRAY:"A5",BLUE_DARK_BLUE_LIGHT_GRAY:"A6",LIGHT_GRAY_BLUE_DARK_BLUE:"A7",ORANGE_ORANGE_YELLOW_DARK_ORANGE:"A8",BLUE_DARK_BLUE_PURPLE:"A9",BLUE_ORANGE_YELLOW_PURPLE:"B0",TEAL_LIGHT_BLUE1_PALE_AQUA:"B1",DARK_BROWN_RED_DARK_RED_RED:"B2",DARK_GRAY_ORANGE_RED_BLUE:"B3",DARK_GRAY_LIGHT_PURPLE1_TAN_GREEN:"B4",TAN_GREEN_DARK_GRAY_LIGHT_PURPLE1:"B5",SKY_BLUE_PALE_BLUE_LIGHT_BLUE2:"B6",LIGHT_BROWN2_REDDISH_BROWN_ORANGE_BROWN:"B7",ORANGE_BROWN_REDDISH_BROWN_LIGHT_BROWN2:"B8",DARKER_PURPLE_LIGHT_PURPLE2_LIGHT_YELLOW:"B9",ORANGE_YELLOW_ORANGE_BROWN_LIGHT_BROWN2:"C0",DARK_GRAY_LIGHT_PURPLE1_GREEN_BLUE:"C1",BLUE_ORANGE_YELLOW_DARK_GRAY:"C2",SKY_BLUE_BLUE_LIGHT_GREEN:"C3",VERY_DARK_GREEN_TAN_WHITE_YELLOW:"C4",BROWNISH_GREEN_DARK_RED_SUPER_DARK_GREEN:"C5",YELLOW_ORANGE_DARK_GREEN2:"C6",LIGHT_PURPLE2_DARKER_PURPLE_LIGHT_YELLOW:"C7",DARK_GRAY_DARK_ORANGE_LIGHTER_GRAY:"C8",DARK_ORANGE_DARK_GRAY_LIGHTER_GRAY:"C9",LIGHTER_GRAY_DARK_ORANGE_DARK_GRAY:"D0",LIME_GREEN1_DARK_BLUE_DARK_GRAY:"D1",VERY_DARK_RED_SUPER_DARK_RED_ORANGE_RED:"D2",ORANGE_RED_VERY_DARK_RED_SUPER_DARK_RED:"D3",PURPLE_VERY_DARK_RED_SUPER_DARK_RED:"D4",DARK_GRAY_LIGHT_GRAY_DARK_RED_PINK:"D5",BLACK_LIGHT_BLUE1_LIGHT_BLUE2:"D6",GREEN_BLUE_LIME_GREEN1_BLUE:"D7",GREY_BLUE_GREEN_LIME_GREEN2_YELLOW_BROWN:"D8",ORANGE_YELLOW_YELLOW_BROWN_TAN_GREEN:"D9",LIGHT_BLUE_GREEN_BROWNISH_GREEN_LIME_GREEN2:"E0",LIME_GREEN2_BROWNISH_GREEN_DARK_RED_ORANGE:"E1",GRAY_DARK_BROWN3_DARKER_BROWN:"E2",BLACK_DARKER_BROWN_DARK_BROWN3:"E3",DARK_PURPLE_PURPLE_LIGHT_PURPLE1:"E4",LIGHT_PURPLE1_ORANGE_RED_PURPLE:"E5",GREEN_BROWN_DARK_BROWN2_DARK_GRAY:"E6",SKY_BLUE_BROWNISH_GREEN_LIME_GREEN2:"E7",RED_SKY_BLUE_BROWNISH_GREEN:"E8"};function Xl(){let l=[];for(let e of Object.values(ll))l.push(e);return l}var dl=Xl();var M={VINE_TOP0:"V0",VINE_TOP1:"V1",VINE_TOP2:"V2",VINE_TOP3:"V3",VINE_TOP4:"V4",VINE_TOP5:"V5",VINE_TOP6:"V6",VINE_TOP7:"V7",VINE_PARTIAL0:"v0",VINE_PARTIAL1:"v1",VINE_PARTIAL2:"v2",VINE_PARTIAL3:"v3",VINE_PARTIAL4:"v4",VINE_PARTIAL5:"v5",VINE_PARTIAL6:"v6",VINE_PARTIAL7:"v7",FLOOR_PLANT0:"P0",FLOOR_PLANT1:"P1",FLOOR_PLANT2:"P2",FLOOR_PLANT3:"P3",FLOOR_PLANT4:"P4",FLOOR_PLANT5:"P5",FLOOR_PLANT6:"P6",FLOOR_PLANT7:"P7",FLOOR_GRASS0:"G0",FLOOR_GRASS1:"G1",FLOOR_GRASS2:"G2",FLOOR_GRASS3:"G3",FLOOR_GRASS4:"G4",FLOOR_GRASS5:"G5",FLOOR_GRASS6:"G6",FLOOR_GRASS7:"G7",FLOOR_MUSHROOM0:"M0",FLOOR_MUSHROOM1:"M1",FLOOR_MUSHROOM2:"M2",FLOOR_MUSHROOM3:"M3",FLOOR_MUSHROOM4:"M4",FLOOR_MUSHROOM5:"M5",FLOOR_MUSHROOM6:"M6",FLOOR_MUSHROOM7:"M7",WALL_FLOWER0:"W0",WALL_FLOWER1:"W1",WALL_FLOWER2:"W2",WALL_FLOWER3:"W3",WALL_FLOWER4:"W4",WALL_FLOWER5:"W5",WALL_FLOWER6:"W6",WALL_FLOWER7:"W7",STALACTITE0:"S0",STALACTITE1:"S1",STALACTITE2:"S2",STALACTITE3:"S3",STALACTITE4:"S4",STALACTITE5:"S5",STALACTITE6:"S6",STALACTITE7:"S7",STALAGMITE0:"s0",STALAGMITE1:"s1",STALAGMITE2:"s2",STALAGMITE3:"s3",STALAGMITE4:"s4",STALAGMITE5:"s5",STALAGMITE6:"s6",STALAGMITE7:"s7",FLOOR_POKIES0:"f0",FLOOR_POKIES1:"f1",FLOOR_POKIES2:"f2",FLOOR_POKIES3:"f3",FLOOR_POKIES4:"f4",FLOOR_POKIES5:"f5",FLOOR_POKIES6:"f6",FLOOR_POKIES7:"f7",CEILING_POKIES0:"p0",CEILING_POKIES1:"p1",CEILING_POKIES2:"p2",CEILING_POKIES3:"p3",CEILING_POKIES4:"p4",CEILING_POKIES5:"p5",CEILING_POKIES6:"p6",CEILING_POKIES7:"p7",WALL_CRACKS0:"C0",WALL_CRACKS1:"C1",WALL_CRACKS2:"C2",WALL_CRACKS3:"C3",WALL_CRACKS4:"C4",WALL_CRACKS5:"C5",WALL_CRACKS6:"C6",WALL_CRACKS7:"C7",TALL_GRASS0:"g0",TALL_GRASS1:"g1",TALL_GRASS2:"g2",TALL_GRASS3:"g3",TALL_GRASS4:"g4",TALL_GRASS5:"g5",TALL_GRASS6:"g6",TALL_GRASS7:"g7",CEILING_GRASS0:"c0",CEILING_GRASS1:"c1",CEILING_GRASS2:"c2",CEILING_GRASS3:"c3",CEILING_GRASS4:"c4",CEILING_GRASS5:"c5",CEILING_GRASS6:"c6",CEILING_GRASS7:"c7",CURVED_PLANTS0:"a0",CURVED_PLANTS1:"a1",CURVED_PLANTS2:"a2",CURVED_PLANTS3:"a3",CURVED_PLANTS4:"a4",CURVED_PLANTS5:"a5",CURVED_PLANTS6:"a6",CURVED_PLANTS7:"a7",FLOWERS0:"b0",FLOWERS1:"b1",FLOWERS2:"b2",FLOWERS3:"b3",FLOWERS4:"b4",FLOWERS5:"b5",FLOWERS6:"b6",FLOWERS7:"b7",FLOOR_SPIKES0:"d0",FLOOR_SPIKES1:"d1",FLOOR_SPIKES2:"d2",FLOOR_SPIKES3:"d3",FLOOR_SPIKES4:"d4",FLOOR_SPIKES5:"d5",FLOOR_SPIKES6:"d6",FLOOR_SPIKES7:"d7",CEILING_SPIKES0:"e0",CEILING_SPIKES1:"e1",CEILING_SPIKES2:"e2",CEILING_SPIKES3:"e3",CEILING_SPIKES4:"e4",CEILING_SPIKES5:"e5",CEILING_SPIKES6:"e6",CEILING_SPIKES7:"e7",WALL_HOLES0:"h0",WALL_HOLES1:"h1",WALL_HOLES2:"h2",WALL_HOLES3:"h3",WALL_HOLES4:"h4",WALL_HOLES5:"h5",WALL_HOLES6:"h6",WALL_HOLES7:"h7"},jl=[M.VINE_TOP0,M.VINE_TOP1,M.VINE_TOP2,M.VINE_TOP3,M.VINE_TOP4,M.VINE_TOP5,M.VINE_TOP6,M.VINE_TOP7],Zl=[M.VINE_PARTIAL0,M.VINE_PARTIAL1,M.VINE_PARTIAL2,M.VINE_PARTIAL3,M.VINE_PARTIAL4,M.VINE_PARTIAL5,M.VINE_PARTIAL6,M.VINE_PARTIAL7],ql=[M.FLOOR_PLANT0,M.FLOOR_PLANT1,M.FLOOR_PLANT2,M.FLOOR_PLANT3,M.FLOOR_PLANT4,M.FLOOR_PLANT5,M.FLOOR_PLANT6,M.FLOOR_PLANT7],Jl=[M.FLOOR_GRASS0,M.FLOOR_GRASS1,M.FLOOR_GRASS2,M.FLOOR_GRASS3,M.FLOOR_GRASS4,M.FLOOR_GRASS5,M.FLOOR_GRASS6,M.FLOOR_GRASS7],Ql=[M.FLOOR_MUSHROOM0,M.FLOOR_MUSHROOM1,M.FLOOR_MUSHROOM2,M.FLOOR_MUSHROOM3,M.FLOOR_MUSHROOM4,M.FLOOR_MUSHROOM5,M.FLOOR_MUSHROOM6,M.FLOOR_MUSHROOM7],$l=[M.WALL_FLOWER0,M.WALL_FLOWER1,M.WALL_FLOWER2,M.WALL_FLOWER3,M.WALL_FLOWER4,M.WALL_FLOWER5,M.WALL_FLOWER6,M.WALL_FLOWER7],ed=[M.STALACTITE0,M.STALACTITE1,M.STALACTITE2,M.STALACTITE3,M.STALACTITE4,M.STALACTITE5,M.STALACTITE6,M.STALACTITE7],td=[M.STALAGMITE0,M.STALAGMITE1,M.STALAGMITE2,M.STALAGMITE3,M.STALAGMITE4,M.STALAGMITE5,M.STALAGMITE6,M.STALAGMITE7],id=[M.FLOOR_POKIES0,M.FLOOR_POKIES1,M.FLOOR_POKIES2,M.FLOOR_POKIES3,M.FLOOR_POKIES4,M.FLOOR_POKIES5,M.FLOOR_POKIES6,M.FLOOR_POKIES7],rd=[M.CEILING_POKIES0,M.CEILING_POKIES1,M.CEILING_POKIES2,M.CEILING_POKIES3,M.CEILING_POKIES4,M.CEILING_POKIES5,M.CEILING_POKIES6,M.CEILING_POKIES7],sd=[M.TALL_GRASS0,M.TALL_GRASS1,M.TALL_GRASS2,M.TALL_GRASS3,M.TALL_GRASS4,M.TALL_GRASS5,M.TALL_GRASS6,M.TALL_GRASS7],od=[M.CEILING_GRASS0,M.CEILING_GRASS1,M.CEILING_GRASS2,M.CEILING_GRASS3,M.CEILING_GRASS4,M.CEILING_GRASS5,M.CEILING_GRASS6,M.CEILING_GRASS7],nd=[M.CURVED_PLANTS0,M.CURVED_PLANTS1,M.CURVED_PLANTS2,M.CURVED_PLANTS3,M.CURVED_PLANTS4,M.CURVED_PLANTS5,M.CURVED_PLANTS6,M.CURVED_PLANTS7],ad=[M.FLOWERS0,M.FLOWERS1,M.FLOWERS2,M.FLOWERS3,M.FLOWERS4,M.FLOWERS5,M.FLOWERS6,M.FLOWERS7],ld=[M.FLOOR_SPIKES0,M.FLOOR_SPIKES1,M.FLOOR_SPIKES2,M.FLOOR_SPIKES3,M.FLOOR_SPIKES4,M.FLOOR_SPIKES5,M.FLOOR_SPIKES6,M.FLOOR_SPIKES7],dd=[M.CEILING_SPIKES0,M.CEILING_SPIKES1,M.CEILING_SPIKES2,M.CEILING_SPIKES3,M.CEILING_SPIKES4,M.CEILING_SPIKES5,M.CEILING_SPIKES6,M.CEILING_SPIKES7],hd=[M.WALL_HOLES0,M.WALL_HOLES1,M.WALL_HOLES2,M.WALL_HOLES3,M.WALL_HOLES4,M.WALL_HOLES5,M.WALL_HOLES6,M.WALL_HOLES7],hl=[jl,ed,rd,od,dd],ul=[Zl,$l,hd],cl=[ql,Jl,Ql,td,id,sd,nd,ad,ld];var ri=class extends it{constructor(e,t){super(e,t),this.spriteMap={}}getSprite(e){return this.spriteMap[e]}};var si=class l extends ri{constructor(e,t){super(e,t),this.loadImage()}static getSpriteName(e,t){return e+"_"+t}populateSpriteMap(){let e=0;for(let t of Object.values(M))this.parseRow(e,t),e++;this.loaded=!0}parseRow(e,t){let i=this.spriteSize+1,r=e*i,s=0;for(let o of Object.values(ll)){let a=l.getSpriteName(t,o);this.spriteMap[a]=new Me(this,s,r),s+=i}}getFixtureSprite(e,t){return this.getSprite(l.getSpriteName(e,t))}};var g={AQUATIC_SNAKE_TAN_1:"AQUATIC_SNAKE_TAN1",AQUATIC_SNAKE_TAN_2:"AQUATIC_SNAKE_TAN2",AQUATIC_SNAKE_BLACK_1:"AQUATIC_SNAKE_BLACK1",AQUATIC_SNAKE_BLACK_2:"AQUATIC_SNAKE_BLACK2",AQUATIC_MONSTER:"AQUATIC_MONSTER",AVIAN_BAT_BROWN_SMALL:"AVIAN_BAT_BROWN_SMALL",AVIAN_BAT_BROWN_LARGE:"AVIAN_BAT_BROWN_LARGE",AVIAN_BAT_BLACK_LARGE:"AVIAN_BAT_BLACK_LARGE",AVIAN_BAT_BROWN_SMALL2:"AVIAN_BAT_BROWN_SMALL2",AVIAN_BAT_BROWN_LARGE2:"AVIAN_BAT_BROWN_LARGE2",DEMON_REPTILIAN_GREEN:"DEMON_REPTILIAN_GREEN",DEMON_REPTILIAN_WINGED:"DEMON_REPTILIAN_WINGED",DEMON_BROWN:"DEMON_BROWN",DEMON_BLOB:"DEMON_BLOB",DEMON_BLUE:"DEMON_BLUE",DEMON_BLUE_WINGED:"DEMON_BLUE_WINGED",DEMON_RED_GLOWING:"DEMON_RED_GLOWING",DEMON_RED_WINGED_1:"DEMON_RED_WINGED1",DEMON_RED_WINGED_2:"DEMON_RED_WINGED2",DEMON_RED_DARK_LARGE:"DEMON_RED_DARK_LARGE",DEMON_RED_LARGE:"DEMON_RED_LARGE",DEMON_RED_PALE_LARGE:"DEMON_RED_PALE_LARGE",DEMON_BLUE_LARGE:"DEMON_BLUE_LARGE",DEMON_BLUE_RED_LARGE:"DEMON_BLUE_RED_LARGE",DEMON_GREEN_EYE_STOCKS:"DEMON_GREEN_EYE_STOCKS",DEMON_GREEN_EVIL_WINGED:"DEMON_GREEN_EVIL_WINGED",DEMON_RED_DARK_WHIP:"DEMON_RED_DARK_WHIP",DEMON_RED_TINY_JUMPING:"DEMON_RED_TINY_JUMPING",DEMON_RED_SMALL_JUMPING:"DEMON_RED_SMALL_JUMPING",DEMON_ARMORED:"DEMON_ARMORED",DEMON_HELMET_HORNED:"DEMON_HELMET_HORNED",DEMON_RED_FANGED:"DEMON_RED_FANGED",DEMON_GREEN_FROG_LIKE:"DEMON_GREEN_FROG_LIKE",ELEMENTAL_WARRIOR:"ELEMENTAL_WARRIOR",ELEMENTAL_SQUID:"ELEMENTAL_SQUID",ELEMENTAL_GOLEM:"ELEMENTAL_GOLEM",ELEMENTAL_GOLEM_DARK:"ELEMENTAL_GOLEM_DARK",ELEMENTAL_GOLEM_RUSTY:"ELEMENTAL_GOLEM_RUSTY",ELEMENTAL_BLOODY:"ELEMENTAL_BLOODY",ELEMENTAL_STONE:"ELEMENTAL_STONE",ELEMENTAL_SWIRL_ORANGE:"ELEMENTAL_SWIRL_ORANGE",ELEMENTAL_SWIRL_YELLOW:"ELEMENTAL_SWIRL_YELLOW",ELEMENTAL_SWIRL_BLUE_DARK:"ELEMENTAL_SWIRL_BLUE_DARK",ELEMENTAL_SWIRL_BLUE_LIGHT:"ELEMENTAL_SWIRL_BLUE_LIGHT",ELEMENTAL_SWIRL_RED:"ELEMENTAL_SWIRL_RED",ELEMENTAL_CREEPY_RED:"ELEMENTAL_CREEPY_RED",ELEMENTAL_CREEPY_BROWN:"ELEMENTAL_CREEPY_BROWN",ELEMENTAL_CREEPY_LIGHT_BLUE:"ELEMENTAL_CREEPY_LIGHT_BLUE",ELEMENTAL_BALL_GREEN:"ELEMENTAL_BALL_GREEN",ELEMENTAL_BALL_BLUE:"ELEMENTAL_BALL_BLUE",ELEMENTAL_BALL_RED:"ELEMENTAL_BALL_RED",ELEMENTAL_BALL_BLACK:"ELEMENTAL_BALL_BLACK",ELEMENTAL_EYE_WHITE:"ELEMENTAL_EYE_WHITE",ELEMENTAL_EYE_RED:"ELEMENTAL_EYE_RED",ELEMENTAL_EYE_BEHOLDER:"ELEMENTAL_EYE_BEHOLDER",HUMANOID_210_SASQUATCH:"HUMANOID_210_SASQUATCH",HUMANOID_000:"HUMANOID_000",HUMANOID_001:"HUMANOID_001",HUMANOID_002:"HUMANOID_002",HUMANOID_003:"HUMANOID_003",HUMANOID_004:"HUMANOID_004",HUMANOID_005:"HUMANOID_005",HUMANOID_006:"HUMANOID_006",HUMANOID_007:"HUMANOID_007",HUMANOID_010_MINOTAUR:"HUMANOID_010_MINOTAUR",HUMANOID_011_CYCLOPS:"HUMANOID_011_CYCLOPS",HUMANOID_040_WALRUS_MAN:"HUMANOID_040_WALRUS_MAN",HUMANOID_041_WALRUS_MAN:"HUMANOID_041_WALRUS_MAN",HUMANOID_042_WALRUS_MAN:"HUMANOID_042_WALRUS_MAN",HUMANOID_043_WALRUS_MAN:"HUMANOID_043_WALRUS_MAN",HUMANOID_044_WALRUS_MAN:"HUMANOID_044_WALRUS_MAN",HUMANOID_045_WALRUS_MAN:"HUMANOID_045_WALRUS_MAN",HUMANOID_046_WALRUS_MAN:"HUMANOID_046_WALRUS_MAN",HUMANOID_070:"HUMANOID_070",HUMANOID_071:"HUMANOID_071",HUMANOID_072:"HUMANOID_072",HUMANOID_073:"HUMANOID_073",HUMANOID_170_STONE_SERPENT:"HUMANOID_170_STONE_SERPENT",HUMANOID_171_STONE_SERPENT:"HUMANOID_171_STONE_SERPENT",MISC_ANIMAL_70:"MISC_ANIMAL_70",HUMANOID_190_DEMON_BASHER:"HUMANOID_190_DEMON_BASHER",HUMANOID_191_DEMON_BASHER:"HUMANOID_191_DEMON_BASHER",HUMANOID_200_SQUID_DEMON:"HUMANOID_200_SQUID_DEMON",HUMANOID_201_SQUID_DEMON:"HUMANOID_201_SQUID_DEMON",MISC_ANIMAL_03_OWL:"MISC_ANIMAL_03_OWL",MISC_ANIMAL_04:"MISC_ANIMAL_04",MISC_ANIMAL_05:"MISC_ANIMAL_05",MISC_ANIMAL_06:"MISC_ANIMAL_06",MISC_ANIMAL_11:"MISC_ANIMAL_11",MISC_ANIMAL_12:"MISC_ANIMAL_12",MISC_ANIMAL_50:"MISC_ANIMAL_50",MISC_ANIMAL_51:"MISC_ANIMAL_51",MISC_ANIMAL_52:"MISC_ANIMAL_52",MISC_ANIMAL_53:"MISC_ANIMAL_53",PEST_LADYBUG_100:"PEST_LADYBUG_100",PEST_LADYBUG_101:"PEST_LADYBUG_101",PEST_TINY_00:"PEST_TINY_00",PEST_TINY_01:"PEST_TINY_01",PEST_TINY_02:"PEST_TINY_02",PEST_TINY_03:"PEST_TINY_03",PEST_TINY_04:"PEST_TINY_04",PEST_TINY_05:"PEST_TINY_05",PEST_TINY_WORM_1:"PEST_TINY_WORM1",PEST_TINY_WORM_2:"PEST_TINY_WORM2",PEST_ANT_10:"PEST_INSECT_10",PEST_INSECT_11:"PEST_INSECT_11",PEST_INSECT_12:"PEST_INSECT_12",PEST_INSECT_13:"PEST_INSECT_13",PEST_INSECT_14:"PEST_INSECT_14",PEST_SPIDER_20:"PEST_SPIDER_20",PEST_SPIDER_21:"PEST_SPIDER_21",PEST_SPIDER_22:"PEST_SPIDER_22",PEST_SCORPION_23:"PEST_SCORPION_23",PEST_SCORPION_24:"PEST_SCORPION_24",PEST_SCORPION_25:"PEST_SCORPION_25",PEST_WORM_30:"PEST_WORM_30",PEST_WORM_31:"PEST_WORM_31",PEST_BALL:"PEST_BALL",PEST_WORM_33:"PEST_WORM_33",PEST_WORM_34:"PEST_WORM_34",PEST_GIANT_ANT_40:"PEST_GIANT_ANT_40",PEST_GIANT_ANT_41:"PEST_GIANT_ANT_41",PEST_GIANT_ANT_42:"PEST_GIANT_ANT_42",PEST_GIANT_ANT_43:"PEST_GIANT_ANT_43",PEST_SLUG_70:"PEST_SLUG_70",PEST_SLUG_71:"PEST_SLUG_71",PEST_SNAIL_72:"PEST_SNAIL_72",PEST_SNAIL_73:"PEST_SNAIL_73",PEST_INSECT_60:"PEST_INSECT_60",PEST_INSECT_61:"PEST_INSECT_61",PEST_INSECT_80:"PEST_INSECT_80",PEST_INSECT_81:"PEST_INSECT_81",MINOR_DEVIL:"PLAYER_130_MINOR_DEVIL",MINOR_DEVIL_WARRIOR:"PLAYER_131_MINOR_DEVIL_WARRIOR",ORC1:"PLAYER_120_ORC",ORC_WARRIOR:"PLAYER_121_ORC_WARRIOR",ORC_FIGHTER:"PLAYER_122_ORC_FIGHTER",ORC_KARATE:"PLAYER_123_ORC_KARATE",ORC_PIRATE:"PLAYER_124_ORC_PIRATE",ORC2:"PLAYER_125_ORC",ORC3:"PLAYER_126_ORC",ORC4:"PLAYER_127_ORC",DRAGON_MAN_BASIC:"PLAYER_140_DRAGON_MAN_BASIC",DRAGON_MAN_EXPLORER:"PLAYER_141_DRAGON_MAN_EXPLORER",DRAGON_MAN_FIGHTER:"PLAYER_142_DRAGON_MAN_FIGHTER",DRAGON_MAN_RUFFIAN:"PLAYER_143_DRAGON_MAN_RUFFIAN",DRAGON_MAN_RANGER:"PLAYER_144_DRAGON_MAN_RANGER",DRAGON_MAN_TERRIBLE:"PLAYER_145_DRAGON_MAN_TERRIBLE",DRAGON_MAN_MERCILESS:"PLAYER_146_DRAGON_MAN_MERCILESS",DRAGON_MAN_FIERY:"PLAYER_147_DRAGON_MAN_FIERY",QUADRUPED_000:"QUADRUPED_000",QUADRUPED_001:"QUADRUPED_001",QUADRUPED_002:"QUADRUPED_002",QUADRUPED_003:"QUADRUPED_003",QUADRUPED_004:"QUADRUPED_004",QUADRUPED_005:"QUADRUPED_005",QUADRUPED_006:"QUADRUPED_006",QUADRUPED_007:"QUADRUPED_007",RODENT_10_RAT_SMALL:"RODENT_10_RAT_SMALL",RODENT_11_RAT:"RODENT_11_RAT",RODENT_12_RAT_LARGE_BROWN:"RODENT_12_RAT_LARGE_BROWN",RODENT_13_RAT_LARGE_GREY:"RODENT_13_RAT_LARGE_GREY",RODENT_20_RAT_POISONOUS:"RODENT_20_RAT_POISONOUS",RODENT_21_RAT_ZOMBIE:"RODENT_21_RAT_ZOMBIE",RODENT_22_MOLE:"RODENT_22_MOLE",SLIME_BLUE_00:"SLIME_BLUE_00",SLIME_BROWN_01:"SLIME_BROWN_01",SLIME_WHITE_02:"SLIME_WHITE_02",SLIME_GREEN_03:"SLIME_GREEN_03",SLIME_PINK_04:"SLIME_PINK_04",SLIME_PURPLE_05:"SLIME_PURPLE_05",SLIME_MUCUS_GREEN_40:"SLIME_MUCUS_GREEN_40",SLIME_MUCUS_BLUE_41:"SLIME_MUCUS_BLUE_41",SLIME_CORRODED_20:"SLIME_CORRODED_20",SLIME_SEEING_21:"SLIME_SEEING_21",SLIME_ORANGE_22:"SLIME_ORANGE_22",SLIME_MINI_BLUE_30:"SLIME_MINI_BLUE_30",SLIME_MINI_31:"SLIME_MINI_31",SLIME_MINI_ORANGE_32:"SLIME_MINI_ORANGE_32",UNDEAD_WRAITH_0600:"UNDEAD_WRAITH_0600",UNDEAD_WRAITH_0601:"UNDEAD_WRAITH_0601",UNDEAD_GOBLIN0:"UNDEAD_GOBLIN0",UNDEAD_GOBLIN1:"UNDEAD_GOBLIN1",UNDEAD_GOBLIN2:"UNDEAD_GOBLIN2",UNDEAD_GOBLIN3:"UNDEAD_GOBLIN3",UNDEAD_GOBLIN4:"UNDEAD_GOBLIN4",UNDEAD_GOBLIN5:"UNDEAD_GOBLIN5",UNDEAD_GOBLIN6:"UNDEAD_GOBLIN6",UNDEAD_GOBLIN7:"UNDEAD_GOBLIN7",UNDEAD_KOBOLD_SKELETON_0200:"UNDEAD_KOBOLD_SKELETON_0200",UNDEAD_KOBOLD_SKELETON_0201:"UNDEAD_KOBOLD_SKELETON_0201",UNDEAD_KOBOLD_SKELETON_0202:"UNDEAD_KOBOLD_SKELETON_0202",UNDEAD_KOBOLD_SKELETON_0203:"UNDEAD_KOBOLD_SKELETON_0203",UNDEAD_KOBOLD4:"UNDEAD_KOBOLD4",UNDEAD_KOBOLD5:"UNDEAD_KOBOLD5",UNDEAD_KOBOLD_KING_0206:"UNDEAD_KOBOLD_KING_0206",UNDEAD_KOBOLD_ANCIENT_EVIL7:"UNDEAD_KOBOLD_ANCIENT_EVIL7",UNDEAD_GHOST_0400:"UNDEAD_GHOST_0400",UNDEAD_GHOST_0401:"UNDEAD_GHOST_0401",UNDEAD_GHOST_0402:"UNDEAD_GHOST_0402",UNDEAD_GHOST_0403:"UNDEAD_GHOST_0403",UNDEAD_REAPER_0500:"UNDEAD_REAPER_0500",UNDEAD_REAPER_0501:"UNDEAD_REAPER_0501",UNDEAD_REAPER_0502:"UNDEAD_REAPER_0502",UNDEAD_DARKNESS_0801:"UNDEAD_DARKNESS_0801",REPTILE_FLYING_SERPENT_SMALL_002:"REPTILE_FLYING_SERPENT_SMALL_002",REPTILE_FLYING_SERPENT_003:"REPTILE_FLYING_SERPENT_003",REPTILE_BROWN_SERPENT_SMALL_040:"REPTILE_BROWN_SERPENT_SMALL_040",REPTILE_BROWN_SERPENT_041:"REPTILE_BROWN_SERPENT_041",REPTILE_BROWN_SERPENT_LARGE_042:"REPTILE_BROWN_SERPENT_LARGE_042",REPTILE_BLACK_SERPENT_043:"REPTILE_BLACK_SERPENT_043",REPTILE_BLACK_SERPENT_LARGE_044:"REPTILE_BLACK_SERPENT_LARGE_044",REPTILE_BLACK_SERPENT_POISONOUS_045:"REPTILE_BLACK_SERPENT_POISONOUS_045",REPTILE_GREEN_SNAKE_SMALL_046:"REPTILE_GREEN_SNAKE_SMALL_046",REPTILE_GREEN_SNAKE_047:"REPTILE_GREEN_SNAKE_047"};var Nr=class extends ti{constructor(e,t,i,r,s){super(r,s),this.spriteAnimationManager=e,this.spritesheet0=t,this.spritesheet1=i}getImage(){return this.spriteAnimationManager.getDefaultFrameIndex(2)==0?this.spritesheet0.image:this.spritesheet1.image}getSize(){return this.spritesheet0.spriteSize}};var Di=class extends ri{constructor(e,t,i){super(e,t),this.monsterSpritesheet=i,this.loadImage()}populateSpriteMap(){this.loaded=!0,this.monsterSpritesheet.onSpritesheetLoaded()}};var Ar=class{constructor(e,t,i,r){this.spriteAnimationManager=r,this.spriteSize=i,this.spriteMap={},this.animationFrameSpritesheet0=new Di(e,i,this),this.animationFrameSpritesheet1=new Di(t,i,this)}onSpritesheetLoaded(){this.animationFrameSpritesheet0.loaded&&this.animationFrameSpritesheet1.loaded&&this.populateSpriteMap()}isLoaded(){return this.animationFrameSpritesheet0.loaded&&this.animationFrameSpritesheet1.loaded}getSprite(e){return this.spriteMap[e]}populateSpriteMap(){let e=0;this.parseRow(e,[g.AQUATIC_SNAKE_TAN_1,g.AQUATIC_SNAKE_TAN_2,g.AQUATIC_SNAKE_BLACK_1,g.AQUATIC_SNAKE_BLACK_2,g.AQUATIC_MONSTER,g.AVIAN_BAT_BROWN_SMALL,g.AVIAN_BAT_BROWN_LARGE,g.AVIAN_BAT_BLACK_LARGE]),e++,this.parseRow(e,[g.AVIAN_BAT_BROWN_SMALL2,g.AVIAN_BAT_BROWN_LARGE2,g.DEMON_REPTILIAN_GREEN,g.DEMON_REPTILIAN_WINGED,g.DEMON_BROWN,g.DEMON_BLOB,g.DEMON_BLUE,g.DEMON_BLUE_WINGED]),e++,this.parseRow(e,[g.DEMON_RED_GLOWING,g.DEMON_RED_WINGED_1,g.DEMON_RED_WINGED_2,g.DEMON_RED_DARK_LARGE,g.DEMON_RED_LARGE,g.DEMON_RED_PALE_LARGE,g.DEMON_BLUE_LARGE,g.DEMON_BLUE_RED_LARGE]),e++,this.parseRow(e,[g.DEMON_GREEN_EYE_STOCKS,g.DEMON_GREEN_EVIL_WINGED,g.DEMON_RED_DARK_WHIP,g.DEMON_RED_TINY_JUMPING,g.DEMON_RED_SMALL_JUMPING,g.DEMON_ARMORED,g.DEMON_HELMET_HORNED,g.DEMON_RED_FANGED]),e++,this.parseRow(e,[g.DEMON_GREEN_FROG_LIKE,g.ELEMENTAL_WARRIOR,g.ELEMENTAL_SQUID,g.ELEMENTAL_GOLEM,g.ELEMENTAL_GOLEM_DARK,g.ELEMENTAL_GOLEM_RUSTY,g.ELEMENTAL_BLOODY,g.ELEMENTAL_STONE]),e++,this.parseRow(e,[g.ELEMENTAL_SWIRL_ORANGE,g.ELEMENTAL_SWIRL_YELLOW,g.ELEMENTAL_SWIRL_BLUE_DARK,g.ELEMENTAL_SWIRL_BLUE_LIGHT,g.ELEMENTAL_SWIRL_RED,g.ELEMENTAL_CREEPY_RED,g.ELEMENTAL_CREEPY_BROWN,g.ELEMENTAL_CREEPY_LIGHT_BLUE]),e++,this.parseRow(e,[g.ELEMENTAL_BALL_GREEN,g.ELEMENTAL_BALL_BLUE,g.ELEMENTAL_BALL_RED,g.ELEMENTAL_BALL_BLACK,g.ELEMENTAL_EYE_WHITE,g.ELEMENTAL_EYE_RED,g.ELEMENTAL_EYE_BEHOLDER,g.HUMANOID_210_SASQUATCH]),e++,this.parseRow(e,[g.HUMANOID_000,g.HUMANOID_001,g.HUMANOID_002,g.HUMANOID_003,g.HUMANOID_004,g.HUMANOID_005,g.HUMANOID_006,g.HUMANOID_007]),e++,this.parseRow(e,[g.HUMANOID_010_MINOTAUR,g.HUMANOID_011_CYCLOPS,g.HUMANOID_040_WALRUS_MAN,g.HUMANOID_041_WALRUS_MAN,g.HUMANOID_042_WALRUS_MAN,g.HUMANOID_043_WALRUS_MAN,g.HUMANOID_044_WALRUS_MAN,g.HUMANOID_045_WALRUS_MAN]),e++,this.parseRow(e,[g.HUMANOID_046_WALRUS_MAN,g.HUMANOID_070,g.HUMANOID_071,g.HUMANOID_072,g.HUMANOID_073,g.HUMANOID_170_STONE_SERPENT,g.HUMANOID_171_STONE_SERPENT,g.MISC_ANIMAL_70]),e++,this.parseRow(e,[g.HUMANOID_190_DEMON_BASHER,g.HUMANOID_191_DEMON_BASHER,g.HUMANOID_200_SQUID_DEMON,g.HUMANOID_201_SQUID_DEMON,g.MISC_ANIMAL_03_OWL,g.MISC_ANIMAL_04,g.MISC_ANIMAL_05,g.MISC_ANIMAL_06]),e++,this.parseRow(e,[g.MISC_ANIMAL_11,g.MISC_ANIMAL_12,g.MISC_ANIMAL_50,g.MISC_ANIMAL_51,g.MISC_ANIMAL_52,g.MISC_ANIMAL_53,g.PEST_LADYBUG_100,g.PEST_LADYBUG_101]),e++,this.parseRow(e,[g.PEST_TINY_00,g.PEST_TINY_01,g.PEST_TINY_02,g.PEST_TINY_03,g.PEST_TINY_04,g.PEST_TINY_05,g.PEST_TINY_WORM_1,g.PEST_TINY_WORM_2]),e++,this.parseRow(e,[g.PEST_ANT_10,g.PEST_INSECT_11,g.PEST_INSECT_12,g.PEST_INSECT_13,g.PEST_INSECT_14,g.PEST_SPIDER_20,g.PEST_SPIDER_21,g.PEST_SPIDER_22]),e++,this.parseRow(e,[g.PEST_SCORPION_23,g.PEST_SCORPION_24,g.PEST_SCORPION_25,g.PEST_WORM_30,g.PEST_WORM_31,g.PEST_BALL,g.PEST_WORM_33,g.PEST_WORM_34]),e++,this.parseRow(e,[g.PEST_GIANT_ANT_40,g.PEST_GIANT_ANT_41,g.PEST_GIANT_ANT_42,g.PEST_GIANT_ANT_43,g.PEST_SLUG_70,g.PEST_SLUG_71,g.PEST_SNAIL_72,g.PEST_SNAIL_73]),e++,this.parseRow(e,[g.PEST_INSECT_60,g.PEST_INSECT_61,g.PEST_INSECT_80,g.PEST_INSECT_81,g.MINOR_DEVIL,g.MINOR_DEVIL_WARRIOR]),e++,this.parseRow(e,[g.ORC1,g.ORC_WARRIOR,g.ORC_FIGHTER,g.ORC_KARATE,g.ORC_PIRATE,g.ORC2,g.ORC3,g.ORC4]),e++,this.parseRow(e,[g.DRAGON_MAN_BASIC,g.DRAGON_MAN_EXPLORER,g.DRAGON_MAN_FIGHTER,g.DRAGON_MAN_RUFFIAN,g.DRAGON_MAN_RANGER,g.DRAGON_MAN_TERRIBLE,g.DRAGON_MAN_MERCILESS,g.DRAGON_MAN_FIERY]),e++,this.parseRow(e,[g.QUADRUPED_000,g.QUADRUPED_001,g.QUADRUPED_002,g.QUADRUPED_003,g.QUADRUPED_004,g.QUADRUPED_005,g.QUADRUPED_006,g.QUADRUPED_007]),e++,this.parseRow(e,[g.RODENT_10_RAT_SMALL,g.RODENT_11_RAT,g.RODENT_12_RAT_LARGE_BROWN,g.RODENT_13_RAT_LARGE_GREY,g.RODENT_20_RAT_POISONOUS,g.RODENT_21_RAT_ZOMBIE,g.RODENT_22_MOLE]),e++,this.parseRow(e,[g.SLIME_BLUE_00,g.SLIME_BROWN_01,g.SLIME_WHITE_02,g.SLIME_GREEN_03,g.SLIME_PINK_04,g.SLIME_PURPLE_05,g.SLIME_MUCUS_GREEN_40,g.SLIME_MUCUS_BLUE_41]),e++,this.parseRow(e,[g.SLIME_CORRODED_20,g.SLIME_SEEING_21,g.SLIME_ORANGE_22,g.SLIME_MINI_BLUE_30,g.SLIME_MINI_31,g.SLIME_MINI_ORANGE_32,g.UNDEAD_WRAITH_0600,g.UNDEAD_WRAITH_0601]),e++,this.parseRow(e,[g.UNDEAD_GOBLIN0,g.UNDEAD_GOBLIN1,g.UNDEAD_GOBLIN2,g.UNDEAD_GOBLIN3,g.UNDEAD_GOBLIN4,g.UNDEAD_GOBLIN5,g.UNDEAD_GOBLIN6,g.UNDEAD_GOBLIN7]),e++,this.parseRow(e,[g.UNDEAD_KOBOLD_SKELETON_0200,g.UNDEAD_KOBOLD_SKELETON_0201,g.UNDEAD_KOBOLD_SKELETON_0202,g.UNDEAD_KOBOLD_SKELETON_0203,g.UNDEAD_KOBOLD4,g.UNDEAD_KOBOLD5,g.UNDEAD_KOBOLD_KING_0206,g.UNDEAD_KOBOLD_ANCIENT_EVIL7]),e++,this.parseRow(e,[g.UNDEAD_GHOST_0400,g.UNDEAD_GHOST_0401,g.UNDEAD_GHOST_0402,g.UNDEAD_GHOST_0403,g.UNDEAD_REAPER_0500,g.UNDEAD_REAPER_0501,g.UNDEAD_REAPER_0502,g.UNDEAD_DARKNESS_0801]),e++,this.parseRow(e,[g.REPTILE_FLYING_SERPENT_SMALL_002,g.REPTILE_FLYING_SERPENT_003]),e++,this.parseRow(e,[g.REPTILE_BROWN_SERPENT_SMALL_040,g.REPTILE_BROWN_SERPENT_041,g.REPTILE_BROWN_SERPENT_LARGE_042,g.REPTILE_BLACK_SERPENT_043,g.REPTILE_BLACK_SERPENT_LARGE_044,g.REPTILE_BLACK_SERPENT_POISONOUS_045,g.REPTILE_GREEN_SNAKE_SMALL_046,g.REPTILE_GREEN_SNAKE_047]),e++,this.loaded=!0}parseRow(e,t){let i=this.spriteSize+1,r=e*i,s=0;for(let o=0;o<+t.length;o++)this.spriteMap[t[o]]=new Nr(this.spriteAnimationManager,this.animationFrameSpritesheet0,this.animationFrameSpritesheet1,s,r),s+=i}};var Pr=class{constructor(){this.oreSpriteLists=[]}addSeries(e){this.oreSpriteLists.push(e)}getOreSprite(e){if(!e||e.open||e.tileType.rarityModifier!==R.ORE)return null;let t=e.getTileRow(),r=Math.min(.999,t/1e4),s=this.oreSpriteLists.length*r|0,o=this.oreSpriteLists[s];return o[e.hash()%o.length]}};var oi=class{constructor(e){this.sprites=e,this.step=100/e.length}getDamageSprite(e){if(e>=100)return null;let t=this.sprites.length-1-e/this.step|0;return t>=this.sprites.length||t<0?(console.log("getDamageSprite() bad index calculated. healthPercent="+e+" idx="+t),null):this.sprites[t]}};var Rr=class{constructor(){this.spriteSeries=[]}add(e){this.spriteSeries.push(e)}getDamageSprite(e){if(!e||e.open)return null;let t=e.healthPercent;if(t===100)return null;let i=Math.abs(e.hash()%this.spriteSeries.length);return this.spriteSeries[i].getDamageSprite(t)}};var Mr=class extends vt{constructor(e,t,i,r,s){super(e,t),this.upgradeSpriteOverlay=null,this.spriteAnimationManager=i,this.tileDamageSpriteOverlay=r,this.oreSpriteOverlay=s,this.loadImage()}calculateSpriteStep(e){return e+1}populateSpriteMap(){let e=this.parseRow(0,2);this.upgradeSpriteOverlay=new gt(e,this.spriteAnimationManager,!1,!0);let t=this.parseRow(1,8),i=new oi(t);this.tileDamageSpriteOverlay.add(i);let r=this.parseRow(2,8),s=new oi(r);this.tileDamageSpriteOverlay.add(s);let o=this.parseRow(3,8),a=new oi(o);this.tileDamageSpriteOverlay.add(a),this.oreSpriteOverlay.addSeries(this.parseRow(5,8)),this.oreSpriteOverlay.addSeries(this.parseRow(6,8)),this.oreSpriteOverlay.addSeries(this.parseRow(7,8)),this.oreSpriteOverlay.addSeries(this.parseRow(8,8)),this.oreSpriteOverlay.addSeries(this.parseRow(9,8)),this.oreSpriteOverlay.addSeries(this.parseRow(10,8)),this.oreSpriteOverlay.addSeries(this.parseRow(11,8)),this.oreSpriteOverlay.addSeries(this.parseRow(12,8)),this.oreSpriteOverlay.addSeries(this.parseRow(13,8)),this.oreSpriteOverlay.addSeries(this.parseRow(14,8)),this.oreSpriteOverlay.addSeries(this.parseRow(15,8)),this.oreSpriteOverlay.addSeries(this.parseRow(16,8)),this.oreSpriteOverlay.addSeries(this.parseRow(17,8)),this.loaded=!0}};var _r=class extends gt{constructor(e,t,i,r,s){super(e,t,i,!0),this.directionalSprite=s,this.superFastAnimation=r}getSpriteAsOf(e,t){return this.fastAnimation?this.getFastCurrentSpriteAsOf(e,t):this.superFastAnimation?this.getSuperFastCurrentSpriteAsOf(e,t):this.getCurrentSpriteAsOf(e,t)}isAnimationLoopCompleted(e){return this.directionalSprite?!1:this.fastAnimation?this.spriteAnimationManager.isFastAnimationLoopCompleted(Date.now(),e,this.sprites.length):this.superFastAnimation?this.spriteAnimationManager.isSuperFastAnimationLoopCompleted(Date.now(),e,this.sprites.length):this.spriteAnimationManager.isDefaultAnimationLoopCompleted(Date.now(),e,this.sprites.length)}isDirectionalSprite(){return this.directionalSprite}};var Lr=class extends it{constructor(e,t,i,r,s){super(e,t),this.sheetEndCol=r,this.spritesheetMetadata=i,this.spriteAnimationManager=s,this.spriteMap={},this.loadImage()}populateSpriteMap(){for(let e=0;e<this.spritesheetMetadata.length;e++){let t=this.spritesheetMetadata[e],i=this.loadSpriteAnimation(t);this.spriteMap[t.animationName]=i}this.loaded=!0}loadSpriteAnimation(e){let t=Object.hasOwn(e,"directional")?e.directional:!1,i=Object.hasOwn(e,"fastAnimation")?e.fastAnimation:!1,r=Object.hasOwn(e,"superFastAnimation")?e.superFastAnimation:!1,s=this.createSpriteFrames(e);return new _r(s,this.spriteAnimationManager,i,r,t)}createSpriteFrames(e){let t=[],i=e.startRow,r=e.endRow,s=e.startCol,o=e.endCol,a=this.spriteSize;for(let h=i;h<=r;h++){let m=h*a,p;h<r?p=this.sheetEndCol:p=Math.min(o,this.sheetEndCol);for(let f=s;f<=p;f++){let N=f*a;t.push(new Me(this,N,m))}}return t}getSpriteAnimation(e){return this.spriteMap[e]}};var Nl=[{animationName:"Red Arrow",startCol:0,startRow:0,endCol:7,endRow:0,directional:!0},{animationName:"Green Arrow",startCol:0,startRow:1,endCol:7,endRow:1,directional:!0},{animationName:"Pink Arrow",startCol:0,startRow:2,endCol:7,endRow:2,directional:!0},{animationName:"Pink Lightning",startCol:0,startRow:3,endCol:7,endRow:3,directional:!0},{animationName:"Green Projectile",startCol:0,startRow:4,endCol:7,endRow:4,directional:!0},{animationName:"Small Green Projectiles",startCol:0,startRow:5,endCol:7,endRow:5,directional:!0},{animationName:"Fire Projectile",startCol:0,startRow:6,endCol:7,endRow:6,directional:!0},{animationName:"Fire Arrow",startCol:0,startRow:7,endCol:7,endRow:7,directional:!0},{animationName:"Ice Projectile",startCol:0,startRow:8,endCol:7,endRow:8,directional:!0},{animationName:"Ice Arrow",startCol:0,startRow:9,endCol:7,endRow:9,directional:!0},{animationName:"Lightning",startCol:0,startRow:10,endCol:7,endRow:10,directional:!0},{animationName:"Lightning Arrow",startCol:0,startRow:11,endCol:7,endRow:11,directional:!0},{animationName:"Grey Bullet",startCol:0,startRow:12,endCol:7,endRow:12,directional:!0},{animationName:"Yellow Bullet",startCol:0,startRow:13,endCol:7,endRow:13,directional:!0},{animationName:"Ninja Star",startCol:0,startRow:14,endCol:7,endRow:14,directional:!0},{animationName:"Pink Star Projectile",startCol:0,startRow:15,endCol:7,endRow:15,directional:!0},{animationName:"Web",startCol:0,startRow:16,endCol:7,endRow:16,directional:!0},{animationName:"Pink Ball Projectile",startCol:0,startRow:17,endCol:7,endRow:17,directional:!0},{animationName:"Yellow Star Projectile",startCol:0,startRow:18,endCol:7,endRow:18,directional:!1},{animationName:"Gold Sparkles",startCol:0,startRow:19,endCol:7,endRow:19},{animationName:"Green Sparkles",startCol:0,startRow:20,endCol:7,endRow:20},{animationName:"Blue Sparkles",startCol:0,startRow:21,endCol:7,endRow:21},{animationName:"Orange Sparkles",startCol:0,startRow:22,endCol:7,endRow:22},{animationName:"Pink Sparkles",startCol:0,startRow:23,endCol:7,endRow:23},{animationName:"Red Sparkles",startCol:0,startRow:24,endCol:7,endRow:24},{animationName:"Green Skull",startCol:0,startRow:25,endCol:7,endRow:25},{animationName:"Yellow Key",startCol:0,startRow:26,endCol:7,endRow:26},{animationName:"Skull Cross",startCol:0,startRow:27,endCol:7,endRow:27},{animationName:"Shields",startCol:0,startRow:28,endCol:7,endRow:28},{animationName:"Red Crosses",startCol:0,startRow:29,endCol:7,endRow:29},{animationName:"Fire Ring",startCol:0,startRow:30,endCol:7,endRow:30},{animationName:"Ice Ring",startCol:0,startRow:31,endCol:7,endRow:31},{animationName:"Green Ring",startCol:0,startRow:32,endCol:7,endRow:32},{animationName:"Pink Ring",startCol:0,startRow:33,endCol:7,endRow:33},{animationName:"Yellow Star",startCol:0,startRow:34,endCol:7,endRow:34},{animationName:"Blue Star",startCol:0,startRow:35,endCol:7,endRow:35},{animationName:"Green Star",startCol:0,startRow:36,endCol:7,endRow:36},{animationName:"White Crosses",startCol:0,startRow:37,endCol:7,endRow:37},{animationName:"Spider Web",startCol:0,startRow:38,endCol:7,endRow:38},{animationName:"Torch",startCol:0,startRow:39,endCol:7,endRow:39},{animationName:"Frost",startCol:0,startRow:40,endCol:7,endRow:41,fastAnimation:!0},{animationName:"Yellow Star Circle",startCol:0,startRow:42,endCol:6,endRow:43},{animationName:"Circles",startCol:0,startRow:44,endCol:4,endRow:45},{animationName:"Gold Shield Spiral",startCol:0,startRow:46,endCol:7,endRow:47,fastAnimation:!0},{animationName:"Green Shield Spiral",startCol:0,startRow:48,endCol:7,endRow:49,fastAnimation:!0},{animationName:"Blue Shield Spiral",startCol:0,startRow:50,endCol:7,endRow:51,fastAnimation:!0},{animationName:"Pink Shield Spiral",startCol:0,startRow:52,endCol:7,endRow:53,fastAnimation:!0},{animationName:"Blue Firework",startCol:0,startRow:54,endCol:7,endRow:55,fastAnimation:!0},{animationName:"Red Firework",startCol:0,startRow:56,endCol:7,endRow:57,fastAnimation:!0},{animationName:"Bubbles",startCol:0,startRow:58,endCol:2,endRow:60,fastAnimation:!0},{animationName:"Shield",startCol:0,startRow:61,endCol:7,endRow:62,fastAnimation:!0},{animationName:"Color Spiral",startCol:0,startRow:63,endCol:7,endRow:64},{animationName:"Arm Flex",startCol:0,startRow:65,endCol:4,endRow:66,fastAnimation:!0},{animationName:"Super Speed",startCol:0,startRow:67,endCol:7,endRow:68,fastAnimation:!0},{animationName:"Target",startCol:0,startRow:69,endCol:7,endRow:70,fastAnimation:!0},{animationName:"Yellow Shield Spiral",startCol:0,startRow:71,endCol:6,endRow:72,fastAnimation:!0},{animationName:"Pink Star Circle",startCol:0,startRow:73,endCol:6,endRow:74},{animationName:"Blue Star Circle",startCol:0,startRow:75,endCol:6,endRow:76},{animationName:"Green Star Circle",startCol:0,startRow:77,endCol:6,endRow:78},{animationName:"Gold Star Circle",startCol:0,startRow:79,endCol:6,endRow:80},{animationName:"Bread",startCol:0,startRow:81,endCol:7,endRow:81},{animationName:"Yellow Fire Ring",startCol:0,startRow:82,endCol:7,endRow:82},{animationName:"Totems",startCol:0,startRow:83,endCol:7,endRow:83},{animationName:"Eye Blink",startCol:0,startRow:84,endCol:7,endRow:84},{animationName:"Pink Star",startCol:0,startRow:85,endCol:7,endRow:85},{animationName:"Orange Star",startCol:0,startRow:86,endCol:7,endRow:86},{animationName:"Red Eye Blink",startCol:0,startRow:87,endCol:6,endRow:88},{animationName:"Eagle",startCol:0,startRow:89,endCol:7,endRow:89},{animationName:"Sleep",startCol:0,startRow:90,endCol:6,endRow:91},{animationName:"Armor",startCol:0,startRow:92,endCol:7,endRow:92},{animationName:"Blind Eye Blink",startCol:0,startRow:93,endCol:7,endRow:93},{animationName:"Fire Rain",startCol:0,startRow:94,endCol:7,endRow:96,fastAnimation:!0},{animationName:"Blue Rain",startCol:0,startRow:97,endCol:7,endRow:99,fastAnimation:!0},{animationName:"Green Rain",startCol:0,startRow:100,endCol:7,endRow:102,fastAnimation:!0},{animationName:"Lightning Rain",startCol:0,startRow:103,endCol:7,endRow:105,fastAnimation:!0},{animationName:"Pink Rain",startCol:0,startRow:106,endCol:7,endRow:108,fastAnimation:!0},{animationName:"Rainbow Rain",startCol:0,startRow:109,endCol:7,endRow:111,fastAnimation:!0},{animationName:"Spear",startCol:0,startRow:112,endCol:7,endRow:112,directional:!0,customScale:1.5},{animationName:"Red Damage",startCol:0,startRow:113,endCol:2,endRow:113},{animationName:"White Damage",startCol:0,startRow:114,endCol:2,endRow:114},{animationName:"Blue Damage",startCol:0,startRow:115,endCol:2,endRow:115},{animationName:"Green Damage",startCol:0,startRow:116,endCol:2,endRow:116},{animationName:"Red Splat",startCol:0,startRow:117,endCol:2,endRow:117},{animationName:"Electric Damage",startCol:0,startRow:118,endCol:2,endRow:118},{animationName:"Fire Damage",startCol:0,startRow:119,endCol:2,endRow:119},{animationName:"Poison Damage",startCol:0,startRow:120,endCol:2,endRow:120},{animationName:"Sonic Damage",startCol:0,startRow:121,endCol:2,endRow:121},{animationName:"Pink Damage",startCol:0,startRow:122,endCol:2,endRow:122},{animationName:"Fat Red Arrow",startCol:0,startRow:123,endCol:7,endRow:123,directional:!0},{animationName:"Wall Arrow",startCol:0,startRow:124,endCol:7,endRow:124,directional:!0}];var yr=class{constructor(){this.spriteAnimationManager=new gr,this.tileDamageSpriteOverlay=new Rr,this.oreSpriteOverlay=new Pr,this.loaded=!1,this.tileSpritesheet=new Tr("spritesheet/tile_spritesheet.png",n.tile.size),this.tileTypeBackgroundSpritesheet=new Cr("spritesheet/tile_type_background.png",n.tile.size),this.characterSpritesheet=new fr("spritesheet/character_spritesheet.png",n.tile.size,this.spriteAnimationManager),this.itemOverlaySpritesheet=new Sr("spritesheet/item_overlay_spritesheet.png",n.tile.size*3,this.spriteAnimationManager),this.staticFixtureSpritesheet=new si("spritesheet/static_fixture_spritesheet.png",n.tile.size),this.monsterSpritesheet=new Ar("spritesheet/monsters0.png","spritesheet/monsters1.png",n.tile.size,this.spriteAnimationManager),this.tileSpriteOverlaySpritesheet=new Mr("spritesheet/tile_overlay.png",n.tile.size,this.spriteAnimationManager,this.tileDamageSpriteOverlay,this.oreSpriteOverlay),this.spellFxSpritesheet=new Lr("spritesheet/SpellFX.png",31,Nl,7,this.spriteAnimationManager)}isInitialized(){return this.loaded||(this.loaded=this.tileSpritesheet.loaded&&this.tileTypeBackgroundSpritesheet.loaded&&this.characterSpritesheet.loaded&&this.itemOverlaySpritesheet.loaded&&this.staticFixtureSpritesheet.loaded&&this.monsterSpritesheet.isLoaded()&&this.tileSpriteOverlaySpritesheet.loaded&&this.spellFxSpritesheet.loaded),this.loaded}};var ze={NO_OPEN_BORDERS:0,NORTH_BORDER_OPEN:1,SOUTH_BORDER_OPEN:2,NORTH_SOUTH_OPEN:3,WEST_BORDER_OPEN:4,NORTH_WEST_OPEN:5,SOUTH_WEST_OPEN:6,NORTH_SOUTH_WEST_OPEN:7,EAST_BORDER_OPEN:8,NORTH_EAST_OPEN:9,SOUTH_EAST_OPEN:10,NORTH_SOUTH_EAST_OPEN:11,WEST_EAST_OPEN:12,NORTH_WEST_EAST:13,SOUTH_WEST_EAST:14,ALL_BORDERS_OPEN:15};var Er=class{constructor(){this.northBorder=null,this.eastBorder=null,this.southBorder=null,this.westBorder=null,this.northEastBorder=null,this.northSouthBorder=null,this.northWestBorder=null,this.southEastBorder=null,this.eastWestBorder=null,this.southWestBorder=null,this.northEastSouthBorder=null,this.northSouthWestBorder=null,this.northEastWestBorder=null,this.eastWestSouthBorder=null,this.northEastSouthWestBorder=null,this.noBorder=null}getTileSprite(e){switch(e){case ze.NO_OPEN_BORDERS:return this.noBorder;case ze.NORTH_BORDER_OPEN:return this.northBorder;case ze.SOUTH_BORDER_OPEN:return this.southBorder;case ze.NORTH_SOUTH_OPEN:return this.northSouthBorder;case ze.WEST_BORDER_OPEN:return this.westBorder;case ze.NORTH_WEST_OPEN:return this.northWestBorder;case ze.SOUTH_WEST_OPEN:return this.southWestBorder;case ze.NORTH_SOUTH_WEST_OPEN:return this.northSouthWestBorder;case ze.EAST_BORDER_OPEN:return this.eastBorder;case ze.NORTH_EAST_OPEN:return this.northEastBorder;case ze.SOUTH_EAST_OPEN:return this.southEastBorder;case ze.NORTH_SOUTH_EAST_OPEN:return this.northEastSouthBorder;case ze.WEST_EAST_OPEN:return this.eastWestBorder;case ze.NORTH_WEST_EAST:return this.northEastWestBorder;case ze.SOUTH_WEST_EAST:return this.eastWestSouthBorder;case ze.ALL_BORDERS_OPEN:return this.northEastSouthWestBorder;default:return console.log("TileTemplate.getTileSprite() invalid border code: "+e),this.noBorder}}};var y=class{constructor(e,t,i,r,s,o){this.id=e,this.name=t,this.iconFileName=i,this.opaque=r,this.lightingSupported=s,this.rarityModifier=o,this.tileTemplate=null,this.tileTemplate2=null,this.tileTemplate3=null,this.tileTypeBackground=null,this.layerDescription=null}getRandomTemplate(){let e=Math.random();return e<.333?this.tileTemplate:e<.666?this.tileTemplate2:this.tileTemplate3}};var ge={EMPTY:new y("0","Empty","sky.png",!0,!1,R.COMMON),SKY:new y("1","Sky","sky.png",!0,!1,R.COMMON),GRASS:new y("2","Grass","grass.png",!0,!1,R.COMMON),DIRT:new y("10","Dirt","dirt.png",!0,!0,R.COMMON)};function cd(){let l=[],e=11;return l.push(new y(""+e++,"Blue Green Clay","blue_green_clay.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Red Clay","red_clay.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Grey Sandstone","grey_sandstone.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Brown Sandstone","brown_sandstone.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Green Pyronxenite","green_pyronxenite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Blue Dunite","blue_dunite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Deficient Hematite","deficient_hematite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Blue Sandstone","blue_sandstone.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Pink Slate","pink_slate.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Green Basalt","green_basalt.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Deep Bismuth","deep_bismuth.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Dark Phrenite","dark_phrenite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Blue Stone","blue_stone.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Orange Alexandrite","orange_alexandrite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Defective Cobalt","defective_cobalt.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Green Schist","green_schist.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Pale Blue Stone","pale_blue_stone.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Red Pyronxenite","red_pyronxenite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Teal Clay","teal_clay.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Bloodstone","bloodstone.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Grey Orange Granite","grey_orange_granite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Aqua Carnelion","aqua_carnelion.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Purple Grey Quartz","purple_grey_quartz.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Substandard Gypsum","substandard_gypsum.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Red Magnetite","red_magnetite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Arkose Sandstone","arkose_sandstone.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Gabbro","gabbro.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Dark Purple Clay","dark_purple_clay.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Rose Stone","rose_stone.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Purple Grey Granite","purple_grey_granite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Green Slate","green_slate.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Blue Schist","blue_schist.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Rotten Vanadium","rotten_vanadium.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Green Quartz","green_quartz.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Golden Slate","golden_slate.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Slimy Pyrrhotite","slimy_pyrrhotite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Green Jasper","green_jasper.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Blood Agate","blood_agate.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Compressed Bauxite","compressed_bauxite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Darkest Adventurine","darkest_adventurine.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Pink Amethyst","pink_amethyst.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Dark Iron Stone","dark_iron_stone.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Brown Jasper","brown_jasper.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Hellish Agate","hellish_agate.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Nasty Bauxite","nasty_bauxite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Diabolical Malachite","diabolical_malachite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Sun Stone","red_sunstone.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Cruek Cesium","cruel_cesium.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Orange Carnelion","orange_carnelion.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Purple Charoite","purple_charoite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Heliotrope Granite","heliotrope_granite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Pink Kunzite","pink_kunzite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Fractured Slate","fractured_slate.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Pink Grey Granite","pink_grey_granite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Blue Galaxy Granite","blue_galaxy_granite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Black Quartz","black_quartz.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Vile Hematite","vile_hematite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Green Clay","green_clay.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Purple Granite","purple_granite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Blue Quartz","blue_quartz.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Orange Basalt","orange_basalt.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Yellow Sandstone","yellow_sandstone.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Blue Green Agate","blue_green_agate.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Calamitous Calcite","calamitous_calcite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Brown Basalt","brown_basalt.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Emerald Dolomite","emerald_dolomite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Dark Pyroxenite","dark_pyroxenite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Violet Tanzanite","violet_tanzanite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Green Serpentine","green_serpentine.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Ruby Basalt","ruby_basalt.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Purple Schist","purple_schist.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Green Aragonite","green_aragonite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Red Spinel","red_spinel.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Infected Schist","infected_schist.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Salmon Basalt","salmon_basalt.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Enchanted Jasper","enchanted_jasper.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Cursed Basalt","cursed_basalt.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Sinister Slate","sinister_slate.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Orange Apocalypse","orange_apocalypse.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Devil Stone","devil_stone.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Asbestos","asbestos.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Bleak Vanadium","bleak_vanadium.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Poisoned Aragonite","poisoned_aragonite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Purple Dunite","purple_dunite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Corrupted Agate","corrupted_agate.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Torched Aragonite","torched_aragonite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Forbidden Quartz","forbidden_quartz.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Violet Pyroxenite","violet_pyroxenite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Slate Soulstone","slate_soulstone.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Fractured Jasper","fractured_jasper.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Sky Quartz","sky_quartz.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Toxic Granite","toxic_granite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Corroded Ruby","corroded_ruby.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Offensive Shale","offensive_shale.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Petrified Flamingos","petrified_flamingos.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Crystallized Onyx","crystallized_onyx.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Orange Jasper","orange_jasper.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Satanic Slate","satanic_slate.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Malignant Pyrite","malignant_pyrite.png",!0,!0,R.COMMON)),l.push(new y(""+e++,"Pink Shale","pink_shale.png",!0,!0,R.COMMON)),l}var ft=cd(),Al={},Pl={},Rl={},Ml={};function ur(l){if(l===ge.EMPTY||l===ge.SKY)return null;let e=Al[l.id];return e||(e=new y(l.id+"_g","Gold","gold.png",!0,!0,R.GOLD),Al[l.id]=e),e}function cr(l){if(l===ge.EMPTY||l===ge.SKY)return null;let e=Pl[l.id];return e||(e=new y(l.id+"_d","Ruby","ruby.png",!0,!0,R.RUBY),Pl[l.id]=e),e}function mr(l){if(l===ge.EMPTY||l===ge.SKY)return null;let e=Ml[l.id];return e||(e=new y(l.id+"_u","Upgrade","onyx.png",!0,!0,R.UPGRADE),Ml[l.id]=e),e}function pr(l){if(l===ge.EMPTY||l===ge.SKY)return null;let e=Rl[l.id];return e||(e=new y(l.id+"_o","Ore","purple_ore.png",!0,!0,R.ORE),Rl[l.id]=e),e}function Va(l,e){if(l[e.id]=e,e===ge.EMPTY||e===ge.SKY)return;let t=ur(e);l[t.id]=t;let i=pr(e);l[i.id]=i;let r=mr(e);l[r.id]=r;let s=cr(e);l[s.id]=s}function md(){let l={};Va(l,ge.SKY),Va(l,ge.GRASS),Va(l,ge.DIRT);for(let e=0;e<ft.length;e++)Va(l,ft[e]);return l}var _l=md();var bl=new ArrayBuffer(4),Ll=new Uint32Array(bl),yl=new Float32Array(bl),Z=class{constructor(){}static floor(e){if(e<0){let t=-this.floorPositive(-e);return e===t?t:t-1}else return this.floorPositive(e)}static floorPositive(e){return e<2147483648?e|0:Math.floor(e)}static len(e){return 1/this.invSqrt(e.x*e.x+e.y*e.y)}static nor(e){let t=this.len(e);return t!=0&&(e.x/=t,e.y/=t),e}static dist(e,t){let i=e.x-t.x,r=e.y-t.y;return 1/this.invSqrt(i*i+r*r)}static invSqrt(e){yl[0]=e,Ll[0]=1597463007-(Ll[0]>>1);let t=yl[0];return t*(1.5-.5*t*t*e)}};var z=class{constructor(){}resetFull(){}resetForPrestige(){}};var br=class extends z{constructor(){super(),this.origin=new b(0,0),this.grids=this.instantiateGrids();for(let e=0;e<this.grids.length;e++)this.grids[e].findTileNeighborsFull();this.changeCount=0,this.shiftCount=0}instantiateGrids(){let e=n.grid.gridPixelWidth,t=n.grid.gridPixelHeight,i=new Array(9);return i[0]=new rt(this,new b(-e,-t)),i[1]=new rt(this,new b(0,-t)),i[2]=new rt(this,new b(e,-t)),i[3]=new rt(this,new b(-e,0)),i[4]=new rt(this,new b(0,0)),i[5]=new rt(this,new b(e,0)),i[6]=new rt(this,new b(-e,t)),i[7]=new rt(this,new b(0,t)),i[8]=new rt(this,new b(e,t)),i}getGridTile(e,t){let i=this.getGrid(e,t);return i?i.getGridTile(e,t):null}getGrid(e,t){let i=e*n.tile.size,r=t*n.tile.size,s=this.grids[4];if(!s)return null;if(s.containsXY(i,r))return s;let o=s.origin.x,a=o+n.grid.gridPixelWidth,h=s.origin.y,m=h+n.grid.gridPixelHeight,p=null;return i>=o&&i<a?r<h?p=this.grids[1]:r>=m&&(p=this.grids[7]):i<s.origin.x?r>=h&&r<m?p=this.grids[3]:r<h?p=this.grids[0]:r>=m&&(p=this.grids[6]):i>=a&&(r>=h&&r<m?p=this.grids[5]:r<h?p=this.grids[2]:r>=m&&(p=this.grids[8])),p&&p.containsXY(i,r)?p:null}findGridContaining(e){let t=Z.floor(e.x/n.tile.size),i=Z.floor(e.y/n.tile.size);return this.getGrid(t,i)}findGridTile(e){let t=Z.floor(e.x/n.tile.size),i=Z.floor(e.y/n.tile.size);return this.getGridTile(t,i)}findGridTileXY(e,t){let i=Z.floor(e/n.tile.size),r=Z.floor(t/n.tile.size);return this.getGridTile(i,r)}findGridRegion(e){if(!this.groups)return null;let t=this.findGridTile(e);return t!=null?t.getRegion():null}resetFull(){this.changeCount=0,this.shiftCount=0}resetForPrestige(){this.resetFull()}};var Ir=class extends pt{constructor(e,t){super(t),this.zone=e,this.tiles=this.createTiles(),this.mineTiles=[],this.vectorFieldNumber=-1}createTiles(){let e=new Array(n.grid.numTileColsInRegion*n.grid.numTileRowsInRegion),t=this.zone.grid,i=this.getOrigin(),r=i.x,s=i.y,o=0;for(let a=0;a<n.grid.numTileColsInRegion;a++)for(let h=0;h<n.grid.numTileRowsInRegion;h++)e[o++]=new vr(t,this,new b(r+n.tile.size*a,s+n.tile.size*h));return e}initialize(e,t){this.origin.set(e,t);let i=this.origin.x,r=this.origin.y,s=0;for(let o=0;o<n.grid.numTileColsInRegion;o++)for(let a=0;a<n.grid.numTileRowsInRegion;a++)this.tiles[s++].initialize(i+n.tile.size*o,r+n.tile.size*a);this.mineTiles.length=0,this.vectorFieldNumber=-1}getTileIndex(e){let t=e.getTileCol()-this.getOriginTileCol(),i=e.getTileRow()-this.getOriginTileRow();return t*n.grid.numTileRowsInRegion+i}getZone(){return this.zone}getGrid(){return this.zone.grid}getWorldGrid(){return this.zone.getWorldGrid()}getTiles(){return this.tiles}getPixelWidth(){return n.grid.regionPixelWidth}getPixelHeight(){return n.grid.regionPixelHeight}findGridTile(e){let t=Z.floor(e.x/n.tile.size),i=Z.floor(e.y/n.tile.size);return this.getGridTileAbsolute(t,i)}getGridTileAbsolute(e,t){let i=this.origin,r=Z.floor(i.x/n.tile.size),s=Z.floor(i.y/n.tile.size);return this.getGridTileLocal(e-r,t-s)}getGridTileLocal(e,t){if(e<0||e>=n.grid.numTileColsInRegion||t<0||t>=n.grid.numTileRowsInRegion)return null;let i=e*n.grid.numTileRowsInRegion+t;return i>=0&&i<this.tiles.length?this.tiles[i]:(console.log("GridRegion.getGridTileLocal() Failed to find tile. col="+e+" row="+t+" index="+i),null)}findTileNeighborsFull(){for(let e=0;e<this.tiles.length;e++)this.tiles[e].findNeighbors()}getTile(e,t){return this.tiles[e*n.grid.numTileRowsInRegion+t]}findRegionBorderTileNeighbors(){let e=n.grid.numTileColsInRegion-1,t=n.grid.numTileRowsInRegion-1,i=0,r=0;this.getTile(e,t).findNeighbors(),this.getTile(e,i).findNeighbors(),this.getTile(r,t).findNeighbors(),this.getTile(r,i).findNeighbors();for(let s=1;s<n.grid.numTileRowsInRegion-1;s++)this.getTile(e,s).findNeighbors();for(let s=1;s<n.grid.numTileRowsInRegion-1;s++)this.getTile(r,s).findNeighbors();for(let s=1;s<n.grid.numTileColsInRegion-1;s++)this.getTile(s,i).findNeighbors();for(let s=1;s<n.grid.numTileColsInRegion-1;s++)this.getTile(s,t).findNeighbors()}findTileNeighborsBorderRight(){let e=n.grid.numTileColsInRegion-1;for(let t=0;t<n.grid.numTileRowsInRegion;t++)this.getTile(e,t).findNeighborRight()}nullifyTileNeighborsBorderRight(){let e=n.grid.numTileColsInRegion-1;for(let t=0;t<n.grid.numTileRowsInRegion;t++)this.getTile(e,t).nullifyNeighborRight()}evaluateTileBordersRight(){let e=n.grid.numTileColsInRegion-1;for(let t=0;t<n.grid.numTileRowsInRegion;t++)this.getTile(e,t).evaluateBorders()}findTileNeighborsBorderLeft(){for(let e=0;e<n.grid.numTileRowsInRegion;e++)this.getTile(0,e).findNeighborLeft()}nullifyTileNeighborsBorderLeft(){for(let e=0;e<n.grid.numTileRowsInRegion;e++)this.getTile(0,e).nullifyNeighborLeft()}evaluateTileBordersLeft(){for(let e=0;e<n.grid.numTileRowsInRegion;e++)this.getTile(0,e).evaluateBorders()}findTileNeighborsBorderBottom(){let e=n.grid.numTileRowsInRegion-1;for(let t=0;t<n.grid.numTileColsInRegion;t++)this.getTile(t,e).findNeighborBottom()}nullifyTileNeighborsBorderBottom(){let e=n.grid.numTileRowsInRegion-1;for(let t=0;t<n.grid.numTileColsInRegion;t++)this.getTile(t,e).nullifyNeighborBottom()}evaluateTileBordersBottom(){let e=n.grid.numTileRowsInRegion-1;for(let t=0;t<n.grid.numTileColsInRegion;t++)this.getTile(t,e).evaluateBorders()}findTileNeighborsBorderTop(){for(let e=0;e<n.grid.numTileColsInRegion;e++)this.getTile(e,0).findNeighborTop()}nullifyTileNeighborsBorderTop(){for(let e=0;e<n.grid.numTileColsInRegion;e++)this.getTile(e,0).nullifyNeighborTop()}evaluateTileBordersTop(){for(let e=0;e<n.grid.numTileColsInRegion;e++)this.getTile(e,0).evaluateBorders()}};var Ua=["00","01","02","03","04","05","06","07","08","09","0A","0B","0C","0D","0E","0F","10","11","12","13","14","15","16","17","18","19","1A","1B","1C","1D","1E","1F","20","21","22","23","24","25","26","27","28","29","2A","2B","2C","2D","2E","2F","30","31","32","33","34","35","36","37","38","39","3A","3B","3C","3D","3E","3F","40","41","42","43","44","45","46","47","48","49","4A","4B","4C","4D","4E","4F","50","51","52","53","54","55","56","57","58","59","5A","5B","5C","5D","5E","5F","60","61","62","63","64","65","66","67","68","69","6A","6B","6C","6D","6E","6F","70","71","72","73","74","75","76","77","78","79","7A","7B","7C","7D","7E","7F","80","81","82","83","84","85","86","87","88","89","8A","8B","8C","8D","8E","8F","90","91","92","93","94","95","96","97","98","99","9A","9B","9C","9D","9E","9F","A0","A1","A2","A3","A4","A5","A6","A7","A8","A9","AA","AB","AC","AD","AE","AF","B0","B1","B2","B3","B4","B5","B6","B7","B8","B9","BA","BB","BC","BD","BE","BF","C0","C1","C2","C3","C4","C5","C6","C7","C8","C9","CA","CB","CC","CD","CE","CF","D0","D1","D2","D3","D4","D5","D6","D7","D8","D9","DA","DB","DC","DD","DE","DF","E0","E1","E2","E3","E4","E5","E6","E7","E8","E9","EA","EB","EC","ED","EE","EF","F0","F1","F2","F3","F4","F5","F6","F7","F8","F9","FA","FB","FC","FD","FE","FF"],ce=class l{constructor(e,t,i,r){this.r=e,this.g=t,this.b=i,this.a=r,this.fillColor=null,this.clamp()}static createColor(e){let t=(e&4278190080)>>24,i=(e&16711680)>>16,r=(e&65280)>>8,s=e&255;return new l(t/255,i/255,r/255,s/255)}set(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this.fillColor=null}setAlpha(e){this.a=e}addAlpha(e){this.a+=e,this.a>1&&(this.a=1)}reset(){this.r=0,this.g=0,this.b=0,this.a=0}setRgba(e,t,i,r){this.r=e,this.g=t,this.b=i,this.a=r,this.clamp(),this.fillColor=null}setRgbaFast(e,t,i,r){this.r=e,this.g=t,this.b=i,this.a=r,this.fillColor=null}resetFast(){this.r=0,this.g=0,this.b=0,this.a=0,this.fillColor=null}mul(e){this.r*=e,this.g*=e,this.b*=e,this.a*=e,this.clamp(),this.fillColor=null}add(e){this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this.clamp(),this.fillColor=null}addFast(e){this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this.fillColor=null}addRgba(e,t,i,r){this.r+=e,this.g+=t,this.b+=i,this.a+=r,this.clamp(),this.fillColor=null}addFastRgba(e,t,i,r){this.r+=e,this.g+=t,this.b+=i,this.a+=r,this.fillColor=null}getFillColor(){return this.fillColor||(this.fillColor=this.createFillColor()),this.fillColor}createFillColor(){let e=(1-this.a)*255|0,t=this.r*255|0,i=this.g*255|0,r=this.b*255|0;return"#"+Ua[t]+Ua[i]+Ua[r]+Ua[e]}clamp(){this.r<0?this.r=0:this.r>1&&(this.r=1),this.g<0?this.g=0:this.g>1&&(this.g=1),this.b<0?this.b=0:this.b>1&&(this.b=1),this.a<0?this.a=0:this.a>1&&(this.a=1)}};var pd=new ce(0,0,0,.3),xr=class{constructor(){this.everVisibleToCharacter=!1,this.currentlyVisibleToCharacter=!1,this.environmentLighting=new ce(0,0,0,0),this.dynamicLighting=new ce(0,0,0,0),this.positionalLighting=new ce(0,0,0,0),this.shadowColor=new ce(0,0,0,0),this.sunlightFull=!1,this.sunlightPartial=0}resetLighting(){this.dynamicLighting.resetFast(),this.environmentLighting.resetFast(),this.positionalLighting.resetFast(),this.currentlyVisibleToCharacter=!1}resetPositionalLighting(){this.positionalLighting.resetFast(),this.currentlyVisibleToCharacter=!1}resetEnvironmentLighting(){this.environmentLighting.resetFast()}resetDynamicLighting(){this.dynamicLighting.resetFast()}addPositionalLighting(e){this.positionalLighting.add(e)}addEnvironmentLighting(e){this.environmentLighting.add(e)}addDynamicLighting(e){this.dynamicLighting.add(e)}markTileAsCurrentlyVisible(){this.currentlyVisibleToCharacter=!0,this.everVisibleToCharacter=!0}markAsSunlightFull(){this.sunlightFull=!0,this.everVisibleToCharacter=!0}isSunlightPartial(){return this.sunlightPartial>0}sunlightPartialIncrement(){this.sunlightPartial++,this.everVisibleToCharacter=!0}sunlightPartialDecrement(){this.sunlightPartial>0&&this.sunlightPartial--}calculateShadowColor(){return this.shadowColor.set(pd),this.currentlyVisibleToCharacter&&(this.shadowColor.addFast(this.environmentLighting),this.shadowColor.addFast(this.dynamicLighting),this.shadowColor.addFast(this.positionalLighting),this.shadowColor.clamp()),this.sunlightFull?this.shadowColor.setAlpha(1):this.sunlightPartial>0&&this.shadowColor.addAlpha(.3),this.shadowColor}reset(){this.everVisibleToCharacter=!1,this.currentlyVisibleToCharacter=!1,this.sunlightFull=!1,this.sunlightPartial=0}};var tt={PREMIUM:100,COMMON_REVEAL_CAVERN:5,COMMON_HIDDEN_NEIGHBOR:3,WORTHLESS:0,IN_RANGE_OPEN:-10,IN_RANGE_UNSEEN:-20,UNSET:-1e3};var Dr=class{constructor(){this.pathNumber=0,this.closed=!1,this.cameFrom=null,this.cost=0,this.score=0,this.inOpenList=!1,this.mineScore=-1,this.mineVectorFieldNumber=-1}getCameFrom(e){return this.pathNumber!=e&&this.reset(e),this.cameFrom}set(e,t,i,r){this.pathNumber!=r&&this.reset(r),this.cameFrom=e,this.cost=t,this.score=i}getCost(e){return this.pathNumber!=e&&this.reset(e),this.cost}setCost(e,t){this.pathNumber!=t&&this.reset(t),this.cost=e}getScore(e){return this.pathNumber!=e&&this.reset(e),this.score}setClosed(e,t){this.pathNumber!=t&&this.reset(t),this.closed=e}isClosed(e){return this.pathNumber!=e&&this.reset(e),this.closed}setInOpenList(e,t){this.pathNumber!=t&&this.reset(t),this.inOpenList=e}isInOpenList(e){return this.pathNumber!=e&&this.reset(e),this.inOpenList}getMineScore(e){return this.mineVectorFieldNumber!=e?tt.UNSET:this.mineScore}setMineScore(e,t){this.mineVectorFieldNumber=t,this.mineScore=e}reset(e){this.pathNumber=e,this.closed=!1,this.cameFrom=null,this.cost=0,this.score=0,this.inOpenList=!1}};var Or=class{constructor(e,t,i,r){this.spriteName=e,this.traversable=t,this.opaque=i,this.stateSavable=r,this.sprite=null}};var lt=0,dt=1,_t=2,Lt=3,ml=new d(0),vr=class extends pt{constructor(e,t,i){super(i),this.grid=e,this.region=t,this.sprite=null,this.backgroundSprite=null,this.neighbors=new Array(4),this.neighbors[lt]=null,this.neighbors[dt]=null,this.neighbors[_t]=null,this.neighbors[Lt]=null,this.tileType=ge.EMPTY,this.tileTemplate=null,this.borderCode=0,this.open=!1,this.fixtureDescription=null,this.lighting=new xr,this.pathData=new Dr,this.initialHealth=null,this.health=null,this.healthPercent=100,this.mineTileIndex=-1}initialize(e,t){this.origin.set(e,t),this.tileType=ge.EMPTY,this.tileTemplate=null,this.sprite=null,this.fixtureDescription=null,this.backgroundSprite=null,this.open=!1,this.mineTileIndex=-1,this.health=null,this.initialHealth=null,this.healthPercent=100,this.lighting.reset()}tileInit(e,t){this.borderCode=-1,this.open=e,this.setTileType(t)}setTileType(e){if(!e){console.log("GridTyple.setTileType is null");return}this.tileType!==e&&(this.tileType=e,this.tileTemplate=e.getRandomTemplate(),this.tileTemplate&&!this.open&&this.borderCode!=-1&&(this.sprite=this.tileTemplate.getTileSprite(this.borderCode)))}getHealth(){return this.open?null:(this.health||this.calculateTileHealth(),this.health)}calculateTileGold(e){if(this.tileType.rarityModifier!==R.GOLD){e.setZero();return}e.copy(this.tileType.layerDescription.baseGold)}calculateTileHealth(){this.open?this.health=null:(this.health=new d(0),this.tileType.layerDescription.calculateTileHealth(this.getTileRow(),this.health),this.initialHealth=new d(0),this.initialHealth.copy(this.health))}isCommon(){return this.tileType.rarityModifier===R.COMMON}isCurrency(){return this.tileType.rarityModifier===R.ORE}isPriority(){return this.tileType.rarityModifier===R.GOLD||this.tileType.rarityModifier===R.RUBY||this.tileType.rarityModifier===R.UPGRADE}getGrid(){return this.grid}getRegion(){return this.region}getWorldGrid(){return this.grid.getWorldGrid()}getSprite(){return this.sprite}setSprite(e){this.sprite=e}createCenterPositionVector(){let e=new b(0,0);return this.assignCenterPosition(e),e}assignCenterPosition(e){e.set(this.origin.x+n.tile.halfSize,this.origin.y+n.tile.halfSize)}isTraversable(){return this.open?!this.fixtureDescription||this.fixtureDescription.traversable:!1}isOpaque(){return this.open?this.fixtureDescription&&this.fixtureDescription.opaque:this.tileType.opaque}getPixelWidth(){return n.tile.size}getPixelHeight(){return n.tile.size}getTileCol(){return this.getOriginTileCol()}getTileRow(){return this.getOriginTileRow()}createId(){return this.getTileCol()+"_"+this.getTileRow()}getNeighbors(){return this.neighbors}findNeighbors(){this.neighbors[0]=null,this.neighbors[1]=null,this.neighbors[2]=null,this.neighbors[3]=null;let e=this.getTileCol(),t=this.getTileRow(),i=this.getNeighborColRow(e,t-1);i&&(this.neighbors[lt]=i,i.neighbors[dt]=this);let r=this.getNeighborColRow(e,t+1);r&&(this.neighbors[dt]=r,r.neighbors[lt]=this);let s=this.getNeighborColRow(e+1,t);s&&(this.neighbors[_t]=s,s.neighbors[Lt]=this);let o=this.getNeighborColRow(e-1,t);o&&(this.neighbors[Lt]=o,o.neighbors[_t]=this)}nullifyNeighborRight(){this.neighbors[_t]=null}nullifyNeighborLeft(){this.neighbors[Lt]=null}nullifyNeighborBottom(){this.neighbors[dt]=null}nullifyNeighborTop(){this.neighbors[lt]=null}findNeighborRight(){this.neighbors[_t]=null;let e=this.getTileCol(),t=this.getTileRow(),i=this.getNeighborColRow(e+1,t);i&&(this.neighbors[_t]=i,i.neighbors[Lt]=this)}findNeighborLeft(){this.neighbors[Lt]=null;let e=this.getTileCol(),t=this.getTileRow(),i=this.getNeighborColRow(e-1,t);i&&(this.neighbors[Lt]=i,i.neighbors[_t]=this)}findNeighborTop(){this.neighbors[lt]=null;let e=this.getTileCol(),t=this.getTileRow(),i=this.getNeighborColRow(e,t-1);i&&(this.neighbors[lt]=i,i.neighbors[dt]=this)}findNeighborBottom(){this.neighbors[dt]=null;let e=this.getTileCol(),t=this.getTileRow(),i=this.getNeighborColRow(e,t+1);i&&(this.neighbors[dt]=i,i.neighbors[lt]=this)}isAdjacentTo(e){let t=this.getTileRow(),i=e.getTileRow();if(Math.abs(t-i)>1)return!1;let r=this.getTileCol(),s=e.getTileCol();return!(Math.abs(r-s)>1)}isNeighborTile(e){return e===this.neighbors[0]||e===this.neighbors[1]||e===this.neighbors[2]||e===this.neighbors[3]}getNeighborColRow(e,t){let i=this.region.getGridTileAbsolute(e,t);if(!i){let r=this.region.zone;i=r.getGridTileAbsolute(e,t),i||(i=r.grid.getGridTileAbsolute(e,t),i||(i=r.grid.worldGrid.getGridTile(e,t)))}return i}getNeighbor(e){if(this.contains(e))return this;let t=this.findNeighborContaining(e);if(t)return t;let i=Z.floor(e.x/n.tile.size),r=Z.floor(e.y/n.tile.size);return this.getNeighborColRow(i,r)}getNeighborLeft(){return this.neighbors[Lt]}getNeighborRight(){return this.neighbors[_t]}getNeighborTop(){return this.neighbors[lt]}getNeighborBottom(){return this.neighbors[dt]}getNeighborTopLeft(){let e=this.neighbors[lt];return e?e.getNeighborLeft():null}getNeighborTopRight(){let e=this.neighbors[lt];return e?e.getNeighborRight():null}getNeighborBottomLeft(){let e=this.neighbors[dt];return e?e.getNeighborLeft():null}getNeighborBottomRight(){let e=this.neighbors[dt];return e?e.getNeighborRight():null}isNeighborLeft(e){return e===this.neighbors[Lt]}isNeighborRight(e){return e===this.neighbors[_t]}isNeighborTop(e){return e===this.neighbors[lt]}isNeighborBottom(e){return e===this.neighbors[dt]}findNeighborContaining(e){for(let o=0;o<this.neighbors.length;o++){let a=this.neighbors[o];if(a&&a.contains(e))return a}let t=this.getNeighborTopLeft();if(t&&t.contains(e))return t;let i=this.getNeighborTopRight();if(i&&i.contains(e))return i;let r=this.getNeighborBottomLeft();if(r&&r.contains(e))return r;let s=this.getNeighborBottomRight();return s&&s.contains(e)?s:null}findRelativeTile(e,t){let i=this.getGrid().getWorldGrid(),r=this.getTileCol()+e,s=this.getTileRow()+t;return i.getGridTile(r,s)}evaluateBorders(){if(this.open)this.borderCode=0,this.sprite=null;else{let e=this.borderCode,t=this.neighbors[lt],i=this.neighbors[dt],r=this.neighbors[_t],s=this.neighbors[Lt],o=t&&t.open?1:0,a=i&&i.open?2:0,h=s&&s.open?4:0,m=r&&r.open?8:0;this.borderCode=o+a+h+m,e!==this.borderCode&&this.tileTemplate&&(this.sprite=this.tileTemplate.getTileSprite(this.borderCode))}}onTileDamaged(e){this.open||!e||(this.health||this.calculateTileHealth(),this.health.sub(e),this.health.lessThanEqualsZero()?this.onTileBreak():this.healthPercent=this.calculateHealthPercent())}calculateHealthPercent(){return this.open?0:this.health?this.health.equalsZero()?0:(ml.copy(this.health),ml.divide(this.initialHealth),ml.toNumber()*100|0):100}isTileDamaged(){return this.open||!this.health?!1:!this.health.equals(this.initialHealth)}onTileBreak(){if(!this.open){this.open=!0,this.borderCode=-1,this.evaluateBorders(),this.handleTileOpened();let e=this.getNeighborTop();e&&e.open&&e.fixtureDescription&&(e.fixtureDescription=null);let t=this.getNeighborBottom();t&&t.open&&t.fixtureDescription&&(t.fixtureDescription=null),this.pathData.mineScore=0,this.pathData.mineVectorFieldNumber=0,this.health=null,this.initialHealth=null,this.healthPercent=0,this.mineTileIndex>=0&&(this.region.mineTiles[this.mineTileIndex]=null,this.mineTileIndex=-1),this.getGrid().markGridAsChanged()}for(let e=0;e<this.neighbors.length;e++){let t=this.neighbors[e];t&&t.evaluateBorders()}}handleTileOpened(){if(!this.open)return;let e=this.getNeighborTop();e&&e.open&&e.lighting.sunlightFull&&this.handleSunlightStart()}handleSunlightStart(){this.markAsSunlightFull();let e=this.getNeighborLeft();e&&!e.lighting.sunlightFull&&e.lighting.sunlightPartialIncrement();let t=this.getNeighborRight();if(t&&!t.lighting.sunlightFull&&t.lighting.sunlightPartialIncrement(),!this.open)return;let i=this.getNeighborBottom();i&&!i.lighting.sunlightFull&&i.handleSunlightStart()}handleSunlightStop(){this.lighting.sunlightFull=!1;let e=this.getNeighborLeft();e&&e.lighting.sunlightPartialDecrement();let t=this.getNeighborRight();if(t&&t.lighting.sunlightPartialDecrement(),!this.open)return;let i=this.getNeighborBottom();i&&i.lighting.sunlightFull&&i.handleSunlightStop()}markTileAsEverVisible(){this.lighting.everVisibleToCharacter=!0,this.mineTileIndex<0&&!this.open&&(this.isCurrency()||this.isPriority())&&(this.region.mineTiles.push(this),this.mineTileIndex=this.region.mineTiles.length-1)}markTileAsCurrentlyVisible(){this.lighting.markTileAsCurrentlyVisible(),this.mineTileIndex<0&&!this.open&&(this.isCurrency()||this.isPriority())&&(this.region.mineTiles.push(this),this.mineTileIndex=this.region.mineTiles.length-1)}markAsSunlightFull(){this.lighting.markAsSunlightFull(),this.mineTileIndex<0&&!this.open&&(this.isCurrency()||this.isPriority())&&(this.region.mineTiles.push(this),this.mineTileIndex=this.region.mineTiles.length-1)}addPositionalLighting(e){this.lighting.addPositionalLighting(e),this.markTileAsCurrentlyVisible()}addEnvironmentLighting(e){this.lighting.addEnvironmentLighting(e),this.markTileAsEverVisible()}addDynamicLighting(e){this.lighting.addDynamicLighting(e),this.markTileAsEverVisible()}hash(){let e=this.origin.x/n.tile.size,t=this.origin.y/n.tile.size,i=17;return i=31*i+e,i=31*i+t,i}};var Br=class extends pt{constructor(e,t){super(t),this.grid=e,this.regions=this.createRegions()}createRegions(){let e=this.getOrigin(),t=e.x,i=e.y,r=new Array(n.grid.numRegionColsInZone*n.grid.numRegionRowsInZone),s=0;for(let o=0;o<n.grid.numRegionColsInZone;o++)for(let a=0;a<n.grid.numRegionRowsInZone;a++)r[s++]=new Ir(this,new b(t+n.grid.regionPixelWidth*o,i+n.grid.regionPixelHeight*a));return r}initialize(e,t){this.origin.set(e,t);let i=this.origin.x,r=this.origin.y,s=0;for(let o=0;o<n.grid.numRegionColsInZone;o++)for(let a=0;a<n.grid.numRegionRowsInZone;a++)this.regions[s++].initialize(i+n.grid.regionPixelWidth*o,r+n.grid.regionPixelHeight*a)}getWorldGrid(){return this.grid.getWorldGrid()}getGrid(){return this.grid}getRegions(){return this.regions}getPixelWidth(){return n.grid.zonePixelWidth}getPixelHeight(){return n.grid.zonePixelHeight}getGridTileAbsolute(e,t){let i=this.origin,r=Z.floor(i.x/n.tile.size),s=Z.floor(i.y/n.tile.size);return this.getGridTileLocal(e-r,t-s)}getGridTileLocal(e,t){let i=Z.floor(e/n.grid.regionTileWidth),r=Z.floor(t/n.grid.regionTileHeight);if(i<0||i>=n.grid.numRegionColsInZone||r<0||r>=n.grid.numRegionRowsInZone)return null;let s=i*n.grid.numRegionRowsInZone+r;if(s>=0&&s<this.regions.length){let o=this.regions[s],a=this.getOrigin(),h=Z.floor(a.x/n.tile.size),m=Z.floor(a.y/n.tile.size),p=o.getOrigin(),f=Z.floor(p.x/n.tile.size),N=Z.floor(p.y/n.tile.size);return o.getGridTileLocal(e+h-f,t+m-N)}else return console.log("GridZone.getGridTileLocal() Failed to find tile. col="+e+" row="+t+" index="+s),null}findTileNeighborsFull(){for(let e=0;e<this.regions.length;e++)this.regions[e].findTileNeighborsFull()}findRegionNeighborsBorderEast(){let e=n.grid.numRegionColsInZone-1;for(let t=0;t<n.grid.numRegionRowsInZone;t++)this.findRegion(e,t).findTileNeighborsBorderRight()}findRegionNeighborsBorderWest(){for(let e=0;e<n.grid.numRegionRowsInZone;e++)this.findRegion(0,e).findTileNeighborsBorderLeft()}findRegionNeighborsBorderSouth(){let e=n.grid.numRegionColsInZone-1;for(let t=0;t<n.grid.numRegionColsInZone;t++)this.findRegion(t,e).findTileNeighborsBorderBottom()}findRegionNeighborsBorderNorth(){for(let e=0;e<n.grid.numRegionColsInZone;e++)this.findRegion(e,0).findTileNeighborsBorderTop()}findRegion(e,t){return this.regions[e*n.grid.numRegionRowsInZone+t]}findZoneBorderRegionNeighbors(){let e=n.grid.numRegionColsInZone-1,t=n.grid.numRegionRowsInZone-1,i=0,r=0,s=this.findRegion(e,t),o=this.findRegion(e,i),a=this.findRegion(r,t),h=this.findRegion(r,i);if(s.findTileNeighborsBorderTop(),s.findTileNeighborsBorderRight(),o.findTileNeighborsBorderBottom(),o.findTileNeighborsBorderRight(),a.findTileNeighborsBorderTop(),a.findTileNeighborsBorderLeft(),h.findTileNeighborsBorderBottom(),h.findTileNeighborsBorderLeft(),n.grid.numRegionRowsInZone>2){for(let m=1;m<n.grid.numRegionRowsInZone-1;m++)this.findRegion(e,m).findTileNeighborsBorderRight();for(let m=1;m<n.grid.numRegionRowsInZone-1;m++)this.findRegion(r,m).findTileNeighborsBorderLeft()}if(n.grid.numRegionColsInZone>2){for(let m=1;m<n.grid.numRegionColsInZone-1;m++)this.findRegion(m,i).findTileNeighborsBorderBottom();for(let m=1;m<n.grid.numRegionColsInZone-1;m++)this.findRegion(m,t).findTileNeighborsBorderTop()}}findTileNeighborsZoneBorderRight(){let e=n.grid.numRegionColsInZone-1;for(let t=0;t<n.grid.numRegionRowsInZone;t++)this.findRegion(e,t).findTileNeighborsBorderRight()}nullifyTileNeighborsZoneBorderRight(){let e=n.grid.numRegionColsInZone-1;for(let t=0;t<n.grid.numRegionRowsInZone;t++)this.findRegion(e,t).nullifyTileNeighborsBorderRight()}findTileNeighborsZoneBorderLeft(){for(let e=0;e<n.grid.numRegionRowsInZone;e++)this.findRegion(0,e).findTileNeighborsBorderLeft()}nullifyTileNeighborsZoneBorderLeft(){for(let e=0;e<n.grid.numRegionRowsInZone;e++)this.findRegion(0,e).nullifyTileNeighborsBorderLeft()}findTileNeighborsZoneBorderBottom(){let e=n.grid.numRegionRowsInZone-1;for(let t=0;t<n.grid.numRegionColsInZone;t++)this.findRegion(t,e).findTileNeighborsBorderBottom()}nullifyTileNeighborsZoneBorderBottom(){let e=n.grid.numRegionRowsInZone-1;for(let t=0;t<n.grid.numRegionColsInZone;t++)this.findRegion(t,e).nullifyTileNeighborsBorderBottom()}findTileNeighborsZoneBorderTop(){for(let e=0;e<n.grid.numRegionColsInZone;e++)this.findRegion(e,0).findTileNeighborsBorderTop()}nullifyTileNeighborsZoneBorderTop(){for(let e=0;e<n.grid.numRegionColsInZone;e++)this.findRegion(e,0).nullifyTileNeighborsBorderTop()}evaluateTileBordersRight(){let e=n.grid.numRegionColsInZone-1;for(let t=0;t<n.grid.numRegionRowsInZone;t++)this.findRegion(e,t).evaluateTileBordersRight()}evaluateTileBordersLeft(){for(let e=0;e<n.grid.numRegionRowsInZone;e++)this.findRegion(0,e).evaluateTileBordersLeft()}evaluateTileBordersBottom(){let e=n.grid.numRegionRowsInZone-1;for(let t=0;t<n.grid.numRegionColsInZone;t++)this.findRegion(t,e).evaluateTileBordersBottom()}evaluateTileBordersTop(){for(let e=0;e<n.grid.numRegionColsInZone;e++)this.findRegion(e,0).evaluateTileBordersTop()}};var kr=class extends z{constructor(){super(),this.gridCenter=new b(n.start.startX,n.start.startY),this.stayCenteredOnCharacter=!0,this.screenOrigin=new b(0,0),this.visibleHalfWidth=0,this.visibleHalfHeight=0,this.visibleHalfWidthWorld=0,this.visibleHalfHeightWorld=0,this.screenScaleFactor=1,this.zoom=n.projection.zoomDefault,this.canvas=null}setCanvas(e){this.canvas=e}resetProjectionState(){this.setGridCenter(n.projection.startCenterX,n.projection.startCenterY),this.zoom=n.projection.zoomDefault,this.canvas=null}setGridCenter(e,t){this.gridCenter.set(e,t)}updateSpaceCenter(e,t){this.gridCenter.addXY(e,t)}updateProjectionForFrame(){this.canvas&&(this.visibleHalfWidth=this.canvas.width/2,this.visibleHalfHeight=this.canvas.height/2,this.visibleHalfWidthWorld=this.visibleHalfWidth/this.zoom,this.visibleHalfHeightWorld=this.visibleHalfHeight/this.zoom,this.screenOrigin.set(this.zoom*this.gridCenter.x-this.visibleHalfWidth,this.zoom*this.gridCenter.y-this.visibleHalfHeight),this.screenOrigin.x=this.screenOrigin.x|0,this.screenOrigin.y=this.screenOrigin.y|0)}screenToWorldDistance(e){return e/this.zoom}screenToWorld(e,t){var i=1/this.zoom;t.set(i*(this.screenOrigin.x+e.x),i*(this.screenOrigin.y+e.y))}worldToScreen(e,t){t.x=this.zoom*e.x-this.screenOrigin.x,t.y=this.zoom*e.y-this.screenOrigin.y}setZoom(e){this.zoom=e,this.zoom<n.projection.zoomOutScaleLimit&&(this.zoom=n.projection.zoomOutScaleLimit),this.zoom>n.projection.zoomInScaleLimit&&(this.zoom=n.projection.zoomInScaleLimit)}zoomOut(){this.zoom-=n.projection.zoomStep,this.zoom<n.projection.zoomOutScaleLimit&&(this.zoom=n.projection.zoomOutScaleLimit)}zoomIn(){this.zoom+=n.projection.zoomStep,this.zoom>n.projection.zoomInScaleLimit&&(this.zoom=n.projection.zoomInScaleLimit)}isNearby(e,t,i){return this.isNearbyX(e.origin.x,e.getPixelWidth(),t,i)&&this.isNearbyY(e.origin.y,e.getPixelHeight(),t,i)}isNearbyXY(e,t,i,r){return this.isNearbyX(e,1,i,r)&&this.isNearbyY(t,1,i,r)}isVisible(e,t){return this.isVisibleX(e.x,t)&&this.isVisibleY(e.y,t)}isVisibleXY(e,t,i){return this.isVisibleX(e,i)&&this.isVisibleY(t,i)}isVisibleGridBox(e){return this.isVisibleX(e.origin.x,e.getPixelWidth())&&this.isVisibleY(e.origin.y,e.getPixelHeight())}isVisibleX(e,t){return e<this.gridCenter.x+this.visibleHalfWidthWorld&&e+t>=this.gridCenter.x-this.visibleHalfWidthWorld}isVisibleY(e,t){return e<this.gridCenter.y+this.visibleHalfHeightWorld&&e+t>=this.gridCenter.y-this.visibleHalfHeightWorld}getMaxVisibleHalfWidth(){return Math.max(this.visibleHalfHeightWorld,this.visibleHalfWidthWorld)}isNearbyX(e,t,i,r){return e<i.x+r&&e+t>=i.x-r}isNearbyY(e,t,i,r){return e<i.y+r&&e+t>=i.y-r}clampToScreen(e,t,i){let r=Math.min(Math.max(e.x,0),this.canvas.width-t),s=Math.min(Math.max(e.y,0),this.canvas.height-i);e.set(r,s)}resetFull(){this.resetProjectionState()}resetForPrestige(){this.resetProjectionState()}};var ye=class{constructor(){}static allVisibleGrids(e,t,i){let r=e.grids;for(let s=0;s<r.length;s++){let o=r[s];o&&o.loaded&&t.isVisibleGridBox(o)&&i(o)}}static allVisibleRegions(e,t,i){let r=e.grids;for(let s=0;s<r.length;s++){let o=r[s];o&&o.loaded&&t.isVisibleGridBox(o)&&this.allVisibleRegionsInGrid(o,t,i)}}static allVisibleTiles(e,t,i){let r=e.grids;for(let s=0;s<r.length;s++){let o=r[s];o&&t.isVisibleGridBox(o)&&this.allVisibleTilesInGrid(o,t,i)}}static allNearbyRegions(e,t,i,r,s){let o=e.grids;for(let a=0;a<o.length;a++){let h=o[a];!h||!h.isLoaded()||(h.contains(i)||t.isNearby(h,i,r))&&this.allNearbyRegionsInGrid(h,t,s,i,r)}}static allVisibleTilesInGrid(e,t,i){if(!e)return;let r=e.zones;for(let s=0;s<r.length;s++){let o=r[s];if(t.isVisibleGridBox(o)){let a=o.getRegions();for(let h=0;h<a.length;h++){let m=a[h];if(t.isVisibleGridBox(m)){let p=m.getTiles();for(let f=0;f<p.length;f++){let N=p[f];t.isVisibleGridBox(N)&&i(N)}}}}}}static allTilesInGrid(e,t){if(!e)return;let i=e.zones;for(let r=0;r<i.length;r++){let s=i[r].getRegions();for(let o=0;o<s.length;o++){let a=s[o].getTiles();for(let h=0;h<a.length;h++)t(a[h])}}}static allTilesInGridZone(e,t){if(!e)return;let i=e.getRegions();for(let r=0;r<i.length;r++){let s=i[r].getTiles();for(let o=0;o<s.length;o++)t(s[o])}}static allVisibleRegionsInGrid(e,t,i){if(!e)return;let r=e.zones;for(let s=0;s<r.length;s++){let o=r[s];if(t.isVisibleGridBox(o)){let a=o.getRegions();for(let h=0;h<a.length;h++){let m=a[h];t.isVisibleGridBox(m)&&i(m)}}}}static allNearbyRegionsInGrid(e,t,i,r,s){if(!e)return;let o=e.zones;for(let a=0;a<o.length;a++){let h=o[a];if(t.isNearby(h,r,s)){let m=h.getRegions();for(let p=0;p<m.length;p++){let f=m[p];t.isNearby(f,r,s)&&i(f)}}}}static allRegionsInGrid(e,t){if(!e)return;let i=e.zones;for(let r=0;r<i.length;r++){let o=i[r].getRegions();for(let a=0;a<o.length;a++)t(o[a])}}};var ni=class extends mt{constructor(){super(),this.color=null,this.radius=0,this.tile=null}set(e,t,i){this.tile=e,this.color=t,this.radius=i}getTile(){return this.tile}setTile(e){this.tile=e}getColor(){return this.color}getTileRadius(){return this.radius}reset(e){super.reset(e),this.color=null,this.radius=0,this.tile=null}};var Ha=0,za=1,Wa=2,Ya=3,rt=class extends pt{constructor(e,t){super(t),this.worldGrid=e,this.gridChangeCount=0,this.zones=this.createZoneArray(),this.neighbors=new Array(4),this.neighbors[Ha]=null,this.neighbors[za]=null,this.neighbors[Wa]=null,this.neighbors[Ya]=null,this.characters=[],this.lightSources=[],this.loaded=!1}createZoneArray(){let e=new Array(n.grid.numZoneColsInGrid*n.grid.numZoneRowsInGrid),t=this.origin,i=t.x,r=t.y,s=0;for(let o=0;o<n.grid.numZoneColsInGrid;o++)for(let a=0;a<n.grid.numZoneRowsInGrid;a++)e[s++]=new Br(this,new b(i+n.grid.zonePixelWidth*o,r+n.grid.zonePixelHeight*a));return e}unloadGrid(){if(this.characters.length>0){let e=this.characters.length;for(let t=e-1;t>=0;t--){let i=this.characters[t];i.isMonster()?i.isFinishedAndAvailable()||i.reset(!0):i.isPartyMember()&&(console.log("Grid.unloadGrid() party character is in grid that is being unloaded."),i.position.resetFull(),i.resetTurnState())}this.characters.length=0}if(this.lightSources!=null){let e=this.lightSources.length;for(let t=e-1;t>=0;t--){let i=this.lightSources[t];i.isFinishedAndAvailable()||i.reset(!0)}this.lightSources.length=0}this.loaded=!1}getLightSources(){return this.lightSources}addLightSource(e){this.lightSources.push(e)}removeLightSource(e){if(this.lightSources==null||this.lightSources.length===0||!e)return;let t=this.lightSources.indexOf(e);t>=0&&this.lightSources.splice(t,1)}removeLightSourceForTile(e){if(!(this.lightSources==null||this.lightSources.length===0||e==null)){for(let t=0;t<this.lightSources.length;t++)if(this.lightSources[t].getTile()===e){this.lightSources.splice[1];break}}}addCharacter(e){e&&this.characters.push(e)}removeCharacter(e){if(e){let t=this.characters.indexOf(e);t!==-1&&this.characters.splice(t,1)}}initializeZonesForGrid(){this.gridChangeCount=0;let e=this.zones,t=this.origin,i=t.x,r=t.y,s=0;for(let o=0;o<n.grid.numZoneColsInGrid;o++)for(let a=0;a<n.grid.numZoneRowsInGrid;a++)e[s++].initialize(i+n.grid.zonePixelWidth*o,r+n.grid.zonePixelHeight*a)}setGridNeighbors(e,t,i,r){this.neighbors[Ha]=e,this.neighbors[za]=t,this.neighbors[Wa]=i,this.neighbors[Ya]=r}markGridAsChanged(){this.gridChangeCount++,this.worldGrid.changeCount++}getWorldGrid(){return this.worldGrid}isLoaded(){return this.loaded}getZones(){return this.zones}getGridCol(){return Z.floor(this.origin.x/n.grid.gridPixelWidth)}getGridRow(){return Z.floor(this.origin.y/n.grid.gridPixelHeight)}static calculateGridCol(e){return Z.floor(e/n.grid.gridTileWidth)}static calculateGridRow(e){return Z.floor(e/n.grid.gridTileHeight)}getPixelWidth(){return n.grid.gridPixelWidth}getPixelHeight(){return n.grid.gridPixelHeight}getGridTile(e,t){return this.getGridTileAbsolute(e,t)}findGridTile(e){if(!this.contains(e))return null;let t=Z.floor(e.x/n.tile.size),i=Z.floor(e.y/n.tile.size);return this.getGridTileAbsolute(t,i)}getGridTileAbsolute(e,t){let i=this.origin,r=Z.floor(i.x/n.tile.size),s=Z.floor(i.y/n.tile.size);return this.getGridTileLocal(e-r,t-s)}getGridTileLocal(e,t){let i=Z.floor(e/n.grid.zoneTileWidth),r=Z.floor(t/n.grid.zoneTileHeight);if(i<0||i>=n.grid.numZoneColsInGrid||r<0||r>=n.grid.numZoneRowsInGrid)return null;let s=i*n.grid.numZoneRowsInGrid+r;if(s>=0&&s<this.zones.length){let o=this.zones[s],a=this.origin,h=a.x/n.tile.size,m=a.y/n.tile.size,p=o.origin,f=p.x/n.tile.size,N=p.y/n.tile.size;return o.getGridTileLocal(e+h-f,t+m-N)}else return console.log("Grid.getGridTileLocal() Failed to find tile. col="+e+" row="+t+" index="+s),null}isTileType(e,t,i){let r=this.getGridTile(e,t);return r!==null&&r.getTileType()===i}isNotTileType(e,t,i){let r=this.getGridTile(e,t);return r===null||r.getTileType()!==i}createCenterVector(){let e=new b;return this.assignCenterVector(e),e}assignCenterVector(e){let t=Z.floor(n.grid.gridPixelWidth/2),i=Z.floor(n.grid.gridPixelHeight/2),r=this.getOrigin();e.x=r.x+t,e.y=r.y+i}findTileNeighborsFull(){for(let e=0;e<this.zones.length;e++)this.zones[e].findTileNeighborsFull()}findWorldGridTileNeighbors(){this.neighbors[Ha]?this.findTileNeighborsGridBorderTop():this.nullifyTileNeighborsGridBorderTop(),this.neighbors[za]?this.findTileNeighborsGridBorderBottom():this.nullifyTileNeighborsGridBorderBottom(),this.neighbors[Ya]?this.findTileNeighborsGridBorderLeft():this.nullifyTileNeighborsGridBorderLeft(),this.neighbors[Wa]?this.findTileNeighborsGridBorderRight():this.nullifyTileNeighborsGridBorderRight()}evaluateWorldGridTileNeighborBorders(){this.neighbors[Ha]&&this.evaluateTileBordersTop(),this.neighbors[za]&&this.evaluateTileBordersBottom(),this.neighbors[Ya]&&this.evaluateTileBordersLeft(),this.neighbors[Wa]&&this.evaluateTileBordersRight()}evaluateAllTileBorders(){ye.allTilesInGrid(this,function(e){e.evaluateBorders()})}nullifyBorderNeighbors(){this.nullifyTileNeighborsGridBorderRight(),this.nullifyTileNeighborsGridBorderLeft(),this.nullifyTileNeighborsGridBorderBottom(),this.nullifyTileNeighborsGridBorderTop()}findTileNeighborsGridBorderRight(){let e=n.grid.numZoneColsInGrid-1;for(let t=0;t<n.grid.numZoneRowsInGrid;t++)this.findZone(e,t).findTileNeighborsZoneBorderRight()}nullifyTileNeighborsGridBorderRight(){let e=n.grid.numZoneColsInGrid-1;for(let t=0;t<n.grid.numZoneRowsInGrid;t++)this.findZone(e,t).nullifyTileNeighborsZoneBorderRight()}evaluateTileBordersRight(){let e=n.grid.numZoneColsInGrid-1;for(let t=0;t<n.grid.numZoneRowsInGrid;t++)this.findZone(e,t).evaluateTileBordersRight()}findTileNeighborsGridBorderLeft(){for(let e=0;e<n.grid.numZoneRowsInGrid;e++)this.findZone(0,e).findTileNeighborsZoneBorderLeft()}nullifyTileNeighborsGridBorderLeft(){for(let e=0;e<n.grid.numZoneRowsInGrid;e++)this.findZone(0,e).nullifyTileNeighborsZoneBorderLeft()}evaluateTileBordersLeft(){for(let e=0;e<n.grid.numZoneRowsInGrid;e++)this.findZone(0,e).evaluateTileBordersLeft()}findTileNeighborsGridBorderBottom(){let e=n.grid.numZoneRowsInGrid-1;for(let t=0;t<n.grid.numZoneColsInGrid;t++)this.findZone(t,e).findTileNeighborsZoneBorderBottom()}nullifyTileNeighborsGridBorderBottom(){let e=n.grid.numZoneRowsInGrid-1;for(let t=0;t<n.grid.numZoneColsInGrid;t++)this.findZone(t,e).nullifyTileNeighborsZoneBorderBottom()}evaluateTileBordersBottom(){let e=n.grid.numZoneRowsInGrid-1;for(let t=0;t<n.grid.numZoneColsInGrid;t++)this.findZone(t,e).evaluateTileBordersBottom()}findTileNeighborsGridBorderTop(){for(let e=0;e<n.grid.numZoneColsInGrid;e++)this.findZone(e,0).findTileNeighborsZoneBorderTop()}nullifyTileNeighborsGridBorderTop(){for(let e=0;e<n.grid.numZoneColsInGrid;e++)this.findZone(e,0).nullifyTileNeighborsZoneBorderTop()}evaluateTileBordersTop(){for(let e=0;e<n.grid.numZoneColsInGrid;e++)this.findZone(e,0).evaluateTileBordersTop()}findZone(e,t){return this.zones[e*n.grid.numZoneRowsInGrid+t]}};var Fr=class{constructor(){this.targetTile=null,this.mineTile=null,this.invalidated=!1,this.behaviorId=null}setTargetTile(e,t,i){this.resetTarget(),this.targetTile=e,this.mineTile=t,this.invalidated=!1,this.behaviorId=i}onGridUnload(e){if(this.targetTile&&this.targetTile.grid===e){this.resetTarget();return}this.mineTile&&this.mineTile.grid===e&&this.resetTarget()}resetTarget(){this.targetTile=null,this.mineTile=null,this.invalidated=!1,this.behaviorId=null}};var be=class{constructor(e,t,i){this.startTile=e,this.endTile=t,this.pathSteps=i}isSolidFloorRequiredAtStart(){return!0}executePlan(e,t,i){}walkLeftToCenterX(e,t,i){let r=e.position.worldCoordinateCenter.x,s=Math.abs(r-i);if(s===0)return!0;e.setCharacterAction(Q.WALK),e.position.facingLeft=!0;let o=this.getWalkDistanceThisFrame(t);return s<o?(e.position.moveX(-s),!0):(e.position.moveX(-o),!1)}walkRightToCenterX(e,t,i){let r=e.position.worldCoordinateCenter.x,s=Math.abs(i-r);if(s===0)return!0;e.setCharacterAction(Q.WALK),e.position.facingLeft=!1;let o=this.getWalkDistanceThisFrame(t);return s<o?(e.position.moveX(s),!0):(e.position.moveX(o),!1)}jumpUp(e,t,i){e.setCharacterAction(Q.JUMP);let r=this.getJumpDistanceThisFrame(t);return e.position.worldCoordinateOrigin.y-i.origin.y<r?(e.position.setY(i.origin.y),!0):(e.position.moveY(-r),!1)}jumpUpAndLeft(e,t,i,r){let s=i.x,o=r.x,a=(s-o)/2,h=o+a,m=i.y-r.y+n.tile.halfSize,p=i.y-m,f=this.getWalkDistanceThisFrame(t);if(e.position.facingLeft=!0,e.position.worldCoordinateCenter.x>h){e.setCharacterAction(Q.JUMP);let w=this.getJumpDistanceThisFrame(t),E=e.position.worldCoordinateCenter.x-h,P=e.position.worldCoordinateOrigin.y-p;if(E>P){let S=this.calcRatio(P,E),A=Math.min(S*w,P),_=Math.min(f,E);e.position.moveXY(-_,-A)}else{let S=this.calcRatio(E,P),A=Math.min(S*f,E),_=Math.min(w,P);e.position.moveXY(-A,-_)}return}e.setCharacterAction(Q.FALL);let N=this.getFallDistanceThisFrame(t),T=e.position.worldCoordinateCenter.x-o,C=this.endTile.origin.y-e.position.worldCoordinateOrigin.y;if(!(T===0&&C===0))if(T>C){let w=this.calcRatio(C,T),E=Math.min(w*N,C),P=Math.min(f,T);e.position.moveXY(-P,E)}else{let w=this.calcRatio(T,C),E=Math.min(w*f,T),P=Math.min(N,C);e.position.moveXY(-E,P)}}jumpUpAndRight(e,t,i,r){let s=i.x,o=r.x,a=(o-s)/2,h=s+a,m=i.y-r.y+n.tile.halfSize,p=i.y-m,f=this.getWalkDistanceThisFrame(t);if(e.position.facingLeft=!1,e.position.worldCoordinateCenter.x<h){e.setCharacterAction(Q.JUMP);let w=this.getJumpDistanceThisFrame(t),E=h-e.position.worldCoordinateCenter.x,P=e.position.worldCoordinateOrigin.y-p;if(E>P){let S=this.calcRatio(P,E),A=Math.min(S*w,P),_=Math.min(f,E);e.position.moveXY(_,-A)}else{let S=this.calcRatio(E,P),A=Math.min(S*f,E),_=Math.min(w,P);e.position.moveXY(A,-_)}return}e.setCharacterAction(Q.FALL);let N=this.getFallDistanceThisFrame(t),T=o-e.position.worldCoordinateCenter.x,C=r.y-e.position.worldCoordinateOrigin.y;if(!(T===0&&C===0))if(T>C){let w=this.calcRatio(C,T),E=Math.min(w*N,C),P=Math.min(f,T);e.position.moveXY(P,E)}else{let w=this.calcRatio(T,C),E=Math.min(w*f,T),P=Math.min(N,C);e.position.moveXY(E,P)}}jumpDownAndLeft(e,t,i,r){let s=i.x,o=r.x,a=(s-o)/2,h=o+a,m=n.tile.halfSize,p=i.y-m,f=this.getWalkDistanceThisFrame(t);if(e.position.facingLeft=!0,e.position.worldCoordinateCenter.x>h){e.setCharacterAction(Q.JUMP);let w=this.getJumpDistanceThisFrame(t),E=e.position.worldCoordinateCenter.x-h,P=e.position.worldCoordinateOrigin.y-p;if(E>P){let S=this.calcRatio(P,E),A=Math.min(S*w,P),_=Math.min(f,E);e.position.moveXY(-_,-A)}else{let S=this.calcRatio(E,P),A=Math.min(S*f,E),_=Math.min(w,P);e.position.moveXY(-A,-_)}return}e.setCharacterAction(Q.FALL);let N=this.getFallDistanceThisFrame(t),T=e.position.worldCoordinateCenter.x-o,C=this.endTile.origin.y-e.position.worldCoordinateOrigin.y;if(!(T===0&&C===0))if(T>C){let w=this.calcRatio(C,T),E=Math.min(w*N,C),P=Math.min(f,T);e.position.moveXY(-P,E)}else{let w=this.calcRatio(T,C),E=Math.min(w*f,T),P=Math.min(N,C);e.position.moveXY(-E,P)}}jumpDownAndRight(e,t,i,r){let s=i.x,o=r.x,a=(o-s)/2,h=s+a,m=n.tile.halfSize,p=i.y-m,f=this.getWalkDistanceThisFrame(t);if(e.position.facingLeft=!1,e.position.worldCoordinateCenter.x<h){e.setCharacterAction(Q.JUMP);let w=this.getJumpDistanceThisFrame(t),E=h-e.position.worldCoordinateCenter.x,P=e.position.worldCoordinateOrigin.y-p;if(E>P){let S=this.calcRatio(P,E),A=Math.min(S*w,P),_=Math.min(f,E);e.position.moveXY(_,-A)}else{let S=this.calcRatio(E,P),A=Math.min(S*f,E),_=Math.min(w,P);e.position.moveXY(A,-_)}return}e.setCharacterAction(Q.FALL);let N=this.getFallDistanceThisFrame(t),T=o-e.position.worldCoordinateCenter.x,C=r.y-e.position.worldCoordinateOrigin.y;if(!(T===0&&C===0))if(T>C){let w=this.calcRatio(C,T),E=Math.min(w*N,C),P=Math.min(f,T);e.position.moveXY(P,E)}else{let w=this.calcRatio(T,C),E=Math.min(w*f,T),P=Math.min(N,C);e.position.moveXY(E,P)}}jumpLeft(e,t,i,r,s){let o=i.x,a=r.x,h=(o-a)/2,m=a+h,p=i.y-s,f=this.getWalkDistanceThisFrame(t);if(e.position.facingLeft=!0,e.position.worldCoordinateCenter.x>m){e.setCharacterAction(Q.JUMP);let w=this.getJumpDistanceThisFrame(t),E=e.position.worldCoordinateCenter.x-m,P=e.position.worldCoordinateOrigin.y-p;if(E>P){let S=this.calcRatio(P,E),A=Math.min(S*w,P),_=Math.min(f,E);e.position.moveXY(-_,-A)}else{let S=this.calcRatio(E,P),A=Math.min(S*f,E),_=Math.min(w,P);e.position.moveXY(-A,-_)}return}e.setCharacterAction(Q.FALL);let N=this.getFallDistanceThisFrame(t),T=e.position.worldCoordinateCenter.x-a,C=this.endTile.origin.y-e.position.worldCoordinateOrigin.y;if(!(T===0&&C===0))if(T>C){let w=this.calcRatio(C,T),E=Math.min(w*N,C),P=Math.min(f,T);e.position.moveXY(-P,E)}else{let w=this.calcRatio(T,C),E=Math.min(w*f,T),P=Math.min(N,C);e.position.moveXY(-E,P)}}jumpRight(e,t,i,r,s){let o=i.x,a=r.x,h=(a-o)/2,m=o+h,p=i.y-s,f=this.getWalkDistanceThisFrame(t);if(e.position.facingLeft=!1,e.position.worldCoordinateCenter.x<m){e.setCharacterAction(Q.JUMP);let w=this.getJumpDistanceThisFrame(t),E=m-e.position.worldCoordinateCenter.x,P=e.position.worldCoordinateOrigin.y-p;if(E>P){let S=this.calcRatio(P,E),A=Math.min(S*w,P),_=Math.min(f,E);e.position.moveXY(_,-A)}else{let S=this.calcRatio(E,P),A=Math.min(S*f,E),_=Math.min(w,P);e.position.moveXY(A,-_)}return}e.setCharacterAction(Q.FALL);let N=this.getFallDistanceThisFrame(t),T=a-e.position.worldCoordinateCenter.x,C=r.y-e.position.worldCoordinateOrigin.y;if(!(T===0&&C===0))if(T>C){let w=this.calcRatio(C,T),E=Math.min(w*N,C),P=Math.min(f,T);e.position.moveXY(P,E)}else{let w=this.calcRatio(T,C),E=Math.min(w*f,T),P=Math.min(N,C);e.position.moveXY(E,P)}}fallDownAndLeft(e,t,i){e.position.facingLeft=!0,e.setCharacterAction(Q.FALL);let r=this.getFallDistanceThisFrame(t),s=this.getWalkDistanceThisFrame(t),o=e.position.worldCoordinateCenter.x-i.x,a=i.y-e.position.worldCoordinateOrigin.y,h=Math.min(s,o),m=Math.min(r,a);e.position.moveXY(-h,m)}fallDownAndRight(e,t,i){e.position.facingLeft=!1,e.setCharacterAction(Q.FALL);let r=this.getFallDistanceThisFrame(t),s=this.getWalkDistanceThisFrame(t),o=i.x-e.position.worldCoordinateCenter.x,a=i.y-e.position.worldCoordinateOrigin.y,h=Math.min(s,o),m=Math.min(r,a);e.position.moveXY(h,m)}fallDown(e,t,i){e.setCharacterAction(Q.FALL);let r=this.getFallDistanceThisFrame(t),s=i.origin.y-e.position.worldCoordinateOrigin.y;return r<s?(e.position.moveY(r),!1):(e.position.setY(i.origin.y),!0)}getWalkDistanceThisFrame(e){return n.physics.walkRatePerFrame*e}getFallDistanceThisFrame(e){return n.physics.gravityRatePerFrame*e}getJumpDistanceThisFrame(e){return n.physics.jumpRatePerFrame*e}getDistanceAboveFloor(e){let t=e.tile.origin.y,i=e.worldCoordinateOrigin.y;return t-i}assertEndTileReached(e,t){if(e.position.tile!==t){let i=t.origin;e.position.setTileAndOriginPosition(t,i.x,i.y)}else e.position.setPositionToTileOrigin()}calcRatio(e,t){return e===t?1:e===0?0:t===0?(console.log("calcRatio() 0 denominator"),1e3):e/t}toString(){return"Base PathPlan toString() sub-class did not override."}};var Gr=class{constructor(e){this.character=e,this.worldCoordinateOrigin=new b(0,0),this.worldCoordinateCenter=new b(0,0),this.tile=null,this.grid=null,this.facingLeft=!0,this.gravityThisFrame=0,this.pathPlan=[]}setGrid(e){this.grid!=e&&(this.grid&&this.grid.removeCharacter(this.character),e?.addCharacter(this.character),this.grid=e)}castVerticalPositionToInteger(){this.worldCoordinateOrigin.y=Z.floor(this.worldCoordinateOrigin.y),this.worldCoordinateCenter.y=this.worldCoordinateOrigin.y+n.tile.halfSize}setTileAndOriginPosition(e,t,i){this.worldCoordinateOrigin.set(t,i),this.tile=e,this.onWorldCoordinateChange()}isNearTileOrigin(){if(!this.tile)return!1;let e=this.worldCoordinateOrigin.x-this.tile.origin.x,t=this.worldCoordinateOrigin.y-this.tile.origin.y;return Math.abs(e)<=5&&Math.abs(t)<=5}setPositionToTileOrigin(){this.tile&&this.setTileAndOriginPosition(this.tile,this.tile.origin.x,this.tile.origin.y)}findClosestNeighbor(){let e=this.tile.neighbors,t=null,i=1e6;for(let r=0;r<e.length;r++){let s=e[r];if(!s||!s.open)continue;let o=this.tile.origin.distanceSquared(s.origin);(!t||o<i)&&(t=s,i=o)}return t}isCenteredOnTile(){return this.tile&&this.tile.origin.equals(this.worldCoordinateOrigin)}setWorldCoordinateOrigin(e){this.worldCoordinateOrigin.copy(e),this.onWorldCoordinateChange()}setWorldCoordinateOriginXY(e,t){this.worldCoordinateOrigin.set(e,t),this.onWorldCoordinateChange()}moveX(e){this.worldCoordinateOrigin.addXY(e,0),this.onWorldCoordinateChange()}moveY(e){this.worldCoordinateOrigin.addXY(0,e),this.onWorldCoordinateChange()}setX(e){this.worldCoordinateOrigin.x=e,this.onWorldCoordinateChange()}setY(e){this.worldCoordinateOrigin.y=e,this.onWorldCoordinateChange()}moveXY(e,t){this.worldCoordinateOrigin.addXY(e,t),this.onWorldCoordinateChange()}onWorldCoordinateChange(){if(this.worldCoordinateCenter.copy(this.worldCoordinateOrigin),this.worldCoordinateCenter.addXY(n.tile.halfSize,n.tile.halfSize),!this.tile){console.log("Position.onWorldCoordinateChange() tile is null");return}if(!this.tile.contains(this.worldCoordinateOrigin)){let e=this.tile;this.tile=this.tile.findNeighborContaining(this.worldCoordinateOrigin),this.tile||(this.grid&&(this.tile=this.grid.findGridTile(this.worldCoordinateOrigin)),this.tile||(this.tile=e.getWorldGrid().findGridTile(this.worldCoordinateOrigin)))}this.tile?this.setGrid(this.tile.grid):(console.log("Position.onWorldCoordinateChange() character lost their tile after move."),this.character.onInvalidGrid())}resetPathPlan(){this.pathPlan.length>0&&(this.pathPlan.length=0,this.setPositionToTileOrigin())}resetFull(){this.resetPathPlan(),this.setGrid(null),this.tile=null,this.gravityThisFrame=0}};var ai=class{constructor(){}performAction(e,t,i){}isMovementAction(){return!1}toString(){return"BaseTurnAction"}};var li=class extends mt{constructor(){super(),this.position=new Gr(this),this.target=new Fr,this.turnAction=null,this.pathCompletedTime=0}isMonster(){return!0}isPartyMember(){return!1}isMinion(){return!1}isDead(){return!1}getMinerIndex(){return-1}getMonsterDescriptionId(){return null}getCharacterLevel(){return 1}setCharacterAction(e){}getCharacterSprite(){return null}getItemOverlaySprite(){return null}isThrusterActive(){return!1}followPathPlan(e,t){if(this.position.pathPlan.length===0)return;this.position.pathPlan[0].executePlan(this,e,t)&&this.position.pathPlan.shift()}chooseTurn(){}performFrameActions(e,t){this.turnAction&&this.turnAction.performAction(this,e,t)}resetTurnState(){this.turnAction=null,this.target.resetTarget(),this.position.resetPathPlan()}onInvalidGrid(){this.resetGameModel()}resetGameModel(){this.position.resetFull(),this.resetTurnState()}};var Vr=class{constructor(e){this.behaviorId=e}applyIfAppropriate(e){return!1}isAutoPlayBehavior(){return!1}getName(){return"CharacterBehavior****"}};var Ur=class{constructor(e,t){this.id=e,this.behaviors=t}chooseTurn(e){if(!e.position.isCenteredOnTile()){if(e.turnAction&&e.turnAction.isMovementAction()&&e.position.pathPlan.length>0)return;e.position.gravityThisFrame===0&&(console.log("CharacterBrain.chooseTurn() not centered on tile and have no path plan. partyMember="+e.isPartyMember()+" monster="+e.isMonster()),e.resetTurnState())}e.turnAction=null;let t=e.position.tile;if(!t){e.resetTurnState();return}if(!t.grid.isLoaded()){console.log("CharacterBarin.chooseTurn() character in grid that is not loaded."),e.resetTurnState();return}e.position.gravityThisFrame>0||(this.applyBehaviors(e,this.behaviors),e.turnAction||(e.position.resetPathPlan(),e.setCharacterAction(Q.STAND)))}applyBehaviors(e,t){let i=!1;for(let r=0;r<t.length;r++)if(t[r].applyIfAppropriate(e)){i=!0;break}i||e.target.resetTarget()}};var Hr=class extends li{constructor(){super(),this.sprite=null,this.monsterDescription=null,this.brain=null,this.damage=1}set(e,t,i){this.brain=e,this.sprite=t,this.monsterDescription=i}isMonster(){return!0}getMonsterDescriptionId(){return this.monsterDescription.id}getCharacterSprite(){return this.sprite}getDamage(){return this.damage}chooseTurn(){this.brain.chooseTurn(this)}reset(e){super.reset(e),this.finishedAndAvailable&&(this.position.resetFull(),this.resetTurnState(),this.brain=null)}};var Tt=class{constructor(){this.cache=[],this.index=0,this.totalSize=0,this.count=0,this.currentActiveCount=0,this.maxActiveCount=0}get(){this.cache.length==0&&this.growCache(this.getInitialSize()),this.index>=this.cache.length&&(this.index=0),this.index=this.findNextAvailableIndex(this.index);let e=this.cache[this.index];return this.index++,e.reset(!1),e}findNextAvailableIndex(e){let t=this.cache.length;this.maxActiveCount>=t&&(e=t,this.growCache(this.getGrowAmount()),t=this.cache.length);let i=0;do{if(e>=t&&(i++,i==1?e=0:(this.growCache(this.getGrowAmount()),t=this.cache.length)),this.cache[e].isFinishedAndAvailable())return e;e++}while(i<2)}getUnderlyingCache(){return this.cache}growCache(e){for(let t=0;t<e;t++){let i=this.createInstance();i.setCycleCacheListener(this),this.cache.push(i)}console.log("CyclingCache.growCache() amount="+e+" newSize="+this.cache.length+" Type: "+this.constructor.name)}shrinkToSize(e){let t=this.cache.length-e;t>0&&this.cache.splice(e,t)}resetCache(){let e=this.cache.length;if(e==0)return;this.count++,this.totalSize+=this.maxActiveCount;let t=this.totalSize/this.count;for(let i=0;i<e;i++){let r=this.cache[i];r.isFinishedAndAvailable()||r.reset(!0)}if(this.count>5){let i=this.getGrowAmount(),r=this.getInitialSize()+2*i;if(e>t*1.75&&e>r){let s=t*1.2|0,o=this.getInitialSize();for(;o<s;)o+=i;o<e&&this.shrinkToSize(o),this.totalSize=0,this.count=0}}this.maxActiveCount=0,this.currentActiveCount=0,this.index=0}getGrowAmount(){}getInitialSize(){}createInstance(){}onAvailabilityChanged(e){e?this.currentActiveCount--:(this.currentActiveCount++,this.maxActiveCount=Math.max(this.maxActiveCount,this.currentActiveCount))}};var zr=class extends Tt{constructor(){super(),this.initialCacheSize=50,this.growAmount=15}getGrowAmount(){return this.growAmount}getInitialSize(){return this.initialCacheSize}createInstance(){return new Hr}};var Pe={BASIC:"B"};var Ie=class{constructor(){}static randomInt(e){return Math.random()*e|0}};var xt=class{constructor(){}static findAvailableTileNearMainMiner(e,t){return this.findAvailableNearbyTile(e,t,t.main.position.tile)}static findAvailableNearbyTile(e,t,i){if(!i)return null;let r=this.findAvailableNeighborTile(e,t,i);if(r)return r;let s=this.findAvailableRegionTile(e,t,i.region);if(s)return s;let o=this.findAvailableZoneTile(e,t,i.region.zone);if(o)return o;let a=this.forceFindTileInZone(e,t,i.region.zone);return a||(console.log("NearbyTileUtil.findAvailableTileNearMainMiner() Complete failure."),null)}static findAvailableNeighborTile(e,t,i){let r=i.neighbors;for(let s=0;s<5;s++){let o=r[Ie.randomInt(r.length)];if(o&&this.isTileClear(e,t,o))return o}return null}static findAvailableZoneTile(e,t,i){let r=i.regions;for(let s=0;s<5;s++){let o=r[Ie.randomInt(r.length)],a=this.findAvailableRegionTile(e,t,o);if(a)return a}return null}static forceFindTileInZone(e,t,i){let r=t.main.position.tile.region,s=this.forceFindTileInRegion(e,t,r);if(s)return s;let o=i.regions;for(let a=0;a<o.length;a++){let h=this.forceFindTileInRegion(e,t,o[a]);if(h)return h}return null}static findAvailableRegionTile(e,t,i){let r=i.tiles;for(let s=0;s<12;s++){let o=r[Ie.randomInt(r.length)];if(o&&this.isTileClear(e,t,o))return o}return null}static forceFindTileInRegion(e,t,i){let r=i.tiles;for(let s=0;s<r.length;s++){let o=r[Ie.randomInt(r.length)];if(o&&!o.open&&this.isClosedTileAvailable(e,t,o))return o.onTileBreak(),o}return null}static isClosedTileAvailable(e,t,i){for(let r=0;r<t.miners.length;r++){let s=t.miners[r];if(s!==e&&i===s.target.targetTile)return!1}return!0}static isTileClear(e,t,i){if(!i||!i.isTraversable())return!1;for(let r=0;r<t.miners.length;r++){let s=t.miners[r];if(s!==e&&(i===s.position.tile||i===s.target.targetTile))return!1}return!0}};var di=class{constructor(e){this.characterSpritesheet=e}getSprite(e,t){let i=this.characterSpritesheet.getSpriteAnimation(e);return i?i.getSpriteAsOf(Date.now(),t):null}};var Oi=class{constructor(e,t,i,r,s,o){this.id=e,this.name=t,this.attackType=i,this.armor=r,this.accessory=s,this.iconSpriteName=o}};var Wr=class{constructor(e,t,i,r){this.itemType=e,this.iconSprite=t,this.staticAnimation=i,this.activeAnimation=r,this.itemActive=!1,this.itemAnimating=!1,this.activeAnimationStartTime=0}setItemActive(e){this.itemActive=e,e?this.itemAnimating||(this.activeAnimationStartTime=Date.now(),this.itemAnimating=!0):this.itemAnimating&&this.activeAnimation.isAnimationLoopCompleted(this.activeAnimationStartTime)&&(this.itemAnimating=!1,this.activeAnimationStartTime=0)}getItemOverlaySprite(){if(this.itemActive)return this.activeAnimation.getSpriteAsOf(Date.now(),this.activeAnimationStartTime);if(this.itemAnimating)if(this.activeAnimation.isAnimationLoopCompleted(this.activeAnimationStartTime))this.itemAnimating=!1;else return this.activeAnimation.getSpriteAsOf(Date.now(),this.activeAnimationStartTime);return this.staticAnimation.getSpriteAsOf(Date.now(),this.activeAnimationStartTime)}isAnimationLoopCompleted(){return this.itemAnimating?this.activeAnimation.isAnimationLoopCompleted(this.activeAnimationStartTime):!0}};var Yr=class extends z{constructor(){super(),this.turnNumber=0,this.frameNumber=0,this.saveTime=0}resetFull(){this.turnNumber=0,this.frameNumber=0,this.saveTime=0}resetForPrestige(){this.turnNumber=0,this.frameNumber=0}};var Kr=class{constructor(e,t){this.animation=e,this.gameTime=t,this.active=!1,this.activeTurn=-1,this.animationStartTime=0}setActive(e){e&&!this.active&&(this.animationStartTime=Date.now()),e&&(this.activeTurn=this.gameTime.turnNumber),this.active=e}deactivateNow(){this.active=!1,this.activeTurn=-1}isActive(){return this.active||this.activeTurn>=this.gameTime.turnNumber-1}getOverlaySprite(){return this.isActive()?this.animation.getSpriteAsOf(Date.now(),this.animationStartTime):null}};var hi=class extends li{constructor(e,t){super(),this.id=""+t,this.characterClass=e,this.minerIndex=t,this.pick=null,this.thruster=null,this.characterAction=Q.STAND,this.characterActionStart=Date.now(),this.skillId=null}isMonster(){return!1}isPartyMember(){return!0}getMinerIndex(){return this.minerIndex}performFrameActions(e,t){if(!this.turnAction){this.updateThrusterStatus();return}this.turnAction.performAction(this,e,t)}followPathPlan(e,t){if(this.position.pathPlan.length===0)return;this.position.pathPlan[0].executePlan(this,e,t)&&(this.position.pathPlan.shift(),this.position.pathPlan.length>0?this.position.pathPlan[0].isSolidFloorRequiredAtStart()&&this.updateThrusterStatus():(this.updateThrusterStatus(),this.pathCompletedTime=Date.now()))}updateThrusterStatus(){let t=this.position.tile.getNeighborBottom();!t||t.isTraversable()?this.thruster.setActive(!0):this.thruster.deactivateNow()}setCharacterAction(e){this.characterAction!==e&&(this.characterAction=e,this.characterActionStart=Date.now()),this.pick.setItemActive(this.characterAction===Q.MINE),this.characterAction!==Q.JUMP&&this.characterAction!==Q.FALL&&this.updateThrusterStatus()}getCharacterSprite(){return this.characterClass.getSprite(this.characterAction,this.characterActionStart)}getItemOverlaySprite(){return this.pick?this.pick.getItemOverlaySprite():null}getThrusterOverlaySprite(){return this.thruster.getOverlaySprite()}isThrusterActive(){return this.thruster.isActive()}};var Il={pick:new Oi("1","Pick",!1,!1,Le.pick.icon),sword:new Oi("2","Sword",!1,!1,Le.broadSword.icon)};var Xr=class extends z{constructor(e,t,i,r){super(),this.worldGrid=e,this.gameTime=t,this.characterSpritesheet=i,this.itemOverlaySpritesheet=r,this.main=null,this.miners=[],this.centerTile=null,this.workingCenter=new b(0,0)}resetTargets(){for(let e=0;e<this.miners.length;e++)this.miners[e].target.resetTarget()}resetTurnStates(){for(let e=0;e<this.miners.length;e++)this.miners[e].resetTurnState()}findMinerIndex(e){return this.miners.indexOf(e)}calculateCrewCenterCoordinate(e){if(this.miners.length===1){e.copy(this.miners[0].position.worldCoordinateOrigin);return}let t=0,i=0;for(let r=0;r<this.miners.length;r++){let s=this.miners[r].position.worldCoordinateOrigin;t+=s.x,i+=s.y}t=t/this.miners.length,i=i/this.miners.length,e.x=t,e.y=i}calculateCrewCenterTile(){if(this.miners.length===1){let e=this.miners[0].position.tile;return e?(this.centerTile=e,e):(this.centerTile=this.worldGrid.findGridTile(this.miners[0].position.worldCoordinateOrigin),this.centerTile)}else{this.calculateCrewCenterCoordinate(this.workingCenter);let e=this.worldGrid.findGridTile(this.workingCenter);if(e)return this.centerTile=e,e;console.log("Crew.getCrewCenterTile() failed to find tile: "+this.workingCenter.toString());for(let t=0;t<this.miners.length;t++){let i=this.miners[t].position.tile;if(i)return this.centerTile=i,this.centerTile}return null}}createMainMiner(){return this.main=new hi(new di(this.characterSpritesheet),this.miners.length),this.initializeCharacter(this.main),this.miners.push(this.main),this.main}addNewMinerNearMain(e){if(!this.main.position.tile){console.log("Crew.addNewMinerNearMain() ERROR main miner does not have a tile.");return}let t=xt.findAvailableTileNearMainMiner(null,this),i=new hi(new di(this.characterSpritesheet),this.miners.length);i.skillId=e,this.initializeCharacter(i),this.miners.push(i),i.position.setTileAndOriginPosition(t,t.origin.x,t.origin.y)}addNewMinerForSaveLoad(){let e=new hi(new di(this.characterSpritesheet),this.miners.length);return this.initializeCharacter(e),this.miners.push(e),e}initializeCharacter(e){this.itemOverlaySpritesheet.loaded||console.log("Crew.initializeCharacter() itemOverlaySpritesheet not loaded yet");let t=this.itemOverlaySpritesheet.getSpriteAnimation(Le.pick.staticOverlay),i=this.itemOverlaySpritesheet.getSpriteAnimation(Le.pick.activeOverlay),r=this.itemOverlaySpritesheet.getSpriteAnimation(Le.thruster.activeOverlay);e.pick=new Wr(Il.pick,null,t,i),e.thruster=new Kr(r,this.gameTime)}onGridUnload(e){for(let t=0;t<this.miners.length;t++)this.miners[t].target.onGridUnload(e)}resetFull(){this.miners.length=0,this.main=null,this.centerTile=null}resetForPrestige(){for(let e=0;e<this.miners.length;e++){let t=this.miners[e];t.resetGameModel(),t.position.setWorldCoordinateOriginXY(n.start.startX,n.start.startY)}this.centerTile=null}};var jr=class extends z{constructor(){super(),this.basePickDamagePerTurn=new d(n.damage.baseDamagePerTurn),this.totalPickDamagePerTurn=new d(n.damage.baseDamagePerTurn),this.minedDamageMultiplier=new d(1),this.prestigeDamageMultiplier=new d(1),this.goldDamageMultiplier=new d(1),this.depthDamageMultiplier=new d(1),this.rubyDamageMultiplier=new d(1),this.totalPickDamagePerFrame=new d(1),this.totalPickDamagePerFrame.copy(this.totalPickDamagePerTurn),this.totalPickDamagePerFrame.divNumber(n.time.turnFrames),this.working=new d(0)}calculateMaxBrickHealth(e,t){let i=e*n.time.turnsPerSecond;t.copy(this.totalPickDamagePerTurn),t.mulNumber(i)}calculateMineSeconds(e){return this.working.copy(e),this.working.div(this.totalPickDamagePerTurn),this.working.mulNumber(n.time.secondsPerTurn),this.working.toNumber()}resetFull(){this.resetForPrestige(),this.minedDamageMultiplier.setValue(1),this.prestigeDamageMultiplier.setValue(1),this.goldDamageMultiplier.setValue(1),this.depthDamageMultiplier.setValue(1),this.rubyDamageMultiplier.setValue(1)}resetForPrestige(){this.basePickDamagePerTurn.setValue(n.damage.baseDamagePerTurn),this.totalPickDamagePerTurn.setValue(n.damage.baseDamagePerTurn),this.totalPickDamagePerFrame.setValue(1)}};var jt=class extends z{constructor(e,t,i){super(),this.gameTime=e,this.batchTurnSize=t*n.time.turnsPerSecond,this.penaltyFactor=new d(i),this.sum=new d(0),this.startTurn=e.turnNumber,this.valuePerTurn=new d(0),this.rates=[],this.rateIndex=0}add(e,t){this.sum.add(e);let i=this.gameTime.turnNumber-this.startTurn;i>this.batchTurnSize&&(this.sum.divNumber(i),this.addToRollingAverage(this.sum),this.calculateValuePerTurn(),this.startTurn=this.gameTime.turnNumber,this.sum.setZero()),t.copy(this.valuePerTurn)}addToRollingAverage(e){if(this.rates.length<10){let t=new d(0);t.copy(e),this.rates.push(t)}else this.rates[this.rateIndex].copy(e),this.rateIndex++,this.rateIndex>=this.rates.length&&(this.rateIndex=0)}calculateValuePerTurn(){if(this.valuePerTurn.setZero(),this.rates.length>0){for(let e=0;e<this.rates.length;e++)this.valuePerTurn.add(this.rates[e]);this.valuePerTurn.divNumber(this.rates.length),this.valuePerTurn.mul(this.penaltyFactor)}}resetFull(){this.sum.setZero(),this.startTurn=this.gameTime.turnNumber,this.rates.length=0,this.rateIndex=0,this.valuePerTurn.setZero()}resetForPrestige(){this.startTurn=this.gameTime.turnNumber}};var Zr=class extends z{constructor(e){super(),this.oreRatePerTurnCalculator=new jt(e,20,.5),this.goldRatePerTurnCalculator=new jt(e,20,.5),this.prestigeRatePerTurnCalculator=new jt(e,20,.5),this.rubyRatePerTurnCalculator=new jt(e,20,.5),this.ore=new d(0),this.gold=new d(0),this.ruby=new d(0),this.prestige=new d(0),this.prestigePointsSum=new d(0),this.unclaimedPrestige=new d(0),this.working=new d(0),this.prestigePerTurn=new d(0),this.goldPerTurn=new d(0),this.orePerTurn=new d(0),this.rubyPerTurn=new d(0),this.offlinePrestige=new d(0),this.offlineGold=new d(0),this.offlineOre=new d(0),this.offlineRuby=new d(0),this.offlineSeconds=0,this.countedOfflineSeconds=0,this.one=new d(1)}incrementOre(e){this.ore.add(e),this.oreRatePerTurnCalculator.add(e,this.orePerTurn)}decrementOre(e){this.ore.sub(e),this.ore.lessThanZero()&&this.ore.setZero()}incrementGold(e){this.gold.add(e),this.goldRatePerTurnCalculator.add(e,this.goldPerTurn)}decrementGold(e){this.gold.sub(e),this.gold.lessThanZero()&&this.gold.setZero()}incrementRuby(e){this.ruby.add(e),this.rubyRatePerTurnCalculator.add(e,this.rubyPerTurn)}decrementPrestige(e){this.prestige.sub(e),this.prestige.lessThanZero()&&this.prestige.setZero()}onTerrainLayerUnlocked(){this.unclaimedPrestige.add(this.one)}incrementOfflinePrestige(e){this.offlinePrestige.add(e)}incrementOfflineGold(e){this.offlineGold.add(e)}incrementOfflineOre(e){this.offlineOre.add(e)}incrementOfflineRuby(e){this.offlineRuby.add(e)}claimOfflineEarnings(){this.countedOfflineSeconds=0,this.prestige.add(this.offlinePrestige),this.prestigePointsSum.add(this.offlinePrestige),this.offlinePrestige.setZero(),this.gold.add(this.offlineGold),this.offlineGold.setZero(),this.ore.add(this.offlineOre),this.offlineOre.setZero(),this.ruby.add(this.offlineRuby),this.offlineRuby.setZero()}onPrestige(){this.prestigeRatePerTurnCalculator.add(this.unclaimedPrestige,this.prestigePerTurn),this.prestige.add(this.unclaimedPrestige),this.prestigePointsSum.add(this.unclaimedPrestige),this.unclaimedPrestige.setZero()}resetFull(){this.prestige.setZero(),this.prestigePointsSum.setZero(),this.unclaimedPrestige.setZero(),this.gold.setZero(),this.ruby.setZero(),this.orePerTurn.setZero(),this.prestigePerTurn.setZero(),this.goldPerTurn.setZero(),this.rubyPerTurn.setZero(),this.offlinePrestige.setZero(),this.offlineGold.setZero(),this.offlineOre.setZero(),this.offlineRuby.setZero(),this.oreRatePerTurnCalculator.resetFull(),this.goldRatePerTurnCalculator.resetFull(),this.prestigeRatePerTurnCalculator.resetFull(),this.rubyRatePerTurnCalculator.resetFull(),this.resetForPrestige()}resetForPrestige(){this.ore.setZero(),this.oreRatePerTurnCalculator.resetForPrestige(),this.goldRatePerTurnCalculator.resetForPrestige(),this.prestigeRatePerTurnCalculator.resetForPrestige(),this.rubyRatePerTurnCalculator.resetForPrestige()}};var Et={NORTH:0,NORTH_EAST:1,EAST:2,SOUTH_EAST:3,SOUTH:4,SOUTH_WEST:5,WEST:6,NORTH_WEST:7};var qe={FINISHED_AND_AVAILABLE_FOR_CACHE:1,FINISHED_BUT_IN_USE:2,NOT_STARTED:3,STARTED_NOT_FINISHED:4};var Ka={SPRITE_EFFECT:0,LIGHTNING_EFFECT:1,AREA_EFFECT:2};var qr=class extends mt{constructor(){super(),this.effectOwner=null,this.effectStatus=qe.FINISHED_AND_AVAILABLE_FOR_CACHE,this.startTime=0}set(e){this.effectOwner=e,this.effectStatus=qe.NOT_STARTED,this.startTime=Date.now()}getSpriteDirection(){return Et.NORTH}getEffectType(){return Ka.SPRITE_EFFECT}getEffectOwner(){return this.effectOwner}getSprite(){return null}getPosition(){return null}isEffectStarted(){return this.effectStatus===qe.STARTED_NOT_FINISHED}isNotStarted(){return this.effectStatus===qe.NOT_STARTED}isEffectFinished(){return this.effectStatus===qe.FINISHED_AND_AVAILABLE_FOR_CACHE||this.effectStatus===qe.FINISHED_BUT_IN_USE}markEffectAsFinishedButInUse(){this.effectStatus!==qe.FINISHED_AND_AVAILABLE_FOR_CACHE&&(this.effectStatus=qe.FINISHED_BUT_IN_USE)}updateEffectForFrame(e){this.isEffectFinished()||(this.effectStatus===qe.NOT_STARTED&&(this.startTime=Date.now()),this.effectStatus=qe.STARTED_NOT_FINISHED,this.updateEffectForFrameInternal(e))}updateEffectForFrameInternal(e){}getStartTime(){return this.startTime}getEffectStatus(){return this.effectStatus}refreshStartTime(e){this.startTime=e}isFinishedAndAvailable(){return this.effectStatus==qe.FINISHED_AND_AVAILABLE_FOR_CACHE}reset(e){this.effectStatus==qe.FINISHED_AND_AVAILABLE_FOR_CACHE!=e&&(e&&(this.spriteAnimation=null),this.effectStatus=e?qe.FINISHED_AND_AVAILABLE_FOR_CACHE:qe.NOT_STARTED,this.startTime=0,this.listener.onAvailabilityChanged(e))}};var Jr=class{constructor(){}createEffect(e,t){return null}createEffectAtTile(e,t){return null}createEffectAtPosition(e,t){return null}getSpriteAnimation(){return null}};var xe={BLACK_OPACITY:ce.createColor(336338048),RED_OPACITY:ce.createColor(3494267008),DARK_GRAY_OPACITY:ce.createColor(1313492864),DARK_RED_OPACITY:ce.createColor(1143223424),BLACK:ce.createColor(336338175),DARK_RED:ce.createColor(1143223551),DARK_BLUE:ce.createColor(808742399),DARK_GRAY:ce.createColor(1313492991),BROWN:ce.createColor(2236363007),DARK_GREEN:ce.createColor(879043839),RED:ce.createColor(3494267135),LIGHT_GRAY:ce.createColor(1970364927),LIGHT_BLUE:ce.createColor(1501417215),ORANGE:ce.createColor(3531418879),BLUE_GRAY:ce.createColor(2241176063),LIGHT_GREEN:ce.createColor(1839869183),PEACH:ce.createColor(3534395903),CYAN:ce.createColor(1841482495),YELLOW:ce.createColor(3671351039),WHITE:ce.createColor(3740194559)};var Qr=class extends ni{constructor(){super(),this.flickerColor=new ce(1,1,1,1)}getColor(){this.flickerColor.set(this.color);let e=-.05+.1*Math.random();return this.flickerColor.add(e,e,e,0),this.flickerColor}getTileRadius(){return this.radius+(Math.random()<.15?1:0)}};var ui=class extends Tt{constructor(){super()}getGrowAmount(){return 5}getInitialSize(){return 5}createInstance(){return new ni}};var $r=class extends ui{constructor(){super()}createInstance(){return new Qr}};var _e=class{constructor(e,t,i){this.color=e,this.radius=t,this.lightSourceCache=i}createLightSource(e){let t=this.lightSourceCache.get();return t.set(e,this.color,this.radius),t}};var es=class extends z{constructor(){super();let e=n.lighting.lightSourceRadius;this.lightSourceCache=new ui,this.flickeringLightSourceCache=new $r,this.lightGreenFlickering=new _e(xe.LIGHT_GREEN,e,this.flickeringLightSourceCache),this.darkGreenFlickering=new _e(xe.DARK_GREEN,e,this.flickeringLightSourceCache),this.cyanFlickering=new _e(xe.CYAN,e,this.flickeringLightSourceCache),this.orangeFlickering=new _e(xe.ORANGE,e,this.flickeringLightSourceCache),this.yellowFlickering=new _e(xe.YELLOW,e,this.flickeringLightSourceCache),this.peachFlickering=new _e(xe.PEACH,e,this.flickeringLightSourceCache),this.lightBlueFlickering=new _e(xe.LIGHT_BLUE,e,this.flickeringLightSourceCache),this.darkBlueFlickering=new _e(xe.DARK_BLUE,e,this.flickeringLightSourceCache),this.whiteFlickering=new _e(xe.WHITE,e,this.flickeringLightSourceCache),this.redFlickering=new _e(xe.RED,e,this.flickeringLightSourceCache),this.darkRedFlickering=new _e(xe.DARK_RED,e,this.flickeringLightSourceCache),this.lightGrayFlickering=new _e(xe.LIGHT_GRAY,e,this.flickeringLightSourceCache),this.lightGreen=new _e(xe.LIGHT_GREEN,e,this.lightSourceCache),this.darkGreen=new _e(xe.DARK_GREEN,e,this.lightSourceCache),this.cyan=new _e(xe.CYAN,e,this.lightSourceCache),this.orange=new _e(xe.ORANGE,e,this.lightSourceCache),this.yellow=new _e(xe.YELLOW,e,this.lightSourceCache),this.peach=new _e(xe.PEACH,e,this.lightSourceCache),this.lightBlue=new _e(xe.LIGHT_BLUE,e,this.lightSourceCache),this.darkBlue=new _e(xe.DARK_BLUE,e,this.lightSourceCache),this.white=new _e(xe.WHITE,e,this.lightSourceCache),this.red=new _e(xe.RED,e,this.lightSourceCache),this.darkRed=new _e(xe.DARK_RED,e,this.lightSourceCache),this.lightGray=new _e(xe.LIGHT_GRAY,e,this.lightSourceCache)}resetFull(){this.lightSourceCache.resetCache(),this.flickeringLightSourceCache.resetCache()}resetForPrestige(){this.resetFull()}};var ve=class{constructor(e,t){this.volume=e,this.soundPaths=t}getVolume(){return this.volume}getSoundPaths(){return this.soundPaths}getRandomSoundPath(){return!this.soundPaths||this.soundPaths.length==0?null:this.soundPaths.length==1?this.soundPaths[0]:this.soundPaths[Ie.randomInt(this.soundPaths.length)]}};var H={buttonClick:new ve(1,"sound/effects/ui/Snd_click.mp3"),coins:new ve(.5,"sound/effects/coins/handleCoins.mp3","sound/effects/coins/handleCoins2.mp3"),tab:new ve(1,"sound/effects/ui/metalLatch.mp3"),minionDeath:new ve(1,"sound/effects/deathMinion/bite-small.mp3"),travelEffect:new ve(1,"sound/effects/travelEffect/dropLeather.mp3"),deathBell:new ve(1,"sound/effects/deathBell/churchbell.mp3"),deathScream:new ve(1,"sound/effects/deathScream/death_01.mp3","sound/effects/deathScream/death_02.mp3","sound/effects/deathScream/death_04.mp3","sound/effects/deathScream/death_05.mp3","sound/effects/deathScream/death_06.mp3","sound/effects/deathScream/death_07.mp3"),resurrection:new ve(1,"sound/effects/resurrection/JRPG_characterRevived.mp3"),questCompletion:new ve(1,"sound/effects/questCompleted/Jingle_Achievement_00_128.mp3"),collectibleFound:new ve(1,"sound/effects/collectibleFound/teleport_02.mp3"),achievement:new ve(1,"sound/effects/achievement/cursespell.mp3"),partyRankEarned:new ve(1,"sound/effects/partyRank/retro_beep_04.mp3"),spellBlastEffect:new ve(1,"sound/effects/spellBlastArea/sfx_exp_cluster2.mp3","sound/effects/spellBlastArea/sfx_exp_short_hard2.mp3","sound/effects/spellBlastArea/sfx_exp_short_hard3.mp3","sound/effects/spellBlastArea/sfx_exp_short_hard6.mp3","sound/effects/spellBlastArea/sfx_exp_short_hard10.mp3","sound/effects/spellBlastArea/sfx_exp_short_hard12.mp3","sound/effects/spellBlastArea/sfx_exp_short_hard13.mp3","sound/effects/spellBlastArea/missile_explosion.mp3"),damage:new ve(1,"sound/effects/damage/sfx_exp_shortest_hard6.mp3","sound/effects/damage/sfx_exp_shortest_soft1.mp3","sound/effects/damage/sfx_exp_shortest_soft2.mp3","sound/effects/damage/sfx_exp_shortest_soft6.mp3","sound/effects/damage/sfx_exp_shortest_soft7.mp3","sound/effects/damage/sfx_exp_shortest_soft8.mp3","sound/effects/damage/sfx_exp_shortest_soft9.mp3"),doorOpenEffect:new ve(1,"sound/effects/doorOpen/sfx_movement_dooropen1.mp3","sound/effects/doorOpen/doorOpen_1.mp3","sound/effects/doorOpen/doorOpen_2.mp3"),barrelOpen:new ve(1,"sound/effects/open/boots-leather-step-01.mp3"),itemDrop:new ve(1,"sound/effects/itemDrop/water-drop-02.mp3"),potBroken:new ve(1,"sound/effects/breakPot/wood-bowl-spoon-04.mp3"),sackLooted:new ve(1,"sound/effects/sackLooted/knife-sheathe-01.mp3"),chestOpen:new ve(1,"sound/effects/chestOpen/match-light-01.mp3","sound/effects/chestOpen/quiver-leather-squeeze-01.mp3"),fixtureBreak:new ve(1,"sound/effects/fixtureBreak/item_wood_02.mp3","sound/effects/fixtureBreak/misc_03.mp3","sound/effects/fixtureBreak/wood_01.mp3","sound/effects/fixtureBreak/wood_04.mp3"),rareWeaponFound:new ve(1,"sound/effects/foundRare/levelup.mp3")};var O={DAMAGE_EFFECT_NAME_RED_SPLAT:"Red Splat",DAMAGE_EFFECT_NAME_RED_DAMAGE:"Red Damage",DAMAGE_EFFECT_NAME_WHITE_DAMAGE:"White Damage",DAMAGE_EFFECT_NAME_BLUE_DAMAGE:"Blue Damage",DAMAGE_EFFECT_NAME_GREEN_DAMAGE:"Green Damage",DAMAGE_EFFECT_NAME_SHOCK_DAMAGE:"Electric Damage",DAMAGE_EFFECT_NAME_FIRE_DAMAGE:"Fire Damage",DAMAGE_EFFECT_NAME_POISON_DAMAGE:"Poison Damage",DAMAGE_EFFECT_NAME_SONIC_DAMAGE:"Sonic Damage",DAMAGE_EFFECT_NAME_PINK_DAMAGE:"Pink Damage",MISSILE_EFFECT_NAME_ARROW:"Red Arrow",MISSILE_EFFECT_NAME_FAT_ARROW:"Fat Red Arrow",MISSILE_EFFECT_NAME_GREEN_ARROW:"Green Arrow",MISSILE_EFFECT_NAME_PINK_ARROW:"Pink Arrow",MISSILE_EFFECT_NAME_ARROW_WALL:"Wall Arrow",MISSILE_EFFECT_NAME_SPEAR:"Spear",MISSILE_EFFECT_NAME_PINK_LIGHTNING:"Pink Lightning",MISSILE_EFFECT_NAME_GREEN_PROJECTILE:"Green Projectile",MISSILE_EFFECT_NAME_SMALL_GREEN_PROJECTILE:"Small Green Projectiles",MISSILE_EFFECT_NAME_FIRE_PROJECTILE:"Fire Projectile",MISSILE_EFFECT_NAME_FIRE_ARROW:"Fire Arrow",MISSILE_EFFECT_NAME_ICE_PROJECTILE:"Ice Projectile",MISSILE_EFFECT_NAME_ICE_ARROW:"Ice Arrow",MISSILE_EFFECT_NAME_LIGHTNING:"Lightning",MISSILE_EFFECT_NAME_LIGHTNING_ARROW:"Lightning Arrow",MISSILE_EFFECT_NAME_GREY_BULLET:"Grey Bullet",MISSILE_EFFECT_NAME_YELLOW_BULLET:"Yellow Bullet",MISSILE_EFFECT_NAME_NINJA_STAR:"Ninja Star",MISSILE_EFFECT_NAME_WEB:"Web",MISSILE_EFFECT_NAME_PINK_STAR_PROJECTILE:"Pink Star Projectile",MISSILE_EFFECT_NAME_PINK_BALL_PROJECTILE:"Pink Ball Projectile",MISSILE_EFFECT_NAME_YELLOW_STAR_PROJECTILE:"Yellow Star Projectile",EFFECT_NAME_SPARKLE_GOLD:"Gold Sparkles",EFFECT_NAME_SPARKLE_GREEN:"Green Sparkles",EFFECT_NAME_SPARKLE_BLUE:"Blue Sparkles",EFFECT_NAME_SPARKLE_ORANGE:"Orange Sparkles",EFFECT_NAME_SPARKLE_PINK:"Pink Sparkles",EFFECT_NAME_SPARKLE_RED:"Red Sparkles",EFFECT_NAME_GREEN_SKULL:"Green Skull",EFFECT_NAME_YELLOW_KEY:"Yellow Key",EFFECT_NAME_SKULL_CROSS:"Skull Cross",EFFECT_NAME_SHIELDS:"Shields",EFFECT_NAME_RED_CROSSES:"Red Crosses",EFFECT_NAME_FIRE_RING:"Fire Ring",EFFECT_NAME_ICE_RING:"Ice Ring",EFFECT_NAME_GREEN_RING:"Green Ring",EFFECT_NAME_PINK_RING:"Pink Ring",EFFECT_NAME_YELLOW_STAR:"Yellow Star",EFFECT_NAME_BLUE_STAR:"Blue Star",EFFECT_NAME_GREEN_STAR:"Green Star",EFFECT_NAME_WEB:"Spider Web",EFFECT_NAME_WHITE_CROSSES:"White Crosses",EFFECT_NAME_TORCH:"Torch",EFFECT_NAME_FROST:"Frost",EFFECT_NAME_YELLOW_STAR_CIRCLE:"Yellow Star Circle",EFFECT_NAME_CIRCLES:"Circles",EFFECT_NAME_GOLD_SHIELD_SPIRAL:"Gold Shield Spiral",EFFECT_NAME_GREEN_SHIELD_SPIRAL:"Green Shield Spiral",EFFECT_NAME_BLUE_SHIELD_SPIRAL:"Blue Shield Spiral",EFFECT_NAME_PINK_SHIELD_SPIRAL:"Pink Shield Spiral",EFFECT_NAME_BLUE_FIREWORK:"Blue Firework",EFFECT_NAME_RED_FIREWORK:"Red Firework",EFFECT_NAME_BUBBLES:"Bubbles",EFFECT_NAME_SHIELD:"Shield",EFFECT_NAME_COLOR_SPIRAL:"Color Spiral",EFFECT_NAME_ARM_FLEX:"Arm Flex",EFFECT_NAME_SUPER_SPEED:"Super Speed",EFFECT_NAME_TARGET:"Target",EFFECT_NAME_YELLOW_SHIELD_SPIRAL:"Yellow Shield Spiral",EFFECT_NAME_PINK_STAR_CIRCLE:"Pink Star Circle",EFFECT_NAME_BLUE_STAR_CIRCLE:"Blue Star Circle",EFFECT_NAME_GREEN_STAR_CIRCLE:"Green Star Circle",EFFECT_NAME_GOLD_STAR_CIRCLE:"Gold Star Circle",EFFECT_NAME_BREAD:"Bread",EFFECT_NAME_YELLOW_FIRE_RING:"Yellow Fire Ring",EFFECT_NAME_TOTEMS:"Totems",EFFECT_NAME_EYE_BLINK:"Eye Blink",EFFECT_NAME_PINK_STAR:"Pink Star",EFFECT_NAME_ORANGE_STAR:"Orange Star",EFFECT_NAME_RED_EYE_BLINK:"Red Eye Blink",EFFECT_NAME_EAGLE:"Eagle",EFFECT_NAME_SLEEP:"Sleep",EFFECT_NAME_ARMOR:"Armor",EFFECT_NAME_BLIND_EYE_BLINK:"Blind Eye Blink",EFFECT_NAME_FIRE_RAIN:"Fire Rain",EFFECT_NAME_BLUE_RAIN:"Blue Rain",EFFECT_NAME_GREEN_RAIN:"Green Rain",EFFECT_NAME_LIGHTNING_RAIN:"Lightning Rain",EFFECT_NAME_PINK_RAIN:"Pink Rain",EFFECT_NAME_RAINBOW_RAIN:"Rainbow Rain"};var ts=class extends qr{constructor(){super(),this.spriteAnimation=null}set(e,t){super.set(e),this.spriteAnimation=t}getEffectType(){return Ka.SPRITE_EFFECT}getSprite(){return this.spriteAnimation.getSpriteAsOf(Date.now(),this.startTime)}};var is=class extends ts{constructor(){super(),this.effectPosition=new b(0,0)}set(e,t,i){super.set(e,t),this.effectPosition.copy(i)}updateEffectForFrameInternal(e){this.spriteAnimation.isAnimationLoopCompleted(this.getStartTime())&&!this.isFinishedAndAvailable()&&this.markEffectAsFinishedButInUse()}getPosition(){return this.effectPosition}};var rs=class extends Tt{constructor(){super(),this.initialCacheSize=20,this.growAmount=10}getGrowAmount(){return this.growAmount}getInitialSize(){return this.initialCacheSize}};var ss=class extends rs{constructor(){super()}createInstance(){return new is}};var V=class extends Jr{constructor(e,t,i,r,s){super(),this.spellFxSpritesheet=e,this.spriteName=t,this.spriteAnimation=null,this.soundEffect=i,this.lightSourceCreator=r,this.basicSpriteEffectCache=s}createEffect(e,t){!this.spriteAnimation&&this.spellFxSpritesheet&&(this.spriteAnimation=this.spellFxSpritesheet.getSpriteAnimation(this.spriteName));let i=this.basicSpriteEffectCache.get();return i.set(e,this.spriteAnimation,t),i}createEffectAtTile(e,t){!this.spriteAnimation&&this.spellFxSpritesheet&&(this.spriteAnimation=this.spellFxSpritesheet.getSpriteAnimation(this.spriteName));let i=this.basicSpriteEffectCache.get();return i.set(e,this.spriteAnimation,t.origin),i}createEffectAtPosition(e,t){!this.spriteAnimation&&this.spellFxSpritesheet&&(this.spriteAnimation=this.spellFxSpritesheet.getSpriteAnimation(this.spriteName));let i=this.basicSpriteEffectCache.get();return i.set(e,this.spriteAnimation,t),i}getSpriteAnimation(){return this.spriteAnimation}};var os=class extends z{constructor(e,t){super(),this.basicSpriteEffectCache=new ss,this.effectGreenSkull=new V(t,O.EFFECT_NAME_GREEN_SKULL,H.damage,e.darkGreenFlickering,this.basicSpriteEffectCache),this.damageEffectBloodSplatter=new V(t,O.DAMAGE_EFFECT_NAME_RED_SPLAT,H.damage,null,this.basicSpriteEffectCache),this.damageEffectRedDamage=new V(t,O.DAMAGE_EFFECT_NAME_RED_DAMAGE,H.damage,e.red,this.basicSpriteEffectCache),this.damageEffectWhiteDamage=new V(t,O.DAMAGE_EFFECT_NAME_WHITE_DAMAGE,H.damage,e.white,this.basicSpriteEffectCache),this.damageEffectBlueDamage=new V(t,O.DAMAGE_EFFECT_NAME_BLUE_DAMAGE,H.damage,e.darkBlue,this.basicSpriteEffectCache),this.damageEffectGreenDamage=new V(t,O.DAMAGE_EFFECT_NAME_GREEN_DAMAGE,H.damage,e.lightGreen,this.basicSpriteEffectCache),this.damageEffectShockDamage=new V(t,O.DAMAGE_EFFECT_NAME_SHOCK_DAMAGE,H.damage,e.lightBlueFlickering,this.basicSpriteEffectCache),this.damageEffectFireDamage=new V(t,O.DAMAGE_EFFECT_NAME_FIRE_DAMAGE,H.damage,e.orange,this.basicSpriteEffectCache),this.damageEffectPoisonDamage=new V(t,O.DAMAGE_EFFECT_NAME_POISON_DAMAGE,H.damage,e.darkGreen,this.basicSpriteEffectCache),this.damageEffectSonicDamage=new V(t,O.DAMAGE_EFFECT_NAME_SONIC_DAMAGE,H.damage,e.peach,this.basicSpriteEffectCache),this.damageEffectPinkDamage=new V(t,O.DAMAGE_EFFECT_NAME_PINK_DAMAGE,H.damage,null,this.basicSpriteEffectCache),this.effectSparkleGold=new V(t,O.EFFECT_NAME_SPARKLE_GOLD,H.damage,e.yellowFlickering,this.basicSpriteEffectCache),this.effectSparkleGreen=new V(t,O.EFFECT_NAME_SPARKLE_GREEN,H.damage,e.darkGreenFlickering,this.basicSpriteEffectCache),this.effectSparkleBlue=new V(t,O.EFFECT_NAME_SPARKLE_BLUE,H.damage,e.lightBlueFlickering,this.basicSpriteEffectCache),this.effectSparklePink=new V(t,O.EFFECT_NAME_SPARKLE_PINK,H.damage,e.peachFlickering,this.basicSpriteEffectCache),this.effectSparkleOrange=new V(t,O.EFFECT_NAME_SPARKLE_ORANGE,H.damage,e.redFlickering,this.basicSpriteEffectCache),this.effectSparkleRed=new V(t,O.EFFECT_NAME_SPARKLE_RED,H.damage,null,this.basicSpriteEffectCache),this.effectGreenSkull=new V(t,O.EFFECT_NAME_GREEN_SKULL,H.damage,e.darkGreenFlickering,this.basicSpriteEffectCache),this.effectYellowKey=new V(t,O.EFFECT_NAME_YELLOW_KEY,H.damage,e.peachFlickering,this.basicSpriteEffectCache),this.effectSkullCross=new V(t,O.EFFECT_NAME_SKULL_CROSS,H.damage,e.darkRed,this.basicSpriteEffectCache),this.effectShields=new V(t,O.EFFECT_NAME_SHIELDS,H.damage,e.darkBlue,this.basicSpriteEffectCache),this.effectRedCrosses=new V(t,O.EFFECT_NAME_RED_CROSSES,H.damage,e.yellow,this.basicSpriteEffectCache),this.effectFireRing=new V(t,O.EFFECT_NAME_FIRE_RING,H.damage,e.orange,this.basicSpriteEffectCache),this.effectIceRing=new V(t,O.EFFECT_NAME_ICE_RING,H.damage,e.lightBlue,this.basicSpriteEffectCache),this.effectGreenRing=new V(t,O.EFFECT_NAME_GREEN_RING,H.damage,e.lightGreen,this.basicSpriteEffectCache),this.effectPinkRing=new V(t,O.EFFECT_NAME_PINK_RING,H.damage,e.peach,this.basicSpriteEffectCache),this.effectYellowStar=new V(t,O.EFFECT_NAME_YELLOW_STAR,H.damage,null,this.basicSpriteEffectCache),this.effectBlueStar=new V(t,O.EFFECT_NAME_BLUE_STAR,H.damage,e.lightBlueFlickering,this.basicSpriteEffectCache),this.effectGreenStar=new V(t,O.EFFECT_NAME_GREEN_STAR,H.damage,e.lightGreenFlickering,this.basicSpriteEffectCache),this.effectWhiteCrosses=new V(t,O.EFFECT_NAME_WHITE_CROSSES,H.damage,e.cyan,this.basicSpriteEffectCache),this.effectWeb=new V(t,O.EFFECT_NAME_WEB,H.damage,null,this.basicSpriteEffectCache),this.effectTorch=new V(t,O.EFFECT_NAME_TORCH,H.damage,e.orange,this.basicSpriteEffectCache),this.effectFrost=new V(t,O.EFFECT_NAME_FROST,H.damage,e.white,this.basicSpriteEffectCache),this.effectYellowStarCircle=new V(t,O.EFFECT_NAME_YELLOW_STAR_CIRCLE,H.damage,null,this.basicSpriteEffectCache),this.effectCircles=new V(t,O.EFFECT_NAME_CIRCLES,H.damage,e.peach,this.basicSpriteEffectCache),this.effectGoldShieldSpiral=new V(t,O.EFFECT_NAME_GOLD_SHIELD_SPIRAL,H.damage,e.yellow,this.basicSpriteEffectCache),this.effectGreenShieldSpiral=new V(t,O.EFFECT_NAME_GREEN_SHIELD_SPIRAL,H.damage,e.lightGreen,this.basicSpriteEffectCache),this.effectBlueShieldSpiral=new V(t,O.EFFECT_NAME_BLUE_SHIELD_SPIRAL,null,e.lightBlue,this.basicSpriteEffectCache),this.effectPinkShieldSpiral=new V(t,O.EFFECT_NAME_PINK_SHIELD_SPIRAL,H.damage,e.peach,this.basicSpriteEffectCache),this.effectBlueFirework=new V(t,O.EFFECT_NAME_BLUE_FIREWORK,H.damage,e.lightBlue,this.basicSpriteEffectCache),this.effectRedFirework=new V(t,O.EFFECT_NAME_RED_FIREWORK,H.damage,e.red,this.basicSpriteEffectCache),this.effectStun=new V(t,O.EFFECT_NAME_BUBBLES,H.damage,e.peachFlickering,this.basicSpriteEffectCache),this.effectShield=new V(t,O.EFFECT_NAME_SHIELD,H.damage,e.lightGray,this.basicSpriteEffectCache),this.colorSpiralEffect=new V(t,O.EFFECT_NAME_COLOR_SPIRAL,H.damage,e.white,this.basicSpriteEffectCache),this.effectArmFlex=new V(t,O.EFFECT_NAME_ARM_FLEX,H.damage,e.lightBlue,this.basicSpriteEffectCache),this.effectSuperSpeed=new V(t,O.EFFECT_NAME_SUPER_SPEED,H.damage,e.yellow,this.basicSpriteEffectCache),this.effectTarget=new V(t,O.EFFECT_NAME_TARGET,H.damage,e.red,this.basicSpriteEffectCache),this.effectYellowShieldSpiral=new V(t,O.EFFECT_NAME_YELLOW_SHIELD_SPIRAL,H.damage,e.yellow,this.basicSpriteEffectCache),this.effectPinkStarCircle=new V(t,O.EFFECT_NAME_PINK_STAR_CIRCLE,H.damage,e.peach,this.basicSpriteEffectCache),this.effectBlueStarCircle=new V(t,O.EFFECT_NAME_BLUE_STAR_CIRCLE,H.damage,e.lightBlue,this.basicSpriteEffectCache),this.effectGreenStarCircle=new V(t,O.EFFECT_NAME_GREEN_STAR_CIRCLE,H.damage,e.lightGreen,this.basicSpriteEffectCache),this.effectGoldStarCircle=new V(t,O.EFFECT_NAME_GOLD_STAR_CIRCLE,H.damage,e.yellow,this.basicSpriteEffectCache),this.effectBread=new V(t,O.EFFECT_NAME_BREAD,H.damage,e.peach,this.basicSpriteEffectCache),this.effectYellowFireFing=new V(t,O.EFFECT_NAME_YELLOW_FIRE_RING,H.damage,e.yellow,this.basicSpriteEffectCache),this.effectTotems=new V(t,O.EFFECT_NAME_TOTEMS,H.damage,e.peach,this.basicSpriteEffectCache),this.effectEyeBlink=new V(t,O.EFFECT_NAME_EYE_BLINK,H.damage,e.orange,this.basicSpriteEffectCache),this.effectPinkStar=new V(t,O.EFFECT_NAME_PINK_STAR,H.damage,e.peachFlickering,this.basicSpriteEffectCache),this.effectOrangeStar=new V(t,O.EFFECT_NAME_ORANGE_STAR,H.damage,e.yellowFlickering,this.basicSpriteEffectCache),this.effectRedEyeBlink=new V(t,O.EFFECT_NAME_RED_EYE_BLINK,H.damage,e.red,this.basicSpriteEffectCache),this.effectEagle=new V(t,O.EFFECT_NAME_EAGLE,H.damage,e.lightBlue,this.basicSpriteEffectCache),this.effectSleep=new V(t,O.EFFECT_NAME_SLEEP,null,e.orange,this.basicSpriteEffectCache),this.effectArmor=new V(t,O.EFFECT_NAME_ARMOR,H.damage,e.red,this.basicSpriteEffectCache),this.effectBlindEyeBlink=new V(t,O.EFFECT_NAME_BLIND_EYE_BLINK,H.damage,e.lightBlue,this.basicSpriteEffectCache),this.effectFireRain=new V(t,O.EFFECT_NAME_FIRE_RAIN,H.damage,e.yellowFlickering,this.basicSpriteEffectCache),this.effectBlueRain=new V(t,O.EFFECT_NAME_BLUE_RAIN,H.damage,e.lightBlueFlickering,this.basicSpriteEffectCache),this.effectGreenRain=new V(t,O.EFFECT_NAME_GREEN_RAIN,H.damage,e.lightGreenFlickering,this.basicSpriteEffectCache),this.effectLightningRain=new V(t,O.EFFECT_NAME_LIGHTNING_RAIN,H.damage,e.yellowFlickering,this.basicSpriteEffectCache),this.effectPinkRain=new V(t,O.EFFECT_NAME_PINK_RAIN,H.damage,e.peachFlickering,this.basicSpriteEffectCache),this.effectRainbowRain=new V(t,O.EFFECT_NAME_RAINBOW_RAIN,H.damage,e.yellowFlickering,this.basicSpriteEffectCache)}resetFull(){this.basicSpriteEffectCache.resetCache()}resetForPrestige(){this.resetFull()}};var ns=class extends z{constructor(e){super(),this.projection=e,this.spriteEffects=[]}resetEffectList(e){if(e.length>0){for(let t=0;t<e.length;t++)e[t].reset(!0);e.length=0}}updateEffectsForFrame(e){this.updateEffectListForFrame(this.spriteEffects,e,!0)}updateEffectListForFrame(e,t,i){let r=!1;for(let s=e.length-1;s>=0;s--){let o=e[s];if(!o||o.isFinishedAndAvailable()){e.splice(s,1),r=!0;continue}o.updateEffectForFrame(t),o.isEffectFinished()&&(i&&!o.isFinishedAndAvailable()&&o.reset(!0),e.splice(s,1),r=!0)}return r}addEffect(e){this.addEffectWithSoundFlag(e,!0)}addEffectWithSoundFlag(e,t){if(!e||e.isFinishedAndAvailable())return;this.spriteEffects.push(e)}resetEffectManager(){this.resetEffectList(this.spriteEffects)}resetFull(){this.resetEffectManager()}resetForPrestige(){this.resetEffectManager()}};var as=class extends mt{constructor(){super(),this.text="",this.textX=0,this.textY=0,this.frameCount=0,this.incrementX=0,this.incrementY=0,this.frameToggle=!1}set(e){this.text=e,this.incrementX=this.calculateTextMotion(),this.incrementY=1+(Math.random()>.5?1:0),this.frameToggle=!0,this.frameCount=0}calculateTextMotion(){let e=1+(Math.random()>.5?1:0);return Math.random()<.5?-e:e}isTextFinished(){return this.frameCount>=n.text.textFrameDuration}updateTextForFrame(e){return this.frameToggle&&(Math.random()<.5&&(this.textX+=this.incrementX),this.textY-=this.incrementY),this.frameToggle=!this.frameToggle,this.frameCount+=e,this.textY<=0||this.isTextFinished()}};var ls=class extends Tt{constructor(){super()}getGrowAmount(){return 10}getInitialSize(){return 10}createInstance(){return new as}};var ds=class extends z{constructor(e){super(),this.projection=e,this.infoTextCache=new ls,this.infoTextArray=[],this.workingVector=new b}addOreText(e,t){if(!this.projection.isVisibleGridBox(e))return;let i=I.formatBigNum(t);this.addCurrencyInternal(e,i)}addGoldText(e,t){if(!this.projection.isVisibleGridBox(e))return;let i=I.formatBigNum(t)+" Gold!";this.addCurrencyInternal(e,i)}addRubyText(e,t){if(!this.projection.isVisibleGridBox(e))return;let i=I.formatBigNum(t)+" Ruby!";this.addCurrencyInternal(e,i)}addCurrencyInternal(e,t){if(!this.projection.isVisibleGridBox(e))return;for(;this.infoTextArray.length>=n.text.maxInfoTextCount;)this.infoTextArray[0].reset(!0),this.infoTextArray.splice(0,1);let i=this.infoTextCache.get();i.set(t),this.setTextPosition(i,e.origin),this.infoTextArray.push(i)}setTextPosition(e,t){this.projection.worldToScreen(t,this.workingVector),e.textX=this.workingVector.x+n.tile.halfSize,e.textY=this.workingVector.y}updateTextForFrame(e){for(let t=this.infoTextArray.length-1;t>=0;t--){let i=this.infoTextArray[t];i.updateTextForFrame(e)&&(i.reset(!0),this.infoTextArray.splice(t,1))}}clearInfoText(){this.infoTextArray.length>0&&(this.resetInfoTextList(this.infoTextArray),this.infoTextArray.length=0)}resetInfoTextList(e){for(let t=0;t<e.length;t++)e[t].reset(!0)}resetFull(){this.infoTextArray.length=0,this.infoTextCache.resetCache()}resetForPrestige(){this.resetFull()}};var ci=class extends z{constructor(){super(),this.totalOre=new d(0),this.totalGold=new d(0),this.totalRuby=new d(0),this.totalPrestigePoints=new d(0),this.maxDepth=0,this.upgradeOre=new d(0),this.totalTurns=0,this.tilesMined=new d(0),this.tilesMinedCommon=new d(0),this.tilesMinedOre=new d(0),this.tilesMinedGold=new d(0),this.tilesMinedRuby=new d(0),this.tilesMinedUpgrade=new d(0),this.tilesMinedLaser=new d(0),this.tilesMinedDrill=new d(0),this.tilesMinedOrbit=new d(0),this.tilesMinedFissure=new d(0),this.tilesMinedLightning=new d(0),this.tilesMinedMissile=new d(0),this.one=new d(1)}tileDepth(e){e>this.maxDepth&&(this.maxDepth=e)}onTileMined(e){switch(this.tilesMined.add(this.one),e.tileType.rarityModifier){case R.COMMON:this.tilesMinedCommon.add(this.one);break;case R.ORE:this.tilesMinedOre.add(this.one);break;case R.GOLD:this.tilesMinedGold.add(this.one);break;case R.RUBY:this.tilesMinedRuby.add(this.one);break;case R.UPGRADE:this.tilesMinedUpgrade.add(this.one);break}}incrementTurns(e){this.totalTurns+=e}incrementOre(e){this.totalOre.add(e)}incrementUpgradeOre(e){this.upgradeOre.add(e)}incrementGold(e){this.totalGold.add(e)}incrementRuby(e){this.totalRuby.add(e)}incrementPrestigePoints(e){this.totalPrestigePoints.add(e)}incrementMinedByLaser(){this.tilesMinedLaser.add(this.one)}incrementMinedByDrill(){this.tilesMinedDrill.add(this.one)}incrementMinedByOrbit(){this.tilesMinedOrbit.add(this.one)}incrementMinedByFissure(){this.tilesMinedFissure.add(this.one)}incrementMinedByLightning(){this.tilesMinedLightning.add(this.one)}incrementMinedByMissile(){this.tilesMinedMissile.add(this.one)}resetFull(){this.totalOre.setZero(),this.totalGold.setZero(),this.totalRuby.setZero(),this.totalPrestigePoints.setZero(),this.upgradeOre.setZero(),this.maxDepth=0,this.totalTurns=0,this.tilesMined.setZero(),this.tilesMinedCommon.setZero(),this.tilesMinedOre.setZero(),this.tilesMinedGold.setZero(),this.tilesMinedRuby.setZero(),this.tilesMinedUpgrade.setZero(),this.tilesMinedLaser.setZero(),this.tilesMinedDrill.setZero(),this.tilesMinedOrbit.setZero(),this.tilesMinedFissure.setZero(),this.tilesMinedLightning.setZero(),this.tilesMinedMissile.setZero()}resetForPrestige(){this.resetFull()}};var hs=class{constructor(e,t){this.globalStatitics=e,this.runStatistics=t}incrementTurns(e){this.globalStatitics.incrementTurns(e),this.runStatistics.incrementTurns(e)}tileDepth(e){this.globalStatitics.tileDepth(e),this.runStatistics.tileDepth(e)}onTileMined(e){this.globalStatitics.onTileMined(e),this.runStatistics.onTileMined(e)}incrementOre(e){this.globalStatitics.incrementOre(e),this.runStatistics.incrementOre(e)}incrementUpgradeOre(e){this.globalStatitics.incrementUpgradeOre(e),this.runStatistics.incrementUpgradeOre(e)}incrementGold(e){this.globalStatitics.incrementGold(e),this.runStatistics.incrementGold(e)}incrementRuby(e){this.globalStatitics.incrementRuby(e),this.runStatistics.incrementRuby(e)}incrementPrestigePoints(e){this.globalStatitics.incrementPrestigePoints(e),this.runStatistics.incrementPrestigePoints(e)}incrementMinedByLaser(){this.globalStatitics.incrementMinedByLaser(),this.runStatistics.incrementMinedByLaser()}incrementMinedByDrill(){this.globalStatitics.incrementMinedByDrill(),this.runStatistics.incrementMinedByDrill()}incrementMinedByOrbit(){this.globalStatitics.incrementMinedByOrbit(),this.runStatistics.incrementMinedByOrbit()}incrementMinedByFissure(){this.globalStatitics.incrementMinedByFissure(),this.runStatistics.incrementMinedByFissure()}incrementMinedByLightning(){this.globalStatitics.incrementMinedByLightning(),this.runStatistics.incrementMinedByLightning()}incrementMinedByMissile(){this.globalStatitics.incrementMinedByMissile(),this.runStatistics.incrementMinedByMissile()}};var mi=class{constructor(e,t){this.title=e,this.iconFileName=t,this.purchasedCount=0}getDescription(){return null}isPurchasable(){return this.isAffordable()}isAffordable(){return!1}getCost(){return null}getCostUnit(){return null}getPurchasedCount(){return this.purchasedCount}setPurchasedCount(e){this.purchasedCount=e}setPurchasedCountFromSave(e){this.setPurchasedCount(e)}purchase(){return!1}resetUpgrade(){this.purchasedCount=0}};var pi=class extends z{constructor(){super(),this.upgrades=[],this.changeCount=0}add(e){if(!e){console.log("UpgradeCollection.add() null upgrade");return}this.upgrades.push(e),this.changeCount++}addBulk(e){if(!e){console.log("UpgradeCollection.addBulk() null upgrade");return}this.upgrades.push(e)}addBulkCompleted(){this.changeCount++}remove(e){if(!e){console.log("UpgradeCollection.remove() upgrade null");return}let t=this.upgrades.indexOf(e);if(t===-1){console.log("UpgradeCollection.remove() did not find upgrade in list");return}this.upgrades.splice(t,1),this.changeCount++}resetFull(){this.upgrades.length=0,this.changeCount=0}resetForPrestige(){this.resetFull()}};var Zt={NUMBER:1,BOOLEAN:2,BIG_NUM:3};var Dt=class{constructor(e){this.id=e}reset(){}getValueType(){return Zt.BIG_NUM}isAtInitialValue(){return!0}isValueApplicable(){return!0}};var yt=class extends Dt{constructor(e,t){super(e),this.initialValue=new d(0).copy(t),this.value=new d(0).copy(t)}getValue(){return this.value}setValue(e){this.value.copy(e)}setZero(){this.value.setZero()}incrementValue(e){this.value.add(e)}reset(){this.value.copy(this.initialValue)}getValueType(){return Zt.BIG_NUM}isAtInitialValue(){return this.value.equals(this.initialValue)}isValueApplicable(){return this.value.greaterThanZero()}};var we=class extends Dt{constructor(e,t){super(e),this.value=t,this.initialValue=t}getValue(){return this.value}setValue(e){this.value=e}incrementValue(e){this.value+=e}decrementValue(e){this.value-=e,this.value<this.initialValue&&(this.value=this.initialValue)}isPercentageApplied(){return this.value<=0?!1:this.value>=100?!0:Ie.randomInt(100)<this.value}getPercentAsFraction(){return this.value===0?0:this.value/100}reset(){this.value=this.initialValue}getValueType(){return Zt.NUMBER}isAtInitialValue(){return this.value===this.initialValue}isValueApplicable(){return this.value>0}};var gi=class extends Dt{constructor(e,t){super(e),this.initialValue=t,this.value=t}isValue(){return this.value}setValue(e){this.value=e}toggleValue(){this.value=!this.value}reset(){this.value=this.initialValue}getValueType(){return Zt.BOOLEAN}isAtInitialValue(){return this.value===this.initialValue}isValueApplicable(){return this.value!=this.initialValue}};var us=class extends z{constructor(){super(),this.baseAdditiveBonusPerTurn=new yt("baseAdditiveBonusPerTurn",new d(0)),this.baseMultiplicativeBonusValue=new yt("baseMultiBonusValue",new d(0)),this.minedDamageBonusMultiplier=new yt("minedDamageBonusValue",new d(0)),this.minedOreBonus=new yt("minedOreBonusValue",new d(0)),this.bonusOreMultiplier=new we(null,0),this.bonusUpgradeMultiplier=new we(null,0),this.bonusGoldIncrement=new we(null,0),this.goldOreBonusMultiplier=new yt(null,new d(1)),this.skillOreBonusMultiplier=new yt(null,new d(0)),this.skillPrestigeBonusMultiplier=new we(null,0),this.skillDepthBonusMultiplier=new we(null,0),this.skillUpgradeAdditiveBonusMultiplier=new we(null,0),this.skillUpgradeMultiplicativeBonusMultiplier=new we(null,0),this.skillMinedDamageBonus=new we(null,0),this.skillMinedOreBonusUpgrades=new we(null,0),this.minedAutomationUnlocked=new gi(null,!1),this.minedAutomationRateUpgrades=new we(null,0),this.pickAutomationUnlocked=new gi(null,!1),this.pickAutomationRateUpgrades=new we(null,0),this.prestigeAutomationUnlocked=new gi(null,!1),this.prestigeAutomationRateUpgrades=new we(null,0),this.offlineTimeUpgrades=new we(null,0)}resetFull(){this.resetForPrestige(),this.goldOreBonusMultiplier.reset(),this.skillOreBonusMultiplier.reset(),this.skillPrestigeBonusMultiplier.reset(),this.skillDepthBonusMultiplier.reset(),this.skillUpgradeAdditiveBonusMultiplier.reset(),this.skillUpgradeMultiplicativeBonusMultiplier.reset(),this.skillMinedDamageBonus.reset(),this.skillMinedOreBonusUpgrades.reset(),this.minedAutomationUnlocked.reset(),this.minedAutomationRateUpgrades.reset(),this.pickAutomationUnlocked.reset(),this.pickAutomationRateUpgrades.reset(),this.prestigeAutomationUnlocked.reset(),this.prestigeAutomationRateUpgrades.reset(),this.offlineTimeUpgrades.reset()}resetForPrestige(){this.baseAdditiveBonusPerTurn.reset(),this.baseMultiplicativeBonusValue.reset(),this.minedDamageBonusMultiplier.reset(),this.minedOreBonus.reset(),this.bonusOreMultiplier.reset(),this.bonusUpgradeMultiplier.reset(),this.bonusGoldIncrement.reset()}};var cs=class{constructor(e,t,i,r){this.values=e,this.totals=t,this.damage=i,this.globalStatistics=r,this.workingMineDamage=new d(0),this.minedDamageBonus=new d(0),this.prestigeBonus=new d(0),this.prestigeMultiplier=new d(n.prestige.multiplierPerPrestige),this.rubyBonus=new d(0),this.workingDepthDamageMultiplier=new d(0),this.workingMultiBonus=new d(0),this.workingPrestige=new d(0),this.oneBigNum=new d(1),this.perFrameConversionFactor=new d(1/n.time.turnFrames)}calculateTotalMineDamagePerTurn(){this.workingMineDamage.copy(this.damage.basePickDamagePerTurn),this.workingMineDamage.add(this.values.baseAdditiveBonusPerTurn.getValue()),this.workingMultiBonus.copy(this.oneBigNum),this.workingMultiBonus.add(this.values.baseMultiplicativeBonusValue.getValue()),this.minedDamageBonus.copy(this.oneBigNum),this.minedDamageBonus.add(this.values.minedDamageBonusMultiplier.getValue()),this.damage.minedDamageMultiplier.copy(this.minedDamageBonus),this.prestigeMultiplier.setValue(n.prestige.multiplierPerPrestige+this.values.skillPrestigeBonusMultiplier.getValue()),this.prestigeBonus.copy(this.totals.prestigePointsSum),this.prestigeBonus.mul(this.prestigeMultiplier),this.prestigeBonus.add(this.oneBigNum),this.damage.prestigeDamageMultiplier.copy(this.prestigeBonus),this.totals.ruby.greaterThanZero()?(this.rubyBonus.copy(this.totals.ruby),this.rubyBonus.add(this.oneBigNum),this.damage.rubyDamageMultiplier.copy(this.rubyBonus)):this.damage.rubyDamageMultiplier.copy(this.oneBigNum);let e=this.values.skillDepthBonusMultiplier.getValue();e>0?(this.workingDepthDamageMultiplier.setValue(this.globalStatistics.maxDepth),this.workingDepthDamageMultiplier.mulNumber(e),this.damage.depthDamageMultiplier.copy(this.workingDepthDamageMultiplier)):(this.workingDepthDamageMultiplier.copy(this.oneBigNum),this.damage.depthDamageMultiplier.copy(this.oneBigNum)),this.workingMineDamage.multiply(this.workingMultiBonus),this.minedDamageBonus.greaterThan(this.oneBigNum)&&this.workingMineDamage.multiply(this.minedDamageBonus),this.prestigeBonus.greaterThan(this.oneBigNum)&&this.workingMineDamage.multiply(this.prestigeBonus),this.workingDepthDamageMultiplier.greaterThan(this.oneBigNum)&&this.workingMineDamage.multiply(this.workingDepthDamageMultiplier),this.damage.goldDamageMultiplier.greaterThan(this.oneBigNum)&&this.workingMineDamage.multiply(this.damage.goldDamageMultiplier),this.damage.rubyDamageMultiplier.greaterThan(this.oneBigNum)&&this.workingMineDamage.multiply(this.damage.rubyDamageMultiplier),this.damage.totalPickDamagePerTurn.copy(this.workingMineDamage),this.damage.totalPickDamagePerFrame.copy(this.damage.totalPickDamagePerTurn),this.damage.totalPickDamagePerFrame.mul(this.perFrameConversionFactor)}};var ms=class{constructor(e){this.values=e,this.one=new d(1)}calculateOreForDepth(e,t){e.tileType.layerDescription.calculateTileOre(e.getTileRow(),t),this.applyMultipliers(t)}applyMultipliers(e){let t=this.values.skillOreBonusMultiplier.getValue();t.greaterThan(this.one)&&e.mul(t);let i=this.values.goldOreBonusMultiplier.getValue();i.greaterThan(this.one)&&e.mul(i)}};var c={pick:"images/pick_40x40.png",miner:"images/pick_40x40.png",offline:"images/pick_40x40.png",currency:{ore:"images/layers/purple_ore.png",gold:"images/layers/gold.png",ruby:"images/layers/ruby.png",prestige:"images/pick_40x40.png",depth:"images/pick_40x40.png",upgrades:"images/upgrades_40x40.png"},skill:{missiles:"images/missile_40x40.png",orbit:"images/orbit_40x40.png",laser:"images/laser_40x40.png",lightning:"images/laser_40x40.png",chain:"images/laser_40x40.png",drill:"images/drill_40x40.png",radar:"images/laser_40x40.png",fissure:"images/laser_40x40.png",minions:"images/laser_40x40.png",dynamite:"images/dynamite_40x40.png",damage:"images/laser_40x40.png",activation:"images/laser_40x40.png"}};var vl={ANT:new Se("1",g.PEST_ANT_10,Pe.BASIC),SPIDER1:new Se("2",g.PEST_SPIDER_20,Pe.BASIC),SPIDER2:new Se("3",g.PEST_SPIDER_21,Pe.BASIC),SPIDER3:new Se("4",g.PEST_SPIDER_22,Pe.BASIC),WORM1:new Se("5",g.PEST_WORM_30,Pe.BASIC),WORM2:new Se("6",g.PEST_WORM_31,Pe.BASIC),WORM4:new Se("7",g.PEST_WORM_33,Pe.BASIC),WORM5:new Se("8",g.PEST_WORM_34,Pe.BASIC),BALL:new Se("9",g.PEST_BALL,Pe.BASIC),SLUG1:new Se("10",g.PEST_SLUG_70,Pe.BASIC),SLUG2:new Se("11",g.PEST_SLUG_71,Pe.BASIC),SNAIL1:new Se("12",g.PEST_SNAIL_72,Pe.BASIC),SNAIL2:new Se("13",g.PEST_SNAIL_73,Pe.BASIC),SLIME01:new Se("14",g.SLIME_BLUE_00,Pe.BASIC),SLIME02:new Se("15",g.SLIME_BROWN_01,Pe.BASIC),SLIME03:new Se("16",g.SLIME_WHITE_02,Pe.BASIC),SLIME04:new Se("17",g.SLIME_GREEN_03,Pe.BASIC),SLIME05:new Se("18",g.SLIME_PINK_04,Pe.BASIC),SLIME06:new Se("19",g.SLIME_MUCUS_GREEN_40,Pe.BASIC),SLIME07:new Se("20",g.SLIME_MUCUS_BLUE_41,Pe.BASIC),SLIME08:new Se("21",g.SLIME_CORRODED_20,Pe.BASIC),SLIME09:new Se("22",g.SLIME_SEEING_21,Pe.BASIC),SLIME10:new Se("23",g.SLIME_ORANGE_22,Pe.BASIC),SLIME11:new Se("24",g.SLIME_MINI_BLUE_30,Pe.BASIC),SLIME12:new Se("25",g.SLIME_MINI_31,Pe.BASIC),SLIME13:new Se("26",g.SLIME_MINI_ORANGE_32,Pe.BASIC)};function gd(){let l={};for(let e of Object.values(vl))l[e.id]=e;return l}function fd(){let l=[];for(let e of Object.values(vl))l.push(e);return l}var xl=gd(),Xa=fd();function Dl(){let l=[];return l.push(Xa[Ie.randomInt(Xa.length)]),l.push(Xa[Ie.randomInt(Xa.length)]),l}var Ue={SKY_LAYER:new Xt(ge.SKY,-1),GRASS_LAYER:new Xt(ge.GRASS,-1),DIRT_LAYER:new Xt(ge.DIRT,1)};function Td(){let l=[];l.push(Ue.SKY_LAYER),l.push(Ue.GRASS_LAYER),l.push(Ue.DIRT_LAYER);let e=2;for(let C=0;C<ft.length;C++)l.push(new Xt(ft[C],e++));Ue.SKY_LAYER.minDepth=-1e6,Ue.SKY_LAYER.maxDepth=-1,Ue.SKY_LAYER.baseHealth=new d(1),Ue.GRASS_LAYER.minDepth=-1,Ue.GRASS_LAYER.maxDepth=0,Ue.GRASS_LAYER.baseHealth=new d(1),Ue.GRASS_LAYER.baseOre=new d(1),Ue.SKY_LAYER.initializeLayerValues(1,1,.05,new d(1),new d(0));let t=1,i=10,r=.1,s=new d(.8),o=new d(12),a=new d(10),h=new d(5),m=2,p=.1,f=.1,N=Ue.GRASS_LAYER,T=500;for(let C=2;C<l.length;C++){let w=l[C];w.monsterDescriptions=Dl(),w.initializeLayerValues(t,i,r,s,o),C<l.length-1?w.initializeLayer(N,T):w.initializeLayer(N,-1),N=w,s.mul(h),o.mul(a),i*=m,r+=p,p+=f}return l}var je=Td();function Ed(){let l={};for(let e=0;e<je.length;e++){let t=je[e];l[t.id]=t}return l}var Ol=Ed();function Bl(l){for(let e=0;e<je.length;e++){let t=je[e];if(t.minDepth<=l&&l<t.maxDepth)return t}return je[je.length-1]}function kl(l,e){let t=l;for(;t&&t.prevLayer&&t.baseHealth.greaterThan(e);)t=t.prevLayer;for(;t&&t.nextLayer&&t.maxHealth.lessThan(e);)t=t.nextLayer;return t||(console.log("LayerDescriptions.findLayerForHealth() null layer. using default"),l)}var Ye=class{constructor(){}static calculateMinedDamageUpgradeValue(e){let t=(80+Ie.randomInt(20))/100;return new d(e.tileType.layerDescription.multiplicativeBonusFactor*t)}static getDamageMultiplier(e){return 1+n.skill.common.damagePerUpgrade*e.getValue()}static getDamagePercent(e){return n.skill.common.damagePercentPerUpgrade*e.getValue()}static getSkillActivationTurns(e){return n.skill.common.baseActivationTurns+e.getValue()*n.skill.common.activationTurnsPerUpgrade}static getSkillActivationSeconds(e){return this.getSkillActivationTurns(e)*n.time.secondsPerTurn}static getSkillCoolDownTurns(e){let t=e.getValue()*n.skill.common.coolDownTurnsPerUpgrade;return Math.max(8,n.skill.common.baseCoolDownTurns-t)}static getSkillCoolDownSeconds(e){return this.getSkillCoolDownTurns(e)*n.time.secondsPerTurn}static getMissileCount(e){return n.skill.missiles.initialMissiles+n.skill.missiles.missilesPerUpgrade*e.getValue()}};var ps=class{constructor(e){this.id=e}getId(){return this.id}createMinedUpgrade(e){}createFreeValueUpgradeFromSave(e){}createFreeIdentifierUpgradeFromSave(e){}combineUpgrades(e,t){if(!e||!t){console.log("UpgradeCreator.combineUpgrade() null upgrade");return}if(e.getCreatorId()!==t.getCreatorId()){console.log("UpgradeCreator.combineUpgrade() creatorId mismatch");return}if(this.id!==e.getCreatorId()||this.id!==t.getCreatorId()){console.log("UpgradeCreator.combineUpgrade() creatorId does not match upgrade creator");return}this.combineUpgradesInternal(e,t)}combineUpgradesInternal(e,t){}};var fi=class extends mi{constructor(e,t,i){super(t,i),this.upgradeCreator=e}getCreatorId(){return this.upgradeCreator.id}isCombineSupported(){return!1}isPurchasable(){return this.purchasedCount===0}isAffordable(){return!0}purchase(){return this.purchasedCount>0?!1:(this.purchasedCount++,this.onUpgradePurchased(),!0)}onUpgradePurchased(){}};var gs=class extends fi{constructor(e,t,i,r,s,o){super(e,t,i),this.valueDelta=r,this.upgradeBonusValue=s,this.mineDamageLogic=o}onUpgradePurchased(){this.upgradeBonusValue.incrementValue(this.valueDelta),this.mineDamageLogic&&this.mineDamageLogic.calculateTotalMineDamagePerTurn()}isCombineSupported(){return!0}};var Ti=class extends ps{constructor(e,t,i){super(e),this.values=t,this.multiplierValue=i}getUpgradeBonusMultiplier(){let e=this.multiplierValue.getValue();return e>1?e:1}};var Ot={mineDamage:"mineDamage",mineOre:"mineOre"};var fs=class extends Ti{constructor(e,t){super(Ot.mineDamage,e,null),this.mineDamageLogic=t}createMinedUpgrade(e){let t=Ye.calculateMinedDamageUpgradeValue(e),i=this.values.skillMinedDamageBonus.getValue();return i>0&&t.addNumber(i),this.createInternal(t)}createFreeValueUpgradeFromSave(e){return this.createInternal(e)}createInternal(e){let t=this.createTitle(e);return new gs(this,t,c.pick,e,this.values.minedDamageBonusMultiplier,this.mineDamageLogic)}combineUpgradesInternal(e,t){e.valueDelta.add(t.valueDelta),e.title=this.createTitle(e.valueDelta)}createTitle(e){return"Multiplier: +"+I.formatBigNum(e)}};var Ts=class extends fi{constructor(e,t,i,r,s,o){super(e,t,i),this.ore=r,this.totals=s,this.statisticsInc=o}onUpgradePurchased(){this.totals.incrementOre(this.ore),this.statisticsInc.incrementOre(this.ore),this.statisticsInc.incrementUpgradeOre(this.ore)}isCombineSupported(){return!0}};var Es=class extends Ti{constructor(e,t,i,r){super(Ot.mineOre,e,null),this.oreCalculationLogic=t,this.totals=i,this.statisticsInc=r}createMinedUpgrade(e){let t=new d(0);this.oreCalculationLogic.calculateOreForDepth(e,t);let i=n.skill.bonus.minedOreBaseTiles,r=this.values.skillMinedOreBonusUpgrades.getValue();if(r>0){let s=r*n.skill.bonus.minedOreBonusPerUpgrade;i+=s}return t.mulNumber(i),this.createInternal(t)}createFreeValueUpgradeFromSave(e){return this.createInternal(e)}createInternal(e){let t=this.createTitle(e);return new Ts(this,t,c.pick,e,this.totals,this.statisticsInc)}combineUpgradesInternal(e,t){e.ore.add(t.ore),e.title=this.createTitle(e.ore)}createTitle(e){return"Ore: +"+I.formatBigNum(e)}};var ws=class extends pi{constructor(){super(),this.combineUpgradeThreshold=8}contains(e){for(let t=0;t<this.upgrades.length;t++)if(this.upgrades[t].getCreatorId()===e)return!0;return!1}add(e){super.add(e),this.upgrades.length>this.combineUpgradeThreshold&&this.combineUpgrades()}combineUpgrades(){for(let e=0;e<this.upgrades.length-1;e++){let t=this.upgrades[e];if(t.isCombineSupported())for(let i=this.upgrades.length-1;i>e;i--){let r=this.upgrades[i];if(r.isCombineSupported()&&t.getCreatorId()===r.getCreatorId()){t.upgradeCreator.combineUpgrades(t,r),this.upgrades.splice(i,1),this.changeCount++;break}}}}};var Cs=class{constructor(e,t,i,r,s,o){this.creatorsById={},this.minedUpgradeCollection=s,this.mineDamage=new fs(e,r),this.creatorsById[this.mineDamage.getId()]=this.mineDamage,this.oreBonus=new Es(e,i,t,o),this.creatorsById[this.oreBonus.getId()]=this.oreBonus}getUpgradeCreatorById(e){return this.creatorsById[e]}getUpgradeCreatorForDrop(){return Math.random()<.65?this.oreBonus:this.mineDamage}};var Ss=class{constructor(e,t,i,r,s,o,a,h,m,p,f,N){this.crew=e,this.totals=t,this.damage=i,this.values=r,this.statisticsInc=s,this.upgradeCollection=o,this.upgradeCreators=a,this.infoTextProcessor=h,this.effectCreators=m,this.effectManager=p,this.oreCalculationLogic=f,this.mineDamageLogic=N,this.workingValue=new d(0),this.workingDamage=new d(0),this.turnsPerSecond=new d(n.time.turnsPerSecond),this.one=new d(1)}mineTileForTurn(e,t){if(!t||t.open)return!0;if(this.workingDamage.copy(this.damage.totalPickDamagePerTurn),t.onTileDamaged(this.workingDamage),t.open){let i=this.getOppositeTile(e.position.tile,t);if(i){this.revealTile(i);for(let r=0;r<i.neighbors.length;r++)this.revealTile(i.neighbors[r]);this.revealTile(i.getNeighborBottomLeft()),this.revealTile(i.getNeighborBottomRight()),this.revealTile(i.getNeighborTopLeft()),this.revealTile(i.getNeighborTopRight())}return this.statisticsInc.onTileMined(t),this.handleTileDrops(t),!0}return!1}revealTile(e){e&&e.markTileAsCurrentlyVisible()}getOppositeTile(e,t){return e?t.isNeighborLeft(e)?t.getNeighborRight():t.isNeighborRight(e)?t.getNeighborLeft():t.isNeighborBottom(e)?t.getNeighborTop():t.isNeighborTop(e)?t.getNeighborBottom():null:null}laserTileForFrame(e,t){!e||e.open||(this.skillDamageForFrame(e,t,this.effectCreators.effectSparkleRed),e.open&&this.statisticsInc.incrementMinedByLaser())}drillTileForFrame(e,t){!e||e.open||(this.skillDamageForFrame(e,t,this.effectCreators.effectSparkleBlue),e.open&&this.statisticsInc.incrementMinedByDrill())}orbitTileForFrame(e,t){!e||e.open||(this.skillDamageForFrame(e,t,this.effectCreators.effectSparkleGold),e.open&&this.statisticsInc.incrementMinedByOrbit())}calculateMissileDamage(e){return e.copy(this.damage.totalPickDamagePerTurn),e}missileTile(e,t){if(!e||e.open)return;let i=e.getHealth();i.lessThan(t)?(t.sub(i),e.onTileBreak(),this.statisticsInc.incrementMinedByMissile()):(e.onTileDamaged(t),t.setZero())}applyFissureSkillForFrame(e,t){!e||e.open||(this.skillDamageForFrame(e,t,null),e.open&&this.statisticsInc.incrementMinedByFissure())}applyLightningSkillForFrame(e,t){!e||e.open||(this.skillDamageForFrame(e,t,this.effectCreators.effectSparkleOrange),e.open&&this.statisticsInc.incrementMinedByLightning())}skillDamageForFrame(e,t,i){if(!(!e||e.open)&&(this.workingDamage.copy(this.damage.totalPickDamagePerFrame),this.workingDamage.mulNumber(t),e.onTileDamaged(this.workingDamage),e.open&&(this.statisticsInc.onTileMined(e),e.markTileAsCurrentlyVisible(),this.handleTileDrops(e),i))){let r=i.createEffectAtPosition(null,e.origin);r?this.effectManager.addEffect(r):console.log("TileMinedLogic.skillDamageForFrame. FAILED TO CREATE SPRITE")}}handleTileDrops(e){let i=e.tileType.rarityModifier;if(!(i===R.UNSET||i===R.COMMON))if(this.workingValue.setZero(),i===R.ORE)this.oreCalculationLogic.calculateOreForDepth(e,this.workingValue),this.totals.incrementOre(this.workingValue),this.statisticsInc.incrementOre(this.workingValue),this.infoTextProcessor.addOreText(e,this.workingValue);else if(i===R.GOLD)e.calculateTileGold(this.workingValue),this.totals.incrementGold(this.workingValue),this.statisticsInc.incrementGold(this.workingValue),this.infoTextProcessor.addGoldText(e,this.workingValue);else if(i===R.UPGRADE){let s=this.upgradeCreators.getUpgradeCreatorForDrop().createMinedUpgrade(e);s?this.upgradeCollection.add(s):console.log("TileMinedLogic.handleTileDrops() no upgrade created")}else i===R.RUBY&&(this.totals.incrementRuby(this.one),this.statisticsInc.incrementRuby(this.one),this.infoTextProcessor.addRubyText(e,this.one),this.mineDamageLogic.calculateTotalMineDamagePerTurn())}};var Ns=class extends z{constructor(){super(),this.commonMiningCandidates=[],this.priorityMiningCandidates=[],this.currencyMiningCandidates=[],this.destinationTileCandidates=[],this.centerTile=null,this.minRow=0,this.maxRow=0,this.vectorFieldNumber=0,this.tileHealthNegligible=!1}isVectorFieldMineTargetsEmpty(){return this.commonMiningCandidates.length===0&&this.currencyMiningCandidates.length===0&&this.priorityMiningCandidates.length===0}isPriorityTileVisible(){return this.priorityMiningCandidates.length>0||this.currencyMiningCandidates.length>0}onGridUnload(e){return this.centerTile&&this.centerTile.grid===e?(this.reset(),!0):(this.removeTilesForGrid(e,this.commonMiningCandidates),this.removeTilesForGrid(e,this.priorityMiningCandidates),this.removeTilesForGrid(e,this.currencyMiningCandidates),!1)}removeTilesForGrid(e,t){for(let i=t.length-1;i>=0;i--)t[i].grid===e&&t.splice(i,1)}resetFull(){this.reset()}resetForPrestige(){this.reset()}reset(){this.commonMiningCandidates.length>0&&(this.commonMiningCandidates.length=0),this.priorityMiningCandidates.length>0&&(this.priorityMiningCandidates.length=0),this.currencyMiningCandidates.length>0&&(this.currencyMiningCandidates.length=0),this.centerTile=null,this.vectorFieldNumber++,this.vectorFieldNumber>1e5&&(this.vectorFieldNumber=0)}};var As=class{constructor(e){this.subject=e,this.startTime=performance.now(),this.elapsed=0,this.count=0}startTimer(){this.startTime=performance.now()}endTimer(){this.elapsed+=performance.now()-this.startTime,this.count++}reset(){this.startTime=performance.now(),this.elapsed=0,this.count=0}};var Ei={},le=class{constructor(){}static startTime(e){let t=Ei[e];t||(t=new As(e),Ei[e]=t),t.startTimer()}static endTime(e){let t=Ei[e];if(!t){console.log("PerformanceMetrics: failed to find: "+e);return}t.endTimer()}static getKeys(){return Object.keys(Ei)}static getPerformanceTrack(e){return Ei[e]}static reset(){for(let[e]of Object.entries(Ei)){let t=Ei[e];t&&t.reset()}}};var Ps=class{constructor(){this.movementVector=new b(0,0),this.position=new b(0,0),this.nearZero=.001}findPath(e,t,i){if(!t||!i)return!1;if(t===i)return e.push(i),!0;if(t.isNeighborTile(i))return e.push(t),e.push(i),!0;this.position.copy(t.origin);let r=t;e.push(r);let s=n.tile.halfSize;this.movementVector.copy(i.origin),this.movementVector.subtract(this.position);let o=Z.len(this.movementVector);if(Math.abs(o)<this.nearZero)return!0;let a=t.getWorldGrid(),h=0;this.movementVector.scale(s/o);let m=!1;do if(this.position.add(this.movementVector),h+=s,!r.contains(this.position)){let p=r.getNeighbor(this.position);if(!p&&(console.log("DirectLinePathFinder.findPath() stepped to non-neighbor tile somehow!"),p=a.findGridTile(this.position),!p))return!1;if(r=p,e.push(r),r===i){m=!0;break}}while(h<o&&r!==i);return m||e.push(i),this.fixDiagonalSteps(e),!0}fixDiagonalSteps(e){for(let t=1;t<e.length;t++){let i=e[t-1],r=e[t];if(!r.isNeighborTile(i)){let s=i.getNeighborLeft(),o=i.getNeighborRight(),a=i.getNeighborTop(),h=i.getNeighborBottom();r===i.getNeighborBottomLeft()?h.open?e.splice(t,0,h):e.splice(t,0,s):r===i.getNeighborBottomRight()?h.open?e.splice(t,0,h):e.splice(t,0,o):r===i.getNeighborTopLeft()?a.open?e.splice(t,0,a):e.splice(t,0,s):r===i.getNeighborTopRight()?a.open?e.splice(t,0,a):e.splice(t,0,o):(console.log("DirectLinePathFinder.fixDiagonalSteps() tiles are not adjacent"),console.log("i="+t+" curr="+t+" "+r.origin.toString()+" prev="+i.origin.toString()+" adjacent="+r.isAdjacentTo(i)+" neighbor="+r.isNeighborTile(i)))}}}};var Rs=class{constructor(){this.queue=[]}add(e,t){let i=e.pathData.getScore(t);for(let r=0;r<this.queue.length;r++)if(i<=this.queue[r].pathData.getScore(t)){this.queue.splice(r,0,e);return}this.queue.push(e)}poll(){return this.queue.shift()}isEmpty(){return this.queue.length===0}clear(){this.queue.length=0}};var Ms=class{constructor(){this.openAirTileCost=n.tile.size*15,this.closedTileCost=n.tile.size*155,this.gravityDiscount=n.tile.halfSize,this.maxPathDistance=n.tile.size*80,this.openList=new Rs,this.pathNumber=0,this.diagonalSize=Math.sqrt(n.tile.size*n.tile.size+n.tile.size*n.tile.size)|0}findPathSpecialCases(e,t,i,r){if(t===i)return r&&e.push(i),!0;if(t.isNeighborTile(i))return r&&(e.push(t),e.push(i)),!0;let s=Z.dist(t.origin,i.origin);return s>this.maxPathDistance?(console.log("Path too long: "+s/n.tile.size+" max: "+this.maxPathDistance/n.tile.size),!0):!1}findPath(e,t,i,r,s,o){if(e.length>0&&(e.length=0),!t||!i){console.log("findPath() null start/end");return}if(this.findPathSpecialCases(e,t,i,r))return;this.pathNumber++,this.openList.clear(),t.pathData.setCost(0,this.pathNumber),this.openList.add(t),t.pathData.setInOpenList(!0,this.pathNumber);let a;for(;!this.openList.isEmpty()&&(a=this.openList.poll(),!!a);)if(a.pathData.setInOpenList(!1,this.pathNumber),a===i){this.constructPath(e,i,r);break}else{a.pathData.setClosed(!0,this.pathNumber);let h=a.pathData.getCost(this.pathNumber),m=a.getNeighborBottom(),p=!m||m.isTraversable(),f=a.getNeighbors();for(let N=0;N<f.length;N++){let T=f[N];if(!T||T.pathData.isClosed(this.pathNumber))continue;let C=0;p&&(N===1?C-=this.gravityDiscount:C+=this.openAirTileCost),!T.open&&s&&!o&&(C+=this.closedTileCost);let w=h+this.distanceBetween(a,T)+C,E=T.pathData.isInOpenList(this.pathNumber);if(E&&w>=T.pathData.getCost(this.pathNumber))continue;let P=w+this.calculateHeuristicCostEstimate(T,i);T.pathData.set(a,w,P,this.pathNumber),E||(this.openList.add(T,this.pathNumber),T.pathData.setInOpenList(!0,this.pathNumber))}}}calculateHeuristicCostEstimate(e,t){return Z.dist(e.getOrigin(),t.getOrigin())|0}distanceBetween(e,t){let i=e.getOrigin(),r=t.getOrigin();return i.x==r.x?n.tile.size:i.y==r.y?n.tile.size:this.diagonalSize}constructPath(e,t,i){let r;if(i)r=t;else if(r=t.pathData.getCameFrom(this.pathNumber),r==null)return;do e.unshift(r),r=r.pathData.getCameFrom(this.pathNumber);while(r!=null)}};var K={IGNORE:-10,OPEN:-9,OPEN_OR_PATH:-11,CLOSED:-8,START:0,END:1e3,PATH:2e3};var oe=class{constructor(e,t){this.startCol=0,this.startRow=0,this.endCol=0,this.endRow=0,this.startColFlipped=0,this.startRowFlipped=0,this.endColFlipped=0,this.endRowFlipped=0,this.pathCount=0,this.pattern=this.convertPattern(e),this.flippedPattern=t?this.convertFlippedPattern(e):null}getMinRequiredPathSteps(){}getPlanIfMatch(e,t,i,r,s){return this.isMatch(i,r,s,this.pattern,this.startCol,this.startRow,this.endCol,this.endRow)?this.getPathPlan(e,t):this.flippedPattern&&this.isMatch(i,r,s,this.flippedPattern,this.startColFlipped,this.startRowFlipped,this.endColFlipped,this.endRowFlipped)?this.getPathPlanFlipped(e,t):null}getPathPlan(e,t){}getPathPlanFlipped(e,t){}isMatch(e,t,i,r,s,o,a,h){if(i.length===0)return!1;let m=e-s,p=t-o;if(m<0||p<0)return!1;let f=i[e][t];if(f<0)return!1;let N=e+(a-s),T=t+(h-o);if(N>=i.length)return!1;let C=i[N];if(T>=C.length||C[T]<f)return!1;for(let E=0;E<r.length;E++){let P=r[E];for(let S=0;S<P.length;S++){let A=P[S];if(A===K.IGNORE||A===K.START||A===K.END)continue;let _=m+E,L=p+S;if(_>=i.length)return!1;let W=i[_];if(L>=W.length)return!1;let x=W[L];if(A===K.OPEN_OR_PATH){if(x===K.OPEN||x>0)continue;return!1}else if(A===K.OPEN){if(x===K.OPEN)continue;return!1}else if(A===K.CLOSED){if(x===K.CLOSED)continue;return!1}else if(A===K.PATH){if(x<0)return!1}else return!1}}return!0}convertPattern(e){if(!e||e.length===0)return console.log("PathTemplatePattern.convertPattern() Invalid empty string pattern"),[];let t=e[0].length,i=e.length,r=new Array(t);for(let s=0;s<t;s++){let o=new Array(i);o.fill(K.IGNORE),r[s]=o}for(let s=0;s<i;s++){let o=e[s];for(let a=0;a<t;a++){let h=o.charAt(a),m=this.convertPatternChar(h);m===K.START?(this.startCol=a,this.startRow=s):m===K.END?(this.endCol=a,this.endRow=s):m===K.PATH&&this.pathCount++,r[a][s]=m}}return r}convertFlippedPattern(e){if(!e||e.length===0)return console.log("PathTemplatePattern.convertPattern() Invalid empty string pattern"),[];let t=e[0].length,i=e.length,r=new Array(t);for(let s=0;s<t;s++){let o=new Array(i);o.fill(K.IGNORE),r[s]=o}for(let s=0;s<i;s++){let o=e[s],a=0;for(let h=t-1;h>=0;h--){let m=o.charAt(h),p=this.convertPatternChar(m);p===K.START?(this.startColFlipped=a,this.startRowFlipped=s):p===K.END&&(this.endColFlipped=a,this.endRowFlipped=s),r[a][s]=p,a++}}return r}convertPatternChar(e){switch(e){case"S":return K.START;case"E":return K.END;case"P":return K.PATH;case"X":return K.CLOSED;case"O":return K.OPEN;case"8":return K.OPEN_OR_PATH;case".":return K.IGNORE}return console.log("PathTemplatePattern.convertPatternChar() Invalid char: "+e),K.IGNORE}findTilePathIndex(e,t,i,r){for(let s=t;s<e.length;s++){let o=e[s];if(!(o.getTileCol()!==i||o.getTileRow()!=r))return s}return console.log("PathTemplatePattern.findTilePathIndex() failed to find tile in path."),-1}printPattern(e){if(e.length===0){console("printPattern() template empty");return}let t=e[0].length;for(let i=0;i<t;i++){let r="";for(let s=0;s<e.length;s++){let o=e[s][i];o===K.IGNORE?r+=".":o===K.PATH?r+="P":o===K.OPEN?r+="0":o===K.OPEN_OR_PATH?r+="8":o===K.CLOSED?r+="X":o===K.START?r+="S":o===K.END?r+="E":r+="?"}console.log(r)}}toString(){}};var _s=class{constructor(){this.template=this.initializeTemplate(30,30),this.startColIndex=0,this.startRowIndex=0}updateTemplate(e){this.buildTemplate(e)}getPlanIfPatternMatch(e,t,i){let r=t[i],s=r.getTileCol(),o=r.getTileRow(),a=t[0],h=a.getTileCol(),m=a.getTileRow(),p=this.startColIndex+(s-h),f=this.startRowIndex+(o-m);return e.getPlanIfMatch(t,i,p,f,this.template)}buildTemplate(e){if(e.length<2)return;let t=e[0],i=t.getTileCol(),r=i,s=t.getTileRow(),o=s;for(let T=1;T<e.length;T++){let C=e[T],w=C.getTileCol(),E=C.getTileRow();i=Math.min(i,w),r=Math.max(r,w),s=Math.min(s,E),o=Math.max(o,E)}i--,s--,r+=2,o+=2;let a=r-i,h=o-s;this.growAndClearTemplate(a,h);let m=e[0];this.startColIndex=m.getTileCol()-i,this.startRowIndex=m.getTileRow()-s;let p=this.startColIndex,f=this.startRowIndex;this.populateTileAndNeighbors(m,p,f,0);let N=m;for(let T=1;T<e.length;T++){let C=e[T];p+=C.getTileCol()-N.getTileCol(),f+=C.getTileRow()-N.getTileRow(),this.populateTileAndNeighbors(C,p,f,T),N=C}}initializeTemplate(e,t){let i=new Array(e);for(let r=0;r<e;r++){let s=new Array(t);s.fill(K.IGNORE),i[r]=s}return i}growAndClearTemplate(e,t){let i=this.template.length,r=this.template[0].length,s=!1;if(r<t){for(let o=0;o<this.template.length;o++){let a=this.template[o],h=a.length;a.length=t;for(let m=h;m<t;m++)a[m]=K.IGNORE}s=!0}if(i<e){this.template.length=e;let o=Math.max(r,t);for(let a=i;a<e;a++){let h=new Array(o);for(let m=0;m<o;m++)h[m]=K.IGNORE;this.template[a]=h}s=!0}for(let o=0;o<this.template.length;o++)this.template[o].fill(K.IGNORE);s&&console.log("PathTemplate grew. ["+this.template.length+"]["+this.template[0].length+"]")}populateTileAndNeighbors(e,t,i,r){if(e.open?this.template[t][i]=r:this.template[t][i]=K.CLOSED,this.template[t][i-1]===K.IGNORE){let s=e.getNeighborTop();s&&(this.template[t][i-1]=s.open?K.OPEN:K.CLOSED)}if(this.template[t][i+1]===K.IGNORE){let s=e.getNeighborBottom();s&&(this.template[t][i+1]=s.open?K.OPEN:K.CLOSED)}if(this.template[t-1][i]===K.IGNORE){let s=e.getNeighborLeft();s&&(this.template[t-1][i]=s.open?K.OPEN:K.CLOSED)}if(this.template[t+1][i]===K.IGNORE){let s=e.getNeighborRight();s&&(this.template[t+1][i]=s.open?K.OPEN:K.CLOSED)}if(this.template[t-1][i-1]===K.IGNORE){let s=e.getNeighborTopLeft();s&&(this.template[t-1][i-1]=s.open?K.OPEN:K.CLOSED)}if(this.template[t+1][i-1]===K.IGNORE){let s=e.getNeighborTopRight();s&&(this.template[t+1][i-1]=s.open?K.OPEN:K.CLOSED)}if(this.template[t-1][i-1]===K.IGNORE){let s=e.getNeighborBottomLeft();s&&(this.template[t-1][i-1]=s.open?K.OPEN:K.CLOSED)}if(this.template[t+1][i-1]===K.IGNORE){let s=e.getNeighborBottomRight();s&&(this.template[t+1][i-1]=s.open?K.OPEN:K.CLOSED)}}};var Ls=class extends be{constructor(e,t,i){super(e,t,i),this.landCoordinate=new b}executePlan(e,t,i){let s=this.startTile.origin.x+n.tile.size+n.character.halfWidth;return e.position.worldCoordinateCenter.x<s?(this.walkRightToCenterX(e,t,s),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x<this.endTile.origin.x||e.position.worldCoordinateOrigin.y<this.endTile.origin.y?(this.fallDownAndRight(e,t,this.landCoordinate),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"FallDownRight("+this.pathSteps+")"}};var ys=class extends be{constructor(e,t,i){super(e,t,i),this.landCoordinate=new b(0,0)}executePlan(e,t,i){let s=this.startTile.origin.x-n.character.halfWidth;return e.position.worldCoordinateCenter.x>s?(this.walkLeftToCenterX(e,t,s),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x>this.landCoordinate.x||e.position.worldCoordinateOrigin.y<this.endTile.origin.y?(this.fallDownAndLeft(e,t,this.landCoordinate),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"FallDownLeft("+this.pathSteps+")"}};var bs=class extends oe{constructor(){super(["S8","X8",".E"],!0)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e[t],r=i.getTileCol()+1,s=i.getTileRow()+2,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e[o],h=o-t;return new Ls(i,a,h)}getPathPlanFlipped(e,t){let i=e[t],r=i.getTileCol()-1,s=i.getTileRow()+2,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e[o],h=o-t;return new ys(i,a,h)}toString(){return"PatternFallDown2Side1"}};var wt=class extends be{constructor(e,t,i){super(e,t,i),this.jumpCoordinate=new b(0,0),this.landCoordinate=new b(0,0)}executePlan(e,t,i){this.jumpCoordinate.copy(this.startTile.origin),this.jumpCoordinate.subtractXY(n.character.halfWidth,0);let r=this.jumpCoordinate.x;return e.position.worldCoordinateCenter.x>r?(this.walkLeftToCenterX(e,t,r),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x>this.landCoordinate.x||e.position.worldCoordinateOrigin.y<this.endTile.origin.y?(this.jumpDownAndLeft(e,t,this.jumpCoordinate,this.landCoordinate),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"JumpDownLeft("+this.pathSteps+")"}};var Ct=class extends be{constructor(e,t,i){super(e,t,i),this.jumpCoordinate=new b(0,0),this.landCoordinate=new b(0,0)}executePlan(e,t,i){this.jumpCoordinate.copy(this.startTile.origin),this.jumpCoordinate.addXY(n.tile.size+n.character.halfWidth,0);let r=this.jumpCoordinate.x;return e.position.worldCoordinateCenter.x<r?(this.walkRightToCenterX(e,t,r),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x<this.landCoordinate.x||e.position.worldCoordinateOrigin.y<this.endTile.origin.y?(this.jumpDownAndRight(e,t,this.jumpCoordinate,this.landCoordinate),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"JumpDownRight("+this.pathSteps+")"}};var Is=class extends oe{constructor(){super([".O.","S88","X8E"],!0)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e[t],r=i.getTileCol()+2,s=i.getTileRow()+1,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e[o],h=o-t;return new Ct(i,a,h)}getPathPlanFlipped(e,t){let i=e[t],r=i.getTileCol()-2,s=i.getTileRow()+1,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e[o],h=o-t;return new wt(i,a,h)}toString(){return"PatternJumpDown1Side2"}};var vs=class extends oe{constructor(){super([".OO.","S888","X88E"],!0)}getMinRequiredPathSteps(){return 4}getPathPlan(e,t){let i=e[t],r=i.getTileCol()+3,s=i.getTileRow()+1,o=this.findTilePathIndex(e,t+4,r,s);if(o<0)return null;let a=e[o],h=o-t;return new Ct(i,a,h)}getPathPlanFlipped(e,t){let i=e[t],r=i.getTileCol()-3,s=i.getTileRow()+1,o=this.findTilePathIndex(e,t+4,r,s);if(o<0)return null;let a=e[o],h=o-t;return new wt(i,a,h)}toString(){return"PatternJumpDown1Side3"}};var xs=class extends oe{constructor(){super([".OO..","S8888","X.88E"],!0)}getMinRequiredPathSteps(){return 5}getPathPlan(e,t){let i=e[t],r=i.getTileCol()+4,s=i.getTileRow()+1,o=this.findTilePathIndex(e,t+5,r,s);if(o<0)return null;let a=e[o],h=o-t;return new Ct(i,a,h)}getPathPlanFlipped(e,t){let i=e[t],r=i.getTileCol()-4,s=i.getTileRow()+1,o=this.findTilePathIndex(e,t+5,r,s);if(o<0)return null;let a=e[o],h=o-t;return new wt(i,a,h)}toString(){return"PatternJumpDown1Side4"}};var Bt=class extends be{constructor(e,t,i,r){super(e,t,i),this.jumpCoordinate=new b(0,0),this.landCoordinate=new b(0,0),this.jumpHeight=r}executePlan(e,t,i){this.jumpCoordinate.copy(this.startTile.origin),this.jumpCoordinate.subtractXY(n.character.halfWidth,0);let r=this.jumpCoordinate.x;return e.position.worldCoordinateCenter.x>r?(this.walkLeftToCenterX(e,t,r),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x>this.landCoordinate.x||e.position.worldCoordinateOrigin.y<this.endTile.origin.y?(this.jumpLeft(e,t,this.jumpCoordinate,this.landCoordinate,this.jumpHeight),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"JumpLeft("+this.pathSteps+")"}};var kt=class extends be{constructor(e,t,i,r){super(e,t,i),this.jumpCoordinate=new b(0,0),this.landCoordinate=new b(0,0),this.jumpHeight=r}executePlan(e,t,i){this.jumpCoordinate.copy(this.startTile.origin),this.jumpCoordinate.addXY(n.tile.size+n.character.halfWidth,0);let r=this.jumpCoordinate.x;return e.position.worldCoordinateCenter.x<r?(this.walkRightToCenterX(e,t,r),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x<this.landCoordinate.x||e.position.worldCoordinateOrigin.y<this.endTile.origin.y?(this.jumpRight(e,t,this.jumpCoordinate,this.landCoordinate,this.jumpHeight),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"JumpRight("+this.pathSteps+")"}};var Ds=class extends oe{constructor(){super([".O.","S8E","X8."],!0)}getMinRequiredPathSteps(){return 2}getPathPlan(e,t){let i=e[t],r=i.getTileCol()+2,s=i.getTileRow(),o=this.findTilePathIndex(e,t+2,r,s);if(o<0)return console.log("PathTemplatePatternJumpSide2() getPathPlan() failed to find end tile"),null;let a=e[o],h=o-t;return new kt(i,a,h,n.tile.halfSize)}getPathPlanFlipped(e,t){let i=e[t],r=i.getTileCol()-2,s=i.getTileRow(),o=this.findTilePathIndex(e,t+2,r,s);if(o<0)return null;let a=e[o],h=o-t;return new Bt(i,a,h,n.tile.halfSize)}toString(){return"PatternJump0Side2"}};var Os=class extends oe{constructor(){super([".OO.","S88E","X88."],!0)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e[t],r=i.getTileCol()+3,s=i.getTileRow(),o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e[o],h=o-t;return new kt(i,a,h,n.tile.threeQuarterSize)}getPathPlanFlipped(e,t){let i=e[t],r=i.getTileCol()-3,s=i.getTileRow(),o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e[o],h=o-t;return new Bt(i,a,h,n.tile.threeQuarterSize)}toString(){return"PatternJump0Side3"}};var Bs=class extends oe{constructor(){super([".OOO.","S8.8E","X8.8."],!0)}getMinRequiredPathSteps(){return 4}getPathPlan(e,t){let i=e[t],r=i.getTileCol()+4,s=i.getTileRow(),o=this.findTilePathIndex(e,t+4,r,s);if(o<0)return console.log("PatternJump0Side4 getPathPlan failed to find end index"),null;let a=e[o],h=o-t;return new kt(i,a,h,n.tile.size)}getPathPlanFlipped(e,t){let i=e[t],r=i.getTileCol()-4,s=i.getTileRow(),o=this.findTilePathIndex(e,t+4,r,s);if(o<0)return console.log("PatternJump0Side4 getPathPlanFlipped failed to find end index"),null;let a=e[o],h=o-t;return new Bt(i,a,h,n.tile.size)}toString(){return"PatternJump0Side4"}};var Je=class extends be{constructor(e,t,i){super(e,t,i),this.jumpCoordinate=new b(0,0),this.landCoordinate=new b(0,0)}executePlan(e,t,i){this.jumpCoordinate.copy(this.startTile.origin),this.jumpCoordinate.addXY(n.tile.halfSize,0);let r=this.jumpCoordinate.x;return e.position.worldCoordinateCenter.x>r?(this.walkLeftToCenterX(e,t,r),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x>this.landCoordinate.x?(this.jumpUpAndLeft(e,t,this.jumpCoordinate,this.landCoordinate),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"JumpUpLeft("+this.pathSteps+")"}};var Qe=class extends be{constructor(e,t,i){super(e,t,i),this.jumpCoordinate=new b(0,0),this.landCoordinate=new b(0,0)}executePlan(e,t,i){this.jumpCoordinate.copy(this.startTile.origin),this.jumpCoordinate.addXY(n.tile.halfSize,0);let r=this.jumpCoordinate.x;return e.position.worldCoordinateCenter.x<r?(this.walkRightToCenterX(e,t,r),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x<this.landCoordinate.x?(this.jumpUpAndRight(e,t,this.jumpCoordinate,this.landCoordinate),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"JumpUpRight("+this.pathSteps+")"}};var ks=class extends oe{constructor(){super(["88E","SX."],!0)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e[t],r=i.getTileCol()+2,s=i.getTileRow()-1,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e[o],h=o-t;return new Qe(i,a,h)}getPathPlanFlipped(e,t){let i=e[t],r=i.getTileCol()-2,s=i.getTileRow()-1,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e[o],h=o-t;return new Je(i,a,h)}toString(){return"PatternJumpUp1Side2"}};var Fs=class extends oe{constructor(){super(["888E","S8X."],!0)}getMinRequiredPathSteps(){return 4}getPathPlan(e,t){let i=e[t],r=i.getTileCol()+3,s=i.getTileRow()-1,o=this.findTilePathIndex(e,t+4,r,s);if(o<0)return null;let a=e[o],h=o-t;return new Qe(i,a,h)}getPathPlanFlipped(e,t){let i=e[t],r=i.getTileCol()-3,s=i.getTileRow()-1,o=this.findTilePathIndex(e,t+4,r,s);if(o<0)return null;let a=e[o],h=o-t;return new Je(i,a,h)}toString(){return"PatternJumpUp1Side3"}};var St=class extends be{constructor(e,t,i){super(e,t,i)}executePlan(e,t,i){let r=this.endTile.origin.x+n.tile.halfSize,s=this.walkLeftToCenterX(e,t,r);return s&&this.assertEndTileReached(e,this.endTile),s}toString(){return"WalkLeft("+this.pathSteps+")"}};var Nt=class extends be{constructor(e,t,i){super(e,t,i)}executePlan(e,t,i){let r=this.endTile.origin.x+n.tile.halfSize,s=this.walkRightToCenterX(e,t,r);return s&&this.assertEndTileReached(e,this.endTile),s}toString(){return"WalkRight("+this.pathSteps+")"}};var Gs=class extends oe{constructor(){super(["SPE","XXX"],!0)}getMinRequiredPathSteps(){return 2}getPathPlan(e,t){let i=e[t],r=e[t+2];return new Nt(i,r,2)}getPathPlanFlipped(e,t){let i=e[t],r=e[t+2];return new St(i,r,2)}toString(){return"PatternWalkSide2"}};var Vs=class extends oe{constructor(){super(["SPPPE","XXXXX"],!0)}getMinRequiredPathSteps(){return 4}getPathPlan(e,t){let i=e[t],r=e[t+4];return new Nt(i,r,4)}getPathPlanFlipped(e,t){let i=e[t],r=e[t+4];return new St(i,r,4)}toString(){return"PatternWalkSide4"}};var st=class extends be{constructor(e,t,i){super(e,t,i)}executePlan(e,t,i){let r=this.fallDown(e,t,this.endTile);return r&&this.assertEndTileReached(e,this.endTile),r}isSolidFloorRequiredAtStart(){return!1}toString(){return"FallDown("+this.pathSteps+")"}};var ot=class extends be{constructor(e,t,i){super(e,t,i)}executePlan(e,t,i){let r=this.jumpUp(e,t,this.endTile);return r&&this.assertEndTileReached(e,this.endTile),r}toString(){return"JumpUp("+this.pathSteps+")"}};var Us=class extends oe{constructor(){super(["8E","S."],!0)}getMinRequiredPathSteps(){return 2}getPathPlan(e,t){let i=e[t],r=i.getTileCol()+1,s=i.getTileRow()-1,o=this.findTilePathIndex(e,t+2,r,s);if(o<0)return null;let a=e[o],h=o-t;return new Qe(i,a,h)}getPathPlanFlipped(e,t){let i=e[t],r=i.getTileCol()-1,s=i.getTileRow()-1,o=this.findTilePathIndex(e,t+2,r,s);if(o<0)return null;let a=e[o],h=o-t;return new Je(i,a,h)}toString(){return"PatternJumpUp1Side1"}};var Hs=class extends oe{constructor(){super([".88E","888X","S8.."],!0)}getMinRequiredPathSteps(){return 5}getPathPlan(e,t){let i=e[t],r=i.getTileCol()+3,s=i.getTileRow()-2,o=this.findTilePathIndex(e,t+5,r,s);if(o<0)return null;let a=e[o],h=o-t;return new Qe(i,a,h)}getPathPlanFlipped(e,t){let i=e[t],r=i.getTileCol()-3,s=i.getTileRow()-2,o=this.findTilePathIndex(e,t+5,r,s);if(o<0)return null;let a=e[o],h=o-t;return new Je(i,a,h)}toString(){return"PatternJumpUp2Side3"}};var zs=class extends oe{constructor(){super([".8E","88.","S.."],!0)}getMinRequiredPathSteps(){return 4}getPathPlan(e,t){let i=e[t],r=i.getTileCol()+2,s=i.getTileRow()-2,o=this.findTilePathIndex(e,t+4,r,s);if(o<0)return null;let a=e[o],h=o-t;return new Qe(i,a,h)}getPathPlanFlipped(e,t){let i=e[t],r=i.getTileCol()-2,s=i.getTileRow()-2,o=this.findTilePathIndex(e,t+4,r,s);if(o<0)return null;let a=e[o],h=o-t;return new Je(i,a,h)}toString(){return"PatternJumpUp2Side2"}};var Ws=class extends oe{constructor(){super(["8E","8.","S."],!0)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e[t],r=i.getTileCol()+1,s=i.getTileRow()-2,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e[o],h=o-t;return new Qe(i,a,h)}getPathPlanFlipped(e,t){let i=e[t],r=i.getTileCol()-1,s=i.getTileRow()-2,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e[o],h=o-t;return new Je(i,a,h)}toString(){return"PatternJumpUp2Side1"}};var Ys=class extends oe{constructor(){super([".OO.","S888","X.88","...E","...X"],!0)}getMinRequiredPathSteps(){return 5}getPathPlan(e,t){let i=e[t],r=i.getTileCol()+3,s=i.getTileRow()+2,o=this.findTilePathIndex(e,t+5,r,s);if(o<0)return null;let a=e[o],h=o-t;return new Ct(i,a,h)}getPathPlanFlipped(e,t){let i=e[t],r=i.getTileCol()-3,s=i.getTileRow()+2,o=this.findTilePathIndex(e,t+5,r,s);if(o<0)return null;let a=e[o],h=o-t;return new wt(i,a,h)}toString(){return"PatternJumpDown2Side3"}};var Ks=class extends oe{constructor(){super(["E","8","S"],!1)}getMinRequiredPathSteps(){return 2}getPathPlan(e,t){let i=e[t],r=i.getTileCol(),s=i.getTileRow()-2,o=this.findTilePathIndex(e,t+2,r,s);if(o<0)return null;let a=e[o],h=o-t;return new ot(i,a,h)}getPathPlanFlipped(e,t){let i=e[t],r=i.getTileCol(),s=i.getTileRow()-2,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e[o],h=o-t;return new ot(i,a,h)}toString(){return"PatternJumpUp2"}};var Xs=class extends oe{constructor(){super(["E","8","8","S"],!1)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e[t],r=i.getTileCol(),s=i.getTileRow()-3,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e[o],h=o-t;return new ot(i,a,h)}getPathPlanFlipped(e,t){let i=e[t],r=i.getTileCol(),s=i.getTileRow()-3,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e[o],h=o-t;return new ot(i,a,h)}toString(){return"PatternJumpUp3"}};var js=class extends oe{constructor(){super(["S","8","E"],!1)}getMinRequiredPathSteps(){return 2}getPathPlan(e,t){let i=e[t],r=i.getTileCol(),s=i.getTileRow()+2,o=this.findTilePathIndex(e,t+2,r,s);if(o<0)return null;let a=e[o],h=o-t;return new st(i,a,h)}getPathPlanFlipped(e,t){let i=e[t],r=i.getTileCol(),s=i.getTileRow()+2,o=this.findTilePathIndex(e,t+2,r,s);if(o<0)return null;let a=e[o],h=o-t;return new st(i,a,h)}toString(){return"PatternFallDown2"}};var Zs=class extends oe{constructor(){super(["S","8","8","E"],!1)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e[t],r=i.getTileCol(),s=i.getTileRow()+3,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e[o],h=o-t;return new st(i,a,h)}getPathPlanFlipped(e,t){let i=e[t],r=i.getTileCol(),s=i.getTileRow()+3,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e[o],h=o-t;return new st(i,a,h)}toString(){return"PatternFallDown3"}};var qs=class extends St{constructor(e,t,i,r){super(e,t,i),this.tileMinedLogic=r,this.miningThisTurn=!1}executePlan(e,t,i){if(this.endTile.open){if(this.miningThisTurn)if(i)this.miningThisTurn=!1;else return!1}else return e.setCharacterAction(Q.MINE),this.miningThisTurn=!0,e.position.worldCoordinateOrigin.x!==this.endTile.origin.x&&(e.position.facingLeft=e.position.worldCoordinateOrigin.x>this.endTile.origin.x),i&&this.tileMinedLogic.mineTileForTurn(e,this.endTile),!1;return super.executePlan(e,t,i)}toString(){return"MineAndWalkLeft("+this.pathSteps+")"}};var Js=class extends Nt{constructor(e,t,i,r){super(e,t,i),this.tileMinedLogic=r,this.miningThisTurn=!1}executePlan(e,t,i){if(this.endTile.open){if(this.miningThisTurn)if(i)this.miningThisTurn=!1;else return!1}else return e.setCharacterAction(Q.MINE),this.miningThisTurn=!0,e.position.worldCoordinateOrigin.x!==this.endTile.origin.x&&(e.position.facingLeft=e.position.worldCoordinateOrigin.x>this.endTile.origin.x),i&&this.tileMinedLogic.mineTileForTurn(e,this.endTile),!1;return super.executePlan(e,t,i)}toString(){return"MineAndWalkRight("+this.pathSteps+")"}};var Qs=class extends ot{constructor(e,t,i,r){super(e,t,i),this.tileMinedLogic=r,this.miningThisTurn=!1}executePlan(e,t,i){if(this.endTile.open){if(this.miningThisTurn)if(i)this.miningThisTurn=!1;else return!1}else return e.setCharacterAction(Q.MINE),this.miningThisTurn=!0,e.position.worldCoordinateOrigin.x!==this.endTile.origin.x&&(e.position.facingLeft=e.position.worldCoordinateOrigin.x>this.endTile.origin.x),i&&this.tileMinedLogic.mineTileForTurn(e,this.endTile),!1;return super.executePlan(e,t,i)}toString(){return"MineAndJumpUp("+this.pathSteps+")"}};var $s=class extends st{constructor(e,t,i,r){super(e,t,i),this.tileMinedLogic=r,this.miningThisTurn=!1}executePlan(e,t,i){if(this.endTile.open){if(this.miningThisTurn)if(i)this.miningThisTurn=!1;else return!1}else return e.setCharacterAction(Q.MINE),this.miningThisTurn=!0,e.position.worldCoordinateOrigin.x!==this.endTile.origin.x&&(e.position.facingLeft=e.position.worldCoordinateOrigin.x>this.endTile.origin.x),i&&this.tileMinedLogic.mineTileForTurn(e,this.endTile),!1;return super.executePlan(e,t,i)}toString(){return"MineAndFallDown("+this.pathSteps+")"}};var eo=class{constructor(e){this.tileMinedLogic=e,this.pathTemplate=new _s,this.patterns=[new Bs,new xs,new Hs,new Ys,new Os,new Fs,new vs,new zs,new Xs,new Zs,new Ds,new Ws,new ks,new Is,new Us,new Ks,new js,new bs,new Vs,new Gs],this.claimedPath=new Array(30),this.claimedPath.fill(null)}evaluatePath(e,t){if(t.length=0,e.length===0)return;if(e.length>this.claimedPath.length&&(this.claimedPath.length=e.length),this.claimedPath.fill(null),e.length<3)for(let r=0;r<e.length-1;r++)this.addDefaultPlan(e,r,this.claimedPath);else{this.pathTemplate.updateTemplate(e);for(let r=0;r<e.length-1;r++)this.addMinePlan(e,r,this.claimedPath);for(let r=0;r<this.patterns.length;r++)this.checkPatternAgainstPath(this.patterns[r],e,this.claimedPath);for(let r=0;r<e.length-1;r++)this.claimedPath[r]||this.addDefaultPlan(e,r,this.claimedPath)}let i=null;for(let r=0;r<e.length;r++){let s=this.claimedPath[r];s&&s!==i&&t.push(s),i=s}}checkPatternAgainstPath(e,t,i){let r=0;for(;r<t.length;){if(i[r]){r++;continue}let s=this.getUnclaimedSpaceAvailable(i,t.length,r);if(s<e.getMinRequiredPathSteps()){r++;continue}let o=this.pathTemplate.getPlanIfPatternMatch(e,t,r);if(o){let a=o.pathSteps;if(a===0){console.log("PathPlanEvaluator.checkPatternAgainstPath() pattern="+e.toString()+" used no steps"),r++;continue}if(a<=s){for(let h=0;h<a;h++)i[r]=o,r++;continue}}r++}}getUnclaimedSpaceAvailable(e,t,i){let r=0;for(let s=i;s<t;s++){if(e[s]!==null)return r;r++}return r}addDefaultPlan(e,t,i){let r=e[t],s=e[t+1];if(!s.open){this.addMinePlan(e,t,i);return}let o;if(r.isNeighborLeft(s))o=new St(r,s,1);else if(r.isNeighborRight(s))o=new Nt(r,s,1);else if(r.isNeighborTop(s))o=new ot(r,s,1);else if(r.isNeighborBottom(s))o=new st(r,s,1);else{console.log("addDefaultPlan() neighbor is not adjacent tile"),this.printPathDebug(e,t);return}i[t]=o}printPathDebug(e,t){console.log("DEBUG BAD INDEX: "+t);for(let i=0;i<e.length;i++)i==0?console.log("DEBUG step="+i+" "+e[i].origin.toString()):console.log("DEBUG step="+i+" "+e[i].origin.toString()+" adjacent="+e[i].isAdjacentTo(e[i-1])+" neighbor="+e[i].isNeighborTile(e[i-1])+(i===t?" <-----":""))}addMinePlan(e,t,i){let r=e[t+1];if(r.open)return;let s=e[t],o;if(s.isNeighborLeft(r))o=new qs(s,r,1,this.tileMinedLogic);else if(s.isNeighborRight(r))o=new Js(s,r,1,this.tileMinedLogic);else if(s.isNeighborTop(r))o=new Qs(s,r,1,this.tileMinedLogic);else if(s.isNeighborBottom(r))o=new $s(s,r,1,this.tileMinedLogic);else{console.log("addMinePlan() neighbor is not adjacent tile");return}i[t]=o}};var to=class extends z{constructor(e,t){super(),this.vectorField=e,this.pathFinder=new Ms,this.directLinePathFinder=new Ps,this.pathPlanEvaluator=new eo(t),this.path=[]}findPathPlan(e,t,i,r,s){this.path.length=0,le.startTime("PathFinding"),this.pathFinder.findPath(this.path,e,t,!0,r,s),le.endTime("PathFinding"),this.path.length>0?this.pathPlanEvaluator.evaluatePath(this.path,i):i.length=0}findDirectPathPlan(e,t,i){this.path.length=0,le.startTime("DirectPath");let r=this.directLinePathFinder.findPath(this.path,e,t);return le.endTime("DirectPath"),r?(this.path.length>0?this.pathPlanEvaluator.evaluatePath(this.path,i):i.length=0,!0):!1}findMonsterPathPlan(e,t,i){this.findPathPlan(e,t,i,!0,!1)}findPartyCharacterPathPlan(e,t,i){if(e===t){console.log("findPartyCharacterPathPlan() start == destination."),i.length=0;return}this.vectorField.tileHealthNegligible&&this.findDirectPathPlan(e,t,i)||this.findPathPlan(e,t,i,!0,this.vectorField.tileHealthNegligible)}resetFull(){this.path.length=0}resetForPrestige(){this.resetFull()}};var wi=class extends ai{constructor(){super()}performAction(e,t,i){let r=e.position;r.pathPlan.length>0&&e.followPathPlan(t,i),r.pathPlan.length===0&&(e.position.resetPathPlan(),e.turnAction=null)}isMovementAction(){return!0}toString(){return"MoveTurnAction"}};var io=class extends Vr{constructor(e,t,i){super(e),this.pathPlanFinder=t,this.moveTurnAction=i}applyIfAppropriate(e){let t=e.position;if(t.pathPlan.length===0&&(Date.now()-e.pathCompletedTime<3e3||Math.random()<.75))return!1;let i=t.tile;if(!i)return!1;let r=e.target;if(t.pathPlan.length===0){let s=this.chooseRandomNeighborTile(i);if(!s)return!1;r.setTargetTile(s,null,this.behaviorId),this.pathPlanFinder.findMonsterPathPlan(e.position.tile,s,e.position.pathPlan)}if(r.behaviorId===this.behaviorId)return e.turnAction=this.moveTurnAction,!0}chooseRandomNeighborTile(e){let t=null,i=Math.random();if(i<.15){if(t=e.getNeighborLeft(),this.isGoodTargetTile(t)||(t=e.getNeighborRight(),this.isGoodTargetTile(t)))return t}else if(i<.3){if(t=e.getNeighborRight(),this.isGoodTargetTile(t)||(t=e.getNeighborLeft(),this.isGoodTargetTile(t)))return t}else if(i<.45){if(t=e.getNeighborTopLeft(),this.isGoodTargetTile(t)||(t=e.getNeighborTopRight(),this.isGoodTargetTile(t)))return t}else if(i<.6){if(t=e.getNeighborTopRight(),this.isGoodTargetTile(t)||(t=e.getNeighborTopLeft(),this.isGoodTargetTile(t)))return t}else if(i<.75){if(t=e.getNeighborBottomLeft(),this.isGoodTargetTile(t)||(t=e.getNeighborBottomRight(),this.isGoodTargetTile(t)))return t}else if(i<.9&&(t=e.getNeighborBottomRight(),this.isGoodTargetTile(t)||(t=e.getNeighborBottomLeft(),this.isGoodTargetTile(t))))return t;return null}isGoodTargetTile(e){if(!e||!e.isTraversable())return!1;let t=e.getNeighborBottom();return!(!t||t.isTraversable())}};var ro=class{constructor(e){this.moveTurnAction=new wi,this.monsterWanderBehavior=new io(1,e,this.moveTurnAction),this.brainById={},this.basicMonsterBrain=new Ur(Pe.BASIC,[this.monsterWanderBehavior]),this.brainById[this.basicMonsterBrain.id]=this.basicMonsterBrain}getBrainById(e){return this.brainById[e]}};var so=class extends z{constructor(e,t){super(),this.monsterSpritesheet=e,this.characterBrains=t,this.monsterCharacterCache=new zr,this.baseMonsterDamage=5,this.monsterDamageIncrease=.6,this.monsterDamageHundredFactor=.1,this.baseMonsterHealth=5,this.monsterHealthIncrease=.6,this.monsterHealthHundredFactor=.1}createMonsterAtTile(e,t){let i=this.createMonsterCharacter(e),r=t.origin;return i.position.setTileAndOriginPosition(t,r.x,r.y),i}createMonsterCharacter(e){let t=this.monsterSpritesheet.getSprite(e.spriteName);if(t==null)return console.log("CharacterCreator.createMonsterCharacter() Failed to find monster sprite: "+e.spriteName),null;let i=this.characterBrains.getBrainById(e.brainId);if(!i)return console.log("CharacterCreator.createMonsterCharacter() Failed to find monster brain id: "+e.brainId),null;let r=this.monsterCharacterCache.get();return r.set(i,t,e),r}resetFull(){this.monsterCharacterCache.resetCache()}resetForPrestige(){this.resetFull()}};var Ci=class{constructor(e){this.N=624,this.M=397,this.MATRIX_A=2567483615,this.UPPER_MASK=2147483648,this.LOWER_MASK=2147483647,this.randFactor=1/4294967296,this.mag01=[0,this.MATRIX_A],this.mt=new Array(this.N),this.mti=this.N+1,this.setSeed(e)}setSeed(e){this.mti=this.N+1,this.initGenRand2(e)}initGenRand2(e){for(this.mt[0]=e&4294967295,this.mti=1;this.mti<this.N;this.mti++)this.mt[this.mti]=1812433253*(this.mt[this.mti-1]^this.mt[this.mti-1]>>30)+this.mti,this.mt[this.mti]&=4294967295}genRandInt(){var e;if(this.mag01[0]=0,this.mag01[1]=this.MATRIX_A,this.mti>=this.N){var t;for(t=0;t<this.N-this.M;t++)e=this.mt[t]&this.UPPER_MASK|this.mt[t+1]&this.LOWER_MASK,this.mt[t]=this.mt[t+this.M]^e>>>1^this.mag01[e&1];for(;t<this.N-1;t++)e=this.mt[t]&this.UPPER_MASK|this.mt[t+1]&this.LOWER_MASK,this.mt[t]=this.mt[t+(this.M-this.N)]^e>>>1^this.mag01[e&1];e=this.mt[this.N-1]&this.UPPER_MASK|this.mt[0]&this.LOWER_MASK,this.mt[this.N-1]=this.mt[this.M-1]^e>>>1^this.mag01[e&1],this.mti=0}return e=this.mt[this.mti++],e^=e>>>11,e^=e<<7&2636928640,e^=e<<15&4022730752,e^=e>>>18,e>>>0}random(){return this.genRandInt()*this.randFactor}randomInt(e){return this.random()*e|0}};var Ke=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],wd=.5*(Math.sqrt(3)-1),oo=(3-Math.sqrt(3))/6,Cd=1/3,bt=1/6,no=class{constructor(e){this.perm=this.initializePerm(e)}initializePerm(e){let t=new Ci(e),i=new Array(256);for(let s=0;s<i.length;s++)i[s]=Math.floor(t.random()*256);let r=new Array(512);for(let s=0;s<r.length;s++)r[s]=i[s&255];return r}noise(e,t){let i=(e+t)*wd,r=Math.floor(e+i),s=Math.floor(t+i),o=(r+s)*oo,a=r-o,h=s-o,m=e-a,p=t-h,f,N;m>p?(f=1,N=0):(f=0,N=1);let T=m-f+oo,C=p-N+oo,w=m-1+2*oo,E=p-1+2*oo,P=r&255,S=s&255,A=this.perm[P+this.perm[S]]%12,_=this.perm[P+f+this.perm[S+N]]%12,L=this.perm[P+1+this.perm[S+1]]%12,W,x,J,ie=.5-m*m-p*p;ie<0?W=0:(ie*=ie,W=ie*ie*(Ke[A][0]*m+Ke[A][1]*p));let Y=.5-T*T-C*C;Y<0?x=0:(Y*=Y,x=Y*Y*(Ke[_][0]*T+Ke[_][1]*C));let X=.5-w*w-E*E;return X<0?J=0:(X*=X,J=X*X*(Ke[L][0]*w+Ke[L][1]*E)),70*(W+x+J)}noise3d(e,t,i){let r=(e+t+i)*Cd,s=Math.floor(e+r),o=Math.floor(t+r),a=Math.floor(i+r),h=(s+o+a)*bt,m=s-h,p=o-h,f=a-h,N=e-m,T=t-p,C=i-f,w,E,P,S,A,_;N>=T?T>=C?(w=1,E=0,P=0,S=1,A=1,_=0):N>=C?(w=1,E=0,P=0,S=1,A=0,_=1):(w=0,E=0,P=1,S=1,A=0,_=1):T<C?(w=0,E=0,P=1,S=0,A=1,_=1):N<C?(w=0,E=1,P=0,S=0,A=1,_=1):(w=0,E=1,P=0,S=1,A=1,_=0);let L=N-w+bt,W=T-E+bt,x=C-P+bt,J=N-S+2*bt,ie=T-A+2*bt,Y=C-_+2*bt,X=N-1+3*bt,B=T-1+3*bt,k=C-1+3*bt,Ce=s&255,me=o&255,Ae=a&255,j=this.perm[Ce+this.perm[me+this.perm[Ae]]]%12,D=this.perm[Ce+w+this.perm[me+E+this.perm[Ae+P]]]%12,te=this.perm[Ce+S+this.perm[me+A+this.perm[Ae+_]]]%12,We=this.perm[Ce+1+this.perm[me+1+this.perm[Ae+1]]]%12,Xe,G,F,ue,ae=.6-N*N-T*T-C*C;ae<0?Xe=0:(ae*=ae,Xe=ae*ae*(Ke[j][0]*N+Ke[j][1]*T+Ke[j][2]*C));let Yt=.6-L*L-W*W-x*x;Yt<0?G=0:(Yt*=Yt,G=Yt*Yt*(Ke[D][0]*L+Ke[D][1]*W+Ke[D][2]*x));let It=.6-J*J-ie*ie-Y*Y;It<0?F=0:(It*=It,F=It*It*(Ke[te][0]*J+Ke[te][1]*ie+Ke[te][2]*Y));let Mt=.6-X*X-B*B-k*k;return Mt<0?ue=0:(Mt*=Mt,ue=Mt*Mt*(Ke[We][0]*X+Ke[We][1]*B+Ke[We][2]*k)),32*(Xe+G+F+ue)}};var $e=class{constructor(e,t,i,r,s,o){this.simplexNoise=new no(e),this.terrainAmplitude=t,this.terrainLacunarity=i,this.terrainGain=r,this.terrainOctaves=s,this.terrainFrequencyMultiplier=o}calculateNoise(e,t){let i=0,r=this.terrainAmplitude,s=this.terrainFrequencyMultiplier;for(let o=0;o<this.terrainOctaves;o++)i+=r*this.simplexNoise.noise(e*s,t*s),r*=this.terrainGain,s*=this.terrainLacunarity;return i}};var Si=class{getLayerDescription(){}isLayerForGrid(e,t){}isLayerForTile(e,t){}isOreTileSupported(){}isGoldTileSupported(){}isRubyTileSupported(){}isUpgradeTileSupported(){}assignTileToOreType(e){}assignTileToGoldType(e){}assignTileToUpgradeType(e){}assignTileToRubyType(e){}assignTileTerrain(e,t){}};var Sd=60,Ft=class extends Si{constructor(e,t,i,r){super(),this.layerDescription=e,this.maxTileDepth=e.maxDepth,this.minTileDepth=e.minDepth,this.adjustedMinTileDepth=this.minTileDepth-Sd,this.fbm=t,this.goldGenerated=i,this.rubyGenerated=r}getLayerDescription(){return this.layerDescription}isInAdjustedRange(e){return e>=this.adjustedMinTileDepth&&e<this.maxTileDepth}isLayerForGrid(e,t){return!(t<this.adjustedMinTileDepth||e>this.maxTileDepth)}isLayerForTile(e,t){if(!this.isInAdjustedRange(t))return!1;let i=e.origin,r=n.tile.size*this.fbm.calculateNoise(i.y,i.x),s=this.minTileDepth+r;return t>=s}isOreTileSupported(){return this.layerDescription.oreTileType!==null}isGoldTileSupported(){return this.goldGenerated&&this.layerDescription.goldTileType!==null}isRubyTileSupported(){return this.rubyGenerated&&this.layerDescription.rubyTileType!==null}isUpgradeTileSupported(){return this.layerDescription.upgradeTileType!==null}assignTileToOreType(e){e.tileInit(!1,this.layerDescription.oreTileType)}assignTileToGoldType(e){e.tileInit(!1,this.layerDescription.goldTileType)}assignTileToUpgradeType(e){e.tileInit(!1,this.layerDescription.upgradeTileType)}assignTileToRubyType(e){e.tileInit(!1,this.layerDescription.rubyTileType)}assignTileTerrain(e,t){e.tileInit(t,this.layerDescription.primaryTileType)}};var ao=class extends Si{constructor(e,t){super(),this.tileType=e,this.layerDescription=t,this.maxSkyTileDepth=20}getLayerDescription(){return this.layerDescription}isLayerForGrid(e,t){return e<this.maxSkyTileDepth}isLayerForTile(e,t){return t<this.maxSkyTileDepth}isOreTileSupported(){return!1}isGoldTileSupported(){return!1}isRubyTileSupported(){return!1}isUpgradeTileSupported(){return!1}assignTileToOreType(e){e.tileInit(!0,this.tileType)}assignTileToGoldType(e){e.tileInit(!0,this.tileType)}assignTileToUpgradeType(e){e.tileInit(!0,this.tileType)}assignTileToRubyType(e){e.tileInit(!0,this.tileType)}assignTileTerrain(e,t){e.tileInit(!0,this.tileType)}};var lo=class extends Ft{constructor(e,t){super(e,t)}isLayerForTile(e,t){if(!this.isInAdjustedRange(t))return!1;let i=e.origin,r=n.tile.size*this.fbm.calculateNoise(i.x,i.x),s=this.minTileDepth+r-5;return t>=s}};var ho=class extends Ft{constructor(e,t){super(e,t)}isLayerForTile(e,t){if(!this.isInAdjustedRange(t))return!1;let i=e.origin,r=n.tile.size*this.fbm.calculateNoise(i.x,i.x),s=this.minTileDepth+r-5;return t>=s}};var uo=class{constructor(e){this.shiftValue=2.2734306378540854,this.indexFbm=new $e(e,1,2.1,.7,5,5e-4),this.indexLookup={},this.indexLookup["0.00"]=0,this.indexLookup["0.01"]=0,this.indexLookup["0.02"]=0,this.indexLookup["0.03"]=0,this.indexLookup["0.04"]=0,this.indexLookup["0.05"]=0,this.indexLookup["0.06"]=0,this.indexLookup["0.07"]=0,this.indexLookup["0.08"]=0,this.indexLookup["0.09"]=0,this.indexLookup["0.10"]=0,this.indexLookup["0.11"]=0,this.indexLookup["0.12"]=0,this.indexLookup["0.13"]=0,this.indexLookup["0.14"]=0,this.indexLookup["0.15"]=0,this.indexLookup["0.16"]=0,this.indexLookup["0.17"]=0,this.indexLookup["0.18"]=0,this.indexLookup["0.19"]=0,this.indexLookup["0.20"]=0,this.indexLookup["0.21"]=0,this.indexLookup["0.22"]=0,this.indexLookup["0.23"]=0,this.indexLookup["0.24"]=0,this.indexLookup["0.25"]=0,this.indexLookup["0.26"]=0,this.indexLookup["0.27"]=0,this.indexLookup["0.28"]=0,this.indexLookup["0.29"]=0,this.indexLookup["0.30"]=0,this.indexLookup["0.31"]=0,this.indexLookup["0.32"]=0,this.indexLookup["0.33"]=0,this.indexLookup["0.34"]=0,this.indexLookup["0.35"]=0,this.indexLookup["0.36"]=0,this.indexLookup["0.37"]=0,this.indexLookup["0.38"]=0,this.indexLookup["0.39"]=0,this.indexLookup["0.40"]=0,this.indexLookup["0.41"]=0,this.indexLookup["0.42"]=0,this.indexLookup["0.43"]=0,this.indexLookup["0.44"]=0,this.indexLookup["0.45"]=0,this.indexLookup["0.46"]=0,this.indexLookup["0.47"]=0,this.indexLookup["0.48"]=0,this.indexLookup["0.49"]=0,this.indexLookup["0.50"]=0,this.indexLookup["0.51"]=0,this.indexLookup["0.52"]=0,this.indexLookup["0.53"]=0,this.indexLookup["0.54"]=0,this.indexLookup["0.55"]=0,this.indexLookup["0.56"]=0,this.indexLookup["0.57"]=0,this.indexLookup["0.58"]=0,this.indexLookup["0.59"]=0,this.indexLookup["0.60"]=0,this.indexLookup["0.61"]=0,this.indexLookup["0.62"]=0,this.indexLookup["0.63"]=0,this.indexLookup["0.64"]=0,this.indexLookup["0.65"]=0,this.indexLookup["0.66"]=0,this.indexLookup["0.67"]=0,this.indexLookup["0.68"]=0,this.indexLookup["0.69"]=0,this.indexLookup["0.70"]=0,this.indexLookup["0.71"]=0,this.indexLookup["0.72"]=0,this.indexLookup["0.73"]=0,this.indexLookup["0.74"]=0,this.indexLookup["0.75"]=0,this.indexLookup["0.76"]=0,this.indexLookup["0.77"]=0,this.indexLookup["0.78"]=0,this.indexLookup["0.79"]=0,this.indexLookup["0.80"]=0,this.indexLookup["0.81"]=0,this.indexLookup["0.82"]=0,this.indexLookup["0.83"]=0,this.indexLookup["0.84"]=0,this.indexLookup["0.85"]=0,this.indexLookup["0.86"]=0,this.indexLookup["0.87"]=0,this.indexLookup["0.88"]=0,this.indexLookup["0.89"]=0,this.indexLookup["0.90"]=0,this.indexLookup["0.91"]=0,this.indexLookup["0.92"]=.01,this.indexLookup["0.93"]=.01,this.indexLookup["0.94"]=.01,this.indexLookup["0.95"]=.01,this.indexLookup["0.96"]=.01,this.indexLookup["0.97"]=.01,this.indexLookup["0.98"]=.01,this.indexLookup["0.99"]=.01,this.indexLookup["1.00"]=.01,this.indexLookup["1.01"]=.01,this.indexLookup["1.02"]=.01,this.indexLookup["1.03"]=.01,this.indexLookup["1.04"]=.01,this.indexLookup["1.05"]=.01,this.indexLookup["1.06"]=.02,this.indexLookup["1.07"]=.02,this.indexLookup["1.08"]=.02,this.indexLookup["1.09"]=.02,this.indexLookup["1.10"]=.02,this.indexLookup["1.11"]=.02,this.indexLookup["1.12"]=.02,this.indexLookup["1.13"]=.02,this.indexLookup["1.14"]=.02,this.indexLookup["1.15"]=.03,this.indexLookup["1.16"]=.03,this.indexLookup["1.17"]=.03,this.indexLookup["1.18"]=.03,this.indexLookup["1.19"]=.03,this.indexLookup["1.20"]=.03,this.indexLookup["1.21"]=.04,this.indexLookup["1.22"]=.04,this.indexLookup["1.23"]=.04,this.indexLookup["1.24"]=.04,this.indexLookup["1.25"]=.04,this.indexLookup["1.26"]=.04,this.indexLookup["1.27"]=.05,this.indexLookup["1.28"]=.05,this.indexLookup["1.29"]=.05,this.indexLookup["1.30"]=.05,this.indexLookup["1.31"]=.05,this.indexLookup["1.32"]=.06,this.indexLookup["1.33"]=.06,this.indexLookup["1.34"]=.06,this.indexLookup["1.35"]=.06,this.indexLookup["1.36"]=.07,this.indexLookup["1.37"]=.07,this.indexLookup["1.38"]=.07,this.indexLookup["1.39"]=.07,this.indexLookup["1.40"]=.08,this.indexLookup["1.41"]=.08,this.indexLookup["1.42"]=.08,this.indexLookup["1.43"]=.08,this.indexLookup["1.44"]=.09,this.indexLookup["1.45"]=.09,this.indexLookup["1.46"]=.09,this.indexLookup["1.47"]=.1,this.indexLookup["1.48"]=.1,this.indexLookup["1.49"]=.1,this.indexLookup["1.50"]=.11,this.indexLookup["1.51"]=.11,this.indexLookup["1.52"]=.11,this.indexLookup["1.53"]=.12,this.indexLookup["1.54"]=.12,this.indexLookup["1.55"]=.12,this.indexLookup["1.56"]=.13,this.indexLookup["1.57"]=.13,this.indexLookup["1.58"]=.13,this.indexLookup["1.59"]=.14,this.indexLookup["1.60"]=.14,this.indexLookup["1.61"]=.15,this.indexLookup["1.62"]=.15,this.indexLookup["1.63"]=.15,this.indexLookup["1.64"]=.16,this.indexLookup["1.65"]=.16,this.indexLookup["1.66"]=.17,this.indexLookup["1.67"]=.17,this.indexLookup["1.68"]=.17,this.indexLookup["1.69"]=.18,this.indexLookup["1.70"]=.18,this.indexLookup["1.71"]=.19,this.indexLookup["1.72"]=.19,this.indexLookup["1.73"]=.2,this.indexLookup["1.74"]=.2,this.indexLookup["1.75"]=.21,this.indexLookup["1.76"]=.21,this.indexLookup["1.77"]=.21,this.indexLookup["1.78"]=.22,this.indexLookup["1.79"]=.22,this.indexLookup["1.80"]=.23,this.indexLookup["1.81"]=.23,this.indexLookup["1.82"]=.24,this.indexLookup["1.83"]=.24,this.indexLookup["1.84"]=.25,this.indexLookup["1.85"]=.25,this.indexLookup["1.86"]=.26,this.indexLookup["1.87"]=.26,this.indexLookup["1.88"]=.27,this.indexLookup["1.89"]=.27,this.indexLookup["1.90"]=.28,this.indexLookup["1.91"]=.29,this.indexLookup["1.92"]=.29,this.indexLookup["1.93"]=.3,this.indexLookup["1.94"]=.3,this.indexLookup["1.95"]=.31,this.indexLookup["1.96"]=.31,this.indexLookup["1.97"]=.32,this.indexLookup["1.98"]=.32,this.indexLookup["1.99"]=.33,this.indexLookup["2.00"]=.34,this.indexLookup["2.01"]=.34,this.indexLookup["2.02"]=.35,this.indexLookup["2.03"]=.35,this.indexLookup["2.04"]=.36,this.indexLookup["2.05"]=.36,this.indexLookup["2.06"]=.37,this.indexLookup["2.07"]=.38,this.indexLookup["2.08"]=.38,this.indexLookup["2.09"]=.39,this.indexLookup["2.10"]=.39,this.indexLookup["2.11"]=.4,this.indexLookup["2.12"]=.41,this.indexLookup["2.13"]=.41,this.indexLookup["2.14"]=.42,this.indexLookup["2.15"]=.42,this.indexLookup["2.16"]=.43,this.indexLookup["2.17"]=.44,this.indexLookup["2.18"]=.44,this.indexLookup["2.19"]=.45,this.indexLookup["2.20"]=.46,this.indexLookup["2.21"]=.46,this.indexLookup["2.22"]=.47,this.indexLookup["2.23"]=.47,this.indexLookup["2.24"]=.48,this.indexLookup["2.25"]=.49,this.indexLookup["2.26"]=.49,this.indexLookup["2.27"]=.5,this.indexLookup["2.28"]=.5,this.indexLookup["2.29"]=.51,this.indexLookup["2.30"]=.52,this.indexLookup["2.31"]=.52,this.indexLookup["2.32"]=.53,this.indexLookup["2.33"]=.53,this.indexLookup["2.34"]=.54,this.indexLookup["2.35"]=.55,this.indexLookup["2.36"]=.55,this.indexLookup["2.37"]=.56,this.indexLookup["2.38"]=.57,this.indexLookup["2.39"]=.57,this.indexLookup["2.40"]=.58,this.indexLookup["2.41"]=.58,this.indexLookup["2.42"]=.59,this.indexLookup["2.43"]=.6,this.indexLookup["2.44"]=.6,this.indexLookup["2.45"]=.61,this.indexLookup["2.46"]=.61,this.indexLookup["2.47"]=.62,this.indexLookup["2.48"]=.63,this.indexLookup["2.49"]=.63,this.indexLookup["2.50"]=.64,this.indexLookup["2.51"]=.64,this.indexLookup["2.52"]=.65,this.indexLookup["2.53"]=.65,this.indexLookup["2.54"]=.66,this.indexLookup["2.55"]=.67,this.indexLookup["2.56"]=.67,this.indexLookup["2.57"]=.68,this.indexLookup["2.58"]=.68,this.indexLookup["2.59"]=.69,this.indexLookup["2.60"]=.69,this.indexLookup["2.61"]=.7,this.indexLookup["2.62"]=.71,this.indexLookup["2.63"]=.71,this.indexLookup["2.64"]=.72,this.indexLookup["2.65"]=.72,this.indexLookup["2.66"]=.73,this.indexLookup["2.67"]=.73,this.indexLookup["2.68"]=.74,this.indexLookup["2.69"]=.74,this.indexLookup["2.70"]=.75,this.indexLookup["2.71"]=.75,this.indexLookup["2.72"]=.76,this.indexLookup["2.73"]=.76,this.indexLookup["2.74"]=.77,this.indexLookup["2.75"]=.77,this.indexLookup["2.76"]=.78,this.indexLookup["2.77"]=.78,this.indexLookup["2.78"]=.79,this.indexLookup["2.79"]=.79,this.indexLookup["2.80"]=.8,this.indexLookup["2.81"]=.8,this.indexLookup["2.82"]=.8,this.indexLookup["2.83"]=.81,this.indexLookup["2.84"]=.81,this.indexLookup["2.85"]=.82,this.indexLookup["2.86"]=.82,this.indexLookup["2.87"]=.83,this.indexLookup["2.88"]=.83,this.indexLookup["2.89"]=.83,this.indexLookup["2.90"]=.84,this.indexLookup["2.91"]=.84,this.indexLookup["2.92"]=.85,this.indexLookup["2.93"]=.85,this.indexLookup["2.94"]=.85,this.indexLookup["2.95"]=.86,this.indexLookup["2.96"]=.86,this.indexLookup["2.97"]=.86,this.indexLookup["2.98"]=.87,this.indexLookup["2.99"]=.87,this.indexLookup["3.00"]=.87,this.indexLookup["3.01"]=.88,this.indexLookup["3.02"]=.88,this.indexLookup["3.03"]=.88,this.indexLookup["3.04"]=.89,this.indexLookup["3.05"]=.89,this.indexLookup["3.06"]=.89,this.indexLookup["3.07"]=.9,this.indexLookup["3.08"]=.9,this.indexLookup["3.09"]=.9,this.indexLookup["3.10"]=.9,this.indexLookup["3.11"]=.91,this.indexLookup["3.12"]=.91,this.indexLookup["3.13"]=.91,this.indexLookup["3.14"]=.92,this.indexLookup["3.15"]=.92,this.indexLookup["3.16"]=.92,this.indexLookup["3.17"]=.92,this.indexLookup["3.18"]=.93,this.indexLookup["3.19"]=.93,this.indexLookup["3.20"]=.93,this.indexLookup["3.21"]=.93,this.indexLookup["3.22"]=.93,this.indexLookup["3.23"]=.94,this.indexLookup["3.24"]=.94,this.indexLookup["3.25"]=.94,this.indexLookup["3.26"]=.94,this.indexLookup["3.27"]=.94,this.indexLookup["3.28"]=.95,this.indexLookup["3.29"]=.95,this.indexLookup["3.30"]=.95,this.indexLookup["3.31"]=.95,this.indexLookup["3.32"]=.95,this.indexLookup["3.33"]=.96,this.indexLookup["3.34"]=.96,this.indexLookup["3.35"]=.96,this.indexLookup["3.36"]=.96,this.indexLookup["3.37"]=.96,this.indexLookup["3.38"]=.96,this.indexLookup["3.39"]=.96,this.indexLookup["3.40"]=.97,this.indexLookup["3.41"]=.97,this.indexLookup["3.42"]=.97,this.indexLookup["3.43"]=.97,this.indexLookup["3.44"]=.97,this.indexLookup["3.45"]=.97,this.indexLookup["3.46"]=.97,this.indexLookup["3.47"]=.97,this.indexLookup["3.48"]=.97,this.indexLookup["3.49"]=.98,this.indexLookup["3.50"]=.98,this.indexLookup["3.51"]=.98,this.indexLookup["3.52"]=.98,this.indexLookup["3.53"]=.98,this.indexLookup["3.54"]=.98,this.indexLookup["3.55"]=.98,this.indexLookup["3.56"]=.98,this.indexLookup["3.57"]=.98,this.indexLookup["3.58"]=.98,this.indexLookup["3.59"]=.98,this.indexLookup["3.60"]=.98,this.indexLookup["3.61"]=.98,this.indexLookup["3.62"]=.99,this.indexLookup["3.63"]=.99,this.indexLookup["3.64"]=.99,this.indexLookup["3.65"]=.99,this.indexLookup["3.66"]=.99,this.indexLookup["3.67"]=.99,this.indexLookup["3.68"]=.99,this.indexLookup["3.69"]=.99,this.indexLookup["3.70"]=.99,this.indexLookup["3.71"]=.99,this.indexLookup["3.72"]=.99,this.indexLookup["3.73"]=.99,this.indexLookup["3.74"]=.99,this.indexLookup["3.75"]=.99,this.indexLookup["3.76"]=.99,this.indexLookup["3.77"]=.99,this.indexLookup["3.78"]=.99,this.indexLookup["3.79"]=.99,this.indexLookup["3.80"]=.99,this.indexLookup["3.81"]=.99,this.indexLookup["3.82"]=.99,this.indexLookup["3.83"]=.99,this.indexLookup["3.84"]=.99,this.indexLookup["3.85"]=.99,this.indexLookup["3.86"]=.99,this.indexLookup["3.87"]=.99,this.indexLookup["3.88"]=.99,this.indexLookup["3.89"]=.99,this.indexLookup["3.90"]=.99,this.indexLookup["3.91"]=.99,this.indexLookup["3.92"]=.99,this.indexLookup["3.93"]=.99,this.indexLookup["3.94"]=.99,this.indexLookup["3.95"]=.99,this.indexLookup["3.96"]=.99,this.indexLookup["3.97"]=.99,this.indexLookup["3.98"]=.99,this.indexLookup["3.99"]=.99,this.indexLookup["4.00"]=.99,this.indexLookup["4.01"]=.99,this.indexLookup["4.02"]=.99,this.indexLookup["4.03"]=.99,this.indexLookup["4.04"]=.99,this.indexLookup["4.05"]=.99,this.indexLookup["4.06"]=.99,this.indexLookup["4.07"]=.99,this.indexLookup["4.08"]=.99,this.indexLookup["4.09"]=.99,this.indexLookup["4.10"]=.99,this.indexLookup["4.11"]=.99,this.indexLookup["4.12"]=.99,this.indexLookup["4.13"]=.99,this.indexLookup["4.14"]=.99,this.indexLookup["4.15"]=.99,this.indexLookup["4.16"]=.99,this.indexLookup["4.17"]=.99,this.indexLookup["4.18"]=.99,this.indexLookup["4.19"]=.99,this.indexLookup["4.20"]=.99,this.indexLookup["4.21"]=.99,this.indexLookup["4.22"]=.99,this.indexLookup["4.23"]=.99,this.indexLookup["4.24"]=.99,this.indexLookup["4.25"]=.99,this.indexLookup["4.26"]=.99,this.indexLookup["4.27"]=.99,this.indexLookup["4.28"]=.99,this.indexLookup["4.29"]=.99,this.indexLookup["4.30"]=.99,this.indexLookup["4.31"]=.99,this.indexLookup["4.32"]=.99,this.indexLookup["4.33"]=.99,this.indexLookup["4.34"]=.99,this.indexLookup["4.35"]=.99,this.indexLookup["4.36"]=.99,this.indexLookup["4.37"]=.99,this.indexLookup["4.38"]=.99,this.indexLookup["4.39"]=.99,this.indexLookup["4.40"]=.99,this.indexLookup["4.41"]=.99}getBucket(e){return e.toFixed(2)}getIndexFromFbm(e,t,i){if(i===1)return 0;let r=this.indexFbm.calculateNoise(e,t)+this.shiftValue;if(r<=0)return 0;let s=this.getBucket(r),o=this.indexLookup[s];return o?i*o|0:0}};var co=class extends Or{constructor(e,t,i,r,s,o){super(i,r,s,o),this.typeName=e,this.colorName=t}};var Ni={};Ni.getDescription=(l,e)=>{let t=si.getSpriteName(l,e),i=Ni[t];return i||(i=new co(l,e,t,!0,!1,!1),Ni[t]=i),i};var Ai=class{constructor(e,t,i){this.fixtureNames=e,this.colorNames=t,this.probabilityDenominator=i}getFixtureDescription(e){if(this.fixtureNames.length===0||this.colorNames.length===0)return null;let t=e.randomInt(this.fixtureNames.length*this.probabilityDenominator);if(t>=this.fixtureNames.length)return null;let i=this.fixtureNames[t],r=this.colorNames.length===1?this.colorNames[0]:this.colorNames[e.randomInt(this.colorNames.length)];return Ni.getDescription(i,r)}};var Bi=class{constructor(e,t,i){this.ceilingDecoratorTheme=e,this.midDecoratorTheme=t,this.floorDecoratorTheme=i}decorateCavernTile(e,t){let i=e.grid,r=e.getNeighborTop(),s=e.getNeighborBottom(),o=r&&!r.open&&i===r.grid,a=s&&!s.open&&i===s.grid,h=null;o&&a?this.midDecoratorTheme&&(h=this.midDecoratorTheme.getFixtureDescription(t)):o?this.ceilingDecoratorTheme&&(h=this.ceilingDecoratorTheme.getFixtureDescription(t)):a?this.floorDecoratorTheme&&(h=this.floorDecoratorTheme.getFixtureDescription(t)):this.midDecoratorTheme&&(h=this.midDecoratorTheme.getFixtureDescription(t)),e.fixtureDescription=h}};var mo=class{constructor(){}getRandomLayerDecorator(e){let t=this.randomColorScheme(e),i=this.randomColorScheme(e);return[new Bi(this.randomCeilingTheme(e,t),this.randomMidTheme(e,i),this.randomFloorTheme(e,i)),new Bi(this.randomCeilingTheme(e,i),null,this.randomFloorTheme(e,t))]}randomCeilingTheme(e,t){let i=hl[e.randomInt(hl.length)];return new Ai(i,t,2)}randomMidTheme(e,t){let i=ul[e.randomInt(ul.length)];return new Ai(i,t,8)}randomFloorTheme(e,t){let i=cl[e.randomInt(cl.length)];return new Ai(i,t,2)}randomColorScheme(e){let t=[];return t.push(this.functionRandomColor(e)),t.push(this.functionRandomColor(e)),t.push(this.functionRandomColor(e)),t}functionRandomColor(e){return dl[e.randomInt(dl.length)]}};var ja=class{constructor(){}generateTerrain(e){}generateTileBackgrounds(e){}};var po=class extends ja{constructor(e,t){super();let i=e;this.cavernFbmA=new $e(i++,.9,2,1.2,5,41e-5),this.cavernValueAMin=-6,this.cavernValueAMax=-1.3,this.cavernFbmB=new $e(i++,1.2,1.25,.9,5,.00261),this.cavernValueBMin=.8,this.cavernValueBMax=4.1,this.oreFbm=new $e(i++,1,1.5,1.4,5,.002),this.pointsFbm=new $e(i++,1,1.6,1.3,5,.001),this.upgradeFbm=new $e(i++,1,1.6,1.4,5,.001),this.rubyFbm=new $e(i++,1,1.6,1.4,5,.001),this.backgroundFbm=new $e(i++,1,2.1,.7,5,5e-4);let r=new $e(i++,.7,3.5,.8,5,1e-5);this.indexGenerator=new uo(e),this.characterCreator=t,this.terrainLayers=[];for(let s=0;s<je.length;s++){let o=je[s];if(o===Ue.SKY_LAYER)this.terrainLayers.push(new ao(ge.SKY,o));else if(o===Ue.GRASS_LAYER)this.terrainLayers.push(new lo(o,r));else if(o===Ue.DIRT_LAYER)this.terrainLayers.push(new ho(o,r));else{let a=s>10,h=s>20;this.terrainLayers.push(new Ft(o,new $e(i++,1,3.5,.9,5,5e-5),a,h))}}this.terrainLayerById={};for(let s=0;s<this.terrainLayers.length;s++){let o=this.terrainLayers[s],a=o.getLayerDescription();if(!a){console.log("LayeredTerrainGenerator No layer description for layer index: "+s);continue}this.terrainLayerById[a.id]=o}this.cavernDecoratorsByLayer={},this.layerDecoratorConfig=new mo,this.rng=new Ci(i);for(let s=0;s<je.length;s++){let o=je[s];o!==Ue.SKY_LAYER&&(o===Ue.GRASS_LAYER?this.cavernDecoratorsByLayer[o.id]=[]:this.cavernDecoratorsByLayer[o.id]=this.layerDecoratorConfig.getRandomLayerDecorator(this.rng))}}generateTerrain(e){let t=this.findApplicableTerrainLayersForGrid(e),i=e.zones;for(let r=0;r<i.length;r++){let o=i[r].regions;for(let a=0;a<o.length;a++){let h=o[a].tiles;for(let m=0;m<h.length;m++)this.assignTileTerrain(h[m],t)}}for(let r=0;r<i.length;r++){let o=i[r].regions;for(let a=0;a<o.length;a++){let h=o[a].tiles;for(let m=0;m<h.length;m++){let p=h[m];!p.open||p.fixtureDescription||this.assignCavernDecorationToTile(p)}}}}generateTileBackgrounds(e){this.generateBackground(e)}isTileCavern(e){let t=e.tileType;if(!t){console.log("LayeredTerrainGenerator.isTileCavern() no tile type");return}let i=t.layerDescription;if(!i){console.log("LayeredTerrainGenerator.isTileCavern() no layer desc. tileType.icon="+t.iconFileName);return}if(!this.terrainLayerById[i.id]){console.log("LayeredTerrainGenerator.isTileCavern() no terrain layer. id="+i.id);return}let s=e.origin,o=this.cavernFbmA.calculateNoise(s.x,s.y);if(o>this.cavernValueAMin&&o<this.cavernValueAMax)return!0;let a=this.cavernFbmB.calculateNoise(s.x/2,s.y*2);return a>this.cavernValueBMin&&a<this.cavernValueBMax}generateBackground(e){let t=this;ye.allTilesInGrid(e,function(i){t.assignTileBackgroundSprite(i)})}assignTileBackgroundSprite(e){let t=e.tileType;if(!t){console.log("LayeredTerrainGenerator.setTileBackground() ERROR Tile has no TileType!");return}let i=t.layerDescription;i?e.backgroundSprite=this.getBackgroundSprite(e.origin,i.primaryTileType.tileTypeBackground):t.tileTypeBackground&&(e.backgroundSprite=this.getBackgroundSprite(e.origin,t.tileTypeBackground))}getBackgroundSprite(e,t){let i=Math.abs(this.backgroundFbm.calculateNoise(e.x,e.y)+1),s=Math.min(Math.max(0,i/3.25),1)*(t.sprites.length-1)|0;return t.sprites[s]}assignCavernDecorationToTile(e){let t=e.tileType;if(!t)return;let i=t.layerDescription;if(!i)return;let r=this.cavernDecoratorsByLayer[i.id];if(!r||r.length===0)return;let s=e.origin;if(r[this.indexGenerator.getIndexFromFbm(s.x,s.y,r.length)].decorateCavernTile(e,this.rng),i.monsterDescriptions.length>0&&this.rng.random()<.01){let a=i.monsterDescriptions[this.rng.randomInt(i.monsterDescriptions.length)];this.characterCreator.createMonsterAtTile(a,e)}}assignTileTerrain(e,t){let i=this.findTerrainLayerForTile(e,t);i&&(i.assignTileTerrain(e,!1),this.isTileCavern(e)?e.open=!0:this.assignTypeForNonCavernTile(e,i),this.assignTileBackgroundSprite(e))}assignTypeForNonCavernTile(e,t){let i=e.origin,r=this.rng.random();if(r<.8&&t.isOreTileSupported()&&this.oreFbm.calculateNoise(i.y,i.x/3)<-3.55){t.assignTileToOreType(e);return}if(r<.4&&t.isGoldTileSupported()&&this.pointsFbm.calculateNoise(i.x,i.y)<-3.5){t.assignTileToGoldType(e);return}if(r<.02&&t.isUpgradeTileSupported()&&this.upgradeFbm.calculateNoise(i.x,i.y)<-3){t.assignTileToUpgradeType(e);return}if(r<.01&&t.isRubyTileSupported()&&this.rubyFbm.calculateNoise(i.x,i.y)<-3){t.assignTileToRubyType(e);return}}findApplicableTerrainLayersForGrid(e){let t=e.origin.y/n.tile.size,i=t+n.grid.gridTileHeight,r=[];for(let s=0;s<this.terrainLayers.length;s++){let o=this.terrainLayers[s];o.isLayerForGrid(t,i)&&r.push(o)}return r}findTerrainLayerForTile(e,t){let i=e.origin.y/n.tile.size;for(let r=t.length-1;r>=0;r--){let s=t[r];if(s.isLayerForTile(e,i))return s}return t.length>0?t[0]:null}};var qa=wl(gl());var go=class{constructor(e){this.characterCreator=e}getGridKey(e){let t=e.getGridCol(),i=e.getGridRow(),r=t>=0?"":"n",s=i>=0?"":"n";return"G_"+r+Math.abs(t)+"_"+s+Math.abs(i)}generateGridStateForExport(e){if(!e)return console.log("GridSave.generateGridStateForExport() Null grid"),null;let t=this.generateState(e);return t?{key:this.getGridKey(e),origin:{x:e.origin.x,y:e.origin.y},state:t}:(console.log("GridSave.generateGridStateForExport() Failed to generate grid state"),null)}importGridState(e,t){if(!e)return console.log("GridSave.importGridState() FAIL. grid is null"),!1;let i=t.origin;return e.origin.set(i.x,i.y),e.initializeZonesForGrid(),this.loadStateInternal(e,t.state),!0}saveGridState(e){if(e.gridChangeCount===0)return;let t=this.generateState(e);if(!t)return console.log("GridSave.saveGridState() Failed to generate grid state"),!1;let i=this.getGridKey(e),r=JSON.stringify(t);if(!r)return console.log("GridSave.saveGridState() Failed to stringify state for grid: "+i),!1;let s=qa.compressToUTF16(r);return s?(localStorage.setItem(i,s),!0):(console.log("GridSave.saveGridState() Failed to compress state for grid: "+i),!1)}removeGridState(e){localStorage.removeItem(e)}loadGridState(e){let t=this.getGridKey(e),i=localStorage.getItem(t);if(i){let r=qa.decompressFromUTF16(i);if(r){let s=JSON.parse(r);if(s)return this.loadStateInternal(e,s),!0;console.log("GridSave.loadGridState() Failed to parse grid json.  grid: "+t)}else console.log("GridSave.loadGridState() Failed to decompress grid save state. grid: "+t)}return!1}generateState(e){let t={};return t.tiles=this.generateTileStateArray(e),t.characters=this.generateCharacterStateArray(e),t}loadStateInternal(e,t){this.loadTileStateArray(e,t.tiles),this.loadCharacterStateArray(e,t.characters)}generateTileStateArray(e){let t=this,i=[];return ye.allTilesInGrid(e,r=>{i.push(t.generateTileState(r))}),i}loadTileStateArray(e,t){if(!t){console.log("GridSave.loadTileStateArray() no tile state array");return}let i=0,r=this;ye.allTilesInGrid(e,s=>{r.loadTileState(s,t[i]),i++})}generateCharacterStateArray(e){let t=[];if(e.characters.length===0)return t;let i=e.getOriginTileCol(),r=e.getOriginTileRow();for(let s=0;s<e.characters.length;s++){let o=e.characters[s];if(!o.isMonster())continue;let a=this.generateCharacterState(i,r,o);a&&t.push(a)}return t}loadCharacterStateArray(e,t){if(!(!t||t.length===0))for(let i=0;i<t.length;i++)this.loadCharacterState(e,t[i])}generateTileState(e){let t={},i=0;return e.open&&(i+=1),e.lighting.sunlightFull&&(i+=2),e.lighting.sunlightPartial&&(i+=4),e.lighting.everVisibleToCharacter&&(i+=8),t.a=i,t.b=e.tileType.id,e.fixtureDescription&&(t.f={t:e.fixtureDescription.typeName,c:e.fixtureDescription.colorName}),t}loadTileState(e,t){if(!t){console.log("GridSave.loadTileState() no tile state");return}let i=t.a,r=t.b,s=(i&1)===1,o=_l[r];e.tileInit(s,o);let a=(i&2)===2,h=(i&4)===4,m=(i&8)===8;if(e.lighting.sunlightPartial=h,a&&e.markAsSunlightFull(),m&&e.markTileAsEverVisible(),t.f){let p=t.f.t,f=t.f.c;e.fixtureDescription=Ni.getDescription(p,f)}}generateCharacterState(e,t,i){let r=i.position.tile;if(!r)return console.log("GridSave.generateCharacterState() character tile is null"),null;let s={};return s.c=r.getTileCol()-e,s.r=r.getTileRow()-t,s.d=i.getMonsterDescriptionId(),s}loadCharacterState(e,t){if(!t)return;let i=t.c,r=t.r,s=t.d,o=e.getGridTileLocal(i,r);if(!o){console.log("GridSave.loadCharacterState() Failed to find tile for character.  tileCol="+i+" tileRow="+r);return}let a=xl[s];if(!a){console.log("GridSave.loadCharacterState() Failed to find monster description: "+s);return}this.characterCreator.createMonsterAtTile(a,o)}};var qt=class{constructor(e,t,i){this.gridKey=e,this.gridCol=t,this.gridRow=i}};var fo=class extends z{constructor(e){super(),this.metadataByKey=new Map,this.gridSave=e,this.maxSizeThreshold=50,this.farColThreshold=8,this.farRowThreshold=6}generateGridStateForExport(e){let t={grids:[]},i=e.grids;for(let r=0;r<i.length;r++){let s=this.gridSave.generateGridStateForExport(i[r]);t.grids.push(s)}return t}importGridState(e,t){if(!t)return console.log("GridSaveManager.importGridState() No world grid state"),!1;if(!t.grids||t.grids.length<e.grids.length)return console.log("GridSaveManager.importGridState() Invalid grids array."),!1;let i=e.grids;for(let r=0;r<i.length;r++){let s=i[r],o=t.grids[r];if(!this.gridSave.importGridState(s,o))return console.log("GridSaveManager.importGridState() Failed to import grid index: "+r),!1;let a=o.key;if(this.metadataByKey.has(a))console.log("GridSaveManager.importGridState() NOT UPDATING METADATA FOR KEY BECAUSE IT WAS ALREADY THERE.");else{let h=new qt(a,s.getGridCol(),s.getGridRow());this.metadataByKey.set(a,h)}}return!0}addGridSaveMetaFromSave(e){if(this.metadataByKey.has(e.gridKey)){console.log("GridSaveManager.addGridSaveMetaFromSave() added duplicate! key="+e.gridKey),console.trace();return}this.metadataByKey.set(e.gridKey,e)}saveGridState(e){if(!e||e.gridChangeCount===0)return;let t=this.gridSave.getGridKey(e);if(this.gridSave.saveGridState(e)){if(!this.metadataByKey.has(t)){let i=new qt(t,e.getGridCol(),e.getGridRow());this.metadataByKey.set(t,i)}}else console.log("GridSaveManager.saveGridState() Failed to save grid state. key="+t)}deleteAllGrids(){let e=[];for(let[t]of this.metadataByKey.entries())e.push(t);for(let t=0;t<e.length;t++)this.removeGridState(e[t])}removeGridState(e){this.gridSave.removeGridState(e),this.metadataByKey.delete(e)}loadGridState(e){let t=this.gridSave.getGridKey(e);return this.metadataByKey.has(t)?this.gridSave.loadGridState(e)?!0:(console.log("GridSaveManager.loadGridState() failed to load grid state. gridKey="+t),!1):!1}clearDistantGrids(e,t){let i=e.getGridCol(),r=e.getGridRow(),s=[];if(e===t)for(let[o,a]of this.metadataByKey.entries())this.isDistant(i,r,a)&&s.push(o);else{let o=t.getGridCol(),a=t.getGridRow();for(let[h,m]of this.metadataByKey.entries())this.isDistant(i,r,m)&&this.isDistant(o,a,m)&&s.push(h)}for(let o=0;o<s.length;o++)this.removeGridState(s[o])}isDistant(e,t,i){return Math.abs(e-i.gridCol)>this.farColThreshold||Math.abs(t-i.gridRow)>this.farRowThreshold}resetFull(){this.deleteAllGrids()}resetForPrestige(){this.resetFull()}};var To=class{constructor(e,t,i,r,s){this.gridSaveManager=e,this.terrainGenerator=t,this.worldGrid=i,this.crew=r,this.vectorField=s}loadGrid(e,t,i){e.isLoaded()&&this.unloadGrid(e),e.origin.set(t,i),e.initializeZonesForGrid(),this.loadOrGenerateTerrain(e,!1)}regenerateGrid(e){e.isLoaded()&&this.unloadGridInternal(e,!1),e.initializeZonesForGrid(),this.loadOrGenerateTerrain(e,!0)}unloadGrid(e){this.unloadGridInternal(e,!0)}unloadGridInternal(e,t){t&&e.loaded&&(le.startTime("SaveGrid"),this.gridSaveManager.saveGridState(e),le.endTime("SaveGrid"));let i=this.crew.miners;for(let r=0;r<i.length;r++){let s=i[r];s.position.tile&&s.position.tile.getGrid()===e&&(console.log("GridLoader.unloadGridInternal() Party character is in grid that is being unloaded."),s.onInvalidGrid())}e.unloadGrid(),this.vectorField.onGridUnload(e),this.crew.onGridUnload(e)}loadOrGenerateTerrain(e,t){le.startTime("LoadGrid");let i=!t&&this.gridSaveManager.loadGridState(e);le.endTime("LoadGrid"),i?this.terrainGenerator.generateTileBackgrounds(e):(le.startTime("GenerateTerrain"),e.nullifyBorderNeighbors(),this.terrainGenerator.generateTerrain(e),le.endTime("GenerateTerrain"),e.markGridAsChanged())}onTerrainGenerationComplete(e){e.gridChangeCount=0,e.loaded=!0,ye.allTilesInGrid(e,function(t){t.open&&t.tileType===ge.SKY&&!t.lighting.sunlightFull&&t.handleSunlightStart()})}};var Ja=0,Qa=1,$a=2,el=3,tl=4,il=5,rl=6,sl=7,Eo=class extends z{constructor(e,t){super(),this.worldGrid=e,this.projection=t,this.centerGrid=null,this.loadedGridTurn=0,this.gridLoader=null,this.crew=null,this.savedGrids=new Array(9)}initializeLoadingManager(e,t){this.gridLoader=e,this.crew=t;let i=n.grid.gridPixelWidth,r=n.grid.gridPixelHeight,s=this.worldGrid.grids,o=Z.floor(this.projection.gridCenter.x/i),a=Z.floor(this.projection.gridCenter.y/r),h=o*i,m=a*r;this.gridLoader.loadGrid(s[0],h-i,m-r),this.gridLoader.loadGrid(s[1],h,m-r),this.gridLoader.loadGrid(s[2],h+i,m-r),this.gridLoader.loadGrid(s[3],h-i,m),this.gridLoader.loadGrid(s[4],h,m),this.gridLoader.loadGrid(s[5],h+i,m),this.gridLoader.loadGrid(s[6],h-i,m+r),this.gridLoader.loadGrid(s[7],h,m+r),this.gridLoader.loadGrid(s[8],h+i,m+r),this.performPostGridLoadOperations(),this.worldGrid.changeCount++,this.worldGrid.shiftCount++}clearSavedGrid(e){let t=this.savedGrids.indexOf(e);t!==-1?this.savedGrids[t]=null:console.log("GridLoadingManager.clearSavedGrid() did not find grid in saved grids")}setGridIfAlreadyLoaded(e,t,i){let r=this.findSavedGridIndex(e,i);if(r===-1)return;let s=this.savedGrids[r];s.loaded&&(this.savedGrids[r]=null,this.worldGrid.grids[t]=s)}findFirstSavedGridIndex(){for(let e=0;e<this.savedGrids.length;e++)if(this.savedGrids[e])return e;return-1}loadIfUnloaded(e,t,i){let r=this.worldGrid.grids[t];if(r&&r.isLoaded())return;let s=this.findFirstSavedGridIndex();if(s===-1){console.log("GridLoadingManager.loadIfUnloaded() ERROR Failed to find available grid!");return}let o=this.savedGrids[s];this.worldGrid.grids[t]=o,this.savedGrids[s]=null;let a=e.origin.x,h=e.origin.y,m=a,p=h,f=n.grid.gridPixelWidth,N=n.grid.gridPixelHeight;switch(i){case Qa:m=a-f,p=h-N;break;case Ja:p=h-N;break;case $a:m=a+f,p=h-N;break;case el:m=a-f;break;case tl:m=a+f;break;case rl:p=h+N,m=a-f;break;case il:p=h+N;break;case sl:p=h+N,m=a+f;break;default:return console.log("GridLoadingManager.findSavedGridIndex() Unknown direction: "+i),-1}this.gridLoader.loadGrid(o,m,p)}findSavedGridIndex(e,t){let i=e.getOriginTileCol(),r=e.getOriginTileRow(),s=n.grid.gridTileWidth,o=n.grid.gridTileHeight,a=i,h=r;switch(t){case Qa:h=r-o,a=i-s;break;case Ja:h=r-o;break;case $a:h=r-o,a=i+s;break;case el:a=i-s;break;case tl:a=i+s;break;case rl:h=r+o,a=i-s;break;case il:h=r+o;break;case sl:h=r+o,a=i+s;break;default:return console.log("GridLoadingManager.findSavedGridIndex() Unknown direction: "+t),-1}for(let m=0;m<this.savedGrids.length;m++){let p=this.savedGrids[m];if(!p||p.getOriginTileCol()!==a)continue;if(p.getOriginTileRow()===h)return m}return-1}manageLoadedGridsForFrame(){let e=this.projection.gridCenter,t=this.worldGrid.findGridContaining(e);if(!t){t=this.worldGrid.grids[4],t.isLoaded()&&this.gridLoader.unloadGrid(t);let r=Z.floor(e.x/n.grid.gridPixelWidth),s=Z.floor(e.y/n.grid.gridPixelHeight),o=r*n.grid.gridPixelWidth,a=s*n.grid.gridPixelHeight;this.gridLoader.loadGrid(t,o,a),this.centerGrid=null}if(this.centerGrid&&this.centerGrid===t)return;this.worldGrid.changeCount++,this.worldGrid.shiftCount++,this.centerGrid=t;let i=this.worldGrid.grids;for(let r=0;r<i.length;r++)this.savedGrids[r]=i[r],i[r]=null;i[4]=this.centerGrid,this.clearSavedGrid(this.centerGrid),this.setGridIfAlreadyLoaded(this.centerGrid,0,Qa),this.setGridIfAlreadyLoaded(this.centerGrid,1,Ja),this.setGridIfAlreadyLoaded(this.centerGrid,2,$a),this.setGridIfAlreadyLoaded(this.centerGrid,3,el),this.setGridIfAlreadyLoaded(this.centerGrid,5,tl),this.setGridIfAlreadyLoaded(this.centerGrid,6,rl),this.setGridIfAlreadyLoaded(this.centerGrid,7,il),this.setGridIfAlreadyLoaded(this.centerGrid,8,sl),this.loadIfUnloaded(this.centerGrid,0,Qa),this.loadIfUnloaded(this.centerGrid,1,Ja),this.loadIfUnloaded(this.centerGrid,2,$a),this.loadIfUnloaded(this.centerGrid,3,el),this.loadIfUnloaded(this.centerGrid,5,tl),this.loadIfUnloaded(this.centerGrid,6,rl),this.loadIfUnloaded(this.centerGrid,7,il),this.loadIfUnloaded(this.centerGrid,8,sl),le.startTime("PostGridLoading"),this.performPostGridLoadOperations(),le.endTime("PostGridLoading")}performPostGridLoadOperations(){if(this.setAllGridNeighbors(),this.findAllGridBorderTileNeighbors(),this.evaulateGridTiles(),this.onLoadingComplete(),this.validateTileReferences(),this.crew&&this.crew.main){let e=null,t=this.crew.main.position.tile;t?e=t.getGrid():this.centerGrid&&(e=this.centerGrid.getWorldGrid().findGridContaining(this.crew.main.position.worldCoordinateOrigin)),e&&this.gridLoader.gridSaveManager.clearDistantGrids(this.centerGrid,e)}}setAllGridNeighbors(){let e=this.worldGrid.grids;e[0].setGridNeighbors(null,e[3],e[1],null),e[1].setGridNeighbors(null,e[4],e[2],e[0]),e[2].setGridNeighbors(null,e[5],null,e[1]),e[3].setGridNeighbors(e[0],e[6],e[4],null),e[4].setGridNeighbors(e[1],e[7],e[5],e[3]),e[5].setGridNeighbors(e[2],e[8],null,e[4]),e[6].setGridNeighbors(e[3],null,e[7],null),e[7].setGridNeighbors(e[4],null,e[8],e[6]),e[8].setGridNeighbors(e[5],null,null,e[7])}onLoadingComplete(){let e=this.worldGrid.grids;for(let t=0;t<e.length;t++)e[t].loaded||this.gridLoader.onTerrainGenerationComplete(e[t])}findAllGridBorderTileNeighbors(){let e=this.worldGrid.grids;for(let t=0;t<e.length;t++)e[t].findWorldGridTileNeighbors()}evaulateGridTiles(){let e=this.worldGrid.grids;for(let t=0;t<e.length;t++){let i=e[t];i.loaded?i.evaluateWorldGridTileNeighborBorders():i.evaluateAllTileBorders()}}validateTileReferences(){let e=this.worldGrid.grids;for(let t=0;t<e.length;t++)this.validateGridTileReferences(e[t])}validateGridTileReferences(e){let t=e.characters;for(let i=0;i<t.length;i++){let r=t[i].position;r.tile&&r.tile.contains(r.worldCoordinateOrigin)||(console.log("GridLoadingManager.validateGridTileReferences() found invalid character. "+r.worldCoordinateOrigin.toString()),t[i].onInvalidGrid())}}regenerateGrids(){let e=this.worldGrid.grids;for(let t=0;t<e.length;t++){let i=e[t];i&&this.gridLoader.regenerateGrid(i)}this.worldGrid.changeCount++}resetFull(){let e=this.worldGrid.grids;for(let t=0;t<e.length;t++){let i=e[t];i&&this.gridLoader.unloadGrid(i)}this.crew=null,this.gridLoader=null}resetForPrestige(){this.resetFull()}};var ki=class{constructor(e,t){this.a0=e,this.a1=t}};var wo=class{constructor(e){this.nextIndex=0,this.arcs=new Array(e);for(let t=0;t<e;t++)this.arcs[t]=new ki(0,0)}resetCache(){this.nextIndex=0}getArc(e,t){let i;return this.nextIndex>=this.arcs.length?(i=new ki(e,t),this.arcs.push(i)):(i=this.arcs[this.nextIndex],i.a0=e,i.a1=t),this.nextIndex++,i}};var Co=class{tileLighted(e,t,i){}};var fl=[[0,-1],[1,0],[0,1],[-1,0]],So=class{constructor(e){this.worldGrid=e}castShadows(e,t,i){}getNeighborCountForRadius(e){return e*8}forEachCircleTile(e,t,i,r){let h=e+-1*i,m=t+1*i,p=null,f=this.getNeighborCountForRadius(i),N=0;for(let T=0;T<fl.length;T++)for(let C=0;C<i*2;C++){let w;if(p!=null?w=p.getNeighborColRow(h,m):w=this.worldGrid.getGridTile(h,m),w&&!this.onCircleTile(w,N,f,i,r))return;N++,h+=fl[T][0],m+=fl[T][1],p=w}}onCircleTile(e,t,i,r,s){}};var No=class extends So{constructor(e){super(e),this.shadows=[],this.cache=new wo(2500)}castShadows(e,t,i){if(e==null)return;i.tileLighted(e,0,1);let r=e.getTileCol(),s=e.getTileRow();this.shadows.length=0,this.cache.resetCache();for(let o=1;o<=t;o++)this.forEachCircleTile(r,s,o,i)}onCircleTile(e,t,i,r,s){if(!e)return!0;let o=this.cache.getArc(t>0?2*t-1:2*i-1,2*i),a=this.cache.getArc(2*t+1,2*i),h=e.isOpaque(),m=this.checkVisibility(o,a,h,this.shadows);return m>0&&s.tileLighted(e,r,m),!(this.shadows.length==2&&this.shadows[0].a0==0&&this.shadows[1].a0==this.shadows[1].a1)}checkVisibility(e,t,i,r){if(e.a0>t.a0){let w=this.checkVisibility(e,this.cache.getArc(e.a1,e.a1),i,r),E=this.checkVisibility(this.cache.getArc(0,1),t,i,r);return(w+E)/2}let s=0,o=!1;for(;s<r.length;){let w=r[s],E=w.a0*e.a1-e.a0*w.a1;if(E>=0){E==0&&s%2==0&&(o=!0);break}s++}let a=r.length,h=!1;for(;a--!=0;){let w=r[a],E=t.a0*w.a1-w.a0*t.a1;if(E>=0){E==0&&a%2!=0&&(h=!0);break}}let m=!0;if((s==a&&(o||h)||o&&h&&s+1==a&&a%2!=0||s>a&&s%2!=0)&&(m=!1),!m)return 0;let p,f=a-s+1;if(f%2!=0)if(s%2!=0){let w=r[s],E=w.a1*t.a1;p=(t.a0*w.a1-w.a0*t.a1)/E,i&&r.splice(s,f,t)}else{let w=r[a],E=e.a1*w.a1;p=(w.a0*e.a1-e.a0*w.a1)/E,i&&r.splice(s,f,e)}else if(s%2!=0){let w=r[s],E=r[a],P=w.a1*E.a1;p=(E.a0*w.a1-w.a0*E.a1)/P,i&&r.splice(s,f)}else return i&&r.splice(s,f,e,t),1;let N=e.a1*t.a1,C=(t.a0*e.a1-e.a0*t.a1)/N;return C==0?1:p/C}};var Gt=class extends Co{constructor(e,t){super(),this.lightColor=e,this.lightSourceCastRadius=t,this.workingCalculatedLightColor=new ce(1,1,1,1)}setValues(e,t){this.lightColor=e,this.lightSourceCastRadius=t}calculatedLightedColor(e,t){let i=1-1*e/this.lightSourceCastRadius;return this.workingCalculatedLightColor.set(this.lightColor),this.workingCalculatedLightColor.mul(i*t),this.workingCalculatedLightColor}};var Ao=class extends Gt{constructor(e,t){super(e,t)}tileLighted(e,t,i){e.addDynamicLighting(this.calculatedLightedColor(t,i))}};var Fi=class extends Gt{constructor(e,t){super(e,t)}tileLighted(e,t,i){e.addPositionalLighting(this.calculatedLightedColor(t,i))}};var Po=class extends Gt{constructor(e,t){super(e,t)}tileLighted(e,t,i){e.addEnvironmentLighting(this.calculatedLightedColor(t,i))}};var Ro=class extends z{constructor(e,t){super(),this.worldGrid=e,this.projection=t,this.visibleTileRadius=13,this.lightSourceRadius=7,this.mainPositionalTileRadius=7,this.secondaryPositionalTileRadius=5,this.lightSourceRecalculationFrames=40,this.maxDynamicLightSources=10,this.elapsedFrameCount=this.lightSourceRecalculationFrames,this.dynamicLightSources=[],this.calculatedTile=null,this.shadowCaster=new No(e),this.forceEnvironmentalRecalculation=!1,this.dynamicLightSourceCastCallback=new Ao(new ce(0,0,0,0),5),this.positionalLightSourceCastCallback=new Fi(new ce(0,0,0,1),this.mainPositionalTileRadius),this.secondaryPositionalLightSourceCastCallback=new Fi(new ce(0,0,0,1),this.secondaryPositionalTileRadius),this.environmentalLightSourceCastCallback=new Po(new ce(0,0,0,0),5),this.regionResetLightingCallback=r=>{let s=r.getTiles();for(let o=0;o<s.length;o++)s[o].lighting.resetLighting()};let i=this;this.gridEnvironmentalLightingCallback=r=>{let s=r.getLightSources();if(!(!s||s.length===0))for(let o=0;o<s.length;o++){let a=s[o];if(a.isFinishedAndAvailable())continue;let h=a.getTileRadius();i.environmentalLightSourceCastCallback.setValues(a.getColor(),h),i.shadowCaster.castShadows(a.getTile(),h,i.environmentalLightSourceCastCallback)}}}resetLightingCalculator(){this.dynamicLightSources.length=0}addDynamicLightSource(e){if(!e||e.getTile()==null||e.isFinishedAndAvailable())return;this.dynamicLightSources.push(e);let t=this.dynamicLightSources.length-this.maxDynamicLightSources;t>0&&this.dynamicLightSources.splice(this.maxDynamicLightSources-1,t),console.log("LightingCalculator.addDynamicLightSource() size="+this.dynamicLightSources.length)}removeDynamicLightSource(e){if(!e)return;let t=this.dynamicLightSources.indexOf(e);t!==-1&&this.dynamicLightSources.splice(t,1)}resetForFrame(){ye.allVisibleRegions(this.worldGrid,this.projection,this.regionResetLightingCallback)}calculateEnvironmentLighting(e){this.elapsedFrameCount+=e,(this.forceEnvironmentalRecalculation||this.elapsedFrameCount>=this.lightSourceRecalculationFrames)&&(this.elapsedFrameCount=0,ye.allVisibleGrids(this.worldGrid,this.projection,this.gridEnvironmentalLightingCallback))}calculateDynamicLighting(){if(this.dynamicLightSources.length!==0)for(let e=this.dynamicLightSources.length-1;e>=0;e--){let t=this.dynamicLightSources[e];if(t.isFinishedAndAvailable()){this.dynamicLightSources.splice(e,1);continue}let i=t.getTile();if(!i){this.dynamicLightSources.splice(e,1);continue}let r=t.getTileRadius(),s=i.getOrigin();this.projection.isVisible(s.x+n.tile.halfSize,s.y+n.tile.halfSize,n.tile.size*r)&&(this.dynamicLightSourceCastCallback.setValues(t.getColor(),r),this.shadowCaster.castShadows(i,r,this.dynamicLightSourceCastCallback))}}calculatePrimaryPositionalLighting(e){e&&this.shadowCaster.castShadows(e,this.mainPositionalTileRadius,this.positionalLightSourceCastCallback)}calculateSecondaryPositionalLighting(e){e&&this.shadowCaster.castShadows(e,this.secondaryPositionalTileRadius,this.secondaryPositionalLightSourceCastCallback)}onEnvironmentalLightSourceChange(){this.forceEnvironmentalRecalculation=!0}onWallBroken(){this.forceRecalculation()}forceRecalculation(){this.forceEnvironmentalRecalculation=!0}resetFull(){this.dynamicLightSources.length=0,this.calculatedTile=null,this.forceEnvironmentalRecalculation=!1}resetForPrestige(){this.resetFull()}};var Gi=class{constructor(){this.collisionVector=new b(0,0)}static isStandingOnTileOrigin(e){let t=e.position.tile;if(!t)return!0;let i=e.position.worldCoordinateOrigin;return Z.floor(i.y)===t.origin.y}static isStandingOnTopOfClosedTile(e){let t=e.position.tile;if(!t)return!0;let i=e.position.worldCoordinateOrigin;if(Z.floor(i.y)!==t.origin.y)return!1;let s=t.getNeighborBottom();return s&&!s.isTraversable()}isCollisionDown(e,t){let i=e.position.tile;if(!i)return!0;let r=i.getNeighborBottom();if(!r)return!0;if(r.open)return!1;let s=e.position.worldCoordinateOrigin.y+n.tile.size+t;return i.containsXY(e.position.worldCoordinateOrigin.x,s)?!i.open:r.containsXY(e.position.worldCoordinateOrigin.x,s)?!r.open:!1}};var Mo=class{constructor(e,t,i){this.worldGrid=e,this.projection=t,this.collision=new Gi,this.gameTime=i;let r=this;this.frameTimeRatio=1,this.applyForcesOnCharactersFunction=function(s){for(let o=s.characters.length-1;o>=0;o--){let a=s.characters[o];a.isPartyMember()||a.position.tile&&(a.position.pathPlan.length>0||r.applyGravity(a,r.frameTimeRatio))}}}updatePhysicsForFrame(e){this.frameTimeRatio=e,ye.allVisibleGrids(this.worldGrid,this.projection,this.applyForcesOnCharactersFunction)}applyGravity(e,t){if(Gi.isStandingOnTopOfClosedTile(e)){e.position.setPositionToTileOrigin(),e.position.gravityThisFrame>0&&(e.position.gravityThisFrame=0,e.setCharacterAction(Q.STAND));return}e.position.gravityThisFrame=n.physics.gravityRatePerFrame*t,this.collision.isCollisionDown(e,e.position.gravityThisFrame)?(e.position.setPositionToTileOrigin(),e.position.gravityThisFrame>0&&(e.position.gravityThisFrame=0,e.setCharacterAction(Q.STAND))):(e.position.moveY(e.position.gravityThisFrame),e.setCharacterAction(Q.FALL))}};var _o=class{constructor(e,t,i){this.characterPhysics=new Mo(e,t,i)}updatePhysicsForFrame(e){this.characterPhysics.updatePhysicsForFrame(e)}};var $t=wl(gl());var Vi=class{constructor(){}static generateSave(e){let t={};return t.gridCenter={x:e.gridCenter.x,y:e.gridCenter.y},t.zoom=e.zoom,t.centerOnCharacter=e.stayCenteredOnCharacter,t}static loadSave(e,t){t&&(e.setGridCenter(t.gridCenter.x,t.gridCenter.y),e.setZoom(t.zoom),e.stayCenteredOnCharacter=!1,t.centerOnCharacter&&(e.stayCenteredOnCharacter=!0))}};var Ui=class{constructor(){}static generateSave(e){let t={};return t.v=1,t.seed=e.worldSeed,t}static loadSave(e,t){t&&(e.worldSeed=t.seed)}};var v=class{constructor(){}static save(e){return e?[e.m,e.e]:[0,0]}static load(e,t){e&&t.set(e[0],e[1])}};var ht=class{constructor(){}static generateSave(e){let t={};t.sum=v.save(e.sum),t.startTurn=e.startTurn,t.valuePerTurn=v.save(e.valuePerTurn),t.rateIndex=e.rateIndex,t.rates=[];for(let i=0;i<e.rates.length;i++)t.rates.push(v.save(e.rates[i]));return t}static loadSave(e,t){if(t&&(v.load(t.sum,e.sum),t.startTurn&&(e.startTurn=t.startTurn),v.load(t.valuePerTurn,e.valuePerTurn),e.rateIndex=0,t.rateIndex&&(e.rateIndex=t.rateIndex),t.rates)){e.rates.length=0;for(let i=0;i<t.rates.length;i++){let r=new d(0);v.load(t.rates[i],r),e.rates.push(r)}}}};var Hi=class{constructor(){}static generateSave(e){let t={};return t.ore=v.save(e.ore),t.gold=v.save(e.gold),t.ruby=v.save(e.ruby),t.prestige=v.save(e.prestige),t.prestigeSum=v.save(e.prestigePointsSum),t.unclaimed=v.save(e.unclaimedPrestige),t.prestigePerTurn=v.save(e.prestigePerTurn),t.goldPerTurn=v.save(e.goldPerTurn),t.orePerTurn=v.save(e.orePerTurn),t.rubyPerTurn=v.save(e.rubyPerTurn),t.offlinePrestige=v.save(e.offlinePrestige),t.offlineGold=v.save(e.offlineGold),t.offlineOre=v.save(e.offlineOre),t.offlineRuby=v.save(e.offlineRuby),t.offlineSeconds=e.offlineSeconds,t.countedOfflineSeconds=e.countedOfflineSeconds,t.prestigePerTurnCalc=ht.generateSave(e.prestigeRatePerTurnCalculator),t.goldPerTurnCalc=ht.generateSave(e.goldRatePerTurnCalculator),t.orePerTurnCalc=ht.generateSave(e.oreRatePerTurnCalculator),t.rubyPerTurnCalc=ht.generateSave(e.rubyRatePerTurnCalculator),t}static loadSave(e,t){t&&(v.load(t.ore,e.ore),v.load(t.gold,e.gold),v.load(t.ruby,e.ruby),v.load(t.prestige,e.prestige),v.load(t.prestigeSum,e.prestigePointsSum),v.load(t.unclaimed,e.unclaimedPrestige),v.load(t.prestigePerTurn,e.prestigePerTurn),v.load(t.goldPerTurn,e.goldPerTurn),v.load(t.orePerTurn,e.orePerTurn),v.load(t.rubyPerTurn,e.rubyPerTurn),v.load(t.offlinePrestige,e.offlinePrestige),v.load(t.offlineGold,e.offlineGold),v.load(t.offlineOre,e.offlineOre),v.load(t.offlineRuby,e.offlineRuby),t.offlineSeconds&&(e.offlineSeconds=t.offlineSeconds),t.countedOfflineSeconds&&(e.countedOfflineSeconds=t.countedOfflineSeconds),ht.loadSave(e.prestigeRatePerTurnCalculator,t.prestigePerTurnCalc),ht.loadSave(e.goldRatePerTurnCalculator,t.goldPerTurnCalc),ht.loadSave(e.oreRatePerTurnCalculator,t.orePerTurnCalc),ht.loadSave(e.rubyRatePerTurnCalculator,t.rubyPerTurnCalc))}};var zi=class{constructor(){}static generateSave(e){let t={};return t.turn=e.turnNumber,t.time=Date.now(),t}static loadSave(e,t){t&&(e.turnNumber=t.turn,e.saveTime=t.time)}};var Wi=class{constructor(){}static generateSave(e){let t={};return t.mineDamageMultiplier=v.save(e.minedDamageBonusMultiplier.getValue()),t.mineOreBonus=v.save(e.minedOreBonus.getValue()),t}static loadSave(e,t){t&&(v.load(t.mineDamageMultiplier,e.minedDamageBonusMultiplier.getValue()),v.load(t.mineOreBonus,e.minedOreBonus.getValue()))}};var Yi=class{constructor(){}static generateSave(e){let t={};t.upgrades=[];for(let i=0;i<e.upgrades.length;i++)e.upgrades[i]&&t.upgrades.push(this.generateUpgradeSave(e.upgrades[i]));return t}static loadSave(e,t,i){if(!i){console.log("MinedUpgradeCollectionSave.loadSave no save state");return}let r=i.upgrades;if(!r){console.log("MinedUpgradeCollectionSave.loadSave state empty");return}for(let s=0;s<r.length;s++){let o=this.loadUpgradeSave(t,r[s]);o&&e.addBulk(o)}e.addBulkCompleted()}static generateUpgradeSave(e){let t=e.getCreatorId(),i={};return i.creatorId=t,t===Ot.mineDamage?this.generateFreeValueUpgradeSave(e,i):t===Ot.mineOre?this.generateMinedOreUpgradeSave(e,i):console.log("MinedUpgradeCollectionSave.generateUpgradeSave() No save logic associated with creatorId: "+t),i}static loadUpgradeSave(e,t){if(!t)return null;let i=t.creatorId;if(!i)return null;let r=e.getUpgradeCreatorById(i);return r?i===Ot.mineDamage?this.loadFreeValueUpgradeSave(r,t):i===Ot.mineOre?this.loadMinedOreUpgradeSave(r,t):(console.log("MinedUpgradeCollectionSave.loadUpgradeSave() No save logic associated with creatorId: "+i),null):(console.log("MinedUpgradeCollectionSave.loadUpgradeSave() Failed to find upgrade creator ID="+i),null)}static generateFreeValueUpgradeSave(e,t){e.cost&&(t.cost=v.save(e.cost)),t.value=v.save(e.valueDelta)}static loadFreeValueUpgradeSave(e,t){let i=new d(0);return v.load(t.value,i),e.createFreeValueUpgradeFromSave(i)}static generateMinedOreUpgradeSave(e,t){e.cost&&(t.cost=v.save(e.cost)),t.value=v.save(e.ore)}static loadMinedOreUpgradeSave(e,t){let i=new d(0);return v.load(t.value,i),e.createFreeValueUpgradeFromSave(i)}};var Pi=class{constructor(){}static generateSave(e){let t={};return t.position={x:e.position.worldCoordinateOrigin.x,y:e.position.worldCoordinateOrigin.y},t.facingLeft=e.position.facingLeft,e.skillId&&(t.skillId=e.skillId),t}static loadSave(e,t){t&&(e.position.setWorldCoordinateOriginXY(t.position.x,t.position.y),e.position.facingLeft=t.facingLeft,t.skillId&&(e.skillId=t.skillId))}};var Ki=class{constructor(){}static generateSave(e){let t={};t.miners=[];for(let i=0;i<e.miners.length;i++)t.miners.push(Pi.generateSave(e.miners[i]));return t}static loadSave(e,t){if(!t){console.log("CrewSave.loadSave() No save state. Not loading crew!");return}let i=t.miners;if(!i||i.length===0){console.log("CrewSave.loadSave() No miners data found");return}console.log("CrewSave.loadSave() create main miner");let r=e.createMainMiner();Pi.loadSave(r,i[0]);for(let s=1;s<i.length;s++){let o=e.addNewMinerForSaveLoad();Pi.loadSave(o,i[s])}}};var Lo=class extends z{constructor(e,t){super(),this.totals=e,this.damage=t,this.layerDescription=Ue.DIRT_LAYER,this.nextLayerDescription=this.findNextLayerDescription(),this.defaultMineSeconds=1,this.targetMineSeconds=1,this.targetRow=0,this.minRow=0,this.maxRow=0,this.workingBrickHealth=new d(0),this.halfDeltaRows=15}deriveTargetSecondsForRow(e){if(this.layerDescription.containsRow(e)){this.deriveTargetSecondsInternal(this.layerDescription,e);return}let t=this.layerDescription.prevLayer;if(t&&t.containsRow(e)){this.deriveTargetSecondsInternal(t,e);return}let i=this.layerDescription.nextLayer;if(i&&i.containsRow(e)){this.deriveTargetSecondsInternal(i,e);return}let r=Bl(e);if(r){this.deriveTargetSecondsInternal(r,e);return}console.log("PartyTarget.deriveTargetSecondsForRow() Failed to update target mine seconds")}deriveTargetSecondsInternal(e,t){e.calculateTileHealth(t,this.workingBrickHealth),this.targetMineSeconds=this.damage.calculateMineSeconds(this.workingBrickHealth)}calculateTargetRow(){this.damage.calculateMaxBrickHealth(this.targetMineSeconds,this.workingBrickHealth);let e=kl(this.layerDescription,this.workingBrickHealth);this.targetRow=Math.max(n.target.minTargetRow,e.calculateTileDepth(this.workingBrickHealth)),this.maxRow=this.targetRow+this.halfDeltaRows,this.minRow=this.targetRow-this.halfDeltaRows}setLayerDescriptionFromSave(e){this.layerDescription=e,this.nextLayerDescription=this.findNextLayerDescription(),this.calculateTargetRow()}findNextLayerDescription(){for(let e=0;e<je.length;e++){let t=je[e];if(t.prevLayer===this.layerDescription)return t}return null}unlockNextLayer(){if(!this.nextLayerDescription){console.log("PartyTarget.unlockNextLayer() No next layer!");return}this.layerDescription=this.nextLayerDescription,this.calculateTargetRow(),this.nextLayerDescription=this.findNextLayerDescription(),this.totals.onTerrainLayerUnlocked()}resetFull(){this.layerDescription=Ue.DIRT_LAYER,this.nextLayerDescription=this.findNextLayerDescription(),this.targetMineSeconds=this.defaultMineSeconds,this.calculateTargetRow()}resetForPrestige(){this.resetFull()}};var Xi=class{constructor(){}static generateSave(e){let t={};return t.layerId=e.layerDescription.id,t.targetMineSeconds=e.targetMineSeconds,t}static loadSave(e,t){if(!t)return;t.targetMineSeconds&&(e.targetMineSeconds=t.targetMineSeconds);let i=t.layerId,r=Ol[i];r?e.setLayerDescriptionFromSave(r):console.log("PartyTargetSave.loadSave() Failed to find layer description: "+i)}};var ji=class{constructor(){}static generateSave(e){let t={};t.metaArray=[];for(let i of e.metadataByKey.values()){let r=this.generateMetaState(i);r&&t.metaArray.push(r)}return t}static loadSave(e,t){if(!t){console.log("GridSaveManagerSave.loadSave() no data found in save 1");return}let i=t.metaArray;if(!i||i.length===0){console.log("GridSaveManagerSave.loadSave() no data found in save 2");return}for(let r=0;r<i.length;r++){let s=this.loadMetaState(i[r]);s&&e.addGridSaveMetaFromSave(s)}}static generateMetaState(e){let t={};return t.k=e.gridKey,t.c=e.gridCol,t.r=e.gridRow,t}static loadMetaState(e){return e?new qt(e.k,e.c,e.r):null}};var yo=class{constructor(){}getNextPurchaseCost(e,t){}calculateBulkPurchaseCost(e,t,i){}calculateMaxAffordable(e,t){return 0}};var Ge={purchaseOne:1,purchaseFive:5,purchaseTen:10,purchaseMax:-1};var Ri=class extends mi{constructor(e,t,i,r,s){super(t,i),this.id=e,this.costCalculator=r,this.maxCount=s,this.singlePurchaseCost=new d(0),this.cost=new d(0),this.countToPurchase=Ge.purchaseOne,this.countToPurchaseUsedInCalculation=Ge.purchaseOne,this.maxAffordableCount=0,this.nextActualPurchaseCount=0,this.workingCost=new d(0)}initializeCosts(){this.calculateCostsAfterCountChange()}isVisible(){return!0}isMaxCountReached(){let e=this.getMaxPurchaseCount();return e>0&&this.purchasedCount>=e}getMaxPurchaseCount(){return this.maxCount}getPurchasedCount(){return this.purchasedCount}setPurchasedCount(e){this.purchasedCount=this.maxCount>0?Math.min(this.maxCount,e):e,this.calculateCostsAfterCountChange()}setPurchasedCountFromSave(e){this.setPurchasedCount(e),this.onUpgradePurchased(0,this.purchasedCount)}getSinglePurchaseCost(){return this.singlePurchaseCost}getCostForActualCount(e,t){return e<=0?(t.setZero(),t):e===1?(t.copy(this.singlePurchaseCost),t):this.costCalculator.calculateBulkPurchaseCost(this.singlePurchaseCost,e,t)}getPurchaseCountNumber(){return this.getActualCountToPurchase(this.getCountToPurchaseSetting())}getActualCountToPurchase(e){if(e===Ge.purchaseMax)return this.maxAffordableCount;{let t=this.getMaxPurchaseCount(),i=this.getPurchasedCount();return i+e<=t?e:t-i}}purchaseAmount(e){return this.purchaseActualAmount(this.getActualCountToPurchase(e))}purchaseActualAmount(e){let t=this.getMaxPurchaseCount(),i=this.getPurchasedCount();if(t>0&&i>=t)return!1;t>0&&e+i>t&&(e=t-i);let r=this.getCostForActualCount(e,this.workingCost);return r.lessThanEqualsZero()||r.greaterThan(this.getMoney())?!1:(this.decrementMoney(r),this.onUpgradePurchased(i,e),this.setPurchasedCount(i+e),!0)}calculateCostsAfterCountChange(){this.costCalculator.getNextPurchaseCost(this.getPurchasedCount(),this.singlePurchaseCost);let e=this.getCountToPurchaseSetting();e===Ge.purchaseMax?(this.recalculateMaxPurchaseCount(),this.nextActualPurchaseCount=this.maxAffordableCount):(this.nextActualPurchaseCount=this.getActualCountToPurchase(e),this.cost=this.getCostForActualCount(this.nextActualPurchaseCount,this.cost))}recalculateMaxPurchaseCount(){let e=this.getMoney();if(this.maxAffordableCount=this.costCalculator.calculateMaxAffordable(e,this.singlePurchaseCost),this.maxAffordableCount>0){let t=this.getPurchasedCount(),i=this.getMaxPurchaseCount();if(i>0&&t+this.maxAffordableCount>i&&(this.maxAffordableCount=Math.max(0,i-t),this.maxAffordableCount===0)){this.cost.copy(this.singlePurchaseCost);return}this.cost=this.costCalculator.calculateBulkPurchaseCost(this.singlePurchaseCost,this.maxAffordableCount,this.cost)}else this.cost.copy(this.singlePurchaseCost)}getCountToPurchaseSetting(){return this.countToPurchase}getMoney(){}decrementMoney(e){}onUpgradePurchased(e,t){}isPurchasable(){return this.isAffordable()&&!this.isMaxCountReached()}isAffordable(){return this.cost.lessThanEquals(this.getMoney())}getCost(){let e=this.getCountToPurchaseSetting();return this.countToPurchaseUsedInCalculation!==e?(this.countToPurchaseUsedInCalculation=e,this.calculateCostsAfterCountChange()):e===Ge.purchaseMax&&this.calculateCostsAfterCountChange(),this.cost}purchase(){return this.purchaseAmount(this.getCountToPurchaseSetting())}resetUpgrade(){super.resetUpgrade(),this.calculateCostsAfterCountChange()}};var Mi=class extends pi{constructor(){super(),this.countToPurchase=Ge.purchaseOne}setCountToPurchase(e){if(this.countToPurchase!==e){this.countToPurchase=e;for(let t=0;t<this.upgrades.length;t++)this.upgrades[t].countToPurchase=e}}initializeUpgrades(e,t,i){}findById(e){for(let t=0;t<this.upgrades.length;t++){let i=this.upgrades[t];if(i.id===e)return i}return null}resetFull(){for(let e=0;e<this.upgrades.length;e++)this.upgrades[e].resetUpgrade()}};var _i=class extends yo{constructor(e,t){super(),this.baseCost=e,this.costGrowthRate=new d(t),this.working=new d(0),this.working2=new d(0),this.one=new d(1),this.logCostFactor=Math.log(t)}getNextPurchaseCost(e,t){t.copy(this.costGrowthRate).pow(e).multiply(this.baseCost)}calculateBulkPurchaseCost(e,t,i){return this.working.copy(this.costGrowthRate),this.working.pow(t).sub(this.one),this.working2.copy(this.costGrowthRate),this.working2.sub(this.one),this.working.divide(this.working2),i.copy(e).multiply(this.working),i}calculateMaxAffordable(e,t){return t.greaterThan(e)?0:(this.working.copy(this.costGrowthRate).sub(this.one),this.working.multiply(e).divide(t),this.working.add(this.one),this.working.ln()/this.logCostFactor|0)}};var ol={FREE:"free",ORE:"Ore",GOLD:"Gold",PRESTIGE:"Prestige"};var Zi=class extends Ri{constructor(e,t,i,r,s,o,a,h,m,p,f,N){super(e,t,i,r,f),this.totals=s,this.mineDamageLogic=o,this.upgradeBonusValue=a,this.valuePerUpgrade=h,this.dependentUpgrade=m,this.requiredPurchaseCount=p,this.workingValue=new d(0),this.additiveUpgrade=N,this.initializeCosts()}isVisible(){return!(this.purchasedCount>=this.maxCount||this.dependentUpgrade&&this.dependentUpgrade.purchasedCount<this.requiredPurchaseCount)}getCostUnit(){return ol.ORE}getMoney(){return this.totals.ore}decrementMoney(e){this.totals.decrementOre(e)}onUpgradePurchased(e,t){this.workingValue.copy(this.valuePerUpgrade),t>1&&this.workingValue.mulNumber(t),this.upgradeBonusValue.incrementValue(this.workingValue),this.mineDamageLogic.calculateTotalMineDamagePerTurn()}};var bo=class extends Mi{constructor(e,t,i){super(),this.initializeUpgrades(e,t,i)}initializeUpgrades(e,t,i){let r=null;for(let s=0;s<100;s++)r=this.generateBaseDamageUpgrade(s,e,t,i,r);r=null;for(let s=1;s<100;s++)r=this.generateMultiplicativeUpgrade(s,e,t,i,r);this.addBulkCompleted()}generateMultiplicativeUpgrade(e,t,i,r,s){let o=e<10?.05:e<20?.1:e<30?.2:e<40?.35:e<50?.45:e<60?.7:e<70?1:e<80?1.35:e<90?1.75:2,a=new d(o*e),h=this.createCostCalculator(e),m="Multiplier: +"+I.formatBigNum(a),p=new Zi("m"+e,m,c.pick,h,t,r,i.baseMultiplicativeBonusValue,a,s,20,150,!1);return this.addBulk(p),p}generateBaseDamageUpgrade(e,t,i,r,s){let h=e+.01,m=new d(1.35);m.pow(h*2.5);let p=new d(0);p.copy(m),p.mulNumber(n.time.turnsPerSecond);let f=I.formatBigNum(p),N=this.createCostCalculator(e+1);console.log("PICK BASE: i="+e+" perTurn="+I.formatBigNum(m)+" perSec="+f);let T=new Zi("add"+e,"Base: +"+f+"/sec",c.pick,N,t,r,i.baseAdditiveBonusPerTurn,m,s,20,150,!0);return this.addBulk(T),T}createCostCalculator(e){let s=Math.max(1,Math.floor(Math.pow(2,e*4.4)));return new _i(new d(s),1.1)}resetForPrestige(){this.resetFull()}};var qi=class{constructor(){}static generateSave(e){let t={};t.upgrades=[];for(let i=0;i<e.upgrades.length;i++){let r=this.generateUpgradeSave(e.upgrades[i]);r&&t.upgrades.push(r)}return t.countToPurchase=e.countToPurchase,t}static loadSave(e,t){if(!t){console.log("PickUpgradeCollectionSave.loadSave no save state");return}if(!t.upgrades){console.log("PickUpgradeCollectionSave.loadSave state empty");return}for(let s=0;s<t.upgrades.length;s++)this.loadUpgradeSave(e,t.upgrades[s]);let r=t.countToPurchase;r&&e.setCountToPurchase(r)}static generateUpgradeSave(e){if(e.purchasedCount===0)return null;let t={};return t.id=e.id,t.c=e.purchasedCount,t}static loadUpgradeSave(e,t){if(!t)return;let i=t.id,r=e.findById(i);if(!r){console.log("PickUpgradeCollectionSave.loadUpgradeSave() failed to find upgrade id="+i);return}let s=t.c;s!==void 0&&r.setPurchasedCountFromSave(s)}};var Jt=class{constructor(){}static generateSave(e){let t={};return t.ore=v.save(e.totalOre),t.gold=v.save(e.totalGold),t.ruby=v.save(e.totalRuby),t.prestige=v.save(e.totalPrestigePoints),t.upgradeOre=v.save(e.upgradeOre),t.maxDepth=e.maxDepth,t.turns=e.totalTurns,t.tiles=v.save(e.tilesMined),t.tilesCommon=v.save(e.tilesMinedCommon),t.tilesOre=v.save(e.tilesMinedOre),t.tilesGold=v.save(e.tilesMinedGold),t.tilesRuby=v.save(e.tilesMinedRuby),t.tilesUpgrade=v.save(e.tilesMinedUpgrade),t.tilesLaser=v.save(e.tilesMinedLaser),t.tilesDrill=v.save(e.tilesMinedDrill),t.tilesOrbit=v.save(e.tilesMinedOrbit),t.tilesFissure=v.save(e.tilesMinedFissure),t.tilesLightning=v.save(e.tilesMinedLightning),t.tilesMissile=v.save(e.tilesMinedMissile),t}static loadSave(e,t){t&&(v.load(t.ore,e.totalOre),v.load(t.gold,e.totalGold),v.load(t.ruby,e.totalRuby),v.load(t.prestige,e.totalPrestigePoints),v.load(t.upgradeOre,e.upgradeOre),t.maxDepth&&(e.maxDepth=t.maxDepth),t.turns&&(e.totalTurns=t.turns),v.load(t.tiles,e.tilesMined),v.load(t.tilesCommon,e.tilesMinedCommon),v.load(t.tilesOre,e.tilesMinedOre),v.load(t.tilesGold,e.tilesMinedGold),v.load(t.tilesRuby,e.tilesMinedRuby),v.load(t.tilesUpgrade,e.tilesMinedUpgrade),v.load(t.tilesLaser,e.tilesMinedLaser),v.load(t.tilesDrill,e.tilesMinedDrill),v.load(t.tilesOrbit,e.tilesMinedOrbit),v.load(t.tilesFissure,e.tilesMinedFissure),v.load(t.tilesLightning,e.tilesMinedLightning),v.load(t.tilesMissile,e.tilesMinedMissile))}};var Io=class extends z{constructor(){super()}onNodePurchased(e){}onNodePurchasedFromSave(){}};var He=class extends z{constructor(e,t,i,r,s,o,a){super(),this.parents=null,this.children=null,this.id=e,this.totals=r,this.title=t,this.description=i,this.iconFileName=s,this.cost=o,this.graphCoordinate=new b(0,0),this.viewCoordinate=new b(0,0),this.nodeVisible=!0,this.purchaseListener=a,this.parentNodePurchased=!1,this.purchased=!1}getTitle(){return this.title}getDescription(){return this.description}setPosition(e,t){this.graphCoordinate.set(n.skillGraph.cellWidth*e,n.skillGraph.cellHeight*t)}getCost(){return this.cost}addParentNode(e){this.parents||(this.parents=[]),this.parents.push(e)}addChildNode(e){this.children||(this.children=[]),this.children.push(e),e.addParentNode(this)}isAffordable(){return this.cost.lessThanEquals(this.totals.prestige)}isPurchasable(){return this.purchased||!this.isAffordable()?!1:!this.parents||this.parents.length===0?!0:this.parentNodePurchased}onPurchase(){return this.purchased?(console.log("SkillNode.onPurchase() node already purchased"),!1):this.isAffordable()?(this.purchased=!0,this.totals.decrementPrestige(this.cost),this.purchaseListener.onNodePurchased(this.cost),this.setChildrenParentNodePurchased(),!0):(console.log("SkillNode.onPurchase() not affordable"),!1)}onPurchaseFromSave(){if(this.purchased)return console.log("SkillNode.onPurchaseFromSave() node already purchased"),!1;this.purchased=!0,this.purchaseListener.onNodePurchasedFromSave(),this.setChildrenParentNodePurchased()}onSaveLoad(){this.purchased&&this.setChildrenParentNodePurchased()}setChildrenParentNodePurchased(){if(this.children)for(let e=0;e<this.children.length;e++)this.children[e].parentNodePurchased=!0}resetFull(){this.parentNodePurchased=!1,this.purchased=!1}resetForPrestige(){}};var fe=class extends He{constructor(e,t,i,r,s,o,a,h,m){super(e,t,i,r,s,o,a),this.valuePerSkillLevel=h,this.numberValue=m}onPurchase(){return super.onPurchase()?(this.numberValue.incrementValue(this.valuePerSkillLevel),!0):!1}onPurchaseFromSave(){this.numberValue.incrementValue(this.valuePerSkillLevel),super.onPurchaseFromSave()}resetFull(){super.resetFull(),this.numberValue.reset()}};var Re=class extends fe{constructor(e,t,i,r,s,o){super(e,"Delay -"+n.automation.secondsPerRateUpgrade+" sec",null,t,i,r,s,1,o)}getDescription(){let e=n.automation.baseUpgradeDelayTurns,t=n.automation.turnsPerRateUpgrade*this.numberValue.getValue(),i=Math.max(n.automation.minDelayTurns,e-t);return"Current Delay: "+I.formatNumber(i*n.time.secondsPerTurn)+"s"}};var ne={MISSILE:"missile",LASER:"laser",DRILL:"drill",ORBIT:"orbit",FISSURE:"fissure",LIGHTNING:"lightning",CHAIN:"chain",DYNAMITE:"dynamite",ORE_BONUS:"oreBonus",UPGRADE_BONUS_MULTIPLICATIVE:"upgradeBonusMult",UPGRADE_BONUS_ADDITIVE:"upgradeBonusAdd",PRESTIGE_BONUS:"prestigeBonus",DEPTH_BONUS:"depthBonus",OFFLINE_BONUS:"offlineBonus",MINED_AUTOMATION:"minedAutomation",PICK_AUTOMATION:"pickAutomation",PRESTIGE_AUTOMATION:"prestigeAutomation"};var nt=class{constructor(){this.screenCoordinate=new b(0,0)}renderSkill(e,t){}renderSprite(e,t,i,r){if(!i)return;let s=i.getSize(),o=n.tile.size*t.zoom;e.drawImage(i.getImage(),i.spriteX,i.spriteY,s,s,r.x,r.y,o,o)}};var Ne=class extends Io{constructor(e){super(),this.id=e,this.rootNode=null,this.nodes=[],this.unlocked=!1,this.durationUpgrades=new we(null,0),this.coolDownUpgrades=new we(null,0),this.pointsSpent=new d(0)}addNode(e){return this.rootNode||(this.rootNode=e),this.nodes.push(e),e}getRootNode(){return this.rootNode}isUnlocked(){return this.unlocked}getRenderer(){return null}updateSkillForFrame(e,t,i){}getSkillNodeById(e){for(let t=0;t<this.nodes.length;t++){let i=this.nodes[t];if(e===i.id)return i}return null}onSaveLoad(){for(let e=0;e<this.nodes.length;e++)this.nodes[e].onSaveLoad()}onNodePurchased(e){this.unlocked=!0,this.pointsSpent.add(e)}onNodePurchasedFromSave(){this.unlocked=!0}resetFull(){this.unlocked=!1,this.pointsSpent.setZero();for(let e=0;e<this.nodes.length;e++)this.nodes[e].resetFull();this.coolDownUpgrades.reset(),this.durationUpgrades.reset()}resetForPrestige(){}};var vo=class extends He{constructor(e,t,i,r,s,o,a){super(e,t,i,r,s,o,a)}};var Vt=class extends vo{constructor(e,t,i,r,s,o,a,h){super(e,t,i,r,s,o,a),this.unlockValue=h}onPurchase(){return super.onPurchase()?(this.unlockValue.setValue(!0),!0):!1}onPurchaseFromSave(){super.onPurchaseFromSave(),this.unlockValue.setValue(!0)}};var xo=class extends Ne{constructor(e,t){super(ne.MINED_AUTOMATION),this.values=t;let i=5,r=5,s=this.addNode(new Vt("minedAutomationUnlock","Auto Claim","Mined Upgrades",e,c.pick,new d(r),this,this.values.minedAutomationUnlocked));r+=i;let o=this.addNode(new Re("minedAutomationBonus1",e,c.pick,new d(r),this,this.values.minedAutomationRateUpgrades));r+=i;let a=this.addNode(new Re("minedAutomationBonus2",e,c.pick,new d(r),this,this.values.minedAutomationRateUpgrades));r+=i;let h=this.addNode(new Re("minedAutomationBonus3",e,c.pick,new d(r),this,this.values.minedAutomationRateUpgrades));r+=i;let m=this.addNode(new Re("minedAutomationBonus4",e,c.pick,new d(r),this,this.values.minedAutomationRateUpgrades));r+=i;let p=this.addNode(new Re("minedAutomationBonus5",e,c.pick,new d(r),this,this.values.minedAutomationRateUpgrades));r+=i;let f=this.addNode(new Re("minedAutomationBonus6",e,c.pick,new d(r),this,this.values.minedAutomationRateUpgrades));r+=i;let N=this.addNode(new Re("minedAutomationBonus7",e,c.pick,new d(r),this,this.values.minedAutomationRateUpgrades));r+=i;let T=this.addNode(new Re("minedAutomationBonus8",e,c.pick,new d(r),this,this.values.minedAutomationRateUpgrades));r+=i;let C=this.addNode(new Re("minedAutomationBonus9",e,c.pick,new d(r),this,this.values.minedAutomationRateUpgrades));r+=i;let w=this.addNode(new Re("minedAutomationBonus10",e,c.pick,new d(r),this,this.values.minedAutomationRateUpgrades));r+=i;let E=this.addNode(new Re("minedAutomationBonus11",e,c.pick,new d(r),this,this.values.minedAutomationRateUpgrades));r+=i;let P=this.addNode(new Re("minedAutomationBonus12",e,c.pick,new d(r),this,this.values.minedAutomationRateUpgrades));s.addChildNode(o),o.addChildNode(a),a.addChildNode(h),h.addChildNode(m),m.addChildNode(p),p.addChildNode(f),f.addChildNode(N),N.addChildNode(T),T.addChildNode(C),C.addChildNode(w),w.addChildNode(E),E.addChildNode(P);let S=-1,A=5;s.setPosition(S,A),o.setPosition(S-1,A),a.setPosition(S-2,A),h.setPosition(S-3,A),m.setPosition(S-4,A),p.setPosition(S-5,A),f.setPosition(S-6,A),N.setPosition(S-6,A-1),T.setPosition(S-5,A-1),C.setPosition(S-4,A-1),w.setPosition(S-3,A-1),E.setPosition(S-2,A-1),P.setPosition(S-1,A-1)}};var Do=class extends Ne{constructor(e,t){super(ne.PICK_AUTOMATION),this.values=t;let i=5,r=5,s=this.addNode(new Vt("pickAutomationUnlock","Auto Purchase","Ore Upgrades",e,c.pick,new d(r),this,this.values.pickAutomationUnlocked));r+=i;let o=this.addNode(new Re("pickAutomationBonus1",e,c.pick,new d(r),this,this.values.pickAutomationRateUpgrades));r+=i;let a=this.addNode(new Re("pickAutomationBonus2",e,c.pick,new d(r),this,this.values.pickAutomationRateUpgrades));r+=i;let h=this.addNode(new Re("pickAutomationBonus3",e,c.pick,new d(r),this,this.values.pickAutomationRateUpgrades));r+=i;let m=this.addNode(new Re("pickAutomationBonus4",e,c.pick,new d(r),this,this.values.pickAutomationRateUpgrades));r+=i;let p=this.addNode(new Re("pickAutomationBonus5",e,c.pick,new d(r),this,this.values.pickAutomationRateUpgrades));r+=i;let f=this.addNode(new Re("pickAutomationBonus6",e,c.pick,new d(r),this,this.values.pickAutomationRateUpgrades));r+=i;let N=this.addNode(new Re("pickAutomationBonus7",e,c.pick,new d(r),this,this.values.pickAutomationRateUpgrades));r+=i;let T=this.addNode(new Re("pickAutomationBonus8",e,c.pick,new d(r),this,this.values.pickAutomationRateUpgrades));r+=i;let C=this.addNode(new Re("pickAutomationBonus9",e,c.pick,new d(r),this,this.values.pickAutomationRateUpgrades));r+=i;let w=this.addNode(new Re("pickAutomationBonus10",e,c.pick,new d(r),this,this.values.pickAutomationRateUpgrades));r+=i;let E=this.addNode(new Re("pickAutomationBonus11",e,c.pick,new d(r),this,this.values.pickAutomationRateUpgrades));r+=i;let P=this.addNode(new Re("pickAutomationBonus12",e,c.pick,new d(r),this,this.values.pickAutomationRateUpgrades));s.addChildNode(o),o.addChildNode(a),a.addChildNode(h),h.addChildNode(m),m.addChildNode(p),p.addChildNode(f),f.addChildNode(N),N.addChildNode(T),T.addChildNode(C),C.addChildNode(w),w.addChildNode(E),E.addChildNode(P);let S=-1,A=8;s.setPosition(S,A),o.setPosition(S-1,A),a.setPosition(S-2,A),h.setPosition(S-3,A),m.setPosition(S-4,A),p.setPosition(S-5,A),f.setPosition(S-6,A),N.setPosition(S-6,A-1),T.setPosition(S-5,A-1),C.setPosition(S-4,A-1),w.setPosition(S-3,A-1),E.setPosition(S-2,A-1),P.setPosition(S-1,A-1)}};var Ze=class extends fe{constructor(e,t,i,r,s,o){super(e,"Delay -"+n.automation.minutesPerPrestigeRateUpgrade+" min",null,t,i,r,s,1,o)}getDescription(){let e=n.automation.prestigeUpgradeDelayTurns,t=n.automation.prestigeTurnsPerRateUpgrade*this.numberValue.getValue(),i=Math.max(n.automation.minDelayTurns,e-t);return"Current Delay: "+I.formatNumber(i*n.time.secondsPerTurn/60)+"m"}};var Oo=class extends Ne{constructor(e,t){super(ne.PRESTIGE_AUTOMATION),this.values=t;let i=5,r=10,s=this.addNode(new Vt("prestigeAutomationUnlock","Auto Prestige","Earn Prestige",e,c.currency.prestige,new d(r),this,this.values.prestigeAutomationUnlocked));r+=i;let o=this.addNode(new Ze("prestigeAutomationBonus1",e,c.currency.prestige,new d(r),this,this.values.prestigeAutomationRateUpgrades));r+=i;let a=this.addNode(new Ze("prestigeAutomationBonus2",e,c.currency.prestige,new d(r),this,this.values.prestigeAutomationRateUpgrades));r+=i;let h=this.addNode(new Ze("prestigeAutomationBonus3",e,c.currency.prestige,new d(r),this,this.values.prestigeAutomationRateUpgrades));r+=i;let m=this.addNode(new Ze("prestigeAutomationBonus4",e,c.currency.prestige,new d(r),this,this.values.prestigeAutomationRateUpgrades));r+=i;let p=this.addNode(new Ze("prestigeAutomationBonus5",e,c.currency.prestige,new d(r),this,this.values.prestigeAutomationRateUpgrades));r+=i;let f=this.addNode(new Ze("prestigeAutomationBonus6",e,c.currency.prestige,new d(r),this,this.values.prestigeAutomationRateUpgrades));r+=i;let N=this.addNode(new Ze("prestigeAutomationBonus7",e,c.currency.prestige,new d(r),this,this.values.prestigeAutomationRateUpgrades));r+=i;let T=this.addNode(new Ze("prestigeAutomationBonus8",e,c.currency.prestige,new d(r),this,this.values.prestigeAutomationRateUpgrades));r+=i;let C=this.addNode(new Ze("prestigeAutomationBonus9",e,c.currency.prestige,new d(r),this,this.values.prestigeAutomationRateUpgrades));r+=i;let w=this.addNode(new Ze("prestigeAutomationBonus10",e,c.currency.prestige,new d(r),this,this.values.prestigeAutomationRateUpgrades));r+=i;let E=this.addNode(new Ze("prestigeAutomationBonus11",e,c.currency.prestige,new d(r),this,this.values.prestigeAutomationRateUpgrades));r+=i;let P=this.addNode(new Ze("prestigeAutomationBonus12",e,c.currency.prestige,new d(r),this,this.values.prestigeAutomationRateUpgrades));s.addChildNode(o),o.addChildNode(a),a.addChildNode(h),h.addChildNode(m),m.addChildNode(p),p.addChildNode(f),f.addChildNode(N),N.addChildNode(T),T.addChildNode(C),C.addChildNode(w),w.addChildNode(E),E.addChildNode(P);let S=-1,A=11;s.setPosition(S,A),o.setPosition(S-1,A),a.setPosition(S-2,A),h.setPosition(S-3,A),m.setPosition(S-4,A),p.setPosition(S-5,A),f.setPosition(S-6,A),N.setPosition(S-6,A-1),T.setPosition(S-5,A-1),C.setPosition(S-4,A-1),w.setPosition(S-3,A-1),E.setPosition(S-2,A-1),P.setPosition(S-1,A-1)}};var De=class extends He{constructor(e,t,i,r,s,o,a,h){super(e,"Depth Damage +"+I.formatNumber(n.depth.baseBonusPerUpgrade+n.depth.incrementBonusPerUpgrade*h),null,t,i,r,s),this.values=o,this.mineDamageLogic=a,this.purchaseIndex=h}getDescription(){let e=this.values.skillDepthBonusMultiplier.getValue();return e===0?"Damage / Max Depth: 0":"Damage / Max Depth: x"+I.formatNumber(e)}onPurchase(){return super.onPurchase()?(this.applyUpgrade(),this.mineDamageLogic.calculateTotalMineDamagePerTurn(),!0):!1}onPurchaseFromSave(){this.applyUpgrade(),super.onPurchaseFromSave()}applyUpgrade(){let e=n.depth.baseBonusPerUpgrade+n.depth.incrementBonusPerUpgrade*this.purchaseIndex;this.values.skillDepthBonusMultiplier.incrementValue(e)}};var Bo=class extends Ne{constructor(e,t,i){super(ne.DEPTH_BONUS),this.values=t;let r=20,s=20,o=0,a=this.addNode(new De("depthBonus1",e,c.currency.depth,new d(s),this,this.values,i,o));s+=r,o++;let h=this.addNode(new De("depthBonus2",e,c.currency.depth,new d(s),this,this.values,i,o));s+=r,o++;let m=this.addNode(new De("depthBonus3",e,c.currency.depth,new d(s),this,this.values,i,o));s+=r,o++;let p=this.addNode(new De("depthBonus4",e,c.currency.depth,new d(s),this,this.values,i,o));s+=r,o++;let f=this.addNode(new De("depthBonus5",e,c.currency.depth,new d(s),this,this.values,i,o));s+=r,o++;let N=this.addNode(new De("depthBonus6",e,c.currency.depth,new d(s),this,this.values,i,o));s+=r,o++;let T=this.addNode(new De("depthBonus7",e,c.currency.depth,new d(s),this,this.values,i,o));s+=r,o++;let C=this.addNode(new De("depthBonus8",e,c.currency.depth,new d(s),this,this.values,i,o));s+=r,o++;let w=this.addNode(new De("depthBonus9",e,c.currency.depth,new d(s),this,this.values,i,o));s+=r,o++;let E=this.addNode(new De("depthBonus10",e,c.currency.depth,new d(s),this,this.values,i,o));s+=r,o++;let P=this.addNode(new De("depthBonus11",e,c.currency.depth,new d(s),this,this.values,i,o));s+=r,o++;let S=this.addNode(new De("depthBonus12",e,c.currency.depth,new d(s),this,this.values,i,o));s+=r,o++;let A=this.addNode(new De("depthBonus13",e,c.currency.depth,new d(s),this,this.values,i,o));s+=r,o++;let _=this.addNode(new De("depthBonus14",e,c.currency.depth,new d(s),this,this.values,i,o));s+=r,o++;let L=this.addNode(new De("depthBonus15",e,c.currency.depth,new d(s),this,this.values,i,o));s+=r,o++;let W=this.addNode(new De("depthBonus16",e,c.currency.depth,new d(s),this,this.values,i,o));s+=r,o++;let x=this.addNode(new De("depthBonus17",e,c.currency.depth,new d(s),this,this.values,i,o));s+=r,o++;let J=this.addNode(new De("depthBonus18",e,c.currency.depth,new d(s),this,this.values,i,o));s+=r,o++;let ie=this.addNode(new De("depthBonus19",e,c.currency.depth,new d(s),this,this.values,i,o));s+=r,o++;let Y=this.addNode(new De("depthBonus20",e,c.currency.depth,new d(s),this,this.values,i,o));s+=r,o++;let X=this.addNode(new De("depthBonus21",e,c.currency.depth,new d(s),this,this.values,i,o));a.addChildNode(h),h.addChildNode(m),m.addChildNode(p),p.addChildNode(f),f.addChildNode(N),N.addChildNode(T),T.addChildNode(C),C.addChildNode(w),w.addChildNode(E),E.addChildNode(P),P.addChildNode(S),S.addChildNode(A),A.addChildNode(_),_.addChildNode(L),L.addChildNode(W),W.addChildNode(x),x.addChildNode(J),J.addChildNode(ie),ie.addChildNode(Y),Y.addChildNode(X);let B=4,k=-7;a.setPosition(B,k),h.setPosition(B+1,k),m.setPosition(B+2,k),p.setPosition(B+3,k),f.setPosition(B+4,k),N.setPosition(B+5,k),T.setPosition(B+6,k),C.setPosition(B+6,k-1),w.setPosition(B+5,k-1),E.setPosition(B+4,k-1),P.setPosition(B+3,k-1),S.setPosition(B+2,k-1),A.setPosition(B+1,k-1),_.setPosition(B,k-1),L.setPosition(B,k-2),W.setPosition(B+1,k-2),x.setPosition(B+2,k-2),J.setPosition(B+3,k-2),ie.setPosition(B+4,k-2),Y.setPosition(B+5,k-2),X.setPosition(B+6,k-2)}};var et=class{constructor(){}static formatElapsedTime(e){if(e<0)return"Error: negative time";let t=e/36e5|0,i=e/6e4%60|0,r=e/1e3%60|0;return(t<10?"0":"")+t+":"+(i<10?"0":"")+i+":"+(r<10?"0":"")+r}static formatElapsedTimeNoHours(e){if(e<0)return"Error: negative time";let t=e/36e5|0,i=e/6e4%60|0,r=e/1e3%60|0;return t>0?(t<10?"0":"")+t+":"+(i<10?"0":"")+i+":"+(r<10?"0":"")+r:(i<10?"0":"")+i+":"+(r<10?"0":"")+r}};var Oe=class extends He{constructor(e,t,i,r,s,o){super(e,"Offline +"+n.offline.minutesPerUpgrade+" min",null,t,i,r,s),this.values=o}getDescription(){let t=(n.offline.defaultOfflineMinutes+this.values.offlineTimeUpgrades.getValue()*n.offline.minutesPerUpgrade)*60*1e3;return"Offline Time: "+et.formatElapsedTime(t)}onPurchase(){return super.onPurchase()?(this.applyUpgrade(),!0):!1}onPurchaseFromSave(){this.applyUpgrade(),super.onPurchaseFromSave()}applyUpgrade(){this.values.offlineTimeUpgrades.incrementValue(1)}};var ko=class extends Ne{constructor(e,t){super(ne.OFFLINE_BONUS),this.values=t;let i=10,r=10,s=this.addNode(new Oe("offlineBonus1",e,c.offline,new d(r),this,this.values));r+=i;let o=this.addNode(new Oe("offlineBonus2",e,c.offline,new d(r),this,this.values));r+=i;let a=this.addNode(new Oe("offlineBonus3",e,c.offline,new d(r),this,this.values));r+=i;let h=this.addNode(new Oe("offlineBonus4",e,c.offline,new d(r),this,this.values));r+=i;let m=this.addNode(new Oe("offlineBonus5",e,c.offline,new d(r),this,this.values));r+=i;let p=this.addNode(new Oe("offlineBonus6",e,c.offline,new d(r),this,this.values));r+=i;let f=this.addNode(new Oe("offlineBonus7",e,c.offline,new d(r),this,this.values));r+=i;let N=this.addNode(new Oe("offlineBonus8",e,c.offline,new d(r),this,this.values));r+=i;let T=this.addNode(new Oe("offlineBonus9",e,c.offline,new d(r),this,this.values));r+=i;let C=this.addNode(new Oe("offlineBonus10",e,c.offline,new d(r),this,this.values));r+=i;let w=this.addNode(new Oe("offlineBonus11",e,c.offline,new d(r),this,this.values));r+=i;let E=this.addNode(new Oe("offlineBonus12",e,c.offline,new d(r),this,this.values));r+=i;let P=this.addNode(new Oe("offlineBonus13",e,c.offline,new d(r),this,this.values));r+=i;let S=this.addNode(new Oe("offlineBonus14",e,c.offline,new d(r),this,this.values));r+=i;let A=this.addNode(new Oe("offlineBonus15",e,c.offline,new d(r),this,this.values));r+=i;let _=this.addNode(new Oe("offlineBonus16",e,c.offline,new d(r),this,this.values));r+=i;let L=this.addNode(new Oe("offlineBonus17",e,c.offline,new d(r),this,this.values));r+=i;let W=this.addNode(new Oe("offlineBonus18",e,c.offline,new d(r),this,this.values));r+=i;let x=this.addNode(new Oe("offlineBonus19",e,c.offline,new d(r),this,this.values));r+=i;let J=this.addNode(new Oe("offlineBonus20",e,c.offline,new d(r),this,this.values));r+=i;let ie=this.addNode(new Oe("offlineBonus21",e,c.offline,new d(r),this,this.values));s.addChildNode(o),o.addChildNode(a),a.addChildNode(h),h.addChildNode(m),m.addChildNode(p),p.addChildNode(f),f.addChildNode(N),N.addChildNode(T),T.addChildNode(C),C.addChildNode(w),w.addChildNode(E),E.addChildNode(P),P.addChildNode(S),S.addChildNode(A),A.addChildNode(_),_.addChildNode(L),L.addChildNode(W),W.addChildNode(x),x.addChildNode(J),J.addChildNode(ie);let Y=4,X=-11;s.setPosition(Y,X),o.setPosition(Y+1,X),a.setPosition(Y+2,X),h.setPosition(Y+3,X),m.setPosition(Y+4,X),p.setPosition(Y+5,X),f.setPosition(Y+6,X),N.setPosition(Y+6,X-1),T.setPosition(Y+5,X-1),C.setPosition(Y+4,X-1),w.setPosition(Y+3,X-1),E.setPosition(Y+2,X-1),P.setPosition(Y+1,X-1),S.setPosition(Y,X-1),A.setPosition(Y,X-2),_.setPosition(Y+1,X-2),L.setPosition(Y+2,X-2),W.setPosition(Y+3,X-2),x.setPosition(Y+4,X-2),J.setPosition(Y+5,X-2),ie.setPosition(Y+6,X-2)}};var Te=class extends He{constructor(e,t,i,r,s,o){super(e,"Ore x"+n.skill.bonus.oreBonusMultiplierPerUpgrade,null,t,i,r,s),this.values=o}getDescription(){return"Bonus: x"+I.formatBigNum(this.values.skillOreBonusMultiplier.getValue())}onPurchase(){return super.onPurchase()?(this.applyMultipliers(),!0):!1}onPurchaseFromSave(){this.applyMultipliers(),super.onPurchaseFromSave()}applyMultipliers(){let e=this.values.skillOreBonusMultiplier.getValue();e.lessThanEqualsNumber(1)&&e.setValue(1),e.mulNumber(n.skill.bonus.oreBonusMultiplierPerUpgrade)}};var Fo=class extends Ne{constructor(e,t){super(ne.ORE_BONUS),this.values=t;let i=5,r=5,s=this.addNode(new Te("oreBonus1",e,c.currency.ore,new d(r),this,this.values));r+=i;let o=this.addNode(new Te("oreBonus2",e,c.currency.ore,new d(r),this,this.values));r+=i;let a=this.addNode(new Te("oreBonus3",e,c.currency.ore,new d(r),this,this.values));r+=i;let h=this.addNode(new Te("oreBonus4",e,c.currency.ore,new d(r),this,this.values));r+=i;let m=this.addNode(new Te("oreBonus5",e,c.currency.ore,new d(r),this,this.values));r+=i;let p=this.addNode(new Te("oreBonus6",e,c.currency.ore,new d(r),this,this.values));r+=i;let f=this.addNode(new Te("oreBonus7",e,c.currency.ore,new d(r),this,this.values));r+=i;let N=this.addNode(new Te("oreBonus8",e,c.currency.ore,new d(r),this,this.values));r+=i;let T=this.addNode(new Te("oreBonus9",e,c.currency.ore,new d(r),this,this.values));r+=i;let C=this.addNode(new Te("oreBonus10",e,c.currency.ore,new d(r),this,this.values));r+=i;let w=this.addNode(new Te("oreBonus11",e,c.currency.ore,new d(r),this,this.values));r+=i;let E=this.addNode(new Te("oreBonus12",e,c.currency.ore,new d(r),this,this.values));r+=i;let P=this.addNode(new Te("oreBonus13",e,c.currency.ore,new d(r),this,this.values));r+=i;let S=this.addNode(new Te("oreBonus14",e,c.currency.ore,new d(r),this,this.values));r+=i;let A=this.addNode(new Te("oreBonus15",e,c.currency.ore,new d(r),this,this.values));r+=i;let _=this.addNode(new Te("oreBonus16",e,c.currency.ore,new d(r),this,this.values));r+=i;let L=this.addNode(new Te("oreBonus17",e,c.currency.ore,new d(r),this,this.values));r+=i;let W=this.addNode(new Te("oreBonus18",e,c.currency.ore,new d(r),this,this.values));r+=i;let x=this.addNode(new Te("oreBonus19",e,c.currency.ore,new d(r),this,this.values));r+=i;let J=this.addNode(new Te("oreBonus20",e,c.currency.ore,new d(r),this,this.values));r+=i;let ie=this.addNode(new Te("oreBonus21",e,c.currency.ore,new d(r),this,this.values));r+=i;let Y=this.addNode(new Te("oreBonus22",e,c.currency.ore,new d(r),this,this.values));r+=i;let X=this.addNode(new Te("oreBonus23",e,c.currency.ore,new d(r),this,this.values));r+=i;let B=this.addNode(new Te("oreBonus24",e,c.currency.ore,new d(r),this,this.values));r+=i;let k=this.addNode(new Te("oreBonus25",e,c.currency.ore,new d(r),this,this.values));r+=i;let Ce=this.addNode(new Te("oreBonus26",e,c.currency.ore,new d(r),this,this.values));r+=i;let me=this.addNode(new Te("oreBonus27",e,c.currency.ore,new d(r),this,this.values));r+=i;let Ae=this.addNode(new Te("oreBonus28",e,c.currency.ore,new d(r),this,this.values));s.addChildNode(o),o.addChildNode(a),a.addChildNode(h),h.addChildNode(m),m.addChildNode(p),p.addChildNode(f),f.addChildNode(N),N.addChildNode(T),T.addChildNode(C),C.addChildNode(w),w.addChildNode(E),E.addChildNode(P),P.addChildNode(S),S.addChildNode(A),A.addChildNode(_),_.addChildNode(L),L.addChildNode(W),W.addChildNode(x),x.addChildNode(J),J.addChildNode(ie),ie.addChildNode(Y),Y.addChildNode(X),X.addChildNode(B),B.addChildNode(k),k.addChildNode(Ce),Ce.addChildNode(me),me.addChildNode(Ae);let j=-1,D=2;s.setPosition(j,D),o.setPosition(j-1,D),a.setPosition(j-2,D),h.setPosition(j-3,D),m.setPosition(j-4,D),p.setPosition(j-5,D),f.setPosition(j-6,D),N.setPosition(j-6,D-1),T.setPosition(j-5,D-1),C.setPosition(j-4,D-1),w.setPosition(j-3,D-1),E.setPosition(j-2,D-1),P.setPosition(j-1,D-1),S.setPosition(j,D-1),A.setPosition(j,D-2),_.setPosition(j-1,D-2),L.setPosition(j-2,D-2),W.setPosition(j-3,D-2),x.setPosition(j-4,D-2),J.setPosition(j-5,D-2),ie.setPosition(j-6,D-2),Y.setPosition(j-6,D-3),X.setPosition(j-5,D-3),B.setPosition(j-4,D-3),k.setPosition(j-3,D-3),Ce.setPosition(j-2,D-3),me.setPosition(j-1,D-3),Ae.setPosition(j,D-3)}};var Be=class extends He{constructor(e,t,i,r,s,o,a,h){super(e,"Prestige +"+I.formatNumber(n.prestige.baseBonusPerUpgrade+n.prestige.incrementBonusPerUpgrade*h),null,t,i,r,s),this.values=o,this.mineDamageLogic=a,this.purchaseIndex=h}getDescription(){let e=this.values.skillPrestigeBonusMultiplier.getValue()+n.prestige.multiplierPerPrestige;return"Damage / Prestige: x"+I.formatNumber(e)}onPurchase(){return super.onPurchase()?(this.applyUpgrade(),this.mineDamageLogic.calculateTotalMineDamagePerTurn(),!0):!1}onPurchaseFromSave(){this.applyUpgrade(),super.onPurchaseFromSave()}applyUpgrade(){let e=n.prestige.baseBonusPerUpgrade+n.prestige.incrementBonusPerUpgrade*this.purchaseIndex;this.values.skillPrestigeBonusMultiplier.incrementValue(e)}};var Go=class extends Ne{constructor(e,t,i){super(ne.PRESTIGE_BONUS),this.values=t;let r=10,s=10,o=0,a=this.addNode(new Be("prestigeBonus1",e,c.currency.prestige,new d(s),this,this.values,i,o));s+=r,o++;let h=this.addNode(new Be("prestigeBonus2",e,c.currency.prestige,new d(s),this,this.values,i,o));s+=r,o++;let m=this.addNode(new Be("prestigeBonus3",e,c.currency.prestige,new d(s),this,this.values,i,o));s+=r,o++;let p=this.addNode(new Be("prestigeBonus4",e,c.currency.prestige,new d(s),this,this.values,i,o));s+=r,o++;let f=this.addNode(new Be("prestigeBonus5",e,c.currency.prestige,new d(s),this,this.values,i,o));s+=r,o++;let N=this.addNode(new Be("prestigeBonus6",e,c.currency.prestige,new d(s),this,this.values,i,o));s+=r,o++;let T=this.addNode(new Be("prestigeBonus7",e,c.currency.prestige,new d(s),this,this.values,i,o));s+=r,o++;let C=this.addNode(new Be("prestigeBonus8",e,c.currency.prestige,new d(s),this,this.values,i,o));s+=r,o++;let w=this.addNode(new Be("prestigeBonus9",e,c.currency.prestige,new d(s),this,this.values,i,o));s+=r,o++;let E=this.addNode(new Be("prestigeBonus10",e,c.currency.prestige,new d(s),this,this.values,i,o));s+=r,o++;let P=this.addNode(new Be("prestigeBonus11",e,c.currency.prestige,new d(s),this,this.values,i,o));s+=r,o++;let S=this.addNode(new Be("prestigeBonus12",e,c.currency.prestige,new d(s),this,this.values,i,o));s+=r,o++;let A=this.addNode(new Be("prestigeBonus13",e,c.currency.prestige,new d(s),this,this.values,i,o));s+=r,o++;let _=this.addNode(new Be("prestigeBonus14",e,c.currency.prestige,new d(s),this,this.values,i,o));s+=r,o++;let L=this.addNode(new Be("prestigeBonus15",e,c.currency.prestige,new d(s),this,this.values,i,o));s+=r,o++;let W=this.addNode(new Be("prestigeBonus16",e,c.currency.prestige,new d(s),this,this.values,i,o));s+=r,o++;let x=this.addNode(new Be("prestigeBonus17",e,c.currency.prestige,new d(s),this,this.values,i,o));s+=r,o++;let J=this.addNode(new Be("prestigeBonus18",e,c.currency.prestige,new d(s),this,this.values,i,o));s+=r,o++;let ie=this.addNode(new Be("prestigeBonus19",e,c.currency.prestige,new d(s),this,this.values,i,o));s+=r,o++;let Y=this.addNode(new Be("prestigeBonus20",e,c.currency.prestige,new d(s),this,this.values,i,o));s+=r,o++;let X=this.addNode(new Be("prestigeBonus21",e,c.currency.prestige,new d(s),this,this.values,i,o));a.addChildNode(h),h.addChildNode(m),m.addChildNode(p),p.addChildNode(f),f.addChildNode(N),N.addChildNode(T),T.addChildNode(C),C.addChildNode(w),w.addChildNode(E),E.addChildNode(P),P.addChildNode(S),S.addChildNode(A),A.addChildNode(_),_.addChildNode(L),L.addChildNode(W),W.addChildNode(x),x.addChildNode(J),J.addChildNode(ie),ie.addChildNode(Y),Y.addChildNode(X);let B=-1,k=-3;a.setPosition(B,k),h.setPosition(B-1,k),m.setPosition(B-2,k),p.setPosition(B-3,k),f.setPosition(B-4,k),N.setPosition(B-5,k),T.setPosition(B-6,k),C.setPosition(B-6,k-1),w.setPosition(B-5,k-1),E.setPosition(B-4,k-1),P.setPosition(B-3,k-1),S.setPosition(B-2,k-1),A.setPosition(B-1,k-1),_.setPosition(B,k-1),L.setPosition(B,k-2),W.setPosition(B-1,k-2),x.setPosition(B-2,k-2),J.setPosition(B-3,k-2),ie.setPosition(B-4,k-2),Y.setPosition(B-5,k-2),X.setPosition(B-6,k-2)}};var Ee=class extends He{constructor(e,t,i,r,s,o,a){super(e,"Mined Damage +"+I.formatNumber(n.minedDamage.baseBonusPerUpgrade+n.minedDamage.incrementBonusPerUpgrade*a),null,t,i,r,s),this.values=o,this.purchaseIndex=a}getDescription(){let e=this.values.skillMinedDamageBonus.getValue();return"Bonus: +"+I.formatNumber(e)}onPurchase(){return super.onPurchase()?(this.applyUpgrade(),!0):!1}onPurchaseFromSave(){this.applyUpgrade(),super.onPurchaseFromSave()}applyUpgrade(){let e=n.minedDamage.baseBonusPerUpgrade+n.minedDamage.incrementBonusPerUpgrade*this.purchaseIndex;this.values.skillMinedDamageBonus.incrementValue(e)}resetFull(){super.resetFull(),this.values.skillMinedDamageBonus.reset()}};var Vo=class extends Ne{constructor(e,t){super(ne.UPGRADE_BONUS_MULTIPLICATIVE),this.values=t;let i=5,r=5,s=0,o=this.addNode(new Ee("upgradeBonusMult1",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let a=this.addNode(new Ee("upgradeBonusMult2",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let h=this.addNode(new Ee("upgradeBonusMult3",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let m=this.addNode(new Ee("upgradeBonusMult4",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let p=this.addNode(new Ee("upgradeBonusMult5",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let f=this.addNode(new Ee("upgradeBonusMult6",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let N=this.addNode(new Ee("upgradeBonusMult7",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let T=this.addNode(new Ee("upgradeBonusMult8",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let C=this.addNode(new Ee("upgradeBonusMult9",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let w=this.addNode(new Ee("upgradeBonusMult10",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let E=this.addNode(new Ee("upgradeBonusMult11",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let P=this.addNode(new Ee("upgradeBonusMult12",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let S=this.addNode(new Ee("upgradeBonusMult13",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let A=this.addNode(new Ee("upgradeBonusMult14",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let _=this.addNode(new Ee("upgradeBonusMult15",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let L=this.addNode(new Ee("upgradeBonusMult16",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let W=this.addNode(new Ee("upgradeBonusMult17",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let x=this.addNode(new Ee("upgradeBonusMult18",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let J=this.addNode(new Ee("upgradeBonusMult19",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let ie=this.addNode(new Ee("upgradeBonusMult20",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let Y=this.addNode(new Ee("upgradeBonusMult21",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let X=this.addNode(new Ee("upgradeBonusMult22",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let B=this.addNode(new Ee("upgradeBonusMult23",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let k=this.addNode(new Ee("upgradeBonusMult24",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let Ce=this.addNode(new Ee("upgradeBonusMult25",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let me=this.addNode(new Ee("upgradeBonusMult26",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let Ae=this.addNode(new Ee("upgradeBonusMult27",e,c.currency.upgrades,new d(r),this,this.values,s));r+=i,s++;let j=this.addNode(new Ee("upgradeBonusMult28",e,c.currency.upgrades,new d(r),this,this.values,s));o.addChildNode(a),a.addChildNode(h),h.addChildNode(m),m.addChildNode(p),p.addChildNode(f),f.addChildNode(N),N.addChildNode(T),T.addChildNode(C),C.addChildNode(w),w.addChildNode(E),E.addChildNode(P),P.addChildNode(S),S.addChildNode(A),A.addChildNode(_),_.addChildNode(L),L.addChildNode(W),W.addChildNode(x),x.addChildNode(J),J.addChildNode(ie),ie.addChildNode(Y),Y.addChildNode(X),X.addChildNode(B),B.addChildNode(k),k.addChildNode(Ce),Ce.addChildNode(me),me.addChildNode(Ae),Ae.addChildNode(j);let D=-1,te=-7;o.setPosition(D,te),a.setPosition(D-1,te),h.setPosition(D-2,te),m.setPosition(D-3,te),p.setPosition(D-4,te),f.setPosition(D-5,te),N.setPosition(D-6,te),T.setPosition(D-6,te-1),C.setPosition(D-5,te-1),w.setPosition(D-4,te-1),E.setPosition(D-3,te-1),P.setPosition(D-2,te-1),S.setPosition(D-1,te-1),A.setPosition(D,te-1),_.setPosition(D,te-2),L.setPosition(D-1,te-2),W.setPosition(D-2,te-2),x.setPosition(D-3,te-2),J.setPosition(D-4,te-2),ie.setPosition(D-5,te-2),Y.setPosition(D-6,te-2),X.setPosition(D-6,te-3),B.setPosition(D-5,te-3),k.setPosition(D-4,te-3),Ce.setPosition(D-3,te-3),me.setPosition(D-2,te-3),Ae.setPosition(D-1,te-3),j.setPosition(D,te-3)}};var ke=class extends He{constructor(e,t,i,r,s,o,a,h,m){super(e,t,i,r,s,o,a),this.crew=h,this.skillId=m}onPurchase(){return super.onPurchase()?(this.crew.addNewMinerNearMain(this.skillId),!0):!1}};var re=class extends fe{constructor(e,t,i,r,s,o,a){super(e,"Cool Down - "+n.skill.common.coolDownSecondsPerUpgrade+" sec",null,t,i,r,s,o,a)}getDescription(){return Ye.getSkillCoolDownSeconds(this.numberValue)+" seconds"}};var se=class extends fe{constructor(e,t,i,r,s,o,a){super(e,"Duration + "+n.skill.common.activationSecondsPerUpgrade+" sec",null,t,i,r,s,o,a)}getDescription(){return Ye.getSkillActivationSeconds(this.numberValue)+" seconds"}};var Fe=class extends fe{constructor(e,t,i,r,s,o,a,h){super(e,"+"+o+" Tile",null,t,i,r,s,o,a),this.minRange=h}getDescription(){return"Range: "+(this.minRange+this.valuePerSkillLevel*this.numberValue.getValue())+" Tiles"}};var Li=class{constructor(e){this.worldGrid=e,this.startPoint=new b(0,0),this.endPoint=new b(0,0),this.workingPosition=new b(0,0)}getProjectedTile(e,t){return e&&e.contains(t)?e:this.worldGrid.findGridTile(t)}};var ut=class{constructor(){}static projectPosition(e,t,i,r){return r.copy(e),r.x+=Math.cos(i)*t,r.y+=Math.sin(i)*t,r}};var Nd=Math.PI/2,Uo=class extends Li{constructor(e,t,i){super(e),this.tileMinedLogic=t,this.depthUpgradeCount=i,this.drillTile=null,this.goalTile=null,this.skillActive=!1}onSkillActivation(){this.skillActive=!0}onSkillDeactivation(){this.skillActive=!1,this.drillTile=null}updateForFrame(e,t){this.startPoint.copy(e.position.worldCoordinateOrigin),this.startPoint.addXY(n.tile.halfSize,n.tile.halfSize);let i=(n.skill.drill.minRange+n.skill.drill.tilesPerUpgrade*this.depthUpgradeCount.getValue())*n.tile.size;if(this.workingPosition.copy(this.startPoint),this.workingPosition.y+=i,this.goalTile=this.worldGrid.findGridTile(this.workingPosition),this.drillTile=this.goalTile,!!this.goalTile){if(this.drillTile=this.findFirstClosedTileOnLine(this.startPoint,Nd,i),!this.drillTile){this.endPoint.copy(this.goalTile.origin),this.endPoint.x=this.startPoint.x,this.endPoint.y+=n.tile.halfSize;return}this.drillTile.markTileAsCurrentlyVisible(),this.endPoint.copy(this.drillTile.origin),this.endPoint.x=this.startPoint.x,this.endPoint.y+=n.tile.halfSize,this.drillTile.open||this.tileMinedLogic.drillTileForFrame(this.drillTile,t)}}findFirstClosedTileOnLine(e,t,i){let r=null;for(let s=n.tile.halfSize;s<=i;s+=n.tile.halfSize){let o=ut.projectPosition(e,s,t,this.workingPosition),a=this.getProjectedTile(r,o);if(!a)break;if(r!==a){if(a.lighting.everVisibleToCharacter||a.markTileAsCurrentlyVisible(),!a.open)return a;r=a}}return r&&!r.open?r:null}};var Ho=class extends nt{constructor(e,t){super(),this.drillArray=e,this.spellFxSpritesheet=t,this.skillAnimation=null,this.skillStart=Date.now()}renderSkill(e,t){if(this.drillArray.length!==0)for(let i=0;i<this.drillArray.length;i++)this.renderDrill(e,t,this.drillArray[i])}renderDrill(e,t,i){if(!i.skillActive||!i.goalTile)return;let r=Date.now();r-this.skillStart>1e5&&(this.skillStart=r),this.skillAnimation||(this.skillAnimation=this.spellFxSpritesheet.getSpriteAnimation(O.EFFECT_NAME_SPARKLE_BLUE));let s=i.startPoint,o=i.endPoint,a=e.lineWidth;if(e.lineWidth=5,e.strokeStyle="#00F",e.beginPath(),t.worldToScreen(s,this.screenCoordinate),e.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),t.worldToScreen(o,this.screenCoordinate),e.lineTo(this.screenCoordinate.x,this.screenCoordinate.y),e.stroke(),e.lineWidth=1,e.strokeStyle="#FFF",e.beginPath(),t.worldToScreen(s,this.screenCoordinate),e.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),t.worldToScreen(o,this.screenCoordinate),e.lineTo(this.screenCoordinate.x,this.screenCoordinate.y),e.stroke(),e.lineWidth=a,t.isVisible(o,n.tile.size)){this.screenCoordinate.copy(o),this.screenCoordinate.x-=n.tile.halfSize,this.screenCoordinate.y-=n.tile.halfSize,t.worldToScreen(this.screenCoordinate,this.screenCoordinate);let h=this.skillAnimation.getSpriteAsOf(Date.now(),this.skillStart);this.renderSprite(e,t,h,this.screenCoordinate)}}};var zo=class extends Ne{constructor(e,t,i,r,s){super(ne.DRILL),this.worldGrid=e,this.tileMinedLogic=i,this.totals=t,this.crew=r,this.drillArray=[],this.drillByCharacter={},this.depthUpgrades=new we(null,0),this.renderer=new Ho(this.drillArray,s);let o=1,a=this.addNode(new ke("addDrillMiner1","+1 Drill Miner","Drills straight down",t,c.skill.drill,new d(o+n.skill.costs.addDrill1),this,r,ne.DRILL));o++;let h=this.addNode(new Fe("drillDepth1",t,c.skill.drill,new d(o),this,n.skill.drill.tilesPerUpgrade,this.depthUpgrades,n.skill.drill.minRange)),m=this.addNode(new re("drillCool1",t,c.skill.drill,new d(o),this,1,this.coolDownUpgrades)),p=this.addNode(new se("drillDur1",t,c.skill.drill,new d(o),this,1,this.durationUpgrades));o++;let f=this.addNode(new Fe("drillDepth2",t,c.skill.drill,new d(o),this,n.skill.drill.tilesPerUpgrade,this.depthUpgrades,n.skill.drill.minRange)),N=this.addNode(new re("drillCool2",t,c.skill.drill,new d(o),this,1,this.coolDownUpgrades)),T=this.addNode(new se("drillDur2",t,c.skill.drill,new d(o),this,1,this.durationUpgrades));o++;let C=this.addNode(new Fe("drillDepth3",t,c.skill.drill,new d(o),this,n.skill.drill.tilesPerUpgrade,this.depthUpgrades,n.skill.drill.minRange)),w=this.addNode(new re("drillCool3",t,c.skill.drill,new d(o),this,1,this.coolDownUpgrades)),E=this.addNode(new se("drillDur3",t,c.skill.drill,new d(o),this,1,this.durationUpgrades)),P=this.addNode(new ke("addDrillMiner2","+1 Drill Miner","Drills straight down",t,c.skill.drill,new d(o+n.skill.costs.addMiner2),this,r,ne.DRILL));o++;let S=this.addNode(new Fe("drillDepth4",t,c.skill.drill,new d(o),this,n.skill.drill.tilesPerUpgrade,this.depthUpgrades,n.skill.drill.minRange)),A=this.addNode(new re("drillCool4",t,c.skill.drill,new d(o),this,1,this.coolDownUpgrades)),_=this.addNode(new se("drillDur4",t,c.skill.drill,new d(o),this,1,this.durationUpgrades));o++;let L=this.addNode(new Fe("drillDepth5",t,c.skill.drill,new d(o),this,n.skill.drill.tilesPerUpgrade,this.depthUpgrades,n.skill.drill.minRange)),W=this.addNode(new re("drillCool5",t,c.skill.drill,new d(o),this,1,this.coolDownUpgrades)),x=this.addNode(new se("drillDur5",t,c.skill.drill,new d(o),this,1,this.durationUpgrades));o++;let J=this.addNode(new Fe("drillDepth6",t,c.skill.drill,new d(o),this,n.skill.drill.tilesPerUpgrade,this.depthUpgrades,n.skill.drill.minRange)),ie=this.addNode(new re("drillCool6",t,c.skill.drill,new d(o),this,1,this.coolDownUpgrades)),Y=this.addNode(new se("drillDur6",t,c.skill.drill,new d(o),this,1,this.durationUpgrades)),X=this.addNode(new ke("addDrillMiner3","+1 Drill Miner","Drills straight down",t,c.skill.drill,new d(o+n.skill.costs.addMiner3),this,r,ne.DRILL));o++;let B=this.addNode(new Fe("drillDepth7",t,c.skill.drill,new d(o),this,n.skill.drill.tilesPerUpgrade,this.depthUpgrades,n.skill.drill.minRange)),k=this.addNode(new re("drillCool7",t,c.skill.drill,new d(o),this,1,this.coolDownUpgrades)),Ce=this.addNode(new se("drillDur7",t,c.skill.drill,new d(o),this,1,this.durationUpgrades));o++;let me=this.addNode(new Fe("drillDepth8",t,c.skill.drill,new d(o),this,n.skill.drill.tilesPerUpgrade,this.depthUpgrades,n.skill.drill.minRange)),Ae=this.addNode(new re("drillCool8",t,c.skill.drill,new d(o),this,1,this.coolDownUpgrades)),j=this.addNode(new se("drillDur8",t,c.skill.drill,new d(o),this,1,this.durationUpgrades));o++;let D=this.addNode(new Fe("drillDepth9",t,c.skill.drill,new d(o),this,n.skill.drill.tilesPerUpgrade,this.depthUpgrades,n.skill.drill.minRange)),te=this.addNode(new re("drillCool9",t,c.skill.drill,new d(o),this,1,this.coolDownUpgrades)),We=this.addNode(new se("drillDur9",t,c.skill.drill,new d(o),this,1,this.durationUpgrades)),Xe=this.addNode(new ke("addDrillMiner4","+1 Drill Miner","Drills straight down",t,c.skill.drill,new d(o+n.skill.costs.addMiner4),this,r,ne.DRILL));a.addChildNode(h),h.addChildNode(f),f.addChildNode(C),C.addChildNode(S),S.addChildNode(L),L.addChildNode(J),J.addChildNode(B),B.addChildNode(me),me.addChildNode(D),h.addChildNode(m),f.addChildNode(N),C.addChildNode(w),S.addChildNode(A),L.addChildNode(W),J.addChildNode(ie),B.addChildNode(k),me.addChildNode(Ae),D.addChildNode(te),h.addChildNode(f),f.addChildNode(C),C.addChildNode(S),S.addChildNode(L),L.addChildNode(J),J.addChildNode(B),B.addChildNode(me),me.addChildNode(D),C.addChildNode(P),J.addChildNode(X),D.addChildNode(Xe),m.addChildNode(p),N.addChildNode(T),w.addChildNode(E),A.addChildNode(_),W.addChildNode(x),ie.addChildNode(Y),k.addChildNode(Ce),Ae.addChildNode(j),te.addChildNode(We);let G=3,F=13;a.setPosition(G,F),h.setPosition(G+1,F),f.setPosition(G+2,F),C.setPosition(G+3,F),S.setPosition(G+4,F),L.setPosition(G+5,F),J.setPosition(G+6,F),B.setPosition(G+7,F),me.setPosition(G+8,F),D.setPosition(G+9,F),m.setPosition(G+1,F-1),N.setPosition(G+2,F-1),w.setPosition(G+3,F-1),A.setPosition(G+4,F-1),W.setPosition(G+5,F-1),ie.setPosition(G+6,F-1),k.setPosition(G+7,F-1),Ae.setPosition(G+8,F-1),te.setPosition(G+9,F-1),p.setPosition(G+1,F-2),T.setPosition(G+2,F-2),E.setPosition(G+3,F-2),_.setPosition(G+4,F-2),x.setPosition(G+5,F-2),Y.setPosition(G+6,F-2),Ce.setPosition(G+7,F-2),j.setPosition(G+8,F-2),We.setPosition(G+9,F-2),P.setPosition(G+3,F+1),X.setPosition(G+6,F+1),Xe.setPosition(G+9,F+1)}updateSkillForFrame(e,t,i){let r=this.drillByCharacter[e.id];r||(r=new Uo(this.worldGrid,this.tileMinedLogic,this.depthUpgrades),this.drillByCharacter[e.id]=r,this.drillArray.push(r)),i&&!r.skillActive?r.onSkillActivation():!i&&r.skillActive&&r.onSkillDeactivation(),i&&r.updateForFrame(e,t)}getRenderer(){return this.renderer}resetFull(){super.resetFull(),this.drillArray.length=0,this.drillByCharacter={},this.depthUpgrades.reset()}};var Wo=class extends Li{constructor(e,t,i,r,s){super(e),this.vectorField=i,this.gameTime=t,this.tileMinedLogic=r,this.laserRangeUpgrades=s,this.laserTile=null,this.goalLaserTile=null,this.skillActive=!1,this.laserVisible=!1,this.laserOn=!1,this.laserOnTurn=0,this.prevTurn=0}onSkillActivation(){this.skillActive=!0,this.laserTile=null,this.goalLaserTile=null,this.laserOn=!0,this.laserOnTurn=this.gameTime.turnNumber}onSkillDeactivation(){this.skillActive=!1,this.laserTile=null,this.goalLaserTile=null,this.laserOn=!1,this.laserOnTurn=0}updateForFrame(e,t){this.startPoint.copy(e.position.worldCoordinateOrigin),this.startPoint.addXY(n.tile.halfSize,n.tile.halfSize);let i=(n.skill.laser.minRange+n.skill.laser.tilesPerUpgrade*this.laserRangeUpgrades.getValue())*n.tile.size;if((this.gameTime.turnNumber!==this.prevTurn||!this.goalLaserTile)&&(this.prevTurn=this.gameTime.turnNumber,this.goalLaserTile===e.position.tile&&(this.goalLaserTile=null),this.goalLaserTile=this.chooseLaserTargetTile(e,i),!this.goalLaserTile)){this.laserTile=null,this.laserVisible=!1;return}if(this.laserTile=this.goalLaserTile,this.workingPosition.copy(this.laserTile.origin),this.workingPosition.addXY(n.tile.halfSize,n.tile.halfSize),this.startPoint.equals(this.workingPosition)){this.laserVisible=!1,this.goalLaserTile=null;return}let r=this.calculateAngle(this.startPoint,this.workingPosition);if(this.laserTile=this.findFirstClosedTileOnLine(this.startPoint,r,i),!this.laserTile){this.laserVisible=!1,this.goalLaserTile=null;return}this.laserTile.markTileAsCurrentlyVisible(),this.endPoint.copy(this.laserTile.origin),this.endPoint.addXY(n.tile.halfSize,n.tile.halfSize),this.laserTile.open||this.tileMinedLogic.laserTileForFrame(this.laserTile,t),this.laserVisible=!0}chooseLaserTargetTile(e,t){let i=t*t,r=e.position.worldCoordinateOrigin;if(this.goalLaserTile&&!this.goalLaserTile.open&&this.isTileInLaserRange(r,this.goalLaserTile,i))return this.goalLaserTile;let s=this.findClosestTargetInList(r,this.vectorField.priorityMiningCandidates,i);if(s)return s;let o=this.findClosestTargetInList(r,this.vectorField.currencyMiningCandidates,i);if(o)return o;let a=e.target.mineTile;if(a&&!a.open&&this.isTileInLaserRange(r,a,i))return a;let h=this.findClosestTargetInList(r,this.vectorField.commonMiningCandidates,i);return h||this.findNearbyRandomTile(e)}findNearbyRandomTile(e){let t=e.position.tile;if(!t)return null;switch(Ie.randomInt(6)){case 0:return this.getBottomLeftSafe(t.getNeighborBottom());case 1:return this.getBottomRightSafe(t.getNeighborBottom());case 2:return this.getBottomLeftSafe(t.getNeighborLeft());case 3:return this.getTopLeftSafe(t.getNeighborLeft());case 4:return this.getBottomRightSafe(t.getNeighborRight());case 5:return this.getTopRightSafe(t.getNeighborRight())}return null}getBottomLeftSafe(e){return e?e.getNeighborBottomLeft():null}getBottomRightSafe(e){return e?e.getNeighborBottomRight():null}getTopLeftSafe(e){return e?e.getNeighborTopLeft():null}getTopRightSafe(e){return e?e.getNeighborTopRight():null}findClosestTargetInList(e,t,i){if(t.length===0)return null;let r=null,s=1e4;for(let o=0;o<t.length;o++){let a=t[o];if(!a||a.open)continue;let h=e.distanceSquared(a.origin);h>i||(!r||h<s)&&(r=a,s=h)}return r}isTileInLaserRange(e,t,i){return e.distanceSquared(t.origin)<=i}findFirstClosedTileOnLine(e,t,i){let r=null;for(let s=n.tile.halfSize;s<=i;s+=n.tile.halfSize){let o=ut.projectPosition(e,s,t,this.workingPosition),a=this.getProjectedTile(r,o);if(!a)break;if(r!==a){if(a.lighting.everVisibleToCharacter||a.markTileAsCurrentlyVisible(),!a.open)return a;r=a}}return r}calculateAngle(e,t){return Math.atan2(t.y-e.y,t.x-e.x)}};var Yo=class extends nt{constructor(e,t){super(),this.laserArray=e,this.spellFxSpritesheet=t,this.skillAnimation=null,this.skillStart=Date.now()}renderSkill(e,t){if(this.laserArray.length!==0)for(let i=0;i<this.laserArray.length;i++)this.renderLaser(e,t,this.laserArray[i])}renderLaser(e,t,i){if(!i.laserTile||!i.laserVisible)return;let r=Date.now();r-this.skillStart>1e5&&(this.skillStart=r),this.skillAnimation||(this.skillAnimation=this.spellFxSpritesheet.getSpriteAnimation(O.EFFECT_NAME_SPARKLE_RED));let s=i.startPoint,o=i.endPoint,a=e.lineWidth;if(e.lineWidth=5,e.strokeStyle="#F00",e.beginPath(),t.worldToScreen(s,this.screenCoordinate),e.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),t.worldToScreen(o,this.screenCoordinate),e.lineTo(this.screenCoordinate.x,this.screenCoordinate.y),e.stroke(),e.lineWidth=1,e.strokeStyle="#FFF",e.beginPath(),t.worldToScreen(s,this.screenCoordinate),e.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),t.worldToScreen(o,this.screenCoordinate),e.lineTo(this.screenCoordinate.x,this.screenCoordinate.y),e.stroke(),e.lineWidth=a,t.isVisible(o,n.tile.size)){this.screenCoordinate.copy(o),this.screenCoordinate.x-=n.tile.halfSize,this.screenCoordinate.y-=n.tile.halfSize,t.worldToScreen(this.screenCoordinate,this.screenCoordinate);let h=this.skillAnimation.getSpriteAsOf(Date.now(),this.skillStart);this.renderSprite(e,t,h,this.screenCoordinate)}}};var Ko=class extends Ne{constructor(e,t,i,r,s,o,a){super(ne.LASER),this.worldGrid=e,this.tileMinedLogic=i,this.totals=t,this.crew=r,this.gameTime=s,this.vectorField=a,this.laserRangeUpgrades=new we(null,0),this.laserArray=[],this.laserByCharacter={},this.renderer=new Yo(this.laserArray,o);let h=1,m=this.addNode(new ke("addLaserMiner1","+1 Laser Miner","Blasts stone with a laser",t,c.skill.laser,new d(h+n.skill.costs.addLaser1),this,r,ne.LASER));h++;let p=this.addNode(new Fe("laserRange1",t,c.skill.laser,new d(h),this,n.skill.laser.tilesPerUpgrade,this.laserRangeUpgrades,n.skill.laser.minRange)),f=this.addNode(new re("laserCool1",t,c.skill.laser,new d(h),this,1,this.coolDownUpgrades)),N=this.addNode(new se("laserDur1",t,c.skill.laser,new d(h),this,1,this.durationUpgrades));h++;let T=this.addNode(new Fe("laserRange2",t,c.skill.laser,new d(h),this,n.skill.laser.tilesPerUpgrade,this.laserRangeUpgrades,n.skill.laser.minRange)),C=this.addNode(new re("laserCool2",t,c.skill.laser,new d(h),this,1,this.coolDownUpgrades)),w=this.addNode(new se("laserDur2",t,c.skill.laser,new d(h),this,1,this.durationUpgrades));h++;let E=this.addNode(new Fe("laserRange3",t,c.skill.laser,new d(h),this,n.skill.laser.tilesPerUpgrade,this.laserRangeUpgrades,n.skill.laser.minRange)),P=this.addNode(new re("laserCool3",t,c.skill.laser,new d(h),this,1,this.coolDownUpgrades)),S=this.addNode(new se("laserDur3",t,c.skill.laser,new d(h),this,1,this.durationUpgrades));h++;let A=this.addNode(new Fe("laserRange4",t,c.skill.laser,new d(h),this,n.skill.laser.tilesPerUpgrade,this.laserRangeUpgrades,n.skill.laser.minRange)),_=this.addNode(new ke("addLaserMiner2","+1 Laser Miner","Blasts stone with a laser",t,c.skill.laser,new d(h+n.skill.costs.addMiner2),this,r,ne.LASER)),L=this.addNode(new re("laserCool4",t,c.skill.laser,new d(h),this,1,this.coolDownUpgrades)),W=this.addNode(new se("laserDur4",t,c.skill.laser,new d(h),this,1,this.durationUpgrades));h++;let x=this.addNode(new Fe("laserRange5",t,c.skill.laser,new d(h),this,n.skill.laser.tilesPerUpgrade,this.laserRangeUpgrades,n.skill.laser.minRange)),J=this.addNode(new re("laserCool5",t,c.skill.laser,new d(h),this,1,this.coolDownUpgrades)),ie=this.addNode(new se("laserDur5",t,c.skill.laser,new d(h),this,1,this.durationUpgrades));h++;let Y=this.addNode(new Fe("laserRange6",t,c.skill.laser,new d(h),this,n.skill.laser.tilesPerUpgrade,this.laserRangeUpgrades,n.skill.laser.minRange)),X=this.addNode(new re("laserCool6",t,c.skill.laser,new d(h),this,1,this.coolDownUpgrades)),B=this.addNode(new se("laserDur6",t,c.skill.laser,new d(h),this,1,this.durationUpgrades));h++;let k=this.addNode(new Fe("laserRange7",t,c.skill.laser,new d(h),this,n.skill.laser.tilesPerUpgrade,this.laserRangeUpgrades,n.skill.laser.minRange)),Ce=this.addNode(new ke("addLaserMiner3","+1 Laser Miner","Blasts stone with a laser",t,c.skill.laser,new d(h+n.skill.costs.addMiner3),this,r,ne.LASER)),me=this.addNode(new re("laserCool7",t,c.skill.laser,new d(h),this,1,this.coolDownUpgrades)),Ae=this.addNode(new se("laserDur7",t,c.skill.laser,new d(h),this,1,this.durationUpgrades));h++;let j=this.addNode(new Fe("laserRange8",t,c.skill.laser,new d(h),this,n.skill.laser.tilesPerUpgrade,this.laserRangeUpgrades,n.skill.laser.minRange)),D=this.addNode(new re("laserCool8",t,c.skill.laser,new d(h),this,1,this.coolDownUpgrades)),te=this.addNode(new se("laserDur8",t,c.skill.laser,new d(h),this,1,this.durationUpgrades));h++;let We=this.addNode(new Fe("laserRange9",t,c.skill.laser,new d(h),this,n.skill.laser.tilesPerUpgrade,this.laserRangeUpgrades,n.skill.laser.minRange)),Xe=this.addNode(new ke("addLaserMiner4","+1 Laser Miner","Blasts stone with a laser",t,c.skill.laser,new d(h+n.skill.costs.addMiner4),this,r,ne.LASER)),G=this.addNode(new re("laserCool9",t,c.skill.laser,new d(h),this,1,this.coolDownUpgrades)),F=this.addNode(new se("laserDur9",t,c.skill.laser,new d(h),this,1,this.durationUpgrades));m.addChildNode(p),p.addChildNode(T),T.addChildNode(E),E.addChildNode(A),A.addChildNode(x),x.addChildNode(Y),Y.addChildNode(k),k.addChildNode(j),j.addChildNode(We),p.addChildNode(f),T.addChildNode(C),E.addChildNode(P),A.addChildNode(L),x.addChildNode(J),Y.addChildNode(X),k.addChildNode(me),j.addChildNode(D),We.addChildNode(G),f.addChildNode(N),C.addChildNode(w),P.addChildNode(S),L.addChildNode(W),J.addChildNode(ie),X.addChildNode(B),me.addChildNode(Ae),D.addChildNode(te),G.addChildNode(F),E.addChildNode(_),k.addChildNode(Ce),We.addChildNode(Xe);let ue=3,ae=8;m.setPosition(ue,ae),p.setPosition(ue+1,ae),T.setPosition(ue+2,ae),E.setPosition(ue+3,ae),A.setPosition(ue+4,ae),x.setPosition(ue+5,ae),Y.setPosition(ue+6,ae),k.setPosition(ue+7,ae),j.setPosition(ue+8,ae),We.setPosition(ue+9,ae),f.setPosition(ue+1,ae-1),C.setPosition(ue+2,ae-1),P.setPosition(ue+3,ae-1),L.setPosition(ue+4,ae-1),J.setPosition(ue+5,ae-1),X.setPosition(ue+6,ae-1),me.setPosition(ue+7,ae-1),D.setPosition(ue+8,ae-1),G.setPosition(ue+9,ae-1),N.setPosition(ue+1,ae-2),w.setPosition(ue+2,ae-2),S.setPosition(ue+3,ae-2),W.setPosition(ue+4,ae-2),ie.setPosition(ue+5,ae-2),B.setPosition(ue+6,ae-2),Ae.setPosition(ue+7,ae-2),te.setPosition(ue+8,ae-2),F.setPosition(ue+9,ae-2),_.setPosition(ue+3,ae+1),Ce.setPosition(ue+7,ae+1),Xe.setPosition(ue+9,ae+1)}updateSkillForFrame(e,t,i){let r=this.laserByCharacter[e.id];r||(r=new Wo(this.worldGrid,this.gameTime,this.vectorField,this.tileMinedLogic,this.laserRangeUpgrades),this.laserByCharacter[e.id]=r,this.laserArray.push(r)),i&&!r.skillActive?r.onSkillActivation():!i&&r.skillActive&&r.onSkillDeactivation(),i&&r.updateForFrame(e,t)}getRenderer(){return this.renderer}resetFull(){super.resetFull(),this.laserArray.length=0,this.laserByCharacter={},this.laserRangeUpgrades.reset()}};var Xo=class{constructor(e,t,i){this.worldGrid=e,this.tileMinedLogic=t,this.missiles=i,this.active=!1,this.startPosition=new b(0,0),this.position=new b(0,0),this.movementUnitVector=new b(0,0),this.movementVector=new b(0,0),this.tile=null,this.spriteDirection=0,this.distance=0,this.missileDamage=new d(0)}resetMissile(){this.active=!1,this.tile=null,this.distance=0}onMissileFire(e,t,i){this.resetMissile(),this.startPosition.copy(e),this.startPosition.addXY(n.tile.halfSize,n.tile.halfSize);let r=this.applyRandom(t);this.spriteDirection=i,this.active=!0,ut.projectPosition(this.startPosition,n.tile.size,r,this.position),this.tileMinedLogic.calculateMissileDamage(this.missileDamage),this.movementUnitVector.copy(this.position),this.movementUnitVector.subtract(this.startPosition),Z.nor(this.movementUnitVector)}applyRandom(e){let t=Math.PI/16*Math.random();return Math.random()<.5?e-t:e+t}updateForFrame(e){if(this.movementVector.copy(this.movementUnitVector),this.movementVector.scale(e),this.distance+=e,this.position.add(this.movementVector),this.tile=this.worldGrid.findGridTile(this.position),!this.tile){this.active=!1;return}if(this.tile){this.tile.lighting.everVisibleToCharacter||this.tile.markTileAsCurrentlyVisible();let i=this.tile.open?this.findCollisionTile(this.position,this.tile):this.tile;if(i&&(i.lighting.everVisibleToCharacter||i.markTileAsCurrentlyVisible(),this.tileMinedLogic.missileTile(i,this.missileDamage),i.open&&this.missiles.addExplosion(this.position),this.missileDamage.lessThanEqualsZero())){this.active=!1;return}}let t=20*n.tile.size;if(this.distance>=t){this.active=!1;return}}findCollisionTile(e,t){for(let r=0;r<t.neighbors.length;r++){let s=t.neighbors[r];if(!(!s||s.open)&&s.intersects(e.x,e.y,3))return s}return null}};var Ji=class{constructor(){this.position=new b(0,0),this.time=Date.now(),this.active=!1}activate(e){this.position.copy(e),this.time=Date.now(),this.active=!0}deactivate(){this.active=!1}};var jo=class{constructor(e,t,i){this.worldGrid=e,this.missilesUpgrades=t,this.tileMinedLogic=i,this.missileExplosions=new Array(3);for(let r=0;r<this.missileExplosions.length;r++)this.missileExplosions[r]=new Ji;this.missiles=[],this.activeMissiles=0,this.lastFireTime=0,this.millisBetweenFires=550,this.skillActive=!1,this.burstActive=!1,this.burstCount=0,this.burstTime=0,this.burstDelay=70,this.radians=0,this.spriteDirection=0}onSkillActivation(){this.skillActive=!0;let e=Date.now();this.burstActive=!1,this.burstTime=e-this.burstDelay,this.activeMissiles=0,this.lastFireTime=e-this.millisBetweenFires;for(let t=0;t<this.missileExplosions.length;t++)this.missileExplosions[t].deactivate();for(let t=0;t<this.missiles.length;t++)this.missiles[t].resetMissile()}onSkillDeactivation(){this.skillActive=!1;for(let e=0;e<this.missileExplosions.length;e++)this.missileExplosions[e].deactivate();this.burstActive=!1,this.activeMissiles=0}updateForFrame(e,t){let i=Date.now();if(!this.burstActive&&this.activeMissiles===0&&i-this.lastFireTime>this.millisBetweenFires&&(this.burstActive=!0,this.burstCount=0,this.burstTime=i-this.burstDelay,this.chooseRandomDirection()),this.burstActive){let r=Ye.getMissileCount(this.missilesUpgrades);for(;this.missiles.length<r;)this.missiles.push(new Xo(this.worldGrid,this.tileMinedLogic,this));if(i-this.burstTime>=this.burstDelay){this.burstTime=i;let s=this.missiles[this.burstCount];this.burstCount++,s.onMissileFire(e.position.worldCoordinateOrigin,this.radians,this.spriteDirection),this.activeMissiles++}this.burstCount>=r&&(this.burstActive=!1)}if(this.activeMissiles>0){let r=4*t;this.activeMissiles=0;for(let s=0;s<this.missiles.length;s++){let o=this.missiles[s];!o||!o.active||(o.updateForFrame(r),o.active&&this.activeMissiles++)}this.activeMissiles===0&&(this.lastFireTime=i)}}addExplosion(e){let t=this.findAvailableExplosion();if(!t){console.log("Missiles.addExplosion() failed to find available explosion.");return}t.activate(e)}findAvailableExplosion(){let e=Ye.getMissileCount(this.missilesUpgrades);if(this.missileExplosions.length<e){for(let i=0;i<this.missileExplosions.length;i++){let r=this.missileExplosions[i];if(!r.active)return r}let t=new Ji;return this.missileExplosions.push(t),t}else{let t=null,i=0;for(let r=0;r<this.missileExplosions.length;r++){let s=this.missileExplosions[r];if(!s.active)return s;(!t||s.time<i)&&(t=s,i=s.time)}return t}}chooseRandomDirection(){let e=2*Math.PI;switch(Ie.randomInt(8)){case 0:this.radians=0,this.spriteDirection=Et.EAST;break;case 1:this.radians=e*(1/8),this.spriteDirection=Et.SOUTH_EAST;break;case 2:this.radians=e*(1/4),this.spriteDirection=Et.SOUTH;break;case 3:this.radians=e*(3/8),this.spriteDirection=Et.SOUTH_WEST;break;case 4:this.radians=e*(1/2),this.spriteDirection=Et.WEST;break;case 5:this.radians=e*(5/8),this.spriteDirection=Et.NORTH_WEST;break;case 6:this.radians=e*(3/4),this.spriteDirection=Et.NORTH;break;case 7:this.radians=e*(7/8),this.spriteDirection=Et.NORTH_EAST;break}}};var Zo=class extends nt{constructor(e,t){super(),this.missilesArray=e,this.spellFxSpritesheet=t,this.missilesSkillAnimation=null,this.skillStart=0,this.missilesExplosionAnimation=null}renderSkill(e,t){if(this.missilesArray.length===0)return;let i=Date.now();i-this.skillStart>1e5&&(this.skillStart=i),this.missilesSkillAnimation||(this.missilesSkillAnimation=this.spellFxSpritesheet.getSpriteAnimation(O.MISSILE_EFFECT_NAME_FAT_ARROW),this.missilesExplosionAnimation=this.spellFxSpritesheet.getSpriteAnimation(O.DAMAGE_EFFECT_NAME_BLUE_DAMAGE));let r=e.lineWidth;e.lineWidth=4,e.strokeStyle="#FFA1";for(let s=0;s<this.missilesArray.length;s++)this.renderMissiles(e,t,this.missilesArray[s]);e.lineWidth=r}renderMissiles(e,t,i){if(!i.skillActive)return;let r=i.missiles;for(let a=0;a<r.length;a++){let h=r[a];if(!h||!h.active)continue;let m=h.startPosition,p=h.position;e.beginPath(),t.worldToScreen(m,this.screenCoordinate),e.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),this.screenCoordinate.copy(p),t.worldToScreen(this.screenCoordinate,this.screenCoordinate),e.lineTo(this.screenCoordinate.x,this.screenCoordinate.y),e.stroke(),this.screenCoordinate.copy(p),this.screenCoordinate.subtractXY(n.tile.halfSize,n.tile.halfSize),t.worldToScreen(this.screenCoordinate,this.screenCoordinate);let f=this.missilesSkillAnimation.getDirectionSprite(h.spriteDirection);this.renderSprite(e,t,f,this.screenCoordinate)}let s=Date.now(),o=i.missileExplosions;for(let a=0;a<o.length;a++){let h=o[a];if(!h.active)continue;let m=this.missilesExplosionAnimation.getSlowCurrentSpriteAsOfNoLooping(s,h.time);if(!m){h.deactivate();continue}this.screenCoordinate.copy(h.position),this.screenCoordinate.subtractXY(n.tile.halfSize,n.tile.halfSize),t.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.renderSprite(e,t,m,this.screenCoordinate)}}};var at=class extends fe{constructor(e,t,i,r,s,o,a){super(e,"Missiles + "+n.skill.missiles.missilesPerUpgrade,null,t,i,r,s,o,a)}getDescription(){return"Missiles: "+Ye.getMissileCount(this.numberValue)}};var qo=class extends Ne{constructor(e,t,i,r,s){super(ne.MISSILE),this.worldGrid=e,this.tileMinedLogic=i,this.missilesUpgrades=new we(null,0),this.missilesArray=[],this.missilesByCharacter={},this.renderer=new Zo(this.missilesArray,s);let o=1,a=this.addNode(new ke("addMissileMiner1","+1 Missile Miner","Fire volleys of missiles",t,c.skill.missiles,new d(o+n.skill.costs.addMissile1),this,r,ne.MISSILE));o++;let h=this.addNode(new at("missileBonus1",t,c.skill.missiles,new d(o),this,1,this.missilesUpgrades)),m=this.addNode(new re("missileCool1",t,c.skill.missiles,new d(o),this,1,this.coolDownUpgrades)),p=this.addNode(new se("missileDur1",t,c.skill.missiles,new d(o),this,1,this.durationUpgrades));o++;let f=this.addNode(new at("missileBonus2",t,c.skill.missiles,new d(o),this,1,this.missilesUpgrades)),N=this.addNode(new re("missileCool2",t,c.skill.missiles,new d(o),this,1,this.coolDownUpgrades)),T=this.addNode(new se("missileDur2",t,c.skill.missiles,new d(o),this,1,this.durationUpgrades));o++;let C=this.addNode(new at("missileBonus3",t,c.skill.missiles,new d(o),this,1,this.missilesUpgrades)),w=this.addNode(new re("missileCool3",t,c.skill.missiles,new d(o),this,1,this.coolDownUpgrades)),E=this.addNode(new se("missileDur3",t,c.skill.missiles,new d(o),this,1,this.durationUpgrades)),P=this.addNode(new ke("addMissileMiner2","+1 Missile Miner","Fire volleys of missiles",t,c.skill.missiles,new d(o+n.skill.costs.addMiner2),this,r,ne.MISSILE));o++;let S=this.addNode(new at("missileBonus4",t,c.skill.missiles,new d(o),this,1,this.missilesUpgrades)),A=this.addNode(new re("missileCool4",t,c.skill.missiles,new d(o),this,1,this.coolDownUpgrades)),_=this.addNode(new se("missileDur4",t,c.skill.missiles,new d(o),this,1,this.durationUpgrades));o++;let L=this.addNode(new at("missileBonus5",t,c.skill.missiles,new d(o),this,1,this.missilesUpgrades)),W=this.addNode(new re("missileCool5",t,c.skill.missiles,new d(o),this,1,this.coolDownUpgrades)),x=this.addNode(new se("missileDur5",t,c.skill.missiles,new d(o),this,1,this.durationUpgrades));o++;let J=this.addNode(new at("missileBonus6",t,c.skill.missiles,new d(o),this,1,this.missilesUpgrades)),ie=this.addNode(new re("missileCool6",t,c.skill.missiles,new d(o),this,1,this.coolDownUpgrades)),Y=this.addNode(new se("missileDur6",t,c.skill.missiles,new d(o),this,1,this.durationUpgrades)),X=this.addNode(new ke("addMissileMiner3","+1 Missile Miner","Fire volleys of missiles",t,c.skill.missiles,new d(o+n.skill.costs.addMiner3),this,r,ne.MISSILE));o++;let B=this.addNode(new at("missileBonus7",t,c.skill.missiles,new d(o),this,1,this.missilesUpgrades)),k=this.addNode(new re("missileCool7",t,c.skill.missiles,new d(o),this,1,this.coolDownUpgrades)),Ce=this.addNode(new se("missileDur7",t,c.skill.missiles,new d(o),this,1,this.durationUpgrades));o++;let me=this.addNode(new at("missileBonus8",t,c.skill.missiles,new d(o),this,1,this.missilesUpgrades)),Ae=this.addNode(new re("missileCool8",t,c.skill.missiles,new d(o),this,1,this.coolDownUpgrades)),j=this.addNode(new se("missileDur8",t,c.skill.missiles,new d(o),this,1,this.durationUpgrades));o++;let D=this.addNode(new at("missileBonus9",t,c.skill.missiles,new d(o),this,1,this.missilesUpgrades)),te=this.addNode(new re("missileCool9",t,c.skill.missiles,new d(o),this,1,this.coolDownUpgrades)),We=this.addNode(new se("missileDur9",t,c.skill.missiles,new d(o),this,1,this.durationUpgrades)),Xe=this.addNode(new ke("addMissileMiner4","+1 Missile Miner","Fire volleys of missiles",t,c.skill.missiles,new d(o+n.skill.costs.addMiner4),this,r,ne.MISSILE));a.addChildNode(h),h.addChildNode(f),f.addChildNode(C),C.addChildNode(S),S.addChildNode(L),L.addChildNode(J),J.addChildNode(B),B.addChildNode(me),me.addChildNode(D),h.addChildNode(m),f.addChildNode(N),C.addChildNode(w),S.addChildNode(A),L.addChildNode(W),J.addChildNode(ie),B.addChildNode(k),me.addChildNode(Ae),D.addChildNode(te),m.addChildNode(p),N.addChildNode(T),w.addChildNode(E),A.addChildNode(_),W.addChildNode(x),ie.addChildNode(Y),k.addChildNode(Ce),Ae.addChildNode(j),te.addChildNode(We),C.addChildNode(P),J.addChildNode(X),D.addChildNode(Xe);let G=3,F=-3;a.setPosition(G,F),h.setPosition(G+1,F),f.setPosition(G+2,F),C.setPosition(G+3,F),S.setPosition(G+4,F),L.setPosition(G+5,F),J.setPosition(G+6,F),B.setPosition(G+7,F),me.setPosition(G+8,F),D.setPosition(G+9,F),m.setPosition(G+1,F-1),N.setPosition(G+2,F-1),w.setPosition(G+3,F-1),A.setPosition(G+4,F-1),W.setPosition(G+5,F-1),ie.setPosition(G+6,F-1),k.setPosition(G+7,F-1),Ae.setPosition(G+8,F-1),te.setPosition(G+9,F-1),p.setPosition(G+1,F-2),T.setPosition(G+2,F-2),E.setPosition(G+3,F-2),_.setPosition(G+4,F-2),x.setPosition(G+5,F-2),Y.setPosition(G+6,F-2),Ce.setPosition(G+7,F-2),j.setPosition(G+8,F-2),We.setPosition(G+9,F-2),P.setPosition(G+3,F+1),X.setPosition(G+6,F+1),Xe.setPosition(G+9,F+1)}updateSkillForFrame(e,t,i){let r=this.missilesByCharacter[e.id];r||(r=new jo(this.worldGrid,this.missilesUpgrades,this.tileMinedLogic),this.missilesByCharacter[e.id]=r,this.missilesArray.push(r)),i&&!r.skillActive?r.onSkillActivation():!i&&r.skillActive&&r.onSkillDeactivation(),i&&r.updateForFrame(e,t)}getRenderer(){return this.renderer}resetFull(){super.resetFull(),this.missilesArray.length=0,this.missilesByCharacter={},this.missilesUpgrades.reset()}};var Fl=2*Math.PI,Ad=Math.PI/50,Jo=class{constructor(e,t,i,r){this.worldGrid=e,this.tileMinedLogic=t,this.character=i,this.center=new b(0,0),this.range=0,this.radians=0,this.endPoint=new b(0,0),this.initialize(r)}onSkillActivation(e){this.initialize(e)}initialize(e){this.center.copy(this.character.position.worldCoordinateOrigin),this.center.addXY(n.tile.halfSize,n.tile.halfSize),this.range=e,ut.projectPosition(this.center,this.range,this.radians,this.endPoint)}updateForFrame(e){this.center.copy(this.character.position.worldCoordinateOrigin),this.center.addXY(n.tile.halfSize,n.tile.halfSize),this.radians+=e*Ad,this.radians>Fl&&(this.radians-=Fl),ut.projectPosition(this.center,this.range,this.radians,this.endPoint);let t=this.worldGrid.findGridTile(this.endPoint);t&&(t.lighting.everVisibleToCharacter||t.markTileAsCurrentlyVisible(),t.open||this.tileMinedLogic.orbitTileForFrame(t,e))}};var Qo=class{constructor(e,t,i,r){this.worldGrid=e,this.orbitRangeUpgrades=t,this.orbMaxUpgrades=i,this.tileMinedLogic=r,this.orbitPairs=[],this.lastPairTime=0,this.orbitIntervalMillis=500,this.skillActive=!1}onSkillActivation(){this.skillActive=!0;let e=n.skill.orbit.minRangePixels+this.orbitRangeUpgrades.getValue()*n.skill.orbit.rangePixelsPerUpgrade;for(let t=0;t<this.orbitPairs.length;t++)this.orbitPairs[t].onSkillActivation(e)}onSkillDeactivation(){this.skillActive=!1}updateForFrame(e,t){let i=n.skill.orbit.minRangePixels+this.orbitRangeUpgrades.getValue()*n.skill.orbit.rangePixelsPerUpgrade,r=!1,s=1+this.orbMaxUpgrades.getValue();for(;this.orbitPairs.length<s;)this.orbitPairs.push(new Jo(this.worldGrid,this.tileMinedLogic,e,i)),r=!0;if(r&&this.orbitPairs.length>1){let o=2*Math.PI/this.orbitPairs.length,a=0;for(let h=0;h<this.orbitPairs.length;h++)this.orbitPairs[h].radians=a,a+=o}for(let o=0;o<this.orbitPairs.length;o++)this.orbitPairs[o].range=i,this.orbitPairs[o].updateForFrame(t)}};var $o=class extends nt{constructor(e,t){super(),this.orbitArray=e,this.spellFxSpritesheet=t,this.skillAnimation=null,this.skillStart=Date.now()}renderSkill(e,t){if(this.orbitArray.length===0)return;let i=e.lineWidth;e.lineWidth=4,e.strokeStyle="#AFA1";for(let r=0;r<this.orbitArray.length;r++)this.renderOrbit(e,t,this.orbitArray[r]);e.lineWidth=i}renderOrbit(e,t,i){if(!i.skillActive)return;let r=Date.now();r-this.skillStart>1e5&&(this.skillStart=r),this.skillAnimation||(this.skillAnimation=this.spellFxSpritesheet.getSpriteAnimation(O.EFFECT_NAME_ORANGE_STAR));let s=i.orbitPairs;for(let o=0;o<s.length;o++){let a=s[o];e.beginPath(),t.worldToScreen(a.center,this.screenCoordinate),e.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),this.screenCoordinate.copy(a.endPoint),this.screenCoordinate.addXY(n.tile.halfSize,n.tile.halfSize),t.worldToScreen(this.screenCoordinate,this.screenCoordinate),e.lineTo(this.screenCoordinate.x,this.screenCoordinate.y),e.stroke(),this.screenCoordinate.copy(a.endPoint),t.worldToScreen(this.screenCoordinate,this.screenCoordinate);let h=this.skillAnimation.getSpriteAsOf(Date.now(),this.skillStart);this.renderSprite(e,t,h,this.screenCoordinate)}}};var en=class extends Ne{constructor(e,t,i,r,s){super(ne.ORBIT),this.worldGrid=e,this.tileMinedLogic=i,this.totals=t,this.crew=r,this.orbMaxUpgrades=new we(null,0),this.orbitRangeUpgrades=new we(null,0),this.orbitArray=[],this.orbitByCharacter={},this.renderer=new $o(this.orbitArray,s);let o=1,a=this.addNode(new ke("addOrbitMiner1","+1 Orbit Miner","Orbiting Damage",t,c.skill.orbit,new d(o+n.skill.costs.addOrbit1),this,r,ne.ORBIT));o++;let h=this.addNode(new fe("orbitRange1","+1/2 Tile","Tile Range +0.5",t,c.skill.orbit,new d(o),this,1,this.orbitRangeUpgrades)),m=this.addNode(new fe("orbBonus1","+1 Orb","More Orbs",t,c.skill.orbit,new d(o),this,1,this.orbMaxUpgrades)),p=this.addNode(new re("orbCool1",t,c.skill.orbit,new d(o),this,1,this.coolDownUpgrades)),f=this.addNode(new se("orbDur1",t,c.skill.orbit,new d(o),this,1,this.durationUpgrades));o++;let N=this.addNode(new fe("orbitRange2","+1/2 Tile","Tile Range +0.5",t,c.skill.orbit,new d(o),this,1,this.orbitRangeUpgrades)),T=this.addNode(new fe("orbBonus2","+1 Orb","More Orbs",t,c.skill.orbit,new d(o),this,1,this.orbMaxUpgrades)),C=this.addNode(new re("orbCool2",t,c.skill.orbit,new d(o),this,1,this.coolDownUpgrades)),w=this.addNode(new se("orbDur2",t,c.skill.orbit,new d(o),this,1,this.durationUpgrades));o++;let E=this.addNode(new fe("orbitRange3","+1/2 Tile","Tile Range +0.5",t,c.skill.orbit,new d(o),this,1,this.orbitRangeUpgrades)),P=this.addNode(new fe("orbBonus3","+1 Orb","More Orbs",t,c.skill.orbit,new d(o),this,1,this.orbMaxUpgrades)),S=this.addNode(new re("orbCool3",t,c.skill.orbit,new d(o),this,1,this.coolDownUpgrades)),A=this.addNode(new se("orbDur3",t,c.skill.orbit,new d(o),this,1,this.durationUpgrades)),_=this.addNode(new ke("addOrbitMiner2","+1 Orbit Miner","Orbiting Damage",t,c.skill.orbit,new d(o+n.skill.costs.addMiner2),this,r,ne.ORBIT));o++;let L=this.addNode(new fe("orbitRange4","+1/2 Tile","Tile Range +0.5",t,c.skill.orbit,new d(o),this,1,this.orbitRangeUpgrades)),W=this.addNode(new fe("orbBonus4","+1 Orb","More Orbs",t,c.skill.orbit,new d(o),this,1,this.orbMaxUpgrades)),x=this.addNode(new re("orbCool4",t,c.skill.orbit,new d(o),this,1,this.coolDownUpgrades)),J=this.addNode(new se("orbDur4",t,c.skill.orbit,new d(o),this,1,this.durationUpgrades));o++;let ie=this.addNode(new fe("orbitRange5","+1/2 Tile","Tile Range +0.5",t,c.skill.orbit,new d(o),this,1,this.orbitRangeUpgrades)),Y=this.addNode(new fe("orbBonus5","+1 Orb","More Orbs",t,c.skill.orbit,new d(o),this,1,this.orbMaxUpgrades)),X=this.addNode(new re("orbCool5",t,c.skill.orbit,new d(o),this,1,this.coolDownUpgrades)),B=this.addNode(new se("orbDur5",t,c.skill.orbit,new d(o),this,1,this.durationUpgrades));o++;let k=this.addNode(new fe("orbitRange6","+1/2 Tile","Tile Range +0.5",t,c.skill.orbit,new d(o),this,1,this.orbitRangeUpgrades)),Ce=this.addNode(new fe("orbBonus6","+1 Orb","More Orbs",t,c.skill.orbit,new d(o),this,1,this.orbMaxUpgrades)),me=this.addNode(new re("orbCool6",t,c.skill.orbit,new d(o),this,1,this.coolDownUpgrades)),Ae=this.addNode(new se("orbDur6",t,c.skill.orbit,new d(o),this,1,this.durationUpgrades)),j=this.addNode(new ke("addOrbitMiner3","+1 Orbit Miner","Orbiting Damage",t,c.skill.orbit,new d(o+n.skill.costs.addMiner3),this,r,ne.ORBIT));o++;let D=this.addNode(new fe("orbitRange7","+1/2 Tile","Tile Range +0.5",t,c.skill.orbit,new d(o),this,1,this.orbitRangeUpgrades)),te=this.addNode(new fe("orbBonus7","+1 Orb","More Orbs",t,c.skill.orbit,new d(o),this,1,this.orbMaxUpgrades)),We=this.addNode(new re("orbCool7",t,c.skill.orbit,new d(o),this,1,this.coolDownUpgrades)),Xe=this.addNode(new se("orbDur7",t,c.skill.orbit,new d(o),this,1,this.durationUpgrades));o++;let G=this.addNode(new fe("orbitRange8","+1/2 Tile","Tile Range +0.5",t,c.skill.orbit,new d(o),this,1,this.orbitRangeUpgrades)),F=this.addNode(new fe("orbBonus8","+1 Orb","More Orbs",t,c.skill.orbit,new d(o),this,1,this.orbMaxUpgrades)),ue=this.addNode(new re("orbCool8",t,c.skill.orbit,new d(o),this,1,this.coolDownUpgrades)),ae=this.addNode(new se("orbDur8",t,c.skill.orbit,new d(o),this,1,this.durationUpgrades));o++;let Yt=this.addNode(new fe("orbitRange9","+1/2 Tile","Tile Range +0.5",t,c.skill.orbit,new d(o),this,1,this.orbitRangeUpgrades)),It=this.addNode(new re("orbCool9",t,c.skill.orbit,new d(o),this,1,this.coolDownUpgrades)),Mt=this.addNode(new fe("orbBonus9","+1 Orb","More Orbs",t,c.skill.orbit,new d(o),this,1,this.orbMaxUpgrades)),nl=this.addNode(new se("orbDur9",t,c.skill.orbit,new d(o),this,1,this.durationUpgrades)),Tl=this.addNode(new ke("addOrbitMiner4","+1 Orbit Miner","Orbiting Damage",t,c.skill.orbit,new d(o+n.skill.costs.addMiner4),this,r,ne.ORBIT));a.addChildNode(m),m.addChildNode(T),T.addChildNode(P),P.addChildNode(W),W.addChildNode(Y),Y.addChildNode(Ce),Ce.addChildNode(te),te.addChildNode(F),F.addChildNode(Mt),m.addChildNode(p),T.addChildNode(C),P.addChildNode(S),W.addChildNode(x),Y.addChildNode(X),Ce.addChildNode(me),te.addChildNode(We),F.addChildNode(ue),Mt.addChildNode(It),p.addChildNode(f),C.addChildNode(w),S.addChildNode(A),x.addChildNode(J),X.addChildNode(B),me.addChildNode(Ae),We.addChildNode(Xe),ue.addChildNode(ae),It.addChildNode(nl),f.addChildNode(h),w.addChildNode(N),A.addChildNode(E),J.addChildNode(L),B.addChildNode(ie),Ae.addChildNode(k),Xe.addChildNode(D),ae.addChildNode(G),nl.addChildNode(Yt),P.addChildNode(_),Ce.addChildNode(j),Mt.addChildNode(Tl);let de=3,he=3;a.setPosition(de,he),m.setPosition(de+1,he),T.setPosition(de+2,he),P.setPosition(de+3,he),W.setPosition(de+4,he),Y.setPosition(de+5,he),Ce.setPosition(de+6,he),te.setPosition(de+7,he),F.setPosition(de+8,he),Mt.setPosition(de+9,he),p.setPosition(de+1,he-1),C.setPosition(de+2,he-1),S.setPosition(de+3,he-1),x.setPosition(de+4,he-1),X.setPosition(de+5,he-1),me.setPosition(de+6,he-1),We.setPosition(de+7,he-1),ue.setPosition(de+8,he-1),It.setPosition(de+9,he-1),f.setPosition(de+1,he-2),w.setPosition(de+2,he-2),A.setPosition(de+3,he-2),J.setPosition(de+4,he-2),B.setPosition(de+5,he-2),Ae.setPosition(de+6,he-2),Xe.setPosition(de+7,he-2),ae.setPosition(de+8,he-2),nl.setPosition(de+9,he-2),h.setPosition(de+1,he-3),N.setPosition(de+2,he-3),E.setPosition(de+3,he-3),L.setPosition(de+4,he-3),ie.setPosition(de+5,he-3),k.setPosition(de+6,he-3),D.setPosition(de+7,he-3),G.setPosition(de+8,he-3),Yt.setPosition(de+9,he-3),_.setPosition(de+3,he+1),j.setPosition(de+6,he+1),Tl.setPosition(de+9,he+1)}updateSkillForFrame(e,t,i){let r=this.orbitByCharacter[e.id];r||(r=new Qo(this.worldGrid,this.orbitRangeUpgrades,this.orbMaxUpgrades,this.tileMinedLogic),this.orbitByCharacter[e.id]=r,this.orbitArray.push(r)),i&&!r.skillActive?r.onSkillActivation():!i&&r.skillActive&&r.onSkillDeactivation(),i&&r.updateForFrame(e,t)}getRenderer(){return this.renderer}resetFull(){super.resetFull(),this.orbitArray.length=0,this.orbitByCharacter={},this.orbMaxUpgrades.reset(),this.orbitRangeUpgrades.reset()}};var tn=class{constructor(e,t){this.durationUpgrades=e,this.coolDownUpgrades=t,this.skillActive=!1,this.startTurn=0}initialize(e,t){this.skillActive=!1,this.startTurn=e-Ye.getSkillCoolDownTurns(this.coolDownUpgrades)+t}updateForTurn(e){let t=e-this.startTurn;this.skillActive?this.skillActive=t<Ye.getSkillActivationTurns(this.durationUpgrades):t>Ye.getSkillCoolDownTurns(this.coolDownUpgrades)&&(this.startTurn=e,this.skillActive=!0)}isSkillActive(){return this.skillActive}};var rn=class{constructor(e,t,i){this.groupOffset=e,this.durationUpgrades=t,this.coolDownUpgrades=i,this.staggeredTurns=n.time.turnsPerSecond*20,this.activationTimers=[]}setMinerCount(e,t){for(;this.activationTimers.length<t;)this.activationTimers.push(new tn(this.durationUpgrades,this.coolDownUpgrades));this.initializeTimers(e)}initializeTimers(e){let t=0;for(let i=0;i<this.activationTimers.length;i++)this.activationTimers[i].initialize(e,this.groupOffset+t),t+=this.staggeredTurns}updateForTurn(e){for(let t=0;t<this.activationTimers.length;t++)this.activationTimers[t].updateForTurn(e)}isSkillActive(e){return this.activationTimers[e].isSkillActive()}resetForPrestige(){this.initializeTimers(0)}};var sn=class{constructor(e,t,i){this.gameTime=e,this.skillType=t,this.miners=[],this.skillActivationTracker=new rn(i,t.durationUpgrades,t.coolDownUpgrades)}addMiner(e){this.miners.push(e),this.skillActivationTracker.setMinerCount(this.gameTime.turnNumber,this.miners.length)}updateSkillsForTurn(e){this.skillActivationTracker.updateForTurn(e)}updateSkillsForFrame(e){for(let t=0;t<this.miners.length;t++)this.skillType.updateSkillForFrame(this.miners[t],e,this.skillActivationTracker.isSkillActive(t))}resetForPrestige(){this.skillActivationTracker.resetForPrestige()}};var on=class extends z{constructor(e,t,i,r,s,o,a,h,m){super(),this.gameTime=e,this.skills=[],this.skillById={},this.skillGroups=[],this.skillGroupMinerCount=-1,this.crew=a,this.centerOffset=new b(0,0),this.zoom=100,this.addSkill(new qo(t,i,s,a,m)),this.addSkill(new Ko(t,i,s,a,e,m,h)),this.addSkill(new zo(t,i,s,a,m)),this.addSkill(new en(t,i,s,a,m)),this.addSkill(new Fo(i,r)),this.addSkill(new Go(i,r,o)),this.addSkill(new Bo(i,r,o)),this.addSkill(new ko(i,r)),this.addSkill(new Vo(i,r)),this.addSkill(new xo(i,r)),this.addSkill(new Do(i,r)),this.addSkill(new Oo(i,r))}updateCenter(e,t){let i=this.zoom/100,r=e/i,s=t/i;this.centerOffset.addXY(r,s)}addSkill(e){this.skills.push(e),this.skillById[e.id]=e}findSkillById(e){return this.skillById[e]}findSkillGroupById(e){for(let t=0;t<this.skillGroups.length;t++){let i=this.skillGroups[t];if(e===i.skillType.id)return i}return null}rebuildSkillGroups(){this.skillGroups.length=0;let e=this.crew.miners,t=0;for(let i=0;i<e.length;i++){let r=e[i],s=r.skillId;if(!s)continue;let o=this.findSkillGroupById(s);if(!o){let a=this.findSkillById(s);if(!a){console.log("SkillTreeGraph.rebuildSkillGroups() Failed to find skill: "+s);continue}o=new sn(this.gameTime,a,t),this.skillGroups.push(o),t+=n.time.turnsPerSecond*5}o.addMiner(r)}}updateSkillsForTurn(){this.assertMinerCountMatchesSkillGroups();let e=this.gameTime.turnNumber;for(let t=0;t<this.skillGroups.length;t++)this.skillGroups[t].updateSkillsForTurn(e)}updateSkillsForFrame(e){this.assertMinerCountMatchesSkillGroups();for(let t=0;t<this.skillGroups.length;t++)this.skillGroups[t].updateSkillsForFrame(e)}assertMinerCountMatchesSkillGroups(){let e=this.crew.miners;this.skillGroupMinerCount!=e.length&&(this.skillGroupMinerCount=e.length,this.rebuildSkillGroups())}setZoom(e){this.zoom=e,this.zoom<n.skillGraph.minZoom&&(this.zoom=n.skillGraph.minZoom),this.zoom>n.skillGraph.maxZoom&&(this.zoom=n.skillGraph.maxZoom)}zoomOut(){this.zoom-=n.skillGraph.zoomStep,this.zoom<n.skillGraph.minZoom&&(this.zoom=n.skillGraph.minZoom)}zoomIn(){this.zoom+=n.skillGraph.zoomStep,this.zoom>n.skillGraph.maxZoom&&(this.zoom=n.skillGraph.maxZoom)}resetFull(){for(let e=0;e<this.skills.length;e++)this.skills[e].resetFull();this.skillGroups.length=0}resetForPrestige(){for(let e=0;e<this.skillGroups.length;e++)this.skillGroups[e].resetForPrestige()}};var Qi=class{constructor(){}static generateSave(e){let t={};t.skills=[];for(let i=0;i<e.skills.length;i++)t.skills.push(this.generateSkillSave(e.skills[i]));return t}static loadSave(e,t){if(!t){console.log("SkillTreeSave.loadSave() No save state. Not loading skills!");return}let i=t.skills;if(!i||i.length===0){console.log("SkillTreeSave.loadSave() No skill save data found");return}for(let r=0;r<i.length;r++)try{this.loadSkillSave(e,i[r])}catch(s){console.error("SkillTreeSave.loadSave() Failed to load skill.",s.message)}}static generateSkillSave(e){let t={};t.id=e.id,t.points=v.save(e.pointsSpent),t.unlocked=e.unlocked,t.nodes=[];for(let i=0;i<e.nodes.length;i++)t.nodes.push(this.generateSkillNodeSave(e.nodes[i]));return t}static loadSkillSave(e,t){if(!t)return;let i=t.id;if(!i){console.log("SkillTreeSave.loadSkillSave() No id found for skill.");return}let r=e.findSkillById(i);if(!r){console.log("SkillTreeSave.loadSkillSave() Failed to find skill for id="+i);return}v.load(t.points,r.pointsSpent),r.unlocked=t.unlocked;let s=t.nodes;if(!s||s.length===0){console.log("SkillTreeSave.loadSkillSave() No skill nodes saved for skill id="+i);return}for(let o=0;o<s.length;o++)this.loadSkillNodeSave(r,s[o]);r.onSaveLoad()}static generateSkillNodeSave(e){let t={};return t.id=e.id,t.purchased=e.purchased,t}static loadSkillNodeSave(e,t){if(!t){console.log("SkillTreeSave.loadSkillNodeSave() No node save state.");return}let i=t.id;if(!i){console.log("SkillTreeSave.loadSkillNodeSave() No id found for skill node.");return}let r=e.getSkillNodeById(i);if(!r){console.log("SkillTreeSave.loadSkillNodeSave() No skill node found for id="+i);return}if(t.purchased)try{r.onPurchaseFromSave()}catch(s){throw console.error("SaveTreeSave.loadSkillNodeSave() Failed to load skill node: "+i,s.message),s}}};var $i=class{constructor(){}static generateSave(e){let t={};return t.basePick=v.save(e.basePickDamagePerTurn),t.totalPick=v.save(e.totalPickDamagePerTurn),t}static loadSave(e,t){t&&(v.load(t.basePick,e.basePickDamagePerTurn),v.load(t.totalPick,e.totalPickDamagePerTurn))}};var nn=class{constructor(e,t,i,r,s,o,a,h){this.id=e,this.title=t,this.description=i,this.spriteFileName=r,this.gameTime=s,this.totals=o,this.cost=a,this.activationTurns=h,this.activated=!1,this.startTurn=0}getTitle(){return this.title}getDescription(){return this.description}isAffordable(){return this.cost.lessThanEquals(this.totals.gold)}isPurchasable(){return!(this.activated||!this.isAffordable())}onPurchase(){this.isPurchasable()&&(this.totals.decrementGold(this.cost),this.onActivation())}getActivationPercent(){if(!this.activated)return 0;let e=this.gameTime.turnNumber-this.startTurn;return Math.min(1,e/this.activationTurns)*100}onActivation(){return this.activated?!1:(this.startTurn=this.gameTime.turnNumber,this.activated=!0,!0)}onActivationFromSave(){this.activated=!0}onDeactivation(){return this.activated?(this.activated=!1,!0):!1}updateForTurn(){if(this.activated){let e=this.gameTime.turnNumber;this.activated=e-this.startTurn<this.activationTurns,this.activated||this.onDeactivation()}}getActivationValue(){}reset(){this.activated=!1,this.startTurn=0}};var Ut=class{constructor(e,t,i){this.id=e,this.gameTime=t,this.totals=i}createBonus(){}createBonusFromSave(e){}};var Ht=class extends nn{constructor(e,t,i,r,s,o,a,h,m,p){super(e,t,i,r,s,o,a,h),this.numberValue=m,this.activeValue=p}onActivation(){return super.onActivation()?(this.numberValue.incrementValue(this.activeValue),!0):!1}onActivationFromSave(){super.onActivationFromSave(),this.numberValue.incrementValue(this.activeValue)}onDeactivation(){return super.onDeactivation()?(this.numberValue.decrementValue(this.activeValue),!0):!1}getActivationValue(){return this.activeValue}reset(){super.reset(),this.numberValue.reset()}};var an=class extends Ut{constructor(e,t,i,r){super(e,t,i),this.numberValue=r,this.cost=new d(n.bonus.activationCost)}createBonus(){return this.createBonusInternal(2)}createBonusFromSave(e){return this.createBonusInternal(e)}createBonusInternal(e){let t=n.bonus.activationTurns;return new Ht(this.id,"Gold Bonus","Gold +"+e,c.currency.gold,this.gameTime,this.totals,this.cost,t,this.numberValue,e)}};var ln=class extends Ut{constructor(e,t,i,r){super(e,t,i),this.numberValue=r,this.cost=new d(n.bonus.activationCost)}createBonus(){return this.createBonusInternal(50)}createBonusFromSave(e){return this.createBonusInternal(e)}createBonusInternal(e){let t=n.bonus.activationTurns;return new Ht(this.id,"Ore Multiplier","Ore x"+e,c.currency.ore,this.gameTime,this.totals,this.cost,t,this.numberValue,e)}};var dn=class extends Ut{constructor(e,t,i,r){super(e,t,i),this.numberValue=r,this.cost=new d(n.bonus.activationCost)}createBonus(){return this.createBonusInternal(10)}createBonusFromSave(e){return this.createBonusInternal(e)}createBonusInternal(e){let t=n.bonus.activationTurns;return new Ht(this.id,"Upgrade Multiplier","Upgrades x"+e,c.currency.upgrades,this.gameTime,this.totals,this.cost,t,this.numberValue,e)}};var hn=class extends z{constructor(e,t,i){super(),this.gameTime=e,this.totals=t,this.values=i,this.availableBonuses=[],this.activeBonuses=[],this.availableChangeCount=0,this.activeChangeCount=0,this.bonusCreators=[],this.bonusCreatorById={},this.prevBonusTurn=-n.bonus.newBonusTurns,this.addBonusCreator(new ln("oreBonus",this.gameTime,this.totals,this.values.bonusOreMultiplier)),this.addBonusCreator(new dn("upgradeBonus",this.gameTime,this.totals,this.values.bonusUpgradeMultiplier)),this.addBonusCreator(new an("goldBonus",this.gameTime,this.totals,this.values.bonusGoldIncrement))}addBonusCreator(e){this.bonusCreators.push(e),this.bonusCreatorById[e.id]=e}add(e){if(!e){console.log("BonusCollection.add() null bonus");return}this.availableBonuses.push(e),this.availableChangeCount++}addActiveBonusFromSave(e){if(!e){console.log("BonusCollection.addActiveBonusFromSave() null bonus");return}this.activeBonuses.push(e),this.activeChangeCount++,console.log("********** addActiveBonusFromSave() ADDED ACTIVE. len="+this.activeBonuses.length)}activateBonus(e){if(console.log("****************** activatebonus "+e.id+"   current length: "+this.activeBonuses.length),e.activated){console.log("BonusCollection.activateBonus() bonus already activated.");return}this.remove(e)?(e.onPurchase(),console.log("********** activateBonus() BONUS IS ACTIVATED: "+e.activated),this.activeBonuses.push(e),this.activeChangeCount++,console.log("********** activateBonus() ADDED ACTIVE. len="+this.activeBonuses.length)):console.log("**************** failed to add active")}remove(e){if(!e)return console.log("BonusCollection.remove() bonus null"),!1;let t=this.availableBonuses.indexOf(e);return t===-1?(console.log("BonusCollection.remove() did not find bonus in list"),!1):(this.availableBonuses.splice(t,1),this.availableChangeCount++,!0)}updateForTurn(){for(let t=this.activeBonuses.length-1;t>=0;t--){let i=this.activeBonuses[t];i.updateForTurn(),i.activated||(this.activeBonuses.splice(t,1),this.activeChangeCount++)}if(this.gameTime.turnNumber-this.prevBonusTurn>=n.bonus.newBonusTurns){this.prevBonusTurn=this.gameTime.turnNumber;let t=this.createRandomBonus();this.add(t)}}createRandomBonus(){let e=Ie.randomInt(this.bonusCreators.length);return this.bonusCreators[e].createBonus()}createBonusFromSave(e,t){let i=this.bonusCreatorById[e];return i?i.createBonusFromSave(t):(console.log("BonusCollection.createBonusById() Failed to find creator by id: "+e),null)}purchaseBonus(e){return e?e.isPurchasable()?this.availableBonuses.indexOf(e)<0?(console.log("BonusCollection.purchaseBonus() failed to find bonus in available list"),!1):(this.activateBonus(e),!0):(console.log("BonusCollection.purchaseBonus() bonus not purchasable"),!1):(console.log("BonusCollection.purchaseBonus() null bonus"),!1)}resetFull(){for(let e=0;e<this.activeBonuses.length;e++)this.activeBonuses[e].reset();this.availableBonuses.length=0,this.activeBonuses.length=0,this.availableChangeCount=0,this.activeChangeCount=0,this.prevBonusTurn=-n.bonus.newBonusTurns}resetForPrestige(){this.resetFull()}};var er=class{constructor(){}static generateSave(e){let t={};t.availableBonuses=[],t.activeBonuses=[],t.prevBonusTurn=e.prevBonusTurn;for(let i=0;i<e.activeBonuses.length;i++)e.activeBonuses[i]&&t.activeBonuses.push(this.generateBonusSave(e.activeBonuses[i]));for(let i=0;i<e.availableBonuses.length;i++)e.availableBonuses[i]&&t.availableBonuses.push(this.generateBonusSave(e.availableBonuses[i]));return t}static loadSave(e,t){if(!t){console.log("BonusCollectionSave.loadSave no save state");return}let i=t.prevBonusTurn;if(i&&(e.prevBonusTurn=i),t.availableBonuses)for(let r=0;r<t.availableBonuses.length;r++)this.loadBonusSave(e,t.availableBonuses[r]);if(t.activeBonuses)for(let r=0;r<t.activeBonuses.length;r++)this.loadBonusSave(e,t.activeBonuses[r])}static generateBonusSave(e){let t={};return t.id=e.id,t.activated=e.activated,t.startTurn=e.startTurn,t.activationValue=e.getActivationValue(),t}static loadBonusSave(e,t){if(!t)return;let i=t.id,r=t.activated,s=t.startTurn,o=t.activationValue,a=e.createBonusFromSave(i,o);if(!a){console.log("BonusCollectionSave.loadBonusSave() no bonus created for: "+i);return}a.startTurn=s,r?(e.addActiveBonusFromSave(a),a.onActivationFromSave()):e.add(a)}};var un=class extends z{constructor(){super(),this.CALLBACK_GAME_RESET=1,this.CALLBACK_GAME_DELETE=2,this.CALLBACK_GAME_IMPORT=3,this.CALLBACK_GAME_PRESTIGE=4}getState(){return null}startGame(){}prestigeGame(){}resetGame(){}deleteGame(){}importSave(e){}modelLoadCallback(e){}};var zt=class extends z{constructor(e,t,i,r,s){super(),this.gameTime=e,this.automationUnlockedValue=t,this.automationRateUpgrades=i,this.baseUpgradeDelayTurns=r,this.turnsPerRateUpgrade=s,this.lastAutomationTurn=0,this.lastAutomationFrame=0,this.active=!0}getDelayTurns(){return Math.max(n.automation.minDelayTurns,this.baseUpgradeDelayTurns-this.automationRateUpgrades.getValue()*this.turnsPerRateUpgrade)}updateForTurn(){if(!this.active||!this.automationUnlockedValue.isValue())return;let e=this.gameTime.turnNumber,t=this.getDelayTurns();e-this.lastAutomationTurn<t||(this.lastAutomationTurn=e,this.lastAutomationFrame=this.gameTime.frameNumber,this.purchaseUpgrade())}purchaseUpgrade(){}isUnlocked(){return this.automationUnlockedValue.isValue()}toggleActiveFlag(){this.active=!this.active}getActivationPercent(){if(!this.active)return 0;let e=this.getDelayTurns()*n.time.turnFrames,t=this.gameTime.frameNumber-this.lastAutomationFrame;return Math.min(1,t/e)*100|0}resetFull(){this.lastAutomationTurn=0,this.lastAutomationFrame=0}resetForPrestige(){this.lastAutomationTurn=0,this.lastAutomationFrame=0}};var cn=class extends zt{constructor(e,t,i){super(e,i.minedAutomationUnlocked,i.minedAutomationRateUpgrades,n.automation.baseUpgradeDelayTurns,n.automation.turnsPerRateUpgrade),this.minedUpgradeCollection=t}purchaseUpgrade(){let e=this.minedUpgradeCollection.upgrades;if(e.length===0)return;let t=Ie.randomInt(e.length),i=e[t];i&&i.isPurchasable()&&(i.purchase(),this.minedUpgradeCollection.remove(i))}};var mn=class extends zt{constructor(e,t,i){super(e,i.pickAutomationUnlocked,i.pickAutomationRateUpgrades,n.automation.baseUpgradeDelayTurns,n.automation.turnsPerRateUpgrade),this.pickUpgradeCollection=t,this.validUpgrades=[],this.workingScore=new d(0),this.bestScore=new d(0),this.additive=!0}purchaseUpgrade(){if(this.pickUpgradeCollection.upgrades.length===0||(this.additive=!this.additive,this.findValidUpgrades(),this.validUpgrades.length===0))return;let t=this.selectBestUpgrade(this.additive);t&&t.purchase()}findValidUpgrades(){this.validUpgrades.length=0;let e=this.pickUpgradeCollection.upgrades;for(let t=0;t<e.length;t++){let i=e[t];this.isValidUpgrade(i)&&this.validUpgrades.push(i)}}selectBestUpgrade(e){let t=this.selectBestUpgradeByType(!0),i=this.selectBestUpgradeByType(!1);return!t&&!i?null:t?i?e?t:i:t:i}selectBestUpgradeByType(e){this.bestScore.setZero();let t=null;for(let i=0;i<this.validUpgrades.length;i++){let r=this.validUpgrades[i];if(r.additiveUpgrade!==e)continue;let s=this.getUpgradeScore(r);(!t||s.greaterThan(this.bestScore))&&(t=r,this.bestScore.copy(s))}return t}getUpgradeScore(e){return this.workingScore.copy(e.valuePerUpgrade),this.workingScore.mulNumber(e.nextActualPurchaseCount),this.workingScore.div(e.getCost()),this.workingScore}isValidUpgrade(e){return e?e.isVisible()&&e.isPurchasable():!1}};var pn=class extends zt{constructor(e,t,i,r){super(e,t.prestigeAutomationUnlocked,t.prestigeAutomationRateUpgrades,n.automation.prestigeUpgradeDelayTurns,n.automation.prestigeTurnsPerRateUpgrade),this.gameStateControl=i,this.totals=r,this.prestigePossible=!1,this.prevUnclaimedPrestige=new d(0),this.lastPrestigeChangeTurn=0}updateForTurn(){this.isPrestigeCriteriaSatisfied()&&(this.lastAutomationTurn===0&&(this.lastAutomationTurn=this.gameTime.turnNumber,this.lastAutomationFrame=this.gameTime.frameNumber),super.updateForTurn())}isPrestigeCriteriaSatisfied(){return this.prestigePossible?!0:this.totals.unclaimedPrestige.equalsZero()||(this.prevUnclaimedPrestige.equals(this.totals.unclaimedPrestige)||(this.prevUnclaimedPrestige.copy(this.totals.unclaimedPrestige),this.lastPrestigeChangeTurn=this.gameTime.turnNumber),this.lastPrestigeChangeTurn===0)||this.gameTime.turnNumber-this.lastPrestigeChangeTurn<n.automation.prestigeMinTurnsSinceLastChange?!1:(this.prestigePossible=!0,!0)}getElapsedTurnsSincePrestige(){return this.gameTime.turnNumber-this.lastPrestigeChangeTurn}getCriteriaPercent(){if(this.prestigePossible)return 0;let e=this.gameTime.turnNumber-this.lastPrestigeChangeTurn,t=n.automation.prestigeMinTurnsSinceLastChange;return Math.min(1,e/t)*100|0}getActivationPercent(){return this.prestigePossible?super.getActivationPercent():0}purchaseUpgrade(){this.gameStateControl.prestigeGame()}resetFull(){super.resetFull(),this.resetInternal()}resetForPrestige(){super.resetForPrestige(),this.resetInternal()}resetInternal(){this.prestigePossible=!1,this.lastPrestigeChangeTurn=0,this.prevUnclaimedPrestige.setZero()}};var gn=class extends z{constructor(e,t,i,r,s,o){super(),this.gameTime=o,this.minedUpgradeAutomation=new cn(o,e,r,o),this.pickUpgradeAutomation=new mn(o,t,r,o),this.prestigeAutomation=new pn(o,r,i,s)}updateForTurn(){this.minedUpgradeAutomation.updateForTurn(),this.pickUpgradeAutomation.updateForTurn(),this.prestigeAutomation.updateForTurn()}resetFull(){this.minedUpgradeAutomation.resetFull(),this.pickUpgradeAutomation.resetFull(),this.prestigeAutomation.resetFull()}resetForPrestige(){this.minedUpgradeAutomation.resetForPrestige(),this.pickUpgradeAutomation.resetForPrestige(),this.prestigeAutomation.resetForPrestige()}};var tr=class{constructor(){}static generateSave(e){let t={};return t.prevTurn=e.prevTurn,t.minedAutomation=this.generateAutomationSave(e.minedUpgradeAutomation),t.pickAutomation=this.generateAutomationSave(e.pickUpgradeAutomation),t.prestigeAutomation=this.generatePrestigeAutomationSave(e.prestigeAutomation),t}static loadSave(e,t){t&&(e.prevTurn=t.prevTurn,this.loadAutomationSave(e.minedUpgradeAutomation,t.minedAutomation),this.loadAutomationSave(e.pickUpgradeAutomation,t.pickAutomation),this.loadPrestigeAutomationSave(e.prestigeAutomation,t.prestigeAutomation))}static generateAutomationSave(e){let t={};return t.lastAutomationTurn=e.lastAutomationTurn,t.active=e.active,t}static loadAutomationSave(e,t){t&&(e.lastAutomationTurn=t.lastAutomationTurn,e.active=t.active)}static generatePrestigeAutomationSave(e){let t=this.generateAutomationSave(e);return t.lastPrestigeChangeTurn=e.lastPrestigeChangeTurn,t.prevUnclaimedPrestige=v.save(e.prevUnclaimedPrestige),t}static loadPrestigeAutomationSave(e,t){t&&(this.loadAutomationSave(e,t),t.prevUnclaimedPrestige&&v.load(t.prevUnclaimedPrestige,e.prevUnclaimedPrestige),t.lastPrestigeChangeTurn&&(e.lastPrestigeChangeTurn=t.lastPrestigeChangeTurn))}};var yi=class extends Ri{constructor(e,t,i,r,s,o){super(e,t,i,r,s),this.totals=o,this.initializeCosts()}getCostUnit(){return ol.GOLD}getMoney(){return this.totals.gold}decrementMoney(e){this.totals.decrementGold(e)}};var fn=class extends yi{constructor(e,t,i,r,s,o,a,h){super(e,t,i,r,s,o),this.damage=h,this.mineDamageLogic=a,this.displayedMultiplier=new d(-10),this.description=null}getDescription(){return(!this.description||!this.damage.goldDamageMultiplier.equals(this.displayedMultiplier))&&(this.displayedMultiplier.copy(this.damage.goldDamageMultiplier),this.description="x"+I.formatBigNum(this.damage.goldDamageMultiplier)),this.description}onUpgradePurchased(e,t){super.onUpgradePurchased(e,t);let i=this.damage.goldDamageMultiplier;i.equalsZero()&&i.setValue(1);let r=new d(n.gold.damageMultiplierPerUpgrade);for(let s=0;s<t;s++)i.multiply(r);this.mineDamageLogic.calculateTotalMineDamagePerTurn()}};var Tn=class extends yi{constructor(e,t,i,r,s,o,a){super(e,t,i,r,s,o),this.oreBonusValue=a,this.displayedMultiplier=new d(-10),this.description=null}getDescription(){let e=this.oreBonusValue.getValue();return(!this.description||!e.equals(this.displayedMultiplier))&&(this.displayedMultiplier.copy(e),this.description="x"+I.formatBigNum(e)),this.description}onUpgradePurchased(e,t){super.onUpgradePurchased(e,t);let i=this.oreBonusValue.getValue();i.equalsZero()&&i.setValue(1);let r=new d(n.gold.oreBonusMultiplierPerUpgrade);for(let s=0;s<t;s++)i.mul(r)}};var En=class extends Mi{constructor(e,t,i,r){super(),this.initializeUpgrades(e,t,i,r)}initializeUpgrades(e,t,i,r){this.generateDamageBonusUpgrade("goldDamage",e,this.createCostCalculator(),i,r),this.generateOreBonusUpgrade("goldOre",e,this.createCostCalculator(),t),this.addBulkCompleted()}generateDamageBonusUpgrade(e,t,i,r,s){let o=n.gold.damageMultiplierPerUpgrade,a=new fn(e,"Mine: x"+o,c.pick,i,100,t,r,s);this.addBulk(a)}generateOreBonusUpgrade(e,t,i,r){let s=n.gold.oreBonusMultiplierPerUpgrade,o=new Tn(e,"Ore: x"+s,c.currency.ore,i,100,t,r.goldOreBonusMultiplier);this.addBulk(o)}createCostCalculator(){return new _i(new d(n.gold.upgradeBaseCost),1.3)}resetForPrestige(){}};var ir=class{constructor(){}static generateSave(e){let t={};t.upgrades=[];for(let i=0;i<e.upgrades.length;i++){let r=this.generateUpgradeSave(e.upgrades[i]);r&&t.upgrades.push(r)}return t.countToPurchase=e.countToPurchase,t}static loadSave(e,t){if(!t){console.log("GoldUpgradeCollectionSave.loadSave no save state");return}if(!t.upgrades){console.log("GoldUpgradeCollectionSave.loadSave state empty");return}for(let s=0;s<t.upgrades.length;s++)this.loadUpgradeSave(e,t.upgrades[s]);let r=t.countToPurchase;r&&e.setCountToPurchase(r)}static generateUpgradeSave(e){if(e.purchasedCount===0)return null;let t={};return t.id=e.id,t.c=e.purchasedCount,t}static loadUpgradeSave(e,t){if(!t)return;let i=t.id,r=e.findById(i);if(!r){console.log("GoldUpgradeCollectionSave.loadUpgradeSave() failed to find upgrade id="+i);return}let s=t.c;s!==void 0&&r.setPurchasedCountFromSave(s)}};var wn=class extends z{constructor(e,t,i,r,s){super(),this.worldGrid=e,this.projection=t,this.vectorField=i,this.partyTarget=r,this.crew=s,this.openAirTileCost=15,this.closedTileCost=155,this.prevStartTile=null,this.prevChangeCount=-1,this.prevVectorFieldNumber=-10,this.prevShiftCount=-11,this.startTileOrigin=null,this.maxRow=0,this.minRow=0,this.vectorFieldNumber=0;let o=this;this.minePremiumTileRegionCallback=function(a){let h=a.mineTiles;a.vectorFieldNumber=o.vectorField.vectorFieldNumber;let m=0;for(let p=0;p<h.length;p++){let f=h[p];!f||f.open||(f.isCurrency()?(o.vectorField.currencyMiningCandidates.push(f),m++):(o.vectorField.priorityMiningCandidates.push(f),m++),f.pathData.setMineScore(tt.PREMIUM,o.vectorField.vectorFieldNumber))}},this.commonTileRegionCallback=function(a){let h=a.tiles;for(let m=0;m<h.length;m++){let p=h[m];if(!p||p.tileType.rarityModifier!==R.COMMON||!p.lighting.everVisibleToCharacter||p.open)continue;let f=o.calculateCommonTileMineScore(p);p.pathData.setMineScore(f,o.vectorFieldNumber),f>tt.WORTHLESS&&o.vectorField.commonMiningCandidates.push(p)}}}generateVectorField(e,t,i,r,s,o,a){if(!e){console.log("VectorFieldGenerator - not generating: no tile");return}if(!e.getGrid().isLoaded()){console.log("VectorFieldGenerator - not generating: grid not loaded?");return}if(!r&&!(this.prevStartTile!==e||this.prevChangeCount!==this.worldGrid.changeCount||this.prevShiftCount!==this.worldGrid.shiftCount||this.prevVectorFieldNumber!==this.vectorField.vectorFieldNumber||this.vectorField.isVectorFieldMineTargetsEmpty()))return;if(this.prevStartTile=e,this.prevChangeCount=this.worldGrid.changeCount,this.prevShiftCount=this.worldGrid.shiftCount,this.startTileOrigin=e.origin,this.vectorField.commonMiningCandidates.length=0,this.vectorField.currencyMiningCandidates.length=0,this.vectorField.priorityMiningCandidates.length=0,this.vectorField.destinationTileCandidates.length=0,this.vectorField.vectorFieldNumber++,this.vectorField.centerTile=e,this.vectorField.minRow=t,this.vectorField.maxRow=i,this.maxRow=i,this.minRow=t,this.prevVectorFieldNumber=this.vectorField.vectorFieldNumber,this.vectorFieldNumber=this.vectorField.vectorFieldNumber,!o){let p=(a?8:25)*n.tile.size;ye.allNearbyRegions(this.worldGrid,this.projection,this.startTileOrigin,p,this.minePremiumTileRegionCallback)}let m=this.vectorField.currencyMiningCandidates.length+this.vectorField.priorityMiningCandidates.length;if(!s&&m<this.crew.miners.length){let p=(a?6:15)*n.tile.size;ye.allNearbyRegions(this.worldGrid,this.projection,this.startTileOrigin,p,this.commonTileRegionCallback)}this.vectorField.isVectorFieldMineTargetsEmpty()&&(this.addNearbyOpenDestinationTiles(e),this.addNearbyClosedDestinationTiles(e))}addNearbyOpenDestinationTiles(e){if(!e)return;let t=this.vectorField.destinationTileCandidates;e.open&&t.push(e);let i=e.neighbors;for(let h=0;h<i.length;h++){let m=i[h];m&&m.open&&t.push(m)}let r=e.getNeighborTopLeft(),s=e.getNeighborTopRight(),o=e.getNeighborBottomLeft(),a=e.getNeighborBottomRight();r&&r.open&&t.push(r),s&&s.open&&t.push(s),o&&o.open&&t.push(o),a&&a.open&&t.push(a)}addNearbyClosedDestinationTiles(e){if(!e)return;let t=this.vectorField.destinationTileCandidates;e.open||t.push(e);let i=e.neighbors;for(let h=0;h<i.length;h++){let m=i[h];m&&!m.open&&t.push(m)}let r=e.getNeighborTopLeft(),s=e.getNeighborTopRight(),o=e.getNeighborBottomLeft(),a=e.getNeighborBottomRight();r&&!r.open&&t.push(r),s&&!s.open&&t.push(s),o&&!o.open&&t.push(o),a&&!a.open&&t.push(a)}calculateCommonTileMineScore(e){return e.borderCode===ze.ALL_BORDERS_OPEN?tt.WORTHLESS:this.calculateNeighborTileScore(e)}calculateNeighborTileScore(e){let t=!1,i=!1,r=e.neighbors;for(let o=0;o<r.length;o++){let a=r[o];a&&(a.lighting.everVisibleToCharacter||!a.tileType.lightingSupported||(a.open?i=!0:t=!0))}let s=0;return t&&(s+=tt.COMMON_HIDDEN_NEIGHBOR),i&&(s+=tt.COMMON_REVEAL_CAVERN),s}resetFull(){this.prevStartTile=null,this.prevChangeCount=-1,this.prevVectorFieldNumber=-10,this.prevShiftCount=-11}resetForPrestige(){this.resetFull()}};var Qt=class{constructor(e,t,i){this.id=e,this.name=t,this.iconFileName=i}};var Ve={MINE_DEEPER:new Qt("1","Deeper",c.pick),MINE_SHALLOWER:new Qt("2","Shallower",c.pick),MINE_CURRENT:new Qt("3","Current Depth",c.pick),MINE_AUTO:new Qt("4","Automated",c.pick)};var Cn=class extends z{constructor(e,t,i,r,s,o){super(),this.crew=e,this.partyTarget=t,this.damage=i,this.worldGrid=r,this.vectorFieldGenerator=s,this.vectorField=o,this.crewModes=[Ve.MINE_DEEPER,Ve.MINE_SHALLOWER,Ve.MINE_CURRENT,Ve.MINE_AUTO],this.verticalShiftPixels=n.tile.size*7,this.horizontalShiftPixels=n.tile.size*10,this.mineTileStep=this.partyTarget.halfDeltaRows+25,this.prevTotalPickDamagePerTurn=new d(0),this.prevMode=null,this.workingHealth=new d(0),this.tileHealthPerDamageThreshold=new d(.1),this.activeMode=Ve.MINE_AUTO}setModeActive(e){this.activeMode=e}setActiveModeById(e){let t=this.findModeById(e);if(!t){console.log("MineControl.setActiveModeById() Failed to find mode id: "+e);return}this.setModeActive(t)}findModeById(e){for(let t=0;t<this.crewModes.length;t++){let i=this.crewModes[t];if(i.id===e)return i}return null}updateForTurn(){let e=this.crew.calculateCrewCenterTile();if(!e){console.log("MineControl.updateForTurn() no crew center tile");return}if(this.activeMode===Ve.MINE_AUTO){let t=this.partyTarget.targetMineSeconds!==this.partyTarget.defaultMineSeconds,i=!this.prevTotalPickDamagePerTurn.equals(this.damage.totalPickDamagePerTurn);(t||i)&&(this.partyTarget.targetMineSeconds=this.partyTarget.defaultMineSeconds,this.prevTotalPickDamagePerTurn.copy(this.damage.totalPickDamagePerTurn),this.partyTarget.calculateTargetRow())}else this.checkForTargetAdjust(e,this.prevMode!==this.activeMode);if(this.vectorField.tileHealthNegligible=this.isTileHealthNegligible(e),this.prevMode=this.activeMode,this.vectorField.isPriorityTileVisible()){let t=this.partyTarget.minRow-10,i=this.partyTarget.maxRow+10,r=e.getTileRow(),s=r<t||r>i,o=s||this.activeMode===Ve.MINE_DEEPER||this.activeMode===Ve.MINE_SHALLOWER;this.vectorFieldGenerator.generateVectorField(this.vectorField.centerTile,this.vectorField.minRow,this.vectorField.maxRow,!0,s,!1,o)}else this.applyMiningLogic(e)}isTileHealthNegligible(e){return e.tileType.layerDescription.calculateTileHealth(e.getTileRow(),this.workingHealth),this.workingHealth.div(this.damage.totalPickDamagePerTurn),this.workingHealth.lessThan(this.tileHealthPerDamageThreshold)}checkForTargetAdjust(e,t){let i=e.getTileRow();if(t){this.activeMode===Ve.MINE_CURRENT?this.applyMineCurrentTargetAdjust(i):this.activeMode===Ve.MINE_SHALLOWER?this.applyMineShallowerTargetAdjust(i):this.activeMode===Ve.MINE_DEEPER&&this.applyMineDeeperTargetAdjust(i);return}let r=this.partyTarget.minRow,s=this.partyTarget.maxRow;i<r?this.activeMode===Ve.MINE_SHALLOWER&&this.applyMineShallowerTargetAdjust(i):i>s?this.activeMode===Ve.MINE_DEEPER&&this.applyMineDeeperTargetAdjust(i):this.activeMode===Ve.MINE_DEEPER?this.applyMineDeeperTargetAdjust(i):this.activeMode===Ve.MINE_SHALLOWER&&this.applyMineShallowerTargetAdjust(i)}applyMineCurrentTargetAdjust(e){this.partyTarget.deriveTargetSecondsForRow(e),this.partyTarget.calculateTargetRow()}applyMineShallowerTargetAdjust(e){let t=Math.max(n.target.minTargetRow,e-this.mineTileStep);this.partyTarget.deriveTargetSecondsForRow(t),this.partyTarget.calculateTargetRow()}applyMineDeeperTargetAdjust(e){this.partyTarget.deriveTargetSecondsForRow(e+this.mineTileStep),this.partyTarget.calculateTargetRow()}applyMiningLogic(e){let t=this.partyTarget.minRow,i=this.partyTarget.maxRow,r=e.getTileRow();r<t?this.mineDeeper(e):r>i?this.mineShallower(e):this.mineCurrent(e)}mineDeeper(e){let t=this.partyTarget.halfDeltaRows,i=e.origin,r=i.y+this.verticalShiftPixels,s=this.vectorField.centerTile?Math.max(r,this.vectorField.centerTile.origin.y):r,o=this.worldGrid.findGridTileXY(i.x,s),a=!1,h=!0,m=this.vectorField.tileHealthNegligible,p=!0;if(o){let f=o.getTileRow();this.vectorFieldGenerator.generateVectorField(o,f-t,f+t,a,h,m,p)}else{let f=e.getTileRow();this.vectorFieldGenerator.generateVectorField(e,f-t,f+t,a,h,m,p)}}mineShallower(e){let t=this.partyTarget.halfDeltaRows,i=e.origin,r=Math.max(i.y-this.verticalShiftPixels,5*n.tile.size),s=this.vectorField.centerTile?Math.min(r,this.vectorField.centerTile.origin.y):r,o=this.worldGrid.findGridTileXY(i.x,s),a=!1,h=!0,m=this.vectorField.tileHealthNegligible,p=!0;if(o){let f=o.getTileRow();this.vectorFieldGenerator.generateVectorField(o,f-t,f+t,a,h,m,p)}else{let f=e.getTileRow();this.vectorFieldGenerator.generateVectorField(e,f-t,f+t,a,h,m,p)}}mineCurrent(e){let t=this.partyTarget.minRow,i=this.partyTarget.maxRow,r=this.partyTarget.targetRow,s=e.origin,o=r*n.tile.size,a=this.worldGrid.findGridTileXY(s.x,o),h=!1,m=!1,p=!1,f=!1;if(a){if(this.vectorFieldGenerator.generateVectorField(a,t,i,h,m,p,f),this.vectorField.isVectorFieldMineTargetsEmpty()){let N=this.worldGrid.findGridTileXY(s.x+this.horizontalShiftPixels,o);N&&this.vectorFieldGenerator.generateVectorField(N,t,i,!0,m,p,f)}}else{let N=e.getTileRow(),T=this.partyTarget.halfDeltaRows;this.vectorFieldGenerator.generateVectorField(e,N-T,N+T,h,m,p,f)}}resetFull(){this.setModeActive(Ve.MINE_AUTO)}resetForPrestige(){}};var rr=class{constructor(){}static generateSave(e){let t={};return t.activeId=e.activeMode.id,t}static loadSave(e,t){if(!t)return;let i=t.activeId;i?e.setActiveModeById(i):(console.log("MineControlSave.loadSave() Failed to load mine mode."),e.setModeActive(Ve.MINE_AUTO))}};var sr=class{constructor(){}static generateSave(e){let t={};return t.crewBrainDebugEnabled=e.crewBrainDebugEnabled,t}static loadSave(e,t){t&&(e.crewBrainDebugEnabled=!1,t.crewBrainDebugEnabled&&(e.crewBrainDebugEnabled=!0))}};var Sn=class{constructor(e){this.gridSaveManager=e,this.modelsSaveKey="modelsSaveV1"}loadSave(e){return this.loadModels(e)}saveGame(e){this.saveAllLoadedGrids(e),this.saveModels(e)}deleteSave(){localStorage.removeItem(this.modelsSaveKey),this.gridSaveManager.deleteAllGrids()}saveModels(e){let t=this.generateModelState(e);if(!t){console.log("SaveManager.saveModels() Failed to generate models save state");return}let i=JSON.stringify(t);if(!i){console.log("SaveManager.saveModels() Failed to stringify models state");return}let r=$t.compressToUTF16(i);if(!r){console.log("SaveManager.saveModels() Failed to compress state for models");return}localStorage.setItem(this.modelsSaveKey,r)}loadModels(e){let t=localStorage.getItem(this.modelsSaveKey);if(!t)return console.log("SaveManager.loadModels() No save found."),!1;let i=$t.decompressFromUTF16(t);if(!i)return console.log("SaveManager.loadModels() Failed to decompress save."),!1;let r=JSON.parse(i);return r?this.loadModelState(e,r):(console.log("SaveManager.loadModels() Failed to parse save as JSON."),!1)}generateModelState(e){let t={};return t.state=Ui.generateSave(e),t.gridSaveManager=ji.generateSave(e.gridSaveManager),t.time=zi.generateSave(e.gameTime),t.projection=Vi.generateSave(e.projection),t.partyTarget=Xi.generateSave(e.partyTarget),t.gameOptions=sr.generateSave(e.gameOptions),t.crew=Ki.generateSave(e.crew),t.totals=Hi.generateSave(e.totals),t.damage=$i.generateSave(e.damage),t.values=Wi.generateSave(e.values),t.runStats=Jt.generateSave(e.runStatistics),t.globalStats=Jt.generateSave(e.globalStatistics),t.minedUpgradeCollection=Yi.generateSave(e.minedUpgradeCollection),t.pickUpgradeCollection=qi.generateSave(e.pickUpgradeCollection),t.goldUpgradeCollection=ir.generateSave(e.goldUpgradeCollection),t.bonusCollection=er.generateSave(e.bonusCollection),t.automation=tr.generateSave(e.automationManager),t.mineControl=rr.generateSave(e.mineControl),t.skillTree=Qi.generateSave(e.skillTreeGraph),t}loadModelState(e,t){if(!t)return!1;let i=!0;try{Ui.loadSave(e,t.state)}catch(r){console.error("SaveManager.loadModelState() Failed to load State:",r.message),i=!1}try{ji.loadSave(e.gridSaveManager,t.gridSaveManager)}catch(r){console.error("SaveManager.loadModelState() Failed to load GridSaveManager:",r.message),i=!1}try{zi.loadSave(e.gameTime,t.time)}catch(r){console.error("SaveManager.loadModelState() Failed to load GameTime:",r.message),i=!1}try{Vi.loadSave(e.projection,t.projection)}catch(r){console.error("SaveManager.loadModelState() Failed to load Projection:",r.message),i=!1}try{Ki.loadSave(e.crew,t.crew)}catch(r){console.error("SaveManager.loadModelState() Failed to load Crew:",r.message),i=!1}try{Hi.loadSave(e.totals,t.totals)}catch(r){console.error("SaveManager.loadModelState() Failed to load Totals:",r.message),i=!1}try{$i.loadSave(e.damage,t.damage)}catch(r){console.error("SaveManager.loadModelState() Failed to load Damage:",r.message),i=!1}try{Wi.loadSave(e.values,t.values)}catch(r){console.error("SaveManager.loadModelState() Failed to load Values:",r.message),i=!1}try{Jt.loadSave(e.runStatistics,t.runStats)}catch(r){console.error("SaveManager.loadModelState() Failed to load Statistics (run):",r.message),i=!1}try{Jt.loadSave(e.globalStatistics,t.globalStats)}catch(r){console.error("SaveManager.loadModelState() Failed to load Statistics (global):",r.message),i=!1}try{Xi.loadSave(e.partyTarget,t.partyTarget)}catch(r){console.error("SaveManager.loadModelState() Failed to load PartyTarget:",r.message),i=!1}try{sr.loadSave(e.gameOptions,t.gameOptions)}catch(r){console.error("SaveManager.loadModelState() Failed to load PartyTarget:",r.message),i=!1}try{Yi.loadSave(e.minedUpgradeCollection,e.upgradeCreators,t.minedUpgradeCollection)}catch(r){console.error("SaveManager.loadModelState() Failed to load MinedUpgradeCollection:",r.message),i=!1}try{qi.loadSave(e.pickUpgradeCollection,t.pickUpgradeCollection)}catch(r){console.error("SaveManager.loadModelState() Failed to load PickUpgradeCollection:",r.message),i=!1}try{ir.loadSave(e.goldUpgradeCollection,t.goldUpgradeCollection)}catch(r){console.error("SaveManager.loadModelState() Failed to load GoldUpgradeCollection:",r.message),i=!1}try{er.loadSave(e.bonusCollection,t.bonusCollection)}catch(r){console.error("SaveManager.loadModelState() Failed to load BonusCollection:",r.message),i=!1}try{tr.loadSave(e.automationManager,t.automation)}catch(r){console.error("SaveManager.loadModelState() Failed to load AutomationSave:",r.message),i=!1}try{rr.loadSave(e.mineControl,t.mineControl)}catch(r){console.error("SaveManager.loadModelState() Failed to load MineControlSave:",r.message),i=!1}try{Qi.loadSave(e.skillTreeGraph,t.skillTree)}catch(r){console.error("SaveManager.loadModelState() Failed to load SkillTreeSave:",r.message),i=!1}return i}saveAllLoadedGrids(e){let t=e.worldGrid.grids;for(let i=0;i<t.length;i++){let r=t[i];r&&r.isLoaded()&&this.gridSaveManager.saveGridState(r)}}getSaveStateForExport(e){let t=this.generateModelState(e);if(!t)return console.log("SaveManager.getSaveState() Failed to generate models save state"),null;let i=this.gridSaveManager.generateGridStateForExport(e.worldGrid);i||console.log("SaveManager.getSaveState() Failed to generate grid state");let s=JSON.stringify({model:t,grid:i});if(!s)return console.log("SaveManager.getSaveState() Failed to stringify state"),null;let o=$t.compressToBase64(s);return o||(console.log("SaveManager.getSaveState() Failed to compress state"),null)}importSave(e,t){if(!t)return console.log("SaveManager.importSave() No save found."),!1;let i=$t.decompressFromBase64(t);if(!i)return console.log("SaveManager.importSave() Failed to decompress save."),!1;let r=JSON.parse(i);if(!r)return console.log("SaveManager.importSave() Failed to parse save as JSON."),!1;let s=r.model,o=r.grid,a=this.loadModelState(e,s);if(console.log("SaveManager.importSave() load model state:"+a),!a)return!1;this.gridSaveManager.deleteAllGrids();let h=this.gridSaveManager.importGridState(e.worldGrid,o);if(console.log("SaveManager.importSave() import grid state:"+h),h){console.log("SaveManager.importSave() saving newly imported state.");let m=e.worldGrid.grids;for(let p=0;p<m.length;p++){let f=m[p];f&&(console.log("SaveManager.importSave() SAVING GRID STATE."),this.gridSaveManager.saveGridState(f))}this.saveModels(e)}else console.log("SaveManager.importSave() FAIL modelStateLoaded="+a+" worldGridStateLoaded="+h);return h}};var Nn=class{constructor(){}playSound(e){}};var An=class extends z{constructor(e,t){super(),this.projection=e,this.crew=t,this.animating=!1,this.workingCenter=new b(0,0),this.deltaThreshold=1.5,this.targetAnimationMillis=200}startAnimation(){if(this.animating)return;if(this.crew.calculateCrewCenterCoordinate(this.workingCenter),Z.dist(this.workingCenter,this.projection.gridCenter)>n.grid.gridPixelWidth*2){this.projection.setGridCenter(this.workingCenter.x,this.workingCenter.y),this.projection.stayCenteredOnCharacter=!0;return}let t=this.workingCenter.x-this.projection.gridCenter.x,i=this.workingCenter.y-this.projection.gridCenter.y;if(t===0&&i===0){this.animating=!1,this.projection.stayCenteredOnCharacter=!0;return}this.animating=!0}updateForFrame(e){if(!this.animating)return!1;this.crew.calculateCrewCenterCoordinate(this.workingCenter);let t=this.workingCenter.x-this.projection.gridCenter.x,i=this.workingCenter.y-this.projection.gridCenter.y;if(t===0&&i===0)return this.animating=!1,!0;let r=Math.abs(t),s=Math.abs(i),o=t/this.targetAnimationMillis*n.time.defaultMillisPerFrame,a=i/this.targetAnimationMillis*n.time.defaultMillisPerFrame,h=o*e,m=a*e,p,f,N,T;return r<this.deltaThreshold||r<h?(p=this.workingCenter.x,N=!0):(p=this.projection.gridCenter.x+h,N=!1),s<this.deltaThreshold||s<m?(f=this.workingCenter.y,T=!0):(f=this.projection.gridCenter.y+m,T=!1),this.projection.setGridCenter(p,f),N&&T?(this.projection.stayCenteredOnCharacter=!0,this.animating=!1,!0):!1}resetFull(){this.animating=!1}resetForPrestige(){this.resetFull()}};var Pn=class extends ai{constructor(e){super(),this.tileMinedLogic=e}performAction(e,t,i){let r=e.target.mineTile;if(!r){e.position.resetPathPlan(),e.turnAction=null;return}if(r.open){e.target.resetTarget(),e.position.resetPathPlan(),e.turnAction=null;return}let s=e.position.tile;if(!s||!s.isNeighborTile(r)){e.target.resetTarget(),e.position.resetPathPlan(),e.turnAction=null;return}e.setCharacterAction(Q.MINE),e.position.worldCoordinateOrigin.x!==r.origin.x&&(e.position.facingLeft=e.position.worldCoordinateOrigin.x>r.origin.x),i&&this.tileMinedLogic.mineTileForTurn(e,r)&&(e.target.resetTarget(),e.position.resetPathPlan(),e.turnAction=null)}toString(){return"MineTurnAction"}};var Rn=class extends wi{constructor(e,t){super(),this.statisticsIncrementor=e,this.mineDamageLogic=t}performAction(e,t,i){super.performAction(e,t,i);let r=e.position.tile;if(!r)return;let s=this.statisticsIncrementor.globalStatitics.maxDepth,o=r.getTileRow();this.statisticsIncrementor.tileDepth(o),s<o&&this.mineDamageLogic.calculateTotalMineDamagePerTurn()}};var Mn=class{constructor(e,t,i,r,s,o,a){this.crew=e,this.vectorField=t,this.partyTarget=i,this.pathPlanFinder=r,this.mineTurnAction=new Pn(s),this.moveTurnAction=new Rn(a,o),this.unassignedMiners=[],this.unassignedMinerCount=0,this.claimedTiles=[],this.bestTiles=[],this.workingPosition=new b(0,0),this.nearDistance2=10*n.tile.size*(10*n.tile.size)}updateForTurn(){for(let e=0;e<this.crew.miners.length;e++){let t=this.crew.miners[e];t.target.invalidated&&this.invalidateTarget(t)}this.vectorField.isVectorFieldMineTargetsEmpty()?this.vectorField.destinationTileCandidates.length>0?this.assignTurnsForDestinationTiles():(console.log("CrewBrain **** walk to new area condition"),this.crewWalksToNewArea()):this.assignTurnsForVectorField(),this.setTurnActions()}assignTurnsForDestinationTiles(){let e=this.crew.miners,t=this.vectorField.destinationTileCandidates;this.claimedTiles.length=0,this.unassignedMiners.fill(null),this.unassignedMinerCount=0;for(let i=0;i<e.length;i++)this.evaluateMinerDestination(e[i]);for(let i=0;i<this.unassignedMiners.length;i++){let r=this.unassignedMiners[i];r&&t.length>0&&this.assignMinerToClosestDestinationTile(r,i,t)}if(this.unassignedMinerCount>0)for(let i=0;i<this.unassignedMiners.length;i++){let r=this.unassignedMiners[i];r&&(r.resetTurnState(),r.setCharacterAction(Q.STAND))}}assignMinerToClosestDestinationTile(e,t,i){let r=this.findClosestUnclaimedTile(e.position.worldCoordinateOrigin,i);return!r&&(r=this.findClosestTile(e.position.worldCoordinateOrigin,i),!r)?!1:(this.assignMinerTarget(e,r,null),this.claimedTiles.push(r),this.unassignedMiners[t]=null,this.unassignedMinerCount--,!0)}assignTurnsForVectorField(){let e=this.crew.miners,t=this.vectorField.priorityMiningCandidates,i=this.vectorField.currencyMiningCandidates,r=this.vectorField.commonMiningCandidates;this.claimedTiles.length=0,this.unassignedMiners.fill(null),this.unassignedMinerCount=0;for(let s=0;s<e.length;s++)this.evaluateMinerTarget(e[s]);for(let s=0;s<this.unassignedMiners.length;s++){let o=this.unassignedMiners[s];o&&(t.length>0&&this.assignMinerToClosestAvailableTile(o,s,t)||i.length>0&&this.assignMinerToClosestAvailableTile(o,s,i)||r.length>0&&this.assignMinerToClosestAvailableTile(o,s,r))}if(this.unassignedMinerCount>0)for(let s=this.unassignedMiners.length-1;s>=0;s--){let o=this.unassignedMiners[s];o&&this.assignMinerToHelpOthers(o,s)}if(this.unassignedMinerCount>0)for(let s=0;s<this.unassignedMiners.length;s++){let o=this.unassignedMiners[s];o&&(o.resetTurnState(),o.setCharacterAction(Q.STAND))}}crewWalksToNewArea(){let e=this.crew.calculateCrewCenterTile();if(!e){console.log("CrewBrain.crewWalksToNewArea() no crew center tile");return}let t=this.findNewArea(e);if(!t){console.log("CrewBrain.crewWalksToNewArea() no crew destination tile");return}let i=this.crew.miners;for(let r=0;r<i.length;r++){let s=i[r],o=s.target.targetTile;o&&this.isNearTile(o,t)||(s.position.isCenteredOnTile()||s.position.setPositionToTileOrigin(),s.resetTurnState(),this.assignWalkToTileNearCrewTarget(s,t)||console.log("CrewBrain.crewWalksToNewArea() failed to walk near target. miner "+r))}}assignMinerToHelpOthers(e,t){let i=this.findClosestTargetedMineTile(e.position.tile.origin);if(!i)return;let r=null;if(e.position.tile.isNeighborTile(i)?r=e.position.tile:r=this.findBestNeighborTile(i,e.position.tile),!r){console.log("CrewBrain.assignMinerToHelpOthers() failed to find miner for tile.");return}this.unassignedMiners[t]=null,this.unassignedMinerCount--,this.assignMinerTarget(e,r,i)}assignMinerToClosestAvailableTile(e,t,i){let r=this.findClosestUnclaimedTile(e.position.worldCoordinateOrigin,i);return!r||!this.claimTargetForMiner(e,r)?!1:(this.unassignedMiners[t]=null,this.unassignedMinerCount--,!0)}claimTargetForMiner(e,t){let i=null;return e.position.tile.isNeighborTile(t)?i=e.position.tile:i=this.findBestNeighborTile(t,e.position.tile),i?(this.assignMinerTarget(e,i,t),this.claimedTiles.push(t),!0):(console.log("CrewBrain.assignTargetForMiner() failed to find miner for tile."),!1)}evaluateMinerTarget(e){if(!e.position.tile)return;let t=e.target.mineTile;if(this.isCurrentMineTargetValid(t)){this.claimedTiles.push(e.target.mineTile);return}this.invalidateTarget(e)&&(this.unassignedMiners[this.unassignedMinerCount]=e,this.unassignedMinerCount++)}evaluateMinerDestination(e){if(!e.position.tile)return;let t=e.target.targetTile;t&&this.vectorField.destinationTileCandidates.indexOf(t)!==-1||this.invalidateTarget(e)&&(this.unassignedMiners[this.unassignedMinerCount]=e,this.unassignedMinerCount++)}invalidateTarget(e){if(!e.position.isCenteredOnTile()){if(!e.position.isNearTileOrigin())return e.target.invalidated=!0,!1;e.position.setPositionToTileOrigin()}return e.resetTurnState(),!0}isCurrentMineTargetValid(e){if(!e||e.open)return!1;let t=this.vectorField.priorityMiningCandidates,i=this.vectorField.currencyMiningCandidates;if(e.isCommon()&&(t.length>0||i.length>0)||e.pathData.getMineScore(this.vectorField.vectorFieldNumber)<=tt.WORTHLESS)return!1;if(e.isPriority()&&t.length>0&&t.indexOf(e)!==-1||e.isCurrency()&&i.length>0&&i.indexOf(e)!==-1)return!0;let r=this.vectorField.commonMiningCandidates;return!!(e.isCommon()&&r.length>0&&r.indexOf(e)!==-1)}findClosestTargetedMineTile(e){let t=this.crew.miners,i=null,r=1e6;for(let s=0;s<t.length;s++){let o=t[s].target.mineTile;if(!o)continue;let a=e.distanceSquared(o.origin);(!i||r>a)&&(i=o,r=a)}return i}findClosestUnclaimedTile(e,t){let i=null,r=1e6;for(let s=0;s<t.length;s++){let o=t[s],a=e.distanceSquared(o.origin);if(!i||r>a){if(this.claimedTiles.indexOf(o)!==-1)continue;i=o,r=a}}return i}findClosestTile(e,t){let i=null,r=1e6;for(let s=0;s<t.length;s++){let o=t[s];if(!o)continue;let a=e.distanceSquared(o.origin);(!i||r>a)&&(i=o,r=a)}return i}findClosestOpenTile(e,t){let i=null,r=1e6;for(let s=0;s<t.length;s++){let o=t[s];if(!o||!o.open)continue;let a=e.distanceSquared(o.origin);(!i||r>a)&&(i=o,r=a)}return i}setTurnActions(){let e=this.crew.miners;for(let t=0;t<e.length;t++)this.setMinerTurnAction(e[t])}setMinerTurnAction(e){let t=e.target.mineTile;e.position.pathPlan.length>0?e.turnAction=this.moveTurnAction:t&&!t.open&&e.position.tile.isNeighborTile(t)?e.turnAction=this.mineTurnAction:e.turnAction=null}findBestNeighborTile(e,t){if(e.isNeighborTile(t))return t;let i=e.getNeighbors(),r=this.findClosestOpenTile(t.origin,i);if(r&&r.open)return r;for(let a=0;a<i.length;a++){let h=i[a];if(!(!h||!h.open)&&h.isNeighborTile(t))return h}let s=null,o=1e6;for(let a=0;a<i.length;a++){let h=i[a];if(!h)continue;let m=h.origin.distanceSquared(t.origin);(!s||o>m)&&(s=h,o=m)}return s}isNearTile(e,t){return e.origin.distanceSquared(t.origin)<this.nearDistance2}assignWalkToTileNearCrewTarget(e,t){let i=0;do{let r=xt.findAvailableNearbyTile(e,this.crew,t);if(r)return this.assignMinerTarget(e,r,null),!0;i++}while(i<5);return!1}assignWalkToNewArea(e){let t=this.findNewArea(e.position.tile);return t?(this.assignMinerTarget(e,t,null),!0):!1}findNewArea(e){if(!e)return null;let t=e.getTileRow();if(t<this.partyTarget.minRow)return this.moveDown(e);if(t>this.partyTarget.maxRow)return this.moveUp(e);{let i=this.partyTarget.targetRow,r=Math.abs(i-t),s=Math.max(5,(this.partyTarget.maxRow-this.partyTarget.minRow)/5);return r<=s?this.moveRight(e):t<i?this.moveDownAndRight(e):this.moveUpAndRight(e)}}moveDown(e){let t=e.getWorldGrid();this.workingPosition.copy(e.origin),this.workingPosition.addXY(0,n.grid.regionPixelHeight*2);let i=t.findGridTile(this.workingPosition);return i?this.findBestTileNeighbor(i):(console.log("FindBestRegion.moveDown() failed to find tile"),null)}moveUp(e){let t=e.getWorldGrid();this.workingPosition.copy(e.origin),this.workingPosition.subtractXY(0,n.grid.regionPixelHeight*2);let i=t.findGridTile(this.workingPosition);return i?this.findBestTileNeighbor(i):(console.log("FindBestRegion.moveUp() failed to find tile"),null)}moveRight(e){let t=e.getWorldGrid();this.workingPosition.copy(e.origin),this.workingPosition.addXY(n.grid.regionPixelHeight*2,0);let i=t.findGridTile(this.workingPosition);return i?this.findBestTileNeighbor(i):(console.log("FindBestRegion.moveRight() failed to find tile"),null)}moveDownAndRight(e){let t=e.getWorldGrid();this.workingPosition.copy(e.origin),this.workingPosition.addXY(n.grid.regionPixelHeight*2,n.tile.size*5);let i=t.findGridTile(this.workingPosition);return i?this.findBestTileNeighbor(i):(console.log("FindBestRegion.moveRight() failed to find tile"),null)}moveUpAndRight(e){let t=e.getWorldGrid();this.workingPosition.copy(e.origin),this.workingPosition.addXY(n.grid.regionPixelHeight*2,-n.tile.size*5);let i=t.findGridTile(this.workingPosition);return i?this.findBestTileNeighbor(i):(console.log("FindBestRegion.moveRight() failed to find tile"),null)}findBestTileNeighbor(e){let t=e,i=this.calculateTileScore(e);for(let r=0;r<e.neighbors.length;r++){let s=e.neighbors[r];if(!s)continue;let o=this.calculateTileScore(s);o>i&&(t=s,i=o)}return t}calculateTileScore(e){let t=0;return e.open&&(t+=1),e.lighting.everVisibleToCharacter&&(t+=1),t}assignMinerTarget(e,t,i){e.target.setTargetTile(t,i,"crewBrain"),t!==e.position.tile&&this.pathPlanFinder.findPartyCharacterPathPlan(e.position.tile,t,e.position.pathPlan)}isDestinationTileAvailable2(e,t){if(!e)return!1;for(let i=0;i<this.crew.miners.length;i++){let r=this.crew.miners[i];if(r!==t&&(e===r.position.tile||e===r.target.targetTile))return!1}return!0}};var _n=class extends ci{constructor(){super()}resetForPrestige(){}};var Ln=class{constructor(e,t){this.totals=e,this.values=t,this.tempFormatValue=new d(0),this.workingOre=new d(0),this.workingPrestige=new d(0),this.workingGold=new d(0),this.workingRuby=new d(0)}calculateOfflineEarnings(){let e=this.totals.offlineSeconds;if(e<=0)return;console.log("OfflineLogic.calculateOfflineEarnings() offlineSeconds="+et.formatElapsedTime(e*1e3));let t=e*n.time.turnsPerSecond,i=n.offline.defaultOfflineTurns+this.values.offlineTimeUpgrades.getValue()*n.offline.turnsPerUpgrade,r=Math.min(i,t);if(r<=0){this.totals.offlineSeconds=0,this.totals.countedOfflineSeconds=0;return}this.calculateOfflineCurrency(r,this.totals.prestigePerTurn,this.workingPrestige),this.workingPrestige.greaterThanZero()&&this.totals.incrementOfflinePrestige(this.workingPrestige),this.calculateOfflineCurrency(r,this.totals.goldPerTurn,this.workingGold),this.workingGold.greaterThanZero()&&this.totals.incrementOfflineGold(this.workingGold),this.calculateOfflineCurrency(r,this.totals.rubyPerTurn,this.workingRuby),this.workingRuby.greaterThanZero()&&this.totals.incrementOfflineRuby(this.workingRuby),this.calculateOfflineCurrency(r,this.totals.orePerTurn,this.workingOre),this.workingOre.greaterThanZero()&&this.totals.incrementOfflineOre(this.workingOre),this.totals.countedOfflineSeconds=r*n.time.secondsPerTurn|0,this.totals.offlineSeconds=0}calculateOfflineCurrency(e,t,i){if(t.equalsZero()){i.setZero();return}i.copy(t),i.mulNumber(e),i.floor()}};var yn=class{constructor(){this.crewBrainDebugEnabled=!1}};var bn=class extends z{constructor(e){super(),this.gameModels=[],this.sprites=new yr,this.worldGrid=new br,this.gameModels.push(this.worldGrid),this.projection=new kr,this.gameModels.push(this.projection),this.gameTime=new Yr,this.gameModels.push(this.gameTime),this.globalStatistics=new _n,this.gameModels.push(this.globalStatistics),this.runStatistics=new ci,this.gameModels.push(this.runStatistics),this.gameOptions=new yn,this.statisticsIncrementor=new hs(this.globalStatistics,this.runStatistics),this.crew=new Xr(this.worldGrid,this.gameTime,this.sprites.characterSpritesheet,this.sprites.itemOverlaySpritesheet),this.gameModels.push(this.crew),this.gridLoadingManager=new Eo(this.worldGrid,this.projection),this.gameModels.push(this.gridLoadingManager),this.gameVisible=!0,this.gamePaused=!1,this.worldSeed=1,this.currentFps=0,this.values=new us,this.gameModels.push(this.values),this.vectorField=new Ns,this.gameModels.push(this.vectorField),this.totals=new Zr(this.gameTime),this.gameModels.push(this.totals),this.damage=new jr,this.gameModels.push(this.damage),this.effectManager=new ns(this.projection),this.gameModels.push(this.effectManager),this.lightSourceCreators=new es,this.gameModels.push(this.lightSourceCreators),this.effectCreators=new os(this.lightSourceCreators,this.sprites.spellFxSpritesheet),this.gameModels.push(this.effectCreators),this.lightingCalculator=new Ro(this.worldGrid,this.projection),this.gameModels.push(this.lightingCalculator),this.physicsManager=new _o(this.worldGrid,this.projection,this.gameTime),this.soundEffectManager=new Nn,this.infoTextProcessor=new ds(this.projection),this.gameModels.push(this.infoTextProcessor),this.partyTarget=new Lo(this.totals,this.damage),this.gameModels.push(this.partyTarget),this.mineDamageLogic=new cs(this.values,this.totals,this.damage,this.globalStatistics),this.offlineLogic=new Ln(this.totals,this.values),this.minedUpgradeCollection=new ws,this.gameModels.push(this.minedUpgradeCollection),this.pickUpgradeCollection=new bo(this.totals,this.values,this.mineDamageLogic),this.gameModels.push(this.pickUpgradeCollection),this.goldUpgradeCollection=new En(this.totals,this.values,this.mineDamageLogic,this.damage),this.gameModels.push(this.goldUpgradeCollection),this.bonusCollection=new hn(this.gameTime,this.totals,this.values),this.gameModels.push(this.bonusCollection),this.vectorFieldGenerator=new wn(this.worldGrid,this.projection,this.vectorField,this.partyTarget,this.crew),this.gameModels.push(this.vectorFieldGenerator),this.oreCalculationLogic=new ms(this.values),this.upgradeCreators=new Cs(this.values,this.totals,this.oreCalculationLogic,this.mineDamageLogic,this.minedUpgradeCollection,this.statisticsIncrementor),this.tileMinedLogic=new Ss(this.crew,this.totals,this.damage,this.values,this.statisticsIncrementor,this.minedUpgradeCollection,this.upgradeCreators,this.infoTextProcessor,this.effectCreators,this.effectManager,this.oreCalculationLogic,this.mineDamageLogic),this.skillTreeGraph=new on(this.gameTime,this.worldGrid,this.totals,this.values,this.tileMinedLogic,this.mineDamageLogic,this.crew,this.vectorField,this.sprites.spellFxSpritesheet),this.gameModels.push(this.skillTreeGraph),this.automationManager=new gn(this.minedUpgradeCollection,this.pickUpgradeCollection,e,this.values,this.totals,this.gameTime),this.gameModels.push(this.automationManager),this.pathPlanFinder=new to(this.vectorField,this.tileMinedLogic),this.gameModels.push(this.pathPlanFinder),this.crewBrain=new Mn(this.crew,this.vectorField,this.partyTarget,this.pathPlanFinder,this.tileMinedLogic,this.mineDamageLogic,this.statisticsIncrementor),this.mineControl=new Cn(this.crew,this.partyTarget,this.damage,this.worldGrid,this.vectorFieldGenerator,this.vectorField),this.gameModels.push(this.mineControl),this.characterBrains=new ro(this.pathPlanFinder),this.characterCreator=new so(this.sprites.monsterSpritesheet,this.characterBrains),this.gameModels.push(this.characterCreator),this.gridSave=new go(this.characterCreator),this.gridSaveManager=new fo(this.gridSave),this.gameModels.push(this.gridSaveManager),this.saveManager=new Sn(this.gridSaveManager),this.panAnimation=new An(this.projection,this.crew),this.gameModels.push(this.panAnimation)}initializeState(e){let t=new po(this.worldSeed,this.characterCreator),i=new To(this.gridSaveManager,t,this.worldGrid,this.crew,this.vectorField);if(this.gridLoadingManager.initializeLoadingManager(i,this.crew),this.crew.main){let r=this.worldGrid.findGridTile(this.crew.main.position.worldCoordinateOrigin);r&&this.crew.main.position.setTileAndOriginPosition(r,r.origin.x,r.origin.y)}else{let r=this.crew.createMainMiner(),s=null;e?s=this.worldGrid.findGridTile(r.position.worldCoordinateOrigin):s=this.worldGrid.findGridTileXY(n.start.startX,n.start.startY),s?r.position.setTileAndOriginPosition(s,s.origin.x,s.origin.y):e||r.position.setWorldCoordinateOriginXY(n.start.startX,n.start.startY)}if(e){let r=Date.now(),s=this.gameTime.saveTime,a=(r-s)/1e3|0;a>0&&(this.totals.offlineSeconds+=a,this.offlineLogic.calculateOfflineEarnings())}this.mineDamageLogic.calculateTotalMineDamagePerTurn()}beforeImportSave(){for(let e=0;e<this.gameModels.length;e++)this.gameModels[e].resetFull()}afterImportSave(){this.initializeState(!0),this.projection.setGridCenter(n.start.startX,n.start.startY),this.gridLoadingManager.manageLoadedGridsForFrame()}resetForPrestige(){for(let e=0;e<this.gameModels.length;e++)this.gameModels[e].resetForPrestige();this.worldSeed++,this.initializeState(!1),this.projection.setGridCenter(n.start.startX,n.start.startY),this.gridLoadingManager.manageLoadedGridsForFrame()}resetFull(){for(let e=0;e<this.gameModels.length;e++)this.gameModels[e].resetFull();this.worldSeed++,this.initializeState(!1),this.projection.setGridCenter(n.start.startX,n.start.startY),this.gridLoadingManager.manageLoadedGridsForFrame()}};var u=class l{constructor(){}static getElement(e){return document.getElementById(e)}static createTextElement(e){return document.createTextNode(e)}static setInnerHtml(e,t){var i=l.getElement(e);i&&(i.innerHTML=t)}static createElement(e,t,i,r){var s=document.createElement(e);return r&&(s.className=r),i&&(s.id=i),t&&t.appendChild(s),s}static createInputElement(e,t,i,r){var s=document.createElement("input");return s.type=e,r&&(s.className=r),i&&(s.id=i),t&&t.appendChild(s),s}static clearChildren(e){var t=l.getElement(e);if(t)for(;t.firstChild;)t.removeChild(t.firstChild)}static removeElementById(e,t){this.removeElement(e,l.getElement(t))}static removeElement(e,t){var i=l.getElement(e);if(!(!i||!t))try{i.removeChild(t)}catch(r){r instanceof DOMException?(console.error("Caught a DOMException. parentId="+e+" elementId="+t.id,r.name,r.message),r.name==="SyntaxError"&&console.warn("Invalid CSS selector used.")):console.error("Caught a non-DOMException error.  parentId="+e+" elementId="+t.id,r)}}static hideElement(e){e&&(e.style.display="none")}static showElement(e){this.showElementWithValue(e,"block")}static showElementIdWithValue(e,t){l.showElementWithValue(l.getElement(e),t)}static showElementWithValue(e,t){e&&(e.style.display=t)}static hideElementId(e){l.hideElement(l.getElement(e))}static showElementId(e){l.showElement(l.getElement(e))}};var U=class{constructor(e,t){this.parentId=e,this.elementId=t,this.viewVisible=!0,this.currentlyVisible=!1,this.inialized=!1}getElementId(){return this.elementId}setCurrentlyVisible(e){this.currentlyVisible=e}isViewVisible(){return this.viewVisible}setViewVisible(e){this.viewVisible=e}setInitialVisibility(e){this.currentlyVisible=!e,this.viewVisible=e}clearChildViews(){}updateView(){if(this.inialized||console.log("View.updateView() Not initialized: "+this.constructor.name),this.elementId){var e=this.isViewVisible();this.currentlyVisible!==e&&(this.currentlyVisible=e,e?u.showElementIdWithValue(this.elementId,this.getVisibileDisplayValue()):u.hideElementId(this.elementId)),e&&this.updateViewContents()}}getVisibileDisplayValue(){return"block"}initializeView(){this.inialized=!0}updateViewContents(){}removeAll(){this.parentId&&u.removeElementById(this.parentId,this.elementId)}};var q=class extends U{constructor(e,t){super(e,t),this.childViews=null}getChildViews(){return this.childViews}clearChildViews(){if(this.childViews&&this.childViews.length>0){for(let e=0;e<this.childViews.length;e++)this.childViews[e].clearChildViews();this.childViews.length=0}}removeAll(){if(this.childViews)for(let e=0;e<this.childViews.length;e++)this.childViews[e].removeAll();this.childViews=null,super.removeAll()}removeChildViewElements(){if(!this.childViews||this.childViews.length===0)return;let e=this.getElementId();for(let t=0;t<this.childViews.length;t++)u.removeElementById(e,this.childViews[t].getElementId());this.clearChildViews()}removeViewAtIndex(e){if(!this.childViews||this.childViews.length===0)return;let t=this.childViews[e],i=this.getElementId();u.removeElementById(i,t.getElementId()),this.childViews.splice(e,1)}removeView(e){if(!this.childViews||this.childViews.length===0)return;let t=this.getElementId(),i=-1;for(let s=0;s<this.childViews.length;s++)if(this.childViews[s].getElementId()===e){i=s;break}if(i===-1){console.log("ParentView.removeView() Failed to find child id: "+e);return}let r=this.childViews[i];u.removeElementById(t,r.getElementId()),this.childViews.splice(i,1)}addView(e){e&&(this.childViews||(this.childViews=[]),this.childViews.push(e))}initializeView(){if(this.childViews)for(let e=0;e<this.childViews.length;e++)this.childViews[e].initializeView();super.initializeView()}updateViewContents(){this.updateChildViews()}updateChildViews(){if(this.childViews)for(let e=0;e<this.childViews.length;e++)this.childViews[e].updateView()}};var $={GAME_VIEW_CONTAINER:"gameViewContainer",GAME_VIEW_OVERLAY_CONTAINER:"gameViewOverlayContainer",GAME_SKILL_TOGGLE_CONTAINER:"gameSkillToggleContainer",GAME_CANVAS:"gameCanvas",SKILL_TREE_GRAPH:"skillTreeGraph",CENTER_ON_CHARACTER_BUTTON:"centerOnCharacterButton",AUTO_PLAY_BUTTON:"autoPlayButton",ACTIVE_SKILLS_PANEL:"activeSkillsPanel",ACTIVE_BONUSES_PANEL:"activeBonusesPanel",PRIMARY_UPGRADE_PANEL:"primaryUpgradePanel",PRIMARY_UPGRADE_PANEL_TAB_BAR:"primaryUpgradePanelTabBar",UPGRADE_TAB_MENU_ITEM_CREW:"crewUpgradesMenuItem",SKILL_TREE_TAB_MENU_ITEM:"skillTreeMenuItem",FREE_UPGRADES_PANEL:"freeUpgradesPanel",MINED_UPGRADES_PANEL:"minedUpgradesPanel",PICK_UPGRADES_PANEL:"pickUpgradesPanel",GOLD_UPGRADES_PANEL:"goldUpgradesPanel",BONUS_PANEL:"bonusPanel",POINT_UPGRADES_PANEL:"pointUpgradesPanel",CREW_UPGRADES_PANEL:"crewUpgradesPanel",SKILL_SELECTION_PANEL:"skillSelectionPanel",SKILL_TREE_PANEL:"skillTreePanel",MENU_PANEL:"menuPanel",CREW_TAB_UPGRADE_COLLECTION:"upgradeCollection",CREW_PICK_UPGRADE_CONTENTS:"pickUpgradeBody",MINE_DAMAGE_VIEW:"mineDamageDisplay",MAX_DEPTH_VIEW:"maxDepth",MAX_LAYER_VIEW:"maxLayer",CURRENT_LAYER_VIEW:"currentLayer",CREW_MODE_VIEW:"crewMode",CURRENCY_VIEW:"currencyView",PRESTIGE_POPUP:"prestigePopup",OFFLINE_POPUP:"offlinePopup",STATISTICS_POPUP:"statisticsPopup",SAVE_POPUP:"savePopup",CLOSE_SKILL_TREE_POPUP:"closeSkillTree",PERFORMANCE_POPUP:"performancePopup"};var or=class{constructor(){this.firstMovement=!0,this.leftMouseDown=!1,this.prevMouseX=0,this.prevMouseY=0,this.mouseX=0,this.mouseY=0,this.mouseDeltaX=0,this.mouseDeltaY=0,this.mouseDownTime=0,this.mouseDownX=0,this.mouseDownY=0,this.leftMouseClick=!1,this.clickX=0,this.clickY=0,this.mouseWheelMotion=0,this.mouseMoved=!1}attachListeners(e,t){let i=this;t.onmouseover=function(r){return t.focus(),i.mouseX=r.clientX,i.mouseY=r.clientY,!1},t.onmouseout=function(r){i.leftMouseDown=!1,i.mouseX=r.clientX,i.mouseY=r.clientY,i.firstMovement=!0},e&&(e.onmouseout=function(r){i.leftMouseDown=!1,i.mouseX=r.clientX,i.mouseY=r.clientY,i.firstMovement=!0}),t.addEventListener("mousewheel",function(r){return i.mouseWheelMotion=-(r.wheelDelta||r.detail),!1},!1),t.addEventListener("DOMMouseScroll",function(r){return i.mouseWheelMotion=r.wheelDelta||r.detail,!1},!1),t.onmousedown=function(r){return i.mouseX=r.clientX,i.mouseY=r.clientY,i.prevMouseX=r.clientX,i.prevMouseY=r.clientY,i.mouseMoved=!1,i.mouseDeltaX=0,i.mouseDeltaY=0,i.mouseDownX=r.clientX,i.mouseDownY=r.clientY,i.mouseDownTime=Date.now(),(r.button===0||r.button===1)&&(i.leftMouseDown=!0),!1},t.onmouseup=function(r){if(i.mouseX=r.clientX,i.mouseY=r.clientY,i.mouseDeltaX=i.mouseX-i.prevMouseX,i.mouseDeltaY=i.mouseY-i.prevMouseY,i.prevMouseX=i.mouseX,i.prevMouseY=i.mouseY,r.button===0||r.button===1){i.leftMouseDown=!1;let s=i.mouseX-i.mouseDownX,o=i.mouseY-i.mouseDownY;Math.abs(s)<5&&Math.abs(o)<5&&Date.now()-i.mouseDownTime<250&&(i.leftMouseClick=!0,i.clickX=r.clientX,i.clickY=r.clientY)}return!1},t.onmousemove=function(r){return i.onMouseMove(r.clientX,r.clientY),!1}}onMouseMove(e,t){this.mouseX=e,this.mouseY=t,this.mouseMoved=!0,this.firstMovement?this.firstMovement=!1:(this.mouseDeltaX+=this.mouseX-this.prevMouseX,this.mouseDeltaY+=this.mouseY-this.prevMouseY),this.prevMouseX=this.mouseX,this.prevMouseY=this.mouseY}resetInputState(){this.leftMouseClick=!1,this.mouseWheelMotion=0,this.mouseDeltaX=0,this.mouseDeltaY=0,this.mouseMoved=!1}};var In=class extends U{constructor(e,t,i){super(e,$.GAME_CANVAS),this.canvas=null,this.context=null,this.userInput=i,this.projection=t.projection,this.sprites=t.sprites,this.tileDamageSpriteOverlay=this.sprites.tileDamageSpriteOverlay,this.oreSpriteOverlay=this.sprites.oreSpriteOverlay,this.upgradeSpriteOverlay=this.sprites.tileSpriteOverlaySpritesheet.upgradeSpriteOverlay,this.crew=t.crew,this.partyTarget=t.partyTarget,this.state=t,this.worldGrid=t.worldGrid,this.vectorField=t.vectorField,this.infoTextProcessor=t.infoTextProcessor,this.spriteSize=0,this.scaledSize=0,this.screenCoordinate=new b(0,0),this.screenCoordinate2=new b(0,0),this.worldCoordinate=new b(0,0),this.tileHealthNum=new d(0),this.crewBrain=t.crewBrain;let r=this;this.renderRegionBorderDebugCallback=s=>{s.vectorFieldNumber==this.vectorField.vectorFieldNumber&&r.renderRegionBorder(s)},this.renderTilesCallback=s=>{r.renderTile(s)},this.renderMonstersCallback=s=>{r.renderMonsterCharacters(s)}}initializeView(){let e=u.getElement(this.parentId);this.canvas=u.createElement("canvas",e,$.GAME_CANVAS,"game-canvas"),this.context=this.canvas.getContext("2d"),this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.userInput.attachListeners(document,this.canvas),this.projection.setCanvas(this.canvas),this.setInitialVisibility(!0),super.initializeView()}getCanvas(){return this.canvas}updateViewContents(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.font="12pt helvetica",this.context.imageSmoothingEnabled=!1,le.startTime("Render-total"),this.renderWorld(),le.endTime("Render-total")}renderWorld(){this.spriteSize=this.sprites.tileSpritesheet.spriteSize,this.scaledSize=this.spriteSize*this.projection.zoom;let e=this;le.startTime("Render-blocks"),ye.allVisibleTiles(this.worldGrid,this.projection,this.renderTilesCallback),le.endTime("Render-blocks"),this.renderInfoText(),ye.allVisibleGrids(this.worldGrid,this.projection,this.renderMonstersCallback),this.state.gameOptions.crewBrainDebugEnabled&&(this.renderVectorFeildTargets(),this.renderRegionBordersDebug()),this.renderTileDepths(),le.startTime("Render-effects"),this.renderEffects(),this.renderSkills(),le.endTime("Render-effects"),le.startTime("Render-crew"),this.renderCrew(),le.endTime("Render-crew"),this.state.gameOptions.crewBrainDebugEnabled&&this.renderPaths()}renderPaths(){let e=this.crew.miners;for(let t=0;t<e.length;t++)this.renderPath(e[t])}renderPath(e){if(e.position.tile&&!(e.position.pathPlan.length<2)){this.context.strokeStyle="#F834",this.context.lineWidth=4,this.context.beginPath();for(let t=0;t<e.position.pathPlan.length;t++){let i=e.position.pathPlan[t];this.screenCoordinate.copy(i.startTile.origin),this.screenCoordinate.addXY(n.tile.halfSize,n.tile.halfSize),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.context.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),this.screenCoordinate.copy(i.endTile.origin),this.screenCoordinate.addXY(n.tile.halfSize,n.tile.halfSize),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.context.lineTo(this.screenCoordinate.x,this.screenCoordinate.y)}this.context.stroke()}}renderCrew(){let e=this.crew.miners;this.spriteSize=this.sprites.itemOverlaySpritesheet.spriteSize,this.scaledSize=this.spriteSize*this.projection.zoom;for(let t=0;t<e.length;t++)this.renderThruster(e[t]);this.spriteSize=this.sprites.tileSpritesheet.spriteSize,this.scaledSize=this.spriteSize*this.projection.zoom;for(let t=0;t<e.length;t++)this.renderCharacter(e[t]);this.spriteSize=this.sprites.itemOverlaySpritesheet.spriteSize,this.scaledSize=this.spriteSize*this.projection.zoom;for(let t=0;t<e.length;t++)this.renderItemOverlay(e[t])}renderTileNeighborScores(e){let t=e.neighbors;this.screenCoordinate.copy(e.origin),this.screenCoordinate.addXY(n.tile.halfSize,n.tile.halfSize);for(let i=0;i<t.length;i++){let r=t[i];r&&(r.lighting.everVisibleToCharacter||r.tileType===ge.SKY||(this.screenCoordinate2.copy(r.origin),this.screenCoordinate2.subtract(e.origin),this.screenCoordinate2.scale(.5),this.screenCoordinate2.add(this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),r.open?this.context.fillRect(this.screenCoordinate2.x-3,this.screenCoordinate2.y-3,6,6):this.context.fillRect(this.screenCoordinate2.x-2,this.screenCoordinate2.y-2,4,4)))}}renderInfoText(){let e=this.infoTextProcessor.infoTextArray;if(e.length!==0){this.context.fillStyle="white";for(let t=0;t<e.length;t++){let i=e[t];this.context.fillText(i.text,i.textX,i.textY)}}}renderRegionBordersDebug(){if(!this.state.vectorField.centerTile)return;let e=this.state.vectorField.centerTile.origin,t=25*n.tile.size;ye.allNearbyRegions(this.worldGrid,this.projection,e,t,this.renderRegionBorderDebugCallback)}renderRegionBorder(e){this.screenCoordinate.copy(e.origin),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.screenCoordinate2.copy(e.origin),this.screenCoordinate2.addXY(n.grid.regionPixelWidth,n.grid.regionPixelHeight),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2);let t=Math.abs(this.screenCoordinate2.x-this.screenCoordinate.x),i=Math.abs(this.screenCoordinate2.y-this.screenCoordinate.y);this.context.strokeStyle="#22222288",this.context.lineWidth=2,this.context.strokeRect(this.screenCoordinate.x,this.screenCoordinate.y,t,i)}renderVectorFeildTargets(){this.context.fillStyle="#FF0000",this.renderTargetList(this.vectorField.priorityMiningCandidates),this.context.fillStyle="#FFFF00",this.renderTargetList(this.vectorField.currencyMiningCandidates),this.context.fillStyle="#FF00FF",this.renderTargetList(this.vectorField.commonMiningCandidates);for(let t=0;t<this.crew.miners.length;t++){let i=this.crew.miners[t],r=i.target.targetTile,s=i.target.mineTile;this.renderMineTarget(i.position.tile,r,s)}let e=this.vectorField.centerTile;e&&(this.screenCoordinate.copy(e.origin),this.screenCoordinate.addXY(4,4),this.screenCoordinate2.copy(e.origin),this.screenCoordinate2.addXY(n.tile.size-4,n.tile.size-4),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),this.context.fillStyle="#FFFFFF",this.context.fillRect(this.screenCoordinate.x,this.screenCoordinate.y,this.screenCoordinate2.x-this.screenCoordinate.x,this.screenCoordinate2.y-this.screenCoordinate.y))}renderMineTarget(e,t,i){e&&(i&&(this.screenCoordinate.copy(i.origin),this.screenCoordinate.addXY(n.tile.quarterSize+2,n.tile.quarterSize+2),this.screenCoordinate2.copy(i.origin),this.screenCoordinate2.addXY(n.tile.threeQuarterSize-2,n.tile.threeQuarterSize-2),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),this.context.fillStyle="#4444FF",this.context.fillRect(this.screenCoordinate.x,this.screenCoordinate.y,this.screenCoordinate2.x-this.screenCoordinate.x,this.screenCoordinate2.y-this.screenCoordinate.y)),t&&(this.screenCoordinate.copy(t.origin),this.screenCoordinate.addXY(n.tile.quarterSize+2,n.tile.quarterSize+2),this.screenCoordinate2.copy(t.origin),this.screenCoordinate2.addXY(n.tile.threeQuarterSize-2,n.tile.threeQuarterSize-2),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),this.context.fillStyle="#FF4444",this.context.fillRect(this.screenCoordinate.x,this.screenCoordinate.y,this.screenCoordinate2.x-this.screenCoordinate.x,this.screenCoordinate2.y-this.screenCoordinate.y)))}renderTargetList(e){for(let t=0;t<e.length;t++){let i=e[t];this.screenCoordinate.copy(i.origin),this.screenCoordinate.addXY(n.tile.quarterSize,n.tile.quarterSize),this.screenCoordinate2.copy(i.origin),this.screenCoordinate2.addXY(n.tile.threeQuarterSize,n.tile.threeQuarterSize),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),this.context.fillRect(this.screenCoordinate.x,this.screenCoordinate.y,this.screenCoordinate2.x-this.screenCoordinate.x,this.screenCoordinate2.y-this.screenCoordinate.y)}}renderGridBorders(){this.context.strokeStyle="#11111122",this.context.lineWidth=1;let e=this.spriteSize*this.projection.zoom*n.grid.gridTileWidth,t=this.worldGrid.grids;for(let i=0;i<t.length;i++){let r=t[i];this.projection.isVisibleGridBox(r)&&(this.projection.worldToScreen(r.origin,this.screenCoordinate),this.context.strokeRect(this.screenCoordinate.x,this.screenCoordinate.y,e,e))}}renderTileDepths(){this.context.fillStyle="#22222211",this.context.fillRect(0,0,190,this.canvas.height);let t=this.worldGrid.findGridTile(this.projection.gridCenter);if(!t)return;this.context.fillStyle="#666666FF";let i=t;for(this.renderTileDepth(i),this.renderTileHealth(i),i=t.getNeighborTop();i&&this.projection.isVisibleGridBox(i);)this.renderTileDepth(i),this.renderTileHealth(i),i=i.getNeighborTop();for(i=t.getNeighborBottom();i&&this.projection.isVisibleGridBox(i);)this.renderTileDepth(i),this.renderTileHealth(i),i=i.getNeighborBottom();this.context.fillStyle="#111111EE",this.context.fillRect(0,this.canvas.height-30,190,30),this.context.fillStyle="#666666FF",this.context.fillText("深度",5,this.canvas.height-10),this.context.fillText("生命值",100,this.canvas.height-10)}renderTileDepth(e){let i=e.getTileRow();i===this.partyTarget.targetRow?(this.screenCoordinate.copy(e.origin),this.screenCoordinate.y+=n.tile.size,this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.context.fillStyle="#FF8822FF",this.context.fillRect(0,this.screenCoordinate.y,80,3),this.context.fillText(""+this.partyTarget.targetRow+" target",5,this.screenCoordinate.y-5)):i%5===0&&(this.screenCoordinate.copy(e.origin),this.screenCoordinate.y+=n.tile.size,this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.context.fillStyle="#666666FF",this.context.fillRect(0,this.screenCoordinate.y,80,2),this.context.fillText(""+i,5,this.screenCoordinate.y-5))}renderTileHealth(e){let t=e.getTileRow();if(t<0)return;this.screenCoordinate.copy(e.origin),this.screenCoordinate.y+=n.tile.size,this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),e.tileType.layerDescription.calculateTileHealth(t,this.tileHealthNum),this.context.fillStyle="#666666FF",this.context.fillText(I.formatBigNum(this.tileHealthNum),100,this.screenCoordinate.y-5)}renderMonsterCharacters(e){let t=e.characters;for(let i=0;i<t.length;i++)t[i].isMonster()&&this.renderCharacter(t[i])}renderCharacter(e){if(!this.projection.isVisible(e.position.worldCoordinateOrigin,n.tile.size))return;let t=e.position.tile;if(!t)return;let i=t.lighting;if(!i.everVisibleToCharacter||t.tileType.lightingSupported&&i.shadowColor.a===0)return;let r=e.getCharacterSprite();e.position.facingLeft?(this.projection.worldToScreen(e.position.worldCoordinateOrigin,this.screenCoordinate),this.renderSprite(r,this.screenCoordinate)):(this.worldCoordinate.copy(e.position.worldCoordinateOrigin),this.worldCoordinate.addXY(this.spriteSize,0),this.projection.worldToScreen(this.worldCoordinate,this.screenCoordinate),this.context.save(),this.context.translate(this.screenCoordinate.x,this.screenCoordinate.y),this.context.scale(-1,1),this.screenCoordinate.set(0,0),this.renderSprite(r,this.screenCoordinate),this.context.restore())}renderItemOverlay(e){this.projection.isVisible(e.position.worldCoordinateOrigin,n.tile.size)&&this.renderOverlaySprite(e,e.getItemOverlaySprite())}renderThruster(e){this.projection.isVisible(e.position.worldCoordinateOrigin,n.tile.size)&&this.renderOverlaySprite(e,e.getThrusterOverlaySprite())}renderOverlaySprite(e,t){t&&(e.position.facingLeft?(this.worldCoordinate.copy(e.position.worldCoordinateOrigin),this.worldCoordinate.subtractXY(n.tile.size,n.tile.size),this.projection.worldToScreen(this.worldCoordinate,this.screenCoordinate),this.renderSprite(t,this.screenCoordinate)):(this.worldCoordinate.copy(e.position.worldCoordinateOrigin),this.worldCoordinate.subtractXY(n.tile.size,n.tile.size),this.worldCoordinate.addXY(this.spriteSize,0),this.projection.worldToScreen(this.worldCoordinate,this.screenCoordinate),this.context.save(),this.context.translate(this.screenCoordinate.x,this.screenCoordinate.y),this.context.scale(-1,1),this.screenCoordinate.set(0,0),this.renderSprite(t,this.screenCoordinate),this.context.restore()))}renderTile(e){if(e){if(!e.tileType.lightingSupported)this.projection.worldToScreen(e.origin,this.screenCoordinate),e.open?this.renderSprite(e.backgroundSprite,this.screenCoordinate):this.renderSprite(e.sprite,this.screenCoordinate);else{let t=e.lighting;if(!t.everVisibleToCharacter)return;this.projection.worldToScreen(e.origin,this.screenCoordinate);let i=t.calculateShadowColor();if(i.a>0){if(e.open?(this.renderSprite(e.backgroundSprite,this.screenCoordinate),e.fixtureDescription&&(e.fixtureDescription.sprite||(e.fixtureDescription.sprite=this.sprites.staticFixtureSpritesheet.getSprite(e.fixtureDescription.spriteName)),this.renderSprite(e.fixtureDescription.sprite,this.screenCoordinate))):this.renderSprite(e.sprite,this.screenCoordinate),!e.open&&e.healthPercent!=100){let r=this.tileDamageSpriteOverlay.getDamageSprite(e);r&&(this.context.globalAlpha=.7,this.renderSprite(r,this.screenCoordinate),this.context.globalAlpha=1)}if(!e.open&&e.tileType.rarityModifier!==R.COMMON)if(e.tileType.rarityModifier===R.UPGRADE){let r=this.upgradeSpriteOverlay.getCurrentSpriteDefault();r&&this.renderSprite(r,this.screenCoordinate)}else{let r=this.oreSpriteOverlay.getOreSprite(e);r&&this.renderSprite(r,this.screenCoordinate)}i.a<1&&(this.context.fillStyle=i.getFillColor(),this.context.fillRect(this.screenCoordinate.x,this.screenCoordinate.y,this.scaledSize,this.scaledSize))}}this.state.gameOptions.crewBrainDebugEnabled&&this.renderTileDebug(e)}}renderTileDebug(e){let t=this.vectorField.vectorFieldNumber,i=e.pathData.getMineScore(t);i!==tt.UNSET&&(this.screenCoordinate.copy(e.origin),this.screenCoordinate.addXY(n.tile.quarterSize,n.tile.quarterSize),this.screenCoordinate2.copy(e.origin),this.screenCoordinate2.addXY(n.tile.threeQuarterSize,n.tile.threeQuarterSize),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),i===tt.IN_RANGE_UNSEEN?this.context.fillStyle="#8665":i===tt.WORTHLESS&&(this.context.fillStyle="#8885"),this.context.fillRect(this.screenCoordinate.x,this.screenCoordinate.y,this.screenCoordinate2.x-this.screenCoordinate.x,this.screenCoordinate2.y-this.screenCoordinate.y))}renderSkills(){let e=this.state.skillTreeGraph.skills;for(let t=0;t<e.length;t++){let i=e[t];if(!i.isUnlocked())continue;let r=i.getRenderer();r&&r.renderSkill(this.context,this.projection)}}renderEffects(){this.renderSpriteEffects()}renderSpriteEffects(){let e=this.state.effectManager.spriteEffects;e.length!==0&&this.renderEffectList(e)}renderEffectList(e){for(let t=0;t<e.length;t++){let i=e[t];if(!i||i.isEffectFinished()||i.isNotStarted())continue;let r=i.getSprite();if(!r)continue;let s=i.getPosition();this.projection.isVisible(s,n.tile.size)&&(this.projection.worldToScreen(s,this.screenCoordinate),this.renderScaledSprite(r,this.screenCoordinate))}}renderScaledSprite(e,t){if(e){let i=e.getSize();this.context.drawImage(e.getImage(),e.spriteX,e.spriteY,i,i,t.x,t.y,this.scaledSize,this.scaledSize)}}renderSprite(e,t){e&&this.context.drawImage(e.getImage(),e.spriteX,e.spriteY,this.spriteSize,this.spriteSize,t.x,t.y,this.scaledSize,this.scaledSize)}};var Pd=-1,nr=class extends U{constructor(e,t,i){super(e,t),this.bonus=i,this.mainElement=null,this.activeProgressElement=null,this.titleElement=null,this.descriptionElement=null,this.displayedTitle=null,this.displayedDescription=null,this.displayState=Pd}initializeView(){let e=this.getElementId(),t=u.getElement(this.parentId);if(!t){console.log("ActiveSkillView.initializeView() No parent element found! parentId="+this.parentId);return}this.mainElement=u.createElement("div",t,e,"active-skill-button-outer-active"),this.activeProgressElement=u.createElement("div",this.mainElement,null,"active-skill-panel-activated");let i=u.createElement("div",this.mainElement,null,"active-skill-button-body"),r=u.createElement("div",i,null,"icon-container"),s=u.createElement("div",i,null,"active-skill-title-description-container"),o=u.createElement("img",r,null,null);o.src=this.bonus.spriteFileName,this.titleElement=u.createElement("div",s,null,"skill-panel-row1-title"),this.titleElement.innerHTML="",this.descriptionElement=u.createElement("div",s,null,"skill-panel-row2-description"),this.descriptionElement.innerHTML="",this.setInitialVisibility(!0),super.initializeView()}updateViewContents(){let e=this.bonus.getTitle();e!==this.displayedTitle&&(this.displayedTitle=e,this.titleElement.innerHTML=e);let t=this.bonus.getDescription();t&&t!==this.displayedDescription&&(this.displayedDescription=t,this.descriptionElement&&(this.descriptionElement.innerHTML=t));let i=this.bonus.getActivationPercent();this.activeProgressElement.style.width=i+"%"}};var vn=class extends q{constructor(e,t){super(e,$.ACTIVE_BONUSES_PANEL);let i=this.getElementId(),r=t.activeBonuses;for(let s=0;s<r.length;s++){let o=new nr(i,i+"_"+s,r[s]);this.addView(o)}this.bonusCollection=t,this.displayedChangeCount=-1}initializeView(){let e=u.getElement(this.parentId);u.createElement("div",e,this.getElementId(),"active-skills-panel"),super.initializeView()}updateViewContents(){if(this.displayedChangeCount!==this.bonusCollection.activeChangeCount){this.displayedChangeCount=this.bonusCollection.activeChangeCount,console.log("-------------------------------"),console.log("active change count: "+this.bonusCollection.activeChangeCount),console.log("   active bonuses:  "+this.bonusCollection.activeBonuses.length),this.removeChildViewElements();let e=this.getElementId(),t=this.bonusCollection.activeBonuses;for(let i=0;i<t.length;i++){let r=new nr(e,e+"_"+i,t[i]);this.addView(r),console.log("  adding view: "+t[i].id),r.initializeView()}}super.updateViewContents()}getVisibileDisplayValue(){return"flex"}};var xn=class extends U{constructor(e,t,i){super(e,$.CENTER_ON_CHARACTER_BUTTON),this.projection=t,this.panAnimation=i,this.setInitialVisibility(!1)}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,this.elementId,"center-on-character-button");t.style.display="none";let i=u.createElement("img",t,null,null);i.src="images/ui_center_button.png",i.title="Center on Crew";let r=this;t.onclick=function(){r.panAnimation.startAnimation()},super.initializeView()}updateView(){let e=!this.projection.stayCenteredOnCharacter&&!this.panAnimation.animating;e!==this.isViewVisible()&&this.setViewVisible(e),super.updateView()}};var Dn=class extends q{constructor(e,t,i,r){super(e,t),this.addView(new xn(t,i,r))}initializeView(){let e=u.getElement(this.parentId);u.createElement("div",e,this.getElementId(),"bottom-row-button-container"),super.initializeView()}};var On=class extends U{constructor(e,t,i){super(e,e+"_base_ore"),this.damage=t,this.values=i,this.displayedBasePickDamage=new d(0),this.basePickDamageString=null,this.workingNum=new d(0),this.turnsPerSecond=new d(n.time.turnsPerSecond),this.baseAdditiveBody=null,this.setInitialVisibility(!0)}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,null,"mine-damage-panel-main-section"),i=u.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Base",this.baseAdditiveBody=u.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.basePickDamagePerTurn,t=this.values.baseAdditiveBonusPerTurn.getValue();(!this.basePickDamageString||!t.equals(this.displayedBasePickDamage))&&(this.displayedBasePickDamage.copy(t),this.workingNum.copy(e),this.workingNum.add(t),this.workingNum.mul(this.turnsPerSecond),this.basePickDamageString=I.formatBigNum(this.workingNum)+"/s",this.baseAdditiveBody.innerHTML=this.basePickDamageString),super.updateViewContents()}};var Bn=class extends U{constructor(e,t){super(e,e+"_depth"),this.damage=t,this.displayedDamageMultiplier=new d(-10),this.bonusString=null,this.body=null,this.setInitialVisibility(!0)}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,this.getElementId(),"mine-damage-panel-main-section"),i=u.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Depth",this.body=u.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.depthDamageMultiplier;(!this.bonusString||!e.equals(this.displayedDamageMultiplier))&&(this.displayedDamageMultiplier.copy(e),this.bonusString=I.formatBigNum(e),this.body.innerHTML=this.bonusString),super.updateViewContents()}getVisibileDisplayValue(){return"inline-block"}};var kn=class extends U{constructor(e,t){super(e,e+"_gold"),this.damage=t,this.displayedGoldDamageMultiplier=new d(-1),this.goldBonusString=null,this.body=null,this.setInitialVisibility(!0)}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,this.getElementId(),"mine-damage-panel-main-section"),i=u.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Gold",this.body=u.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.goldDamageMultiplier;(!this.goldBonusString||!e.equals(this.displayedGoldDamageMultiplier))&&(this.displayedGoldDamageMultiplier.copy(e),this.goldBonusString=I.formatBigNum(e),this.body.innerHTML=this.goldBonusString),super.updateViewContents()}getVisibileDisplayValue(){return"inline-block"}};var Fn=class extends U{constructor(e){super(e,null),this.setInitialVisibility(!0)}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,null,"mine-damage-panel-operator-section"),i=u.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML+="Mine";let r=u.createElement("div",t,null,"mine-damage-panel-section-body");r.innerHTML="Damage:",super.initializeView()}};var Gn=class extends U{constructor(e,t){super(e,e+"_multore"),this.values=t,this.displayedBonus=new d(0),this.displayedValue=null,this.workingNum=new d(0),this.oneBigNum=new d(1),this.body=null,this.setInitialVisibility(!0)}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,null,"mine-damage-panel-main-section"),i=u.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Ore Multi",this.body=u.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.values.baseMultiplicativeBonusValue.getValue();(!this.displayedValue||!e.equals(this.displayedBonus))&&(this.displayedBonus.copy(e),this.workingNum.copy(this.oneBigNum),this.workingNum.add(e),this.displayedValue=I.formatBigNum(this.workingNum),this.body.innerHTML=this.displayedValue),super.updateViewContents()}};var Vn=class extends U{constructor(e,t){super(e,e+"_ruby"),this.damage=t,this.displayedDamageMultiplier=new d(-1),this.damageBonusString=null,this.body=null,this.setInitialVisibility(!0)}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,this.getElementId(),"mine-damage-panel-main-section"),i=u.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Ruby",this.body=u.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.rubyDamageMultiplier;(!this.damageBonusString||!e.equals(this.displayedDamageMultiplier))&&(this.displayedDamageMultiplier.copy(e),this.damageBonusString=I.formatBigNum(e),this.body.innerHTML=this.damageBonusString),super.updateViewContents()}getVisibileDisplayValue(){return"inline-block"}};var At=class extends U{constructor(e,t,i){super(e,t),this.operator=i,this.setInitialVisibility(!0)}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,this.getElementId(),"mine-damage-panel-operator-section"),i=u.createElement("div",t,null,null);i.innerHTML+="&nbsp;";let r=u.createElement("div",t,null,null);r.innerHTML=this.operator,super.initializeView()}getVisibileDisplayValue(){return"inline-block"}};var Un=class extends U{constructor(e,t){super(e,e+"_prestige"),this.damage=t,this.displayedPrestigeDamageMultiplier=new d(0),this.prestigeBonusString=null,this.body=null,this.setInitialVisibility(!0)}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,this.getElementId(),"mine-damage-panel-main-section"),i=u.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Prestige",this.body=u.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.prestigeDamageMultiplier;(!this.prestigeBonusString||!e.equals(this.displayedPrestigeDamageMultiplier))&&(this.displayedPrestigeDamageMultiplier.copy(e),this.prestigeBonusString=I.formatBigNum(e),this.body.innerHTML=this.prestigeBonusString),super.updateViewContents()}getVisibileDisplayValue(){return"inline-block"}};var Hn=class extends U{constructor(e,t){super(e,e+"_tot"),this.damage=t,this.displayedTotalDamage=new d(0),this.totalDamageString=null,this.workingNum=new d(0),this.turnsPerSecond=new d(n.time.turnsPerSecond),this.baseTotalBody=null,this.setInitialVisibility(!0)}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,null,"mine-damage-panel-main-section"),i=u.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Total Damage",this.baseTotalBody=u.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.totalPickDamagePerTurn;(!this.totalDamageString||!e.equals(this.displayedTotalDamage))&&(this.displayedTotalDamage.copy(e),this.workingNum.copy(e),this.workingNum.mul(this.turnsPerSecond),this.totalDamageString=I.formatBigNum(this.workingNum),this.baseTotalBody.innerHTML=this.totalDamageString+"/Sec")}};var zn=class extends U{constructor(e,t){super(e,e+"_mined"),this.damage=t,this.displayedDamageMultiplier=new d(0),this.bonusString=null,this.body=null,this.setInitialVisibility(!0)}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,this.getElementId(),"mine-damage-panel-main-section"),i=u.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Mined",this.body=u.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.minedDamageMultiplier;(!this.bonusString||!e.equals(this.displayedDamageMultiplier))&&(this.displayedDamageMultiplier.copy(e),this.bonusString=I.formatBigNum(e),this.body.innerHTML=this.bonusString),super.updateViewContents()}getVisibileDisplayValue(){return"inline-block"}};var Wn=class extends q{constructor(e,t,i,r){super(e,$.MINE_DAMAGE_VIEW),this.one=new d(1),this.damage=t,this.minedDamageVisible=!1,this.prestigeDamageVisible=!1,this.goldDamageVisible=!1,this.depthDamageVisible=!1,this.rubyDamageVisible=!1,this.addView(new Fn(this.elementId)),this.addView(new On(this.elementId,t,i)),this.addView(new At(this.elementId,this.elementId+"3"," x ")),this.addView(new Gn(this.elementId,i)),this.minedDamageOperator=new At(this.elementId,this.elementId+"6"," x "),this.minedDamageView=new zn(this.elementId,t),this.addView(this.minedDamageOperator),this.addView(this.minedDamageView),this.minedDamageOperator.setInitialVisibility(!1),this.minedDamageView.setInitialVisibility(!1),this.prestigeOperator=new At(this.elementId,this.elementId+"7"," x "),this.prestigeDamageView=new Un(this.elementId,t),this.addView(this.prestigeOperator),this.addView(this.prestigeDamageView),this.prestigeOperator.setInitialVisibility(!1),this.prestigeDamageView.setInitialVisibility(!1),this.goldOperator=new At(this.elementId,this.elementId+"8"," x "),this.goldDamageView=new kn(this.elementId,t),this.addView(this.goldOperator),this.addView(this.goldDamageView),this.goldOperator.setInitialVisibility(!1),this.goldDamageView.setInitialVisibility(!1),this.depthOperator=new At(this.elementId,this.elementId+"9"," x "),this.depthDamageView=new Bn(this.elementId,t),this.addView(this.depthOperator),this.addView(this.depthDamageView),this.depthOperator.setInitialVisibility(!1),this.depthDamageView.setInitialVisibility(!1),this.rubyOperator=new At(this.elementId,this.elementId+"10"," x "),this.rubyDamageView=new Vn(this.elementId,t),this.addView(this.rubyOperator),this.addView(this.rubyDamageView),this.rubyOperator.setInitialVisibility(!1),this.rubyDamageView.setInitialVisibility(!1),this.addView(new At(this.elementId,this.elementId+"11"," = ")),this.addView(new Hn(this.elementId,t)),this.setInitialVisibility(!0)}initializeView(){let e=u.getElement(this.parentId);u.createElement("div",e,this.getElementId(),"mine-damage-panel"),super.initializeView()}updateView(){let e=this.damage.minedDamageMultiplier.greaterThan(this.one),t=this.damage.prestigeDamageMultiplier.greaterThan(this.one),i=this.damage.goldDamageMultiplier.greaterThan(this.one),r=this.damage.depthDamageMultiplier.greaterThan(this.one),s=this.damage.rubyDamageMultiplier.greaterThan(this.one);this.minedDamageVisible!==e&&(this.minedDamageVisible=e,this.minedDamageOperator.setViewVisible(e),this.minedDamageView.setViewVisible(e)),this.prestigeDamageVisible!==t&&(this.prestigeDamageVisible=t,this.prestigeOperator.setViewVisible(t),this.prestigeDamageView.setViewVisible(t)),this.goldDamageVisible!==i&&(this.goldDamageVisible=i,this.goldOperator.setViewVisible(i),this.goldDamageView.setViewVisible(i)),this.depthDamageVisible!==r&&(this.depthDamageVisible=r,this.depthOperator.setViewVisible(r),this.depthDamageView.setViewVisible(r)),this.rubyDamageVisible!==s&&(this.rubyDamageVisible=s,this.rubyOperator.setViewVisible(s),this.rubyDamageView.setViewVisible(s)),super.updateView()}getVisibileDisplayValue(){return"inline-block"}};var Yn=class extends q{constructor(e,t,i,r,s){super(e,t),this.addView(new Wn(t,i,r,s))}initializeView(){let e=u.getElement(this.parentId);u.createElement("div",e,this.getElementId(),"bottom-row-damage"),super.initializeView()}};var Kn=class extends U{constructor(e,t){super(e,e+"_target"),this.partyTarget=t,this.displayedTargetRow=-10,this.baseBody=null,this.setInitialVisibility(!0)}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,null,"mine-damage-panel-main-section"),i=u.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Target Depth",this.baseBody=u.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.partyTarget.targetRow;this.displayedTargetRow!=e&&(this.displayedTargetRow=e,this.baseBody.innerHTML=I.formatNumber(e))}};var ei=class extends U{constructor(e,t,i,r,s,o){super(e,t),this.mineControl=i,this.mineMode=r,this.topRowText=s,this.bottomRowText=o,this.mainElement=null,this.displayedActive=!1}initializeView(){let e=this.getElementId(),t=u.getElement(this.parentId);if(!t){console.log("MineModeOption.initializeView() No parent element found! parentId="+this.parentId);return}this.displayedActive=this.mineControl.activeMode===this.mineMode,this.mainElement=u.createElement("div",t,e,this.displayedActive?"mine-mode-button-outer-active":"mine-mode-button-outer-not-active");let i=u.createElement("div",this.mainElement,null,"mine-mode-button-row"),r=u.createElement("div",i,null,"icon-container"),s=u.createElement("img",r,null,"icon-container");s.src=c.pick;let o=u.createElement("div",i,null,"pick-upgrade-title-description-container"),a=u.createElement("div",o,null,null);a.innerHTML=this.topRowText;let h=u.createElement("div",o,null,"mined-upgrade-button-description");h.innerHTML=this.bottomRowText;let m=this;this.mainElement.onclick=function(){console.log("MineModeOption click mode="+m.mineMode.id),m.mineControl.setModeActive(m.mineMode)},super.initializeView()}updateViewContents(){let e=this.mineControl.activeMode===this.mineMode;this.displayedActive!==e&&(this.displayedActive=e,e?this.mainElement.className="mine-mode-button-outer-active":this.mainElement.className="mine-mode-button-outer-not-active")}getVisibileDisplayValue(){return"inline-block"}};var Xn=class extends q{constructor(e,t,i){super(e,"mineControl"),this.addView(new ei(this.elementId,this.elementId+"_up",t,Ve.MINE_SHALLOWER,"Mine","Shallower")),this.addView(new ei(this.elementId,this.elementId+"_down",t,Ve.MINE_DEEPER,"Mine","Deeper")),this.addView(new ei(this.elementId,this.elementId+"_current",t,Ve.MINE_CURRENT,"Mine","Current")),this.addView(new ei(this.elementId,this.elementId+"_auto",t,Ve.MINE_AUTO,"Mine","Auto")),this.addView(new Kn(this.elementId,i))}initializeView(){let e=u.getElement(this.parentId);u.createElement("div",e,this.getElementId(),"mine-control-panel"),super.initializeView()}getVisibileDisplayValue(){return"inline-block"}};var jn=class extends q{constructor(e,t,i,r){super(e,t),this.addView(new Xn(t,i,r))}initializeView(){let e=u.getElement(this.parentId);u.createElement("div",e,this.getElementId(),"bottom-row-mine-control"),super.initializeView()}};var Zn=class extends q{constructor(e,t,i,r,s,o,a,h,m,p){super(e,t),this.addView(new jn(t,"bottomRowMineControl",o,s)),this.addView(new Yn(t,"bottomRowDamage",i,r,s)),this.addView(new Dn(t,"bottomRowButtonContainer",h,m))}initializeView(){let e=u.getElement(this.parentId);u.createElement("div",e,this.getElementId(),"bottom-row"),super.initializeView()}};var qn=class extends U{constructor(e){super(e,e+"_title")}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,null,"game-title-container"),i=u.createElement("div",t,null,"game-title-body"),r=u.createElement("div",i,null,"game-title-display");r.innerHTML="Mining";let s=u.createElement("div",i,null,"game-title-display");s.innerHTML="Crew",super.initializeView()}};var Pt=class extends U{constructor(e,t,i,r,s){super(e,t),this.title=i,this.iconFileName=r,this.totals=s,this.displayedDescription=null,this.valueElement=null,this.setInitialVisibility(!0)}initializeView(){let e=this.getElementId(),t=u.getElement(this.parentId);if(!t){console.log("CurrencyContainerSectionView.initializeView() No parent element found! parentId="+this.parentId);return}let i=u.createElement("div",t,e,"currency-container-section"),r=u.createElement("div",i,null,"currency-container-body"),s=u.createElement("div",r,null,"icon-container"),o=u.createElement("img",s,null,"icon-container");o.src=this.iconFileName;let a=u.createElement("div",r,this.elementId+"_text","mined-upgrade-title-description-container"),h=u.createElement("div",a,null,null);h.innerHTML=this.title,this.valueElement=u.createElement("div",a,null,"mined-upgrade-button-description"),this.valueElement.innerHTML="",this.setInitialVisibility(!0),super.initializeView()}getVisibileDisplayValue(){return"inline-block"}};var Jn=class extends Pt{constructor(e,t){super(e,e+"gold_section","Gold",c.currency.gold,t),this.displayedValue=new d(0),this.formattedValue=null}updateViewContents(){let e=this.totals.gold;(!this.formattedValue||!e.equals(this.displayedValue))&&(this.displayedValue.copy(e),this.formattedValue=I.formatBigNum(e),this.valueElement.innerHTML=this.formattedValue)}};var Qn=class extends Pt{constructor(e,t){super(e,e+"ruby_section","Ruby",c.currency.ruby,t),this.displayedValue=new d(0),this.formattedValue=null}updateViewContents(){let e=this.totals.ruby;(!this.formattedValue||!e.equals(this.displayedValue))&&(this.displayedValue.copy(e),this.formattedValue=I.formatBigNum(e),this.valueElement.innerHTML=this.formattedValue)}};var $n=class extends Pt{constructor(e,t){super(e,e+"ore_section","Mined Ore",c.currency.ore,t),this.displayedValue=new d(0),this.formattedValue=null}updateViewContents(){let e=this.totals.ore;(!this.formattedValue||!e.equals(this.displayedValue))&&(this.displayedValue.copy(e),this.formattedValue=I.formatBigNum(e),this.valueElement.innerHTML=this.formattedValue)}};var ea=class extends Pt{constructor(e,t){super(e,e+"prestige_section","Prestige",c.currency.prestige,t),this.displayedPrestige=new d(0),this.displayedUnclaimedPrestige=new d(0),this.formattedPrestigeValue=null}updateViewContents(){let e=this.totals.prestige,t=this.totals.unclaimedPrestige;(!this.formattedValue||!e.equals(this.displayedPrestige)||!t.equals(this.displayedUnclaimedPrestige))&&(this.displayedPrestige.copy(e),this.displayedUnclaimedPrestige.copy(t),t.equalsZero()?this.formattedValue=I.formatBigNum(e):this.formattedValue=I.formatBigNum(e)+" ("+I.formatBigNum(t)+")",this.valueElement.innerHTML=this.formattedValue)}};var ta=class extends q{constructor(e,t){super(e,$.CURRENCY_VIEW),this.addView(new $n(this.elementId,t)),this.addView(new Jn(this.elementId,t)),this.addView(new ea(this.elementId,t)),this.addView(new Qn(this.elementId,t)),this.setInitialVisibility(!0)}initializeView(){let e=u.getElement(this.parentId);u.createElement("div",e,this.getElementId(),"currency-container-view"),super.initializeView()}getVisibileDisplayValue(){return"inline-block"}};var ia=class extends q{constructor(e,t){super(e,e+"_one"),this.addView(new ta(this.elementId,t))}initializeView(){let e=u.getElement(this.parentId);u.createElement("div",e,this.getElementId(),"top-row-one"),super.initializeView()}};var ra=class extends U{constructor(e,t,i,r){super(e,t),this.partyTarget=i,this.statistics=r,this.displayedLayerDescription=null,this.mainElement=null,this.imgElement=null,this.titleElement=null,this.progressElement=null,this.displayedTitle=null,this.displayedDescription=null,this.descriptionElement=null,this.displayedIconFileName=null,this.displayPercent=-1,this.displayMaxDepth=-1}initializeView(){let e=this.getElementId(),t=u.getElement(this.parentId);if(!t){console.log("UnlockTerrainLayerView.initializeView() No parent element found! parentId="+this.parentId);return}this.mainElement=u.createElement("div",t,e,"terrain-layer-progress-outer");let i=u.createElement("div",this.mainElement,null,"mined-upgrade-button-body"),r=u.createElement("div",i,null,"icon-container"),s=u.createElement("div",i,this.elementId+"_text","mined-upgrade-title-description-container");this.imgElement=u.createElement("img",r,null,"icon-container"),this.imgElement.src=c.pick,this.titleElement=u.createElement("div",s,null,null),this.titleElement.innerHTML="",this.descriptionElement=u.createElement("div",s,null,"mined-upgrade-button-description"),this.descriptionElement.innerHTML="",this.progressElement=u.createElement("div",this.mainElement,null,"terrain-layer-progress-slider"),this.setInitialVisibility(!0),super.initializeView()}getVisibileDisplayValue(){return"inline-block"}generateDescription(){return"Depth: "+I.formatNumber(this.statistics.maxDepth)+" / "+I.formatNumber(this.displayedLayerDescription.maxDepth)}updateViewContents(){let e=this.partyTarget.layerDescription,t=this.partyTarget.nextLayerDescription,i=this.statistics.maxDepth;if(!t)return;if(this.displayedLayerDescription!==e||this.displayMaxDepth!=i){this.displayedLayerDescription=e,this.displayMaxDepth=i;let o=e.nominalIndex;o>0?this.titleElement.innerHTML=e.name+" ("+o+"/"+(je.length-2)+")":this.titleElement.innerHTML=e.name,this.descriptionElement.innerHTML=this.generateDescription()}if(!this.displayedLayerDescription)return;let r=this.displayedLayerDescription.iconFileName;this.displayedIconFileName!==r&&(this.displayedIconFileName=r,this.imgElement.src="images/layers/"+r);let s=e.getDepthPercent(i);s!=this.displayPercent&&(this.displayPercent=s,s>=100?this.progressElement.style.width="0px":this.progressElement.style.width=s+"%")}};var sa=class extends q{constructor(e,t,i){super(e,e+"_layer"),this.addView(new ra(this.elementId,this.elementId+"_progress",t,i))}initializeView(){let e=u.getElement(this.parentId);u.createElement("div",e,this.getElementId(),"top-row-two"),super.initializeView()}};var oa=class extends q{constructor(e,t,i,r){super(e,e+"_panel"),this.addView(new ia(this.elementId,t)),this.addView(new sa(this.elementId,i,r))}initializeView(){let e=u.getElement(this.parentId);u.createElement("div",e,this.getElementId(),"top-row-panel"),super.initializeView()}};var na=class extends q{constructor(e,t,i,r,s){super(e,t),this.addView(new qn(t)),this.addView(new oa(t,i,r,s))}initializeView(){let e=u.getElement(this.parentId);u.createElement("div",e,this.getElementId(),"top-row"),super.initializeView()}};var aa=class{constructor(){this.popupViews=[],this.popupById={}}addPopupView(e){this.popupViews.push(e),this.popupById[e.getElementId()]=e}isPopupVisible(e){let t=this.popupById[e];return t?t.isViewVisible():(console.log("PopupViewController.isPopupVisible() UNKNOWN VIEW. viewId="+e),!1)}setPopupVisible(e){for(let t=0;t<this.popupViews.length;t++){let i=this.popupViews[t];i.setViewVisible(i.getElementId()===e)}}setDoublePopupVisible(e,t){for(let i=0;i<this.popupViews.length;i++){let r=this.popupViews[i];r.setViewVisible(r.getElementId()===e||r.getElementId()===t)}}hideAllPopups(){for(let e=0;e<this.popupViews.length;e++)this.popupViews[e].setViewVisible(!1)}setPopupHidden(e){let t=this.popupById[e];if(!t){console.log("PopupViewController.setPopupHidden() UNKNOWN VIEW. viewId="+e);return}t.setViewVisible(!1)}};var Rt=class extends U{constructor(e,t,i,r,s){super(e,t),this.popupViewController=i,this.popupViewId=r,this.secondaryPopupViewId=null,this.title=s,this.mainElement=null,this.displayedVisible=!1}initializeView(){let e=this.getElementId(),t=u.getElement(this.parentId);if(!t){console.log("PopupViewToggle.initializeView() No parent element found! parentId="+this.parentId);return}this.mainElement=u.createElement("div",t,e,"upgrade-button-outer");let i=u.createElement("div",this.mainElement,null,"button-row-icon-text"),r=u.createElement("img",i,null,"pick-upgrade-icon");r.src=c.pick;let s=u.createElement("div",i,null,"pick-upgrade-title-description-container"),o=u.createElement("div",s,null,"pick-upgrade-button-title-single-row");o.innerHTML=this.title;let a=this;this.mainElement.onclick=function(){a.popupViewController.isPopupVisible(a.popupViewId)?a.popupViewController.hideAllPopups():a.secondaryPopupViewId?a.popupViewController.setDoublePopupVisible(a.popupViewId,a.secondaryPopupViewId):a.popupViewController.setPopupVisible(a.popupViewId)},super.initializeView()}updateViewContents(){let e=this.popupViewController.isPopupVisible(this.popupViewId);this.displayedVisible!==e&&(this.displayedVisible=e,e?this.mainElement.className="popup-toggle-button-outer-open":this.mainElement.className="upgrade-button-outer")}};var la=class extends q{constructor(e,t){super(e,$.CLOSE_SKILL_TREE_POPUP),this.addView(new Rt(this.elementId,this.elementId+"_skill",t,$.SKILL_TREE_GRAPH,"Close Skill Tree"))}initializeView(){let e=u.getElement(this.parentId);u.createElement("div",e,this.getElementId(),"popup-window-close-skill-tree"),this.setInitialVisibility(!1),super.initializeView()}};var da=class extends U{constructor(e,t){super(e,$.OFFLINE_POPUP),this.totals=t,this.container=null,this.offlineTimeInfo=null,this.prestigeEarnedInfo=null,this.goldEarnedInfo=null,this.oreEarnedInfo=null,this.rubyEarnedInfo=null,this.displayedPrestige=new d(-10),this.displayedGold=new d(-10),this.displayedOre=new d(-10),this.displayedRuby=new d(-10),this.displayedOfflineSeconds=0,this.working=new d(0),this.one=new d(1)}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,this.getElementId(),"popup-window-prestige"),i=u.createElement("div",t,null,null),r=u.createElement("div",i,null,"popup-window-header");r.innerHTML="Offline Progress";let s=this;r.onclick=function(){return s.totals.claimOfflineEarnings(),s.setViewVisible(!1),!1};let o=u.createElement("div",i,null,"menu-section-body");this.container=u.createElement("div",o,null,null);let a=u.createElement("div",this.container,null,"offline-info");a.innerHTML="You have offline earnings!",this.offlineTimeInfo=u.createElement("div",this.container,null,"offline-info"),this.offlineTimeInfo.innerHTML="",this.prestigeEarnedInfo=u.createElement("div",this.container,null,"offline-info"),this.prestigeEarnedInfo.innerHTML="",this.goldEarnedInfo=u.createElement("div",this.container,null,"offline-info"),this.goldEarnedInfo.innerHTML="",this.oreEarnedInfo=u.createElement("div",this.container,null,"offline-info"),this.oreEarnedInfo.innerHTML="",this.rubyEarnedInfo=u.createElement("div",this.container,null,"offline-info"),this.rubyEarnedInfo.innerHTML="";let h=u.createElement("div",this.container,null,"save-popup-button-row"),m=u.createElement("div",h,"prestigeButton","game-button prestige-button");m.style.marginTop="10px",m.innerHTML="Claim Earnings",m.onclick=function(){return s.totals.claimOfflineEarnings(),s.setViewVisible(!1),!1},this.setInitialVisibility(!1),super.initializeView()}getPrestigeRate(){return this.getRate(this.totals.prestigePerTurn)}getGoldRate(){return this.getRate(this.totals.goldPerTurn)}getOreRate(){return this.getRate(this.totals.orePerTurn)}getRubyRate(){return this.getRate(this.totals.rubyPerTurn)}getRate(e){return this.working.copy(e),this.working.mulNumber(n.time.turnsPerSecond),this.working.lessThan(this.one)?this.working.toNumber().toFixed(4)+" / second":I.formatBigNum(this.working)+" / second"}updateViewContents(){let e=this.totals.offlinePrestige,t=this.totals.offlineGold,i=this.totals.offlineOre,r=this.totals.offlineRuby,s=this.totals.countedOfflineSeconds;this.displayedOfflineSeconds!==s&&(this.displayedOfflineSeconds=s,this.offlineTimeInfo.innerHTML="Offline time: "+et.formatElapsedTime(s*1e3)),this.displayedPrestige.equals(e)||(this.displayedPrestige.copy(e),this.prestigeEarnedInfo.innerHTML="Prestige earned: "+I.formatBigNum(e)+" ("+this.getPrestigeRate()+")"),this.displayedGold.equals(t)||(this.displayedGold.copy(t),this.goldEarnedInfo.innerHTML="Gold earned: "+I.formatBigNum(t)+" ("+this.getGoldRate()+")"),this.displayedOre.equals(i)||(this.displayedOre.copy(i),this.oreEarnedInfo.innerHTML="Ore earned: "+I.formatBigNum(i)+" ("+this.getOreRate()+")"),this.displayedRuby.equals(r)||(this.displayedRuby.copy(r),this.rubyEarnedInfo.innerHTML="Ruby earned: "+I.formatBigNum(r)+" ("+this.getRubyRate()+")")}};var ha=class extends U{constructor(e,t,i){super(e,t),this.performanceTrack=i,this.countSpan=null,this.averageSpan=null,this.totalSpan=null,this.displayedCount=-1,this.displayedAverage=-1,this.displayedTotal=-1}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,null,"performance-row"),i=u.createElement("span",t,null,null);i.innerHTML=this.performanceTrack.subject,this.countSpan=u.createElement("span",t,null,"performance-value"),this.countSpan.innerHTML="",this.averageSpan=u.createElement("span",t,null,"performance-value"),this.averageSpan.innerHTML="",this.totalSpan=u.createElement("span",t,null,"performance-value"),this.totalSpan.innerHTML="",this.setInitialVisibility(!0),super.initializeView()}updateViewContents(){let e=this.performanceTrack.count,t=this.performanceTrack.elapsed,i=e>0?t/e:0;this.displayedCount!=e&&(this.displayedCount=e,this.countSpan.innerHTML=I.formatNumber(e)),this.displayedAverage!=i&&(this.displayedAverage=i,this.averageSpan.innerHTML=I.formatNumber(i)),this.displayedTotal!=t&&(this.displayedTotal!=t,this.totalSpan.innerHTML=I.formatNumber(t)),super.updateViewContents()}};var ua=class extends q{constructor(e){super(e,$.PERFORMANCE_POPUP),this.container=null,this.contentElement=null,this.displayedContent=null,this.prevTimestamp=Date.now()-1e3,this.currentKeys={}}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,this.getElementId(),"popup-window-prestige"),i=u.createElement("div",t,null,null),r=u.createElement("div",i,null,"popup-window-header");r.innerHTML="Performance Info";let s=this;r.onclick=function(){return s.setViewVisible(!1),!1};let o=u.createElement("div",i,null,"menu-section-body");this.container=u.createElement("div",o,null,null),this.contentElement=u.createElement("div",this.container,"performanceContent","offline-info");let a=u.createElement("div",this.contentElement,null,"performance-row"),h=u.createElement("span",a,null,null);h.innerHTML="Activity";let m=u.createElement("span",a,null,"performance-value");m.innerHTML="Count";let p=u.createElement("span",a,null,"performance-value");p.innerHTML="Ave Millis";let f=u.createElement("span",a,null,"performance-value");f.innerHTML="Tot Millis";let N=u.createElement("div",this.container,null,"save-popup-button-row"),T=u.createElement("div",N,"resetButton","game-button prestige-button");T.style.marginTop="10px",T.innerHTML="Reset",T.onclick=function(){return le.reset(),this.displayedContent=null,!1},this.setInitialVisibility(!1),super.initializeView()}updateViewContents(){let e=Date.now();if(e-this.prevTimestamp>1e3){this.prevTimestamp=e;let i=le.getKeys();for(let r=0;r<i.length;r++){let s=i[r];if(!this.currentKeys[s]){this.currentKeys[s]=!0;let o=le.getPerformanceTrack(s);if(o){let a=new ha("performanceContent","performanceContent_"+r,o);this.addView(a),a.initializeView()}else console.log("PerformanceMetricsPopupView.updateViewContents() failed to find: "+s)}}}super.updateViewContents()}};var ca=class extends U{constructor(e,t,i){super(e,$.PRESTIGE_POPUP),this.totals=t,this.gameStateControl=i,this.prestigeContainer=null,this.confirmContainer=null,this.prestigeEarnedInfo=null,this.prestigeEarnedInfo2=null,this.displayedPrestige=new d(0)}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,this.getElementId(),"popup-window-prestige"),i=u.createElement("div",t,null,null),r=u.createElement("div",i,null,"popup-window-header");r.innerHTML="Prestige";let s=this;r.onclick=function(){return s.setViewVisible(!1),!1};let o=u.createElement("div",i,null,"menu-section-body");this.prestigeContainer=u.createElement("div",o,null,null),this.confirmContainer=u.createElement("div",o,null,null),this.confirmContainer.style.display="none";let a=u.createElement("div",this.prestigeContainer,null,"prestige-info");a.innerHTML="Prestige the game and start over at the surface.",this.prestigeEarnedInfo=u.createElement("div",this.prestigeContainer,null,"prestige-info"),this.prestigeEarnedInfo.innerHTML=this.getEarnedPrestigeText(),this.displayedPrestige.copy(this.totals.unclaimedPrestige);let h=u.createElement("div",this.prestigeContainer,null,"prestige-info");h.innerHTML="You earn 1 prestige point per terrain layer cleared.";let m=u.createElement("div",this.prestigeContainer,null,"prestige-info");m.innerHTML="Spend your points on skills in the skill tree.";let p=u.createElement("div",this.prestigeContainer,null,"save-popup-button-row"),f=u.createElement("div",p,"prestigeButton","game-button prestige-button");f.style.marginTop="10px",f.innerHTML="Prestige Game",f.onclick=function(){return s.displayConfirmation(),!1};let N=u.createElement("div",this.confirmContainer,null,"prestige-info");N.innerHTML="Prestige Confirmation";let T=u.createElement("div",this.confirmContainer,null,"prestige-info");T.innerHTML="If you prestige you will be placed back on the surface.";let C=u.createElement("div",this.confirmContainer,null,"prestige-info");C.innerHTML="Your ore and mine power will be reset.";let w=u.createElement("div",this.confirmContainer,null,"prestige-info");w.innerHTML="Your can spend points to expand your crew and learn skills.",this.prestigeEarnedInfo2=u.createElement("div",this.confirmContainer,null,"prestige-info"),this.prestigeEarnedInfo2.innerHTML=this.getEarnedPrestigeText();let E=u.createElement("div",this.confirmContainer,null,"save-popup-button-row"),P=u.createElement("div",E,"cancelButton","game-button prestige-button");P.style.marginTop="10px",P.innerHTML="Cancel",P.onclick=function(){return s.onPrestigeCancel(),!1};let S=u.createElement("div",E,"realPrestigeButton","game-button prestige-button");S.style.marginTop="10px",S.innerHTML="Prestige Game",S.onclick=function(){return s.gameStateControl.prestigeGame(),!1},this.setInitialVisibility(!1),super.initializeView()}getEarnedPrestigeText(){return"Prestige points earned: "+I.formatBigNum(this.totals.unclaimedPrestige)}displayConfirmation(){u.hideElement(this.prestigeContainer),u.showElement(this.confirmContainer)}onPrestigeCancel(){u.hideElement(this.confirmContainer),u.showElement(this.prestigeContainer)}updateViewContents(){let e=this.totals.unclaimedPrestige;if(!this.displayedPrestige.equals(e)){this.displayedPrestige.copy(e);let t=this.getEarnedPrestigeText();this.prestigeEarnedInfo.innerHTML=t,this.prestigeEarnedInfo2.innerHTML=t}}};var ma=class extends U{constructor(e,t){super(e,$.SAVE_POPUP),this.gameStateControl=t,this.setCurrentlyVisible(!0),this.setViewVisible(!1)}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,this.elementId,"popup-window-save"),i=u.createElement("div",t,null,null),r=u.createElement("div",i,null,"popup-window-header");r.innerHTML="Save Controls",r.onclick=function(){return j.setViewVisible(!1),!1};let s=u.createElement("div",i,null,"menu-section-body"),o=u.createElement("div",s,"saveButtonsContainer","save-popup-buttons-container"),a=u.createElement("div",o,"exportSaveButton","game-button");a.innerHTML="Export Save";let h=u.createElement("div",o,"importSaveButton","game-button");h.innerHTML="Import Save";let m=u.createElement("div",o,"resetGameButton","game-button");m.innerHTML="Reset Game";let p=u.createElement("div",o,"deleteSaveButton","game-button");p.innerHTML="Delete Save";let f=u.createElement("div",s,"importContainer","save-popup-content-container");f.style.display="none";let N=u.createElement("div",f,null,null),T=u.createElement("textarea",N,"importTextArea","import-export-textarea");T.title="Paste exported save here and click import.";let C=u.createElement("div",N,null,"save-popup-button-row"),w=u.createElement("div",C,"importButtonActual","game-button save-button");w.innerHTML="Import";let E=u.createElement("div",C,"closeImportButton","game-button save-button");E.innerHTML="Close";let P=u.createElement("div",s,"exportContainer","save-popup-content-container");P.style.display="none";let S=u.createElement("div",P,null,null),A=u.createElement("textarea",S,"exportTextArea","import-export-textarea"),_=u.createElement("div",P,null,"save-popup-button-row"),L=u.createElement("div",_,"copyToClipboardButton","game-button save-button");L.style.width="130px",L.innerHTML="Copy to Clipboard";let W=u.createElement("div",_,"closeExportButton","game-button save-button");W.innerHTML="Close";let x=u.createElement("div",s,"resetConfirmationContainer","save-popup-content-container");x.style.display="none";let J=u.createElement("div",x,null,null);J.style.padding="10px",J.innerHTML="Are you sure you want to reset? You will not lose your victory count.";let ie=u.createElement("div",x,null,"save-popup-button-row"),Y=u.createElement("div",ie,"resetButtonActual","game-button save-button");Y.innerHTML="Reset";let X=u.createElement("div",ie,"closeResetButton","game-button save-button");X.innerHTML="Close";let B=u.createElement("div",s,"deleteConfirmationContainer","save-popup-content-container");B.style.display="none";let k=u.createElement("div",B,null,null);k.style.padding="10px",k.innerHTML="Are you sure you want to delete? You will lose everything and start over.";let Ce=u.createElement("div",B,null,"save-popup-button-row"),me=u.createElement("div",Ce,"deleteButtonActual","game-button save-button");me.innerHTML="Delete";let Ae=u.createElement("div",Ce,"closeDeleteButton","game-button save-button");Ae.innerHTML="Close",this.setInitialVisibility(!1),super.initializeView();let j=this;this.saveTimeDiv=u.getElement("lastSaveTime"),this.displayedSaveTime=-1,a.onclick=function(){return j.displayExportSave(),!1},h.onclick=function(){return j.displayImportSave(),!1},E.onclick=function(){return j.closeImportContainer(),!1},w.onclick=function(){return j.handleImportSave(),!1},W.onclick=function(){return j.closeExportContainer(),!1},L.onclick=function(){A.select(),navigator.clipboard.writeText(A.value).then(()=>{console.log("clipboard successfully set")},()=>{console.error("clipboard write failed")})},m.onclick=function(){return j.displayResetConfirmation(),!1},p.onclick=function(){return j.displayDeleteConfirmation(),!1},Y.onclick=function(){return j.handleGameReset(),!1},me.onclick=function(){return j.handleGameDelete(),!1},X.onclick=function(){return j.closeResetConfirmation(),!1},Ae.onclick=function(){return j.closeDeleteConfirmation(),!1}}displayExportSave(){u.hideElementId("saveButtonsContainer"),u.showElementId("exportContainer");var e=u.getElement("exportTextArea");let t=this.gameStateControl.getState();e.value=t.saveManager.getSaveStateForExport(t)}displayImportSave(){u.hideElementId("saveButtonsContainer"),u.showElementId("importContainer"),u.showElementId("importButtonActual")}closeImportContainer(){var e=u.getElement("importTextArea");e.value="",u.hideElementId("importContainer"),u.showElementIdWithValue("saveButtonsContainer","grid")}closeExportContainer(){var e=u.getElement("exportTextArea");e.value="",u.hideElementId("exportContainer"),u.showElementIdWithValue("saveButtonsContainer","grid")}handleImportSave(){console.log("SavePopupView.handleImportSave()");let e=u.getElement("importTextArea").value;this.gameStateControl.importSave(e)}handleGameReset(){this.gameStateControl.resetGame()}handleGameDelete(){this.gameStateControl.deleteGame()}displayResetConfirmation(){u.hideElementId("saveButtonsContainer"),u.showElementId("resetConfirmationContainer")}displayDeleteConfirmation(){u.hideElementId("saveButtonsContainer"),u.showElementId("deleteConfirmationContainer")}closeResetConfirmation(){u.hideElementId("resetConfirmationContainer"),u.showElementIdWithValue("saveButtonsContainer","grid")}closeDeleteConfirmation(){u.hideElementId("deleteConfirmationContainer"),u.showElementIdWithValue("saveButtonsContainer","grid")}};var ar=class extends U{constructor(e,t,i,r){super(e,t),this.statistics=i,this.headerText=r,this.displayedSeconds=-1,this.displayedTotalOre=new d(-1),this.displayedTotalGold=new d(-1),this.displayedTotalRuby=new d(-1),this.displayedTotalPrestigePoints=new d(-1),this.displayedUpgradeOre=new d(-1),this.displayedMaxDepth=-1,this.displayedTilesMined=new d(-1),this.displayedTilesMinedCommon=new d(-1),this.displayedTilesMinedOre=new d(-1),this.displayedTilesMinedGold=new d(-1),this.displayedTilesMinedRuby=new d(-1),this.displayedTilesMinedUpgrade=new d(-1),this.displayedTilesMinedLaser=new d(-1),this.displayedTilesMinedDrill=new d(-1),this.displayedTilesMinedOrbit=new d(-1),this.displayedTilesMinedMissile=new d(-1),this.totalTurnsElement=null,this.totalOreElement=null,this.totalGoldElement=null,this.totalRubyElement=null,this.totalPrestigePointsElement=null,this.upgradeOreElement=null,this.maxDepthElement=null,this.tilesMinedElement=null,this.tilesMinedCommonElement=null,this.tilesMinedOreElement=null,this.tilesMinedGoldElement=null,this.tilesMinedRubyElement=null,this.tilesMinedUpgradeElement=null,this.tilesMinedLaserElement=null,this.tilesMinedDrillElement=null,this.tilesMinedOrbitElement=null,this.tilesMinedMissileElement=null,this.setViewVisible(!1)}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,null,"stats-view"),i=u.createElement("div",t,null,"stats-header");i.innerHTML=this.headerText;let r=u.createElement("div",t,null,"menu-section-body");this.totalTurnsElement=this.createStatsSection(r,"Time","Time",!1),this.totalOreElement=this.createStatsSection(r,"Total Ore","Ore",!1),this.totalGoldElement=this.createStatsSection(r,"Total Gold","Gold",!1),this.totalRubyElement=this.createStatsSection(r,"Total Ruby","Ruby",!1),this.totalPrestigePointsElement=this.createStatsSection(r,"Total Prestige","Points",!1),this.maxDepthElement=this.createStatsSection(r,"Max Depth","Blocks",!1),this.upgradeOreElement=this.createStatsSection(r,"Upgrade Ore","Ore",!1),this.tilesMinedElement=this.createStatsSection(r,"Type: Any","Blocks",!0),this.tilesMinedCommonElement=this.createStatsSection(r,"Type: Common","Blocks",!1),this.tilesMinedOreElement=this.createStatsSection(r,"Type: Ore","Blocks",!1),this.tilesMinedGoldElement=this.createStatsSection(r,"Type: Gold","Blocks",!1),this.tilesMinedRubyElement=this.createStatsSection(r,"Type: Ruby","Blocks",!1),this.tilesMinedUpgradeElement=this.createStatsSection(r,"Type: Upgrade","Blocks",!1),this.tilesMinedLaserElement=this.createStatsSection(r,"Skill: Laser","Blocks",!0),this.tilesMinedDrillElement=this.createStatsSection(r,"Skill: Drill","Blocks",!1),this.tilesMinedOrbitElement=this.createStatsSection(r,"Skill: Orbit","Blocks",!1),this.tilesMinedMissileElement=this.createStatsSection(r,"Skill: Missile","Blocks",!1),this.setInitialVisibility(!0),super.initializeView()}createStatsSection(e,t,i,r){let s=u.createElement("div",e,null,"numbers-section-row");r&&(s.style.marginTop="10px");let o=u.createElement("div",s,null,"numbers-section-label");o.innerHTML=t;let a=u.createElement("div",s,null,"numbers-section-unit");return a.innerHTML=i,u.createElement("div",s,null,"numbers-section-value")}updateViewContents(){let e=this.statistics.totalTurns*n.time.secondsPerTurn|0;this.displayedSeconds!==e&&(this.displayedSeconds=e,this.totalTurnsElement.innerHTML=et.formatElapsedTime(e*1e3));let t=this.statistics.totalOre;this.displayedTotalOre.equals(t)||(this.displayedTotalOre.copy(t),this.totalOreElement.innerHTML=I.formatBigNum(t));let i=this.statistics.totalGold;this.displayedTotalGold.equals(i)||(this.displayedTotalGold.copy(i),this.totalGoldElement.innerHTML=I.formatBigNum(i));let r=this.statistics.totalRuby;this.displayedTotalRuby.equals(r)||(this.displayedTotalRuby.copy(r),this.totalRubyElement.innerHTML=I.formatBigNum(r));let s=this.statistics.totalPrestigePoints;this.displayedTotalPrestigePoints.equals(s)||(this.displayedTotalPrestigePoints.compare(s),this.totalPrestigePointsElement.innerHTML=I.formatBigNum(s));let o=this.statistics.upgradeOre;this.displayedUpgradeOre.equals(o)||(this.displayedUpgradeOre.copy(o),this.upgradeOreElement.innerHTML=I.formatBigNum(o));let a=this.statistics.maxDepth;this.displayedMaxDepth!==a&&(this.displayedMaxDepth=a,this.maxDepthElement.innerHTML=I.formatNumber(a));let h=this.statistics.tilesMined;this.displayedTilesMined.equals(h)||(this.displayedTilesMined.copy(h),this.tilesMinedElement.innerHTML=I.formatBigNum(h));let m=this.statistics.tilesMinedCommon;this.displayedTilesMinedCommon.equals(m)||(this.displayedTilesMinedCommon.copy(m),this.tilesMinedCommonElement.innerHTML=I.formatBigNum(m));let p=this.statistics.tilesMinedOre;this.displayedTilesMinedOre.equals(p)||(this.displayedTilesMinedOre.copy(p),this.tilesMinedOreElement.innerHTML=I.formatBigNum(p));let f=this.statistics.tilesMinedGold;this.displayedTilesMinedGold.equals(f)||(this.displayedTilesMinedGold.copy(f),this.tilesMinedGoldElement.innerHTML=I.formatBigNum(f));let N=this.statistics.tilesMinedRuby;this.displayedTilesMinedRuby.equals(N)||(this.displayedTilesMinedRuby.copy(N),this.tilesMinedRubyElement.innerHTML=I.formatBigNum(N));let T=this.statistics.tilesMinedUpgrade;this.displayedTilesMinedUpgrade.equals(T)||(this.displayedTilesMinedUpgrade.copy(T),this.tilesMinedUpgradeElement.innerHTML=I.formatBigNum(T));let C=this.statistics.tilesMinedLaser;this.displayedTilesMinedLaser.equals(C)||(this.displayedTilesMinedLaser.copy(C),this.tilesMinedLaserElement.innerHTML=I.formatBigNum(C));let w=this.statistics.tilesMinedDrill;this.displayedTilesMinedDrill.equals(w)||(this.displayedTilesMinedDrill.copy(w),this.tilesMinedDrillElement.innerHTML=I.formatBigNum(w));let E=this.statistics.tilesMinedOrbit;this.displayedTilesMinedOrbit.equals(E)||(this.displayedTilesMinedOrbit.copy(E),this.tilesMinedOrbitElement.innerHTML=I.formatBigNum(E));let P=this.statistics.tilesMinedMissile;this.displayedTilesMinedMissile.equals(P)||(this.displayedTilesMinedMissile.copy(P),this.tilesMinedMissileElement.innerHTML=I.formatBigNum(P))}};var pa=class extends q{constructor(e,t,i){super(e,e+"_container");let r=this.getElementId();this.addView(new ar(r,r+"_run",t,"Current Run Statistics")),this.addView(new ar(r,r+"_global",i,"Cumulative Statistics"))}initializeView(){let e=u.getElement(this.parentId);u.createElement("div",e,this.getElementId(),"stats-container"),this.setInitialVisibility(!0),super.initializeView()}getVisibileDisplayValue(){return"grid"}};var ga=class extends q{constructor(e,t,i){super(e,$.STATISTICS_POPUP),this.addView(new pa(this.getElementId(),t,i))}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,this.getElementId(),"popup-window-statistics"),i=u.createElement("div",t,null,"popup-window-header");i.innerHTML="Statistics";let r=this;i.onclick=function(){return r.setViewVisible(!1),!1},this.setInitialVisibility(!1),super.initializeView()}};var fa=class extends q{constructor(e,t,i,r,s,o,a){super(e,t),this.totals=s,this.popupViewController=a;let h=new ga(t,i,r),m=new ma(t,o),p=new ca(t,s,o),f=new la(t,a),N=new da(t,s),T=new ua(t);a.addPopupView(h),a.addPopupView(m),a.addPopupView(p),a.addPopupView(f),a.addPopupView(N),a.addPopupView(T),this.addView(h),this.addView(m),this.addView(p),this.addView(f),this.addView(N),this.addView(T)}initializeView(){let e=u.getElement(this.parentId);u.createElement("div",e,this.getElementId(),"popup-container"),super.initializeView()}updateView(){this.totals.countedOfflineSeconds>0&&!this.popupViewController.isPopupVisible($.OFFLINE_POPUP)&&this.popupViewController.setPopupVisible($.OFFLINE_POPUP),super.updateView()}};var ct=class extends U{constructor(e,t,i){super(e,t),this.headerText=i,this.headerElement=null,this.setInitialVisibility(!0)}initializeView(){let e=u.getElement(this.parentId);if(!e){console.log("HeaderView.initializeView() No parent element found! parentId="+this.parentId);return}this.headerElement=u.createElement("div",e,this.elementId,"header-panel"),this.headerElement.innerHTML=this.headerText,super.initializeView()}};var Wt=class extends U{constructor(e,t,i,r){super(e,t),this.headerText=i,this.automation=r,this.mainElement=null,this.activeProgressElement=null,this.titleElement=null,this.descriptionElement=null,this.displayedActive=r.active,this.displayedPercent=-1,this.setInitialVisibility(!0)}initializeView(){let e=u.getElement(this.parentId);if(!e){console.log("AutomationView.initializeView() No parent element found! parentId="+this.parentId);return}let t=this.automation.active?"automation-button-outer-active":"automation-button-outer-not-active";this.mainElement=u.createElement("div",e,this.elementId,t),this.activeProgressElement=u.createElement("div",this.mainElement,null,this.getProgressElementClassName());let i=u.createElement("div",this.mainElement,null,"active-skill-button-body"),r=u.createElement("div",i,null,"icon-container"),s=u.createElement("div",i,null,null),o=u.createElement("img",r,null,null);o.src=c.pick,this.titleElement=u.createElement("div",s,null,null),this.titleElement.innerHTML=this.headerText,this.descriptionElement=u.createElement("div",s,null,"skill-panel-row2-description"),this.descriptionElement.innerHTML=this.getDescription(),this.setInitialVisibility(!1);let a=this;this.mainElement.onclick=function(){a.automation.toggleActiveFlag()},super.initializeView()}getProgressElementClassName(){return"automation-progress-panel"}updateView(){let e=this.automation.isUnlocked();e!==this.isViewVisible()&&this.setViewVisible(e),super.updateView()}updateViewContents(){let e=this.automation.active;if(this.displayedActive!==e){this.displayedActive=e;let i=e?"automation-button-outer-active":"automation-button-outer-not-active";this.mainElement.className=i,this.descriptionElement.innerHTML=this.getDescription()}let t=this.automation.getActivationPercent();this.displayedPercent!==t&&(this.displayedPercent=t,this.activeProgressElement.style.width=t+"%")}getDescription(){return this.automation.active?"Active":"Not Active"}};var Ta=class extends Wt{constructor(e,t,i,r){super(e,t,i,r),this.prestigeAutomation=r,this.displayedPrestigePossible=r.prestigePossible,this.displayedElapsedSeconds=-1,this.waitingDescription="Waiting..."}getProgressElementClassName(){return this.prestigeAutomation.prestigePossible?"automation-progress-panel":"prestige-automation-criteria-progress-panel"}updateViewContents(){let e=this.automation.active,t=this.prestigeAutomation.prestigePossible;if(this.displayedActive!==e){this.displayedActive=e;let i=e?"automation-button-outer-active":"automation-button-outer-not-active";this.mainElement.className=i,this.descriptionElement.innerHTML=this.getDescription()}if(e){if(this.displayedPrestigePossible!=t&&(this.displayedPrestigePossible=t,this.activeProgressElement.className=t?"automation-progress-panel":"prestige-automation-criteria-progress-panel",this.descriptionElement.innerHTML=this.getDescription()),!t){let r=this.prestigeAutomation.getElapsedTurnsSincePrestige(),s=r*n.time.secondsPerTurn|0;if(this.displayedElapsedSeconds!==s){this.displayedElapsedSeconds=s;let a=Math.max(0,n.automation.prestigeMinTurnsSinceLastChange-r)*n.time.millisPerTurn|0;this.descriptionElement.innerHTML="Layer Clear Countdown: "+et.formatElapsedTimeNoHours(a)}}let i=t?this.automation.getActivationPercent():this.prestigeAutomation.getCriteriaPercent();this.displayedPercent!==i&&(this.displayedPercent=i,this.activeProgressElement.style.width=i+"%")}}getDescription(){return this.automation.active?this.prestigeAutomation.prestigePossible?"Active":"Waiting...":"Not Active"}};var Ea=class extends U{constructor(e,t,i,r){super(e,t),this.title=i,this.gameOptions=r,this.mainElement=null,this.displayedEnabled=!1}initializeView(){let e=this.getElementId(),t=u.getElement(this.parentId);if(!t){console.log("GameOptionsToggle.initializeView() No parent element found! parentId="+this.parentId);return}this.mainElement=u.createElement("div",t,e,"upgrade-button-outer");let i=u.createElement("div",this.mainElement,null,"button-row-icon-text"),r=u.createElement("img",i,null,"pick-upgrade-icon");r.src=c.pick;let s=u.createElement("div",i,null,"pick-upgrade-title-description-container"),o=u.createElement("div",s,null,"pick-upgrade-button-title-single-row");o.innerHTML=this.title;let a=this;this.mainElement.onclick=function(){a.gameOptions.crewBrainDebugEnabled=!a.gameOptions.crewBrainDebugEnabled},super.initializeView()}updateViewContents(){let e=this.gameOptions.crewBrainDebugEnabled;this.displayedEnabled!==e&&(this.displayedEnabled=e,e?this.mainElement.className="popup-toggle-button-outer-open":this.mainElement.className="upgrade-button-outer")}};var wa=class extends q{constructor(e,t,i,r){super(e,$.MENU_PANEL),this.addView(new ct(this.elementId,this.elementId+"_header","Menu")),this.addView(new Rt(this.elementId,this.elementId+"_prestige",t,$.PRESTIGE_POPUP,"Prestige"));let s=new Rt(this.elementId,this.elementId+"_skill",t,$.SKILL_TREE_GRAPH,"Skill Tree");s.secondaryPopupViewId=$.CLOSE_SKILL_TREE_POPUP,this.addView(s),this.addView(new Rt(this.elementId,this.elementId+"_stats",t,$.STATISTICS_POPUP,"Statistics View")),this.addView(new Rt(this.elementId,this.elementId+"_save",t,$.SAVE_POPUP,"Save View")),this.addView(new Rt(this.elementId,this.elementId+"_performance",t,$.PERFORMANCE_POPUP,"Performance View (Dev tool)")),this.addView(new Ea(this.elementId,this.elementId+"_debug","Crew Brain Debug (Dev tool)",r)),this.addView(new Ta(this.elementId,this.elementId+"_auto_prestige","Auto Prestige",i))}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,this.elementId,null);t.style.display="none",this.setViewVisible(!1),this.setCurrentlyVisible(!0),super.initializeView()}};var Ca=class extends U{constructor(e,t,i,r,s){super(e,t),this.tabContentsView=i,this.tabContainerView=r,this.tabIconPath=s,this.tabItem=null}getVisibileDisplayValue(){return"inline-block"}initializeView(){let e=this,t=this.getElementId(),i=u.getElement(this.parentId);this.tabItem=u.createElement("button",i,t,"upgrade-tab-menu-item");let r=u.createElement("img",this.tabItem,null,"icon-container");r.src=this.tabIconPath,this.tabItem.onclick=function(){e.tabContainerView.onTabItemViewClicked(e)},super.initializeView()}setTabSelected(e){e?this.tabItem.className="upgrade-tab-menu-item-selected":this.tabItem.className="upgrade-tab-menu-item"}};var Sa=class extends q{constructor(e){super(e,$.PRIMARY_UPGRADE_PANEL_TAB_BAR),this.tabItemViews=[],this.setViewVisible(!0),this.setCurrentlyVisible(!1)}addPanelView(e,t){let i=e.elementId+"_tab",r=new Ca(this.elementId,i,e,this,t);this.tabItemViews.push(r),this.addView(r)}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,this.getElementId(),"upgrade-tab-menu-bar");super.initializeView(),u.createElement("div",t,null,"upgrade-tab-menu-bar-fill-remaining"),this.tabItemViews.length>0&&this.onTabItemViewClicked(this.tabItemViews[0])}onTabItemViewClicked(e){for(let t=0;t<this.tabItemViews.length;t++){let i=this.tabItemViews[t],r=i===e;i.setTabSelected(r),i.tabContentsView.setViewVisible(r)}}getVisibileDisplayValue(){return"flex"}};var Na=class extends U{constructor(e,t,i){super(e,t),this.upgradeCollection=i,this.purchaseOneButton=null,this.purchaseFiveButton=null,this.purchaseTenButton=null,this.purchaseMaxButton=null,this.displayedPurchaseCount=Ge.purchaseOne,this.setCurrentlyVisible(!1),this.setViewVisible(!0)}getVisibileDisplayValue(){return"grid"}initializeView(){super.initializeView();let e=this.getElementId(),t=u.getElement(this.parentId);if(!t){console.log("CountToPurchaseView.initializeView() No element found! id="+e);return}let i=u.createElement("div",t,e,"purchase-count-button-container");this.purchaseOneButton=u.createElement("div",i,e+"_one","purchase-count-button-selected"),this.purchaseFiveButton=u.createElement("div",i,e+"_five","purchase-count-button"),this.purchaseTenButton=u.createElement("div",i,e+"_ten","purchase-count-button"),this.purchaseMaxButton=u.createElement("div",i,e+"_max","purchase-count-button"),this.purchaseOneButton.innerHTML="1",this.purchaseFiveButton.innerHTML="5",this.purchaseTenButton.innerHTML="10",this.purchaseMaxButton.innerHTML="Max";let r=this;this.purchaseOneButton.onclick=function(){r.upgradeCollection.setCountToPurchase(Ge.purchaseOne)},this.purchaseFiveButton.onclick=function(){r.upgradeCollection.setCountToPurchase(Ge.purchaseFive)},this.purchaseTenButton.onclick=function(){r.upgradeCollection.setCountToPurchase(Ge.purchaseTen)},this.purchaseMaxButton.onclick=function(){r.upgradeCollection.setCountToPurchase(Ge.purchaseMax)}}updateViewContents(){let e=this.upgradeCollection.countToPurchase;this.displayedPurchaseCount!==e&&(this.displayedPurchaseCount===Ge.purchaseOne?this.purchaseOneButton.className="purchase-count-button":this.displayedPurchaseCount===Ge.purchaseFive?this.purchaseFiveButton.className="purchase-count-button":this.displayedPurchaseCount===Ge.purchaseTen?this.purchaseTenButton.className="purchase-count-button":this.displayedPurchaseCount===Ge.purchaseMax&&(this.purchaseMaxButton.className="purchase-count-button"),e===Ge.purchaseOne?this.purchaseOneButton.className="purchase-count-button-selected":e===Ge.purchaseFive?this.purchaseFiveButton.className="purchase-count-button-selected":e===Ge.purchaseTen?this.purchaseTenButton.className="purchase-count-button-selected":e===Ge.purchaseMax&&(this.purchaseMaxButton.className="purchase-count-button-selected"),this.displayedPurchaseCount=e)}};var bi=class extends U{constructor(e,t,i,r){super(e,t),this.upgrade=i,this.displayDescriptionRow=r,this.mainElement=null,this.titleElement=null,this.descriptionElement=null,this.costElement=null,this.displayedCost=new d(-10),this.countElement=null,this.displayedCount=-10,this.displayedNextActualPurchaseCount=-10,this.displayedTitle=null,this.displayedDescription=null,this.displayedPurchasable=!this.upgrade.isPurchasable()}setClassicUpgrade(e){this.upgrade=e}initializeView(){let e=this.getElementId(),t=u.getElement(this.parentId);if(!t){console.log("PickUpgradeView.initializeView() No parent element found! parentId="+this.parentId);return}this.displayedPurchasable=this.upgrade.isPurchasable();let i=this.displayedPurchasable?"upgrade-button-outer":"upgrade-button-outer-not-purchasable";this.mainElement=u.createElement("div",t,e,i);let r=u.createElement("div",this.mainElement,null,"pick-upgrade-button-row1"),s=u.createElement("img",r,null,"pick-upgrade-icon");s.src=c.pick;let o=u.createElement("div",r,null,"pick-upgrade-title-description-container");this.displayDescriptionRow?(this.titleElement=u.createElement("div",o,null,"pick-upgrade-button-title-double-row"),this.descriptionElement=u.createElement("div",o,null,"pick-upgrade-button-description"),this.descriptionElement.innerHTML=""):this.titleElement=u.createElement("div",o,null,"pick-upgrade-button-title-single-row"),this.titleElement.innerHTML="";let a=u.createElement("div",r,null,null);this.countElement=u.createElement("div",a,null,"pick-upgrade-count"),this.costElement=u.createElement("div",a,null,"pick-upgrade-cost"),this.setInitialVisibility(this.upgrade.isVisible());let h=this;this.mainElement.onclick=function(){h.upgrade.isPurchasable()&&h.upgrade.purchase()},super.initializeView()}updateView(){this.setViewVisible(this.upgrade&&this.upgrade.isVisible()),super.updateView()}updateViewContents(){let e=this.upgrade.getCost(),t=this.upgrade.purchasedCount,i=this.upgrade.isPurchasable(),r=this.upgrade.getCountToPurchaseSetting(),s=this.upgrade.nextActualPurchaseCount;e.equals(this.displayedCost)||(this.displayedCost.copy(e),this.costElement.innerHTML=I.formatBigNum(e)+" "+this.upgrade.getCostUnit()),(t!==this.displayedCount||s!==this.displayedNextActualPurchaseCount)&&(this.displayedCount=t,this.displayedNextActualPurchaseCount=s,r===Ge.purchaseOne?this.countElement.innerHTML=""+t:this.countElement.innerHTML=""+t+"+"+s);let o=this.upgrade.title;if(o!==this.displayedTitle&&(this.displayedTitle=o,this.titleElement.innerHTML=o),this.displayDescriptionRow){let a=this.upgrade.getDescription();a&&a!==this.displayedDescription&&(this.displayedDescription=a,this.descriptionElement.innerHTML=a)}i!==this.displayedPurchasable&&(this.displayedPurchasable=i,i?this.mainElement.className="upgrade-button-outer":this.mainElement.className="upgrade-button-outer-not-purchasable")}};var Ii=class extends q{constructor(e,t,i){super(e,t),this.upgradeCollection=i,this.upgradeViews=[],this.idSequence=0;let r=this.upgradeCollection.upgrades;for(let s=0;s<r.length;s++){let o=r[s];if(!o||!o.isVisible())continue;let a=this.createUpgradeView(r[s]);this.upgradeViews.push(a),this.addView(a)}}getNextId(){return++this.idSequence}initializeView(){let e=u.getElement(this.parentId);u.createElement("div",e,this.elementId,null),super.initializeView()}updateViewContents(){let e=this.upgradeCollection.upgrades,t=0,i=0;for(;t<e.length&&i<this.upgradeViews.length;t++){let r=e[t];!r||!r.isVisible()||(this.upgradeViews[i].setClassicUpgrade(r),i++)}if(t<e.length)for(;t<e.length;t++){let r=e[t];if(!r||!r.isVisible())continue;let s=this.createUpgradeView(e[t]);this.upgradeViews.push(s),this.addView(s),s.initializeView()}else if(i<this.upgradeViews.length)for(;i<this.upgradeViews.length;i++)this.upgradeViews[i].setClassicUpgrade(null);super.updateViewContents()}createUpgradeView(e){return new bi(this.elementId,this.elementId+"_"+this.getNextId(),e,!1)}};var Aa=class extends q{constructor(e,t,i,r){super(e,t),this.addView(new ct(this.elementId,this.elementId+"_header","Ore Upgrades")),this.addView(new Ii(this.elementId,this.elementId+"_upgrades",i)),this.addView(new ct(this.elementId,this.elementId+"_settings_header","Purchase Settings")),this.addView(new Na(this.elementId,this.elementId+"_ctp",i)),this.addView(new Wt(this.elementId,this.elementId+"_auto","Auto Purchase",r))}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,this.elementId,"primary-upgrade-panel-body");t.style.display="none",this.setViewVisible(!1),this.setCurrentlyVisible(!0),super.initializeView()}};var Pa=class extends Ii{constructor(e,t,i){super(e,t,i)}createUpgradeView(e){return new bi(this.elementId,this.elementId+"_"+this.getNextId(),e,!0)}};var Ra=class extends q{constructor(e,t,i){super(e,t),this.addView(new ct(this.elementId,this.elementId+"_header","Gold Upgrades")),this.addView(new Pa(this.elementId,this.elementId+"_gold_upgrades",i))}initializeView(){let e=u.getElement(this.parentId),t=u.createElement("div",e,this.elementId,"primary-upgrade-panel-body");t.style.display="none",this.setInitialVisibility(!1),super.initializeView()}};var Ma=class extends U{constructor(e,t,i){super(e,t),this.titleDescriptionContainerId=t+"_text",this.minedUpgradeCollection=i,this.upgrade=null,this.mainElement=null,this.titleDescriptionContainer=null,this.imgElement=null,this.titleElement=null,this.displayedTitle=null,this.displayedDescription=null,this.descriptionElement=null,this.displayedIconFileName=null,this.displayedPurchasable=!0}setUpgrade(e){if(this.upgrade!==e)if(this.upgrade=e,e){let t=this.upgrade.getDescription();this.displayedDescription=null,t?this.descriptionElement||(this.descriptionElement=u.createElement("div",this.titleDescriptionContainer,null,"mined-upgrade-button-description"),this.descriptionElement.innerHTML="",this.titleElement.className="mined-upgrade-button-title-double-row"):(this.descriptionElement&&(u.removeElement(this.titleDescriptionContainerId,this.descriptionElement),this.descriptionElement=null),this.titleElement.className="mined-upgrade-button-title-single-row"),this.displayedPurchasable=!this.upgrade.isPurchasable(),this.setViewVisible(!0)}else this.setViewVisible(!1)}initializeView(){let e=this.getElementId(),t=u.getElement(this.parentId);if(!t){console.log("UpgradeView.initializeView() No parent element found! parentId="+this.parentId);return}this.mainElement=u.createElement("div",t,e,"upgrade-button-outer");let i=u.createElement("div",this.mainElement,null,"mined-upgrade-button-body"),r=u.createElement("div",i,null,"icon-container");this.titleDescriptionContainer=u.createElement("div",i,this.titleDescriptionContainerId,"mined-upgrade-title-description-container"),this.imgElement=u.createElement("img",r,null,null),this.imgElement.src=c.pick,this.titleElement=u.createElement("div",this.titleDescriptionContainer,null,"mined-upgrade-button-title-single-row"),this.titleElement.innerHTML="",u.hideElement(this.mainElement),this.setViewVisible(!1);let s=this;this.mainElement.onclick=function(){!s.upgrade||!s.upgrade.isPurchasable()||s.upgrade.purchase()&&(s.minedUpgradeCollection.remove(s.upgrade),s.upgrade=null,s.setViewVisible(!1))},super.initializeView()}updateViewContents(){if(!this.upgrade)return;let e=this.upgrade.title;e!==this.displayedTitle&&(this.displayedTitle=e,this.titleElement.innerHTML=e);let t=this.upgrade.getDescription();t&&t!==this.displayedDescription&&(this.displayedDescription=t,this.descriptionElement?this.descriptionElement.innerHTML=t:console.log("MinedUpgradeView.updateViewContents() null description element"));let i=this.upgrade.iconFileName;this.displayedIconFileName!==i&&(this.displayedIconFileName=i,this.imgElement.src=i);let r=this.upgrade.isPurchasable();this.displayedPurchasable!==r&&(this.displayedPurchasable=r,r?this.mainElement.className="upgrade-button-outer":this.mainElement.className="upgrade-button-outer-not-purchasable")}};var _a=class extends q{constructor(e,t,i){super(e,t),this.minedUpgradeCollection=i,this.displayedChangeCount=-1,this.maxDisplayCount=15,this.upgradeViews=[],this.addView(new ct(this.elementId,this.elementId+"_header","Mined Upgrades"));for(let r=0;r<this.maxDisplayCount;r++){let s=new Ma(t,t+"_"+r,i);this.upgradeViews.push(s),this.addView(s)}this.setCurrentlyVisible(!0)}initializeView(){let e=u.getElement(this.parentId);u.createElement("div",e,this.elementId,null),super.initializeView()}updateView(){super.updateView()}updateViewContents(){this.displayedChangeCount!==this.minedUpgradeCollection.changeCount&&(this.displayedChangeCount=this.minedUpgradeCollection.changeCount,this.updateUpgrades()),super.updateViewContents()}updateUpgrades(){let e=this.minedUpgradeCollection.upgrades,t=Math.min(e.length,this.maxDisplayCount),i=0;for(;i<t;i++)i<this.upgradeViews.length&&this.upgradeViews[i].setUpgrade(e[i]);for(;i<this.upgradeViews.length;i++)this.upgradeViews[i].setUpgrade(null)}};var La=class extends q{constructor(e,t,i){super(e,$.FREE_UPGRADES_PANEL),this.addView(new _a(this.elementId,$.MINED_UPGRADES_PANEL,t)),this.addView(new Wt(this.elementId,this.elementId+"_auto","Auto Claim",i))}initializeView(){let e=u.getElement(this.parentId);u.createElement("div",e,this.elementId,"primary-upgrade-panel-body"),super.initializeView()}};var ya=class extends q{constructor(e,t,i,r,s,o,a,h,m){super(e,$.PRIMARY_UPGRADE_PANEL);let p=new Sa(this.elementId);this.addView(p);let f=new La(this.elementId,t,i),N=new Aa(this.elementId,$.PICK_UPGRADES_PANEL,r,s),T=new Ra(this.elementId,$.GOLD_UPGRADES_PANEL,o),C=new wa(this.elementId,h,a,m);this.addView(f),this.addView(N),this.addView(T),this.addView(C),p.addPanelView(f,c.currency.upgrades),p.addPanelView(N,c.currency.ore),p.addPanelView(T,c.currency.gold),p.addPanelView(C,c.pick),this.setViewVisible(!0),this.setCurrentlyVisible(!0)}initializeView(){let e=u.getElement(this.parentId);u.createElement("div",e,this.getElementId(),"primary-upgrade-panel"),super.initializeView()}getVisibileDisplayValue(){return"flex"}};var ba=class extends q{constructor(e,t,i,r){super(e,$.GAME_VIEW_OVERLAY_CONTAINER);let s=this.getElementId();this.addView(new na(s,"topRowContainer",t.totals,t.partyTarget,t.runStatistics)),this.addView(new vn(s,t.bonusCollection)),this.addView(new fa(s,"popupContainer",t.runStatistics,t.globalStatistics,t.totals,i,r)),this.addView(new ya(s,t.minedUpgradeCollection,t.automationManager.minedUpgradeAutomation,t.pickUpgradeCollection,t.automationManager.pickUpgradeAutomation,t.goldUpgradeCollection,t.automationManager.prestigeAutomation,r,t.gameOptions)),this.addView(new Zn(s,"bottomRowContainer",t.damage,t.values,t.partyTarget,t.mineControl,t.crew,t.projection,t.panAnimation,t.runStatistics))}initializeView(){let e=u.getElement(this.parentId);u.createElement("div",e,this.elementId,"view-overlay-container"),this.setInitialVisibility(!0),super.initializeView()}};var Ia=class extends U{constructor(e,t,i){super(e,e+"_"+t.id+"_"+i.id+"_con"),this.parentNode=t,this.childNode=i,this.originNode=this.getTopLeftNode(),this.mainElement=null,this.displayCoordinate=new b(0,0)}initializeView(){super.initializeView();let e=u.getElement(this.parentId);if(!e){console.log("NodeConnectionView.initializeView() No parent element found! parentId="+this.parentId);return}let t=this.isConnectionVertical(),i=this.isConnectionVertical()?"connection-vertical":"connection-horizontal";this.mainElement=u.createElement("div",e,this.elementId,i),t?this.mainElement.style.height=Math.abs(this.parentNode.graphCoordinate.y-this.childNode.graphCoordinate.y)+"px":this.mainElement.style.width=Math.abs(this.parentNode.graphCoordinate.x-this.childNode.graphCoordinate.x)+"px",this.setInitialVisibility(!0),this.updatePosition()}updateViewContents(){this.updatePosition()}updatePosition(){if(this.displayCoordinate.equals(this.originNode.viewCoordinate))return;this.displayCoordinate.copy(this.originNode.viewCoordinate);let e=n.skillGraph.connectorOffsetX,t=n.skillGraph.connectorOffsetY;this.mainElement.style.left=this.originNode.viewCoordinate.x+e+"px",this.mainElement.style.top=this.originNode.viewCoordinate.y+t+"px"}isConnectionVertical(){let e=this.originNode===this.childNode?this.parentNode:this.childNode,t=this.originNode.graphCoordinate,i=e.graphCoordinate;return t.x===i.x}getTopLeftNode(){let e=this.parentNode.graphCoordinate,t=this.childNode.graphCoordinate;return e.x===t.x?e.y<t.y?this.parentNode:this.childNode:e.y===t.y?e.x<t.x?this.parentNode:this.childNode:e.x<t.x?this.parentNode:this.childNode}};var lr=class extends U{constructor(e,t){super(e,e+"_"+t.id),this.node=t,this.mainElement=null,this.titleElement=null,this.displayedTitle=null,this.descriptionElement=null,this.displayedDescription=null,this.costElement=null,this.displayedCost=new d(-10),this.displayCoordinate=new b(0,0),this.displayedPurchaseState=0}getPurchaseStateValue(e,t){return t?2:e?1:0}initializeView(){super.initializeView();let e=this.getElementId(),t=this.node.description,i=u.getElement(this.parentId);if(!i){console.log("SkillNodeView.initializeView() No parent element found! parentId="+this.parentId);return}this.mainElement=u.createElement("div",i,e,"skill-tree-button-outer-not-purchasable"),this.displayedPurchaseState=-1;let r=u.createElement("div",this.mainElement,null,"skill-tree-button-row1"),s=u.createElement("img",r,null,"icon-container");s.src=this.node.iconFileName;let o=u.createElement("div",r,null,"pick-upgrade-title-description-container");this.titleElement=u.createElement("div",o,null,null),this.titleElement.innerHTML="",this.costElement=u.createElement("div",o,null,"pick-upgrade-button-title-double-row"),this.descriptionElement=u.createElement("div",this.mainElement,null,"skill-tree-button-description"),this.descriptionElement.innerHTML=t,this.displayedDescription=t;let a=this;this.mainElement.onclick=function(){a.node.isPurchasable()&&a.node.onPurchase()},this.setInitialVisibility(!1),this.updatePosition()}updateView(){this.setViewVisible(this.node.nodeVisible),super.updateView()}updateViewContents(){this.updatePosition();let e=this.node.getCost(),t=this.node.isPurchasable(),i=this.node.purchased,r=this.getPurchaseStateValue(t,i);e.equals(this.displayedCost)||(this.displayedCost.copy(e),this.costElement.innerHTML=I.formatBigNum(e)+" Prestige");let s=this.node.getTitle();s!==this.displayedTitle&&(this.displayedTitle=s,this.titleElement.innerHTML=s);let o=this.node.getDescription();o!==this.displayedDescription&&(this.displayedDescription=o,this.descriptionElement.innerHTML=o),this.displayedPurchaseState!==r&&(this.displayedPurchaseState=r,r===0?this.mainElement.className="skill-tree-button-outer-not-purchasable":r===1?this.mainElement.className="skill-tree-button-outer":this.mainElement.className="skill-tree-button-outer-purchased")}updatePosition(){this.displayCoordinate.equals(this.node.viewCoordinate)||(this.displayCoordinate.copy(this.node.viewCoordinate),this.mainElement.style.left=this.node.viewCoordinate.x+"px",this.mainElement.style.top=this.node.viewCoordinate.y+"px")}};var va=class extends q{constructor(e,t,i){super(e,$.SKILL_TREE_GRAPH),this.skillTreeGraph=t,this.userInput=i,this.mainElement=null,this.displayCenterOffset=new b(-50,-50),this.displayedZoom=0;let r=this.skillTreeGraph.skills;for(let s=0;s<r.length;s++)this.addNodeConnectionViews(r[s].rootNode);for(let s=0;s<r.length;s++)this.addNodeAndChildViews(r[s].rootNode)}addNodeAndChildViews(e){let t=this.getElementId();this.addView(new lr(t,e));let i=e.children;if(!i)return;let r={},s=[];for(s.push(...i);s.length>0;){let o=s.shift();if(!r[o.id]&&(r[o.id]=!0,this.addView(new lr(t,o)),o.children))for(let a=0;a<o.children.length;a++){let h=o.children[a];r[h.id]||s.push(h)}}}addNodeConnectionViews(e){let t=this.getElementId(),i=[];i.push(e);let r={};for(;i.length>0;){let s=i.shift();if(r[s.id])continue;r[s.id]=!0;let o=s.children;if(o)for(let a=0;a<o.length;a++){let h=o[a];this.addView(new Ia(t,s,h)),!(r[h.id]||!h.children)&&i.push(h)}}}initializeView(){let e=u.getElement(this.parentId);this.mainElement=u.createElement("div",e,this.elementId,"skill-tree-graph"),this.setInitialVisibility(!1),this.userInput.attachListeners(document,this.mainElement),super.initializeView()}updateViewContents(){let e=!1,t=this.skillTreeGraph.zoom;this.displayedZoom!==t&&(this.mainElement.style.zoom=t+"%",this.displayedZoom=t,e=!0);let i=this.skillTreeGraph.centerOffset;this.displayCenterOffset.equals(i)||(this.displayCenterOffset.copy(i),e=!0),e&&this.updateNodeCoordinates(),super.updateViewContents()}updateNodeCoordinates(){let e=this.mainElement.clientWidth,t=this.mainElement.clientHeight,i=e/2,r=t/2,s=this.skillTreeGraph.centerOffset;for(let o=0;o<this.skillTreeGraph.skills.length;o++){let a=this.skillTreeGraph.skills[o];for(let h=0;h<a.nodes.length;h++){let m=a.nodes[h],p=i+s.x+m.graphCoordinate.x,f=r+s.y+m.graphCoordinate.y;m.viewCoordinate.set(p,f)}}}};var xa=class extends q{constructor(e,t,i){super(null,$.GAME_VIEW_CONTAINER),this.canvasView=null,this.skillTreeView=null,this.mineCanvasUserInput=t,this.skillTreeUserInput=i,this.gameStateControl=e}createChildren(e){let t=this.getElementId();this.removeChildViewElements(),u.clearChildren(t),this.canvasView=new In(t,e,this.mineCanvasUserInput),this.addView(this.canvasView),this.skillTreeView=new va(t,e.skillTreeGraph,this.skillTreeUserInput),this.addView(this.skillTreeView);let i=new aa;i.addPopupView(this.skillTreeView),this.addView(new ba(t,e,this.gameStateControl,i)),this.initializeView()}getCanvas(){return this.canvasView.getCanvas()}resetGameView(){this.removeAll()}};var Da=class{constructor(e,t,i,r){this.userInput=e,this.projection=t,this.worldGrid=i,this.panAnimation=r,this.mapPanned=!1,this.mapPannedTime=0,this.delta=new b(0,0),this.screenCoordinate=new b(0,0),this.clickWorldCoordinate=new b(0,0),this.hoverWorldCoordinate=new b(0,0)}handleInput(){this.userInput.leftMouseClick?this.handleMouseClick():(this.handlePanning(),this.handleZoomInput())}resetInputHandler(){this.userInput.resetInputState()}handleMouseClick(){this.screenCoordinate.set(this.userInput.clickX,this.userInput.clickY),this.projection.screenToWorld(this.screenCoordinate,this.clickWorldCoordinate)}handlePanning(){this.userInput.leftMouseDown?(this.delta.x=this.userInput.mouseDeltaX,this.delta.y=this.userInput.mouseDeltaY):(this.delta.x*=n.input.panning.decayFactor,this.delta.y*=n.input.panning.decayFactor,Math.abs(this.delta.x)<1&&(this.delta.x=0),Math.abs(this.delta.y)<1&&(this.delta.y=0)),this.delta.x!==0||this.delta.y!==0?(this.mapPanned=!0,this.mapPannedTime=Date.now(),this.projection.updateSpaceCenter(this.projection.screenToWorldDistance(-this.delta.x),this.projection.screenToWorldDistance(-this.delta.y)),this.projection.stayCenteredOnCharacter=!1,this.panAnimation.animating=!1):this.mapPanned=!1}handleZoomInput(){var e=this.userInput.mouseWheelMotion;e<0?this.projection.zoomIn():e>0&&this.projection.zoomOut()}};var Oa=class{constructor(e,t){this.userInput=e,this.skillTreeGraph=t,this.mapPanned=!1,this.mapPannedTime=0,this.delta=new b(0,0)}handleInput(){this.userInput.leftMouseClick||(this.handlePanning(),this.handleZoomInput())}resetInputHandler(){this.userInput.resetInputState()}handlePanning(){this.userInput.leftMouseDown?(this.delta.x=this.userInput.mouseDeltaX,this.delta.y=this.userInput.mouseDeltaY):(this.delta.x*=n.input.panning.decayFactor,this.delta.y*=n.input.panning.decayFactor,Math.abs(this.delta.x)<1&&(this.delta.x=0),Math.abs(this.delta.y)<1&&(this.delta.y=0)),this.delta.x!==0||this.delta.y!==0?(this.mapPanned=!0,this.mapPannedTime=Date.now(),this.skillTreeGraph.updateCenter(this.delta.x,this.delta.y)):this.mapPanned=!1}handleZoomInput(){var e=this.userInput.mouseWheelMotion;e<0?this.skillTreeGraph.zoomIn():e>0&&this.skillTreeGraph.zoomOut()}};var Ba=class{constructor(e,t){this.inputHandler=e,this.skillTreeInputHandler=t,this.elapsedTurnFrames=0,this.prevWorldGridShiftCount=-1,this.frameTimeRatio=1,this.turnStart=!1,this.lastSaveTime=Date.now(),this.workingGridCenter=new b(0,0),this.elapsedSaveThreshold=1e3*60*2;let i=this;this.performMonsterFrameActionsForGrid=function(r){let s=r.characters;for(let o=0;o<s.length;o++)s[o].isMonster()&&s[o].performFrameActions(i.frameTimeRatio,i.turnStart)},this.processMonsterTurnsForGrid=function(r){let s=r.characters;for(let o=0;o<s.length;o++){let a=s[o],h=a.position.tile;a.isMonster()&&h&&h.lighting.everVisibleToCharacter&&a.chooseTurn()}}}processFrameLogic(e,t){e.gameTime.frameNumber+=t,e.gameTime.frameNumber>1e10&&(e.gameTime.frameNumber=0),this.inputHandler.handleInput(),this.skillTreeInputHandler.handleInput();let i=!1;this.elapsedTurnFrames+=t,this.elapsedTurnFrames>=n.time.turnFrames&&(i=!0,this.elapsedTurnFrames-=n.time.turnFrames);let r=e.worldGrid.shiftCount;this.prevWorldGridShiftCount!==r&&(this.prevWorldGridShiftCount=r),i&&this.processTurnLogic(e),this.performCharacterActions(e,t,i),e.partyTarget.nextLayerDescription&&e.partyTarget.nextLayerDescription.minDepth<=e.runStatistics.maxDepth&&e.partyTarget.unlockNextLayer(),e.physicsManager.updatePhysicsForFrame(t),e.effectManager.updateEffectsForFrame(t),this.updateGridCenter(e,t),e.projection.updateProjectionForFrame(),e.gridLoadingManager.manageLoadedGridsForFrame(),i&&(this.updateDynamicLighting(e.lightingCalculator,e.crew,t),e.skillTreeGraph.updateSkillsForTurn()),e.skillTreeGraph.updateSkillsForFrame(t),e.sprites.spriteAnimationManager.updateForFrame(t),e.infoTextProcessor.updateTextForFrame(t);let s=Date.now();s-this.lastSaveTime>this.elapsedSaveThreshold&&(e.saveManager.saveGame(e),this.lastSaveTime=s)}updateDynamicLighting(e,t,i){le.startTime("LightingReset"),e.resetForFrame(),le.endTime("LightingReset");let r=t.miners;le.startTime("DynamicLighting");for(let s=0;s<r.length;s++){let o=r[s].position.tile;o&&(s===0?e.calculatePrimaryPositionalLighting(o):e.calculateSecondaryPositionalLighting(o))}le.endTime("DynamicLighting")}updateGridCenter(e,t){if(!e.panAnimation.animating&&!e.projection.stayCenteredOnCharacter&&Date.now()-this.inputHandler.mapPannedTime>1e3*10&&e.panAnimation.startAnimation(),e.panAnimation.animating){e.panAnimation.updateForFrame(t);return}e.projection.stayCenteredOnCharacter&&(e.crew.calculateCrewCenterCoordinate(this.workingGridCenter),e.projection.setGridCenter(this.workingGridCenter.x+n.tile.halfSize,this.workingGridCenter.y+n.tile.halfSize))}performCharacterActions(e,t,i){let r=e.crew.miners;for(let s=0;s<r.length;s++){let o=r[s];o.position.tile&&o.performFrameActions(t,i)}this.frameTimeRatio=t,this.turnStart=i,ye.allVisibleGrids(e.worldGrid,e.projection,this.performMonsterFrameActionsForGrid)}validateCrewTiles(e,t){let i=t.calculateCrewCenterTile();if(!i)return!1;let r=t.miners;for(let s=0;s<r.length;s++){let o=r[s];if(!this.validateCharacterTile(e,o)){let h=xt.findAvailableNearbyTile(o,t,i);h?(console.log("FrameLogic.validateCrewTiles() moving miner to valid grid near crew center."),o.position.setTileAndOriginPosition(h,h.origin.x,h.origin.y)):console.log("FrameLogic.validateCrewTiles() failed to move miner near crew center")}}return!0}validateCharacterTile(e,t){let i=e.findGridTile(t.position.worldCoordinateOrigin);return t.position.tile?i&&i!==t.position.tile?(t.onInvalidGrid(),t.position.setTileAndOriginPosition(i,i.origin.x,i.origin.y),!0):i?!0:(t.onInvalidGrid(),!1):i?(t.onInvalidGrid(),t.position.setTileAndOriginPosition(i,i.origin.x,i.origin.y),!0):!1}processTurnLogic(e){if(e.gameTime.turnNumber++,e.statisticsIncrementor.incrementTurns(1),!this.validateCrewTiles(e.worldGrid,e.crew)){e.vectorField.reset();return}e.automationManager.updateForTurn(),e.mineControl.updateForTurn(),e.crewBrain.updateForTurn(),ye.allVisibleGrids(e.worldGrid,e.projection,this.processMonsterTurnsForGrid)}};var ka=class{constructor(e,t,i,r){this.state=e,this.gameView=t,this.inputHandler=i,this.skillTreeInputHandler=r,this.prevTimeStamp=performance.now(),this.frameLogic=new Ba(i,r);let s=this;this.gameLoopReference=function(){s.gameLoop()},this.fpsFrameCount=0,this.fpsMillis=0,this.offlineThresholdMillis=1e3*60*30,this.gameStateControl=null,this.callbackCode=-1,this.prevFrameVisible=!1}requestGameStateCallback(e,t){this.gameStateControl=e,this.callbackCode=t}startGameLoop(){this.fpsFrameCount=0,this.fpsMillis=0,this.prevTimeStamp=performance.now(),window.requestAnimationFrame(this.gameLoopReference)}gameLoop(){le.endTime("Inactive"),le.startTime("GameLoop");let e=performance.now(),t=e-this.prevTimeStamp,i=t>0?t:this.state.currentFps>0?1e3/this.state.currentFps:1e3/60;if(this.prevTimeStamp=e,!this.state.gameVisible||!this.prevFrameVisible){let r=t/1e3|0;r>0&&(console.log("GameLoop.gameLoop() earned offline credit: "+et.formatElapsedTime(r*1e3)),this.state.totals.offlineSeconds+=r),this.state.gameVisible&&!this.prevFrameVisible&&this.state.totals.offlineSeconds>0&&this.state.offlineLogic.calculateOfflineEarnings()}if(this.prevFrameVisible=this.state.gameVisible,this.gameStateControl)this.gameStateControl.modelLoadCallback(this.callbackCode),this.gameStateControl=null,this.callbackCode=0;else if(this.state.gameVisible&&!this.state.gamePaused){let r=i/n.time.defaultMillisPerFrame;this.frameLogic.processFrameLogic(this.state,r),this.gameView.updateView()}this.inputHandler.resetInputHandler(),this.skillTreeInputHandler.resetInputHandler(),this.fpsFrameCount++,this.fpsMillis+=t,this.fpsFrameCount>=60&&(this.state.currentFps=this.fpsFrameCount/(this.fpsMillis/1e3)|0,this.fpsFrameCount=0,this.fpsMillis=0),le.endTime("GameLoop"),le.startTime("Inactive"),window.requestAnimationFrame(this.gameLoopReference)}};var Fa=class extends un{constructor(){super(),this.state=new bn(this),this.mineCanvasUserInput=new or,this.skillTreeUserInput=new or,this.gameView=new xa(this,this.mineCanvasUserInput,this.skillTreeUserInput),this.inputHandler=new Da(this.mineCanvasUserInput,this.state.projection,this.state.worldGrid,this.state.panAnimation),this.skillTreeInputHandler=new Oa(this.skillTreeUserInput,this.state.skillTreeGraph),this.gameLoop=new ka(this.state,this.gameView,this.inputHandler,this.skillTreeInputHandler),this.started=!1,this.gameInitialized=!1,this.saveStateText=null}onVisibilityChange(e){this.state.gameVisible=e}onWindowResize(e,t){let i=this.gameView.getCanvas();i&&(i.width=e,i.height=t)}saveGame(){this.state.saveManager.saveGame(this.state)}getState(){return this.state}isStarted(){return this.started}startGame(){this.started||(this.gameInitialized||this.initialize(),this.gameLoop.startGameLoop(),this.started=!0)}initialize(){if(this.gameInitialized)return;this.state.sprites.isInitialized()||console.log("GameState.initialize() ERROR The sprites have not been initialed yet.");let e=this.state.saveManager.loadSave(this.state);this.state.initializeState(e),this.gameView.createChildren(this.state),this.gameInitialized=!0}prestigeGame(){this.gameLoop.requestGameStateCallback(this,this.CALLBACK_GAME_PRESTIGE)}resetGame(){this.gameLoop.requestGameStateCallback(this,this.CALLBACK_GAME_RESET)}deleteGame(){this.gameLoop.requestGameStateCallback(this,this.CALLBACK_GAME_DELETE)}importSave(e){this.saveStateText=e,this.gameLoop.requestGameStateCallback(this,this.CALLBACK_GAME_IMPORT)}modelLoadCallback(e){e===this.CALLBACK_GAME_RESET?this.resetInternal():e===this.CALLBACK_GAME_DELETE?this.deleteInternal():e===this.CALLBACK_GAME_IMPORT?this.importInternal():e===this.CALLBACK_GAME_PRESTIGE?this.prestigeInternal():console.log("GameState.modelLoadCallback(callbackCode) Invalid callback code: "+e)}resetInternal(){let e=this.state.saveManager;e.deleteSave(),this.state.resetForPrestige(),this.gameView.resetGameView(),this.gameView.createChildren(this.state),e.saveGame(this.state)}deleteInternal(){let e=this.state.saveManager;e.deleteSave(),this.state.resetFull(),this.gameView.resetGameView(),this.gameView.createChildren(this.state),e.saveGame(this.state)}prestigeInternal(){this.state.statisticsIncrementor.incrementPrestigePoints(this.state.totals.unclaimedPrestige),this.state.totals.onPrestige(),this.resetInternal()}importInternal(){console.log("GameState.importInternal() START");let e=this.state.saveManager,t=e.getSaveStateForExport(this.state);this.state.beforeImportSave(),e.importSave(this.state,this.saveStateText)||(console.log("GameState.importInternal() IMPORT FAILED. REVERTING TO PREV SAVE"),this.state.beforeImportSave(),e.importSave(this.state,t)),this.saveStateText=null,this.state.afterImportSave(),this.gameView.resetGameView(),this.gameView.createChildren(this.state),console.log("GameState.importInternal() DONE")}};var Ga=class{constructor(){this.gameState=new Fa;let e=this;this.resourceLoadingLoop=function(){e.waitForResourcesToLoad()}}onResize(e){this.gameState.onWindowResize(e.innerWidth,e.innerHeight)}onVisibilityChange(){typeof document.hidden<"u"&&(console.log("Game.onVisibilityChange() hidden="+document.hidden),this.gameState.onVisibilityChange(!document.hidden))}onLoad(e,t){if(this.gameState.isStarted())return;console.log("Game.onLoad() Loading game.");let i=this;t.addEventListener("visibilitychange",function(r){i.onVisibilityChange()},!1),this.waitForResourcesToLoad()}onUnload(){console.log("Game.onUnload()"),this.gameState.saveGame()}waitForResourcesToLoad(){this.gameState.state.sprites.isInitialized()?(console.log("Game.waitForResourcesToLoad() Resources are loaded. Starting game."),this.gameState.startGame()):(console.log("Game.waitForResourcesToLoad() Resources not yet loaded. Waiting..."),window.requestAnimationFrame(this.resourceLoadingLoop))}};(()=>{let l=new Ga;window.onresize=function(){l.onResize(window)},window.onload=function(){l.onLoad(window,document)},window.onbeforeunload=function(){l.onUnload()}})();})();
//# sourceMappingURL=out.js.map
