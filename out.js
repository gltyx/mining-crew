(()=>{var sh=Object.create;var vl=Object.defineProperty;var oh=Object.getOwnPropertyDescriptor;var nh=Object.getOwnPropertyNames;var ah=Object.getPrototypeOf,lh=Object.prototype.hasOwnProperty;var hh=(l,e)=>()=>(e||l((e={exports:{}}).exports,e),e.exports);var dh=(l,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of nh(e))!lh.call(l,r)&&r!==t&&vl(l,r,{get:()=>e[r],enumerable:!(i=oh(e,r))||i.enumerable});return l};var Gl=(l,e,t)=>(t=l!=null?sh(ah(l)):{},dh(e||!l||!l.__esModule?vl(t,"default",{value:l,enumerable:!0}):t,l));var Ol=hh((vx,dl)=>{var Il=(function(){var l=String.fromCharCode,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",i={};function r(o,a){if(!i[o]){i[o]={};for(var h=0;h<o.length;h++)i[o][o.charAt(h)]=h}return i[o][a]}var s={compressToBase64:function(o){if(o==null)return"";var a=s._compress(o,6,function(h){return e.charAt(h)});switch(a.length%4){default:case 0:return a;case 1:return a+"===";case 2:return a+"==";case 3:return a+"="}},decompressFromBase64:function(o){return o==null?"":o==""?null:s._decompress(o.length,32,function(a){return r(e,o.charAt(a))})},compressToUTF16:function(o){return o==null?"":s._compress(o,15,function(a){return l(a+32)})+" "},decompressFromUTF16:function(o){return o==null?"":o==""?null:s._decompress(o.length,16384,function(a){return o.charCodeAt(a)-32})},compressToUint8Array:function(o){for(var a=s.compress(o),h=new Uint8Array(a.length*2),u=0,m=a.length;u<m;u++){var g=a.charCodeAt(u);h[u*2]=g>>>8,h[u*2+1]=g%256}return h},decompressFromUint8Array:function(o){if(o==null)return s.decompress(o);for(var a=new Array(o.length/2),h=0,u=a.length;h<u;h++)a[h]=o[h*2]*256+o[h*2+1];var m=[];return a.forEach(function(g){m.push(l(g))}),s.decompress(m.join(""))},compressToEncodedURIComponent:function(o){return o==null?"":s._compress(o,6,function(a){return t.charAt(a)})},decompressFromEncodedURIComponent:function(o){return o==null?"":o==""?null:(o=o.replace(/ /g,"+"),s._decompress(o.length,32,function(a){return r(t,o.charAt(a))}))},compress:function(o){return s._compress(o,16,function(a){return l(a)})},_compress:function(o,a,h){if(o==null)return"";var u,m,g={},_={},C="",w="",T="",S=2,R=3,y=2,I=[],N=0,D=0,Q;for(Q=0;Q<o.length;Q+=1)if(C=o.charAt(Q),Object.prototype.hasOwnProperty.call(g,C)||(g[C]=R++,_[C]=!0),w=T+C,Object.prototype.hasOwnProperty.call(g,w))T=w;else{if(Object.prototype.hasOwnProperty.call(_,T)){if(T.charCodeAt(0)<256){for(u=0;u<y;u++)N=N<<1,D==a-1?(D=0,I.push(h(N)),N=0):D++;for(m=T.charCodeAt(0),u=0;u<8;u++)N=N<<1|m&1,D==a-1?(D=0,I.push(h(N)),N=0):D++,m=m>>1}else{for(m=1,u=0;u<y;u++)N=N<<1|m,D==a-1?(D=0,I.push(h(N)),N=0):D++,m=0;for(m=T.charCodeAt(0),u=0;u<16;u++)N=N<<1|m&1,D==a-1?(D=0,I.push(h(N)),N=0):D++,m=m>>1}S--,S==0&&(S=Math.pow(2,y),y++),delete _[T]}else for(m=g[T],u=0;u<y;u++)N=N<<1|m&1,D==a-1?(D=0,I.push(h(N)),N=0):D++,m=m>>1;S--,S==0&&(S=Math.pow(2,y),y++),g[w]=R++,T=String(C)}if(T!==""){if(Object.prototype.hasOwnProperty.call(_,T)){if(T.charCodeAt(0)<256){for(u=0;u<y;u++)N=N<<1,D==a-1?(D=0,I.push(h(N)),N=0):D++;for(m=T.charCodeAt(0),u=0;u<8;u++)N=N<<1|m&1,D==a-1?(D=0,I.push(h(N)),N=0):D++,m=m>>1}else{for(m=1,u=0;u<y;u++)N=N<<1|m,D==a-1?(D=0,I.push(h(N)),N=0):D++,m=0;for(m=T.charCodeAt(0),u=0;u<16;u++)N=N<<1|m&1,D==a-1?(D=0,I.push(h(N)),N=0):D++,m=m>>1}S--,S==0&&(S=Math.pow(2,y),y++),delete _[T]}else for(m=g[T],u=0;u<y;u++)N=N<<1|m&1,D==a-1?(D=0,I.push(h(N)),N=0):D++,m=m>>1;S--,S==0&&(S=Math.pow(2,y),y++)}for(m=2,u=0;u<y;u++)N=N<<1|m&1,D==a-1?(D=0,I.push(h(N)),N=0):D++,m=m>>1;for(;;)if(N=N<<1,D==a-1){I.push(h(N));break}else D++;return I.join("")},decompress:function(o){return o==null?"":o==""?null:s._decompress(o.length,32768,function(a){return o.charCodeAt(a)})},_decompress:function(o,a,h){var u=[],m,g=4,_=4,C=3,w="",T=[],S,R,y,I,N,D,Q,V={val:h(0),position:a,index:1};for(S=0;S<3;S+=1)u[S]=S;for(y=0,N=Math.pow(2,2),D=1;D!=N;)I=V.val&V.position,V.position>>=1,V.position==0&&(V.position=a,V.val=h(V.index++)),y|=(I>0?1:0)*D,D<<=1;switch(m=y){case 0:for(y=0,N=Math.pow(2,8),D=1;D!=N;)I=V.val&V.position,V.position>>=1,V.position==0&&(V.position=a,V.val=h(V.index++)),y|=(I>0?1:0)*D,D<<=1;Q=l(y);break;case 1:for(y=0,N=Math.pow(2,16),D=1;D!=N;)I=V.val&V.position,V.position>>=1,V.position==0&&(V.position=a,V.val=h(V.index++)),y|=(I>0?1:0)*D,D<<=1;Q=l(y);break;case 2:return""}for(u[3]=Q,R=Q,T.push(Q);;){if(V.index>o)return"";for(y=0,N=Math.pow(2,C),D=1;D!=N;)I=V.val&V.position,V.position>>=1,V.position==0&&(V.position=a,V.val=h(V.index++)),y|=(I>0?1:0)*D,D<<=1;switch(Q=y){case 0:for(y=0,N=Math.pow(2,8),D=1;D!=N;)I=V.val&V.position,V.position>>=1,V.position==0&&(V.position=a,V.val=h(V.index++)),y|=(I>0?1:0)*D,D<<=1;u[_++]=l(y),Q=_-1,g--;break;case 1:for(y=0,N=Math.pow(2,16),D=1;D!=N;)I=V.val&V.position,V.position>>=1,V.position==0&&(V.position=a,V.val=h(V.index++)),y|=(I>0?1:0)*D,D<<=1;u[_++]=l(y),Q=_-1,g--;break;case 2:return T.join("")}if(g==0&&(g=Math.pow(2,C),C++),u[Q])w=u[Q];else if(Q===_)w=R+R.charAt(0);else return null;T.push(w),u[_++]=R+w.charAt(0),g--,R=w,g==0&&(g=Math.pow(2,C),C++)}}};return s})();typeof define=="function"&&define.amd?define(function(){return Il}):typeof dl<"u"&&dl!=null?dl.exports=Il:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return Il})});var $=class{constructor(e,t,i){this.id=e,this.spriteName=t,this.brainId=i}};var n={};n.time={defaultFramesPerSecond:60,defaultMillisPerFrame:1e3/60,turnsPerSecond:4,secondsPerTurn:.25,millisPerTurn:250,turnFrames:15};n.target={minTargetRow:5};n.damage={baseDamagePerSecond:30,baseDamagePerTurn:30*n.time.secondsPerTurn};n.tile={size:16,halfSize:8,halfSizeSquared:64,threeQuarterSize:12,quarterSize:4,eighthSize:2,doubleSize:32};n.skillGraph={cellWidth:260,cellHeight:110,connectorOffsetX:100,connectorOffsetY:40,minZoom:20,maxZoom:100,zoomStep:10,nodeViewWidth:180};n.physics={gravityRatePerFrame:4,walkRatePerFrame:2,jumpRatePerFrame:2};n.character={jumpPower:2.5*n.tile.size,maxJumpPixelsPerFrame:2,halfWidth:5};n.combat={critialHitMultiplier:1.5};n.input={panning:{decayFactor:.95}};n.projection={zoomInScaleLimit:8,zoomOutScaleLimit:1.5,zoomDefault:2,zoomStep:.25,startCenterX:0,startCenterY:0};n.text={maxInfoTextCount:7,maxDamageTextCount:4,textFrameDuration:45};n.grid={numZoneColsInGrid:3,numZoneRowsInGrid:3,numRegionColsInZone:2,numRegionRowsInZone:2,numTileColsInRegion:5,numTileRowsInRegion:5};n.grid.regionTileWidth=n.grid.numTileColsInRegion;n.grid.regionTileHeight=n.grid.numTileRowsInRegion;n.grid.zoneTileWidth=n.grid.numRegionColsInZone*n.grid.regionTileWidth;n.grid.zoneTileHeight=n.grid.numRegionRowsInZone*n.grid.regionTileHeight;n.grid.gridTileWidth=n.grid.numZoneColsInGrid*n.grid.zoneTileWidth;n.grid.gridTileHeight=n.grid.numZoneRowsInGrid*n.grid.zoneTileHeight;n.grid.regionPixelWidth=n.grid.regionTileWidth*n.tile.size;n.grid.regionPixelHeight=n.grid.regionTileHeight*n.tile.size;n.grid.zonePixelWidth=n.grid.zoneTileWidth*n.tile.size;n.grid.zonePixelHeight=n.grid.zoneTileHeight*n.tile.size;n.grid.gridPixelWidth=n.grid.gridTileWidth*n.tile.size;n.grid.gridPixelHeight=n.grid.gridTileHeight*n.tile.size;n.start={startX:2e4,startY:-100*n.tile.size};n.effect={effectTravelPixlesPerFrame:5.5,fastEffectTravelPixelsPerFrame:6.5,slowEffectTravelPixelsPerFrame:3,lightningFrames:n.time.turnFrames*2};n.lighting={lightSourceRadius:5};n.skill={};n.bonus={newBonusTurns:n.time.turnsPerSecond*900,activationTurns:n.time.turnsPerSecond*300,activationCost:1e3};n.silver={incrementBonusPerUpgrade:.001};n.ruby={incrementBonusPerUpgrade:.75};n.blocks={incrementBonusPerUpgrade:.001};n.depth={incrementBonusPerUpgrade:.002};n.minedDamage={incrementBonusPerUpgrade:.1};n.gold={damageMultiplierPerUpgrade:15,oreBonusMultiplierPerUpgrade:1};n.skill.fissure={delayMillis:2500,forkChance:75,secondForkChance:85,minBlocks:3,blocksPerUpgrade:2};n.skill.lightning={minRange:3,delayMillis:2500,forkChance:75,secondForkChance:85,minBlocks:3,blocksPerUpgrade:1,tilesPerUpgrade:1};n.skill.chain={minRange:3,minSize:3,delayMillis:2500,blocksPerUpgrade:1,tilesPerUpgrade:1};n.skill.laser={minRange:3,tilesPerUpgrade:1};n.skill.drill={minRange:3,tilesPerUpgrade:1};n.skill.missiles={initialMissiles:5,missilesPerUpgrade:3};n.skill.orbit={minRangePixels:2*n.tile.size,rangePixelsPerUpgrade:n.tile.halfSize};n.skill.bonus={oreBonusMultiplierPerUpgrade:1,minedOreBaseTiles:8,minedOreMaxExtraTiles:6};n.skill.common={damagePercentPerUpgrade:25,damagePerUpgrade:.25,baseActivationTurns:n.time.turnsPerSecond*10,baseCoolDownTurns:n.time.turnsPerSecond*60,activationSecondsPerUpgrade:1,coolDownSecondsPerUpgrade:2,activationTurnsPerUpgrade:n.time.turnsPerSecond,coolDownTurnsPerUpgrade:n.time.turnsPerSecond*2};n.automation={minDelayTurns:n.time.turnsPerSecond*1,baseUpgradeDelayTurns:n.time.turnsPerSecond*61,turnsPerRateUpgrade:n.time.turnsPerSecond*5,prestigeUpgradeDelayTurns:n.time.turnsPerSecond*3660,prestigeTurnsPerRateUpgrade:n.time.turnsPerSecond*300,secondsPerRateUpgrade:5,minutesPerPrestigeRateUpgrade:5};n.offline={defaultOfflineMinutes:30,defaultOfflineTurns:1800*n.time.turnsPerSecond,minutesPerUpgrade:30,turnsPerUpgrade:30*(60*n.time.turnsPerSecond)};var Gt=class{constructor(e,t){this.spriteX=e,this.spriteY=t}getImage(){}getSize(){return n.tile.size}};var qe=class{constructor(){this.finishedAndAvailable=!0,this.listener=null}isFinishedAndAvailable(){return this.finishedAndAvailable}reset(e){this.finishedAndAvailable!=e&&this.listener&&this.listener.onAvailabilityChanged(e),this.finishedAndAvailable=e}setCycleCacheListener(e){this.listener=e}};var H={STAND:"STAND",WALK:"WALK",JUMP:"JUMP",FALL:"FALL",MINE:"MINE"};var P=class l{constructor(e,t){this.x=e,this.y=t}set(e,t){this.x=e,this.y=t}copy(e){this.x=e.x,this.y=e.y}clone(){return new l(this.x,this.y)}add(e){this.x+=e.x,this.y+=e.y}addXY(e,t){this.x+=e,this.y+=t}subtract(e){this.x-=e.x,this.y-=e.y}subtractXY(e,t){this.x-=e,this.y-=t}scale(e){this.x*=e,this.y*=e}distance(e){let t=e.x-this.x,i=e.y-this.y;return Math.sqrt(t*t+i*i)}distanceSquared(e){let t=e.x-this.x,i=e.y-this.y;return t*t+i*i}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}equals(e){return e&&this.x===e.x&&this.y===e.y}toString(){return"("+this.x+", "+this.y+")"}hash(){let e=23;return e=e*31+this.x,e=e*31+this.y,e}};var Je=class{constructor(e){this.origin=e}getOrigin(){return this.origin}getPixelWidth(){return 0}getPixelHeight(){return 0}getOriginTileCol(){return this.origin.x/n.tile.size}getOriginTileRow(){return this.origin.y/n.tile.size}contains(e){return e.x>=this.origin.x&&e.x<this.origin.x+this.getPixelWidth()&&e.y>=this.origin.y&&e.y<this.origin.y+this.getPixelHeight()}containsXY(e,t){return e>=this.origin.x&&e<this.origin.x+this.getPixelWidth()&&t>=this.origin.y&&t<this.origin.y+this.getPixelHeight()}intersects(e,t,i){return!(e+i<this.origin.x||e-i>this.origin.x+this.getPixelWidth()||t+i<this.origin.y||t-i>this.origin.y+this.getPixelHeight())}};var gi=class{constructor(e,t){this.m=e,this.e=t}set(e,t){return this.m=e,this.e=t,this}setZero(){return this.m=0,this.e=0,this}copy(e){return typeof e=="number"&&(console.log("ManExp.copy() passed number instead of ManExp"),console.trace()),this.m=e.m,this.e=e.e,this}lessThan(e){return typeof e=="number"&&(console.log("ManExp.lessThan() passed number instead of ManExp"),console.trace()),this.m===0?e.m>0:e.m===0?this.m<=0:this.e===e.e?this.m<e.m:this.m>0?e.m>0&&this.e<e.e:e.m>0||this.e>e.e}lessThanEquals(e){return!this.greaterThan(e)}greaterThan(e){return typeof e=="number"&&(console.log("ManExp.greaterThan() passed number instead of ManExp"),console.trace()),this.m===0?e.m<0:e.m===0?this.m>0:this.e===e.e?this.m>e.m:this.m>0?e.m<0||this.e>e.e:e.m<0&&this.e<e.e}greaterThanEquals(e){return!this.lessThan(e)}compare(e){if(typeof e=="number"&&(console.log("ManExp.compare() passed number instead of ManExp"),console.trace()),this.m===0){if(e.m===0)return 0;if(e.m<0)return 1;if(e.m>0)return-1}if(e.m===0){if(this.m<0)return-1;if(this.m>0)return 1}if(this.m>0)return e.m<0||this.e>e.e?1:this.e<e.e?-1:this.m>e.m?1:this.m<e.m?-1:0;if(this.m<0)return e.m>0||this.e>e.e?-1:this.e<e.e||this.m>e.m?1:this.m<e.m?-1:0}equals(e){return this.e===e.e&&this.m===e.m}equalsZero(){return this.e===0&&this.m===0}};var kt=17,Mt=9e15,Ml=308,fi=-324,uh=1e-10,kl=[];for(let l=fi+1;l<=Ml;l++)kl.push(+("1e"+l));var W=class l{constructor(){}static powerOf10(e){return kl[e+323]}static fromNumber(e,t){return isNaN(t)?(e.m=Number.NaN,e.e=Number.NaN):t===Number.POSITIVE_INFINITY?(e.m=1,e.e=Mt):t===Number.NEGATIVE_INFINITY?(e.m=-1,e.e=Mt):t===0?(e.m=0,e.e=0):(e.e=Math.floor(Math.log10(Math.abs(t))),e.m=e.e===fi?t*10/1e-323:t/l.powerOf10(e.e),l.normalize(e)),e}static negate(e){return typeof value=="number"&&(console.log("BigNumMath.negate() passed number instead of BigNum"),console.trace()),e.m=-e.m,e}static copy(e,t){return typeof t=="number"&&(console.log("BigNumMath.copy() passed number instead of BigNum"),console.trace()),e.m=t.m,e.e=t.e,e}static normalize(e){if(e.m>=1&&e.m<10)return e;if(e.m===0)return e.m=0,e.e=0,e;let t=Math.floor(Math.log10(Math.abs(e.m)));return e.m=t===fi?e.m*10/1e-323:e.m/l.powerOf10(t),e.e+=t,e}static multiply(e,t){return typeof t=="number"&&(console.log("BigNumMath.multiply() passed number instead of BigNum"),console.trace()),e.m*=t.m,e.e+=t.e,l.normalize(e)}static add(e,t){if(typeof t=="number"&&(console.log("BigNumMath.add() passed number instead of BigNum"),console.trace()),e.m===0)return e.m=t.m,e.e=t.e,e;if(t.m===0)return e;let i,r,s,o;if(e.e>=t.e?(i=e.m,r=e.e,s=t.m,o=t.e):(i=t.m,r=t.e,s=e.m,o=e.e),r-o>kt)return e.m=i,e.e=r,e;let a=Math.round(1e14*i+1e14*s*l.powerOf10(o-r));return e.m=a,e.e=r-14,l.normalize(e)}static log10(e){return typeof e=="number"&&(console.log("BigNumMath.log10() passed number instead of BigNum"),console.trace()),e.e+Math.log10(e.m)}static log2(e){return 3.321928094887362*l.log10(e)}static ln(e){return 2.302585092994045*l.log10(e)}static log(e,t){return Math.LN10/Math.log(t)*l.log10(e)}static pow10(e,t){return Number.isInteger(t)?(e.set(1,t),e):(e.set(Math.pow(10,t%1),Math.trunc(t)),l.normalize(e))}static pow(e,t){let i=t,r=e.e*i,s;if(Number.isSafeInteger(r)&&(s=Math.pow(e.m,i),isFinite(s)&&s!==0))return e.m=s,e.e=r,l.normalize(e);let o=Math.trunc(r),a=r-o;return s=Math.pow(10,i*Math.log10(e.m)+a),isFinite(s)&&s!==0?(e.m=s,e.e=o,l.normalize(e)):(l.pow10(e,i*l.absLog10(e)),l.sign(e)===-1?Math.abs(i%2)===1?l.negate(e):(Math.abs(i%2)===0||(e.m=Number.NaN,e.e=Number.NaN),e):e)}static toString(e){return typeof e=="number"&&(console.log("BigNumMath.toString() passed number instead of BigNum"),console.trace()),isNaN(e.m)||isNaN(e.e)?"NaN":e.e>=Mt?e.m>0?"Infinity":"-Infinity":e.e<=-Mt||e.m===0?"0":e.e<21&&e.e>-7?l.toNumber(e).toString():e.m+"e"+(e.e>=0?"+":"")+e.e}static toNumber(e){if(typeof e=="number"&&(console.log("BigNumMath.toNumber() passed number instead of BigNum"),console.trace()),!isFinite(e.e))return Number.NaN;if(e.e>Ml)return e.m>0?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY;if(e.e<fi)return 0;if(e.e===fi)return e.m>0?5e-324:-5e-324;let t=e.m*l.powerOf10(e.e);if(!isFinite(t)||e.e<0)return t;let i=Math.round(t);return Math.abs(i-t)<uh?i:t}static toExponential(e,t){if(typeof e=="number"&&(console.log("BigNumMath.toExponential() passed number instead of BigNum"),console.trace()),isNaN(e.m)||isNaN(e.e))return"NaN";if(e.e>=Mt)return e.m>0?"Infinity":"-Infinity";if(e.e<=-Mt||e.m===0)return"0"+(t>0?l.padEnd(".",t+1,"0"):"")+"e+0";if(e.e>fi&&e.e<Ml)return l.toNumber(e).toExponential(t);isFinite(t)||(t=kt);let i=t+1,r=Math.max(1,Math.ceil(Math.log10(Math.abs(e.m))));return(Math.round(e.m*Math.pow(10,i-r))*Math.pow(10,r-i)).toFixed(Math.max(i-r,0))+"e"+(e.e>=0?"+":"")+e.e}static toFixed(e,t){return typeof e=="number"&&(console.log("BigNumMath.toFixed() passed number instead of BigNum"),console.trace()),isNaN(e.m)||isNaN(e.e)?"NaN":e.e>=Mt?e.m>0?"Infinity":"-Infinity":e.e<=-Mt||e.m===0?"0"+(t>0?l.padEnd(".",t+1,"0"):""):e.e>=kt?e.m.toString().replace(".","").padEnd(e.e+1,"0")+(t>0?l.padEnd(".",t+1,"0"):""):l.toNumber(e).toFixed(t)}static toPrecision(e,t){return typeof e=="number"&&(console.log("BigNumMath.toPrecision() passed number instead of BigNum"),console.trace()),e.e<=-7?l.toExponential(e,t-1):t>e.e?l.toFixed(e,t-e.e-1):l.toExponential(e,t-1)}static valueOf(e){return l.toString(e)}static toJSON(e){return l.toString(e)}static toStringWithDecimalPlaces(e,t){return l.toExponential(e,t)}static abs(e){return typeof value=="number"&&(console.log("BigNumMath.abs() passed number instead of BigNum"),console.trace()),e.m=Math.abs(e.m),e}static sign(e){return typeof e=="number"&&(console.log("BigNumMath.sign() passed number instead of BigNum"),console.trace()),Math.sign(e.m)}static round(e){return e.e<-1?e.setZero():e.e<kt?l.fromNumber(e,Math.round(l.toNumber(e))):e}static floor(e){return e.e<-1?Math.sign(e.m)>=0?e.setZero():l.fromNumber(e,-1):e.e<kt?l.fromNumber(e,Math.floor(l.toNumber(e))):e}static ceil(e){return e.e<-1?Math.sign(e.m)>0?l.fromNumber(e,1):e.setZero():e.e<kt?l.fromNumber(e,Math.ceil(l.toNumber(e))):e}static trunc(e){return e.e<0?e.setZero():e.e<kt?l.fromNumber(e,Math.trunc(l.toNumber(e))):e}static recip(e){return e.m=1/e.m,e.e=-e.e,l.normalize(e)}static absLog10(e){return e.e+Math.log10(Math.abs(e.m))}static padEnd(e,t,i){if(e==null||t==null)return e;let r=String(e),s=typeof t=="number"?t:parseInt(t,10);if(isNaN(s)||!isFinite(s))return r;let o=r.length;if(o>=s)return r;let a=i==null?"":String(i);a===""&&(a=" ");let h=s-o;for(;a.length<h;)a+=a;let u=a.length>h?a.substr(0,h):a;return r+u}};var Z=new gi(0,0),c=class l extends gi{constructor(e){super(0,0),this.setValue(e)}setValue(e){return W.fromNumber(this,e),this}multiplyNumber(e){return e instanceof l&&(console.log("BigNum.multiplyNumber() passed BigNum instead of number"),console.trace()),W.fromNumber(Z,e),W.multiply(this,Z)}mulNumber(e){return this.multiplyNumber(e)}multiply(e){return W.multiply(this,e)}mul(e){return this.multiply(e)}addNumber(e){return e instanceof l&&(console.log("BigNum.addNumber() passed BigNum instead of number"),console.trace()),W.fromNumber(Z,e),W.add(this,Z)}add(e){return W.add(this,e)}subNumber(e){return e instanceof l&&(console.log("BigNum.subNumber() passed BigNum instead of number"),console.trace()),W.fromNumber(Z,-e),W.add(this,Z)}subtractNumber(e){return this.subNumber(e)}sub(e){return W.copy(Z,e),W.negate(Z),W.add(this,Z)}subtract(e){return this.sub(e)}recip(){return W.recip(this)}divideNumber(e){return e instanceof l&&(console.log("BigNum.divideNumber() passed BigNum instead of number"),console.trace()),W.fromNumber(Z,e),W.recip(Z),W.multiply(this,Z)}divNumber(e){return this.divideNumber(e)}divide(e){return W.copy(Z,e),W.recip(Z),W.multiply(this,Z)}div(e){return this.divide(e)}round(){return W.round(this)}floor(){return W.floor(this)}ceil(){return W.ceil(this)}trunc(){return W.trunc(this)}abs(){return W.abs(this)}log10(){return W.log10(this)}log2(){return W.log2(this)}ln(){return W.ln(this)}log(e){return W.log(this,e)}pow(e){return W.pow(this,e)}toString(){return W.toString(this)}toDebugString(){return this.toString()+", (m="+this.m+", e="+this.e+")"}toNumber(){return W.toNumber(this)}toExponential(e){return W.toExponential(this,e)}toFixed(e){return W.toFixed(this,e)}toPrecision(e){return W.toPrecision(this,e)}valueOf(){return W.valueOf(this)}toJSON(){return W.toJSON(this)}toStringWithDecimalPlaces(e){return W.toStringWithDecimalPlaces(this,e)}sign(){return W.sign(this)}equalsNumber(e){return e instanceof l&&(console.log("BigNum.equalsNumber() passed BigNum instead of number"),console.trace()),W.fromNumber(Z,e),this.equals(Z)}lessThanNumber(e){return e instanceof l&&(console.log("BigNum.lessThanNumber() passed BigNum instead of number"),console.trace()),W.fromNumber(Z,e),this.lessThan(Z)}lessThanZero(){return Z.setZero(),this.lessThan(Z)}lessThanEqualsZero(){return Z.setZero(),!this.greaterThan(Z)}lessThanEqualsNumber(e){return e instanceof l&&(console.log("BigNum.lessThanEqualsNumber() passed BigNum instead of number"),console.trace()),W.fromNumber(Z,e),this.lessThanEquals(Z)}greaterThanNumber(e){return e instanceof l&&(console.log("BigNum.greaterThanNumber() passed BigNum instead of number"),console.trace()),W.fromNumber(Z,e),this.greaterThan(Z)}greaterThanEqualsNumber(e){return e instanceof l&&(console.log("BigNum.greaterThanEqualsNumber() passed BigNum instead of number"),console.trace()),W.fromNumber(Z,e),!this.lessThan(Z)}equalsZero(){return Z.setZero(),this.equals(Z)}greaterThanZero(){return Z.setZero(),this.greaterThan(Z)}greaterThanEqualsZero(){return Z.setZero(),!this.lessThan(Z)}};var sr=class{constructor(){this.working=new c(0),this.hundredThousand=new c(1e5),this.noDecimalPlacesOptions={maximumFractionDigits:0}}formatNumber(e){return e<1e5?this.formatSmallNumber(e):(W.fromNumber(this.working,e),this.bigNumToGameString(this.working))}formatBigNum(e){return e.lessThan(this.hundredThousand)?this.formatSmallNumber(e.toNumber()):this.bigNumToGameString(e)}formatSmallNumber(e){return e<1e3?Number.isInteger(e)?e.toFixed(0):e<10?e<.1?e.toFixed(3):e.toFixed(2):e<100?e.toFixed(2):e.toFixed(1):e.toLocaleString(void 0,this.noDecimalPlacesOptions)}bigNumToGameString(e){return typeof e=="number"&&(console.log("BigNumMath.toGameString() passed number instead of BigNum"),console.trace()),isNaN(e.m)||isNaN(e.e)?"NaN":e.e<10?e.m.toFixed(3)+"E"+e.e:e.e<100?e.m.toFixed(2)+"E"+e.e:e.m.toFixed(1)+"E"+e.e}};var Fl=new sr,L=class{constructor(){}static formatBigNum(e){return typeof e=="number"&&(console.log("NumberFormatter.formatBigNum() passed number instead of BigNum"),console.trace()),e?Fl.formatBigNum(e):"0"}static formatNumber(e){return e instanceof c&&(console.log("NumberFormatter.formatNumber() passed BigNum instead of number"),console.trace()),Fl.formatNumber(e)}};var f={UNSET:0,COMMON:1,ORE:2,GOLD:3,UPGRADE:4,RUBY:5,SILVER:6};var or=new c(0),Rt=class{constructor(e,t){this.primaryTileType=e,this.id=e.id,this.name=e.name,this.nominalIndex=t,this.iconFileName=e.iconFileName,this.minDepth=0,this.maxDepth=0,this.oreStep=new c(0),this.baseOre=new c(0),this.healthStep=new c(0),this.baseHealth=new c(0),this.baseGold=null,this.silver=new c(0),this.multiplicativeBonusFactor=0,this.maxHealth=new c(0),this.oreTileType=dr(e),this.goldTileType=nr(e),this.upgradeTileType=lr(e),this.rubyTileType=ar(e),this.silverTileType=hr(e),this.prevLayer=null,this.nextLayer=null,this.monsterDescriptions=[],e.layerDescription&&console.log("LayerDescription ERROR: primary tile type already has a layer desc. Tile Reuse? layer: "+this.id+" tileType="+e.id),e.layerDescription=this,this.oreTileType&&(this.oreTileType.layerDescription&&console.log("LayerDescription ERROR: ore tile type already has a layer desc. Tile Reuse? layer: "+this.id+" tileType="+this.oreTileType.id),this.oreTileType.rarityModifier!==f.ORE&&console.log("LayerDescription ERROR layer="+this.name+": ORE tile type with rarity: "+this.oreTileType.rarityModifier),this.oreTileType.layerDescription=this),this.goldTileType&&(this.goldTileType.layerDescription&&console.log("LayerDescription ERROR: GOLD tile type already has a layer desc. Tile Reuse? layer: "+this.id+" tileType="+this.goldTileType.id),this.goldTileType.rarityModifier!==f.GOLD&&console.log("LayerDescription ERROR layer="+this.name+": GOLD tile type with rarity: "+this.goldTileType.rarityModifier),this.goldTileType.layerDescription=this),this.upgradeTileType&&(this.upgradeTileType.layerDescription&&console.log("LayerDescription ERROR: upgrade tile type already has a layer desc. Tile Reuse? "+this.id+" tileType="+this.upgradeTileType.id),this.upgradeTileType.rarityModifier!==f.UPGRADE&&console.log("LayerDescription ERROR layer="+this.name+": UPGRADE tile type with rarity: "+this.upgradeTileType.rarityModifier),this.upgradeTileType.layerDescription=this),this.rubyTileType&&(this.rubyTileType.layerDescription&&console.log("LayerDescription ERROR: RUBY tile type already has a layer desc. Tile Reuse? "+this.id+" tileType="+this.rubyTileType.id),this.rubyTileType.rarityModifier!==f.RUBY&&console.log("LayerDescription ERROR layer="+this.name+": RUBY tile type with rarity: "+this.rubyTileType.rarityModifier),this.rubyTileType.layerDescription=this),this.silverTileType&&(this.silverTileType.layerDescription&&console.log("LayerDescription ERROR: SILVER tile type already has a layer desc. Tile Reuse? "+this.id+" tileType="+this.silverTileType.id),this.silverTileType.rarityModifier!==f.SILVER&&console.log("LayerDescription ERROR layer="+this.name+": SILVER tile type with rarity: "+this.silverTileType.rarityModifier),this.silverTileType.layerDescription=this)}isDeeperThan(e){return this.minDepth>e.minDepth}getDepthPercent(e){if(e<=this.minDepth)return 0;if(e>=this.maxDepth)return 100;let t=e-this.minDepth,i=this.maxDepth-this.minDepth;return t/i*100}initializeLayerValues(e,t,i,r,s){this.oreStep.copy(i),this.healthStep.copy(r),this.silver.copy(s),this.baseGold=new c(e),this.multiplicativeBonusFactor=t}initializeLayer(e,t,i){if(this.prevLayer=e,this.prevLayer&&(this.prevLayer.nextLayer=this),this.minDepth=e.maxDepth,t===-1?this.maxDepth=this.minDepth+1e9:this.maxDepth=this.minDepth+t,i)this.baseHealth.copy(this.healthStep),this.baseOre.copy(this.oreStep);else if(e){let r=e.maxDepth-e.minDepth;this.baseHealth.setValue(r),this.baseHealth.mul(e.healthStep),this.baseHealth.add(e.baseHealth),this.baseHealth.add(this.healthStep),this.baseOre.setValue(r),this.baseOre.mul(e.oreStep),this.baseOre.add(e.baseOre),this.baseOre.add(this.oreStep)}else console.log("LayerDescription.initializeLayer() REACHED UNEXPECTED BLOCK. name="+this.name),this.baseHealth.setValue(1),this.baseOre.setValue(1);this.calculateTileHealth(this.maxDepth,this.maxHealth),console.log("Layer: "+this.name+" minDepth="+this.minDepth+" maxDepth="+this.maxDepth+" baseHealth="+L.formatBigNum(this.baseHealth)+" maxHealth="+L.formatBigNum(this.maxHealth)+" baseOre="+L.formatBigNum(this.baseOre))}calculateTileOre(e,t){let i=Math.max(1,e)-this.minDepth;i<=0?t.copy(this.baseOre):(t.copy(this.oreStep),t.mulNumber(i),t.add(this.baseOre))}calculateTileHealth(e,t){let i=Math.max(1,e)-this.minDepth;i<=0?t.copy(this.baseHealth):(t.copy(this.healthStep),t.mulNumber(i),t.add(this.baseHealth))}calculateTileDepth(e){return e.lessThanEquals(this.baseHealth)?this.minDepth:e.greaterThanEquals(this.maxHealth)?this.maxDepth:(or.copy(e),or.sub(this.baseHealth),or.div(this.healthStep),or.addNumber(this.minDepth),Math.max(0,or.toNumber()|0))}containsRow(e){return this.maxDepth<=e&&this.maxDepth>e}};var ve=class{constructor(e,t){this.fileName=e,this.loaded=!1,this.spriteSize=t;let i=this;this.image=new Image,this.image.onload=function(){i.populateSpriteMap()}}loadImage(){this.image.src=this.fileName}populateSpriteMap(){}};var ur=class{constructor(){this.defaultFrameIncrement=0,this.defaultElapsedFrameCount=0,this.defaultAnimationFramesPerFrame=30,this.defaultMillisPerFrame=150,this.slowMillisPerFrame=250,this.fastMillisPerFrame=80,this.superFastMillisPerFrame=30}updateForFrame(e){this.defaultElapsedFrameCount+=e,this.defaultElapsedFrameCount>=this.defaultAnimationFramesPerFrame&&(this.defaultFrameIncrement++,this.defaultElapsedFrameCount=0,this.defaultFrameIncrement>=5e4&&(this.defaultFrameIncrement=0))}getDefaultFrameIndex(e){return this.defaultFrameIncrement%e|0}getFrameIndex(e,t,i,r){return this.getFrameIndexInternal(e,t,i,r,this.defaultMillisPerFrame)}getFastFrameIndex(e,t,i,r){return this.getFrameIndexInternal(e,t,i,r,this.fastMillisPerFrame)}getSlowFrameIndex(e,t,i,r){return this.getFrameIndexInternal(e,t,i,r,this.slowMillisPerFrame)}getSuperFastFrameIndex(e,t,i,r){return this.getFrameIndexInternal(e,t,i,r,this.superFastMillisPerFrame)}getFrameIndexInternal(e,t,i,r,s){let o=this.calculateElapsedFrameCount(e,t,s);return r?o%i|0:o<i?o:-1}calculateElapsedFrameCount(e,t,i){return Math.max(0,e-t)/i|0}isDefaultAnimationLoopCompleted(e,t,i){return this.calculateElapsedFrameCount(e,t,this.defaultMillisPerFrame)>=i}isFastAnimationLoopCompleted(e,t,i){return this.calculateElapsedFrameCount(e,t,this.fastMillisPerFrame)>=i}isSuperFastAnimationLoopCompleted(e,t,i){return this.calculateElapsedFrameCount(e,t,this.superFastMillisPerFrame)>=i}};var Qe=class{constructor(e,t,i,r){this.sprites=e,this.spriteAnimationManager=t,this.fastAnimation=i,this.loopingAnimation=r}getSpriteAsOf(e,t){return this.sprites.length===1?this.sprites[0]:this.fastAnimation?this.getFastCurrentSpriteAsOf(e,t):this.getCurrentSpriteAsOf(e,t)}getSpriteAtIndex(e){return e<0||e>=this.sprites.length?null:this.sprites[e]}getCurrentSpriteDefault(){let e=this.spriteAnimationManager.getDefaultFrameIndex(this.sprites.length);return this.sprites[e]}getCurrentSpriteAsOf(e,t){let i=this.spriteAnimationManager.getFrameIndex(e,t,this.sprites.length,this.loopingAnimation);return i<0?null:this.sprites[i]}getCurrentSpriteAsOfNoLooping(e,t){let i=this.spriteAnimationManager.getFrameIndex(e,t,this.sprites.length,!1);return i<0?null:this.sprites[i]}getSlowCurrentSpriteAsOfNoLooping(e,t){let i=this.spriteAnimationManager.getSlowFrameIndex(e,t,this.sprites.length,!1);return i<0?null:this.sprites[i]}getFastCurrentSpriteAsOf(e,t){let i=this.spriteAnimationManager.getFastFrameIndex(e,t,this.sprites.length,this.loopingAnimation);return i<0?null:this.sprites[i]}getSuperFastCurrentSpriteAsOf(e,t){let i=this.spriteAnimationManager.getSuperFastFrameIndex(e,t,this.sprites.length,this.loopingAnimation);return i<0?null:this.sprites[i]}isAnimationLoopCompleted(e){return this.fastAnimation?this.spriteAnimationManager.isFastAnimationLoopCompleted(Date.now(),e,this.sprites.length):this.spriteAnimationManager.isDefaultAnimationLoopCompleted(Date.now(),e,this.sprites.length)}getDirectionSprite(e){return this.sprites[e]}isDirectionalSprite(){return!1}};var te=class extends Gt{constructor(e,t,i){super(t,i),this.spritesheet=e}getImage(){return this.spritesheet.image}getSize(){return this.spritesheet.spriteSize}};var ht=class extends ve{constructor(e,t){super(e,t),this.step=this.calculateSpriteStep(t)}calculateSpriteStep(e){}parseRow(e,t){let i=[],r=e*this.step,s=0;for(let o=0;o<t;o++)i.push(new te(this,s,r)),s+=this.step;return i}};var cr=class extends ht{constructor(e,t,i){super(e,t),this.spriteAnimationManager=i,this.defaultAnimation=null,this.spriteAnimationMap={},this.loadImage()}getSpriteAnimation(e){let t=this.spriteAnimationMap[e];return t||this.defaultAnimation}calculateSpriteStep(e){return e+1}populateSpriteMap(){let e=0;this.defaultAnimation=this.populateSpriteAnimation(e++,1,!1,!0),this.spriteAnimationManager[H.STAND]=this.defaultAnimation,this.spriteAnimationManager[H.FALL]=this.defaultAnimation,this.spriteAnimationManager[H.MINE]=this.defaultAnimation,this.spriteAnimationManager[H.JUMP]=this.populateSpriteAnimation(e++,1,!1,!0),this.spriteAnimationManager[H.WALK]=this.populateSpriteAnimation(e++,2,!1,!0),this.loaded=!0}populateSpriteAnimation(e,t,i,r){let s=this.parseRow(e,t);return new Qe(s,this.spriteAnimationManager,i,r)}};var mr=class extends ve{constructor(e,t){super(e,t),this.goldRow=0,this.oreRow=1,this.rubyRow=2,this.upgradeRow=3,this.silverRow=4,this.loadImage()}populateSpriteMap(){let e=5;this.loadTileType(X.SKY,e),e++,this.loadTileTypePlusSpecial(X.GRASS,e),e++,this.loadTileTypePlusSpecial(X.DIRT,e),e++;for(let t=0;t<Ge.length;t++)this.loadTileTypePlusSpecial(Ge[t],e),e++;this.loaded=!0}loadTileTypePlusSpecial(e,t){this.loadTileType(e,t),this.loadTileType(nr(e),this.goldRow),this.loadTileType(dr(e),this.oreRow),this.loadTileType(lr(e),this.upgradeRow),this.loadTileType(ar(e),this.rubyRow),this.loadTileType(hr(e),this.silverRow)}loadTileType(e,t){let i=(this.spriteSize+1)*16,r=0,s=i,o=2*i;e.tileTemplate=this.parseTileTemplate(r,t),e.tileTemplate2=this.parseTileTemplate(s,t),e.tileTemplate3=this.parseTileTemplate(o,t)}parseTileTemplate(e,t){let i=this.spriteSize+1,r=t*i,s=new pr;return s.northBorder=new te(this,e,r),e+=i,s.eastBorder=new te(this,e,r),e+=i,s.southBorder=new te(this,e,r),e+=i,s.westBorder=new te(this,e,r),e+=i,s.northEastBorder=new te(this,e,r),e+=i,s.northSouthBorder=new te(this,e,r),e+=i,s.northWestBorder=new te(this,e,r),e+=i,s.southEastBorder=new te(this,e,r),e+=i,s.eastWestBorder=new te(this,e,r),e+=i,s.southWestBorder=new te(this,e,r),e+=i,s.northEastSouthBorder=new te(this,e,r),e+=i,s.northSouthWestBorder=new te(this,e,r),e+=i,s.northEastWestBorder=new te(this,e,r),e+=i,s.eastWestSouthBorder=new te(this,e,r),e+=i,s.northEastSouthWestBorder=new te(this,e,r),e+=i,s.noBorder=new te(this,e,r),s}};var gr=class{constructor(){this.sprites=[]}};var fr=class extends ve{constructor(e,t){super(e,t),this.loadImage()}populateSpriteMap(){let e=5;this.loadTileType(X.SKY,e),e++,this.loadTileType(X.GRASS,e),e++,this.loadTileType(X.DIRT,e),e++;for(let t=0;t<Ge.length;t++)this.loadTileType(Ge[t],e),e++;this.loaded=!0}loadTileType(e,t){e.tileTypeBackground=this.parseRow(t)}parseRow(e){let t=this.spriteSize+1,i=48,r=e*t,s=0,o=new gr;for(let a=0;a<i;a++)o.sprites.push(new te(this,s,r)),s+=t;return o}};var se={thruster:{icon:"",staticOverlay:"",activeOverlay:"thruster"},pick:{icon:"",staticOverlay:"pick_s",activeOverlay:"pick_a"},club:{icon:"",staticOverlay:"club_s",activeOverlay:"club_a"},axe:{icon:"",staticOverlay:"axe_s",activeOverlay:"axe_a"},broadSword:{icon:"",staticOverlay:"broad_sword_s",activeOverlay:"broad_sword_a"},mace:{icon:"",staticOverlay:"mace_s",activeOverlay:"mace_a"},twoHandedAxe:{icon:"",staticOverlay:"two_handed_axe_s",activeOverlay:"two_handed_axe_a"},twoHandedClub:{icon:"",staticOverlay:"two_handed_club_s",activeOverlay:"two_handed_club_a"},darkSword:{icon:"",staticOverlay:"dark_sword_s",activeOverlay:"dark_sword_a"},redSword:{icon:"",staticOverlay:"red_sword_s",activeOverlay:"red_sword_a"}};var Tr=class extends ht{constructor(e,t,i){super(e,t),this.spriteAnimationManager=i,this.spriteAnimationMap={},this.loadImage()}getSpriteAnimation(e){return this.spriteAnimationMap[e]}calculateSpriteStep(e){return e}populateSpriteMap(){let e=0;this.populateSpriteAnimation(se.thruster.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(se.pick.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(se.pick.activeOverlay,e,4,!0,!0),e++,this.populateSpriteAnimation(se.club.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(se.club.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(se.axe.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(se.axe.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(se.broadSword.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(se.broadSword.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(se.mace.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(se.mace.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(se.twoHandedAxe.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(se.twoHandedAxe.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(se.twoHandedClub.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(se.twoHandedClub.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(se.darkSword.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(se.darkSword.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(se.redSword.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(se.redSword.activeOverlay,e,5,!0,!0),this.loaded=!0}populateSpriteAnimation(e,t,i,r,s){let o=new Qe(this.parseRow(t,i),this.spriteAnimationManager,r,s);this.spriteAnimationMap[e]=o}};var Rl={GREEN_DARK_GREEN1_DARK_GREEN2:"A0",DARK_BROWN1_GREY_ORANGE_BROWN:"A1",LIGHT_BROWN2_BROWN3_YELLOW_BROWN:"A2",LIGHT_YELLOW_YELLOW_ORANGE_YELLOW:"A3",LIGHT_PINK_DARK_PURPLE_YELLOW:"A4",GRAY_DARK_GRAY_LIGHTER_GRAY:"A5",BLUE_DARK_BLUE_LIGHT_GRAY:"A6",LIGHT_GRAY_BLUE_DARK_BLUE:"A7",ORANGE_ORANGE_YELLOW_DARK_ORANGE:"A8",BLUE_DARK_BLUE_PURPLE:"A9",BLUE_ORANGE_YELLOW_PURPLE:"B0",TEAL_LIGHT_BLUE1_PALE_AQUA:"B1",DARK_BROWN_RED_DARK_RED_RED:"B2",DARK_GRAY_ORANGE_RED_BLUE:"B3",DARK_GRAY_LIGHT_PURPLE1_TAN_GREEN:"B4",TAN_GREEN_DARK_GRAY_LIGHT_PURPLE1:"B5",SKY_BLUE_PALE_BLUE_LIGHT_BLUE2:"B6",LIGHT_BROWN2_REDDISH_BROWN_ORANGE_BROWN:"B7",ORANGE_BROWN_REDDISH_BROWN_LIGHT_BROWN2:"B8",DARKER_PURPLE_LIGHT_PURPLE2_LIGHT_YELLOW:"B9",ORANGE_YELLOW_ORANGE_BROWN_LIGHT_BROWN2:"C0",DARK_GRAY_LIGHT_PURPLE1_GREEN_BLUE:"C1",BLUE_ORANGE_YELLOW_DARK_GRAY:"C2",SKY_BLUE_BLUE_LIGHT_GREEN:"C3",VERY_DARK_GREEN_TAN_WHITE_YELLOW:"C4",BROWNISH_GREEN_DARK_RED_SUPER_DARK_GREEN:"C5",YELLOW_ORANGE_DARK_GREEN2:"C6",LIGHT_PURPLE2_DARKER_PURPLE_LIGHT_YELLOW:"C7",DARK_GRAY_DARK_ORANGE_LIGHTER_GRAY:"C8",DARK_ORANGE_DARK_GRAY_LIGHTER_GRAY:"C9",LIGHTER_GRAY_DARK_ORANGE_DARK_GRAY:"D0",LIME_GREEN1_DARK_BLUE_DARK_GRAY:"D1",VERY_DARK_RED_SUPER_DARK_RED_ORANGE_RED:"D2",ORANGE_RED_VERY_DARK_RED_SUPER_DARK_RED:"D3",PURPLE_VERY_DARK_RED_SUPER_DARK_RED:"D4",DARK_GRAY_LIGHT_GRAY_DARK_RED_PINK:"D5",BLACK_LIGHT_BLUE1_LIGHT_BLUE2:"D6",GREEN_BLUE_LIME_GREEN1_BLUE:"D7",GREY_BLUE_GREEN_LIME_GREEN2_YELLOW_BROWN:"D8",ORANGE_YELLOW_YELLOW_BROWN_TAN_GREEN:"D9",LIGHT_BLUE_GREEN_BROWNISH_GREEN_LIME_GREEN2:"E0",LIME_GREEN2_BROWNISH_GREEN_DARK_RED_ORANGE:"E1",GRAY_DARK_BROWN3_DARKER_BROWN:"E2",BLACK_DARKER_BROWN_DARK_BROWN3:"E3",DARK_PURPLE_PURPLE_LIGHT_PURPLE1:"E4",LIGHT_PURPLE1_ORANGE_RED_PURPLE:"E5",GREEN_BROWN_DARK_BROWN2_DARK_GRAY:"E6",SKY_BLUE_BROWNISH_GREEN_LIME_GREEN2:"E7",RED_SKY_BLUE_BROWNISH_GREEN:"E8"};function ch(){let l=[];for(let e of Object.values(Rl))l.push(e);return l}var Al=ch();var E={VINE_TOP0:"V0",VINE_TOP1:"V1",VINE_TOP2:"V2",VINE_TOP3:"V3",VINE_TOP4:"V4",VINE_TOP5:"V5",VINE_TOP6:"V6",VINE_TOP7:"V7",VINE_PARTIAL0:"v0",VINE_PARTIAL1:"v1",VINE_PARTIAL2:"v2",VINE_PARTIAL3:"v3",VINE_PARTIAL4:"v4",VINE_PARTIAL5:"v5",VINE_PARTIAL6:"v6",VINE_PARTIAL7:"v7",FLOOR_PLANT0:"P0",FLOOR_PLANT1:"P1",FLOOR_PLANT2:"P2",FLOOR_PLANT3:"P3",FLOOR_PLANT4:"P4",FLOOR_PLANT5:"P5",FLOOR_PLANT6:"P6",FLOOR_PLANT7:"P7",FLOOR_GRASS0:"G0",FLOOR_GRASS1:"G1",FLOOR_GRASS2:"G2",FLOOR_GRASS3:"G3",FLOOR_GRASS4:"G4",FLOOR_GRASS5:"G5",FLOOR_GRASS6:"G6",FLOOR_GRASS7:"G7",FLOOR_MUSHROOM0:"M0",FLOOR_MUSHROOM1:"M1",FLOOR_MUSHROOM2:"M2",FLOOR_MUSHROOM3:"M3",FLOOR_MUSHROOM4:"M4",FLOOR_MUSHROOM5:"M5",FLOOR_MUSHROOM6:"M6",FLOOR_MUSHROOM7:"M7",WALL_FLOWER0:"W0",WALL_FLOWER1:"W1",WALL_FLOWER2:"W2",WALL_FLOWER3:"W3",WALL_FLOWER4:"W4",WALL_FLOWER5:"W5",WALL_FLOWER6:"W6",WALL_FLOWER7:"W7",STALACTITE0:"S0",STALACTITE1:"S1",STALACTITE2:"S2",STALACTITE3:"S3",STALACTITE4:"S4",STALACTITE5:"S5",STALACTITE6:"S6",STALACTITE7:"S7",STALAGMITE0:"s0",STALAGMITE1:"s1",STALAGMITE2:"s2",STALAGMITE3:"s3",STALAGMITE4:"s4",STALAGMITE5:"s5",STALAGMITE6:"s6",STALAGMITE7:"s7",FLOOR_POKIES0:"f0",FLOOR_POKIES1:"f1",FLOOR_POKIES2:"f2",FLOOR_POKIES3:"f3",FLOOR_POKIES4:"f4",FLOOR_POKIES5:"f5",FLOOR_POKIES6:"f6",FLOOR_POKIES7:"f7",CEILING_POKIES0:"p0",CEILING_POKIES1:"p1",CEILING_POKIES2:"p2",CEILING_POKIES3:"p3",CEILING_POKIES4:"p4",CEILING_POKIES5:"p5",CEILING_POKIES6:"p6",CEILING_POKIES7:"p7",WALL_CRACKS0:"C0",WALL_CRACKS1:"C1",WALL_CRACKS2:"C2",WALL_CRACKS3:"C3",WALL_CRACKS4:"C4",WALL_CRACKS5:"C5",WALL_CRACKS6:"C6",WALL_CRACKS7:"C7",TALL_GRASS0:"g0",TALL_GRASS1:"g1",TALL_GRASS2:"g2",TALL_GRASS3:"g3",TALL_GRASS4:"g4",TALL_GRASS5:"g5",TALL_GRASS6:"g6",TALL_GRASS7:"g7",CEILING_GRASS0:"c0",CEILING_GRASS1:"c1",CEILING_GRASS2:"c2",CEILING_GRASS3:"c3",CEILING_GRASS4:"c4",CEILING_GRASS5:"c5",CEILING_GRASS6:"c6",CEILING_GRASS7:"c7",CURVED_PLANTS0:"a0",CURVED_PLANTS1:"a1",CURVED_PLANTS2:"a2",CURVED_PLANTS3:"a3",CURVED_PLANTS4:"a4",CURVED_PLANTS5:"a5",CURVED_PLANTS6:"a6",CURVED_PLANTS7:"a7",FLOWERS0:"b0",FLOWERS1:"b1",FLOWERS2:"b2",FLOWERS3:"b3",FLOWERS4:"b4",FLOWERS5:"b5",FLOWERS6:"b6",FLOWERS7:"b7",FLOOR_SPIKES0:"d0",FLOOR_SPIKES1:"d1",FLOOR_SPIKES2:"d2",FLOOR_SPIKES3:"d3",FLOOR_SPIKES4:"d4",FLOOR_SPIKES5:"d5",FLOOR_SPIKES6:"d6",FLOOR_SPIKES7:"d7",CEILING_SPIKES0:"e0",CEILING_SPIKES1:"e1",CEILING_SPIKES2:"e2",CEILING_SPIKES3:"e3",CEILING_SPIKES4:"e4",CEILING_SPIKES5:"e5",CEILING_SPIKES6:"e6",CEILING_SPIKES7:"e7",WALL_HOLES0:"h0",WALL_HOLES1:"h1",WALL_HOLES2:"h2",WALL_HOLES3:"h3",WALL_HOLES4:"h4",WALL_HOLES5:"h5",WALL_HOLES6:"h6",WALL_HOLES7:"h7"},mh=[E.VINE_TOP0,E.VINE_TOP1,E.VINE_TOP2,E.VINE_TOP3,E.VINE_TOP4,E.VINE_TOP5,E.VINE_TOP6,E.VINE_TOP7],ph=[E.VINE_PARTIAL0,E.VINE_PARTIAL1,E.VINE_PARTIAL2,E.VINE_PARTIAL3,E.VINE_PARTIAL4,E.VINE_PARTIAL5,E.VINE_PARTIAL6,E.VINE_PARTIAL7],gh=[E.FLOOR_PLANT0,E.FLOOR_PLANT1,E.FLOOR_PLANT2,E.FLOOR_PLANT3,E.FLOOR_PLANT4,E.FLOOR_PLANT5,E.FLOOR_PLANT6,E.FLOOR_PLANT7],fh=[E.FLOOR_GRASS0,E.FLOOR_GRASS1,E.FLOOR_GRASS2,E.FLOOR_GRASS3,E.FLOOR_GRASS4,E.FLOOR_GRASS5,E.FLOOR_GRASS6,E.FLOOR_GRASS7],Th=[E.FLOOR_MUSHROOM0,E.FLOOR_MUSHROOM1,E.FLOOR_MUSHROOM2,E.FLOOR_MUSHROOM3,E.FLOOR_MUSHROOM4,E.FLOOR_MUSHROOM5,E.FLOOR_MUSHROOM6,E.FLOOR_MUSHROOM7],Eh=[E.WALL_FLOWER0,E.WALL_FLOWER1,E.WALL_FLOWER2,E.WALL_FLOWER3,E.WALL_FLOWER4,E.WALL_FLOWER5,E.WALL_FLOWER6,E.WALL_FLOWER7],Sh=[E.STALACTITE0,E.STALACTITE1,E.STALACTITE2,E.STALACTITE3,E.STALACTITE4,E.STALACTITE5,E.STALACTITE6,E.STALACTITE7],Ch=[E.STALAGMITE0,E.STALAGMITE1,E.STALAGMITE2,E.STALAGMITE3,E.STALAGMITE4,E.STALAGMITE5,E.STALAGMITE6,E.STALAGMITE7],wh=[E.FLOOR_POKIES0,E.FLOOR_POKIES1,E.FLOOR_POKIES2,E.FLOOR_POKIES3,E.FLOOR_POKIES4,E.FLOOR_POKIES5,E.FLOOR_POKIES6,E.FLOOR_POKIES7],Lh=[E.CEILING_POKIES0,E.CEILING_POKIES1,E.CEILING_POKIES2,E.CEILING_POKIES3,E.CEILING_POKIES4,E.CEILING_POKIES5,E.CEILING_POKIES6,E.CEILING_POKIES7],_h=[E.TALL_GRASS0,E.TALL_GRASS1,E.TALL_GRASS2,E.TALL_GRASS3,E.TALL_GRASS4,E.TALL_GRASS5,E.TALL_GRASS6,E.TALL_GRASS7],Mh=[E.CEILING_GRASS0,E.CEILING_GRASS1,E.CEILING_GRASS2,E.CEILING_GRASS3,E.CEILING_GRASS4,E.CEILING_GRASS5,E.CEILING_GRASS6,E.CEILING_GRASS7],Rh=[E.CURVED_PLANTS0,E.CURVED_PLANTS1,E.CURVED_PLANTS2,E.CURVED_PLANTS3,E.CURVED_PLANTS4,E.CURVED_PLANTS5,E.CURVED_PLANTS6,E.CURVED_PLANTS7],Ah=[E.FLOWERS0,E.FLOWERS1,E.FLOWERS2,E.FLOWERS3,E.FLOWERS4,E.FLOWERS5,E.FLOWERS6,E.FLOWERS7],Nh=[E.FLOOR_SPIKES0,E.FLOOR_SPIKES1,E.FLOOR_SPIKES2,E.FLOOR_SPIKES3,E.FLOOR_SPIKES4,E.FLOOR_SPIKES5,E.FLOOR_SPIKES6,E.FLOOR_SPIKES7],Ph=[E.CEILING_SPIKES0,E.CEILING_SPIKES1,E.CEILING_SPIKES2,E.CEILING_SPIKES3,E.CEILING_SPIKES4,E.CEILING_SPIKES5,E.CEILING_SPIKES6,E.CEILING_SPIKES7],yh=[E.WALL_HOLES0,E.WALL_HOLES1,E.WALL_HOLES2,E.WALL_HOLES3,E.WALL_HOLES4,E.WALL_HOLES5,E.WALL_HOLES6,E.WALL_HOLES7],Nl=[mh,Sh,Lh,Mh,Ph],Pl=[ph,Eh,yh],yl=[gh,fh,Th,Ch,wh,_h,Rh,Ah,Nh];var Ft=class extends ve{constructor(e,t){super(e,t),this.spriteMap={}}getSprite(e){return this.spriteMap[e]}};var Bt=class l extends Ft{constructor(e,t){super(e,t),this.loadImage()}static getSpriteName(e,t){return e+"_"+t}populateSpriteMap(){let e=0;for(let t of Object.values(E))this.parseRow(e,t),e++;this.loaded=!0}parseRow(e,t){let i=this.spriteSize+1,r=e*i,s=0;for(let o of Object.values(Rl)){let a=l.getSpriteName(t,o);this.spriteMap[a]=new te(this,s,r),s+=i}}getFixtureSprite(e,t){return this.getSprite(l.getSpriteName(e,t))}};var p={AQUATIC_SNAKE_TAN_1:"AQUATIC_SNAKE_TAN1",AQUATIC_SNAKE_TAN_2:"AQUATIC_SNAKE_TAN2",AQUATIC_SNAKE_BLACK_1:"AQUATIC_SNAKE_BLACK1",AQUATIC_SNAKE_BLACK_2:"AQUATIC_SNAKE_BLACK2",AQUATIC_MONSTER:"AQUATIC_MONSTER",AVIAN_BAT_BROWN_SMALL:"AVIAN_BAT_BROWN_SMALL",AVIAN_BAT_BROWN_LARGE:"AVIAN_BAT_BROWN_LARGE",AVIAN_BAT_BLACK_LARGE:"AVIAN_BAT_BLACK_LARGE",AVIAN_BAT_BROWN_SMALL2:"AVIAN_BAT_BROWN_SMALL2",AVIAN_BAT_BROWN_LARGE2:"AVIAN_BAT_BROWN_LARGE2",DEMON_REPTILIAN_GREEN:"DEMON_REPTILIAN_GREEN",DEMON_REPTILIAN_WINGED:"DEMON_REPTILIAN_WINGED",DEMON_BROWN:"DEMON_BROWN",DEMON_BLOB:"DEMON_BLOB",DEMON_BLUE:"DEMON_BLUE",DEMON_BLUE_WINGED:"DEMON_BLUE_WINGED",DEMON_RED_GLOWING:"DEMON_RED_GLOWING",DEMON_RED_WINGED_1:"DEMON_RED_WINGED1",DEMON_RED_WINGED_2:"DEMON_RED_WINGED2",DEMON_RED_DARK_LARGE:"DEMON_RED_DARK_LARGE",DEMON_RED_LARGE:"DEMON_RED_LARGE",DEMON_RED_PALE_LARGE:"DEMON_RED_PALE_LARGE",DEMON_BLUE_LARGE:"DEMON_BLUE_LARGE",DEMON_BLUE_RED_LARGE:"DEMON_BLUE_RED_LARGE",DEMON_GREEN_EYE_STOCKS:"DEMON_GREEN_EYE_STOCKS",DEMON_GREEN_EVIL_WINGED:"DEMON_GREEN_EVIL_WINGED",DEMON_RED_DARK_WHIP:"DEMON_RED_DARK_WHIP",DEMON_RED_TINY_JUMPING:"DEMON_RED_TINY_JUMPING",DEMON_RED_SMALL_JUMPING:"DEMON_RED_SMALL_JUMPING",DEMON_ARMORED:"DEMON_ARMORED",DEMON_HELMET_HORNED:"DEMON_HELMET_HORNED",DEMON_RED_FANGED:"DEMON_RED_FANGED",DEMON_GREEN_FROG_LIKE:"DEMON_GREEN_FROG_LIKE",ELEMENTAL_WARRIOR:"ELEMENTAL_WARRIOR",ELEMENTAL_SQUID:"ELEMENTAL_SQUID",ELEMENTAL_GOLEM:"ELEMENTAL_GOLEM",ELEMENTAL_GOLEM_DARK:"ELEMENTAL_GOLEM_DARK",ELEMENTAL_GOLEM_RUSTY:"ELEMENTAL_GOLEM_RUSTY",ELEMENTAL_BLOODY:"ELEMENTAL_BLOODY",ELEMENTAL_STONE:"ELEMENTAL_STONE",ELEMENTAL_SWIRL_ORANGE:"ELEMENTAL_SWIRL_ORANGE",ELEMENTAL_SWIRL_YELLOW:"ELEMENTAL_SWIRL_YELLOW",ELEMENTAL_SWIRL_BLUE_DARK:"ELEMENTAL_SWIRL_BLUE_DARK",ELEMENTAL_SWIRL_BLUE_LIGHT:"ELEMENTAL_SWIRL_BLUE_LIGHT",ELEMENTAL_SWIRL_RED:"ELEMENTAL_SWIRL_RED",ELEMENTAL_CREEPY_RED:"ELEMENTAL_CREEPY_RED",ELEMENTAL_CREEPY_BROWN:"ELEMENTAL_CREEPY_BROWN",ELEMENTAL_CREEPY_LIGHT_BLUE:"ELEMENTAL_CREEPY_LIGHT_BLUE",ELEMENTAL_BALL_GREEN:"ELEMENTAL_BALL_GREEN",ELEMENTAL_BALL_BLUE:"ELEMENTAL_BALL_BLUE",ELEMENTAL_BALL_RED:"ELEMENTAL_BALL_RED",ELEMENTAL_BALL_BLACK:"ELEMENTAL_BALL_BLACK",ELEMENTAL_EYE_WHITE:"ELEMENTAL_EYE_WHITE",ELEMENTAL_EYE_RED:"ELEMENTAL_EYE_RED",ELEMENTAL_EYE_BEHOLDER:"ELEMENTAL_EYE_BEHOLDER",HUMANOID_210_SASQUATCH:"HUMANOID_210_SASQUATCH",HUMANOID_000:"HUMANOID_000",HUMANOID_001:"HUMANOID_001",HUMANOID_002:"HUMANOID_002",HUMANOID_003:"HUMANOID_003",HUMANOID_004:"HUMANOID_004",HUMANOID_005:"HUMANOID_005",HUMANOID_006:"HUMANOID_006",HUMANOID_007:"HUMANOID_007",HUMANOID_010_MINOTAUR:"HUMANOID_010_MINOTAUR",HUMANOID_011_CYCLOPS:"HUMANOID_011_CYCLOPS",HUMANOID_040_WALRUS_MAN:"HUMANOID_040_WALRUS_MAN",HUMANOID_041_WALRUS_MAN:"HUMANOID_041_WALRUS_MAN",HUMANOID_042_WALRUS_MAN:"HUMANOID_042_WALRUS_MAN",HUMANOID_043_WALRUS_MAN:"HUMANOID_043_WALRUS_MAN",HUMANOID_044_WALRUS_MAN:"HUMANOID_044_WALRUS_MAN",HUMANOID_045_WALRUS_MAN:"HUMANOID_045_WALRUS_MAN",HUMANOID_046_WALRUS_MAN:"HUMANOID_046_WALRUS_MAN",HUMANOID_070:"HUMANOID_070",HUMANOID_071:"HUMANOID_071",HUMANOID_072:"HUMANOID_072",HUMANOID_073:"HUMANOID_073",HUMANOID_170_STONE_SERPENT:"HUMANOID_170_STONE_SERPENT",HUMANOID_171_STONE_SERPENT:"HUMANOID_171_STONE_SERPENT",MISC_ANIMAL_70:"MISC_ANIMAL_70",HUMANOID_190_DEMON_BASHER:"HUMANOID_190_DEMON_BASHER",HUMANOID_191_DEMON_BASHER:"HUMANOID_191_DEMON_BASHER",HUMANOID_200_SQUID_DEMON:"HUMANOID_200_SQUID_DEMON",HUMANOID_201_SQUID_DEMON:"HUMANOID_201_SQUID_DEMON",MISC_ANIMAL_03_OWL:"MISC_ANIMAL_03_OWL",MISC_ANIMAL_04:"MISC_ANIMAL_04",MISC_ANIMAL_05:"MISC_ANIMAL_05",MISC_ANIMAL_06:"MISC_ANIMAL_06",MISC_ANIMAL_11:"MISC_ANIMAL_11",MISC_ANIMAL_12:"MISC_ANIMAL_12",MISC_ANIMAL_50:"MISC_ANIMAL_50",MISC_ANIMAL_51:"MISC_ANIMAL_51",MISC_ANIMAL_52:"MISC_ANIMAL_52",MISC_ANIMAL_53:"MISC_ANIMAL_53",PEST_LADYBUG_100:"PEST_LADYBUG_100",PEST_LADYBUG_101:"PEST_LADYBUG_101",PEST_TINY_00:"PEST_TINY_00",PEST_TINY_01:"PEST_TINY_01",PEST_TINY_02:"PEST_TINY_02",PEST_TINY_03:"PEST_TINY_03",PEST_TINY_04:"PEST_TINY_04",PEST_TINY_05:"PEST_TINY_05",PEST_TINY_WORM_1:"PEST_TINY_WORM1",PEST_TINY_WORM_2:"PEST_TINY_WORM2",PEST_ANT_10:"PEST_INSECT_10",PEST_INSECT_11:"PEST_INSECT_11",PEST_INSECT_12:"PEST_INSECT_12",PEST_INSECT_13:"PEST_INSECT_13",PEST_INSECT_14:"PEST_INSECT_14",PEST_SPIDER_20:"PEST_SPIDER_20",PEST_SPIDER_21:"PEST_SPIDER_21",PEST_SPIDER_22:"PEST_SPIDER_22",PEST_SCORPION_23:"PEST_SCORPION_23",PEST_SCORPION_24:"PEST_SCORPION_24",PEST_SCORPION_25:"PEST_SCORPION_25",PEST_WORM_30:"PEST_WORM_30",PEST_WORM_31:"PEST_WORM_31",PEST_BALL:"PEST_BALL",PEST_WORM_33:"PEST_WORM_33",PEST_WORM_34:"PEST_WORM_34",PEST_GIANT_ANT_40:"PEST_GIANT_ANT_40",PEST_GIANT_ANT_41:"PEST_GIANT_ANT_41",PEST_GIANT_ANT_42:"PEST_GIANT_ANT_42",PEST_GIANT_ANT_43:"PEST_GIANT_ANT_43",PEST_SLUG_70:"PEST_SLUG_70",PEST_SLUG_71:"PEST_SLUG_71",PEST_SNAIL_72:"PEST_SNAIL_72",PEST_SNAIL_73:"PEST_SNAIL_73",PEST_INSECT_60:"PEST_INSECT_60",PEST_INSECT_61:"PEST_INSECT_61",PEST_INSECT_80:"PEST_INSECT_80",PEST_INSECT_81:"PEST_INSECT_81",MINOR_DEVIL:"PLAYER_130_MINOR_DEVIL",MINOR_DEVIL_WARRIOR:"PLAYER_131_MINOR_DEVIL_WARRIOR",ORC1:"PLAYER_120_ORC",ORC_WARRIOR:"PLAYER_121_ORC_WARRIOR",ORC_FIGHTER:"PLAYER_122_ORC_FIGHTER",ORC_KARATE:"PLAYER_123_ORC_KARATE",ORC_PIRATE:"PLAYER_124_ORC_PIRATE",ORC2:"PLAYER_125_ORC",ORC3:"PLAYER_126_ORC",ORC4:"PLAYER_127_ORC",DRAGON_MAN_BASIC:"PLAYER_140_DRAGON_MAN_BASIC",DRAGON_MAN_EXPLORER:"PLAYER_141_DRAGON_MAN_EXPLORER",DRAGON_MAN_FIGHTER:"PLAYER_142_DRAGON_MAN_FIGHTER",DRAGON_MAN_RUFFIAN:"PLAYER_143_DRAGON_MAN_RUFFIAN",DRAGON_MAN_RANGER:"PLAYER_144_DRAGON_MAN_RANGER",DRAGON_MAN_TERRIBLE:"PLAYER_145_DRAGON_MAN_TERRIBLE",DRAGON_MAN_MERCILESS:"PLAYER_146_DRAGON_MAN_MERCILESS",DRAGON_MAN_FIERY:"PLAYER_147_DRAGON_MAN_FIERY",QUADRUPED_000:"QUADRUPED_000",QUADRUPED_001:"QUADRUPED_001",QUADRUPED_002:"QUADRUPED_002",QUADRUPED_003:"QUADRUPED_003",QUADRUPED_004:"QUADRUPED_004",QUADRUPED_005:"QUADRUPED_005",QUADRUPED_006:"QUADRUPED_006",QUADRUPED_007:"QUADRUPED_007",RODENT_10_RAT_SMALL:"RODENT_10_RAT_SMALL",RODENT_11_RAT:"RODENT_11_RAT",RODENT_12_RAT_LARGE_BROWN:"RODENT_12_RAT_LARGE_BROWN",RODENT_13_RAT_LARGE_GREY:"RODENT_13_RAT_LARGE_GREY",RODENT_20_RAT_POISONOUS:"RODENT_20_RAT_POISONOUS",RODENT_21_RAT_ZOMBIE:"RODENT_21_RAT_ZOMBIE",RODENT_22_MOLE:"RODENT_22_MOLE",SLIME_BLUE_00:"SLIME_BLUE_00",SLIME_BROWN_01:"SLIME_BROWN_01",SLIME_WHITE_02:"SLIME_WHITE_02",SLIME_GREEN_03:"SLIME_GREEN_03",SLIME_PINK_04:"SLIME_PINK_04",SLIME_PURPLE_05:"SLIME_PURPLE_05",SLIME_MUCUS_GREEN_40:"SLIME_MUCUS_GREEN_40",SLIME_MUCUS_BLUE_41:"SLIME_MUCUS_BLUE_41",SLIME_CORRODED_20:"SLIME_CORRODED_20",SLIME_SEEING_21:"SLIME_SEEING_21",SLIME_ORANGE_22:"SLIME_ORANGE_22",SLIME_MINI_BLUE_30:"SLIME_MINI_BLUE_30",SLIME_MINI_31:"SLIME_MINI_31",SLIME_MINI_ORANGE_32:"SLIME_MINI_ORANGE_32",UNDEAD_WRAITH_0600:"UNDEAD_WRAITH_0600",UNDEAD_WRAITH_0601:"UNDEAD_WRAITH_0601",UNDEAD_GOBLIN0:"UNDEAD_GOBLIN0",UNDEAD_GOBLIN1:"UNDEAD_GOBLIN1",UNDEAD_GOBLIN2:"UNDEAD_GOBLIN2",UNDEAD_GOBLIN3:"UNDEAD_GOBLIN3",UNDEAD_GOBLIN4:"UNDEAD_GOBLIN4",UNDEAD_GOBLIN5:"UNDEAD_GOBLIN5",UNDEAD_GOBLIN6:"UNDEAD_GOBLIN6",UNDEAD_GOBLIN7:"UNDEAD_GOBLIN7",UNDEAD_KOBOLD_SKELETON_0200:"UNDEAD_KOBOLD_SKELETON_0200",UNDEAD_KOBOLD_SKELETON_0201:"UNDEAD_KOBOLD_SKELETON_0201",UNDEAD_KOBOLD_SKELETON_0202:"UNDEAD_KOBOLD_SKELETON_0202",UNDEAD_KOBOLD_SKELETON_0203:"UNDEAD_KOBOLD_SKELETON_0203",UNDEAD_KOBOLD4:"UNDEAD_KOBOLD4",UNDEAD_KOBOLD5:"UNDEAD_KOBOLD5",UNDEAD_KOBOLD_KING_0206:"UNDEAD_KOBOLD_KING_0206",UNDEAD_KOBOLD_ANCIENT_EVIL7:"UNDEAD_KOBOLD_ANCIENT_EVIL7",UNDEAD_GHOST_0400:"UNDEAD_GHOST_0400",UNDEAD_GHOST_0401:"UNDEAD_GHOST_0401",UNDEAD_GHOST_0402:"UNDEAD_GHOST_0402",UNDEAD_GHOST_0403:"UNDEAD_GHOST_0403",UNDEAD_REAPER_0500:"UNDEAD_REAPER_0500",UNDEAD_REAPER_0501:"UNDEAD_REAPER_0501",UNDEAD_REAPER_0502:"UNDEAD_REAPER_0502",UNDEAD_DARKNESS_0801:"UNDEAD_DARKNESS_0801",REPTILE_FLYING_SERPENT_SMALL_002:"REPTILE_FLYING_SERPENT_SMALL_002",REPTILE_FLYING_SERPENT_003:"REPTILE_FLYING_SERPENT_003",REPTILE_BROWN_SERPENT_SMALL_040:"REPTILE_BROWN_SERPENT_SMALL_040",REPTILE_BROWN_SERPENT_041:"REPTILE_BROWN_SERPENT_041",REPTILE_BROWN_SERPENT_LARGE_042:"REPTILE_BROWN_SERPENT_LARGE_042",REPTILE_BLACK_SERPENT_043:"REPTILE_BLACK_SERPENT_043",REPTILE_BLACK_SERPENT_LARGE_044:"REPTILE_BLACK_SERPENT_LARGE_044",REPTILE_BLACK_SERPENT_POISONOUS_045:"REPTILE_BLACK_SERPENT_POISONOUS_045",REPTILE_GREEN_SNAKE_SMALL_046:"REPTILE_GREEN_SNAKE_SMALL_046",REPTILE_GREEN_SNAKE_047:"REPTILE_GREEN_SNAKE_047"};var Er=class extends Gt{constructor(e,t,i,r,s){super(r,s),this.spriteAnimationManager=e,this.spritesheet0=t,this.spritesheet1=i}getImage(){return this.spriteAnimationManager.getDefaultFrameIndex(2)==0?this.spritesheet0.image:this.spritesheet1.image}getSize(){return this.spritesheet0.spriteSize}};var Ti=class extends Ft{constructor(e,t,i){super(e,t),this.monsterSpritesheet=i,this.loadImage()}populateSpriteMap(){this.loaded=!0,this.monsterSpritesheet.onSpritesheetLoaded()}};var Sr=class{constructor(e,t,i,r){this.spriteAnimationManager=r,this.spriteSize=i,this.spriteMap={},this.animationFrameSpritesheet0=new Ti(e,i,this),this.animationFrameSpritesheet1=new Ti(t,i,this)}onSpritesheetLoaded(){this.animationFrameSpritesheet0.loaded&&this.animationFrameSpritesheet1.loaded&&this.populateSpriteMap()}isLoaded(){return this.animationFrameSpritesheet0.loaded&&this.animationFrameSpritesheet1.loaded}getSprite(e){return this.spriteMap[e]}populateSpriteMap(){let e=0;this.parseRow(e,[p.AQUATIC_SNAKE_TAN_1,p.AQUATIC_SNAKE_TAN_2,p.AQUATIC_SNAKE_BLACK_1,p.AQUATIC_SNAKE_BLACK_2,p.AQUATIC_MONSTER,p.AVIAN_BAT_BROWN_SMALL,p.AVIAN_BAT_BROWN_LARGE,p.AVIAN_BAT_BLACK_LARGE]),e++,this.parseRow(e,[p.AVIAN_BAT_BROWN_SMALL2,p.AVIAN_BAT_BROWN_LARGE2,p.DEMON_REPTILIAN_GREEN,p.DEMON_REPTILIAN_WINGED,p.DEMON_BROWN,p.DEMON_BLOB,p.DEMON_BLUE,p.DEMON_BLUE_WINGED]),e++,this.parseRow(e,[p.DEMON_RED_GLOWING,p.DEMON_RED_WINGED_1,p.DEMON_RED_WINGED_2,p.DEMON_RED_DARK_LARGE,p.DEMON_RED_LARGE,p.DEMON_RED_PALE_LARGE,p.DEMON_BLUE_LARGE,p.DEMON_BLUE_RED_LARGE]),e++,this.parseRow(e,[p.DEMON_GREEN_EYE_STOCKS,p.DEMON_GREEN_EVIL_WINGED,p.DEMON_RED_DARK_WHIP,p.DEMON_RED_TINY_JUMPING,p.DEMON_RED_SMALL_JUMPING,p.DEMON_ARMORED,p.DEMON_HELMET_HORNED,p.DEMON_RED_FANGED]),e++,this.parseRow(e,[p.DEMON_GREEN_FROG_LIKE,p.ELEMENTAL_WARRIOR,p.ELEMENTAL_SQUID,p.ELEMENTAL_GOLEM,p.ELEMENTAL_GOLEM_DARK,p.ELEMENTAL_GOLEM_RUSTY,p.ELEMENTAL_BLOODY,p.ELEMENTAL_STONE]),e++,this.parseRow(e,[p.ELEMENTAL_SWIRL_ORANGE,p.ELEMENTAL_SWIRL_YELLOW,p.ELEMENTAL_SWIRL_BLUE_DARK,p.ELEMENTAL_SWIRL_BLUE_LIGHT,p.ELEMENTAL_SWIRL_RED,p.ELEMENTAL_CREEPY_RED,p.ELEMENTAL_CREEPY_BROWN,p.ELEMENTAL_CREEPY_LIGHT_BLUE]),e++,this.parseRow(e,[p.ELEMENTAL_BALL_GREEN,p.ELEMENTAL_BALL_BLUE,p.ELEMENTAL_BALL_RED,p.ELEMENTAL_BALL_BLACK,p.ELEMENTAL_EYE_WHITE,p.ELEMENTAL_EYE_RED,p.ELEMENTAL_EYE_BEHOLDER,p.HUMANOID_210_SASQUATCH]),e++,this.parseRow(e,[p.HUMANOID_000,p.HUMANOID_001,p.HUMANOID_002,p.HUMANOID_003,p.HUMANOID_004,p.HUMANOID_005,p.HUMANOID_006,p.HUMANOID_007]),e++,this.parseRow(e,[p.HUMANOID_010_MINOTAUR,p.HUMANOID_011_CYCLOPS,p.HUMANOID_040_WALRUS_MAN,p.HUMANOID_041_WALRUS_MAN,p.HUMANOID_042_WALRUS_MAN,p.HUMANOID_043_WALRUS_MAN,p.HUMANOID_044_WALRUS_MAN,p.HUMANOID_045_WALRUS_MAN]),e++,this.parseRow(e,[p.HUMANOID_046_WALRUS_MAN,p.HUMANOID_070,p.HUMANOID_071,p.HUMANOID_072,p.HUMANOID_073,p.HUMANOID_170_STONE_SERPENT,p.HUMANOID_171_STONE_SERPENT,p.MISC_ANIMAL_70]),e++,this.parseRow(e,[p.HUMANOID_190_DEMON_BASHER,p.HUMANOID_191_DEMON_BASHER,p.HUMANOID_200_SQUID_DEMON,p.HUMANOID_201_SQUID_DEMON,p.MISC_ANIMAL_03_OWL,p.MISC_ANIMAL_04,p.MISC_ANIMAL_05,p.MISC_ANIMAL_06]),e++,this.parseRow(e,[p.MISC_ANIMAL_11,p.MISC_ANIMAL_12,p.MISC_ANIMAL_50,p.MISC_ANIMAL_51,p.MISC_ANIMAL_52,p.MISC_ANIMAL_53,p.PEST_LADYBUG_100,p.PEST_LADYBUG_101]),e++,this.parseRow(e,[p.PEST_TINY_00,p.PEST_TINY_01,p.PEST_TINY_02,p.PEST_TINY_03,p.PEST_TINY_04,p.PEST_TINY_05,p.PEST_TINY_WORM_1,p.PEST_TINY_WORM_2]),e++,this.parseRow(e,[p.PEST_ANT_10,p.PEST_INSECT_11,p.PEST_INSECT_12,p.PEST_INSECT_13,p.PEST_INSECT_14,p.PEST_SPIDER_20,p.PEST_SPIDER_21,p.PEST_SPIDER_22]),e++,this.parseRow(e,[p.PEST_SCORPION_23,p.PEST_SCORPION_24,p.PEST_SCORPION_25,p.PEST_WORM_30,p.PEST_WORM_31,p.PEST_BALL,p.PEST_WORM_33,p.PEST_WORM_34]),e++,this.parseRow(e,[p.PEST_GIANT_ANT_40,p.PEST_GIANT_ANT_41,p.PEST_GIANT_ANT_42,p.PEST_GIANT_ANT_43,p.PEST_SLUG_70,p.PEST_SLUG_71,p.PEST_SNAIL_72,p.PEST_SNAIL_73]),e++,this.parseRow(e,[p.PEST_INSECT_60,p.PEST_INSECT_61,p.PEST_INSECT_80,p.PEST_INSECT_81,p.MINOR_DEVIL,p.MINOR_DEVIL_WARRIOR]),e++,this.parseRow(e,[p.ORC1,p.ORC_WARRIOR,p.ORC_FIGHTER,p.ORC_KARATE,p.ORC_PIRATE,p.ORC2,p.ORC3,p.ORC4]),e++,this.parseRow(e,[p.DRAGON_MAN_BASIC,p.DRAGON_MAN_EXPLORER,p.DRAGON_MAN_FIGHTER,p.DRAGON_MAN_RUFFIAN,p.DRAGON_MAN_RANGER,p.DRAGON_MAN_TERRIBLE,p.DRAGON_MAN_MERCILESS,p.DRAGON_MAN_FIERY]),e++,this.parseRow(e,[p.QUADRUPED_000,p.QUADRUPED_001,p.QUADRUPED_002,p.QUADRUPED_003,p.QUADRUPED_004,p.QUADRUPED_005,p.QUADRUPED_006,p.QUADRUPED_007]),e++,this.parseRow(e,[p.RODENT_10_RAT_SMALL,p.RODENT_11_RAT,p.RODENT_12_RAT_LARGE_BROWN,p.RODENT_13_RAT_LARGE_GREY,p.RODENT_20_RAT_POISONOUS,p.RODENT_21_RAT_ZOMBIE,p.RODENT_22_MOLE]),e++,this.parseRow(e,[p.SLIME_BLUE_00,p.SLIME_BROWN_01,p.SLIME_WHITE_02,p.SLIME_GREEN_03,p.SLIME_PINK_04,p.SLIME_PURPLE_05,p.SLIME_MUCUS_GREEN_40,p.SLIME_MUCUS_BLUE_41]),e++,this.parseRow(e,[p.SLIME_CORRODED_20,p.SLIME_SEEING_21,p.SLIME_ORANGE_22,p.SLIME_MINI_BLUE_30,p.SLIME_MINI_31,p.SLIME_MINI_ORANGE_32,p.UNDEAD_WRAITH_0600,p.UNDEAD_WRAITH_0601]),e++,this.parseRow(e,[p.UNDEAD_GOBLIN0,p.UNDEAD_GOBLIN1,p.UNDEAD_GOBLIN2,p.UNDEAD_GOBLIN3,p.UNDEAD_GOBLIN4,p.UNDEAD_GOBLIN5,p.UNDEAD_GOBLIN6,p.UNDEAD_GOBLIN7]),e++,this.parseRow(e,[p.UNDEAD_KOBOLD_SKELETON_0200,p.UNDEAD_KOBOLD_SKELETON_0201,p.UNDEAD_KOBOLD_SKELETON_0202,p.UNDEAD_KOBOLD_SKELETON_0203,p.UNDEAD_KOBOLD4,p.UNDEAD_KOBOLD5,p.UNDEAD_KOBOLD_KING_0206,p.UNDEAD_KOBOLD_ANCIENT_EVIL7]),e++,this.parseRow(e,[p.UNDEAD_GHOST_0400,p.UNDEAD_GHOST_0401,p.UNDEAD_GHOST_0402,p.UNDEAD_GHOST_0403,p.UNDEAD_REAPER_0500,p.UNDEAD_REAPER_0501,p.UNDEAD_REAPER_0502,p.UNDEAD_DARKNESS_0801]),e++,this.parseRow(e,[p.REPTILE_FLYING_SERPENT_SMALL_002,p.REPTILE_FLYING_SERPENT_003]),e++,this.parseRow(e,[p.REPTILE_BROWN_SERPENT_SMALL_040,p.REPTILE_BROWN_SERPENT_041,p.REPTILE_BROWN_SERPENT_LARGE_042,p.REPTILE_BLACK_SERPENT_043,p.REPTILE_BLACK_SERPENT_LARGE_044,p.REPTILE_BLACK_SERPENT_POISONOUS_045,p.REPTILE_GREEN_SNAKE_SMALL_046,p.REPTILE_GREEN_SNAKE_047]),e++,this.loaded=!0}parseRow(e,t){let i=this.spriteSize+1,r=e*i,s=0;for(let o=0;o<+t.length;o++)this.spriteMap[t[o]]=new Er(this.spriteAnimationManager,this.animationFrameSpritesheet0,this.animationFrameSpritesheet1,s,r),s+=i}};var Cr=class{constructor(){this.oreSpriteLists=[]}addSeries(e){this.oreSpriteLists.push(e)}getOreSprite(e){if(!e||e.open||e.tileType.rarityModifier!==f.ORE)return null;let t=e.getTileRow(),r=Math.min(.999,t/1e4),s=this.oreSpriteLists.length*r|0,o=this.oreSpriteLists[s];return o[e.hash()%o.length]}};var Vt=class{constructor(e){this.sprites=e,this.step=100/e.length}getDamageSprite(e){if(e>=100)return null;let t=this.sprites.length-1-e/this.step|0;return t>=this.sprites.length||t<0?(console.log("getDamageSprite() bad index calculated. healthPercent="+e+" idx="+t),null):this.sprites[t]}};var wr=class{constructor(){this.spriteSeries=[]}add(e){this.spriteSeries.push(e)}getDamageSprite(e){if(!e||e.open)return null;let t=e.healthPercent;if(t===100)return null;let i=Math.abs(e.hash()%this.spriteSeries.length);return this.spriteSeries[i].getDamageSprite(t)}};var Lr=class extends ht{constructor(e,t,i,r,s){super(e,t),this.upgradeSpriteOverlay=null,this.spriteAnimationManager=i,this.tileDamageSpriteOverlay=r,this.oreSpriteOverlay=s,this.loadImage()}calculateSpriteStep(e){return e+1}populateSpriteMap(){let e=this.parseRow(0,2);this.upgradeSpriteOverlay=new Qe(e,this.spriteAnimationManager,!1,!0);let t=this.parseRow(1,8),i=new Vt(t);this.tileDamageSpriteOverlay.add(i);let r=this.parseRow(2,8),s=new Vt(r);this.tileDamageSpriteOverlay.add(s);let o=this.parseRow(3,8),a=new Vt(o);this.tileDamageSpriteOverlay.add(a),this.oreSpriteOverlay.addSeries(this.parseRow(5,8)),this.oreSpriteOverlay.addSeries(this.parseRow(6,8)),this.oreSpriteOverlay.addSeries(this.parseRow(7,8)),this.oreSpriteOverlay.addSeries(this.parseRow(8,8)),this.oreSpriteOverlay.addSeries(this.parseRow(9,8)),this.oreSpriteOverlay.addSeries(this.parseRow(10,8)),this.oreSpriteOverlay.addSeries(this.parseRow(11,8)),this.oreSpriteOverlay.addSeries(this.parseRow(12,8)),this.oreSpriteOverlay.addSeries(this.parseRow(13,8)),this.oreSpriteOverlay.addSeries(this.parseRow(14,8)),this.oreSpriteOverlay.addSeries(this.parseRow(15,8)),this.oreSpriteOverlay.addSeries(this.parseRow(16,8)),this.oreSpriteOverlay.addSeries(this.parseRow(17,8)),this.loaded=!0}};var _r=class extends Qe{constructor(e,t,i,r,s){super(e,t,i,!0),this.directionalSprite=s,this.superFastAnimation=r}getSpriteAsOf(e,t){return this.fastAnimation?this.getFastCurrentSpriteAsOf(e,t):this.superFastAnimation?this.getSuperFastCurrentSpriteAsOf(e,t):this.getCurrentSpriteAsOf(e,t)}isAnimationLoopCompleted(e){return this.directionalSprite?!1:this.fastAnimation?this.spriteAnimationManager.isFastAnimationLoopCompleted(Date.now(),e,this.sprites.length):this.superFastAnimation?this.spriteAnimationManager.isSuperFastAnimationLoopCompleted(Date.now(),e,this.sprites.length):this.spriteAnimationManager.isDefaultAnimationLoopCompleted(Date.now(),e,this.sprites.length)}isDirectionalSprite(){return this.directionalSprite}};var Mr=class extends ve{constructor(e,t,i,r,s){super(e,t),this.sheetEndCol=r,this.spritesheetMetadata=i,this.spriteAnimationManager=s,this.spriteMap={},this.loadImage()}populateSpriteMap(){for(let e=0;e<this.spritesheetMetadata.length;e++){let t=this.spritesheetMetadata[e],i=this.loadSpriteAnimation(t);this.spriteMap[t.animationName]=i}this.loaded=!0}loadSpriteAnimation(e){let t=Object.hasOwn(e,"directional")?e.directional:!1,i=Object.hasOwn(e,"fastAnimation")?e.fastAnimation:!1,r=Object.hasOwn(e,"superFastAnimation")?e.superFastAnimation:!1,s=this.createSpriteFrames(e);return new _r(s,this.spriteAnimationManager,i,r,t)}createSpriteFrames(e){let t=[],i=e.startRow,r=e.endRow,s=e.startCol,o=e.endCol,a=this.spriteSize;for(let h=i;h<=r;h++){let u=h*a,m;h<r?m=this.sheetEndCol:m=Math.min(o,this.sheetEndCol);for(let g=s;g<=m;g++){let _=g*a;t.push(new te(this,_,u))}}return t}getSpriteAnimation(e){return this.spriteMap[e]}};var Bl=[{animationName:"Red Arrow",startCol:0,startRow:0,endCol:7,endRow:0,directional:!0},{animationName:"Green Arrow",startCol:0,startRow:1,endCol:7,endRow:1,directional:!0},{animationName:"Pink Arrow",startCol:0,startRow:2,endCol:7,endRow:2,directional:!0},{animationName:"Pink Lightning",startCol:0,startRow:3,endCol:7,endRow:3,directional:!0},{animationName:"Green Projectile",startCol:0,startRow:4,endCol:7,endRow:4,directional:!0},{animationName:"Small Green Projectiles",startCol:0,startRow:5,endCol:7,endRow:5,directional:!0},{animationName:"Fire Projectile",startCol:0,startRow:6,endCol:7,endRow:6,directional:!0},{animationName:"Fire Arrow",startCol:0,startRow:7,endCol:7,endRow:7,directional:!0},{animationName:"Ice Projectile",startCol:0,startRow:8,endCol:7,endRow:8,directional:!0},{animationName:"Ice Arrow",startCol:0,startRow:9,endCol:7,endRow:9,directional:!0},{animationName:"Lightning",startCol:0,startRow:10,endCol:7,endRow:10,directional:!0},{animationName:"Lightning Arrow",startCol:0,startRow:11,endCol:7,endRow:11,directional:!0},{animationName:"Grey Bullet",startCol:0,startRow:12,endCol:7,endRow:12,directional:!0},{animationName:"Yellow Bullet",startCol:0,startRow:13,endCol:7,endRow:13,directional:!0},{animationName:"Ninja Star",startCol:0,startRow:14,endCol:7,endRow:14,directional:!0},{animationName:"Pink Star Projectile",startCol:0,startRow:15,endCol:7,endRow:15,directional:!0},{animationName:"Web",startCol:0,startRow:16,endCol:7,endRow:16,directional:!0},{animationName:"Pink Ball Projectile",startCol:0,startRow:17,endCol:7,endRow:17,directional:!0},{animationName:"Yellow Star Projectile",startCol:0,startRow:18,endCol:7,endRow:18,directional:!1},{animationName:"Gold Sparkles",startCol:0,startRow:19,endCol:7,endRow:19},{animationName:"Green Sparkles",startCol:0,startRow:20,endCol:7,endRow:20},{animationName:"Blue Sparkles",startCol:0,startRow:21,endCol:7,endRow:21},{animationName:"Orange Sparkles",startCol:0,startRow:22,endCol:7,endRow:22},{animationName:"Pink Sparkles",startCol:0,startRow:23,endCol:7,endRow:23},{animationName:"Red Sparkles",startCol:0,startRow:24,endCol:7,endRow:24},{animationName:"Green Skull",startCol:0,startRow:25,endCol:7,endRow:25},{animationName:"Yellow Key",startCol:0,startRow:26,endCol:7,endRow:26},{animationName:"Skull Cross",startCol:0,startRow:27,endCol:7,endRow:27},{animationName:"Shields",startCol:0,startRow:28,endCol:7,endRow:28},{animationName:"Red Crosses",startCol:0,startRow:29,endCol:7,endRow:29},{animationName:"Fire Ring",startCol:0,startRow:30,endCol:7,endRow:30},{animationName:"Ice Ring",startCol:0,startRow:31,endCol:7,endRow:31},{animationName:"Green Ring",startCol:0,startRow:32,endCol:7,endRow:32},{animationName:"Pink Ring",startCol:0,startRow:33,endCol:7,endRow:33},{animationName:"Yellow Star",startCol:0,startRow:34,endCol:7,endRow:34},{animationName:"Blue Star",startCol:0,startRow:35,endCol:7,endRow:35},{animationName:"Green Star",startCol:0,startRow:36,endCol:7,endRow:36},{animationName:"White Crosses",startCol:0,startRow:37,endCol:7,endRow:37},{animationName:"Spider Web",startCol:0,startRow:38,endCol:7,endRow:38},{animationName:"Torch",startCol:0,startRow:39,endCol:7,endRow:39},{animationName:"Frost",startCol:0,startRow:40,endCol:7,endRow:41,fastAnimation:!0},{animationName:"Yellow Star Circle",startCol:0,startRow:42,endCol:6,endRow:43},{animationName:"Circles",startCol:0,startRow:44,endCol:4,endRow:45},{animationName:"Gold Shield Spiral",startCol:0,startRow:46,endCol:7,endRow:47,fastAnimation:!0},{animationName:"Green Shield Spiral",startCol:0,startRow:48,endCol:7,endRow:49,fastAnimation:!0},{animationName:"Blue Shield Spiral",startCol:0,startRow:50,endCol:7,endRow:51,fastAnimation:!0},{animationName:"Pink Shield Spiral",startCol:0,startRow:52,endCol:7,endRow:53,fastAnimation:!0},{animationName:"Blue Firework",startCol:0,startRow:54,endCol:7,endRow:55,fastAnimation:!0},{animationName:"Red Firework",startCol:0,startRow:56,endCol:7,endRow:57,fastAnimation:!0},{animationName:"Bubbles",startCol:0,startRow:58,endCol:2,endRow:60,fastAnimation:!0},{animationName:"Shield",startCol:0,startRow:61,endCol:7,endRow:62,fastAnimation:!0},{animationName:"Color Spiral",startCol:0,startRow:63,endCol:7,endRow:64},{animationName:"Arm Flex",startCol:0,startRow:65,endCol:4,endRow:66,fastAnimation:!0},{animationName:"Super Speed",startCol:0,startRow:67,endCol:7,endRow:68,fastAnimation:!0},{animationName:"Target",startCol:0,startRow:69,endCol:7,endRow:70,fastAnimation:!0},{animationName:"Yellow Shield Spiral",startCol:0,startRow:71,endCol:6,endRow:72,fastAnimation:!0},{animationName:"Pink Star Circle",startCol:0,startRow:73,endCol:6,endRow:74},{animationName:"Blue Star Circle",startCol:0,startRow:75,endCol:6,endRow:76},{animationName:"Green Star Circle",startCol:0,startRow:77,endCol:6,endRow:78},{animationName:"Gold Star Circle",startCol:0,startRow:79,endCol:6,endRow:80},{animationName:"Bread",startCol:0,startRow:81,endCol:7,endRow:81},{animationName:"Yellow Fire Ring",startCol:0,startRow:82,endCol:7,endRow:82},{animationName:"Totems",startCol:0,startRow:83,endCol:7,endRow:83},{animationName:"Eye Blink",startCol:0,startRow:84,endCol:7,endRow:84},{animationName:"Pink Star",startCol:0,startRow:85,endCol:7,endRow:85},{animationName:"Orange Star",startCol:0,startRow:86,endCol:7,endRow:86},{animationName:"Red Eye Blink",startCol:0,startRow:87,endCol:6,endRow:88},{animationName:"Eagle",startCol:0,startRow:89,endCol:7,endRow:89},{animationName:"Sleep",startCol:0,startRow:90,endCol:6,endRow:91},{animationName:"Armor",startCol:0,startRow:92,endCol:7,endRow:92},{animationName:"Blind Eye Blink",startCol:0,startRow:93,endCol:7,endRow:93},{animationName:"Fire Rain",startCol:0,startRow:94,endCol:7,endRow:96,fastAnimation:!0},{animationName:"Blue Rain",startCol:0,startRow:97,endCol:7,endRow:99,fastAnimation:!0},{animationName:"Green Rain",startCol:0,startRow:100,endCol:7,endRow:102,fastAnimation:!0},{animationName:"Lightning Rain",startCol:0,startRow:103,endCol:7,endRow:105,fastAnimation:!0},{animationName:"Pink Rain",startCol:0,startRow:106,endCol:7,endRow:108,fastAnimation:!0},{animationName:"Rainbow Rain",startCol:0,startRow:109,endCol:7,endRow:111,fastAnimation:!0},{animationName:"Spear",startCol:0,startRow:112,endCol:7,endRow:112,directional:!0,customScale:1.5},{animationName:"Red Damage",startCol:0,startRow:113,endCol:2,endRow:113},{animationName:"White Damage",startCol:0,startRow:114,endCol:2,endRow:114},{animationName:"Blue Damage",startCol:0,startRow:115,endCol:2,endRow:115},{animationName:"Green Damage",startCol:0,startRow:116,endCol:2,endRow:116},{animationName:"Red Splat",startCol:0,startRow:117,endCol:2,endRow:117},{animationName:"Electric Damage",startCol:0,startRow:118,endCol:2,endRow:118},{animationName:"Fire Damage",startCol:0,startRow:119,endCol:2,endRow:119},{animationName:"Poison Damage",startCol:0,startRow:120,endCol:2,endRow:120},{animationName:"Sonic Damage",startCol:0,startRow:121,endCol:2,endRow:121},{animationName:"Pink Damage",startCol:0,startRow:122,endCol:2,endRow:122},{animationName:"Fat Red Arrow",startCol:0,startRow:123,endCol:7,endRow:123,directional:!0},{animationName:"Wall Arrow",startCol:0,startRow:124,endCol:7,endRow:124,directional:!0}];var Rr=class{constructor(){this.spriteAnimationManager=new ur,this.tileDamageSpriteOverlay=new wr,this.oreSpriteOverlay=new Cr,this.loaded=!1,this.tileSpritesheet=new mr("spritesheet/tile_spritesheet.png",n.tile.size),this.tileTypeBackgroundSpritesheet=new fr("spritesheet/tile_type_background.png",n.tile.size),this.characterSpritesheet=new cr("spritesheet/character_spritesheet.png",n.tile.size,this.spriteAnimationManager),this.itemOverlaySpritesheet=new Tr("spritesheet/item_overlay_spritesheet.png",n.tile.size*3,this.spriteAnimationManager),this.staticFixtureSpritesheet=new Bt("spritesheet/static_fixture_spritesheet.png",n.tile.size),this.monsterSpritesheet=new Sr("spritesheet/monsters0.png","spritesheet/monsters1.png",n.tile.size,this.spriteAnimationManager),this.tileSpriteOverlaySpritesheet=new Lr("spritesheet/tile_overlay.png",n.tile.size,this.spriteAnimationManager,this.tileDamageSpriteOverlay,this.oreSpriteOverlay),this.spellFxSpritesheet=new Mr("spritesheet/SpellFX.png",31,Bl,7,this.spriteAnimationManager)}isInitialized(){return this.loaded||(this.loaded=this.tileSpritesheet.loaded&&this.tileTypeBackgroundSpritesheet.loaded&&this.characterSpritesheet.loaded&&this.itemOverlaySpritesheet.loaded&&this.staticFixtureSpritesheet.loaded&&this.monsterSpritesheet.isLoaded()&&this.tileSpriteOverlaySpritesheet.loaded&&this.spellFxSpritesheet.loaded),this.loaded}};var pe={NO_OPEN_BORDERS:0,NORTH_BORDER_OPEN:1,SOUTH_BORDER_OPEN:2,NORTH_SOUTH_OPEN:3,WEST_BORDER_OPEN:4,NORTH_WEST_OPEN:5,SOUTH_WEST_OPEN:6,NORTH_SOUTH_WEST_OPEN:7,EAST_BORDER_OPEN:8,NORTH_EAST_OPEN:9,SOUTH_EAST_OPEN:10,NORTH_SOUTH_EAST_OPEN:11,WEST_EAST_OPEN:12,NORTH_WEST_EAST:13,SOUTH_WEST_EAST:14,ALL_BORDERS_OPEN:15};var pr=class{constructor(){this.northBorder=null,this.eastBorder=null,this.southBorder=null,this.westBorder=null,this.northEastBorder=null,this.northSouthBorder=null,this.northWestBorder=null,this.southEastBorder=null,this.eastWestBorder=null,this.southWestBorder=null,this.northEastSouthBorder=null,this.northSouthWestBorder=null,this.northEastWestBorder=null,this.eastWestSouthBorder=null,this.northEastSouthWestBorder=null,this.noBorder=null}getTileSprite(e){switch(e){case pe.NO_OPEN_BORDERS:return this.noBorder;case pe.NORTH_BORDER_OPEN:return this.northBorder;case pe.SOUTH_BORDER_OPEN:return this.southBorder;case pe.NORTH_SOUTH_OPEN:return this.northSouthBorder;case pe.WEST_BORDER_OPEN:return this.westBorder;case pe.NORTH_WEST_OPEN:return this.northWestBorder;case pe.SOUTH_WEST_OPEN:return this.southWestBorder;case pe.NORTH_SOUTH_WEST_OPEN:return this.northSouthWestBorder;case pe.EAST_BORDER_OPEN:return this.eastBorder;case pe.NORTH_EAST_OPEN:return this.northEastBorder;case pe.SOUTH_EAST_OPEN:return this.southEastBorder;case pe.NORTH_SOUTH_EAST_OPEN:return this.northEastSouthBorder;case pe.WEST_EAST_OPEN:return this.eastWestBorder;case pe.NORTH_WEST_EAST:return this.northEastWestBorder;case pe.SOUTH_WEST_EAST:return this.eastWestSouthBorder;case pe.ALL_BORDERS_OPEN:return this.northEastSouthWestBorder;default:return console.log("TileTemplate.getTileSprite() invalid border code: "+e),this.noBorder}}};var M=class{constructor(e,t,i,r,s,o){this.id=e,this.name=t,this.iconFileName=i,this.opaque=r,this.lightingSupported=s,this.rarityModifier=o,this.tileTemplate=null,this.tileTemplate2=null,this.tileTemplate3=null,this.tileTypeBackground=null,this.layerDescription=null,this.openColor="",this.closedColor=""}getRandomTemplate(){let e=Math.random();return e<.333?this.tileTemplate:e<.666?this.tileTemplate2:this.tileTemplate3}};var X={EMPTY:new M("0","Empty","sky.png",!0,!1,f.COMMON),SKY:new M("1","Sky","sky.png",!0,!1,f.COMMON),GRASS:new M("2","Grass","grass.png",!0,!1,f.COMMON),DIRT:new M("10","Dirt","dirt.png",!0,!0,f.COMMON)};function Ih(){let l=[],e=11;return l.push(new M(""+e++,"Blue Green Clay","blue_green_clay.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Red Clay","red_clay.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Grey Sandstone","grey_sandstone.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Brown Sandstone","brown_sandstone.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Green Pyronxenite","green_pyronxenite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Blue Dunite","blue_dunite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Deficient Hematite","deficient_hematite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Blue Sandstone","blue_sandstone.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Pink Slate","pink_slate.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Green Basalt","green_basalt.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Deep Bismuth","deep_bismuth.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Dark Phrenite","dark_phrenite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Blue Stone","blue_stone.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Orange Alexandrite","orange_alexandrite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Defective Cobalt","defective_cobalt.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Green Schist","green_schist.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Pale Blue Stone","pale_blue_stone.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Red Pyronxenite","red_pyronxenite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Teal Clay","teal_clay.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Bloodstone","bloodstone.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Grey Orange Granite","grey_orange_granite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Aqua Carnelion","aqua_carnelion.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Purple Grey Quartz","purple_grey_quartz.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Substandard Gypsum","substandard_gypsum.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Red Magnetite","red_magnetite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Arkose Sandstone","arkose_sandstone.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Gabbro","gabbro.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Dark Purple Clay","dark_purple_clay.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Rose Stone","rose_stone.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Purple Grey Granite","purple_grey_granite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Green Slate","green_slate.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Blue Schist","blue_schist.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Rotten Vanadium","rotten_vanadium.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Green Quartz","green_quartz.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Golden Slate","golden_slate.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Slimy Pyrrhotite","slimy_pyrrhotite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Green Jasper","green_jasper.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Blood Agate","blood_agate.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Compressed Bauxite","compressed_bauxite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Darkest Adventurine","darkest_adventurine.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Pink Amethyst","pink_amethyst.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Dark Iron Stone","dark_iron_stone.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Brown Jasper","brown_jasper.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Hellish Agate","hellish_agate.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Nasty Bauxite","nasty_bauxite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Diabolical Malachite","diabolical_malachite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Sun Stone","red_sunstone.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Cruek Cesium","cruel_cesium.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Orange Carnelion","orange_carnelion.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Purple Charoite","purple_charoite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Heliotrope Granite","heliotrope_granite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Pink Kunzite","pink_kunzite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Fractured Slate","fractured_slate.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Pink Grey Granite","pink_grey_granite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Blue Galaxy Granite","blue_galaxy_granite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Black Quartz","black_quartz.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Vile Hematite","vile_hematite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Green Clay","green_clay.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Purple Granite","purple_granite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Blue Quartz","blue_quartz.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Orange Basalt","orange_basalt.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Yellow Sandstone","yellow_sandstone.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Blue Green Agate","blue_green_agate.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Calamitous Calcite","calamitous_calcite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Brown Basalt","brown_basalt.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Emerald Dolomite","emerald_dolomite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Dark Pyroxenite","dark_pyroxenite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Violet Tanzanite","violet_tanzanite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Green Serpentine","green_serpentine.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Ruby Basalt","ruby_basalt.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Purple Schist","purple_schist.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Green Aragonite","green_aragonite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Red Spinel","red_spinel.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Infected Schist","infected_schist.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Salmon Basalt","salmon_basalt.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Enchanted Jasper","enchanted_jasper.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Cursed Basalt","cursed_basalt.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Sinister Slate","sinister_slate.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Orange Apocalypse","orange_apocalypse.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Devil Stone","devil_stone.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Asbestos","asbestos.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Bleak Vanadium","bleak_vanadium.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Poisoned Aragonite","poisoned_aragonite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Purple Dunite","purple_dunite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Corrupted Agate","corrupted_agate.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Torched Aragonite","torched_aragonite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Forbidden Quartz","forbidden_quartz.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Violet Pyroxenite","violet_pyroxenite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Slate Soulstone","slate_soulstone.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Fractured Jasper","fractured_jasper.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Sky Quartz","sky_quartz.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Toxic Granite","toxic_granite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Corroded Ruby","corroded_ruby.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Offensive Shale","offensive_shale.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Petrified Flamingos","petrified_flamingos.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Crystallized Onyx","crystallized_onyx.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Orange Jasper","orange_jasper.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Satanic Slate","satanic_slate.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Malignant Pyrite","malignant_pyrite.png",!0,!0,f.COMMON)),l.push(new M(""+e++,"Pink Shale","pink_shale.png",!0,!0,f.COMMON)),l}var Ge=Ih(),Vl={},Ul={},zl={},Hl={},Wl={};function nr(l){if(l===X.EMPTY||l===X.SKY)return null;let e=Vl[l.id];return e||(e=new M(l.id+"_g","Gold","gold.png",!0,!0,f.GOLD),Vl[l.id]=e),e}function ar(l){if(l===X.EMPTY||l===X.SKY)return null;let e=Ul[l.id];return e||(e=new M(l.id+"_d","Ruby","ruby.png",!0,!0,f.RUBY),Ul[l.id]=e),e}function lr(l){if(l===X.EMPTY||l===X.SKY)return null;let e=Hl[l.id];return e||(e=new M(l.id+"_u","Upgrade","onyx.png",!0,!0,f.UPGRADE),Hl[l.id]=e),e}function hr(l){if(l===X.EMPTY||l===X.SKY)return null;let e=Wl[l.id];return e||(e=new M(l.id+"_s","Silver","silver.png",!0,!0,f.SILVER),Wl[l.id]=e),e}function dr(l){if(l===X.EMPTY||l===X.SKY)return null;let e=zl[l.id];return e||(e=new M(l.id+"_o","Ore","purple_ore.png",!0,!0,f.ORE),zl[l.id]=e),e}function tl(l,e){if(l[e.id]=e,e===X.EMPTY||e===X.SKY)return;let t=nr(e);l[t.id]=t;let i=dr(e);l[i.id]=i;let r=lr(e);l[r.id]=r;let s=ar(e);l[s.id]=s;let o=hr(e);l[o.id]=o}function Oh(){let l={};tl(l,X.SKY),tl(l,X.GRASS),tl(l,X.DIRT);for(let e=0;e<Ge.length;e++)tl(l,Ge[e]);return l}function xh(){X.SKY.openColor="#74c2ed33",X.GRASS.openColor="#709b1a33",X.GRASS.closedColor="#709b1a",X.DIRT.openColor="#56392733",X.DIRT.closedColor="#563927";for(let l=0;l<Ge.length;l++){let e=Ge[l];e.openColor="#41414133",e.closedColor="#414141"}}xh();var Yl=Oh();var jl=new ArrayBuffer(4),Kl=new Uint32Array(jl),Xl=new Float32Array(jl),U=class{constructor(){}static floor(e){if(e<0){let t=-this.floorPositive(-e);return e===t?t:t-1}else return this.floorPositive(e)}static floorPositive(e){return e<2147483648?e|0:Math.floor(e)}static len(e){return 1/this.invSqrt(e.x*e.x+e.y*e.y)}static nor(e){let t=this.len(e);return t!=0&&(e.x/=t,e.y/=t),e}static dist(e,t){let i=e.x-t.x,r=e.y-t.y;return 1/this.invSqrt(i*i+r*r)}static invSqrt(e){Xl[0]=e,Kl[0]=1597463007-(Kl[0]>>1);let t=Xl[0];return t*(1.5-.5*t*t*e)}};var F=class{constructor(){}resetFull(){}resetForPrestige(){}};var Ar=class extends F{constructor(){super(),this.origin=new P(0,0),this.grids=this.instantiateGrids();for(let e=0;e<this.grids.length;e++)this.grids[e].findTileNeighborsFull();this.changeCount=0,this.shiftCount=0}instantiateGrids(){let e=n.grid.gridPixelWidth,t=n.grid.gridPixelHeight,i=new Array(9);return i[0]=new ke(this,new P(-e,-t)),i[1]=new ke(this,new P(0,-t)),i[2]=new ke(this,new P(e,-t)),i[3]=new ke(this,new P(-e,0)),i[4]=new ke(this,new P(0,0)),i[5]=new ke(this,new P(e,0)),i[6]=new ke(this,new P(-e,t)),i[7]=new ke(this,new P(0,t)),i[8]=new ke(this,new P(e,t)),i}getGridTile(e,t){let i=this.getGrid(e,t);return i?i.getGridTile(e,t):null}getGrid(e,t){let i=e*n.tile.size,r=t*n.tile.size,s=this.grids[4];if(!s)return null;if(s.containsXY(i,r))return s;let o=s.origin.x,a=o+n.grid.gridPixelWidth,h=s.origin.y,u=h+n.grid.gridPixelHeight,m=null;return i>=o&&i<a?r<h?m=this.grids[1]:r>=u&&(m=this.grids[7]):i<s.origin.x?r>=h&&r<u?m=this.grids[3]:r<h?m=this.grids[0]:r>=u&&(m=this.grids[6]):i>=a&&(r>=h&&r<u?m=this.grids[5]:r<h?m=this.grids[2]:r>=u&&(m=this.grids[8])),m&&m.containsXY(i,r)?m:null}findGridContaining(e){let t=U.floor(e.x/n.tile.size),i=U.floor(e.y/n.tile.size);return this.getGrid(t,i)}findGridTile(e){let t=U.floor(e.x/n.tile.size),i=U.floor(e.y/n.tile.size);return this.getGridTile(t,i)}findGridTileXY(e,t){let i=U.floor(e/n.tile.size),r=U.floor(t/n.tile.size);return this.getGridTile(i,r)}findGridRegion(e){if(!this.groups)return null;let t=this.findGridTile(e);return t!=null?t.getRegion():null}resetFull(){this.changeCount=0,this.shiftCount=0}resetForPrestige(){this.resetFull()}};var Nr=class extends Je{constructor(e,t){super(t),this.zone=e,this.tiles=this.createTiles(),this.mineTiles=[],this.targetListNumber=-1}createTiles(){let e=new Array(n.grid.numTileColsInRegion*n.grid.numTileRowsInRegion),t=this.zone.grid,i=this.getOrigin(),r=i.x,s=i.y,o=0;for(let a=0;a<n.grid.numTileColsInRegion;a++)for(let h=0;h<n.grid.numTileRowsInRegion;h++)e[o++]=new Pr(t,this,new P(r+n.tile.size*a,s+n.tile.size*h));return e}initialize(e,t){this.origin.set(e,t);let i=this.origin.x,r=this.origin.y,s=0;for(let o=0;o<n.grid.numTileColsInRegion;o++)for(let a=0;a<n.grid.numTileRowsInRegion;a++)this.tiles[s++].initialize(i+n.tile.size*o,r+n.tile.size*a);this.mineTiles.length=0,this.targetListNumber=-1}getTileIndex(e){let t=e.getTileCol()-this.getOriginTileCol(),i=e.getTileRow()-this.getOriginTileRow();return t*n.grid.numTileRowsInRegion+i}getZone(){return this.zone}getGrid(){return this.zone.grid}getWorldGrid(){return this.zone.getWorldGrid()}getTiles(){return this.tiles}getPixelWidth(){return n.grid.regionPixelWidth}getPixelHeight(){return n.grid.regionPixelHeight}findGridTile(e){let t=U.floor(e.x/n.tile.size),i=U.floor(e.y/n.tile.size);return this.getGridTileAbsolute(t,i)}getGridTileAbsolute(e,t){let i=this.origin,r=U.floor(i.x/n.tile.size),s=U.floor(i.y/n.tile.size);return this.getGridTileLocal(e-r,t-s)}getGridTileLocal(e,t){if(e<0||e>=n.grid.numTileColsInRegion||t<0||t>=n.grid.numTileRowsInRegion)return null;let i=e*n.grid.numTileRowsInRegion+t;return i>=0&&i<this.tiles.length?this.tiles[i]:(console.log("GridRegion.getGridTileLocal() Failed to find tile. col="+e+" row="+t+" index="+i),null)}findTileNeighborsFull(){for(let e=0;e<this.tiles.length;e++)this.tiles[e].findNeighbors()}getTile(e,t){return this.tiles[e*n.grid.numTileRowsInRegion+t]}findRegionBorderTileNeighbors(){let e=n.grid.numTileColsInRegion-1,t=n.grid.numTileRowsInRegion-1,i=0,r=0;this.getTile(e,t).findNeighbors(),this.getTile(e,i).findNeighbors(),this.getTile(r,t).findNeighbors(),this.getTile(r,i).findNeighbors();for(let s=1;s<n.grid.numTileRowsInRegion-1;s++)this.getTile(e,s).findNeighbors();for(let s=1;s<n.grid.numTileRowsInRegion-1;s++)this.getTile(r,s).findNeighbors();for(let s=1;s<n.grid.numTileColsInRegion-1;s++)this.getTile(s,i).findNeighbors();for(let s=1;s<n.grid.numTileColsInRegion-1;s++)this.getTile(s,t).findNeighbors()}findTileNeighborsBorderRight(){let e=n.grid.numTileColsInRegion-1;for(let t=0;t<n.grid.numTileRowsInRegion;t++)this.getTile(e,t).findNeighborRight()}nullifyTileNeighborsBorderRight(){let e=n.grid.numTileColsInRegion-1;for(let t=0;t<n.grid.numTileRowsInRegion;t++)this.getTile(e,t).nullifyNeighborRight()}evaluateTileBordersRight(){let e=n.grid.numTileColsInRegion-1;for(let t=0;t<n.grid.numTileRowsInRegion;t++)this.getTile(e,t).evaluateBorders()}findTileNeighborsBorderLeft(){for(let e=0;e<n.grid.numTileRowsInRegion;e++)this.getTile(0,e).findNeighborLeft()}nullifyTileNeighborsBorderLeft(){for(let e=0;e<n.grid.numTileRowsInRegion;e++)this.getTile(0,e).nullifyNeighborLeft()}evaluateTileBordersLeft(){for(let e=0;e<n.grid.numTileRowsInRegion;e++)this.getTile(0,e).evaluateBorders()}findTileNeighborsBorderBottom(){let e=n.grid.numTileRowsInRegion-1;for(let t=0;t<n.grid.numTileColsInRegion;t++)this.getTile(t,e).findNeighborBottom()}nullifyTileNeighborsBorderBottom(){let e=n.grid.numTileRowsInRegion-1;for(let t=0;t<n.grid.numTileColsInRegion;t++)this.getTile(t,e).nullifyNeighborBottom()}evaluateTileBordersBottom(){let e=n.grid.numTileRowsInRegion-1;for(let t=0;t<n.grid.numTileColsInRegion;t++)this.getTile(t,e).evaluateBorders()}findTileNeighborsBorderTop(){for(let e=0;e<n.grid.numTileColsInRegion;e++)this.getTile(e,0).findNeighborTop()}nullifyTileNeighborsBorderTop(){for(let e=0;e<n.grid.numTileColsInRegion;e++)this.getTile(e,0).nullifyNeighborTop()}evaluateTileBordersTop(){for(let e=0;e<n.grid.numTileColsInRegion;e++)this.getTile(e,0).evaluateBorders()}};var il=["00","01","02","03","04","05","06","07","08","09","0A","0B","0C","0D","0E","0F","10","11","12","13","14","15","16","17","18","19","1A","1B","1C","1D","1E","1F","20","21","22","23","24","25","26","27","28","29","2A","2B","2C","2D","2E","2F","30","31","32","33","34","35","36","37","38","39","3A","3B","3C","3D","3E","3F","40","41","42","43","44","45","46","47","48","49","4A","4B","4C","4D","4E","4F","50","51","52","53","54","55","56","57","58","59","5A","5B","5C","5D","5E","5F","60","61","62","63","64","65","66","67","68","69","6A","6B","6C","6D","6E","6F","70","71","72","73","74","75","76","77","78","79","7A","7B","7C","7D","7E","7F","80","81","82","83","84","85","86","87","88","89","8A","8B","8C","8D","8E","8F","90","91","92","93","94","95","96","97","98","99","9A","9B","9C","9D","9E","9F","A0","A1","A2","A3","A4","A5","A6","A7","A8","A9","AA","AB","AC","AD","AE","AF","B0","B1","B2","B3","B4","B5","B6","B7","B8","B9","BA","BB","BC","BD","BE","BF","C0","C1","C2","C3","C4","C5","C6","C7","C8","C9","CA","CB","CC","CD","CE","CF","D0","D1","D2","D3","D4","D5","D6","D7","D8","D9","DA","DB","DC","DD","DE","DF","E0","E1","E2","E3","E4","E5","E6","E7","E8","E9","EA","EB","EC","ED","EE","EF","F0","F1","F2","F3","F4","F5","F6","F7","F8","F9","FA","FB","FC","FD","FE","FF"],j=class l{constructor(e,t,i,r){this.r=e,this.g=t,this.b=i,this.a=r,this.fillColor=null,this.clamp()}static createColor(e){let t=(e&4278190080)>>24,i=(e&16711680)>>16,r=(e&65280)>>8,s=e&255;return new l(t/255,i/255,r/255,s/255)}set(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this.fillColor=null}setAlpha(e){this.a=e}addAlpha(e){this.a+=e,this.a>1&&(this.a=1)}reset(){this.r=0,this.g=0,this.b=0,this.a=0}setRgba(e,t,i,r){this.r=e,this.g=t,this.b=i,this.a=r,this.clamp(),this.fillColor=null}setRgbaFast(e,t,i,r){this.r=e,this.g=t,this.b=i,this.a=r,this.fillColor=null}resetFast(){this.r=0,this.g=0,this.b=0,this.a=0,this.fillColor=null}mul(e){this.r*=e,this.g*=e,this.b*=e,this.a*=e,this.clamp(),this.fillColor=null}add(e){this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this.clamp(),this.fillColor=null}addFast(e){this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this.fillColor=null}addRgba(e,t,i,r){this.r+=e,this.g+=t,this.b+=i,this.a+=r,this.clamp(),this.fillColor=null}addFastRgba(e,t,i,r){this.r+=e,this.g+=t,this.b+=i,this.a+=r,this.fillColor=null}getFillColor(){return this.fillColor||(this.fillColor=this.createFillColor()),this.fillColor}createFillColor(){let e=(1-this.a)*255|0,t=this.r*255|0,i=this.g*255|0,r=this.b*255|0;return"#"+il[t]+il[i]+il[r]+il[e]}clamp(){this.r<0?this.r=0:this.r>1&&(this.r=1),this.g<0?this.g=0:this.g>1&&(this.g=1),this.b<0?this.b=0:this.b>1&&(this.b=1),this.a<0?this.a=0:this.a>1&&(this.a=1)}};var Dh=new j(0,0,0,.3),yr=class{constructor(){this.everVisibleToCharacter=!1,this.currentlyVisibleToCharacter=!1,this.environmentLighting=new j(0,0,0,0),this.dynamicLighting=new j(0,0,0,0),this.positionalLighting=new j(0,0,0,0),this.shadowColor=new j(0,0,0,0),this.sunlightFull=!1,this.sunlightPartial=0}resetLighting(){this.dynamicLighting.resetFast(),this.environmentLighting.resetFast(),this.positionalLighting.resetFast(),this.currentlyVisibleToCharacter=!1}resetPositionalLighting(){this.positionalLighting.resetFast(),this.currentlyVisibleToCharacter=!1}resetEnvironmentLighting(){this.environmentLighting.resetFast()}resetDynamicLighting(){this.dynamicLighting.resetFast()}addPositionalLighting(e){this.positionalLighting.add(e)}addEnvironmentLighting(e){this.environmentLighting.add(e)}addDynamicLighting(e){this.dynamicLighting.add(e)}markTileAsCurrentlyVisible(){this.currentlyVisibleToCharacter=!0,this.everVisibleToCharacter=!0}markAsSunlightFull(){this.sunlightFull=!0,this.everVisibleToCharacter=!0}isSunlightPartial(){return this.sunlightPartial>0}sunlightPartialIncrement(){this.sunlightPartial++,this.everVisibleToCharacter=!0}sunlightPartialDecrement(){this.sunlightPartial>0&&this.sunlightPartial--}calculateShadowColor(){return this.shadowColor.set(Dh),this.currentlyVisibleToCharacter&&(this.shadowColor.addFast(this.environmentLighting),this.shadowColor.addFast(this.dynamicLighting),this.shadowColor.addFast(this.positionalLighting),this.shadowColor.clamp()),this.sunlightFull?this.shadowColor.setAlpha(1):this.sunlightPartial>0&&this.shadowColor.addAlpha(.3),this.shadowColor}reset(){this.everVisibleToCharacter=!1,this.currentlyVisibleToCharacter=!1,this.sunlightFull=!1,this.sunlightPartial=0}};var ye={PRIORITY:100,COMMON_REVEAL_CAVERN:5,COMMON_HIDDEN_NEIGHBOR:3,WORTHLESS:0,IN_RANGE_OPEN:-10,IN_RANGE_UNSEEN:-20,UNSET:-1e3};var br=class{constructor(){this.pathNumber=0,this.closed=!1,this.cameFrom=null,this.cost=0,this.score=0,this.inOpenList=!1,this.mineScore=-1,this.mineTargetListNumber=-1}getCameFrom(e){return this.pathNumber!=e&&this.reset(e),this.cameFrom}set(e,t,i,r){this.pathNumber!=r&&this.reset(r),this.cameFrom=e,this.cost=t,this.score=i}getCost(e){return this.pathNumber!=e&&this.reset(e),this.cost}setCost(e,t){this.pathNumber!=t&&this.reset(t),this.cost=e}getScore(e){return this.pathNumber!=e&&this.reset(e),this.score}setClosed(e,t){this.pathNumber!=t&&this.reset(t),this.closed=e}isClosed(e){return this.pathNumber!=e&&this.reset(e),this.closed}setInOpenList(e,t){this.pathNumber!=t&&this.reset(t),this.inOpenList=e}isInOpenList(e){return this.pathNumber!=e&&this.reset(e),this.inOpenList}getMineScore(e){return this.mineTargetListNumber!=e?ye.UNSET:this.mineScore}setMineScore(e,t){this.mineTargetListNumber=t,this.mineScore=e}reset(e){this.pathNumber=e,this.closed=!1,this.cameFrom=null,this.cost=0,this.score=0,this.inOpenList=!1}};var Ir=class{constructor(e,t,i,r){this.spriteName=e,this.traversable=t,this.opaque=i,this.stateSavable=r,this.sprite=null}};var Ye=0,Ke=1,nt=2,at=3,bl=new c(0),Pr=class extends Je{constructor(e,t,i){super(i),this.grid=e,this.region=t,this.sprite=null,this.backgroundSprite=null,this.neighbors=new Array(4),this.neighbors[Ye]=null,this.neighbors[Ke]=null,this.neighbors[nt]=null,this.neighbors[at]=null,this.tileType=X.EMPTY,this.tileTemplate=null,this.borderCode=0,this.open=!1,this.fixtureDescription=null,this.lighting=new yr,this.pathData=new br,this.initialHealth=null,this.health=null,this.healthPercent=100,this.mineTileIndex=-1}initialize(e,t){this.origin.set(e,t),this.tileType=X.EMPTY,this.tileTemplate=null,this.sprite=null,this.fixtureDescription=null,this.backgroundSprite=null,this.open=!1,this.mineTileIndex=-1,this.health=null,this.initialHealth=null,this.healthPercent=100,this.lighting.reset()}tileInit(e,t){this.borderCode=-1,this.open=e,this.setTileType(t)}setTileType(e){if(!e){console.log("GridTyple.setTileType is null");return}this.tileType!==e&&(this.tileType=e,this.tileTemplate=e.getRandomTemplate(),this.tileTemplate&&!this.open&&this.borderCode!=-1&&(this.sprite=this.tileTemplate.getTileSprite(this.borderCode)))}getHealth(){return this.open?null:(this.health||this.calculateTileHealth(),this.health)}calculateTileGold(e){if(this.tileType.rarityModifier!==f.GOLD){e.setZero();return}e.copy(this.tileType.layerDescription.baseGold)}calculateTileHealth(){this.open?this.health=null:(this.health=new c(0),this.tileType.layerDescription.calculateTileHealth(this.getTileRow(),this.health),this.initialHealth=new c(0),this.initialHealth.copy(this.health))}isCommon(){return this.tileType.rarityModifier===f.COMMON}isPriority(){return this.tileType.rarityModifier!==f.COMMON&&this.tileType.rarityModifier!==f.UNSET}getGrid(){return this.grid}getRegion(){return this.region}getWorldGrid(){return this.grid.getWorldGrid()}getSprite(){return this.sprite}setSprite(e){this.sprite=e}createCenterPositionVector(){let e=new P(0,0);return this.assignCenterPosition(e),e}assignCenterPosition(e){e.set(this.origin.x+n.tile.halfSize,this.origin.y+n.tile.halfSize)}isTraversable(){return this.open?!this.fixtureDescription||this.fixtureDescription.traversable:!1}isOpaque(){return this.open?this.fixtureDescription&&this.fixtureDescription.opaque:this.tileType.opaque}getPixelWidth(){return n.tile.size}getPixelHeight(){return n.tile.size}getTileCol(){return this.getOriginTileCol()}getTileRow(){return this.getOriginTileRow()}createId(){return this.getTileCol()+"_"+this.getTileRow()}getNeighbors(){return this.neighbors}findNeighbors(){this.neighbors[0]=null,this.neighbors[1]=null,this.neighbors[2]=null,this.neighbors[3]=null;let e=this.getTileCol(),t=this.getTileRow(),i=this.getNeighborColRow(e,t-1);i&&(this.neighbors[Ye]=i,i.neighbors[Ke]=this);let r=this.getNeighborColRow(e,t+1);r&&(this.neighbors[Ke]=r,r.neighbors[Ye]=this);let s=this.getNeighborColRow(e+1,t);s&&(this.neighbors[nt]=s,s.neighbors[at]=this);let o=this.getNeighborColRow(e-1,t);o&&(this.neighbors[at]=o,o.neighbors[nt]=this)}nullifyNeighborRight(){this.neighbors[nt]=null}nullifyNeighborLeft(){this.neighbors[at]=null}nullifyNeighborBottom(){this.neighbors[Ke]=null}nullifyNeighborTop(){this.neighbors[Ye]=null}findNeighborRight(){this.neighbors[nt]=null;let e=this.getTileCol(),t=this.getTileRow(),i=this.getNeighborColRow(e+1,t);i&&(this.neighbors[nt]=i,i.neighbors[at]=this)}findNeighborLeft(){this.neighbors[at]=null;let e=this.getTileCol(),t=this.getTileRow(),i=this.getNeighborColRow(e-1,t);i&&(this.neighbors[at]=i,i.neighbors[nt]=this)}findNeighborTop(){this.neighbors[Ye]=null;let e=this.getTileCol(),t=this.getTileRow(),i=this.getNeighborColRow(e,t-1);i&&(this.neighbors[Ye]=i,i.neighbors[Ke]=this)}findNeighborBottom(){this.neighbors[Ke]=null;let e=this.getTileCol(),t=this.getTileRow(),i=this.getNeighborColRow(e,t+1);i&&(this.neighbors[Ke]=i,i.neighbors[Ye]=this)}isAdjacentTo(e){let t=this.getTileRow(),i=e.getTileRow();if(Math.abs(t-i)>1)return!1;let r=this.getTileCol(),s=e.getTileCol();return!(Math.abs(r-s)>1)}isNeighborTile(e){return e===this.neighbors[0]||e===this.neighbors[1]||e===this.neighbors[2]||e===this.neighbors[3]}getNeighborColRow(e,t){let i=this.region.getGridTileAbsolute(e,t);if(!i){let r=this.region.zone;i=r.getGridTileAbsolute(e,t),i||(i=r.grid.getGridTileAbsolute(e,t),i||(i=r.grid.worldGrid.getGridTile(e,t)))}return i}getNeighbor(e){if(this.contains(e))return this;let t=this.findNeighborContaining(e);if(t)return t;let i=U.floor(e.x/n.tile.size),r=U.floor(e.y/n.tile.size);return this.getNeighborColRow(i,r)}getNeighborLeft(){return this.neighbors[at]}getNeighborRight(){return this.neighbors[nt]}getNeighborTop(){return this.neighbors[Ye]}getNeighborBottom(){return this.neighbors[Ke]}getNeighborTopLeft(){let e=this.neighbors[Ye];return e?e.getNeighborLeft():null}getNeighborTopRight(){let e=this.neighbors[Ye];return e?e.getNeighborRight():null}getNeighborBottomLeft(){let e=this.neighbors[Ke];return e?e.getNeighborLeft():null}getNeighborBottomRight(){let e=this.neighbors[Ke];return e?e.getNeighborRight():null}isNeighborLeft(e){return e===this.neighbors[at]}isNeighborRight(e){return e===this.neighbors[nt]}isNeighborTop(e){return e===this.neighbors[Ye]}isNeighborBottom(e){return e===this.neighbors[Ke]}findNeighborContaining(e){for(let o=0;o<this.neighbors.length;o++){let a=this.neighbors[o];if(a&&a.contains(e))return a}let t=this.getNeighborTopLeft();if(t&&t.contains(e))return t;let i=this.getNeighborTopRight();if(i&&i.contains(e))return i;let r=this.getNeighborBottomLeft();if(r&&r.contains(e))return r;let s=this.getNeighborBottomRight();return s&&s.contains(e)?s:null}findRelativeTile(e,t){let i=this.getGrid().getWorldGrid(),r=this.getTileCol()+e,s=this.getTileRow()+t;return i.getGridTile(r,s)}evaluateBorders(){if(this.open)this.borderCode=0,this.sprite=null;else{let e=this.borderCode,t=this.neighbors[Ye],i=this.neighbors[Ke],r=this.neighbors[nt],s=this.neighbors[at],o=t&&t.open?1:0,a=i&&i.open?2:0,h=s&&s.open?4:0,u=r&&r.open?8:0;this.borderCode=o+a+h+u,e!==this.borderCode&&this.tileTemplate&&(this.sprite=this.tileTemplate.getTileSprite(this.borderCode))}}onTileDamaged(e){this.open||!e||(this.health||this.calculateTileHealth(),this.health.sub(e),this.health.lessThanEqualsZero()?this.onTileBreak():this.healthPercent=this.calculateHealthPercent())}calculateHealthPercent(){return this.open?0:this.health?this.health.equalsZero()?0:(bl.copy(this.health),bl.divide(this.initialHealth),bl.toNumber()*100|0):100}isTileDamaged(){return this.open||!this.health?!1:!this.health.equals(this.initialHealth)}onTileBreak(){if(!this.open){this.open=!0,this.borderCode=-1,this.evaluateBorders(),this.handleTileOpened();let e=this.getNeighborTop();e&&e.open&&e.fixtureDescription&&(e.fixtureDescription=null);let t=this.getNeighborBottom();t&&t.open&&t.fixtureDescription&&(t.fixtureDescription=null),this.pathData.mineScore=0,this.pathData.mineTargetListNumber=0,this.health=null,this.initialHealth=null,this.healthPercent=0,this.mineTileIndex>=0&&(this.region.mineTiles[this.mineTileIndex]=null,this.mineTileIndex=-1),this.getGrid().markGridAsChanged()}for(let e=0;e<this.neighbors.length;e++){let t=this.neighbors[e];t&&t.evaluateBorders()}}handleTileOpened(){if(!this.open)return;let e=this.getNeighborTop();e&&e.open&&e.lighting.sunlightFull&&this.handleSunlightStart()}handleSunlightStart(){this.markAsSunlightFull();let e=this.getNeighborLeft();e&&!e.lighting.sunlightFull&&e.lighting.sunlightPartialIncrement();let t=this.getNeighborRight();if(t&&!t.lighting.sunlightFull&&t.lighting.sunlightPartialIncrement(),!this.open)return;let i=this.getNeighborBottom();i&&!i.lighting.sunlightFull&&i.handleSunlightStart()}handleSunlightStop(){this.lighting.sunlightFull=!1;let e=this.getNeighborLeft();e&&e.lighting.sunlightPartialDecrement();let t=this.getNeighborRight();if(t&&t.lighting.sunlightPartialDecrement(),!this.open)return;let i=this.getNeighborBottom();i&&i.lighting.sunlightFull&&i.handleSunlightStop()}markTileAsEverVisible(){this.lighting.everVisibleToCharacter=!0,this.mineTileIndex<0&&!this.open&&this.isPriority()&&(this.region.mineTiles.push(this),this.mineTileIndex=this.region.mineTiles.length-1)}markTileAsCurrentlyVisible(){this.lighting.markTileAsCurrentlyVisible(),this.mineTileIndex<0&&!this.open&&this.isPriority()&&(this.region.mineTiles.push(this),this.mineTileIndex=this.region.mineTiles.length-1)}markAsSunlightFull(){this.lighting.markAsSunlightFull(),this.mineTileIndex<0&&!this.open&&this.isPriority()&&(this.region.mineTiles.push(this),this.mineTileIndex=this.region.mineTiles.length-1)}addPositionalLighting(e){this.lighting.addPositionalLighting(e),this.markTileAsCurrentlyVisible()}addEnvironmentLighting(e){this.lighting.addEnvironmentLighting(e),this.markTileAsEverVisible()}addDynamicLighting(e){this.lighting.addDynamicLighting(e),this.markTileAsEverVisible()}hash(){let e=this.origin.x/n.tile.size,t=this.origin.y/n.tile.size,i=17;return i=31*i+e,i=31*i+t,i}};var Or=class extends Je{constructor(e,t){super(t),this.grid=e,this.regions=this.createRegions()}createRegions(){let e=this.getOrigin(),t=e.x,i=e.y,r=new Array(n.grid.numRegionColsInZone*n.grid.numRegionRowsInZone),s=0;for(let o=0;o<n.grid.numRegionColsInZone;o++)for(let a=0;a<n.grid.numRegionRowsInZone;a++)r[s++]=new Nr(this,new P(t+n.grid.regionPixelWidth*o,i+n.grid.regionPixelHeight*a));return r}initialize(e,t){this.origin.set(e,t);let i=this.origin.x,r=this.origin.y,s=0;for(let o=0;o<n.grid.numRegionColsInZone;o++)for(let a=0;a<n.grid.numRegionRowsInZone;a++)this.regions[s++].initialize(i+n.grid.regionPixelWidth*o,r+n.grid.regionPixelHeight*a)}getWorldGrid(){return this.grid.getWorldGrid()}getGrid(){return this.grid}getRegions(){return this.regions}getPixelWidth(){return n.grid.zonePixelWidth}getPixelHeight(){return n.grid.zonePixelHeight}getGridTileAbsolute(e,t){let i=this.origin,r=U.floor(i.x/n.tile.size),s=U.floor(i.y/n.tile.size);return this.getGridTileLocal(e-r,t-s)}getGridTileLocal(e,t){let i=U.floor(e/n.grid.regionTileWidth),r=U.floor(t/n.grid.regionTileHeight);if(i<0||i>=n.grid.numRegionColsInZone||r<0||r>=n.grid.numRegionRowsInZone)return null;let s=i*n.grid.numRegionRowsInZone+r;if(s>=0&&s<this.regions.length){let o=this.regions[s],a=this.getOrigin(),h=U.floor(a.x/n.tile.size),u=U.floor(a.y/n.tile.size),m=o.getOrigin(),g=U.floor(m.x/n.tile.size),_=U.floor(m.y/n.tile.size);return o.getGridTileLocal(e+h-g,t+u-_)}else return console.log("GridZone.getGridTileLocal() Failed to find tile. col="+e+" row="+t+" index="+s),null}findTileNeighborsFull(){for(let e=0;e<this.regions.length;e++)this.regions[e].findTileNeighborsFull()}findRegionNeighborsBorderEast(){let e=n.grid.numRegionColsInZone-1;for(let t=0;t<n.grid.numRegionRowsInZone;t++)this.findRegion(e,t).findTileNeighborsBorderRight()}findRegionNeighborsBorderWest(){for(let e=0;e<n.grid.numRegionRowsInZone;e++)this.findRegion(0,e).findTileNeighborsBorderLeft()}findRegionNeighborsBorderSouth(){let e=n.grid.numRegionColsInZone-1;for(let t=0;t<n.grid.numRegionColsInZone;t++)this.findRegion(t,e).findTileNeighborsBorderBottom()}findRegionNeighborsBorderNorth(){for(let e=0;e<n.grid.numRegionColsInZone;e++)this.findRegion(e,0).findTileNeighborsBorderTop()}findRegion(e,t){return this.regions[e*n.grid.numRegionRowsInZone+t]}findZoneBorderRegionNeighbors(){let e=n.grid.numRegionColsInZone-1,t=n.grid.numRegionRowsInZone-1,i=0,r=0,s=this.findRegion(e,t),o=this.findRegion(e,i),a=this.findRegion(r,t),h=this.findRegion(r,i);if(s.findTileNeighborsBorderTop(),s.findTileNeighborsBorderRight(),o.findTileNeighborsBorderBottom(),o.findTileNeighborsBorderRight(),a.findTileNeighborsBorderTop(),a.findTileNeighborsBorderLeft(),h.findTileNeighborsBorderBottom(),h.findTileNeighborsBorderLeft(),n.grid.numRegionRowsInZone>2){for(let u=1;u<n.grid.numRegionRowsInZone-1;u++)this.findRegion(e,u).findTileNeighborsBorderRight();for(let u=1;u<n.grid.numRegionRowsInZone-1;u++)this.findRegion(r,u).findTileNeighborsBorderLeft()}if(n.grid.numRegionColsInZone>2){for(let u=1;u<n.grid.numRegionColsInZone-1;u++)this.findRegion(u,i).findTileNeighborsBorderBottom();for(let u=1;u<n.grid.numRegionColsInZone-1;u++)this.findRegion(u,t).findTileNeighborsBorderTop()}}findTileNeighborsZoneBorderRight(){let e=n.grid.numRegionColsInZone-1;for(let t=0;t<n.grid.numRegionRowsInZone;t++)this.findRegion(e,t).findTileNeighborsBorderRight()}nullifyTileNeighborsZoneBorderRight(){let e=n.grid.numRegionColsInZone-1;for(let t=0;t<n.grid.numRegionRowsInZone;t++)this.findRegion(e,t).nullifyTileNeighborsBorderRight()}findTileNeighborsZoneBorderLeft(){for(let e=0;e<n.grid.numRegionRowsInZone;e++)this.findRegion(0,e).findTileNeighborsBorderLeft()}nullifyTileNeighborsZoneBorderLeft(){for(let e=0;e<n.grid.numRegionRowsInZone;e++)this.findRegion(0,e).nullifyTileNeighborsBorderLeft()}findTileNeighborsZoneBorderBottom(){let e=n.grid.numRegionRowsInZone-1;for(let t=0;t<n.grid.numRegionColsInZone;t++)this.findRegion(t,e).findTileNeighborsBorderBottom()}nullifyTileNeighborsZoneBorderBottom(){let e=n.grid.numRegionRowsInZone-1;for(let t=0;t<n.grid.numRegionColsInZone;t++)this.findRegion(t,e).nullifyTileNeighborsBorderBottom()}findTileNeighborsZoneBorderTop(){for(let e=0;e<n.grid.numRegionColsInZone;e++)this.findRegion(e,0).findTileNeighborsBorderTop()}nullifyTileNeighborsZoneBorderTop(){for(let e=0;e<n.grid.numRegionColsInZone;e++)this.findRegion(e,0).nullifyTileNeighborsBorderTop()}evaluateTileBordersRight(){let e=n.grid.numRegionColsInZone-1;for(let t=0;t<n.grid.numRegionRowsInZone;t++)this.findRegion(e,t).evaluateTileBordersRight()}evaluateTileBordersLeft(){for(let e=0;e<n.grid.numRegionRowsInZone;e++)this.findRegion(0,e).evaluateTileBordersLeft()}evaluateTileBordersBottom(){let e=n.grid.numRegionRowsInZone-1;for(let t=0;t<n.grid.numRegionColsInZone;t++)this.findRegion(t,e).evaluateTileBordersBottom()}evaluateTileBordersTop(){for(let e=0;e<n.grid.numRegionColsInZone;e++)this.findRegion(e,0).evaluateTileBordersTop()}};var xr=class extends F{constructor(){super(),this.gridCenter=new P(n.start.startX,n.start.startY),this.stayCenteredOnCharacter=!0,this.screenOrigin=new P(0,0),this.visibleHalfWidth=0,this.visibleHalfHeight=0,this.visibleHalfWidthWorld=0,this.visibleHalfHeightWorld=0,this.screenScaleFactor=1,this.zoom=n.projection.zoomDefault,this.canvas=null}setCanvas(e){this.canvas=e}resetProjectionState(){this.setGridCenter(n.projection.startCenterX,n.projection.startCenterY),this.zoom=n.projection.zoomDefault,this.canvas=null}setGridCenter(e,t){this.gridCenter.set(e,t)}updateSpaceCenter(e,t){this.gridCenter.addXY(e,t)}updateProjectionForFrame(){this.canvas&&(this.visibleHalfWidth=this.canvas.width/2,this.visibleHalfHeight=this.canvas.height/2,this.visibleHalfWidthWorld=this.visibleHalfWidth/this.zoom,this.visibleHalfHeightWorld=this.visibleHalfHeight/this.zoom,this.screenOrigin.set(this.zoom*this.gridCenter.x-this.visibleHalfWidth,this.zoom*this.gridCenter.y-this.visibleHalfHeight),this.screenOrigin.x=this.screenOrigin.x|0,this.screenOrigin.y=this.screenOrigin.y|0)}screenToWorldDistance(e){return e/this.zoom}screenToWorld(e,t){var i=1/this.zoom;t.set(i*(this.screenOrigin.x+e.x),i*(this.screenOrigin.y+e.y))}worldToScreen(e,t){t.x=this.zoom*e.x-this.screenOrigin.x,t.y=this.zoom*e.y-this.screenOrigin.y}setZoom(e){this.zoom=e,this.zoom<n.projection.zoomOutScaleLimit&&(this.zoom=n.projection.zoomOutScaleLimit),this.zoom>n.projection.zoomInScaleLimit&&(this.zoom=n.projection.zoomInScaleLimit)}zoomOut(){this.zoom-=n.projection.zoomStep,this.zoom<n.projection.zoomOutScaleLimit&&(this.zoom=n.projection.zoomOutScaleLimit)}zoomIn(){this.zoom+=n.projection.zoomStep,this.zoom>n.projection.zoomInScaleLimit&&(this.zoom=n.projection.zoomInScaleLimit)}isNearby(e,t,i){return this.isNearbyX(e.origin.x,e.getPixelWidth(),t,i)&&this.isNearbyY(e.origin.y,e.getPixelHeight(),t,i)}isNearbyXY(e,t,i,r){return this.isNearbyX(e,1,i,r)&&this.isNearbyY(t,1,i,r)}isVisible(e,t){return this.isVisibleX(e.x,t)&&this.isVisibleY(e.y,t)}isVisibleXY(e,t,i){return this.isVisibleX(e,i)&&this.isVisibleY(t,i)}isVisibleGridBox(e){return this.isVisibleX(e.origin.x,e.getPixelWidth())&&this.isVisibleY(e.origin.y,e.getPixelHeight())}isVisibleX(e,t){return e<this.gridCenter.x+this.visibleHalfWidthWorld&&e+t>=this.gridCenter.x-this.visibleHalfWidthWorld}isVisibleY(e,t){return e<this.gridCenter.y+this.visibleHalfHeightWorld&&e+t>=this.gridCenter.y-this.visibleHalfHeightWorld}getMaxVisibleHalfWidth(){return Math.max(this.visibleHalfHeightWorld,this.visibleHalfWidthWorld)}isNearbyX(e,t,i,r){return e<i.x+r&&e+t>=i.x-r}isNearbyY(e,t,i,r){return e<i.y+r&&e+t>=i.y-r}clampToScreen(e,t,i){let r=Math.min(Math.max(e.x,0),this.canvas.width-t),s=Math.min(Math.max(e.y,0),this.canvas.height-i);e.set(r,s)}resetFull(){this.resetProjectionState()}resetForPrestige(){this.resetProjectionState()}};var ie=class{constructor(){}static allVisibleGrids(e,t,i){let r=e.grids;for(let s=0;s<r.length;s++){let o=r[s];o&&o.loaded&&t.isVisibleGridBox(o)&&i(o)}}static allVisibleRegions(e,t,i){let r=e.grids;for(let s=0;s<r.length;s++){let o=r[s];o&&o.loaded&&t.isVisibleGridBox(o)&&this.allVisibleRegionsInGrid(o,t,i)}}static allVisibleTiles(e,t,i){let r=e.grids;for(let s=0;s<r.length;s++){let o=r[s];o&&t.isVisibleGridBox(o)&&this.allVisibleTilesInGrid(o,t,i)}}static allNearbyRegions(e,t,i,r,s){let o=e.grids;for(let a=0;a<o.length;a++){let h=o[a];!h||!h.isLoaded()||(h.contains(i)||t.isNearby(h,i,r))&&this.allNearbyRegionsInGrid(h,t,s,i,r)}}static allVisibleTilesInGrid(e,t,i){if(!e)return;let r=e.zones;for(let s=0;s<r.length;s++){let o=r[s];if(t.isVisibleGridBox(o)){let a=o.getRegions();for(let h=0;h<a.length;h++){let u=a[h];if(t.isVisibleGridBox(u)){let m=u.getTiles();for(let g=0;g<m.length;g++){let _=m[g];t.isVisibleGridBox(_)&&i(_)}}}}}}static allTilesInGrid(e,t){if(!e)return;let i=e.zones;for(let r=0;r<i.length;r++){let s=i[r].getRegions();for(let o=0;o<s.length;o++){let a=s[o].getTiles();for(let h=0;h<a.length;h++)t(a[h])}}}static allTilesInGridZone(e,t){if(!e)return;let i=e.getRegions();for(let r=0;r<i.length;r++){let s=i[r].getTiles();for(let o=0;o<s.length;o++)t(s[o])}}static allVisibleRegionsInGrid(e,t,i){if(!e)return;let r=e.zones;for(let s=0;s<r.length;s++){let o=r[s];if(t.isVisibleGridBox(o)){let a=o.getRegions();for(let h=0;h<a.length;h++){let u=a[h];t.isVisibleGridBox(u)&&i(u)}}}}static allNearbyRegionsInGrid(e,t,i,r,s){if(!e)return;let o=e.zones;for(let a=0;a<o.length;a++){let h=o[a];if(t.isNearby(h,r,s)){let u=h.getRegions();for(let m=0;m<u.length;m++){let g=u[m];t.isNearby(g,r,s)&&i(g)}}}}static allRegionsInGrid(e,t){if(!e)return;let i=e.zones;for(let r=0;r<i.length;r++){let o=i[r].getRegions();for(let a=0;a<o.length;a++)t(o[a])}}};var Ut=class extends qe{constructor(){super(),this.color=null,this.radius=0,this.tile=null}set(e,t,i){this.tile=e,this.color=t,this.radius=i}getTile(){return this.tile}setTile(e){this.tile=e}getColor(){return this.color}getTileRadius(){return this.radius}reset(e){super.reset(e),this.color=null,this.radius=0,this.tile=null}};var rl=0,sl=1,ol=2,nl=3,ke=class extends Je{constructor(e,t){super(t),this.worldGrid=e,this.gridChangeCount=0,this.zones=this.createZoneArray(),this.neighbors=new Array(4),this.neighbors[rl]=null,this.neighbors[sl]=null,this.neighbors[ol]=null,this.neighbors[nl]=null,this.characters=[],this.lightSources=[],this.loaded=!1}createZoneArray(){let e=new Array(n.grid.numZoneColsInGrid*n.grid.numZoneRowsInGrid),t=this.origin,i=t.x,r=t.y,s=0;for(let o=0;o<n.grid.numZoneColsInGrid;o++)for(let a=0;a<n.grid.numZoneRowsInGrid;a++)e[s++]=new Or(this,new P(i+n.grid.zonePixelWidth*o,r+n.grid.zonePixelHeight*a));return e}unloadGrid(){if(this.characters.length>0){let e=this.characters.length;for(let t=e-1;t>=0;t--){let i=this.characters[t];i.isMonster()?i.isFinishedAndAvailable()||i.reset(!0):i.isPartyMember()&&(console.log("Grid.unloadGrid() party character is in grid that is being unloaded."),i.position.resetFull(),i.resetTurnState())}this.characters.length=0}if(this.lightSources!=null){let e=this.lightSources.length;for(let t=e-1;t>=0;t--){let i=this.lightSources[t];i.isFinishedAndAvailable()||i.reset(!0)}this.lightSources.length=0}this.loaded=!1}getLightSources(){return this.lightSources}addLightSource(e){this.lightSources.push(e)}removeLightSource(e){if(this.lightSources==null||this.lightSources.length===0||!e)return;let t=this.lightSources.indexOf(e);t>=0&&this.lightSources.splice(t,1)}removeLightSourceForTile(e){if(!(this.lightSources==null||this.lightSources.length===0||e==null)){for(let t=0;t<this.lightSources.length;t++)if(this.lightSources[t].getTile()===e){this.lightSources.splice[1];break}}}addCharacter(e){e&&this.characters.push(e)}removeCharacter(e){if(e){let t=this.characters.indexOf(e);t!==-1&&this.characters.splice(t,1)}}initializeZonesForGrid(){this.gridChangeCount=0;let e=this.zones,t=this.origin,i=t.x,r=t.y,s=0;for(let o=0;o<n.grid.numZoneColsInGrid;o++)for(let a=0;a<n.grid.numZoneRowsInGrid;a++)e[s++].initialize(i+n.grid.zonePixelWidth*o,r+n.grid.zonePixelHeight*a)}setGridNeighbors(e,t,i,r){this.neighbors[rl]=e,this.neighbors[sl]=t,this.neighbors[ol]=i,this.neighbors[nl]=r}markGridAsChanged(){this.gridChangeCount++,this.worldGrid.changeCount++}getWorldGrid(){return this.worldGrid}isLoaded(){return this.loaded}getZones(){return this.zones}getGridCol(){return U.floor(this.origin.x/n.grid.gridPixelWidth)}getGridRow(){return U.floor(this.origin.y/n.grid.gridPixelHeight)}static calculateGridCol(e){return U.floor(e/n.grid.gridTileWidth)}static calculateGridRow(e){return U.floor(e/n.grid.gridTileHeight)}getPixelWidth(){return n.grid.gridPixelWidth}getPixelHeight(){return n.grid.gridPixelHeight}getGridTile(e,t){return this.getGridTileAbsolute(e,t)}findGridTile(e){if(!this.contains(e))return null;let t=U.floor(e.x/n.tile.size),i=U.floor(e.y/n.tile.size);return this.getGridTileAbsolute(t,i)}getGridTileAbsolute(e,t){let i=this.origin,r=U.floor(i.x/n.tile.size),s=U.floor(i.y/n.tile.size);return this.getGridTileLocal(e-r,t-s)}getGridTileLocal(e,t){let i=U.floor(e/n.grid.zoneTileWidth),r=U.floor(t/n.grid.zoneTileHeight);if(i<0||i>=n.grid.numZoneColsInGrid||r<0||r>=n.grid.numZoneRowsInGrid)return null;let s=i*n.grid.numZoneRowsInGrid+r;if(s>=0&&s<this.zones.length){let o=this.zones[s],a=this.origin,h=a.x/n.tile.size,u=a.y/n.tile.size,m=o.origin,g=m.x/n.tile.size,_=m.y/n.tile.size;return o.getGridTileLocal(e+h-g,t+u-_)}else return console.log("Grid.getGridTileLocal() Failed to find tile. col="+e+" row="+t+" index="+s),null}isTileType(e,t,i){let r=this.getGridTile(e,t);return r!==null&&r.getTileType()===i}isNotTileType(e,t,i){let r=this.getGridTile(e,t);return r===null||r.getTileType()!==i}createCenterVector(){let e=new P;return this.assignCenterVector(e),e}assignCenterVector(e){let t=U.floor(n.grid.gridPixelWidth/2),i=U.floor(n.grid.gridPixelHeight/2),r=this.getOrigin();e.x=r.x+t,e.y=r.y+i}findTileNeighborsFull(){for(let e=0;e<this.zones.length;e++)this.zones[e].findTileNeighborsFull()}findWorldGridTileNeighbors(){this.neighbors[rl]?this.findTileNeighborsGridBorderTop():this.nullifyTileNeighborsGridBorderTop(),this.neighbors[sl]?this.findTileNeighborsGridBorderBottom():this.nullifyTileNeighborsGridBorderBottom(),this.neighbors[nl]?this.findTileNeighborsGridBorderLeft():this.nullifyTileNeighborsGridBorderLeft(),this.neighbors[ol]?this.findTileNeighborsGridBorderRight():this.nullifyTileNeighborsGridBorderRight()}evaluateWorldGridTileNeighborBorders(){this.neighbors[rl]&&this.evaluateTileBordersTop(),this.neighbors[sl]&&this.evaluateTileBordersBottom(),this.neighbors[nl]&&this.evaluateTileBordersLeft(),this.neighbors[ol]&&this.evaluateTileBordersRight()}evaluateAllTileBorders(){ie.allTilesInGrid(this,function(e){e.evaluateBorders()})}nullifyBorderNeighbors(){this.nullifyTileNeighborsGridBorderRight(),this.nullifyTileNeighborsGridBorderLeft(),this.nullifyTileNeighborsGridBorderBottom(),this.nullifyTileNeighborsGridBorderTop()}findTileNeighborsGridBorderRight(){let e=n.grid.numZoneColsInGrid-1;for(let t=0;t<n.grid.numZoneRowsInGrid;t++)this.findZone(e,t).findTileNeighborsZoneBorderRight()}nullifyTileNeighborsGridBorderRight(){let e=n.grid.numZoneColsInGrid-1;for(let t=0;t<n.grid.numZoneRowsInGrid;t++)this.findZone(e,t).nullifyTileNeighborsZoneBorderRight()}evaluateTileBordersRight(){let e=n.grid.numZoneColsInGrid-1;for(let t=0;t<n.grid.numZoneRowsInGrid;t++)this.findZone(e,t).evaluateTileBordersRight()}findTileNeighborsGridBorderLeft(){for(let e=0;e<n.grid.numZoneRowsInGrid;e++)this.findZone(0,e).findTileNeighborsZoneBorderLeft()}nullifyTileNeighborsGridBorderLeft(){for(let e=0;e<n.grid.numZoneRowsInGrid;e++)this.findZone(0,e).nullifyTileNeighborsZoneBorderLeft()}evaluateTileBordersLeft(){for(let e=0;e<n.grid.numZoneRowsInGrid;e++)this.findZone(0,e).evaluateTileBordersLeft()}findTileNeighborsGridBorderBottom(){let e=n.grid.numZoneRowsInGrid-1;for(let t=0;t<n.grid.numZoneColsInGrid;t++)this.findZone(t,e).findTileNeighborsZoneBorderBottom()}nullifyTileNeighborsGridBorderBottom(){let e=n.grid.numZoneRowsInGrid-1;for(let t=0;t<n.grid.numZoneColsInGrid;t++)this.findZone(t,e).nullifyTileNeighborsZoneBorderBottom()}evaluateTileBordersBottom(){let e=n.grid.numZoneRowsInGrid-1;for(let t=0;t<n.grid.numZoneColsInGrid;t++)this.findZone(t,e).evaluateTileBordersBottom()}findTileNeighborsGridBorderTop(){for(let e=0;e<n.grid.numZoneColsInGrid;e++)this.findZone(e,0).findTileNeighborsZoneBorderTop()}nullifyTileNeighborsGridBorderTop(){for(let e=0;e<n.grid.numZoneColsInGrid;e++)this.findZone(e,0).nullifyTileNeighborsZoneBorderTop()}evaluateTileBordersTop(){for(let e=0;e<n.grid.numZoneColsInGrid;e++)this.findZone(e,0).evaluateTileBordersTop()}findZone(e,t){return this.zones[e*n.grid.numZoneRowsInGrid+t]}};var Dr=class{constructor(){this.targetTile=null,this.mineTile=null,this.behaviorId=null,this.candidateTile=null,this.candidateDist=1e4}setTargetTile(e,t,i){this.resetTarget(),this.targetTile=e,this.mineTile=t,this.behaviorId=i}onGridUnload(e){if(this.targetTile&&this.targetTile.grid===e){this.resetTarget();return}this.mineTile&&this.mineTile.grid===e&&this.resetTarget()}resetTarget(){this.targetTile=null,this.mineTile=null,this.behaviorId=null,this.candidateTile=null,this.candidateDist=1e4}};var oe=class{constructor(e,t,i){this.startTile=e,this.endTile=t,this.pathSteps=i}isSolidFloorRequiredAtStart(){return!0}executePlan(e,t,i){}walkLeftToCenterX(e,t,i){let r=e.position.worldCoordinateCenter.x,s=Math.abs(r-i);if(s===0)return!0;e.setCharacterAction(H.WALK),e.position.facingLeft=!0;let o=this.getWalkDistanceThisFrame(t);return s<o?(e.position.moveX(-s),!0):(e.position.moveX(-o),!1)}walkRightToCenterX(e,t,i){let r=e.position.worldCoordinateCenter.x,s=Math.abs(i-r);if(s===0)return!0;e.setCharacterAction(H.WALK),e.position.facingLeft=!1;let o=this.getWalkDistanceThisFrame(t);return s<o?(e.position.moveX(s),!0):(e.position.moveX(o),!1)}jumpUp(e,t,i){e.setCharacterAction(H.JUMP);let r=this.getJumpDistanceThisFrame(t);return e.position.worldCoordinateOrigin.y-i.origin.y<r?(e.position.setY(i.origin.y),!0):(e.position.moveY(-r),!1)}jumpUpAndLeft(e,t,i,r){let s=i.x,o=r.x,a=(s-o)/2,h=o+a,u=i.y-r.y+n.tile.halfSize,m=i.y-u,g=this.getWalkDistanceThisFrame(t);if(e.position.facingLeft=!0,e.position.worldCoordinateCenter.x>h){e.setCharacterAction(H.JUMP);let T=this.getJumpDistanceThisFrame(t),S=e.position.worldCoordinateCenter.x-h,R=e.position.worldCoordinateOrigin.y-m;if(S>R){let y=this.calcRatio(R,S),I=Math.min(y*T,R),N=Math.min(g,S);e.position.moveXY(-N,-I)}else{let y=this.calcRatio(S,R),I=Math.min(y*g,S),N=Math.min(T,R);e.position.moveXY(-I,-N)}return}e.setCharacterAction(H.FALL);let _=this.getFallDistanceThisFrame(t),C=e.position.worldCoordinateCenter.x-o,w=this.endTile.origin.y-e.position.worldCoordinateOrigin.y;if(!(C===0&&w===0))if(C>w){let T=this.calcRatio(w,C),S=Math.min(T*_,w),R=Math.min(g,C);e.position.moveXY(-R,S)}else{let T=this.calcRatio(C,w),S=Math.min(T*g,C),R=Math.min(_,w);e.position.moveXY(-S,R)}}jumpUpAndRight(e,t,i,r){let s=i.x,o=r.x,a=(o-s)/2,h=s+a,u=i.y-r.y+n.tile.halfSize,m=i.y-u,g=this.getWalkDistanceThisFrame(t);if(e.position.facingLeft=!1,e.position.worldCoordinateCenter.x<h){e.setCharacterAction(H.JUMP);let T=this.getJumpDistanceThisFrame(t),S=h-e.position.worldCoordinateCenter.x,R=e.position.worldCoordinateOrigin.y-m;if(S>R){let y=this.calcRatio(R,S),I=Math.min(y*T,R),N=Math.min(g,S);e.position.moveXY(N,-I)}else{let y=this.calcRatio(S,R),I=Math.min(y*g,S),N=Math.min(T,R);e.position.moveXY(I,-N)}return}e.setCharacterAction(H.FALL);let _=this.getFallDistanceThisFrame(t),C=o-e.position.worldCoordinateCenter.x,w=r.y-e.position.worldCoordinateOrigin.y;if(!(C===0&&w===0))if(C>w){let T=this.calcRatio(w,C),S=Math.min(T*_,w),R=Math.min(g,C);e.position.moveXY(R,S)}else{let T=this.calcRatio(C,w),S=Math.min(T*g,C),R=Math.min(_,w);e.position.moveXY(S,R)}}jumpDownAndLeft(e,t,i,r){let s=i.x,o=r.x,a=(s-o)/2,h=o+a,u=n.tile.halfSize,m=i.y-u,g=this.getWalkDistanceThisFrame(t);if(e.position.facingLeft=!0,e.position.worldCoordinateCenter.x>h){e.setCharacterAction(H.JUMP);let T=this.getJumpDistanceThisFrame(t),S=e.position.worldCoordinateCenter.x-h,R=e.position.worldCoordinateOrigin.y-m;if(S>R){let y=this.calcRatio(R,S),I=Math.min(y*T,R),N=Math.min(g,S);e.position.moveXY(-N,-I)}else{let y=this.calcRatio(S,R),I=Math.min(y*g,S),N=Math.min(T,R);e.position.moveXY(-I,-N)}return}e.setCharacterAction(H.FALL);let _=this.getFallDistanceThisFrame(t),C=e.position.worldCoordinateCenter.x-o,w=this.endTile.origin.y-e.position.worldCoordinateOrigin.y;if(!(C===0&&w===0))if(C>w){let T=this.calcRatio(w,C),S=Math.min(T*_,w),R=Math.min(g,C);e.position.moveXY(-R,S)}else{let T=this.calcRatio(C,w),S=Math.min(T*g,C),R=Math.min(_,w);e.position.moveXY(-S,R)}}jumpDownAndRight(e,t,i,r){let s=i.x,o=r.x,a=(o-s)/2,h=s+a,u=n.tile.halfSize,m=i.y-u,g=this.getWalkDistanceThisFrame(t);if(e.position.facingLeft=!1,e.position.worldCoordinateCenter.x<h){e.setCharacterAction(H.JUMP);let T=this.getJumpDistanceThisFrame(t),S=h-e.position.worldCoordinateCenter.x,R=e.position.worldCoordinateOrigin.y-m;if(S>R){let y=this.calcRatio(R,S),I=Math.min(y*T,R),N=Math.min(g,S);e.position.moveXY(N,-I)}else{let y=this.calcRatio(S,R),I=Math.min(y*g,S),N=Math.min(T,R);e.position.moveXY(I,-N)}return}e.setCharacterAction(H.FALL);let _=this.getFallDistanceThisFrame(t),C=o-e.position.worldCoordinateCenter.x,w=r.y-e.position.worldCoordinateOrigin.y;if(!(C===0&&w===0))if(C>w){let T=this.calcRatio(w,C),S=Math.min(T*_,w),R=Math.min(g,C);e.position.moveXY(R,S)}else{let T=this.calcRatio(C,w),S=Math.min(T*g,C),R=Math.min(_,w);e.position.moveXY(S,R)}}jumpLeft(e,t,i,r,s){let o=i.x,a=r.x,h=(o-a)/2,u=a+h,m=i.y-s,g=this.getWalkDistanceThisFrame(t);if(e.position.facingLeft=!0,e.position.worldCoordinateCenter.x>u){e.setCharacterAction(H.JUMP);let T=this.getJumpDistanceThisFrame(t),S=e.position.worldCoordinateCenter.x-u,R=e.position.worldCoordinateOrigin.y-m;if(S>R){let y=this.calcRatio(R,S),I=Math.min(y*T,R),N=Math.min(g,S);e.position.moveXY(-N,-I)}else{let y=this.calcRatio(S,R),I=Math.min(y*g,S),N=Math.min(T,R);e.position.moveXY(-I,-N)}return}e.setCharacterAction(H.FALL);let _=this.getFallDistanceThisFrame(t),C=e.position.worldCoordinateCenter.x-a,w=this.endTile.origin.y-e.position.worldCoordinateOrigin.y;if(!(C===0&&w===0))if(C>w){let T=this.calcRatio(w,C),S=Math.min(T*_,w),R=Math.min(g,C);e.position.moveXY(-R,S)}else{let T=this.calcRatio(C,w),S=Math.min(T*g,C),R=Math.min(_,w);e.position.moveXY(-S,R)}}jumpRight(e,t,i,r,s){let o=i.x,a=r.x,h=(a-o)/2,u=o+h,m=i.y-s,g=this.getWalkDistanceThisFrame(t);if(e.position.facingLeft=!1,e.position.worldCoordinateCenter.x<u){e.setCharacterAction(H.JUMP);let T=this.getJumpDistanceThisFrame(t),S=u-e.position.worldCoordinateCenter.x,R=e.position.worldCoordinateOrigin.y-m;if(S>R){let y=this.calcRatio(R,S),I=Math.min(y*T,R),N=Math.min(g,S);e.position.moveXY(N,-I)}else{let y=this.calcRatio(S,R),I=Math.min(y*g,S),N=Math.min(T,R);e.position.moveXY(I,-N)}return}e.setCharacterAction(H.FALL);let _=this.getFallDistanceThisFrame(t),C=a-e.position.worldCoordinateCenter.x,w=r.y-e.position.worldCoordinateOrigin.y;if(!(C===0&&w===0))if(C>w){let T=this.calcRatio(w,C),S=Math.min(T*_,w),R=Math.min(g,C);e.position.moveXY(R,S)}else{let T=this.calcRatio(C,w),S=Math.min(T*g,C),R=Math.min(_,w);e.position.moveXY(S,R)}}fallDownAndLeft(e,t,i){e.position.facingLeft=!0,e.setCharacterAction(H.FALL);let r=this.getFallDistanceThisFrame(t),s=this.getWalkDistanceThisFrame(t),o=e.position.worldCoordinateCenter.x-i.x,a=i.y-e.position.worldCoordinateOrigin.y,h=Math.min(s,o),u=Math.min(r,a);e.position.moveXY(-h,u)}fallDownAndRight(e,t,i){e.position.facingLeft=!1,e.setCharacterAction(H.FALL);let r=this.getFallDistanceThisFrame(t),s=this.getWalkDistanceThisFrame(t),o=i.x-e.position.worldCoordinateCenter.x,a=i.y-e.position.worldCoordinateOrigin.y,h=Math.min(s,o),u=Math.min(r,a);e.position.moveXY(h,u)}fallDown(e,t,i){e.setCharacterAction(H.FALL);let r=this.getFallDistanceThisFrame(t),s=i.origin.y-e.position.worldCoordinateOrigin.y;return r<s?(e.position.moveY(r),!1):(e.position.setY(i.origin.y),!0)}getWalkDistanceThisFrame(e){return n.physics.walkRatePerFrame*e}getFallDistanceThisFrame(e){return n.physics.gravityRatePerFrame*e}getJumpDistanceThisFrame(e){return n.physics.jumpRatePerFrame*e}getDistanceAboveFloor(e){let t=e.tile.origin.y,i=e.worldCoordinateOrigin.y;return t-i}assertEndTileReached(e,t){if(e.position.tile!==t){let i=t.origin;e.position.setTileAndOriginPosition(t,i.x,i.y)}else e.position.setPositionToTileOrigin()}calcRatio(e,t){return e===t?1:e===0?0:t===0?(console.log("calcRatio() 0 denominator"),1e3):e/t}toString(){return"Base PathPlan toString() sub-class did not override."}};var vr=class{constructor(e){this.character=e,this.worldCoordinateOrigin=new P(0,0),this.worldCoordinateCenter=new P(0,0),this.tile=null,this.grid=null,this.facingLeft=!0,this.gravityThisFrame=0,this.pathPlan=[]}setGrid(e){this.grid!=e&&(this.grid&&this.grid.removeCharacter(this.character),e?.addCharacter(this.character),this.grid=e)}castVerticalPositionToInteger(){this.worldCoordinateOrigin.y=U.floor(this.worldCoordinateOrigin.y),this.worldCoordinateCenter.y=this.worldCoordinateOrigin.y+n.tile.halfSize}setTileAndOriginPosition(e,t,i){this.worldCoordinateOrigin.set(t,i),this.tile=e,this.onWorldCoordinateChange()}isNearTileOrigin(){if(!this.tile)return!1;let e=this.worldCoordinateOrigin.x-this.tile.origin.x,t=this.worldCoordinateOrigin.y-this.tile.origin.y;return Math.abs(e)<=n.tile.quarterSize&&Math.abs(t)<=n.tile.quarterSize}setPositionToTileOrigin(){this.tile&&this.setTileAndOriginPosition(this.tile,this.tile.origin.x,this.tile.origin.y)}findClosestNeighbor(){let e=this.tile.neighbors,t=null,i=1e6;for(let r=0;r<e.length;r++){let s=e[r];if(!s||!s.open)continue;let o=this.tile.origin.distanceSquared(s.origin);(!t||o<i)&&(t=s,i=o)}return t}isCenteredOnTile(){return this.tile&&this.tile.origin.equals(this.worldCoordinateOrigin)}setWorldCoordinateOrigin(e){this.worldCoordinateOrigin.copy(e),this.onWorldCoordinateChange()}setWorldCoordinateOriginXY(e,t){this.worldCoordinateOrigin.set(e,t),this.onWorldCoordinateChange()}moveX(e){this.worldCoordinateOrigin.addXY(e,0),this.onWorldCoordinateChange()}moveY(e){this.worldCoordinateOrigin.addXY(0,e),this.onWorldCoordinateChange()}setX(e){this.worldCoordinateOrigin.x=e,this.onWorldCoordinateChange()}setY(e){this.worldCoordinateOrigin.y=e,this.onWorldCoordinateChange()}moveXY(e,t){this.worldCoordinateOrigin.addXY(e,t),this.onWorldCoordinateChange()}onWorldCoordinateChange(){if(this.worldCoordinateCenter.copy(this.worldCoordinateOrigin),this.worldCoordinateCenter.addXY(n.tile.halfSize,n.tile.halfSize),!this.tile){console.log("Position.onWorldCoordinateChange() tile is null");return}if(!this.tile.contains(this.worldCoordinateOrigin)){let e=this.tile;this.tile=this.tile.findNeighborContaining(this.worldCoordinateOrigin),this.tile||(this.grid&&(this.tile=this.grid.findGridTile(this.worldCoordinateOrigin)),this.tile||(this.tile=e.getWorldGrid().findGridTile(this.worldCoordinateOrigin)))}this.tile?this.setGrid(this.tile.grid):(console.log("Position.onWorldCoordinateChange() character lost their tile after move."),this.character.onInvalidGrid())}resetPathPlan(){this.pathPlan.length>0&&(this.pathPlan.length=0,this.setPositionToTileOrigin())}resetFull(){this.resetPathPlan(),this.setGrid(null),this.tile=null,this.gravityThisFrame=0}};var zt=class{constructor(){}performAction(e,t,i){}isMovementAction(){return!1}toString(){return"BaseTurnAction"}};var Ht=class extends qe{constructor(){super(),this.position=new vr(this),this.target=new Dr,this.turnAction=null,this.pathCompletedTime=0}isMonster(){return!0}isPartyMember(){return!1}isMinion(){return!1}isDead(){return!1}getMinerIndex(){return-1}getMonsterDescriptionId(){return null}getCharacterLevel(){return 1}setCharacterAction(e){}getCharacterSprite(){return null}getItemOverlaySprite(){return null}isThrusterActive(){return!1}followPathPlan(e,t){if(this.position.pathPlan.length===0)return;this.position.pathPlan[0].executePlan(this,e,t)&&(this.position.pathPlan.shift(),this.position.pathPlan.length===0&&(this.pathCompletedTime=Date.now()))}chooseTurn(){}performFrameActions(e,t){this.turnAction&&this.turnAction.performAction(this,e,t)}resetTurnState(){this.turnAction=null,this.characterAction=H.STAND,this.target.resetTarget(),this.position.resetPathPlan()}onInvalidGrid(){this.resetGameModel()}resetGameModel(){this.position.resetFull(),this.resetTurnState()}};var Gr=class{constructor(e){this.behaviorId=e}applyIfAppropriate(e){return!1}isAutoPlayBehavior(){return!1}getName(){return"CharacterBehavior****"}};var kr=class{constructor(e,t){this.id=e,this.behaviors=t}chooseTurn(e){if(!e.position.isCenteredOnTile()){if(e.turnAction&&e.turnAction.isMovementAction()&&e.position.pathPlan.length>0)return;e.position.gravityThisFrame===0&&(console.log("CharacterBrain.chooseTurn() not centered on tile and have no path plan. partyMember="+e.isPartyMember()+" monster="+e.isMonster()),e.resetTurnState())}e.turnAction=null;let t=e.position.tile;if(!t){e.resetTurnState();return}if(!t.grid.isLoaded()){console.log("CharacterBarin.chooseTurn() character in grid that is not loaded."),e.resetTurnState();return}e.position.gravityThisFrame>0||(this.applyBehaviors(e,this.behaviors),e.turnAction||(e.position.resetPathPlan(),e.setCharacterAction(H.STAND)))}applyBehaviors(e,t){let i=!1;for(let r=0;r<t.length;r++)if(t[r].applyIfAppropriate(e)){i=!0;break}i||e.target.resetTarget()}};var Fr=class extends Ht{constructor(){super(),this.sprite=null,this.monsterDescription=null,this.brain=null,this.damage=1}set(e,t,i){this.brain=e,this.sprite=t,this.monsterDescription=i}isMonster(){return!0}getMonsterDescriptionId(){return this.monsterDescription.id}getCharacterSprite(){return this.sprite}getDamage(){return this.damage}chooseTurn(){this.brain.chooseTurn(this)}reset(e){super.reset(e),this.finishedAndAvailable&&(this.position.resetFull(),this.resetTurnState(),this.brain=null)}};var $e=class{constructor(){this.cache=[],this.index=0,this.totalSize=0,this.count=0,this.currentActiveCount=0,this.maxActiveCount=0}get(){this.cache.length==0&&this.growCache(this.getInitialSize()),this.index>=this.cache.length&&(this.index=0),this.index=this.findNextAvailableIndex(this.index);let e=this.cache[this.index];return this.index++,e.reset(!1),e}findNextAvailableIndex(e){let t=this.cache.length;this.maxActiveCount>=t&&(e=t,this.growCache(this.getGrowAmount()),t=this.cache.length);let i=0;do{if(e>=t&&(i++,i==1?e=0:(this.growCache(this.getGrowAmount()),t=this.cache.length)),this.cache[e].isFinishedAndAvailable())return e;e++}while(i<2)}getUnderlyingCache(){return this.cache}growCache(e){for(let t=0;t<e;t++){let i=this.createInstance();i.setCycleCacheListener(this),this.cache.push(i)}console.log("CyclingCache.growCache() amount="+e+" newSize="+this.cache.length+" Type: "+this.constructor.name)}shrinkToSize(e){let t=this.cache.length-e;t>0&&this.cache.splice(e,t)}resetCache(){let e=this.cache.length;if(e==0)return;this.count++,this.totalSize+=this.maxActiveCount;let t=this.totalSize/this.count;for(let i=0;i<e;i++){let r=this.cache[i];r.isFinishedAndAvailable()||r.reset(!0)}if(this.count>5){let i=this.getGrowAmount(),r=this.getInitialSize()+2*i;if(e>t*1.75&&e>r){let s=t*1.2|0,o=this.getInitialSize();for(;o<s;)o+=i;o<e&&this.shrinkToSize(o),this.totalSize=0,this.count=0}}this.maxActiveCount=0,this.currentActiveCount=0,this.index=0}getGrowAmount(){}getInitialSize(){}createInstance(){}onAvailabilityChanged(e){e?this.currentActiveCount--:(this.currentActiveCount++,this.maxActiveCount=Math.max(this.maxActiveCount,this.currentActiveCount))}};var Br=class extends $e{constructor(){super(),this.initialCacheSize=50,this.growAmount=15}getGrowAmount(){return this.growAmount}getInitialSize(){return this.initialCacheSize}createInstance(){return new Fr}};var ee={BASIC:"B"};var de=class{constructor(){}static randomInt(e){return Math.random()*e|0}};var Wt=class{constructor(){}static findAvailableTileNearMainMiner(e,t){return this.findAvailableNearbyTile(e,t,t.main.position.tile)}static findAvailableNearbyTile(e,t,i){if(!i)return null;let r=this.findAvailableNeighborTile(e,t,i);if(r)return r;let s=this.findAvailableRegionTile(e,t,i.region);if(s)return s;let o=this.forceFindTileInRegion(i.region);if(o)return o;let a=this.findAvailableZoneTile(e,t,i.region.zone);if(a)return a;let h=this.forceFindTileInZone(i.region.zone);return h||(console.log("NearbyTileUtil.findAvailableTileNearMainMiner() Complete failure."),null)}static findAvailableNeighborTile(e,t,i){let r=i.neighbors;for(let s=0;s<5;s++){let o=r[de.randomInt(r.length)];if(o&&this.isTileClear(e,t,o))return o}return null}static findAvailableZoneTile(e,t,i){let r=i.regions;for(let s=0;s<5;s++){let o=r[de.randomInt(r.length)],a=this.findAvailableRegionTile(e,t,o);if(a)return a}return null}static forceFindTileInZone(e){let t=e.regions;for(let i=0;i<t.length;i++){let r=this.forceFindTileInRegion(t[i]);if(r)return r}return null}static findAvailableRegionTile(e,t,i){let r=i.tiles;for(let s=0;s<12;s++){let o=r[de.randomInt(r.length)];if(o&&this.isTileClear(e,t,o))return o}return null}static forceFindTileInRegion(e){if(!e)return null;let t=e.tiles[de.randomInt(e.tiles.length)];return t.open||t.onTileBreak(),t}static isClosedTileAvailable(e,t,i){for(let r=0;r<t.miners.length;r++){let s=t.miners[r];if(s!==e&&i===s.target.targetTile)return!1}return!0}static isTileClear(e,t,i){if(!i||!i.isTraversable())return!1;for(let r=0;r<t.miners.length;r++){let s=t.miners[r];if(s!==e&&(i===s.position.tile||i===s.target.targetTile))return!1}return!0}};var Yt=class{constructor(e){this.characterSpritesheet=e}getSprite(e,t){let i=this.characterSpritesheet.getSpriteAnimation(e);return i?i.getSpriteAsOf(Date.now(),t):null}};var Ei=class{constructor(e,t,i,r,s,o){this.id=e,this.name=t,this.attackType=i,this.armor=r,this.accessory=s,this.iconSpriteName=o}};var Vr=class{constructor(e,t,i,r){this.itemType=e,this.iconSprite=t,this.staticAnimation=i,this.activeAnimation=r,this.itemActive=!1,this.itemAnimating=!1,this.activeAnimationStartTime=0}setItemActive(e){this.itemActive=e,e?this.itemAnimating||(this.activeAnimationStartTime=Date.now(),this.itemAnimating=!0):this.itemAnimating&&this.activeAnimation.isAnimationLoopCompleted(this.activeAnimationStartTime)&&(this.itemAnimating=!1,this.activeAnimationStartTime=0)}getItemOverlaySprite(){if(this.itemActive)return this.activeAnimation.getSpriteAsOf(Date.now(),this.activeAnimationStartTime);if(this.itemAnimating)if(this.activeAnimation.isAnimationLoopCompleted(this.activeAnimationStartTime))this.itemAnimating=!1;else return this.activeAnimation.getSpriteAsOf(Date.now(),this.activeAnimationStartTime);return this.staticAnimation.getSpriteAsOf(Date.now(),this.activeAnimationStartTime)}isAnimationLoopCompleted(){return this.itemAnimating?this.activeAnimation.isAnimationLoopCompleted(this.activeAnimationStartTime):!0}};var Ur=class extends F{constructor(){super(),this.turnNumber=0,this.frameNumber=0,this.saveTime=0}resetFull(){this.turnNumber=0,this.frameNumber=0,this.saveTime=0}resetForPrestige(){this.turnNumber=0,this.frameNumber=0}};var zr=class{constructor(e,t){this.animation=e,this.gameTime=t,this.active=!1,this.activeTurn=-1,this.animationStartTime=0}setActive(e){e&&!this.active&&(this.animationStartTime=Date.now()),e&&(this.activeTurn=this.gameTime.turnNumber),this.active=e}deactivateNow(){this.active=!1,this.activeTurn=-1}isActive(){return this.active||this.activeTurn>=this.gameTime.turnNumber-1}getOverlaySprite(){return this.isActive()?this.animation.getSpriteAsOf(Date.now(),this.animationStartTime):null}};var At={NUMBER:1,BOOLEAN:2,BIG_NUM:3};var dt=class{constructor(e){this.id=e}reset(){}getValueType(){return At.BIG_NUM}isAtInitialValue(){return!0}isValueApplicable(){return!0}};var Xe=class extends dt{constructor(e,t){super(e),this.initialValue=new c(0).copy(t),this.value=new c(0).copy(t)}getValue(){return this.value}setValue(e){this.value.copy(e)}setZero(){this.value.setZero()}incrementValue(e){this.value.add(e)}reset(){this.value.copy(this.initialValue)}getValueType(){return At.BIG_NUM}isAtInitialValue(){return this.value.equals(this.initialValue)}isValueApplicable(){return this.value.greaterThanZero()}};var q=class extends dt{constructor(e,t){super(e),this.value=t,this.initialValue=t}getValue(){return this.value}setValue(e){this.value=e}incrementValue(e){this.value+=e}decrementValue(e){this.value-=e,this.value<this.initialValue&&(this.value=this.initialValue)}isPercentageApplied(){return this.value<=0?!1:this.value>=100?!0:de.randomInt(100)<this.value}getPercentAsFraction(){return this.value===0?0:this.value/100}reset(){this.value=this.initialValue}getValueType(){return At.NUMBER}isAtInitialValue(){return this.value===this.initialValue}isValueApplicable(){return this.value>0}};var Nt=class extends dt{constructor(e,t){super(e),this.initialValue=t,this.value=t}isValue(){return this.value}setValue(e){this.value=e}toggleValue(){this.value=!this.value}reset(){this.value=this.initialValue}getValueType(){return At.BOOLEAN}isAtInitialValue(){return this.value===this.initialValue}isValueApplicable(){return this.value!=this.initialValue}};var Hr=class extends F{constructor(){super(),this.baseAdditiveBonusPerTurn=new Xe("baseAdditiveBonusPerTurn",new c(0)),this.baseMultiplicativeBonusValue=new Xe("baseMultiBonusValue",new c(0)),this.minedDamageBonusMultiplier=new Xe("minedDamageBonusValue",new c(0)),this.minedOreBonus=new Xe("minedOreBonusValue",new c(0)),this.bonusOreMultiplier=new q(null,0),this.bonusUpgradeMultiplier=new q(null,0),this.bonusGoldIncrement=new q(null,0),this.goldOreBonusMultiplier=new Xe(null,new c(1)),this.goldPerBlockBonus=new Xe(null,new c(0)),this.skillOreBonusMultiplier=new Xe(null,new c(0)),this.skillGoldBonusMultiplier=new q(null,0),this.skillSilverBonusMultiplier=new q(null,0),this.skillRubyBonusMultiplier=new q(null,0),this.skillBlockBonusMultiplier=new q(null,0),this.skillDepthBonusMultiplier=new q(null,0),this.skillUpgradeAdditiveBonusMultiplier=new q(null,0),this.skillUpgradeMultiplicativeBonusMultiplier=new q(null,0),this.fallSpeedUpgrades=new q(null,0),this.fallSpeedBonusActive=new Nt(null,!1),this.skillMinedDamageBonus=new q(null,0),this.minedAutomationUnlocked=new Nt(null,!1),this.minedAutomationRateUpgrades=new q(null,0),this.pickAutomationUnlocked=new Nt(null,!1),this.pickAutomationRateUpgrades=new q(null,0),this.prestigeAutomationUnlocked=new Nt(null,!1),this.prestigeAutomationRateUpgrades=new q(null,0),this.offlineTimeUpgrades=new q(null,0),this.silverPerBlockBonus=new Xe(null,new c(0))}resetFull(){this.resetForPrestige(),this.goldOreBonusMultiplier.reset(),this.goldPerBlockBonus.reset(),this.skillOreBonusMultiplier.reset(),this.skillSilverBonusMultiplier.reset(),this.skillGoldBonusMultiplier.reset(),this.skillRubyBonusMultiplier.reset(),this.skillBlockBonusMultiplier.reset(),this.skillDepthBonusMultiplier.reset(),this.fallSpeedUpgrades.reset(),this.skillUpgradeAdditiveBonusMultiplier.reset(),this.skillUpgradeMultiplicativeBonusMultiplier.reset(),this.skillMinedDamageBonus.reset(),this.minedAutomationUnlocked.reset(),this.minedAutomationRateUpgrades.reset(),this.pickAutomationUnlocked.reset(),this.pickAutomationRateUpgrades.reset(),this.prestigeAutomationUnlocked.reset(),this.prestigeAutomationRateUpgrades.reset(),this.offlineTimeUpgrades.reset(),this.silverPerBlockBonus.reset()}resetForPrestige(){this.baseAdditiveBonusPerTurn.reset(),this.baseMultiplicativeBonusValue.reset(),this.minedDamageBonusMultiplier.reset(),this.minedOreBonus.reset(),this.bonusOreMultiplier.reset(),this.bonusUpgradeMultiplier.reset(),this.bonusGoldIncrement.reset()}};var Se=class{constructor(){}static calculateMinedDamageUpgradeValue(e){let t=(80+de.randomInt(20))/100;return new c(e.tileType.layerDescription.multiplicativeBonusFactor*t)}static getDamageMultiplier(e){return 1+n.skill.common.damagePerUpgrade*e.getValue()}static getDamagePercent(e){return n.skill.common.damagePercentPerUpgrade*e.getValue()}static getSkillActivationTurns(e){return n.skill.common.baseActivationTurns+e.getValue()*n.skill.common.activationTurnsPerUpgrade}static getSkillActivationSeconds(e){return this.getSkillActivationTurns(e)*n.time.secondsPerTurn}static getSkillCoolDownTurns(e){let t=e.getValue()*n.skill.common.coolDownTurnsPerUpgrade;return Math.max(2*n.time.turnsPerSecond,n.skill.common.baseCoolDownTurns-t)}static getSkillCoolDownSeconds(e){return this.getSkillCoolDownTurns(e)*n.time.secondsPerTurn}static getMissileCount(e){return n.skill.missiles.initialMissiles+n.skill.missiles.missilesPerUpgrade*e.getValue()}};var Kt=class extends Ht{constructor(e,t,i){super(),this.id=""+i,this.characterClass=e,this.values=t,this.minerIndex=i,this.pick=null,this.thruster=null,this.characterAction=H.STAND,this.characterActionStart=Date.now(),this.skillId=null}isMonster(){return!1}isPartyMember(){return!0}getMinerIndex(){return this.minerIndex}performFrameActions(e,t){if(!this.turnAction){this.updateThrusterStatus();return}this.turnAction.performAction(this,e,t),this.characterAction!==H.FALL?this.updateThrusterStatus():this.thruster.active&&this.thruster.deactivateNow()}followPathPlan(e,t){if(this.position.pathPlan.length===0)return;this.position.pathPlan[0].executePlan(this,e,t)&&this.position.pathPlan.shift()}updateThrusterStatus(){let t=this.position.tile.getNeighborBottom();!t||t.isTraversable()?this.thruster.setActive(!0):this.thruster.deactivateNow()}setCharacterAction(e){this.characterAction!==e&&(this.characterAction=e,this.characterActionStart=Date.now()),this.pick.setItemActive(this.characterAction===H.MINE),this.characterAction!==H.JUMP&&this.characterAction!==H.FALL&&this.updateThrusterStatus()}getCharacterSprite(){return this.characterClass.getSprite(this.characterAction,this.characterActionStart)}getItemOverlaySprite(){return this.pick?this.pick.getItemOverlaySprite():null}getThrusterOverlaySprite(){return this.thruster.getOverlaySprite()}isThrusterActive(){return this.thruster.isActive()}};var Zl={pick:new Ei("1","Pick",!1,!1,se.pick.icon),sword:new Ei("2","Sword",!1,!1,se.broadSword.icon)};var Wr=class extends F{constructor(e,t,i,r,s){super(),this.worldGrid=e,this.gameTime=t,this.characterSpritesheet=i,this.values=s,this.itemOverlaySpritesheet=r,this.main=null,this.miners=[],this.centerTile=null,this.workingCenter=new P(0,0)}resetTargets(){for(let e=0;e<this.miners.length;e++)this.miners[e].target.resetTarget()}findMinerIndex(e){return this.miners.indexOf(e)}calculateCrewCenterCoordinate(e){if(this.miners.length===1){e.copy(this.miners[0].position.worldCoordinateOrigin);return}let t=0,i=0;for(let r=0;r<this.miners.length;r++){let s=this.miners[r].position.worldCoordinateOrigin;t+=s.x,i+=s.y}t=t/this.miners.length,i=i/this.miners.length,e.x=t,e.y=i}calculateCrewCenterTile(){if(this.miners.length===1){let e=this.miners[0].position.tile;return e?(this.centerTile=e,e):(this.centerTile=this.worldGrid.findGridTile(this.miners[0].position.worldCoordinateOrigin),this.centerTile)}else{this.calculateCrewCenterCoordinate(this.workingCenter);let e=this.worldGrid.findGridTile(this.workingCenter);if(e)return this.centerTile=e,e;console.log("Crew.getCrewCenterTile() failed to find tile: "+this.workingCenter.toString());for(let t=0;t<this.miners.length;t++){let i=this.miners[t].position.tile;if(i)return this.centerTile=i,this.centerTile}return null}}createMainMiner(){return this.main=new Kt(new Yt(this.characterSpritesheet),this.values,this.miners.length),this.initializeCharacter(this.main),this.miners.push(this.main),this.main}addNewMinerNearMain(e){if(!this.main.position.tile){console.log("Crew.addNewMinerNearMain() ERROR main miner does not have a tile.");return}let t=Wt.findAvailableTileNearMainMiner(null,this),i=new Kt(new Yt(this.characterSpritesheet),this.values,this.miners.length);i.skillId=e,this.initializeCharacter(i),this.miners.push(i),i.position.setTileAndOriginPosition(t,t.origin.x,t.origin.y)}addNewMinerForSaveLoad(){let e=new Kt(new Yt(this.characterSpritesheet),this.values,this.miners.length);return this.initializeCharacter(e),this.miners.push(e),e}initializeCharacter(e){this.itemOverlaySpritesheet.loaded||console.log("Crew.initializeCharacter() itemOverlaySpritesheet not loaded yet");let t=this.itemOverlaySpritesheet.getSpriteAnimation(se.pick.staticOverlay),i=this.itemOverlaySpritesheet.getSpriteAnimation(se.pick.activeOverlay),r=this.itemOverlaySpritesheet.getSpriteAnimation(se.thruster.activeOverlay);e.pick=new Vr(Zl.pick,null,t,i),e.thruster=new zr(r,this.gameTime)}onGridUnload(e){for(let t=0;t<this.miners.length;t++)this.miners[t].target.onGridUnload(e)}resetFull(){this.miners.length=0,this.main=null,this.centerTile=null}resetForPrestige(){for(let e=0;e<this.miners.length;e++){let t=this.miners[e];t.resetGameModel(),this.setInitialMinerPosition(t,e)}this.centerTile=null}setInitialMinerPosition(e,t){switch(t){case 0:e.position.setWorldCoordinateOriginXY(n.start.startX,n.start.startY);break;case 1:e.position.setWorldCoordinateOriginXY(n.start.startX-n.tile.size*2,n.start.startY);break;case 2:e.position.setWorldCoordinateOriginXY(n.start.startX+n.tile.size*2,n.start.startY);break;case 3:e.position.setWorldCoordinateOriginXY(n.start.startX-n.tile.size*4,n.start.startY);break;case 4:e.position.setWorldCoordinateOriginXY(n.start.startX+n.tile.size*4,n.start.startY);break;case 5:e.position.setWorldCoordinateOriginXY(n.start.startX-n.tile.size*6,n.start.startY);break;case 6:e.position.setWorldCoordinateOriginXY(n.start.startX+n.tile.size*6,n.start.startY);break;case 7:e.position.setWorldCoordinateOriginXY(n.start.startX-n.tile.size*8,n.start.startY);break;case 8:e.position.setWorldCoordinateOriginXY(n.start.startX+n.tile.size*8,n.start.startY);break;case 9:e.position.setWorldCoordinateOriginXY(n.start.startX-n.tile.size*10,n.start.startY);break;case 10:e.position.setWorldCoordinateOriginXY(n.start.startX+n.tile.size*10,n.start.startY);break;case 11:e.position.setWorldCoordinateOriginXY(n.start.startX,n.start.startY+n.tile.size*2);break;case 12:e.position.setWorldCoordinateOriginXY(n.start.startX-n.tile.size*2,n.start.startY+n.tile.size*2);break;case 13:e.position.setWorldCoordinateOriginXY(n.start.startX+n.tile.size*2,n.start.startY+n.tile.size*2);break;case 14:e.position.setWorldCoordinateOriginXY(n.start.startX-n.tile.size*4,n.start.startY+n.tile.size*2);break;case 15:e.position.setWorldCoordinateOriginXY(n.start.startX+n.tile.size*4,n.start.startY+n.tile.size*2);break;case 16:e.position.setWorldCoordinateOriginXY(n.start.startX-n.tile.size*6,n.start.startY+n.tile.size*2);break;case 17:e.position.setWorldCoordinateOriginXY(n.start.startX+n.tile.size*6,n.start.startY+n.tile.size*2);break;case 18:e.position.setWorldCoordinateOriginXY(n.start.startX-n.tile.size*8,n.start.startY+n.tile.size*2);break;case 19:e.position.setWorldCoordinateOriginXY(n.start.startX+n.tile.size*8,n.start.startY+n.tile.size*2);break;case 20:e.position.setWorldCoordinateOriginXY(n.start.startX-n.tile.size*10,n.start.startY+n.tile.size*2);break;case 21:e.position.setWorldCoordinateOriginXY(n.start.startX+n.tile.size*10,n.start.startY+n.tile.size*2);break;default:e.position.setWorldCoordinateOriginXY(n.start.startX,n.start.startY);break}}teleportToRow(e){let t=e*n.tile.size;for(let i=0;i<this.miners.length;i++){let r=this.miners[i],s=r.position.worldCoordinateOrigin;r.position.setTileAndOriginPosition(null,s.x,t)}}teleportUpwards(e){let t=e*n.tile.size,i=n.target.minTargetRow*n.tile.size;for(let r=0;r<this.miners.length;r++){let s=this.miners[r],o=s.position.worldCoordinateOrigin,a=Math.max(i,o.y-t);s.position.setTileAndOriginPosition(null,o.x,a)}}};var Yr=class extends F{constructor(){super(),this.basePickDamagePerTurn=new c(n.damage.baseDamagePerTurn),this.totalPickDamagePerTurn=new c(n.damage.baseDamagePerTurn),this.baseDamagePerTurn=new c(1),this.oreDamageMultiplier=new c(1),this.minedDamageMultiplier=new c(1),this.silverDamageMultiplier=new c(1),this.goldDamageMultiplier=new c(1),this.depthDamageMultiplier=new c(1),this.rubyDamageMultiplier=new c(1),this.blockDamageMultiplier=new c(1),this.totalPickDamagePerFrame=new c(1),this.totalPickDamagePerFrame.copy(this.totalPickDamagePerTurn),this.totalPickDamagePerFrame.divNumber(n.time.turnFrames),this.working=new c(0)}calculateMaxBrickHealth(e,t){let i=e*n.time.turnsPerSecond;t.copy(this.totalPickDamagePerTurn),t.mulNumber(i)}calculateMineSeconds(e){return this.working.copy(e),this.working.div(this.totalPickDamagePerTurn),this.working.mulNumber(n.time.secondsPerTurn),this.working.toNumber()}resetFull(){this.resetForPrestige(),this.baseDamagePerTurn.setValue(1),this.oreDamageMultiplier.setValue(1),this.minedDamageMultiplier.setValue(1),this.silverDamageMultiplier.setValue(1),this.goldDamageMultiplier.setValue(1),this.depthDamageMultiplier.setValue(1),this.rubyDamageMultiplier.setValue(1),this.blockDamageMultiplier.setValue(1),this.depthDamageMultiplier.setValue(1),this.rubyDamageMultiplier.setValue(1)}resetForPrestige(){this.basePickDamagePerTurn.setValue(n.damage.baseDamagePerTurn),this.totalPickDamagePerTurn.setValue(n.damage.baseDamagePerTurn),this.totalPickDamagePerFrame.setValue(1),this.oreDamageMultiplier.setValue(1)}};var ut=class extends F{constructor(e,t,i){super(),this.gameTime=e,this.batchTurnSize=t*n.time.turnsPerSecond,this.penaltyFactor=new c(i),this.sum=new c(0),this.startTurn=e.turnNumber,this.valuePerTurn=new c(0),this.rates=[],this.rateIndex=0}add(e,t){this.sum.add(e);let i=this.gameTime.turnNumber-this.startTurn;i>this.batchTurnSize&&(this.sum.divNumber(i),this.addToRollingAverage(this.sum),this.calculateValuePerTurn(),this.startTurn=this.gameTime.turnNumber,this.sum.setZero()),t.copy(this.valuePerTurn)}addToRollingAverage(e){if(this.rates.length<10){let t=new c(0);t.copy(e),this.rates.push(t)}else this.rates[this.rateIndex].copy(e),this.rateIndex++,this.rateIndex>=this.rates.length&&(this.rateIndex=0)}calculateValuePerTurn(){if(this.valuePerTurn.setZero(),this.rates.length>0){for(let e=0;e<this.rates.length;e++)this.valuePerTurn.add(this.rates[e]);this.valuePerTurn.divNumber(this.rates.length),this.valuePerTurn.mul(this.penaltyFactor)}}resetFull(){this.sum.setZero(),this.startTurn=this.gameTime.turnNumber,this.rates.length=0,this.rateIndex=0,this.valuePerTurn.setZero()}resetForPrestige(){this.startTurn=this.gameTime.turnNumber}};var Kr=class extends F{constructor(e){super(),this.oreRatePerTurnCalculator=new ut(e,20,.5),this.goldRatePerTurnCalculator=new ut(e,20,.5),this.prestigeRatePerTurnCalculator=new ut(e,20,.5),this.rubyRatePerTurnCalculator=new ut(e,20,.5),this.silverRatePerTurnCalculator=new ut(e,20,.5),this.ore=new c(0),this.gold=new c(0),this.goldSum=new c(0),this.ruby=new c(0),this.silver=new c(0),this.silverSum=new c(0),this.prestige=new c(0),this.prestigePointsSum=new c(0),this.unclaimedPrestige=new c(0),this.working=new c(0),this.prestigePerTurn=new c(0),this.goldPerTurn=new c(0),this.orePerTurn=new c(0),this.rubyPerTurn=new c(0),this.silverPerTurn=new c(0),this.offlinePrestige=new c(0),this.offlineGold=new c(0),this.offlineOre=new c(0),this.offlineRuby=new c(0),this.offlineSilver=new c(0),this.offlineSeconds=0,this.countedOfflineSeconds=0,this.one=new c(1)}incrementOre(e){this.ore.add(e),this.oreRatePerTurnCalculator.add(e,this.orePerTurn)}decrementOre(e){this.ore.sub(e),this.ore.lessThanZero()&&this.ore.setZero()}incrementGold(e){this.gold.add(e),this.goldSum.add(e),this.goldRatePerTurnCalculator.add(e,this.goldPerTurn)}decrementGold(e){this.gold.sub(e),this.gold.lessThanZero()&&this.gold.setZero()}incrementRuby(e){this.ruby.add(e),this.rubyRatePerTurnCalculator.add(e,this.rubyPerTurn)}decrementPrestige(e){this.prestige.sub(e),this.prestige.lessThanZero()&&this.prestige.setZero()}incrementSilver(e){this.silver.add(e),this.silverSum.add(e),this.silverRatePerTurnCalculator.add(e,this.silverPerTurn)}decrementSilver(e){this.silver.sub(e),this.silver.lessThanZero()&&this.silver.setZero()}incrementOfflinePrestige(e){this.offlinePrestige.add(e)}incrementOfflineGold(e){this.offlineGold.add(e)}incrementOfflineOre(e){this.offlineOre.add(e)}incrementOfflineRuby(e){this.offlineRuby.add(e)}incrementOfflineSilver(e){this.offlineSilver.add(e)}onPrestige(){}resetFull(){this.silver.setZero(),this.silverSum.setZero(),this.prestige.setZero(),this.prestigePointsSum.setZero(),this.unclaimedPrestige.setZero(),this.gold.setZero(),this.goldSum.setZero(),this.ruby.setZero(),this.orePerTurn.setZero(),this.prestigePerTurn.setZero(),this.goldPerTurn.setZero(),this.rubyPerTurn.setZero(),this.silverPerTurn.setZero(),this.offlinePrestige.setZero(),this.offlineGold.setZero(),this.offlineOre.setZero(),this.offlineRuby.setZero(),this.offlineSilver.setZero(),this.oreRatePerTurnCalculator.resetFull(),this.goldRatePerTurnCalculator.resetFull(),this.prestigeRatePerTurnCalculator.resetFull(),this.rubyRatePerTurnCalculator.resetFull(),this.silverRatePerTurnCalculator.resetFull(),this.resetForPrestige()}resetForPrestige(){this.ore.setZero(),this.oreRatePerTurnCalculator.resetForPrestige(),this.goldRatePerTurnCalculator.resetForPrestige(),this.prestigeRatePerTurnCalculator.resetForPrestige(),this.rubyRatePerTurnCalculator.resetForPrestige(),this.silverRatePerTurnCalculator.resetForPrestige()}};var me={NORTH:0,NORTH_EAST:1,EAST:2,SOUTH_EAST:3,SOUTH:4,SOUTH_WEST:5,WEST:6,NORTH_WEST:7};var be={FINISHED_AND_AVAILABLE_FOR_CACHE:1,FINISHED_BUT_IN_USE:2,NOT_STARTED:3,STARTED_NOT_FINISHED:4};var al={SPRITE_EFFECT:0,LIGHTNING_EFFECT:1,AREA_EFFECT:2};var Xr=class extends qe{constructor(){super(),this.effectOwner=null,this.effectStatus=be.FINISHED_AND_AVAILABLE_FOR_CACHE,this.startTime=0}set(e){this.effectOwner=e,this.effectStatus=be.NOT_STARTED,this.startTime=Date.now()}getSpriteDirection(){return me.NORTH}getEffectType(){return al.SPRITE_EFFECT}getEffectOwner(){return this.effectOwner}getSprite(){return null}getPosition(){return null}isEffectStarted(){return this.effectStatus===be.STARTED_NOT_FINISHED}isNotStarted(){return this.effectStatus===be.NOT_STARTED}isEffectFinished(){return this.effectStatus===be.FINISHED_AND_AVAILABLE_FOR_CACHE||this.effectStatus===be.FINISHED_BUT_IN_USE}markEffectAsFinishedButInUse(){this.effectStatus!==be.FINISHED_AND_AVAILABLE_FOR_CACHE&&(this.effectStatus=be.FINISHED_BUT_IN_USE)}updateEffectForFrame(e){this.isEffectFinished()||(this.effectStatus===be.NOT_STARTED&&(this.startTime=Date.now()),this.effectStatus=be.STARTED_NOT_FINISHED,this.updateEffectForFrameInternal(e))}updateEffectForFrameInternal(e){}getStartTime(){return this.startTime}getEffectStatus(){return this.effectStatus}refreshStartTime(e){this.startTime=e}isFinishedAndAvailable(){return this.effectStatus==be.FINISHED_AND_AVAILABLE_FOR_CACHE}reset(e){this.effectStatus==be.FINISHED_AND_AVAILABLE_FOR_CACHE!=e&&(e&&(this.spriteAnimation=null),this.effectStatus=e?be.FINISHED_AND_AVAILABLE_FOR_CACHE:be.NOT_STARTED,this.startTime=0,this.listener.onAvailabilityChanged(e))}};var jr=class{constructor(){}createEffect(e,t){return null}createEffectAtTile(e,t){return null}createEffectAtPosition(e,t){return null}getSpriteAnimation(){return null}};var ae={BLACK_OPACITY:j.createColor(336338048),RED_OPACITY:j.createColor(3494267008),DARK_GRAY_OPACITY:j.createColor(1313492864),DARK_RED_OPACITY:j.createColor(1143223424),BLACK:j.createColor(336338175),DARK_RED:j.createColor(1143223551),DARK_BLUE:j.createColor(808742399),DARK_GRAY:j.createColor(1313492991),BROWN:j.createColor(2236363007),DARK_GREEN:j.createColor(879043839),RED:j.createColor(3494267135),LIGHT_GRAY:j.createColor(1970364927),LIGHT_BLUE:j.createColor(1501417215),ORANGE:j.createColor(3531418879),BLUE_GRAY:j.createColor(2241176063),LIGHT_GREEN:j.createColor(1839869183),PEACH:j.createColor(3534395903),CYAN:j.createColor(1841482495),YELLOW:j.createColor(3671351039),WHITE:j.createColor(3740194559)};var Zr=class extends Ut{constructor(){super(),this.flickerColor=new j(1,1,1,1)}getColor(){this.flickerColor.set(this.color);let e=-.05+.1*Math.random();return this.flickerColor.add(e,e,e,0),this.flickerColor}getTileRadius(){return this.radius+(Math.random()<.15?1:0)}};var Xt=class extends $e{constructor(){super()}getGrowAmount(){return 5}getInitialSize(){return 5}createInstance(){return new Ut}};var qr=class extends Xt{constructor(){super()}createInstance(){return new Zr}};var re=class{constructor(e,t,i){this.color=e,this.radius=t,this.lightSourceCache=i}createLightSource(e){let t=this.lightSourceCache.get();return t.set(e,this.color,this.radius),t}};var Jr=class extends F{constructor(){super();let e=n.lighting.lightSourceRadius;this.lightSourceCache=new Xt,this.flickeringLightSourceCache=new qr,this.lightGreenFlickering=new re(ae.LIGHT_GREEN,e,this.flickeringLightSourceCache),this.darkGreenFlickering=new re(ae.DARK_GREEN,e,this.flickeringLightSourceCache),this.cyanFlickering=new re(ae.CYAN,e,this.flickeringLightSourceCache),this.orangeFlickering=new re(ae.ORANGE,e,this.flickeringLightSourceCache),this.yellowFlickering=new re(ae.YELLOW,e,this.flickeringLightSourceCache),this.peachFlickering=new re(ae.PEACH,e,this.flickeringLightSourceCache),this.lightBlueFlickering=new re(ae.LIGHT_BLUE,e,this.flickeringLightSourceCache),this.darkBlueFlickering=new re(ae.DARK_BLUE,e,this.flickeringLightSourceCache),this.whiteFlickering=new re(ae.WHITE,e,this.flickeringLightSourceCache),this.redFlickering=new re(ae.RED,e,this.flickeringLightSourceCache),this.darkRedFlickering=new re(ae.DARK_RED,e,this.flickeringLightSourceCache),this.lightGrayFlickering=new re(ae.LIGHT_GRAY,e,this.flickeringLightSourceCache),this.lightGreen=new re(ae.LIGHT_GREEN,e,this.lightSourceCache),this.darkGreen=new re(ae.DARK_GREEN,e,this.lightSourceCache),this.cyan=new re(ae.CYAN,e,this.lightSourceCache),this.orange=new re(ae.ORANGE,e,this.lightSourceCache),this.yellow=new re(ae.YELLOW,e,this.lightSourceCache),this.peach=new re(ae.PEACH,e,this.lightSourceCache),this.lightBlue=new re(ae.LIGHT_BLUE,e,this.lightSourceCache),this.darkBlue=new re(ae.DARK_BLUE,e,this.lightSourceCache),this.white=new re(ae.WHITE,e,this.lightSourceCache),this.red=new re(ae.RED,e,this.lightSourceCache),this.darkRed=new re(ae.DARK_RED,e,this.lightSourceCache),this.lightGray=new re(ae.LIGHT_GRAY,e,this.lightSourceCache)}resetFull(){this.lightSourceCache.resetCache(),this.flickeringLightSourceCache.resetCache()}resetForPrestige(){this.resetFull()}};var ne=class{constructor(e,t){this.volume=e,this.soundPaths=t}getVolume(){return this.volume}getSoundPaths(){return this.soundPaths}getRandomSoundPath(){return!this.soundPaths||this.soundPaths.length==0?null:this.soundPaths.length==1?this.soundPaths[0]:this.soundPaths[de.randomInt(this.soundPaths.length)]}};var k={buttonClick:new ne(1,"sound/effects/ui/Snd_click.mp3"),coins:new ne(.5,"sound/effects/coins/handleCoins.mp3","sound/effects/coins/handleCoins2.mp3"),tab:new ne(1,"sound/effects/ui/metalLatch.mp3"),minionDeath:new ne(1,"sound/effects/deathMinion/bite-small.mp3"),travelEffect:new ne(1,"sound/effects/travelEffect/dropLeather.mp3"),deathBell:new ne(1,"sound/effects/deathBell/churchbell.mp3"),deathScream:new ne(1,"sound/effects/deathScream/death_01.mp3","sound/effects/deathScream/death_02.mp3","sound/effects/deathScream/death_04.mp3","sound/effects/deathScream/death_05.mp3","sound/effects/deathScream/death_06.mp3","sound/effects/deathScream/death_07.mp3"),resurrection:new ne(1,"sound/effects/resurrection/JRPG_characterRevived.mp3"),questCompletion:new ne(1,"sound/effects/questCompleted/Jingle_Achievement_00_128.mp3"),collectibleFound:new ne(1,"sound/effects/collectibleFound/teleport_02.mp3"),achievement:new ne(1,"sound/effects/achievement/cursespell.mp3"),partyRankEarned:new ne(1,"sound/effects/partyRank/retro_beep_04.mp3"),spellBlastEffect:new ne(1,"sound/effects/spellBlastArea/sfx_exp_cluster2.mp3","sound/effects/spellBlastArea/sfx_exp_short_hard2.mp3","sound/effects/spellBlastArea/sfx_exp_short_hard3.mp3","sound/effects/spellBlastArea/sfx_exp_short_hard6.mp3","sound/effects/spellBlastArea/sfx_exp_short_hard10.mp3","sound/effects/spellBlastArea/sfx_exp_short_hard12.mp3","sound/effects/spellBlastArea/sfx_exp_short_hard13.mp3","sound/effects/spellBlastArea/missile_explosion.mp3"),damage:new ne(1,"sound/effects/damage/sfx_exp_shortest_hard6.mp3","sound/effects/damage/sfx_exp_shortest_soft1.mp3","sound/effects/damage/sfx_exp_shortest_soft2.mp3","sound/effects/damage/sfx_exp_shortest_soft6.mp3","sound/effects/damage/sfx_exp_shortest_soft7.mp3","sound/effects/damage/sfx_exp_shortest_soft8.mp3","sound/effects/damage/sfx_exp_shortest_soft9.mp3"),doorOpenEffect:new ne(1,"sound/effects/doorOpen/sfx_movement_dooropen1.mp3","sound/effects/doorOpen/doorOpen_1.mp3","sound/effects/doorOpen/doorOpen_2.mp3"),barrelOpen:new ne(1,"sound/effects/open/boots-leather-step-01.mp3"),itemDrop:new ne(1,"sound/effects/itemDrop/water-drop-02.mp3"),potBroken:new ne(1,"sound/effects/breakPot/wood-bowl-spoon-04.mp3"),sackLooted:new ne(1,"sound/effects/sackLooted/knife-sheathe-01.mp3"),chestOpen:new ne(1,"sound/effects/chestOpen/match-light-01.mp3","sound/effects/chestOpen/quiver-leather-squeeze-01.mp3"),fixtureBreak:new ne(1,"sound/effects/fixtureBreak/item_wood_02.mp3","sound/effects/fixtureBreak/misc_03.mp3","sound/effects/fixtureBreak/wood_01.mp3","sound/effects/fixtureBreak/wood_04.mp3"),rareWeaponFound:new ne(1,"sound/effects/foundRare/levelup.mp3")};var O={DAMAGE_EFFECT_NAME_RED_SPLAT:"Red Splat",DAMAGE_EFFECT_NAME_RED_DAMAGE:"Red Damage",DAMAGE_EFFECT_NAME_WHITE_DAMAGE:"White Damage",DAMAGE_EFFECT_NAME_BLUE_DAMAGE:"Blue Damage",DAMAGE_EFFECT_NAME_GREEN_DAMAGE:"Green Damage",DAMAGE_EFFECT_NAME_SHOCK_DAMAGE:"Electric Damage",DAMAGE_EFFECT_NAME_FIRE_DAMAGE:"Fire Damage",DAMAGE_EFFECT_NAME_POISON_DAMAGE:"Poison Damage",DAMAGE_EFFECT_NAME_SONIC_DAMAGE:"Sonic Damage",DAMAGE_EFFECT_NAME_PINK_DAMAGE:"Pink Damage",MISSILE_EFFECT_NAME_ARROW:"Red Arrow",MISSILE_EFFECT_NAME_FAT_ARROW:"Fat Red Arrow",MISSILE_EFFECT_NAME_GREEN_ARROW:"Green Arrow",MISSILE_EFFECT_NAME_PINK_ARROW:"Pink Arrow",MISSILE_EFFECT_NAME_ARROW_WALL:"Wall Arrow",MISSILE_EFFECT_NAME_SPEAR:"Spear",MISSILE_EFFECT_NAME_PINK_LIGHTNING:"Pink Lightning",MISSILE_EFFECT_NAME_GREEN_PROJECTILE:"Green Projectile",MISSILE_EFFECT_NAME_SMALL_GREEN_PROJECTILE:"Small Green Projectiles",MISSILE_EFFECT_NAME_FIRE_PROJECTILE:"Fire Projectile",MISSILE_EFFECT_NAME_FIRE_ARROW:"Fire Arrow",MISSILE_EFFECT_NAME_ICE_PROJECTILE:"Ice Projectile",MISSILE_EFFECT_NAME_ICE_ARROW:"Ice Arrow",MISSILE_EFFECT_NAME_LIGHTNING:"Lightning",MISSILE_EFFECT_NAME_LIGHTNING_ARROW:"Lightning Arrow",MISSILE_EFFECT_NAME_GREY_BULLET:"Grey Bullet",MISSILE_EFFECT_NAME_YELLOW_BULLET:"Yellow Bullet",MISSILE_EFFECT_NAME_NINJA_STAR:"Ninja Star",MISSILE_EFFECT_NAME_WEB:"Web",MISSILE_EFFECT_NAME_PINK_STAR_PROJECTILE:"Pink Star Projectile",MISSILE_EFFECT_NAME_PINK_BALL_PROJECTILE:"Pink Ball Projectile",MISSILE_EFFECT_NAME_YELLOW_STAR_PROJECTILE:"Yellow Star Projectile",EFFECT_NAME_SPARKLE_GOLD:"Gold Sparkles",EFFECT_NAME_SPARKLE_GREEN:"Green Sparkles",EFFECT_NAME_SPARKLE_BLUE:"Blue Sparkles",EFFECT_NAME_SPARKLE_ORANGE:"Orange Sparkles",EFFECT_NAME_SPARKLE_PINK:"Pink Sparkles",EFFECT_NAME_SPARKLE_RED:"Red Sparkles",EFFECT_NAME_GREEN_SKULL:"Green Skull",EFFECT_NAME_YELLOW_KEY:"Yellow Key",EFFECT_NAME_SKULL_CROSS:"Skull Cross",EFFECT_NAME_SHIELDS:"Shields",EFFECT_NAME_RED_CROSSES:"Red Crosses",EFFECT_NAME_FIRE_RING:"Fire Ring",EFFECT_NAME_ICE_RING:"Ice Ring",EFFECT_NAME_GREEN_RING:"Green Ring",EFFECT_NAME_PINK_RING:"Pink Ring",EFFECT_NAME_YELLOW_STAR:"Yellow Star",EFFECT_NAME_BLUE_STAR:"Blue Star",EFFECT_NAME_GREEN_STAR:"Green Star",EFFECT_NAME_WEB:"Spider Web",EFFECT_NAME_WHITE_CROSSES:"White Crosses",EFFECT_NAME_TORCH:"Torch",EFFECT_NAME_FROST:"Frost",EFFECT_NAME_YELLOW_STAR_CIRCLE:"Yellow Star Circle",EFFECT_NAME_CIRCLES:"Circles",EFFECT_NAME_GOLD_SHIELD_SPIRAL:"Gold Shield Spiral",EFFECT_NAME_GREEN_SHIELD_SPIRAL:"Green Shield Spiral",EFFECT_NAME_BLUE_SHIELD_SPIRAL:"Blue Shield Spiral",EFFECT_NAME_PINK_SHIELD_SPIRAL:"Pink Shield Spiral",EFFECT_NAME_BLUE_FIREWORK:"Blue Firework",EFFECT_NAME_RED_FIREWORK:"Red Firework",EFFECT_NAME_BUBBLES:"Bubbles",EFFECT_NAME_SHIELD:"Shield",EFFECT_NAME_COLOR_SPIRAL:"Color Spiral",EFFECT_NAME_ARM_FLEX:"Arm Flex",EFFECT_NAME_SUPER_SPEED:"Super Speed",EFFECT_NAME_TARGET:"Target",EFFECT_NAME_YELLOW_SHIELD_SPIRAL:"Yellow Shield Spiral",EFFECT_NAME_PINK_STAR_CIRCLE:"Pink Star Circle",EFFECT_NAME_BLUE_STAR_CIRCLE:"Blue Star Circle",EFFECT_NAME_GREEN_STAR_CIRCLE:"Green Star Circle",EFFECT_NAME_GOLD_STAR_CIRCLE:"Gold Star Circle",EFFECT_NAME_BREAD:"Bread",EFFECT_NAME_YELLOW_FIRE_RING:"Yellow Fire Ring",EFFECT_NAME_TOTEMS:"Totems",EFFECT_NAME_EYE_BLINK:"Eye Blink",EFFECT_NAME_PINK_STAR:"Pink Star",EFFECT_NAME_ORANGE_STAR:"Orange Star",EFFECT_NAME_RED_EYE_BLINK:"Red Eye Blink",EFFECT_NAME_EAGLE:"Eagle",EFFECT_NAME_SLEEP:"Sleep",EFFECT_NAME_ARMOR:"Armor",EFFECT_NAME_BLIND_EYE_BLINK:"Blind Eye Blink",EFFECT_NAME_FIRE_RAIN:"Fire Rain",EFFECT_NAME_BLUE_RAIN:"Blue Rain",EFFECT_NAME_GREEN_RAIN:"Green Rain",EFFECT_NAME_LIGHTNING_RAIN:"Lightning Rain",EFFECT_NAME_PINK_RAIN:"Pink Rain",EFFECT_NAME_RAINBOW_RAIN:"Rainbow Rain"};var Qr=class extends Xr{constructor(){super(),this.spriteAnimation=null}set(e,t){super.set(e),this.spriteAnimation=t}getEffectType(){return al.SPRITE_EFFECT}getSprite(){return this.spriteAnimation.getSpriteAsOf(Date.now(),this.startTime)}};var $r=class extends Qr{constructor(){super(),this.effectPosition=new P(0,0)}set(e,t,i){super.set(e,t),this.effectPosition.copy(i)}updateEffectForFrameInternal(e){this.spriteAnimation.isAnimationLoopCompleted(this.getStartTime())&&!this.isFinishedAndAvailable()&&this.markEffectAsFinishedButInUse()}getPosition(){return this.effectPosition}};var es=class extends $e{constructor(){super(),this.initialCacheSize=20,this.growAmount=10}getGrowAmount(){return this.growAmount}getInitialSize(){return this.initialCacheSize}};var ts=class extends es{constructor(){super(),this.initialCacheSize=100,this.growAmount=50}getGrowAmount(){return this.growAmount}getInitialSize(){return this.initialCacheSize}createInstance(){return new $r}};var v=class extends jr{constructor(e,t,i,r,s){super(),this.spellFxSpritesheet=e,this.spriteName=t,this.spriteAnimation=null,this.soundEffect=i,this.lightSourceCreator=r,this.basicSpriteEffectCache=s}createEffect(e,t){!this.spriteAnimation&&this.spellFxSpritesheet&&(this.spriteAnimation=this.spellFxSpritesheet.getSpriteAnimation(this.spriteName));let i=this.basicSpriteEffectCache.get();return i.set(e,this.spriteAnimation,t),i}createEffectAtTile(e,t){!this.spriteAnimation&&this.spellFxSpritesheet&&(this.spriteAnimation=this.spellFxSpritesheet.getSpriteAnimation(this.spriteName));let i=this.basicSpriteEffectCache.get();return i.set(e,this.spriteAnimation,t.origin),i}createEffectAtPosition(e,t){!this.spriteAnimation&&this.spellFxSpritesheet&&(this.spriteAnimation=this.spellFxSpritesheet.getSpriteAnimation(this.spriteName));let i=this.basicSpriteEffectCache.get();return i.set(e,this.spriteAnimation,t),i}getSpriteAnimation(){return this.spriteAnimation}};var is=class extends F{constructor(e,t){super(),this.basicSpriteEffectCache=new ts,this.effectGreenSkull=new v(t,O.EFFECT_NAME_GREEN_SKULL,k.damage,e.darkGreenFlickering,this.basicSpriteEffectCache),this.damageEffectBloodSplatter=new v(t,O.DAMAGE_EFFECT_NAME_RED_SPLAT,k.damage,null,this.basicSpriteEffectCache),this.damageEffectRedDamage=new v(t,O.DAMAGE_EFFECT_NAME_RED_DAMAGE,k.damage,e.red,this.basicSpriteEffectCache),this.damageEffectWhiteDamage=new v(t,O.DAMAGE_EFFECT_NAME_WHITE_DAMAGE,k.damage,e.white,this.basicSpriteEffectCache),this.damageEffectBlueDamage=new v(t,O.DAMAGE_EFFECT_NAME_BLUE_DAMAGE,k.damage,e.darkBlue,this.basicSpriteEffectCache),this.damageEffectGreenDamage=new v(t,O.DAMAGE_EFFECT_NAME_GREEN_DAMAGE,k.damage,e.lightGreen,this.basicSpriteEffectCache),this.damageEffectShockDamage=new v(t,O.DAMAGE_EFFECT_NAME_SHOCK_DAMAGE,k.damage,e.lightBlueFlickering,this.basicSpriteEffectCache),this.damageEffectFireDamage=new v(t,O.DAMAGE_EFFECT_NAME_FIRE_DAMAGE,k.damage,e.orange,this.basicSpriteEffectCache),this.damageEffectPoisonDamage=new v(t,O.DAMAGE_EFFECT_NAME_POISON_DAMAGE,k.damage,e.darkGreen,this.basicSpriteEffectCache),this.damageEffectSonicDamage=new v(t,O.DAMAGE_EFFECT_NAME_SONIC_DAMAGE,k.damage,e.peach,this.basicSpriteEffectCache),this.damageEffectPinkDamage=new v(t,O.DAMAGE_EFFECT_NAME_PINK_DAMAGE,k.damage,null,this.basicSpriteEffectCache),this.effectSparkleGold=new v(t,O.EFFECT_NAME_SPARKLE_GOLD,k.damage,e.yellowFlickering,this.basicSpriteEffectCache),this.effectSparkleGreen=new v(t,O.EFFECT_NAME_SPARKLE_GREEN,k.damage,e.darkGreenFlickering,this.basicSpriteEffectCache),this.effectSparkleBlue=new v(t,O.EFFECT_NAME_SPARKLE_BLUE,k.damage,e.lightBlueFlickering,this.basicSpriteEffectCache),this.effectSparklePink=new v(t,O.EFFECT_NAME_SPARKLE_PINK,k.damage,e.peachFlickering,this.basicSpriteEffectCache),this.effectSparkleOrange=new v(t,O.EFFECT_NAME_SPARKLE_ORANGE,k.damage,e.redFlickering,this.basicSpriteEffectCache),this.effectSparkleRed=new v(t,O.EFFECT_NAME_SPARKLE_RED,k.damage,null,this.basicSpriteEffectCache),this.effectGreenSkull=new v(t,O.EFFECT_NAME_GREEN_SKULL,k.damage,e.darkGreenFlickering,this.basicSpriteEffectCache),this.effectYellowKey=new v(t,O.EFFECT_NAME_YELLOW_KEY,k.damage,e.peachFlickering,this.basicSpriteEffectCache),this.effectSkullCross=new v(t,O.EFFECT_NAME_SKULL_CROSS,k.damage,e.darkRed,this.basicSpriteEffectCache),this.effectShields=new v(t,O.EFFECT_NAME_SHIELDS,k.damage,e.darkBlue,this.basicSpriteEffectCache),this.effectRedCrosses=new v(t,O.EFFECT_NAME_RED_CROSSES,k.damage,e.yellow,this.basicSpriteEffectCache),this.effectFireRing=new v(t,O.EFFECT_NAME_FIRE_RING,k.damage,e.orange,this.basicSpriteEffectCache),this.effectIceRing=new v(t,O.EFFECT_NAME_ICE_RING,k.damage,e.lightBlue,this.basicSpriteEffectCache),this.effectGreenRing=new v(t,O.EFFECT_NAME_GREEN_RING,k.damage,e.lightGreen,this.basicSpriteEffectCache),this.effectPinkRing=new v(t,O.EFFECT_NAME_PINK_RING,k.damage,e.peach,this.basicSpriteEffectCache),this.effectYellowStar=new v(t,O.EFFECT_NAME_YELLOW_STAR,k.damage,null,this.basicSpriteEffectCache),this.effectBlueStar=new v(t,O.EFFECT_NAME_BLUE_STAR,k.damage,e.lightBlueFlickering,this.basicSpriteEffectCache),this.effectGreenStar=new v(t,O.EFFECT_NAME_GREEN_STAR,k.damage,e.lightGreenFlickering,this.basicSpriteEffectCache),this.effectWhiteCrosses=new v(t,O.EFFECT_NAME_WHITE_CROSSES,k.damage,e.cyan,this.basicSpriteEffectCache),this.effectWeb=new v(t,O.EFFECT_NAME_WEB,k.damage,null,this.basicSpriteEffectCache),this.effectTorch=new v(t,O.EFFECT_NAME_TORCH,k.damage,e.orange,this.basicSpriteEffectCache),this.effectFrost=new v(t,O.EFFECT_NAME_FROST,k.damage,e.white,this.basicSpriteEffectCache),this.effectYellowStarCircle=new v(t,O.EFFECT_NAME_YELLOW_STAR_CIRCLE,k.damage,null,this.basicSpriteEffectCache),this.effectCircles=new v(t,O.EFFECT_NAME_CIRCLES,k.damage,e.peach,this.basicSpriteEffectCache),this.effectGoldShieldSpiral=new v(t,O.EFFECT_NAME_GOLD_SHIELD_SPIRAL,k.damage,e.yellow,this.basicSpriteEffectCache),this.effectGreenShieldSpiral=new v(t,O.EFFECT_NAME_GREEN_SHIELD_SPIRAL,k.damage,e.lightGreen,this.basicSpriteEffectCache),this.effectBlueShieldSpiral=new v(t,O.EFFECT_NAME_BLUE_SHIELD_SPIRAL,null,e.lightBlue,this.basicSpriteEffectCache),this.effectPinkShieldSpiral=new v(t,O.EFFECT_NAME_PINK_SHIELD_SPIRAL,k.damage,e.peach,this.basicSpriteEffectCache),this.effectBlueFirework=new v(t,O.EFFECT_NAME_BLUE_FIREWORK,k.damage,e.lightBlue,this.basicSpriteEffectCache),this.effectRedFirework=new v(t,O.EFFECT_NAME_RED_FIREWORK,k.damage,e.red,this.basicSpriteEffectCache),this.effectStun=new v(t,O.EFFECT_NAME_BUBBLES,k.damage,e.peachFlickering,this.basicSpriteEffectCache),this.effectShield=new v(t,O.EFFECT_NAME_SHIELD,k.damage,e.lightGray,this.basicSpriteEffectCache),this.colorSpiralEffect=new v(t,O.EFFECT_NAME_COLOR_SPIRAL,k.damage,e.white,this.basicSpriteEffectCache),this.effectArmFlex=new v(t,O.EFFECT_NAME_ARM_FLEX,k.damage,e.lightBlue,this.basicSpriteEffectCache),this.effectSuperSpeed=new v(t,O.EFFECT_NAME_SUPER_SPEED,k.damage,e.yellow,this.basicSpriteEffectCache),this.effectTarget=new v(t,O.EFFECT_NAME_TARGET,k.damage,e.red,this.basicSpriteEffectCache),this.effectYellowShieldSpiral=new v(t,O.EFFECT_NAME_YELLOW_SHIELD_SPIRAL,k.damage,e.yellow,this.basicSpriteEffectCache),this.effectPinkStarCircle=new v(t,O.EFFECT_NAME_PINK_STAR_CIRCLE,k.damage,e.peach,this.basicSpriteEffectCache),this.effectBlueStarCircle=new v(t,O.EFFECT_NAME_BLUE_STAR_CIRCLE,k.damage,e.lightBlue,this.basicSpriteEffectCache),this.effectGreenStarCircle=new v(t,O.EFFECT_NAME_GREEN_STAR_CIRCLE,k.damage,e.lightGreen,this.basicSpriteEffectCache),this.effectGoldStarCircle=new v(t,O.EFFECT_NAME_GOLD_STAR_CIRCLE,k.damage,e.yellow,this.basicSpriteEffectCache),this.effectBread=new v(t,O.EFFECT_NAME_BREAD,k.damage,e.peach,this.basicSpriteEffectCache),this.effectYellowFireFing=new v(t,O.EFFECT_NAME_YELLOW_FIRE_RING,k.damage,e.yellow,this.basicSpriteEffectCache),this.effectTotems=new v(t,O.EFFECT_NAME_TOTEMS,k.damage,e.peach,this.basicSpriteEffectCache),this.effectEyeBlink=new v(t,O.EFFECT_NAME_EYE_BLINK,k.damage,e.orange,this.basicSpriteEffectCache),this.effectPinkStar=new v(t,O.EFFECT_NAME_PINK_STAR,k.damage,e.peachFlickering,this.basicSpriteEffectCache),this.effectOrangeStar=new v(t,O.EFFECT_NAME_ORANGE_STAR,k.damage,e.yellowFlickering,this.basicSpriteEffectCache),this.effectRedEyeBlink=new v(t,O.EFFECT_NAME_RED_EYE_BLINK,k.damage,e.red,this.basicSpriteEffectCache),this.effectEagle=new v(t,O.EFFECT_NAME_EAGLE,k.damage,e.lightBlue,this.basicSpriteEffectCache),this.effectSleep=new v(t,O.EFFECT_NAME_SLEEP,null,e.orange,this.basicSpriteEffectCache),this.effectArmor=new v(t,O.EFFECT_NAME_ARMOR,k.damage,e.red,this.basicSpriteEffectCache),this.effectBlindEyeBlink=new v(t,O.EFFECT_NAME_BLIND_EYE_BLINK,k.damage,e.lightBlue,this.basicSpriteEffectCache),this.effectFireRain=new v(t,O.EFFECT_NAME_FIRE_RAIN,k.damage,e.yellowFlickering,this.basicSpriteEffectCache),this.effectBlueRain=new v(t,O.EFFECT_NAME_BLUE_RAIN,k.damage,e.lightBlueFlickering,this.basicSpriteEffectCache),this.effectGreenRain=new v(t,O.EFFECT_NAME_GREEN_RAIN,k.damage,e.lightGreenFlickering,this.basicSpriteEffectCache),this.effectLightningRain=new v(t,O.EFFECT_NAME_LIGHTNING_RAIN,k.damage,e.yellowFlickering,this.basicSpriteEffectCache),this.effectPinkRain=new v(t,O.EFFECT_NAME_PINK_RAIN,k.damage,e.peachFlickering,this.basicSpriteEffectCache),this.effectRainbowRain=new v(t,O.EFFECT_NAME_RAINBOW_RAIN,k.damage,e.yellowFlickering,this.basicSpriteEffectCache)}resetFull(){this.basicSpriteEffectCache.resetCache()}resetForPrestige(){this.resetFull()}};var rs=class extends F{constructor(e){super(),this.projection=e,this.spriteEffects=[]}resetEffectList(e){if(e.length>0){for(let t=0;t<e.length;t++)e[t].reset(!0);e.length=0}}updateEffectsForFrame(e){this.updateEffectListForFrame(this.spriteEffects,e,!0)}updateEffectListForFrame(e,t,i){let r=!1;for(let s=e.length-1;s>=0;s--){let o=e[s];if(!o||o.isFinishedAndAvailable()){e.splice(s,1),r=!0;continue}o.updateEffectForFrame(t),o.isEffectFinished()&&(i&&!o.isFinishedAndAvailable()&&o.reset(!0),e.splice(s,1),r=!0)}return r}addEffect(e){this.addEffectWithSoundFlag(e,!0)}addEffectWithSoundFlag(e,t){if(!e||e.isFinishedAndAvailable())return;this.spriteEffects.push(e)}resetEffectManager(){this.resetEffectList(this.spriteEffects)}resetFull(){this.resetEffectManager()}resetForPrestige(){this.resetEffectManager()}};var ss=class extends qe{constructor(){super(),this.text="",this.textX=0,this.textY=0,this.frameCount=0,this.incrementX=0,this.incrementY=0,this.frameToggle=!1}set(e){this.text=e,this.incrementX=this.calculateTextMotion(),this.incrementY=1+(Math.random()>.5?1:0),this.frameToggle=!0,this.frameCount=0}calculateTextMotion(){let e=1+(Math.random()>.5?1:0);return Math.random()<.5?-e:e}isTextFinished(){return this.frameCount>=n.text.textFrameDuration}updateTextForFrame(e){return this.frameToggle&&(Math.random()<.5&&(this.textX+=this.incrementX),this.textY-=this.incrementY),this.frameToggle=!this.frameToggle,this.frameCount+=e,this.textY<=0||this.isTextFinished()}};var os=class extends $e{constructor(){super()}getGrowAmount(){return 10}getInitialSize(){return 10}createInstance(){return new ss}};var ns=class extends F{constructor(e){super(),this.projection=e,this.infoTextCache=new os,this.infoTextArray=[],this.workingVector=new P,this.one=new c(1)}addOreText(e,t){if(!this.projection.isVisibleGridBox(e))return;let i=L.formatBigNum(t);this.addCurrencyInternal(e,i)}addGoldText(e,t){if(this.projection.isVisibleGridBox(e))if(t.equals(this.one))this.addCurrencyInternal(e,"1 Gold");else{let i=L.formatBigNum(t)+" Gold";this.addCurrencyInternal(e,i)}}addRubyText(e){this.projection.isVisibleGridBox(e)&&this.addCurrencyInternal(e,"1 Ruby")}addSilverText(e,t){if(this.projection.isVisibleGridBox(e))if(t.equals(this.one))this.addCurrencyInternal(e,"1 Silver");else{let i=L.formatBigNum(t)+" Silver";this.addCurrencyInternal(e,i)}}addCurrencyInternal(e,t){if(!this.projection.isVisibleGridBox(e))return;for(;this.infoTextArray.length>=n.text.maxInfoTextCount;)this.infoTextArray[0].reset(!0),this.infoTextArray.splice(0,1);let i=this.infoTextCache.get();i.set(t),this.setTextPosition(i,e.origin),this.infoTextArray.push(i)}setTextPosition(e,t){this.projection.worldToScreen(t,this.workingVector),e.textX=this.workingVector.x+n.tile.halfSize,e.textY=this.workingVector.y}updateTextForFrame(e){for(let t=this.infoTextArray.length-1;t>=0;t--){let i=this.infoTextArray[t];i.updateTextForFrame(e)&&(i.reset(!0),this.infoTextArray.splice(t,1))}}clearInfoText(){this.infoTextArray.length>0&&(this.resetInfoTextList(this.infoTextArray),this.infoTextArray.length=0)}resetInfoTextList(e){for(let t=0;t<e.length;t++)e[t].reset(!0)}resetFull(){this.infoTextArray.length=0,this.infoTextCache.resetCache()}resetForPrestige(){this.resetFull()}};var jt=class extends F{constructor(){super(),this.totalOre=new c(0),this.totalGold=new c(0),this.totalRuby=new c(0),this.totalPrestigePoints=new c(0),this.totalSilver=new c(0),this.maxDepth=0,this.upgradeOre=new c(0),this.totalTurns=0,this.tilesMined=new c(0),this.tilesMinedCommon=new c(0),this.tilesMinedOre=new c(0),this.tilesMinedGold=new c(0),this.tilesMinedSilver=new c(0),this.tilesMinedRuby=new c(0),this.tilesMinedUpgrade=new c(0),this.tilesMinedLaser=new c(0),this.tilesMinedDrill=new c(0),this.tilesMinedOrbit=new c(0),this.tilesMinedFissure=new c(0),this.tilesMinedLightning=new c(0),this.tilesMinedMissile=new c(0),this.one=new c(1)}tileDepth(e){e>this.maxDepth&&(this.maxDepth=e)}onTileMined(e){switch(this.tilesMined.add(this.one),e.tileType.rarityModifier){case f.COMMON:this.tilesMinedCommon.add(this.one);break;case f.ORE:this.tilesMinedOre.add(this.one);break;case f.GOLD:this.tilesMinedGold.add(this.one);break;case f.SILVER:this.tilesMinedSilver.add(this.one);break;case f.RUBY:this.tilesMinedRuby.add(this.one);break;case f.UPGRADE:this.tilesMinedUpgrade.add(this.one);break}}incrementTurns(e){this.totalTurns+=e}incrementOre(e){this.totalOre.add(e)}incrementUpgradeOre(e){this.upgradeOre.add(e)}incrementGold(e){this.totalGold.add(e)}incrementRuby(e){this.totalRuby.add(e)}incrementPrestigePoints(e){this.totalPrestigePoints.add(e)}incrementSilver(e){this.totalSilver.add(e)}incrementMinedByLaser(){this.tilesMinedLaser.add(this.one)}incrementMinedByDrill(){this.tilesMinedDrill.add(this.one)}incrementMinedByOrbit(){this.tilesMinedOrbit.add(this.one)}incrementMinedByFissure(){this.tilesMinedFissure.add(this.one)}incrementMinedByLightning(){this.tilesMinedLightning.add(this.one)}incrementMinedByMissile(){this.tilesMinedMissile.add(this.one)}resetFull(){this.totalOre.setZero(),this.totalGold.setZero(),this.totalRuby.setZero(),this.totalSilver.setZero(),this.totalPrestigePoints.setZero(),this.upgradeOre.setZero(),this.maxDepth=0,this.totalTurns=0,this.tilesMined.setZero(),this.tilesMinedCommon.setZero(),this.tilesMinedOre.setZero(),this.tilesMinedGold.setZero(),this.tilesMinedSilver.setZero(),this.tilesMinedRuby.setZero(),this.tilesMinedUpgrade.setZero(),this.tilesMinedLaser.setZero(),this.tilesMinedDrill.setZero(),this.tilesMinedOrbit.setZero(),this.tilesMinedFissure.setZero(),this.tilesMinedLightning.setZero(),this.tilesMinedMissile.setZero()}resetForPrestige(){this.resetFull()}};var as=class{constructor(e,t){this.globalStatitics=e,this.runStatistics=t}incrementTurns(e){this.globalStatitics.incrementTurns(e),this.runStatistics.incrementTurns(e)}tileDepth(e){this.globalStatitics.tileDepth(e),this.runStatistics.tileDepth(e)}onTileMined(e){this.globalStatitics.onTileMined(e),this.runStatistics.onTileMined(e)}incrementOre(e){this.globalStatitics.incrementOre(e),this.runStatistics.incrementOre(e)}incrementUpgradeOre(e){this.globalStatitics.incrementUpgradeOre(e),this.runStatistics.incrementUpgradeOre(e)}incrementGold(e){this.globalStatitics.incrementGold(e),this.runStatistics.incrementGold(e)}incrementRuby(e){this.globalStatitics.incrementRuby(e),this.runStatistics.incrementRuby(e)}incrementSilver(e){this.globalStatitics.incrementSilver(e),this.runStatistics.incrementSilver(e)}incrementPrestigePoints(e){this.globalStatitics.incrementPrestigePoints(e),this.runStatistics.incrementPrestigePoints(e)}incrementMinedByLaser(){this.globalStatitics.incrementMinedByLaser(),this.runStatistics.incrementMinedByLaser()}incrementMinedByDrill(){this.globalStatitics.incrementMinedByDrill(),this.runStatistics.incrementMinedByDrill()}incrementMinedByOrbit(){this.globalStatitics.incrementMinedByOrbit(),this.runStatistics.incrementMinedByOrbit()}incrementMinedByFissure(){this.globalStatitics.incrementMinedByFissure(),this.runStatistics.incrementMinedByFissure()}incrementMinedByLightning(){this.globalStatitics.incrementMinedByLightning(),this.runStatistics.incrementMinedByLightning()}incrementMinedByMissile(){this.globalStatitics.incrementMinedByMissile(),this.runStatistics.incrementMinedByMissile()}};var Zt=class{constructor(e,t){this.title=e,this.iconFileName=t,this.purchasedCount=0}getTitle(){return this.title}getDescription(){return null}isPurchasable(){return this.isAffordable()}isAffordable(){return!1}getCost(){return null}getCostUnit(){return null}getPurchasedCount(){return this.purchasedCount}setPurchasedCount(e){this.purchasedCount=e}setPurchasedCountFromSave(e){this.setPurchasedCount(e)}purchase(){return!1}resetUpgrade(){this.purchasedCount=0}};var qt=class extends F{constructor(){super(),this.upgrades=[],this.changeCount=0}add(e){if(!e){console.log("UpgradeCollection.add() null upgrade");return}this.upgrades.push(e),this.changeCount++}addBulk(e){if(!e){console.log("UpgradeCollection.addBulk() null upgrade");return}this.upgrades.push(e)}addBulkCompleted(){this.changeCount++}remove(e){if(!e){console.log("UpgradeCollection.remove() upgrade null");return}let t=this.upgrades.indexOf(e);if(t===-1){console.log("UpgradeCollection.remove() did not find upgrade in list");return}this.upgrades.splice(t,1),this.changeCount++}resetFull(){this.upgrades.length=0,this.changeCount=0}resetForPrestige(){this.resetFull()}};var ls=class{constructor(e,t,i,r){this.values=e,this.totals=t,this.damage=i,this.globalStatistics=r,this.workingMineDamage=new c(0),this.oneBigNum=new c(1),this.perFrameConversionFactor=new c(1/n.time.turnFrames)}calculateTotalMineDamagePerTurn(){this.damage.baseDamagePerTurn.copy(this.damage.basePickDamagePerTurn),this.damage.baseDamagePerTurn.add(this.values.baseAdditiveBonusPerTurn.getValue()),this.damage.oreDamageMultiplier.copy(this.oneBigNum),this.damage.oreDamageMultiplier.add(this.values.baseMultiplicativeBonusValue.getValue()),this.damage.minedDamageMultiplier.copy(this.oneBigNum),this.damage.minedDamageMultiplier.add(this.values.minedDamageBonusMultiplier.getValue());let e=this.values.skillSilverBonusMultiplier.getValue();e>0?(this.damage.silverDamageMultiplier.setValue(e),this.damage.silverDamageMultiplier.mul(this.totals.silverSum),this.damage.silverDamageMultiplier.add(this.oneBigNum)):this.damage.silverDamageMultiplier.copy(this.oneBigNum),this.totals.ruby.greaterThanZero()?(this.damage.rubyDamageMultiplier.setValue(this.values.skillRubyBonusMultiplier.getValue()),this.damage.rubyDamageMultiplier.add(this.oneBigNum),this.damage.rubyDamageMultiplier.mul(this.totals.ruby)):this.damage.rubyDamageMultiplier.copy(this.oneBigNum);let t=this.values.skillBlockBonusMultiplier.getValue();t>0&&this.globalStatistics.tilesMined.greaterThanZero()?(this.damage.blockDamageMultiplier.copy(this.globalStatistics.tilesMined),this.damage.blockDamageMultiplier.mulNumber(t),this.damage.blockDamageMultiplier.add(this.oneBigNum)):this.damage.blockDamageMultiplier.copy(this.oneBigNum);let i=this.values.skillDepthBonusMultiplier.getValue();i>0?(this.damage.depthDamageMultiplier.setValue(i),this.damage.depthDamageMultiplier.mulNumber(this.globalStatistics.maxDepth),this.damage.depthDamageMultiplier.add(this.oneBigNum)):this.damage.depthDamageMultiplier.copy(this.oneBigNum);let r=this.values.skillGoldBonusMultiplier.getValue();r>0?(this.damage.goldDamageMultiplier.setValue(r),this.damage.goldDamageMultiplier.add(this.oneBigNum)):this.damage.goldDamageMultiplier.copy(this.oneBigNum),this.workingMineDamage.copy(this.damage.baseDamagePerTurn),this.damage.oreDamageMultiplier.greaterThan(this.oneBigNum)&&this.workingMineDamage.multiply(this.damage.oreDamageMultiplier),this.damage.minedDamageMultiplier.greaterThan(this.oneBigNum)&&this.workingMineDamage.multiply(this.damage.minedDamageMultiplier),this.damage.silverDamageMultiplier.greaterThan(this.oneBigNum)&&this.workingMineDamage.multiply(this.damage.silverDamageMultiplier),this.damage.depthDamageMultiplier.greaterThan(this.oneBigNum)&&this.workingMineDamage.multiply(this.damage.depthDamageMultiplier),this.damage.goldDamageMultiplier.greaterThan(this.oneBigNum)&&this.workingMineDamage.multiply(this.damage.goldDamageMultiplier),this.damage.rubyDamageMultiplier.greaterThan(this.oneBigNum)&&this.workingMineDamage.multiply(this.damage.rubyDamageMultiplier),this.damage.blockDamageMultiplier.greaterThan(this.oneBigNum)&&this.workingMineDamage.multiply(this.damage.blockDamageMultiplier),this.damage.totalPickDamagePerTurn.copy(this.workingMineDamage),this.damage.totalPickDamagePerFrame.copy(this.damage.totalPickDamagePerTurn),this.damage.totalPickDamagePerFrame.mul(this.perFrameConversionFactor)}};var hs=class{constructor(e){this.values=e,this.one=new c(1),this.workingBonus=new c(0)}calculateOreForDepth(e,t){e.tileType.layerDescription.calculateTileOre(e.getTileRow(),t),this.applyMultipliers(t)}applyMultipliers(e){let t=this.values.skillOreBonusMultiplier.getValue();t.greaterThanZero()&&(this.workingBonus.copy(this.one),this.workingBonus.add(t),e.mul(this.workingBonus));let i=this.values.goldOreBonusMultiplier.getValue();i.greaterThanZero()&&(this.workingBonus.copy(this.one),this.workingBonus.add(i),e.mul(this.workingBonus))}};var b={pick:"images/pick_40x40.png",miner:"images/pick_40x40.png",offline:"images/pick_40x40.png",block:"images/layers/dirt.png",currency:{ore:"images/layers/purple_ore.png",gold:"images/layers/gold.png",ruby:"images/layers/ruby.png",prestige:"images/pick_40x40.png",silver:"images/layers/silver.png",depth:"images/pick_40x40.png",upgrades:"images/upgrades_40x40.png"},skill:{missiles:"images/missile_40x40.png",orbit:"images/orbit_40x40.png",laser:"images/laser_40x40.png",lightning:"images/laser_40x40.png",chain:"images/laser_40x40.png",drill:"images/drill_40x40.png",radar:"images/laser_40x40.png",fissure:"images/laser_40x40.png",minions:"images/laser_40x40.png",dynamite:"images/dynamite_40x40.png",damage:"images/laser_40x40.png",activation:"images/laser_40x40.png"}};var ds=class{constructor(e){this.id=e}getId(){return this.id}createMinedUpgrade(e){}createFreeValueUpgradeFromSave(e){}createFreeIdentifierUpgradeFromSave(e){}combineUpgrades(e,t){if(!e||!t){console.log("UpgradeCreator.combineUpgrade() null upgrade");return}if(e.getCreatorId()!==t.getCreatorId()){console.log("UpgradeCreator.combineUpgrade() creatorId mismatch");return}if(this.id!==e.getCreatorId()||this.id!==t.getCreatorId()){console.log("UpgradeCreator.combineUpgrade() creatorId does not match upgrade creator");return}this.combineUpgradesInternal(e,t)}combineUpgradesInternal(e,t){}};var Jt=class extends Zt{constructor(e,t,i){super(t,i),this.upgradeCreator=e,this.frameCount=0,this.delayFrames=n.time.turnsPerSecond*n.time.turnFrames*6}getCreatorId(){return this.upgradeCreator.id}isCombineSupported(){return!1}isPurchasable(){return this.purchasedCount===0}isAffordable(){return!0}updateForFrame(e){return this.frameCount+=e,this.frameCount>=this.delayFrames?(this.purchase(),!0):!1}getAutoClaimPercent(){return Math.min(1,this.frameCount/this.delayFrames)*100|0}purchase(){return this.purchasedCount>0?!1:(this.purchasedCount++,this.onUpgradePurchased(),!0)}onUpgradePurchased(){}};var us=class extends Jt{constructor(e,t,i,r,s,o){super(e,t,i),this.valueDelta=r,this.upgradeBonusValue=s,this.mineDamageLogic=o}onUpgradePurchased(){this.upgradeBonusValue.incrementValue(this.valueDelta),this.mineDamageLogic&&this.mineDamageLogic.calculateTotalMineDamagePerTurn()}isCombineSupported(){return!0}};var Qt=class extends ds{constructor(e,t,i){super(e),this.values=t,this.multiplierValue=i}getUpgradeBonusMultiplier(){let e=this.multiplierValue.getValue();return e>1?e:1}};var ct={mineDamage:"mineDamage",mineOre:"mineOre"};var cs=class extends Qt{constructor(e,t){super(ct.mineDamage,e,null),this.mineDamageLogic=t}createMinedUpgrade(e){let t=Se.calculateMinedDamageUpgradeValue(e),i=this.values.skillMinedDamageBonus.getValue();return i>0&&t.addNumber(i),this.createInternal(t)}createFreeValueUpgradeFromSave(e){return this.createInternal(e)}createInternal(e){let t=this.createTitle(e);return new us(this,t,b.pick,e,this.values.minedDamageBonusMultiplier,this.mineDamageLogic)}combineUpgradesInternal(e,t){e.valueDelta.add(t.valueDelta),e.title=this.createTitle(e.valueDelta)}createTitle(e){return"Multiplier: +"+L.formatBigNum(e)}};var ms=class extends Jt{constructor(e,t,i,r,s,o){super(e,t,i),this.ore=r,this.totals=s,this.statisticsInc=o}onUpgradePurchased(){this.totals.incrementOre(this.ore),this.statisticsInc.incrementOre(this.ore),this.statisticsInc.incrementUpgradeOre(this.ore)}isCombineSupported(){return!0}};var ps=class extends Qt{constructor(e,t,i,r){super(ct.mineOre,e,null),this.oreCalculationLogic=t,this.totals=i,this.statisticsInc=r}createMinedUpgrade(e){let t=new c(0);this.oreCalculationLogic.calculateOreForDepth(e,t);let i=n.skill.bonus.minedOreBaseTiles+de.randomInt(n.skill.bonus.minedOreMaxExtraTiles);return t.mulNumber(i),this.createInternal(t)}createFreeValueUpgradeFromSave(e){return this.createInternal(e)}createInternal(e){let t=this.createTitle(e);return new ms(this,t,b.pick,e,this.totals,this.statisticsInc)}combineUpgradesInternal(e,t){e.ore.add(t.ore),e.title=this.createTitle(e.ore)}createTitle(e){return"Ore: +"+L.formatBigNum(e)}};var gs=class extends qt{constructor(){super(),this.combineUpgradeThreshold=8}updateForFrame(e){for(let t=this.upgrades.length-1;t>=0;t--)this.upgrades[t].updateForFrame(e)&&(this.upgrades.splice(t,1),this.changeCount++)}contains(e){for(let t=0;t<this.upgrades.length;t++)if(this.upgrades[t].getCreatorId()===e)return!0;return!1}add(e){super.add(e),this.upgrades.length>this.combineUpgradeThreshold&&this.combineUpgrades()}combineUpgrades(){for(let e=0;e<this.upgrades.length-1;e++){let t=this.upgrades[e];if(t.isCombineSupported())for(let i=this.upgrades.length-1;i>e;i--){let r=this.upgrades[i];if(r.isCombineSupported()&&t.getCreatorId()===r.getCreatorId()){t.upgradeCreator.combineUpgrades(t,r),this.upgrades.splice(i,1),this.changeCount++;break}}}}};var fs=class{constructor(e,t,i,r,s,o){this.creatorsById={},this.minedUpgradeCollection=s,this.mineDamage=new cs(e,r),this.creatorsById[this.mineDamage.getId()]=this.mineDamage,this.oreBonus=new ps(e,i,t,o),this.creatorsById[this.oreBonus.getId()]=this.oreBonus}getUpgradeCreatorById(e){return this.creatorsById[e]}getUpgradeCreatorForDrop(){return Math.random()<.65?this.oreBonus:this.mineDamage}};var Ts=class{constructor(){this.crewBrainDebugEnabled=!1,this.maxFps=-1,this.displayFps=!1,this.effectsRenderingEnabled=!0,this.depthColumnRendered=!0,this.wireframeModeEnabled=!1}getFpsMillis(){return this.maxFps<=0?1e3/250:1e3/this.maxFps}};var Es=class{constructor(e,t,i,r,s,o,a,h,u,m,g,_,C){this.crew=e,this.totals=t,this.damage=i,this.values=r,this.statisticsInc=s,this.upgradeCollection=o,this.upgradeCreators=a,this.infoTextProcessor=h,this.effectCreators=u,this.effectManager=m,this.oreCalculationLogic=g,this.mineDamageLogic=_,this.gameOptions=C,this.workingValue=new c(0),this.workingDamage=new c(0),this.turnsPerSecond=new c(n.time.turnsPerSecond),this.one=new c(1)}mineTileIstantly(e,t){!t||t.open||(t.onTileBreak(),this.revealTilesAfterMine(e,t),this.statisticsInc.onTileMined(t),this.handleTileDrops(t))}mineTileForTurn(e,t){return!t||t.open?!0:(this.workingDamage.copy(this.damage.totalPickDamagePerTurn),t.onTileDamaged(this.workingDamage),t.open?(this.revealTilesAfterMine(e,t),this.statisticsInc.onTileMined(t),this.handleTileDrops(t),!0):!1)}revealTilesAfterMine(e,t){let i=this.getOppositeTile(e.position.tile,t);if(i){this.revealTile(i);for(let r=0;r<i.neighbors.length;r++)this.revealTile(i.neighbors[r]);this.revealTile(i.getNeighborBottomLeft()),this.revealTile(i.getNeighborBottomRight()),this.revealTile(i.getNeighborTopLeft()),this.revealTile(i.getNeighborTopRight())}}revealTile(e){e&&e.markTileAsCurrentlyVisible()}getOppositeTile(e,t){return e?t.isNeighborLeft(e)?t.getNeighborRight():t.isNeighborRight(e)?t.getNeighborLeft():t.isNeighborBottom(e)?t.getNeighborTop():t.isNeighborTop(e)?t.getNeighborBottom():null:null}laserTileForFrame(e,t){!e||e.open||(this.skillDamageForFrame(e,t,this.effectCreators.effectSparkleRed),e.open&&this.statisticsInc.incrementMinedByLaser())}drillTileForFrame(e,t){!e||e.open||(this.skillDamageForFrame(e,t,this.effectCreators.effectSparkleBlue),e.open&&this.statisticsInc.incrementMinedByDrill())}orbitTileForFrame(e,t){!e||e.open||(this.skillDamageForFrame(e,t,this.effectCreators.effectSparkleGold),e.open&&this.statisticsInc.incrementMinedByOrbit())}calculateMissileDamage(e){return e.copy(this.damage.totalPickDamagePerTurn),e}missileTile(e,t){if(!e||e.open)return;let i=e.getHealth();i.lessThan(t)?(t.sub(i),e.onTileBreak(),e.markTileAsCurrentlyVisible(),this.handleTileDrops(e),this.statisticsInc.incrementMinedByMissile()):(e.onTileDamaged(t),t.setZero())}applyFissureSkillForFrame(e,t){!e||e.open||(this.skillDamageForFrame(e,t,null),e.open&&this.statisticsInc.incrementMinedByFissure())}applyLightningSkillForFrame(e,t){!e||e.open||(this.skillDamageForFrame(e,t,this.effectCreators.effectSparkleOrange),e.open&&this.statisticsInc.incrementMinedByLightning())}skillDamageForFrame(e,t,i){if(!(!e||e.open)&&(this.workingDamage.copy(this.damage.totalPickDamagePerFrame),this.workingDamage.mulNumber(t),e.onTileDamaged(this.workingDamage),e.open&&(this.statisticsInc.onTileMined(e),e.markTileAsCurrentlyVisible(),this.handleTileDrops(e),i&&this.gameOptions.effectsRenderingEnabled))){let r=i.createEffectAtPosition(null,e.origin);r?this.effectManager.addEffect(r):console.log("TileMinedLogic.skillDamageForFrame. FAILED TO CREATE SPRITE")}}handleTileDrops(e){let t=e.tileType,i=t.rarityModifier;if(!(i===f.UNSET||i===f.COMMON)){if(this.workingValue.setZero(),i===f.ORE)this.oreCalculationLogic.calculateOreForDepth(e,this.workingValue),this.totals.incrementOre(this.workingValue),this.statisticsInc.incrementOre(this.workingValue),this.infoTextProcessor.addOreText(e,this.workingValue);else if(i===f.GOLD){e.calculateTileGold(this.workingValue);let r=this.values.goldPerBlockBonus.getValue();r.greaterThanZero()&&this.workingValue.add(r),this.totals.incrementGold(this.workingValue),this.statisticsInc.incrementGold(this.workingValue),this.infoTextProcessor.addGoldText(e,this.workingValue)}else if(i===f.UPGRADE){let s=this.upgradeCreators.getUpgradeCreatorForDrop().createMinedUpgrade(e);s?this.upgradeCollection.add(s):console.log("TileMinedLogic.handleTileDrops() no upgrade created")}else if(i===f.RUBY)this.totals.incrementRuby(this.one),this.statisticsInc.incrementRuby(this.one),this.infoTextProcessor.addRubyText(e),this.mineDamageLogic.calculateTotalMineDamagePerTurn();else if(i===f.SILVER){this.workingValue.copy(t.layerDescription.silver);let r=this.values.silverPerBlockBonus.getValue();r.greaterThanZero()&&this.workingValue.add(r),this.totals.incrementSilver(this.workingValue),this.statisticsInc.incrementSilver(this.workingValue),this.infoTextProcessor.addSilverText(e,this.workingValue),this.mineDamageLogic.calculateTotalMineDamagePerTurn()}}}};var Ss=class extends F{constructor(){super(),this.commonMiningCandidates=[],this.priorityMiningCandidates=[],this.destinationTileCandidates=[],this.ignoreCommonTiles=!1,this.ignorePriorityTiles=!1,this.centerTile=null,this.targetListNumber=0,this.tileHealthNegligible=!1}isMineTargetsEmpty(){return this.commonMiningCandidates.length===0&&this.priorityMiningCandidates.length===0}isPriorityTileVisible(){return this.priorityMiningCandidates.length===0?!1:this.isClosedTileInList(this.priorityMiningCandidates)}isClosedTileInList(e){for(let t=0;t<e.length;t++)if(!e[t].open)return!0;return!1}onGridUnload(e){return this.centerTile&&this.centerTile.grid===e?(this.reset(),!0):(this.removeTilesForGrid(e,this.commonMiningCandidates),this.removeTilesForGrid(e,this.priorityMiningCandidates),!1)}removeTilesForGrid(e,t){for(let i=t.length-1;i>=0;i--)t[i].grid===e&&t.splice(i,1)}resetFull(){this.reset()}resetForPrestige(){this.reset()}reset(){this.commonMiningCandidates.length>0&&(this.commonMiningCandidates.length=0),this.priorityMiningCandidates.length>0&&(this.priorityMiningCandidates.length=0),this.centerTile=null,this.targetListNumber++,this.targetListNumber>1e5&&(this.targetListNumber=0)}};var Cs=class{constructor(e){this.subject=e,this.startTime=performance.now(),this.elapsed=0,this.count=0}startTimer(){this.startTime=performance.now()}endTimer(){this.elapsed+=performance.now()-this.startTime,this.count++}reset(){this.startTime=performance.now(),this.elapsed=0,this.count=0}};var $t={},K=class{constructor(){}static startTime(e){let t=$t[e];t||(t=new Cs(e),$t[e]=t),t.startTimer()}static endTime(e){let t=$t[e];if(!t){console.log("PerformanceMetrics: failed to find: "+e);return}t.endTimer()}static getKeys(){return Object.keys($t)}static getPerformanceTrack(e){return $t[e]}static reset(){for(let[e]of Object.entries($t)){let t=$t[e];t&&t.reset()}}};var ws=class{constructor(){this.tiles=new Array(100);for(let t=0;t<100;t++)this.tiles[t]=null;this.pathBuilder=new Array(100);for(let t=0;t<100;t++)this.tiles[t]=null;this.pathBuilderIndex=0,this.size=0}add(e){if(this.size>=this.tiles.length)for(let t=0;t<20;t++)this.tiles.push(null);this.tiles[this.size]=e,this.size++}addToFrontStart(){this.pathBuilderIndex=0}addToFrontEnd(){for(let e=this.pathBuilderIndex-1;e>=0;e--)this.add(this.pathBuilder[e])}addToFront(e){if(this.pathBuilderIndex>=this.pathBuilder.length)for(let t=0;t<20;t++)this.pathBuilder.push(null);this.pathBuilder[this.pathBuilderIndex]=e,this.pathBuilderIndex++}reset(){this.size=0}};var Ls=class{constructor(e){this.worldGrid=e,this.movementVector=new P(0,0),this.position=new P(0,0),this.nearZero=.001}findPath(e,t,i){if(!t||!i)return!1;if(t===i)return e.add(i),!0;if(t.isNeighborTile(i))return e.add(t),e.add(i),!0;this.position.copy(t.origin);let r=t;e.add(r);let s=n.tile.halfSize;this.movementVector.copy(i.origin),this.movementVector.subtract(this.position);let o=U.len(this.movementVector);if(Math.abs(o)<this.nearZero)return!0;let a=0;this.movementVector.scale(s/o);let h=!1;do if(this.position.add(this.movementVector),a+=s,!r.contains(this.position)){let u=r,m=r.getNeighbor(this.position);if(!m&&(console.log("DirectLinePathFinder.findPath() stepped to non-neighbor tile somehow!"),m=this.worldGrid.findGridTile(this.position),!m))return!1;if(r=m,this.checkForDiagonal(e,u,r),e.add(r),r===i){h=!0;break}}while(a<o&&r!==i);return h||e.add(i),!0}checkForDiagonal(e,t,i){if(!i.isNeighborTile(t)){let r=t.getNeighborLeft(),s=t.getNeighborRight(),o=t.getNeighborTop(),a=t.getNeighborBottom();i===t.getNeighborBottomLeft()?a.open?e.add(a):e.add(r):i===t.getNeighborBottomRight()?a.open?e.add(a):e.add(s):i===t.getNeighborTopLeft()?o.open?e.add(o):e.add(r):i===t.getNeighborTopRight()&&(o.open?e.add(o):e.add(s))}}};var Si=class{constructor(){this.score=0,this.tile=null}reset(){this.score=0,this.tile=null}set(e,t){this.score=e,this.tile=t}copy(e){this.score=e.score,this.tile=e.tile}};var _s=class{constructor(){this.queue=new Array(100);for(let t=0;t<100;t++)this.queue[t]=new Si;this.size=0}add(e,t){this.size>=this.queue.length&&this.grow(this.size+1),this.siftUpUsingComparator(this.size,e,t),this.size=this.size+1}grow(e){let t=this.queue.length,i=e-t,r=t<64?t+2:t>>1,s=Math.max(i,r);console.log("PriorityQueue2.grow() length="+this.queue.length+" min="+i+" pref="+r+" amount="+s);for(let o=0;o<s;o++)this.queue.push(new Si);console.log("PriorityQueue2.grow() new length: "+this.queue.length)}siftUpUsingComparator(e,t,i){for(;e>0;){let r=e-1>>>1,s=this.queue[r];if(this.compare(t,s.score)>=0)break;this.queue[e].copy(s),e=r}this.queue[e].set(t,i)}siftDownUsingComparator(e,t,i){let r=this.size>>>1;for(;e<r;){let s=(e<<1)+1,o=this.queue[s],a=s+1;if(a<this.size&&this.compare(o.score,this.queue[a].score)>0&&(s=a,o=this.queue[s]),this.compare(t,o.score)<=0)break;this.queue[e].copy(o),e=s}this.queue[e].set(t,i)}poll(){let t=this.queue[0].tile;this.size--;let i=this.queue[this.size],r=i.tile,s=i.score;return i.reset(),this.size>0&&this.siftDownUsingComparator(0,s,r),t}compare(e,t){return e-t}isEmpty(){return this.size===0}clear(){for(let e=0;e<this.size;e++)this.queue[e].reset();this.size=0}};var Ms=class{constructor(){this.openAirTileCost=n.tile.size*15,this.closedTileCost=n.tile.size*30,this.gravityDiscount=n.tile.halfSize,this.maxPathDistance=n.tile.size*80,this.openList=new _s,this.pathNumber=0,this.diagonalSize=Math.sqrt(n.tile.size*n.tile.size+n.tile.size*n.tile.size)|0}findPathSpecialCases(e,t,i,r){if(t===i)return r&&e.add(i),!0;if(t.isNeighborTile(i))return r&&(e.add(t),e.add(i)),!0;let s=U.dist(t.origin,i.origin);return s>this.maxPathDistance?(console.log("Path too long: "+s/n.tile.size+" max: "+this.maxPathDistance/n.tile.size),!0):!1}findPath(e,t,i,r,s,o){if(!t||!i){console.log("findPath() null start/end");return}if(this.findPathSpecialCases(e,t,i,r))return;this.pathNumber++,this.openList.clear(),t.pathData.setCost(0,this.pathNumber),this.openList.add(0,t),t.pathData.setInOpenList(!0,this.pathNumber);let a;for(;!this.openList.isEmpty();){if(a=this.openList.poll(),!a){console.log("PathFinder.findPath() current is null. bug");break}if(a.pathData.setInOpenList(!1,this.pathNumber),a===i){this.constructPath(e,i,r);break}else{a.pathData.setClosed(!0,this.pathNumber);let h=a.pathData.getCost(this.pathNumber),u=a.getNeighborBottom(),m=!u||u.isTraversable(),g=a.getNeighbors();for(let _=0;_<g.length;_++){let C=g[_];if(!C||C.pathData.isClosed(this.pathNumber))continue;let w=0;m&&(_===1?w-=this.gravityDiscount:w+=this.openAirTileCost),!C.open&&s&&!o&&(w+=this.closedTileCost);let T=h+this.distanceBetween(a,C)+w,S=C.pathData.isInOpenList(this.pathNumber);if(S&&T>=C.pathData.getCost(this.pathNumber))continue;let R=T+this.calculateHeuristicCostEstimate(C,i);C.pathData.set(a,T,R,this.pathNumber),S||(this.openList.add(R,C),C.pathData.setInOpenList(!0,this.pathNumber))}}}}calculateHeuristicCostEstimate(e,t){return U.dist(e.getOrigin(),t.getOrigin())|0}distanceBetween(e,t){let i=e.getOrigin(),r=t.getOrigin();return i.x==r.x?n.tile.size:i.y==r.y?n.tile.size:this.diagonalSize}constructPath(e,t,i){let r;if(i)r=t;else if(r=t.pathData.getCameFrom(this.pathNumber),r==null)return;e.addToFrontStart();do e.addToFront(r),r=r.pathData.getCameFrom(this.pathNumber);while(r!=null);e.addToFrontEnd()}};var x={IGNORE:-10,OPEN:-9,OPEN_OR_PATH:-11,CLOSED:-8,START:0,END:1e3,PATH:2e3};var z=class{constructor(e,t){this.startCol=0,this.startRow=0,this.endCol=0,this.endRow=0,this.startColFlipped=0,this.startRowFlipped=0,this.endColFlipped=0,this.endRowFlipped=0,this.pathCount=0,this.pattern=this.convertPattern(e),this.flippedPattern=t?this.convertFlippedPattern(e):null}getMinRequiredPathSteps(){}getPlanIfMatch(e,t,i,r,s){return this.isMatch(i,r,s,this.pattern,this.startCol,this.startRow,this.endCol,this.endRow)?this.getPathPlan(e,t):this.flippedPattern&&this.isMatch(i,r,s,this.flippedPattern,this.startColFlipped,this.startRowFlipped,this.endColFlipped,this.endRowFlipped)?this.getPathPlanFlipped(e,t):null}getPathPlan(e,t){}getPathPlanFlipped(e,t){}isMatch(e,t,i,r,s,o,a,h){if(i.length===0)return!1;let u=e-s,m=t-o;if(u<0||m<0)return!1;let g=i[e][t];if(g<0)return!1;let _=e+(a-s),C=t+(h-o);if(_>=i.length)return!1;let w=i[_];if(C>=w.length||w[C]<g)return!1;for(let S=0;S<r.length;S++){let R=r[S];for(let y=0;y<R.length;y++){let I=R[y];if(I===x.IGNORE||I===x.START||I===x.END)continue;let N=u+S,D=m+y;if(N>=i.length)return!1;let Q=i[N];if(D>=Q.length)return!1;let V=Q[D];if(I===x.OPEN_OR_PATH){if(V===x.OPEN||V>0)continue;return!1}else if(I===x.OPEN){if(V===x.OPEN)continue;return!1}else if(I===x.CLOSED){if(V===x.CLOSED)continue;return!1}else if(I===x.PATH){if(V<0)return!1}else return!1}}return!0}convertPattern(e){if(!e||e.length===0)return console.log("PathTemplatePattern.convertPattern() Invalid empty string pattern"),[];let t=e[0].length,i=e.length,r=new Array(t);for(let s=0;s<t;s++){let o=new Array(i);o.fill(x.IGNORE),r[s]=o}for(let s=0;s<i;s++){let o=e[s];for(let a=0;a<t;a++){let h=o.charAt(a),u=this.convertPatternChar(h);u===x.START?(this.startCol=a,this.startRow=s):u===x.END?(this.endCol=a,this.endRow=s):u===x.PATH&&this.pathCount++,r[a][s]=u}}return r}convertFlippedPattern(e){if(!e||e.length===0)return console.log("PathTemplatePattern.convertPattern() Invalid empty string pattern"),[];let t=e[0].length,i=e.length,r=new Array(t);for(let s=0;s<t;s++){let o=new Array(i);o.fill(x.IGNORE),r[s]=o}for(let s=0;s<i;s++){let o=e[s],a=0;for(let h=t-1;h>=0;h--){let u=o.charAt(h),m=this.convertPatternChar(u);m===x.START?(this.startColFlipped=a,this.startRowFlipped=s):m===x.END&&(this.endColFlipped=a,this.endRowFlipped=s),r[a][s]=m,a++}}return r}convertPatternChar(e){switch(e){case"S":return x.START;case"E":return x.END;case"P":return x.PATH;case"X":return x.CLOSED;case"O":return x.OPEN;case"8":return x.OPEN_OR_PATH;case".":return x.IGNORE}return console.log("PathTemplatePattern.convertPatternChar() Invalid char: "+e),x.IGNORE}findTilePathIndex(e,t,i,r){for(let s=t;s<e.size;s++){let o=e.tiles[s];if(!(o.getTileCol()!==i||o.getTileRow()!=r))return s}return console.log("PathTemplatePattern.findTilePathIndex() failed to find tile in path."),-1}printPattern(e){if(e.length===0){console("printPattern() template empty");return}let t=e[0].length;for(let i=0;i<t;i++){let r="";for(let s=0;s<e.length;s++){let o=e[s][i];o===x.IGNORE?r+=".":o===x.PATH?r+="P":o===x.OPEN?r+="0":o===x.OPEN_OR_PATH?r+="8":o===x.CLOSED?r+="X":o===x.START?r+="S":o===x.END?r+="E":r+="?"}console.log(r)}}toString(){}};var Rs=class{constructor(){this.template=this.initializeTemplate(30,30),this.startColIndex=0,this.startRowIndex=0}updateTemplate(e,t){this.buildTemplate(e,t)}getPlanIfPatternMatch(e,t,i){let r=t.tiles[i],s=r.getTileCol(),o=r.getTileRow(),a=t.tiles[0],h=a.getTileCol(),u=a.getTileRow(),m=this.startColIndex+(s-h),g=this.startRowIndex+(o-u);return e.getPlanIfMatch(t,i,m,g,this.template)}buildTemplate(e,t){if(e.size<2)return;let i=e.tiles[0],r=i.getTileCol(),s=r,o=i.getTileRow(),a=o;for(let w=1;w<e.size;w++){let T=e.tiles[w],S=T.getTileCol(),R=T.getTileRow();r=Math.min(r,S),s=Math.max(s,S),o=Math.min(o,R),a=Math.max(a,R)}r--,o--,s+=2,a+=2;let h=s-r,u=a-o;this.growAndClearTemplate(h,u);let m=e.tiles[0];this.startColIndex=m.getTileCol()-r,this.startRowIndex=m.getTileRow()-o;let g=this.startColIndex,_=this.startRowIndex;t?this.populateNegligibleTileAndNeighbors(m,g,_,0):this.populateTileAndNeighbors(m,g,_,0);let C=m;for(let w=1;w<e.size;w++){let T=e.tiles[w];g+=T.getTileCol()-C.getTileCol(),_+=T.getTileRow()-C.getTileRow(),t?this.populateNegligibleTileAndNeighbors(T,g,_,w):this.populateTileAndNeighbors(T,g,_,w),C=T}}initializeTemplate(e,t){let i=new Array(e);for(let r=0;r<e;r++){let s=new Array(t);s.fill(x.IGNORE),i[r]=s}return i}growAndClearTemplate(e,t){let i=this.template.length,r=this.template[0].length,s=!1;if(r<t){for(let o=0;o<this.template.length;o++){let a=this.template[o],h=a.length;a.length=t;for(let u=h;u<t;u++)a[u]=x.IGNORE}s=!0}if(i<e){this.template.length=e;let o=Math.max(r,t);for(let a=i;a<e;a++){let h=new Array(o);for(let u=0;u<o;u++)h[u]=x.IGNORE;this.template[a]=h}s=!0}for(let o=0;o<this.template.length;o++)this.template[o].fill(x.IGNORE);s&&console.log("PathTemplate grew. ["+this.template.length+"]["+this.template[0].length+"]")}populateTileAndNeighbors(e,t,i,r){if(e.open?this.template[t][i]=r:this.template[t][i]=x.CLOSED,this.template[t][i-1]===x.IGNORE){let s=e.getNeighborTop();s&&(this.template[t][i-1]=s.open?x.OPEN:x.CLOSED)}if(this.template[t][i+1]===x.IGNORE){let s=e.getNeighborBottom();s&&(this.template[t][i+1]=s.open?x.OPEN:x.CLOSED)}if(this.template[t-1][i]===x.IGNORE){let s=e.getNeighborLeft();s&&(this.template[t-1][i]=s.open?x.OPEN:x.CLOSED)}if(this.template[t+1][i]===x.IGNORE){let s=e.getNeighborRight();s&&(this.template[t+1][i]=s.open?x.OPEN:x.CLOSED)}if(this.template[t-1][i-1]===x.IGNORE){let s=e.getNeighborTopLeft();s&&(this.template[t-1][i-1]=s.open?x.OPEN:x.CLOSED)}if(this.template[t+1][i-1]===x.IGNORE){let s=e.getNeighborTopRight();s&&(this.template[t+1][i-1]=s.open?x.OPEN:x.CLOSED)}if(this.template[t-1][i-1]===x.IGNORE){let s=e.getNeighborBottomLeft();s&&(this.template[t-1][i-1]=s.open?x.OPEN:x.CLOSED)}if(this.template[t+1][i-1]===x.IGNORE){let s=e.getNeighborBottomRight();s&&(this.template[t+1][i-1]=s.open?x.OPEN:x.CLOSED)}}populateNegligibleTileAndNeighbors(e,t,i,r){this.template[t][i]=r,this.template[t][i-1]===x.IGNORE&&e.getNeighborTop()&&(this.template[t][i-1]=x.OPEN),this.template[t][i+1]===x.IGNORE&&e.getNeighborBottom()&&(this.template[t][i+1]=x.OPEN),this.template[t-1][i]===x.IGNORE&&e.getNeighborLeft()&&(this.template[t-1][i]=x.OPEN),this.template[t+1][i]===x.IGNORE&&e.getNeighborRight()&&(this.template[t+1][i]=x.OPEN),this.template[t-1][i-1]===x.IGNORE&&e.getNeighborTopLeft()&&(this.template[t-1][i-1]=x.OPEN),this.template[t+1][i-1]===x.IGNORE&&e.getNeighborTopRight()&&(this.template[t+1][i-1]=x.OPEN),this.template[t-1][i-1]===x.IGNORE&&e.getNeighborBottomLeft()&&(this.template[t-1][i-1]=x.OPEN),this.template[t+1][i-1]===x.IGNORE&&e.getNeighborBottomRight()&&(this.template[t+1][i-1]=x.OPEN)}};var As=class extends oe{constructor(e,t,i){super(e,t,i),this.landCoordinate=new P}executePlan(e,t,i){let s=this.startTile.origin.x+n.tile.size+n.character.halfWidth;return e.position.worldCoordinateCenter.x<s?(this.walkRightToCenterX(e,t,s),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x<this.endTile.origin.x||e.position.worldCoordinateOrigin.y<this.endTile.origin.y?(this.fallDownAndRight(e,t,this.landCoordinate),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"FallDownRight("+this.pathSteps+")"}};var Ns=class extends oe{constructor(e,t,i){super(e,t,i),this.landCoordinate=new P(0,0)}executePlan(e,t,i){let s=this.startTile.origin.x-n.character.halfWidth;return e.position.worldCoordinateCenter.x>s?(this.walkLeftToCenterX(e,t,s),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x>this.landCoordinate.x||e.position.worldCoordinateOrigin.y<this.endTile.origin.y?(this.fallDownAndLeft(e,t,this.landCoordinate),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"FallDownLeft("+this.pathSteps+")"}};var Ps=class extends z{constructor(){super(["S8","X8",".E"],!0)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol()+1,s=i.getTileRow()+2,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new As(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol()-1,s=i.getTileRow()+2,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Ns(i,a,h)}toString(){return"PatternFallDown2Side1"}};var Fe=class extends oe{constructor(e,t,i){super(e,t,i),this.jumpCoordinate=new P(0,0),this.landCoordinate=new P(0,0)}executePlan(e,t,i){this.jumpCoordinate.copy(this.startTile.origin),this.jumpCoordinate.subtractXY(n.character.halfWidth,0);let r=this.jumpCoordinate.x;return e.position.worldCoordinateCenter.x>r?(this.walkLeftToCenterX(e,t,r),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x>this.landCoordinate.x||e.position.worldCoordinateOrigin.y<this.endTile.origin.y?(this.jumpDownAndLeft(e,t,this.jumpCoordinate,this.landCoordinate),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"JumpDownLeft("+this.pathSteps+")"}};var Be=class extends oe{constructor(e,t,i){super(e,t,i),this.jumpCoordinate=new P(0,0),this.landCoordinate=new P(0,0)}executePlan(e,t,i){this.jumpCoordinate.copy(this.startTile.origin),this.jumpCoordinate.addXY(n.tile.size+n.character.halfWidth,0);let r=this.jumpCoordinate.x;return e.position.worldCoordinateCenter.x<r?(this.walkRightToCenterX(e,t,r),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x<this.landCoordinate.x||e.position.worldCoordinateOrigin.y<this.endTile.origin.y?(this.jumpDownAndRight(e,t,this.jumpCoordinate,this.landCoordinate),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"JumpDownRight("+this.pathSteps+")"}};var ys=class extends z{constructor(){super([".O.","S88","X8E"],!0)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol()+2,s=i.getTileRow()+1,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Be(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol()-2,s=i.getTileRow()+1,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Fe(i,a,h)}toString(){return"PatternJumpDown1Side2"}};var bs=class extends z{constructor(){super([".OO.","S888","X88E"],!0)}getMinRequiredPathSteps(){return 4}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol()+3,s=i.getTileRow()+1,o=this.findTilePathIndex(e,t+4,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Be(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol()-3,s=i.getTileRow()+1,o=this.findTilePathIndex(e,t+4,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Fe(i,a,h)}toString(){return"PatternJumpDown1Side3"}};var Is=class extends z{constructor(){super([".OO..","S8888","X.88E"],!0)}getMinRequiredPathSteps(){return 5}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol()+4,s=i.getTileRow()+1,o=this.findTilePathIndex(e,t+5,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Be(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol()-4,s=i.getTileRow()+1,o=this.findTilePathIndex(e,t+5,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Fe(i,a,h)}toString(){return"PatternJumpDown1Side4"}};var mt=class extends oe{constructor(e,t,i,r){super(e,t,i),this.jumpCoordinate=new P(0,0),this.landCoordinate=new P(0,0),this.jumpHeight=r}executePlan(e,t,i){this.jumpCoordinate.copy(this.startTile.origin),this.jumpCoordinate.subtractXY(n.character.halfWidth,0);let r=this.jumpCoordinate.x;return e.position.worldCoordinateCenter.x>r?(this.walkLeftToCenterX(e,t,r),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x>this.landCoordinate.x||e.position.worldCoordinateOrigin.y<this.endTile.origin.y?(this.jumpLeft(e,t,this.jumpCoordinate,this.landCoordinate,this.jumpHeight),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"JumpLeft("+this.pathSteps+")"}};var pt=class extends oe{constructor(e,t,i,r){super(e,t,i),this.jumpCoordinate=new P(0,0),this.landCoordinate=new P(0,0),this.jumpHeight=r}executePlan(e,t,i){this.jumpCoordinate.copy(this.startTile.origin),this.jumpCoordinate.addXY(n.tile.size+n.character.halfWidth,0);let r=this.jumpCoordinate.x;return e.position.worldCoordinateCenter.x<r?(this.walkRightToCenterX(e,t,r),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x<this.landCoordinate.x||e.position.worldCoordinateOrigin.y<this.endTile.origin.y?(this.jumpRight(e,t,this.jumpCoordinate,this.landCoordinate,this.jumpHeight),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"JumpRight("+this.pathSteps+")"}};var Os=class extends z{constructor(){super([".O.","S8E","X8."],!0)}getMinRequiredPathSteps(){return 2}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol()+2,s=i.getTileRow(),o=this.findTilePathIndex(e,t+2,r,s);if(o<0)return console.log("PathTemplatePatternJumpSide2() getPathPlan() failed to find end tile"),null;let a=e.tiles[o],h=o-t;return new pt(i,a,h,n.tile.halfSize)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol()-2,s=i.getTileRow(),o=this.findTilePathIndex(e,t+2,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new mt(i,a,h,n.tile.halfSize)}toString(){return"PatternJump0Side2"}};var xs=class extends z{constructor(){super([".OO.","S88E","X88."],!0)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol()+3,s=i.getTileRow(),o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new pt(i,a,h,n.tile.threeQuarterSize)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol()-3,s=i.getTileRow(),o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new mt(i,a,h,n.tile.threeQuarterSize)}toString(){return"PatternJump0Side3"}};var Ds=class extends z{constructor(){super([".OOO.","S8.8E","X8.8."],!0)}getMinRequiredPathSteps(){return 4}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol()+4,s=i.getTileRow(),o=this.findTilePathIndex(e,t+4,r,s);if(o<0)return console.log("PatternJump0Side4 getPathPlan failed to find end index"),null;let a=e.tiles[o],h=o-t;return new pt(i,a,h,n.tile.size)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol()-4,s=i.getTileRow(),o=this.findTilePathIndex(e,t+4,r,s);if(o<0)return console.log("PatternJump0Side4 getPathPlanFlipped failed to find end index"),null;let a=e.tiles[o],h=o-t;return new mt(i,a,h,n.tile.size)}toString(){return"PatternJump0Side4"}};var Le=class extends oe{constructor(e,t,i){super(e,t,i),this.jumpCoordinate=new P(0,0),this.landCoordinate=new P(0,0)}executePlan(e,t,i){this.jumpCoordinate.copy(this.startTile.origin),this.jumpCoordinate.addXY(n.tile.halfSize,0);let r=this.jumpCoordinate.x;return e.position.worldCoordinateCenter.x>r?(this.walkLeftToCenterX(e,t,r),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x>this.landCoordinate.x?(this.jumpUpAndLeft(e,t,this.jumpCoordinate,this.landCoordinate),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"JumpUpLeft("+this.pathSteps+")"}};var _e=class extends oe{constructor(e,t,i){super(e,t,i),this.jumpCoordinate=new P(0,0),this.landCoordinate=new P(0,0)}executePlan(e,t,i){this.jumpCoordinate.copy(this.startTile.origin),this.jumpCoordinate.addXY(n.tile.halfSize,0);let r=this.jumpCoordinate.x;return e.position.worldCoordinateCenter.x<r?(this.walkRightToCenterX(e,t,r),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x<this.landCoordinate.x?(this.jumpUpAndRight(e,t,this.jumpCoordinate,this.landCoordinate),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"JumpUpRight("+this.pathSteps+")"}};var vs=class extends z{constructor(){super(["88E","SX."],!0)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol()+2,s=i.getTileRow()-1,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new _e(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol()-2,s=i.getTileRow()-1,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Le(i,a,h)}toString(){return"PatternJumpUp1Side2"}};var Gs=class extends z{constructor(){super(["888E","S8X."],!0)}getMinRequiredPathSteps(){return 4}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol()+3,s=i.getTileRow()-1,o=this.findTilePathIndex(e,t+4,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new _e(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol()-3,s=i.getTileRow()-1,o=this.findTilePathIndex(e,t+4,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Le(i,a,h)}toString(){return"PatternJumpUp1Side3"}};var ge=class extends oe{constructor(e,t,i){super(e,t,i)}executePlan(e,t,i){let r=this.endTile.origin.x+n.tile.halfSize,s=this.walkLeftToCenterX(e,t,r);return s&&this.assertEndTileReached(e,this.endTile),s}toString(){return"WalkLeft("+this.pathSteps+")"}};var fe=class extends oe{constructor(e,t,i){super(e,t,i)}executePlan(e,t,i){let r=this.endTile.origin.x+n.tile.halfSize,s=this.walkRightToCenterX(e,t,r);return s&&this.assertEndTileReached(e,this.endTile),s}toString(){return"WalkRight("+this.pathSteps+")"}};var ks=class extends z{constructor(){super(["SPE","XXX"],!0)}getMinRequiredPathSteps(){return 2}getPathPlan(e,t){let i=e.tiles[t],r=e.tiles[t+2];return new fe(i,r,2)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=e.tiles[t+2];return new ge(i,r,2)}toString(){return"PatternWalkSide2"}};var Fs=class extends z{constructor(){super(["SPPPE","XXXXX"],!0)}getMinRequiredPathSteps(){return 4}getPathPlan(e,t){let i=e.tiles[t],r=e.tiles[t+4];return new fe(i,r,4)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=e.tiles[t+4];return new ge(i,r,4)}toString(){return"PatternWalkSide4"}};var Te=class extends oe{constructor(e,t,i){super(e,t,i)}executePlan(e,t,i){let r=this.fallDown(e,t,this.endTile);return r&&this.assertEndTileReached(e,this.endTile),r}isSolidFloorRequiredAtStart(){return!1}toString(){return"FallDown("+this.pathSteps+")"}};var Ve=class extends oe{constructor(e,t,i){super(e,t,i)}executePlan(e,t,i){let r=this.jumpUp(e,t,this.endTile);return r&&this.assertEndTileReached(e,this.endTile),r}toString(){return"JumpUp("+this.pathSteps+")"}};var Ci=class extends z{constructor(){super(["8E","S."],!0)}getMinRequiredPathSteps(){return 2}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol()+1,s=i.getTileRow()-1,o=this.findTilePathIndex(e,t+2,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new _e(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol()-1,s=i.getTileRow()-1,o=this.findTilePathIndex(e,t+2,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Le(i,a,h)}toString(){return"PatternJumpUp1Side1"}};var Bs=class extends z{constructor(){super([".88E","888X","S8.."],!0)}getMinRequiredPathSteps(){return 5}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol()+3,s=i.getTileRow()-2,o=this.findTilePathIndex(e,t+5,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new _e(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol()-3,s=i.getTileRow()-2,o=this.findTilePathIndex(e,t+5,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Le(i,a,h)}toString(){return"PatternJumpUp2Side3"}};var wi=class extends z{constructor(){super([".8E","88.","S.."],!0)}getMinRequiredPathSteps(){return 4}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol()+2,s=i.getTileRow()-2,o=this.findTilePathIndex(e,t+4,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new _e(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol()-2,s=i.getTileRow()-2,o=this.findTilePathIndex(e,t+4,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Le(i,a,h)}toString(){return"PatternJumpUp2Side2"}};var Vs=class extends z{constructor(){super(["8E","8.","S."],!0)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol()+1,s=i.getTileRow()-2,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new _e(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol()-1,s=i.getTileRow()-2,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Le(i,a,h)}toString(){return"PatternJumpUp2Side1"}};var Us=class extends z{constructor(){super([".OO.","S888","X.88","...E","...X"],!0)}getMinRequiredPathSteps(){return 5}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol()+3,s=i.getTileRow()+2,o=this.findTilePathIndex(e,t+5,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Be(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol()-3,s=i.getTileRow()+2,o=this.findTilePathIndex(e,t+5,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Fe(i,a,h)}toString(){return"PatternJumpDown2Side3"}};var zs=class extends z{constructor(){super(["E","8","S"],!1)}getMinRequiredPathSteps(){return 2}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol(),s=i.getTileRow()-2,o=this.findTilePathIndex(e,t+2,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Ve(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol(),s=i.getTileRow()-2,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Ve(i,a,h)}toString(){return"PatternJumpUp2"}};var Hs=class extends z{constructor(){super(["E","8","8","S"],!1)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol(),s=i.getTileRow()-3,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Ve(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol(),s=i.getTileRow()-3,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Ve(i,a,h)}toString(){return"PatternJumpUp3"}};var Li=class extends z{constructor(){super(["S","8","E"],!1)}getMinRequiredPathSteps(){return 2}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol(),s=i.getTileRow()+2,o=this.findTilePathIndex(e,t+2,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Te(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol(),s=i.getTileRow()+2,o=this.findTilePathIndex(e,t+2,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Te(i,a,h)}toString(){return"PatternFallDown2"}};var _i=class extends z{constructor(){super(["S","8","8","E"],!1)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol(),s=i.getTileRow()+3,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Te(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol(),s=i.getTileRow()+3,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Te(i,a,h)}toString(){return"PatternFallDown3"}};var Ws=class extends ge{constructor(e,t,i,r){super(e,t,i),this.tileMinedLogic=r,this.miningThisTurn=!1}executePlan(e,t,i){if(this.endTile.open){if(this.miningThisTurn)if(i)this.miningThisTurn=!1;else return!1}else return e.setCharacterAction(H.MINE),this.miningThisTurn=!0,e.position.worldCoordinateOrigin.x!==this.endTile.origin.x&&(e.position.facingLeft=e.position.worldCoordinateOrigin.x>this.endTile.origin.x),i&&this.tileMinedLogic.mineTileForTurn(e,this.endTile),!1;return super.executePlan(e,t,i)}toString(){return"MineAndWalkLeft("+this.pathSteps+")"}};var Ys=class extends fe{constructor(e,t,i,r){super(e,t,i),this.tileMinedLogic=r,this.miningThisTurn=!1}executePlan(e,t,i){if(this.endTile.open){if(this.miningThisTurn)if(i)this.miningThisTurn=!1;else return!1}else return e.setCharacterAction(H.MINE),this.miningThisTurn=!0,e.position.worldCoordinateOrigin.x!==this.endTile.origin.x&&(e.position.facingLeft=e.position.worldCoordinateOrigin.x>this.endTile.origin.x),i&&this.tileMinedLogic.mineTileForTurn(e,this.endTile),!1;return super.executePlan(e,t,i)}toString(){return"MineAndWalkRight("+this.pathSteps+")"}};var Ks=class extends Ve{constructor(e,t,i,r){super(e,t,i),this.tileMinedLogic=r,this.miningThisTurn=!1}executePlan(e,t,i){if(this.endTile.open){if(this.miningThisTurn)if(i)this.miningThisTurn=!1;else return!1}else return e.setCharacterAction(H.MINE),this.miningThisTurn=!0,e.position.worldCoordinateOrigin.x!==this.endTile.origin.x&&(e.position.facingLeft=e.position.worldCoordinateOrigin.x>this.endTile.origin.x),i&&this.tileMinedLogic.mineTileForTurn(e,this.endTile),!1;return super.executePlan(e,t,i)}toString(){return"MineAndJumpUp("+this.pathSteps+")"}};var Xs=class extends Te{constructor(e,t,i,r){super(e,t,i),this.tileMinedLogic=r,this.miningThisTurn=!1}executePlan(e,t,i){if(this.endTile.open){if(this.miningThisTurn)if(i)this.miningThisTurn=!1;else return!1}else return e.setCharacterAction(H.MINE),this.miningThisTurn=!0,e.position.worldCoordinateOrigin.x!==this.endTile.origin.x&&(e.position.facingLeft=e.position.worldCoordinateOrigin.x>this.endTile.origin.x),i&&this.tileMinedLogic.mineTileForTurn(e,this.endTile),!1;return super.executePlan(e,t,i)}toString(){return"MineAndFallDown("+this.pathSteps+")"}};var Mi=class extends z{constructor(){super(["S","8","8","8","E"],!1)}getMinRequiredPathSteps(){return 4}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol(),s=i.getTileRow()+4,o=this.findTilePathIndex(e,t+4,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Te(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol(),s=i.getTileRow()+4,o=this.findTilePathIndex(e,t+4,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Te(i,a,h)}toString(){return"PatternFallDown4"}};var Ri=class extends z{constructor(){super(["S","8","8","8","8","E"],!1)}getMinRequiredPathSteps(){return 5}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol(),s=i.getTileRow()+5,o=this.findTilePathIndex(e,t+5,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Te(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol(),s=i.getTileRow()+5,o=this.findTilePathIndex(e,t+5,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Te(i,a,h)}toString(){return"PatternFallDown5"}};var js=class extends z{constructor(){super(["SPPPE"],!0)}getMinRequiredPathSteps(){return 4}getPathPlan(e,t){let i=e.tiles[t],r=e.tiles[t+4];return new fe(i,r,4)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=e.tiles[t+4];return new ge(i,r,4)}toString(){return"PatternWalkSide4Negligible"}};var Zs=class extends z{constructor(){super(["SPPE"],!0)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e.tiles[t],r=e.tiles[t+3];return new fe(i,r,3)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=e.tiles[t+3];return new ge(i,r,3)}toString(){return"PatternWalkSide3Negligible"}};var qs=class extends z{constructor(){super(["SPE"],!0)}getMinRequiredPathSteps(){return 2}getPathPlan(e,t){let i=e.tiles[t],r=e.tiles[t+2];return new fe(i,r,2)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=e.tiles[t+2];return new ge(i,r,2)}toString(){return"PatternWalkSide2Negligible"}};var Js=class extends z{constructor(){super(["SPPPPE"],!0)}getMinRequiredPathSteps(){return 5}getPathPlan(e,t){let i=e.tiles[t],r=e.tiles[t+5];return new fe(i,r,5)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=e.tiles[t+5];return new ge(i,r,5)}toString(){return"PatternWalkSide5Negligible"}};var Qs=class extends z{constructor(){super(["S..","..E"],!0)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol()+2,s=i.getTileRow()+1,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Be(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol()-2,s=i.getTileRow()+1,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Fe(i,a,h)}toString(){return"PatternJumpDown1Side2Negligible"}};var $s=class extends z{constructor(){super(["..E","S.."],!0)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e.tiles[t],r=i.getTileCol()+2,s=i.getTileRow()-1,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new _e(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],r=i.getTileCol()-2,s=i.getTileRow()-1,o=this.findTilePathIndex(e,t+3,r,s);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Le(i,a,h)}toString(){return"PatternJumpUp1Side2Negligible"}};var eo=class{constructor(e){this.tileMinedLogic=e,this.pathTemplate=new Rs,this.patterns=[new Ri,new Mi,new Ds,new Is,new Bs,new Us,new xs,new Gs,new bs,new wi,new Hs,new _i,new Os,new Vs,new vs,new ys,new Ci,new zs,new Li,new Ps,new Fs,new ks],this.patternsTileHealthNegligible=[new Ri,new Mi,new _i,new Li,new Js,new js,new Zs,new qs,new Qs,new wi,new $s,new Ci],this.claimedPath=new Array(30),this.claimedPath.fill(null)}connectPathToPlan2(e,t,i,r){e.size!==0&&(this.evaluatePathInternal(e,r),t.length=i,this.buildPathPlanFromClaimedPath(e,t,this.claimedPath))}evaluatePath(e,t,i){if(e.size===0){t.length=0;return}this.evaluatePathInternal(e,i),t.length=0,this.buildPathPlanFromClaimedPath(e,t,this.claimedPath)}buildPathPlanFromClaimedPath(e,t,i){let r=null;for(let s=0;s<e.size;s++){let o=i[s];o&&o!==r&&t.push(o),r=o}}evaluatePathInternal(e,t){if(e.size>this.claimedPath.length&&(this.claimedPath.length=e.size),this.claimedPath.fill(null),e.size<3)for(let i=0;i<e.size-1;i++)this.addDefaultPlan(e,i,this.claimedPath,t);else{if(this.pathTemplate.updateTemplate(e,t),!t)for(let i=0;i<e.size-1;i++)this.addMinePlan(e,i,this.claimedPath);if(t)for(let i=0;i<this.patternsTileHealthNegligible.length;i++)this.checkPatternAgainstPath(this.patternsTileHealthNegligible[i],e,this.claimedPath);else for(let i=0;i<this.patterns.length;i++)this.checkPatternAgainstPath(this.patterns[i],e,this.claimedPath);for(let i=0;i<e.size-1;i++)this.claimedPath[i]||this.addDefaultPlan(e,i,this.claimedPath,t)}}checkPatternAgainstPath(e,t,i){let r=0;for(;r<t.size;){if(i[r]){r++;continue}let s=this.getUnclaimedSpaceAvailable(i,t.size,r);if(s<e.getMinRequiredPathSteps()){r++;continue}let o=this.pathTemplate.getPlanIfPatternMatch(e,t,r);if(o){let a=o.pathSteps;if(a===0){console.log("PathPlanEvaluator.checkPatternAgainstPath() pattern="+e.toString()+" used no steps"),r++;continue}if(a<=s){for(let h=0;h<a;h++)i[r]=o,r++;continue}}r++}}getUnclaimedSpaceAvailable(e,t,i){let r=0;for(let s=i;s<t;s++){if(e[s]!==null)return r;r++}return r}addDefaultPlan(e,t,i,r){let s=e.tiles[t],o=e.tiles[t+1];if(!o.open&&!r){this.addMinePlan(e,t,i);return}let a;if(s.isNeighborLeft(o))a=new ge(s,o,1);else if(s.isNeighborRight(o))a=new fe(s,o,1);else if(s.isNeighborTop(o))a=new Ve(s,o,1);else if(s.isNeighborBottom(o))a=new Te(s,o,1);else{console.log("addDefaultPlan() neighbor is not adjacent tile"),this.printPathDebug(e,t);return}i[t]=a}printPathDebug(e,t){console.log("DEBUG BAD INDEX: "+t);for(let i=0;i<e.size;i++)i==0?console.log("DEBUG step="+i+" "+e.tiles[i].origin.toString()):console.log("DEBUG step="+i+" "+e.tiles[i].origin.toString()+" adjacent="+e.tiles[i].isAdjacentTo(e[i-1])+" neighbor="+e.tiles[i].isNeighborTile(e.tiles[i-1])+(i===t?" <-----":""))}pathPlanToString(e){let t="";for(let i=0;i<e.length;i++)t+="i="+i+":"+e[i].toString()+", ";return t}addMinePlan(e,t,i){let r=e.tiles[t+1];if(r.open)return;let s=e.tiles[t],o;if(s.isNeighborLeft(r))o=new Ws(s,r,1,this.tileMinedLogic);else if(s.isNeighborRight(r))o=new Ys(s,r,1,this.tileMinedLogic);else if(s.isNeighborTop(r))o=new Ks(s,r,1,this.tileMinedLogic);else if(s.isNeighborBottom(r))o=new Xs(s,r,1,this.tileMinedLogic);else{console.log("addMinePlan() neighbor is not adjacent tile");return}i[t]=o}};var to=class extends F{constructor(e,t,i){super(),this.targetList=t,this.pathFinder=new Ms,this.directLinePathFinder=new Ls(e),this.pathPlanEvaluator=new eo(i),this.path=new ws}findPathPlan(e,t,i,r,s){this.path.reset(),K.startTime("PathFinding"),this.pathFinder.findPath(this.path,e,t,!0,r,s),K.endTime("PathFinding"),this.path.size>0?this.pathPlanEvaluator.evaluatePath(this.path,i,!1):i.length=0}findDirectPathPlan(e,t,i){this.path.reset(),K.startTime("DirectPath");let r=this.directLinePathFinder.findPath(this.path,e,t);return K.endTime("DirectPath"),r?(this.path.size>0?this.pathPlanEvaluator.evaluatePath(this.path,i,!0):i.length=0,!0):!1}findContinuedDirectPathPlan2(e,t,i){if(i.length<1)return this.findDirectPathPlan(e,t,i);let r=i[0];if(r.endTile===t)return i.length=1,!0;this.path.reset(),K.startTime("DirectPath");let s=this.directLinePathFinder.findPath(this.path,r.endTile,t);if(K.endTime("DirectPath"),!s)return this.findDirectPathPlan(e,t,i);if(this.path.size===1){console.log("PathPlanFinder.findContinuedDirectPathPlan() resulting path length 1"),i.length=0;return}return this.path.size>0?(this.pathPlanEvaluator.connectPathToPlan2(this.path,i,1,!0),!0):(console.log("PathPlanFinder.findContinuedDirectPathPlan() did not find a good path."),i.length=0,!1)}findContinuedPathPlan2(e,t,i,r,s){if(i.length<1){this.findPathPlan(e,t,i,r,s);return}let o=i[0];if(o.endTile===t)return i.length=1,!0;if(this.path.reset(),K.startTime("PathFinding"),this.pathFinder.findPath(this.path,o.endTile,t,!0,r,s),K.endTime("PathFinding"),this.path.size===1){console.log("NORMAL PATH SIZE 1.  dest="+t.origin.toString()+" path[0]="+this.path.tiles[0].origin.toString()),i.length=0;return}this.path.size>0?this.pathPlanEvaluator.connectPathToPlan2(this.path,i,1,s):console.log("PathPlanFinder.findContinuedPathPlan2() did not find a good path.")}findClosestPathStepIndex(e,t){let i=null,r=1e6,s=-1,o=t.origin;for(let a=0;a<e.length;a++){let h=e[a];if(!h)continue;let u=h.endTile;if(u===t)return a;let m=o.distanceSquared(u.origin);(!i||r>m)&&(i=u,r=m,s=a)}return s}findMonsterPathPlan(e,t,i){this.findPathPlan(e,t,i,!0,!1)}findPartyCharacterPathPlan(e,t,i,r){if(e===t){console.log("findPartyCharacterPathPlan() start == destination."),i.length=0;return}if(this.targetList.tileHealthNegligible){if(r||i.length===0){if(this.findDirectPathPlan(e,t,i))return}else if(this.findContinuedDirectPathPlan2(e,t,i))return}r||i.length===0?this.findPathPlan(e,t,i,!0,this.targetList.tileHealthNegligible):this.findContinuedPathPlan2(e,t,i,!0,this.targetList.tileHealthNegligible)}resetFull(){this.path.reset()}resetForPrestige(){this.resetFull()}};var ei=class extends zt{constructor(){super()}performAction(e,t,i){let r=e.position;r.pathPlan.length>0&&e.followPathPlan(t,i),r.pathPlan.length===0&&(e.position.resetPathPlan(),e.turnAction=null)}isMovementAction(){return!0}toString(){return"MoveTurnAction"}};var io=class extends Gr{constructor(e,t,i){super(e),this.pathPlanFinder=t,this.moveTurnAction=i}applyIfAppropriate(e){let t=e.position;if(t.pathPlan.length===0&&(Date.now()-e.pathCompletedTime<3e3||Math.random()<.75))return!1;let i=t.tile;if(!i)return!1;let r=e.target;if(t.pathPlan.length===0){let s=this.chooseRandomNeighborTile(i);if(!s)return!1;r.setTargetTile(s,null,this.behaviorId),this.pathPlanFinder.findMonsterPathPlan(e.position.tile,s,e.position.pathPlan)}if(r.behaviorId===this.behaviorId)return e.turnAction=this.moveTurnAction,!0}chooseRandomNeighborTile(e){let t=null,i=Math.random();if(i<.15){if(t=e.getNeighborLeft(),this.isGoodTargetTile(t)||(t=e.getNeighborRight(),this.isGoodTargetTile(t)))return t}else if(i<.3){if(t=e.getNeighborRight(),this.isGoodTargetTile(t)||(t=e.getNeighborLeft(),this.isGoodTargetTile(t)))return t}else if(i<.45){if(t=e.getNeighborTopLeft(),this.isGoodTargetTile(t)||(t=e.getNeighborTopRight(),this.isGoodTargetTile(t)))return t}else if(i<.6){if(t=e.getNeighborTopRight(),this.isGoodTargetTile(t)||(t=e.getNeighborTopLeft(),this.isGoodTargetTile(t)))return t}else if(i<.75){if(t=e.getNeighborBottomLeft(),this.isGoodTargetTile(t)||(t=e.getNeighborBottomRight(),this.isGoodTargetTile(t)))return t}else if(i<.9&&(t=e.getNeighborBottomRight(),this.isGoodTargetTile(t)||(t=e.getNeighborBottomLeft(),this.isGoodTargetTile(t))))return t;return null}isGoodTargetTile(e){if(!e||!e.isTraversable())return!1;let t=e.getNeighborBottom();return!(!t||t.isTraversable())}};var ro=class{constructor(e){this.moveTurnAction=new ei,this.monsterWanderBehavior=new io(1,e,this.moveTurnAction),this.brainById={},this.basicMonsterBrain=new kr(ee.BASIC,[this.monsterWanderBehavior]),this.brainById[this.basicMonsterBrain.id]=this.basicMonsterBrain}getBrainById(e){return this.brainById[e]}};var so=class extends F{constructor(e,t){super(),this.monsterSpritesheet=e,this.characterBrains=t,this.monsterCharacterCache=new Br,this.baseMonsterDamage=5,this.monsterDamageIncrease=.6,this.monsterDamageHundredFactor=.1,this.baseMonsterHealth=5,this.monsterHealthIncrease=.6,this.monsterHealthHundredFactor=.1}createMonsterAtTile(e,t){let i=this.createMonsterCharacter(e),r=t.origin;return i.position.setTileAndOriginPosition(t,r.x,r.y),i}createMonsterCharacter(e){let t=this.monsterSpritesheet.getSprite(e.spriteName);if(t==null)return console.log("CharacterCreator.createMonsterCharacter() Failed to find monster sprite: "+e.spriteName),null;let i=this.characterBrains.getBrainById(e.brainId);if(!i)return console.log("CharacterCreator.createMonsterCharacter() Failed to find monster brain id: "+e.brainId),null;let r=this.monsterCharacterCache.get();return r.set(i,t,e),r}resetFull(){this.monsterCharacterCache.resetCache()}resetForPrestige(){this.resetFull()}};var ql={ANT:new $("1",p.PEST_ANT_10,ee.BASIC),SPIDER1:new $("2",p.PEST_SPIDER_20,ee.BASIC),SPIDER2:new $("3",p.PEST_SPIDER_21,ee.BASIC),SPIDER3:new $("4",p.PEST_SPIDER_22,ee.BASIC),WORM1:new $("5",p.PEST_WORM_30,ee.BASIC),WORM2:new $("6",p.PEST_WORM_31,ee.BASIC),WORM4:new $("7",p.PEST_WORM_33,ee.BASIC),WORM5:new $("8",p.PEST_WORM_34,ee.BASIC),BALL:new $("9",p.PEST_BALL,ee.BASIC),SLUG1:new $("10",p.PEST_SLUG_70,ee.BASIC),SLUG2:new $("11",p.PEST_SLUG_71,ee.BASIC),SNAIL1:new $("12",p.PEST_SNAIL_72,ee.BASIC),SNAIL2:new $("13",p.PEST_SNAIL_73,ee.BASIC),SLIME01:new $("14",p.SLIME_BLUE_00,ee.BASIC),SLIME02:new $("15",p.SLIME_BROWN_01,ee.BASIC),SLIME03:new $("16",p.SLIME_WHITE_02,ee.BASIC),SLIME04:new $("17",p.SLIME_GREEN_03,ee.BASIC),SLIME05:new $("18",p.SLIME_PINK_04,ee.BASIC),SLIME06:new $("19",p.SLIME_MUCUS_GREEN_40,ee.BASIC),SLIME07:new $("20",p.SLIME_MUCUS_BLUE_41,ee.BASIC),SLIME08:new $("21",p.SLIME_CORRODED_20,ee.BASIC),SLIME09:new $("22",p.SLIME_SEEING_21,ee.BASIC),SLIME10:new $("23",p.SLIME_ORANGE_22,ee.BASIC),SLIME11:new $("24",p.SLIME_MINI_BLUE_30,ee.BASIC),SLIME12:new $("25",p.SLIME_MINI_31,ee.BASIC),SLIME13:new $("26",p.SLIME_MINI_ORANGE_32,ee.BASIC)};function vh(){let l={};for(let e of Object.values(ql))l[e.id]=e;return l}function Gh(){let l=[];for(let e of Object.values(ql))l.push(e);return l}var Jl=vh(),ll=Gh();function Ql(){let l=[];return l.push(ll[de.randomInt(ll.length)]),l.push(ll[de.randomInt(ll.length)]),l}var ce={SKY_LAYER:new Rt(X.SKY,-1),GRASS_LAYER:new Rt(X.GRASS,-1),DIRT_LAYER:new Rt(X.DIRT,1)};function kh(){let l=[];l.push(ce.SKY_LAYER),l.push(ce.GRASS_LAYER),l.push(ce.DIRT_LAYER);let e=2;for(let w=0;w<Ge.length;w++)l.push(new Rt(Ge[w],e++));ce.SKY_LAYER.minDepth=-1e6,ce.SKY_LAYER.maxDepth=-1,ce.SKY_LAYER.baseHealth=new c(20),ce.GRASS_LAYER.minDepth=-1,ce.GRASS_LAYER.maxDepth=0,ce.GRASS_LAYER.baseHealth=new c(20),ce.GRASS_LAYER.baseOre=new c(1),ce.GRASS_LAYER.silver=new c(1),ce.SKY_LAYER.initializeLayerValues(1,.05,new c(1),new c(0),new c(0));let t=1,i=.1,r=new c(.8),s=new c(12),o=new c(0),a=new c(10),h=new c(5),u=.1,m=.1,g=ce.GRASS_LAYER,_=500,C=2;for(let w=C;w<l.length;w++){let T=l[w];T.monsterDescriptions=Ql(),o.setValue(T.nominalIndex),T.initializeLayerValues(t,i,r,s,o),console.log("LAYER="+T.name+" nominalIndex="+T.nominalIndex+" points="+L.formatBigNum(o)),w<l.length-1?T.initializeLayer(g,_,w==C):T.initializeLayer(g,-1,!1),g=T,r.mul(h),s.mul(a),i+=u,u+=m}return l}var Me=kh();function Fh(){let l={};for(let e=0;e<Me.length;e++){let t=Me[e];l[t.id]=t}return l}var $l=Fh();function eh(l){for(let e=0;e<Me.length;e++){let t=Me[e];if(t.minDepth<=l&&l<t.maxDepth)return t}return Me[Me.length-1]}function th(l,e){let t=l;for(;t&&t.prevLayer&&t.baseHealth.greaterThan(e);)t=t.prevLayer;for(;t&&t.nextLayer&&t.maxHealth.lessThan(e);)t=t.nextLayer;return t||(console.log("LayerDescriptions.findLayerForHealth() null layer. using default"),l)}var ti=class{constructor(e){this.N=624,this.M=397,this.MATRIX_A=2567483615,this.UPPER_MASK=2147483648,this.LOWER_MASK=2147483647,this.randFactor=1/4294967296,this.mag01=[0,this.MATRIX_A],this.mt=new Array(this.N),this.mti=this.N+1,this.setSeed(e)}setSeed(e){this.mti=this.N+1,this.initGenRand2(e)}initGenRand2(e){for(this.mt[0]=e&4294967295,this.mti=1;this.mti<this.N;this.mti++)this.mt[this.mti]=1812433253*(this.mt[this.mti-1]^this.mt[this.mti-1]>>30)+this.mti,this.mt[this.mti]&=4294967295}genRandInt(){var e;if(this.mag01[0]=0,this.mag01[1]=this.MATRIX_A,this.mti>=this.N){var t;for(t=0;t<this.N-this.M;t++)e=this.mt[t]&this.UPPER_MASK|this.mt[t+1]&this.LOWER_MASK,this.mt[t]=this.mt[t+this.M]^e>>>1^this.mag01[e&1];for(;t<this.N-1;t++)e=this.mt[t]&this.UPPER_MASK|this.mt[t+1]&this.LOWER_MASK,this.mt[t]=this.mt[t+(this.M-this.N)]^e>>>1^this.mag01[e&1];e=this.mt[this.N-1]&this.UPPER_MASK|this.mt[0]&this.LOWER_MASK,this.mt[this.N-1]=this.mt[this.M-1]^e>>>1^this.mag01[e&1],this.mti=0}return e=this.mt[this.mti++],e^=e>>>11,e^=e<<7&2636928640,e^=e<<15&4022730752,e^=e>>>18,e>>>0}random(){return this.genRandInt()*this.randFactor}randomInt(e){return this.random()*e|0}};var Ce=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],Bh=.5*(Math.sqrt(3)-1),oo=(3-Math.sqrt(3))/6,Vh=1/3,lt=1/6,no=class{constructor(e){this.perm=this.initializePerm(e)}initializePerm(e){let t=new ti(e),i=new Array(256);for(let s=0;s<i.length;s++)i[s]=Math.floor(t.random()*256);let r=new Array(512);for(let s=0;s<r.length;s++)r[s]=i[s&255];return r}noise(e,t){let i=(e+t)*Bh,r=Math.floor(e+i),s=Math.floor(t+i),o=(r+s)*oo,a=r-o,h=s-o,u=e-a,m=t-h,g,_;u>m?(g=1,_=0):(g=0,_=1);let C=u-g+oo,w=m-_+oo,T=u-1+2*oo,S=m-1+2*oo,R=r&255,y=s&255,I=this.perm[R+this.perm[y]]%12,N=this.perm[R+g+this.perm[y+_]]%12,D=this.perm[R+1+this.perm[y+1]]%12,Q,V,ot,De=.5-u*u-m*m;De<0?Q=0:(De*=De,Q=De*De*(Ce[I][0]*u+Ce[I][1]*m));let He=.5-C*C-w*w;He<0?V=0:(He*=He,V=He*He*(Ce[N][0]*C+Ce[N][1]*w));let We=.5-T*T-S*S;return We<0?ot=0:(We*=We,ot=We*We*(Ce[D][0]*T+Ce[D][1]*S)),70*(Q+V+ot)}noise3d(e,t,i){let r=(e+t+i)*Vh,s=Math.floor(e+r),o=Math.floor(t+r),a=Math.floor(i+r),h=(s+o+a)*lt,u=s-h,m=o-h,g=a-h,_=e-u,C=t-m,w=i-g,T,S,R,y,I,N;_>=C?C>=w?(T=1,S=0,R=0,y=1,I=1,N=0):_>=w?(T=1,S=0,R=0,y=1,I=0,N=1):(T=0,S=0,R=1,y=1,I=0,N=1):C<w?(T=0,S=0,R=1,y=0,I=1,N=1):_<w?(T=0,S=1,R=0,y=0,I=1,N=1):(T=0,S=1,R=0,y=1,I=1,N=0);let D=_-T+lt,Q=C-S+lt,V=w-R+lt,ot=_-y+2*lt,De=C-I+2*lt,He=w-N+2*lt,We=_-1+3*lt,ui=C-1+3*lt,ci=w-1+3*lt,_t=s&255,xt=o&255,Dt=a&255,mi=this.perm[_t+this.perm[xt+this.perm[Dt]]]%12,pi=this.perm[_t+T+this.perm[xt+S+this.perm[Dt+R]]]%12,Ee=this.perm[_t+y+this.perm[xt+I+this.perm[Dt+N]]]%12,vt=this.perm[_t+1+this.perm[xt+1+this.perm[Dt+1]]]%12,Cl,wl,Ll,_l,er=.6-_*_-C*C-w*w;er<0?Cl=0:(er*=er,Cl=er*er*(Ce[mi][0]*_+Ce[mi][1]*C+Ce[mi][2]*w));let tr=.6-D*D-Q*Q-V*V;tr<0?wl=0:(tr*=tr,wl=tr*tr*(Ce[pi][0]*D+Ce[pi][1]*Q+Ce[pi][2]*V));let ir=.6-ot*ot-De*De-He*He;ir<0?Ll=0:(ir*=ir,Ll=ir*ir*(Ce[Ee][0]*ot+Ce[Ee][1]*De+Ce[Ee][2]*He));let rr=.6-We*We-ui*ui-ci*ci;return rr<0?_l=0:(rr*=rr,_l=rr*rr*(Ce[vt][0]*We+Ce[vt][1]*ui+Ce[vt][2]*ci)),32*(Cl+wl+Ll+_l)}};var Re=class{constructor(e,t,i,r,s,o){this.simplexNoise=new no(e),this.terrainAmplitude=t,this.terrainLacunarity=i,this.terrainGain=r,this.terrainOctaves=s,this.terrainFrequencyMultiplier=o}calculateNoise(e,t){let i=0,r=this.terrainAmplitude,s=this.terrainFrequencyMultiplier;for(let o=0;o<this.terrainOctaves;o++)i+=r*this.simplexNoise.noise(e*s,t*s),r*=this.terrainGain,s*=this.terrainLacunarity;return i}};var ii=class{getLayerDescription(){}isLayerForGrid(e,t){}isLayerForTile(e,t){}isOreTileSupported(){}isGoldTileSupported(){}isRubyTileSupported(){}isUpgradeTileSupported(){}assignTileToOreType(e){}assignTileToGoldType(e){}assignTileToSilverType(e){}assignTileToUpgradeType(e){}assignTileToRubyType(e){}assignTileTerrain(e,t){}};var Uh=60,gt=class extends ii{constructor(e,t,i,r){super(),this.layerDescription=e,this.maxTileDepth=e.maxDepth,this.minTileDepth=e.minDepth,this.adjustedMinTileDepth=this.minTileDepth-Uh,this.fbm=t,this.goldGenerated=i,this.rubyGenerated=r}getLayerDescription(){return this.layerDescription}isInAdjustedRange(e){return e>=this.adjustedMinTileDepth&&e<this.maxTileDepth}isLayerForGrid(e,t){return!(t<this.adjustedMinTileDepth||e>this.maxTileDepth)}isLayerForTile(e,t){if(!this.isInAdjustedRange(t))return!1;let i=e.origin,r=n.tile.size*this.fbm.calculateNoise(i.y,i.x),s=this.minTileDepth+r;return t>=s}isOreTileSupported(){return this.layerDescription.oreTileType!==null}isGoldTileSupported(){return this.goldGenerated&&this.layerDescription.goldTileType!==null}isRubyTileSupported(){return this.rubyGenerated&&this.layerDescription.rubyTileType!==null}isUpgradeTileSupported(){return this.layerDescription.upgradeTileType!==null}assignTileToOreType(e){e.tileInit(!1,this.layerDescription.oreTileType)}assignTileToGoldType(e){e.tileInit(!1,this.layerDescription.goldTileType)}assignTileToSilverType(e){e.tileInit(!1,this.layerDescription.silverTileType)}assignTileToUpgradeType(e){e.tileInit(!1,this.layerDescription.upgradeTileType)}assignTileToRubyType(e){e.tileInit(!1,this.layerDescription.rubyTileType)}assignTileTerrain(e,t){e.tileInit(t,this.layerDescription.primaryTileType)}};var ao=class extends ii{constructor(e,t){super(),this.tileType=e,this.layerDescription=t,this.maxSkyTileDepth=20}getLayerDescription(){return this.layerDescription}isLayerForGrid(e,t){return e<this.maxSkyTileDepth}isLayerForTile(e,t){return t<this.maxSkyTileDepth}isOreTileSupported(){return!1}isGoldTileSupported(){return!1}isRubyTileSupported(){return!1}isUpgradeTileSupported(){return!1}assignTileToOreType(e){e.tileInit(!0,this.tileType)}assignTileToGoldType(e){e.tileInit(!0,this.tileType)}assignTileToSilverType(e){e.tileInit(!0,this.tileType)}assignTileToUpgradeType(e){e.tileInit(!0,this.tileType)}assignTileToRubyType(e){e.tileInit(!0,this.tileType)}assignTileTerrain(e,t){e.tileInit(!0,this.tileType)}};var lo=class extends gt{constructor(e,t){super(e,t)}isLayerForTile(e,t){if(!this.isInAdjustedRange(t))return!1;let i=e.origin,r=n.tile.size*this.fbm.calculateNoise(i.x,i.x),s=this.minTileDepth+r-5;return t>=s}};var ho=class extends gt{constructor(e,t){super(e,t)}isLayerForTile(e,t){if(!this.isInAdjustedRange(t))return!1;let i=e.origin,r=n.tile.size*this.fbm.calculateNoise(i.x,i.x),s=this.minTileDepth+r-5;return t>=s}};var uo=class{constructor(e){this.shiftValue=2.2734306378540854,this.indexFbm=new Re(e,1,2.1,.7,5,5e-4),this.indexLookup={},this.indexLookup["0.00"]=0,this.indexLookup["0.01"]=0,this.indexLookup["0.02"]=0,this.indexLookup["0.03"]=0,this.indexLookup["0.04"]=0,this.indexLookup["0.05"]=0,this.indexLookup["0.06"]=0,this.indexLookup["0.07"]=0,this.indexLookup["0.08"]=0,this.indexLookup["0.09"]=0,this.indexLookup["0.10"]=0,this.indexLookup["0.11"]=0,this.indexLookup["0.12"]=0,this.indexLookup["0.13"]=0,this.indexLookup["0.14"]=0,this.indexLookup["0.15"]=0,this.indexLookup["0.16"]=0,this.indexLookup["0.17"]=0,this.indexLookup["0.18"]=0,this.indexLookup["0.19"]=0,this.indexLookup["0.20"]=0,this.indexLookup["0.21"]=0,this.indexLookup["0.22"]=0,this.indexLookup["0.23"]=0,this.indexLookup["0.24"]=0,this.indexLookup["0.25"]=0,this.indexLookup["0.26"]=0,this.indexLookup["0.27"]=0,this.indexLookup["0.28"]=0,this.indexLookup["0.29"]=0,this.indexLookup["0.30"]=0,this.indexLookup["0.31"]=0,this.indexLookup["0.32"]=0,this.indexLookup["0.33"]=0,this.indexLookup["0.34"]=0,this.indexLookup["0.35"]=0,this.indexLookup["0.36"]=0,this.indexLookup["0.37"]=0,this.indexLookup["0.38"]=0,this.indexLookup["0.39"]=0,this.indexLookup["0.40"]=0,this.indexLookup["0.41"]=0,this.indexLookup["0.42"]=0,this.indexLookup["0.43"]=0,this.indexLookup["0.44"]=0,this.indexLookup["0.45"]=0,this.indexLookup["0.46"]=0,this.indexLookup["0.47"]=0,this.indexLookup["0.48"]=0,this.indexLookup["0.49"]=0,this.indexLookup["0.50"]=0,this.indexLookup["0.51"]=0,this.indexLookup["0.52"]=0,this.indexLookup["0.53"]=0,this.indexLookup["0.54"]=0,this.indexLookup["0.55"]=0,this.indexLookup["0.56"]=0,this.indexLookup["0.57"]=0,this.indexLookup["0.58"]=0,this.indexLookup["0.59"]=0,this.indexLookup["0.60"]=0,this.indexLookup["0.61"]=0,this.indexLookup["0.62"]=0,this.indexLookup["0.63"]=0,this.indexLookup["0.64"]=0,this.indexLookup["0.65"]=0,this.indexLookup["0.66"]=0,this.indexLookup["0.67"]=0,this.indexLookup["0.68"]=0,this.indexLookup["0.69"]=0,this.indexLookup["0.70"]=0,this.indexLookup["0.71"]=0,this.indexLookup["0.72"]=0,this.indexLookup["0.73"]=0,this.indexLookup["0.74"]=0,this.indexLookup["0.75"]=0,this.indexLookup["0.76"]=0,this.indexLookup["0.77"]=0,this.indexLookup["0.78"]=0,this.indexLookup["0.79"]=0,this.indexLookup["0.80"]=0,this.indexLookup["0.81"]=0,this.indexLookup["0.82"]=0,this.indexLookup["0.83"]=0,this.indexLookup["0.84"]=0,this.indexLookup["0.85"]=0,this.indexLookup["0.86"]=0,this.indexLookup["0.87"]=0,this.indexLookup["0.88"]=0,this.indexLookup["0.89"]=0,this.indexLookup["0.90"]=0,this.indexLookup["0.91"]=0,this.indexLookup["0.92"]=.01,this.indexLookup["0.93"]=.01,this.indexLookup["0.94"]=.01,this.indexLookup["0.95"]=.01,this.indexLookup["0.96"]=.01,this.indexLookup["0.97"]=.01,this.indexLookup["0.98"]=.01,this.indexLookup["0.99"]=.01,this.indexLookup["1.00"]=.01,this.indexLookup["1.01"]=.01,this.indexLookup["1.02"]=.01,this.indexLookup["1.03"]=.01,this.indexLookup["1.04"]=.01,this.indexLookup["1.05"]=.01,this.indexLookup["1.06"]=.02,this.indexLookup["1.07"]=.02,this.indexLookup["1.08"]=.02,this.indexLookup["1.09"]=.02,this.indexLookup["1.10"]=.02,this.indexLookup["1.11"]=.02,this.indexLookup["1.12"]=.02,this.indexLookup["1.13"]=.02,this.indexLookup["1.14"]=.02,this.indexLookup["1.15"]=.03,this.indexLookup["1.16"]=.03,this.indexLookup["1.17"]=.03,this.indexLookup["1.18"]=.03,this.indexLookup["1.19"]=.03,this.indexLookup["1.20"]=.03,this.indexLookup["1.21"]=.04,this.indexLookup["1.22"]=.04,this.indexLookup["1.23"]=.04,this.indexLookup["1.24"]=.04,this.indexLookup["1.25"]=.04,this.indexLookup["1.26"]=.04,this.indexLookup["1.27"]=.05,this.indexLookup["1.28"]=.05,this.indexLookup["1.29"]=.05,this.indexLookup["1.30"]=.05,this.indexLookup["1.31"]=.05,this.indexLookup["1.32"]=.06,this.indexLookup["1.33"]=.06,this.indexLookup["1.34"]=.06,this.indexLookup["1.35"]=.06,this.indexLookup["1.36"]=.07,this.indexLookup["1.37"]=.07,this.indexLookup["1.38"]=.07,this.indexLookup["1.39"]=.07,this.indexLookup["1.40"]=.08,this.indexLookup["1.41"]=.08,this.indexLookup["1.42"]=.08,this.indexLookup["1.43"]=.08,this.indexLookup["1.44"]=.09,this.indexLookup["1.45"]=.09,this.indexLookup["1.46"]=.09,this.indexLookup["1.47"]=.1,this.indexLookup["1.48"]=.1,this.indexLookup["1.49"]=.1,this.indexLookup["1.50"]=.11,this.indexLookup["1.51"]=.11,this.indexLookup["1.52"]=.11,this.indexLookup["1.53"]=.12,this.indexLookup["1.54"]=.12,this.indexLookup["1.55"]=.12,this.indexLookup["1.56"]=.13,this.indexLookup["1.57"]=.13,this.indexLookup["1.58"]=.13,this.indexLookup["1.59"]=.14,this.indexLookup["1.60"]=.14,this.indexLookup["1.61"]=.15,this.indexLookup["1.62"]=.15,this.indexLookup["1.63"]=.15,this.indexLookup["1.64"]=.16,this.indexLookup["1.65"]=.16,this.indexLookup["1.66"]=.17,this.indexLookup["1.67"]=.17,this.indexLookup["1.68"]=.17,this.indexLookup["1.69"]=.18,this.indexLookup["1.70"]=.18,this.indexLookup["1.71"]=.19,this.indexLookup["1.72"]=.19,this.indexLookup["1.73"]=.2,this.indexLookup["1.74"]=.2,this.indexLookup["1.75"]=.21,this.indexLookup["1.76"]=.21,this.indexLookup["1.77"]=.21,this.indexLookup["1.78"]=.22,this.indexLookup["1.79"]=.22,this.indexLookup["1.80"]=.23,this.indexLookup["1.81"]=.23,this.indexLookup["1.82"]=.24,this.indexLookup["1.83"]=.24,this.indexLookup["1.84"]=.25,this.indexLookup["1.85"]=.25,this.indexLookup["1.86"]=.26,this.indexLookup["1.87"]=.26,this.indexLookup["1.88"]=.27,this.indexLookup["1.89"]=.27,this.indexLookup["1.90"]=.28,this.indexLookup["1.91"]=.29,this.indexLookup["1.92"]=.29,this.indexLookup["1.93"]=.3,this.indexLookup["1.94"]=.3,this.indexLookup["1.95"]=.31,this.indexLookup["1.96"]=.31,this.indexLookup["1.97"]=.32,this.indexLookup["1.98"]=.32,this.indexLookup["1.99"]=.33,this.indexLookup["2.00"]=.34,this.indexLookup["2.01"]=.34,this.indexLookup["2.02"]=.35,this.indexLookup["2.03"]=.35,this.indexLookup["2.04"]=.36,this.indexLookup["2.05"]=.36,this.indexLookup["2.06"]=.37,this.indexLookup["2.07"]=.38,this.indexLookup["2.08"]=.38,this.indexLookup["2.09"]=.39,this.indexLookup["2.10"]=.39,this.indexLookup["2.11"]=.4,this.indexLookup["2.12"]=.41,this.indexLookup["2.13"]=.41,this.indexLookup["2.14"]=.42,this.indexLookup["2.15"]=.42,this.indexLookup["2.16"]=.43,this.indexLookup["2.17"]=.44,this.indexLookup["2.18"]=.44,this.indexLookup["2.19"]=.45,this.indexLookup["2.20"]=.46,this.indexLookup["2.21"]=.46,this.indexLookup["2.22"]=.47,this.indexLookup["2.23"]=.47,this.indexLookup["2.24"]=.48,this.indexLookup["2.25"]=.49,this.indexLookup["2.26"]=.49,this.indexLookup["2.27"]=.5,this.indexLookup["2.28"]=.5,this.indexLookup["2.29"]=.51,this.indexLookup["2.30"]=.52,this.indexLookup["2.31"]=.52,this.indexLookup["2.32"]=.53,this.indexLookup["2.33"]=.53,this.indexLookup["2.34"]=.54,this.indexLookup["2.35"]=.55,this.indexLookup["2.36"]=.55,this.indexLookup["2.37"]=.56,this.indexLookup["2.38"]=.57,this.indexLookup["2.39"]=.57,this.indexLookup["2.40"]=.58,this.indexLookup["2.41"]=.58,this.indexLookup["2.42"]=.59,this.indexLookup["2.43"]=.6,this.indexLookup["2.44"]=.6,this.indexLookup["2.45"]=.61,this.indexLookup["2.46"]=.61,this.indexLookup["2.47"]=.62,this.indexLookup["2.48"]=.63,this.indexLookup["2.49"]=.63,this.indexLookup["2.50"]=.64,this.indexLookup["2.51"]=.64,this.indexLookup["2.52"]=.65,this.indexLookup["2.53"]=.65,this.indexLookup["2.54"]=.66,this.indexLookup["2.55"]=.67,this.indexLookup["2.56"]=.67,this.indexLookup["2.57"]=.68,this.indexLookup["2.58"]=.68,this.indexLookup["2.59"]=.69,this.indexLookup["2.60"]=.69,this.indexLookup["2.61"]=.7,this.indexLookup["2.62"]=.71,this.indexLookup["2.63"]=.71,this.indexLookup["2.64"]=.72,this.indexLookup["2.65"]=.72,this.indexLookup["2.66"]=.73,this.indexLookup["2.67"]=.73,this.indexLookup["2.68"]=.74,this.indexLookup["2.69"]=.74,this.indexLookup["2.70"]=.75,this.indexLookup["2.71"]=.75,this.indexLookup["2.72"]=.76,this.indexLookup["2.73"]=.76,this.indexLookup["2.74"]=.77,this.indexLookup["2.75"]=.77,this.indexLookup["2.76"]=.78,this.indexLookup["2.77"]=.78,this.indexLookup["2.78"]=.79,this.indexLookup["2.79"]=.79,this.indexLookup["2.80"]=.8,this.indexLookup["2.81"]=.8,this.indexLookup["2.82"]=.8,this.indexLookup["2.83"]=.81,this.indexLookup["2.84"]=.81,this.indexLookup["2.85"]=.82,this.indexLookup["2.86"]=.82,this.indexLookup["2.87"]=.83,this.indexLookup["2.88"]=.83,this.indexLookup["2.89"]=.83,this.indexLookup["2.90"]=.84,this.indexLookup["2.91"]=.84,this.indexLookup["2.92"]=.85,this.indexLookup["2.93"]=.85,this.indexLookup["2.94"]=.85,this.indexLookup["2.95"]=.86,this.indexLookup["2.96"]=.86,this.indexLookup["2.97"]=.86,this.indexLookup["2.98"]=.87,this.indexLookup["2.99"]=.87,this.indexLookup["3.00"]=.87,this.indexLookup["3.01"]=.88,this.indexLookup["3.02"]=.88,this.indexLookup["3.03"]=.88,this.indexLookup["3.04"]=.89,this.indexLookup["3.05"]=.89,this.indexLookup["3.06"]=.89,this.indexLookup["3.07"]=.9,this.indexLookup["3.08"]=.9,this.indexLookup["3.09"]=.9,this.indexLookup["3.10"]=.9,this.indexLookup["3.11"]=.91,this.indexLookup["3.12"]=.91,this.indexLookup["3.13"]=.91,this.indexLookup["3.14"]=.92,this.indexLookup["3.15"]=.92,this.indexLookup["3.16"]=.92,this.indexLookup["3.17"]=.92,this.indexLookup["3.18"]=.93,this.indexLookup["3.19"]=.93,this.indexLookup["3.20"]=.93,this.indexLookup["3.21"]=.93,this.indexLookup["3.22"]=.93,this.indexLookup["3.23"]=.94,this.indexLookup["3.24"]=.94,this.indexLookup["3.25"]=.94,this.indexLookup["3.26"]=.94,this.indexLookup["3.27"]=.94,this.indexLookup["3.28"]=.95,this.indexLookup["3.29"]=.95,this.indexLookup["3.30"]=.95,this.indexLookup["3.31"]=.95,this.indexLookup["3.32"]=.95,this.indexLookup["3.33"]=.96,this.indexLookup["3.34"]=.96,this.indexLookup["3.35"]=.96,this.indexLookup["3.36"]=.96,this.indexLookup["3.37"]=.96,this.indexLookup["3.38"]=.96,this.indexLookup["3.39"]=.96,this.indexLookup["3.40"]=.97,this.indexLookup["3.41"]=.97,this.indexLookup["3.42"]=.97,this.indexLookup["3.43"]=.97,this.indexLookup["3.44"]=.97,this.indexLookup["3.45"]=.97,this.indexLookup["3.46"]=.97,this.indexLookup["3.47"]=.97,this.indexLookup["3.48"]=.97,this.indexLookup["3.49"]=.98,this.indexLookup["3.50"]=.98,this.indexLookup["3.51"]=.98,this.indexLookup["3.52"]=.98,this.indexLookup["3.53"]=.98,this.indexLookup["3.54"]=.98,this.indexLookup["3.55"]=.98,this.indexLookup["3.56"]=.98,this.indexLookup["3.57"]=.98,this.indexLookup["3.58"]=.98,this.indexLookup["3.59"]=.98,this.indexLookup["3.60"]=.98,this.indexLookup["3.61"]=.98,this.indexLookup["3.62"]=.99,this.indexLookup["3.63"]=.99,this.indexLookup["3.64"]=.99,this.indexLookup["3.65"]=.99,this.indexLookup["3.66"]=.99,this.indexLookup["3.67"]=.99,this.indexLookup["3.68"]=.99,this.indexLookup["3.69"]=.99,this.indexLookup["3.70"]=.99,this.indexLookup["3.71"]=.99,this.indexLookup["3.72"]=.99,this.indexLookup["3.73"]=.99,this.indexLookup["3.74"]=.99,this.indexLookup["3.75"]=.99,this.indexLookup["3.76"]=.99,this.indexLookup["3.77"]=.99,this.indexLookup["3.78"]=.99,this.indexLookup["3.79"]=.99,this.indexLookup["3.80"]=.99,this.indexLookup["3.81"]=.99,this.indexLookup["3.82"]=.99,this.indexLookup["3.83"]=.99,this.indexLookup["3.84"]=.99,this.indexLookup["3.85"]=.99,this.indexLookup["3.86"]=.99,this.indexLookup["3.87"]=.99,this.indexLookup["3.88"]=.99,this.indexLookup["3.89"]=.99,this.indexLookup["3.90"]=.99,this.indexLookup["3.91"]=.99,this.indexLookup["3.92"]=.99,this.indexLookup["3.93"]=.99,this.indexLookup["3.94"]=.99,this.indexLookup["3.95"]=.99,this.indexLookup["3.96"]=.99,this.indexLookup["3.97"]=.99,this.indexLookup["3.98"]=.99,this.indexLookup["3.99"]=.99,this.indexLookup["4.00"]=.99,this.indexLookup["4.01"]=.99,this.indexLookup["4.02"]=.99,this.indexLookup["4.03"]=.99,this.indexLookup["4.04"]=.99,this.indexLookup["4.05"]=.99,this.indexLookup["4.06"]=.99,this.indexLookup["4.07"]=.99,this.indexLookup["4.08"]=.99,this.indexLookup["4.09"]=.99,this.indexLookup["4.10"]=.99,this.indexLookup["4.11"]=.99,this.indexLookup["4.12"]=.99,this.indexLookup["4.13"]=.99,this.indexLookup["4.14"]=.99,this.indexLookup["4.15"]=.99,this.indexLookup["4.16"]=.99,this.indexLookup["4.17"]=.99,this.indexLookup["4.18"]=.99,this.indexLookup["4.19"]=.99,this.indexLookup["4.20"]=.99,this.indexLookup["4.21"]=.99,this.indexLookup["4.22"]=.99,this.indexLookup["4.23"]=.99,this.indexLookup["4.24"]=.99,this.indexLookup["4.25"]=.99,this.indexLookup["4.26"]=.99,this.indexLookup["4.27"]=.99,this.indexLookup["4.28"]=.99,this.indexLookup["4.29"]=.99,this.indexLookup["4.30"]=.99,this.indexLookup["4.31"]=.99,this.indexLookup["4.32"]=.99,this.indexLookup["4.33"]=.99,this.indexLookup["4.34"]=.99,this.indexLookup["4.35"]=.99,this.indexLookup["4.36"]=.99,this.indexLookup["4.37"]=.99,this.indexLookup["4.38"]=.99,this.indexLookup["4.39"]=.99,this.indexLookup["4.40"]=.99,this.indexLookup["4.41"]=.99}getBucket(e){return e.toFixed(2)}getIndexFromFbm(e,t,i){if(i===1)return 0;let r=this.indexFbm.calculateNoise(e,t)+this.shiftValue;if(r<=0)return 0;let s=this.getBucket(r),o=this.indexLookup[s];return o?i*o|0:0}};var co=class extends Ir{constructor(e,t,i,r,s,o){super(i,r,s,o),this.typeName=e,this.colorName=t}};var ri={};ri.getDescription=(l,e)=>{let t=Bt.getSpriteName(l,e),i=ri[t];return i||(i=new co(l,e,t,!0,!1,!1),ri[t]=i),i};var si=class{constructor(e,t,i){this.fixtureNames=e,this.colorNames=t,this.probabilityDenominator=i}getFixtureDescription(e){if(this.fixtureNames.length===0||this.colorNames.length===0)return null;let t=e.randomInt(this.fixtureNames.length*this.probabilityDenominator);if(t>=this.fixtureNames.length)return null;let i=this.fixtureNames[t],r=this.colorNames.length===1?this.colorNames[0]:this.colorNames[e.randomInt(this.colorNames.length)];return ri.getDescription(i,r)}};var Ai=class{constructor(e,t,i){this.ceilingDecoratorTheme=e,this.midDecoratorTheme=t,this.floorDecoratorTheme=i}decorateCavernTile(e,t){let i=e.grid,r=e.getNeighborTop(),s=e.getNeighborBottom(),o=r&&!r.open&&i===r.grid,a=s&&!s.open&&i===s.grid,h=null;o&&a?this.midDecoratorTheme&&(h=this.midDecoratorTheme.getFixtureDescription(t)):o?this.ceilingDecoratorTheme&&(h=this.ceilingDecoratorTheme.getFixtureDescription(t)):a?this.floorDecoratorTheme&&(h=this.floorDecoratorTheme.getFixtureDescription(t)):this.midDecoratorTheme&&(h=this.midDecoratorTheme.getFixtureDescription(t)),e.fixtureDescription=h}};var mo=class{constructor(){}getRandomLayerDecorator(e){let t=this.randomColorScheme(e),i=this.randomColorScheme(e);return[new Ai(this.randomCeilingTheme(e,t),this.randomMidTheme(e,i),this.randomFloorTheme(e,i)),new Ai(this.randomCeilingTheme(e,i),null,this.randomFloorTheme(e,t))]}randomCeilingTheme(e,t){let i=Nl[e.randomInt(Nl.length)];return new si(i,t,2)}randomMidTheme(e,t){let i=Pl[e.randomInt(Pl.length)];return new si(i,t,8)}randomFloorTheme(e,t){let i=yl[e.randomInt(yl.length)];return new si(i,t,2)}randomColorScheme(e){let t=[];return t.push(this.functionRandomColor(e)),t.push(this.functionRandomColor(e)),t.push(this.functionRandomColor(e)),t}functionRandomColor(e){return Al[e.randomInt(Al.length)]}};var hl=class{constructor(){}generateTerrain(e){}generateTileBackgrounds(e){}};var po=class extends hl{constructor(e,t){super();let i=e;this.cavernFbmA=new Re(i++,.9,2,1.2,5,41e-5),this.cavernValueAMin=-6,this.cavernValueAMax=-1.3,this.cavernFbmB=new Re(i++,1.2,1.25,.9,5,.00261),this.cavernValueBMin=.8,this.cavernValueBMax=4.1,this.oreFbm=new Re(i++,1,1.5,1.4,5,.002),this.goldFbm=new Re(i++,1,1.6,1.3,5,.001),this.silverFbm=new Re(i++,1,1.55,1.35,5,.0015),this.upgradeFbm=new Re(i++,1,1.6,1.4,5,.001),this.rubyFbm=new Re(i++,1,1.6,1.4,5,.001),this.backgroundFbm=new Re(i++,1,2.1,.7,5,5e-4);let r=new Re(i++,.7,3.5,.8,5,1e-5);this.indexGenerator=new uo(e),this.characterCreator=t,this.terrainLayers=[];for(let s=0;s<Me.length;s++){let o=Me[s];if(o===ce.SKY_LAYER)this.terrainLayers.push(new ao(X.SKY,o));else if(o===ce.GRASS_LAYER)this.terrainLayers.push(new lo(o,r));else if(o===ce.DIRT_LAYER)this.terrainLayers.push(new ho(o,r));else{let a=s>10,h=s>20;this.terrainLayers.push(new gt(o,new Re(i++,1,3.5,.9,5,5e-5),a,h))}}this.terrainLayerById={};for(let s=0;s<this.terrainLayers.length;s++){let o=this.terrainLayers[s],a=o.getLayerDescription();if(!a){console.log("LayeredTerrainGenerator No layer description for layer index: "+s);continue}this.terrainLayerById[a.id]=o}this.cavernDecoratorsByLayer={},this.layerDecoratorConfig=new mo,this.rng=new ti(i);for(let s=0;s<Me.length;s++){let o=Me[s];o!==ce.SKY_LAYER&&(o===ce.GRASS_LAYER?this.cavernDecoratorsByLayer[o.id]=[]:this.cavernDecoratorsByLayer[o.id]=this.layerDecoratorConfig.getRandomLayerDecorator(this.rng))}}generateTerrain(e){let t=this.findApplicableTerrainLayersForGrid(e),i=e.zones;for(let r=0;r<i.length;r++){let o=i[r].regions;for(let a=0;a<o.length;a++){let h=o[a].tiles;for(let u=0;u<h.length;u++)this.assignTileTerrain(h[u],t)}}for(let r=0;r<i.length;r++){let o=i[r].regions;for(let a=0;a<o.length;a++){let h=o[a].tiles;for(let u=0;u<h.length;u++){let m=h[u];!m.open||m.fixtureDescription||this.assignCavernDecorationToTile(m)}}}}generateTileBackgrounds(e){this.generateBackground(e)}isTileCavern(e){let t=e.tileType;if(!t){console.log("LayeredTerrainGenerator.isTileCavern() no tile type");return}let i=t.layerDescription;if(!i){console.log("LayeredTerrainGenerator.isTileCavern() no layer desc. tileType.icon="+t.iconFileName);return}if(!this.terrainLayerById[i.id]){console.log("LayeredTerrainGenerator.isTileCavern() no terrain layer. id="+i.id);return}let s=e.origin,o=this.cavernFbmA.calculateNoise(s.x,s.y);if(o>this.cavernValueAMin&&o<this.cavernValueAMax)return!0;let a=this.cavernFbmB.calculateNoise(s.x/2,s.y*2);return a>this.cavernValueBMin&&a<this.cavernValueBMax}generateBackground(e){let t=this;ie.allTilesInGrid(e,function(i){t.assignTileBackgroundSprite(i)})}assignTileBackgroundSprite(e){let t=e.tileType;if(!t){console.log("LayeredTerrainGenerator.setTileBackground() ERROR Tile has no TileType!");return}let i=t.layerDescription;i?e.backgroundSprite=this.getBackgroundSprite(e.origin,i.primaryTileType.tileTypeBackground):t.tileTypeBackground&&(e.backgroundSprite=this.getBackgroundSprite(e.origin,t.tileTypeBackground))}getBackgroundSprite(e,t){let i=Math.abs(this.backgroundFbm.calculateNoise(e.x,e.y)+1),s=Math.min(Math.max(0,i/3.25),1)*(t.sprites.length-1)|0;return t.sprites[s]}assignCavernDecorationToTile(e){let t=e.tileType;if(!t)return;let i=t.layerDescription;if(!i)return;let r=this.cavernDecoratorsByLayer[i.id];if(!r||r.length===0)return;let s=e.origin;if(r[this.indexGenerator.getIndexFromFbm(s.x,s.y,r.length)].decorateCavernTile(e,this.rng),i.monsterDescriptions.length>0&&this.rng.random()<.01){let a=i.monsterDescriptions[this.rng.randomInt(i.monsterDescriptions.length)];this.characterCreator.createMonsterAtTile(a,e)}}assignTileTerrain(e,t){let i=this.findTerrainLayerForTile(e,t);i&&(i.assignTileTerrain(e,!1),this.isTileCavern(e)?e.open=!0:this.assignTypeForNonCavernTile(e,i),this.assignTileBackgroundSprite(e))}assignTypeForNonCavernTile(e,t){let i=e.origin,r=this.rng.random();if(r<.8&&t.isOreTileSupported()&&this.oreFbm.calculateNoise(i.y,i.x/3)<-3.55){t.assignTileToOreType(e);return}if(r<.4){if(t.isGoldTileSupported()&&this.goldFbm.calculateNoise(i.x,i.y)<-3.5){t.assignTileToGoldType(e);return}if(this.silverFbm.calculateNoise(i.x,i.y)<-3.5){t.assignTileToSilverType(e);return}}if(r<.02&&t.isUpgradeTileSupported()&&this.upgradeFbm.calculateNoise(i.x,i.y)<-3){t.assignTileToUpgradeType(e);return}if(r<.01&&t.isRubyTileSupported()&&this.rubyFbm.calculateNoise(i.x,i.y)<-3){t.assignTileToRubyType(e);return}}findApplicableTerrainLayersForGrid(e){let t=e.origin.y/n.tile.size,i=t+n.grid.gridTileHeight,r=[];for(let s=0;s<this.terrainLayers.length;s++){let o=this.terrainLayers[s];o.isLayerForGrid(t,i)&&r.push(o)}return r}findTerrainLayerForTile(e,t){let i=e.origin.y/n.tile.size;for(let r=t.length-1;r>=0;r--){let s=t[r];if(s.isLayerForTile(e,i))return s}return t.length>0?t[0]:null}};var ul=Gl(Ol());var go=class{constructor(e){this.characterCreator=e}getGridKey(e){let t=e.getGridCol(),i=e.getGridRow(),r=t>=0?"":"n",s=i>=0?"":"n";return"G_"+r+Math.abs(t)+"_"+s+Math.abs(i)}generateGridStateForExport(e){if(!e)return console.log("GridSave.generateGridStateForExport() Null grid"),null;let t=this.generateState(e);return t?{key:this.getGridKey(e),origin:{x:e.origin.x,y:e.origin.y},state:t}:(console.log("GridSave.generateGridStateForExport() Failed to generate grid state"),null)}importGridState(e,t){if(!e)return console.log("GridSave.importGridState() FAIL. grid is null"),!1;let i=t.origin;return e.origin.set(i.x,i.y),e.initializeZonesForGrid(),this.loadStateInternal(e,t.state),!0}saveGridState(e){if(e.gridChangeCount===0)return;let t=this.generateState(e);if(!t)return console.log("GridSave.saveGridState() Failed to generate grid state"),!1;let i=this.getGridKey(e),r=JSON.stringify(t);if(!r)return console.log("GridSave.saveGridState() Failed to stringify state for grid: "+i),!1;let s=ul.compressToUTF16(r);return s?(localStorage.setItem(i,s),!0):(console.log("GridSave.saveGridState() Failed to compress state for grid: "+i),!1)}removeGridState(e){localStorage.removeItem(e)}loadGridState(e){let t=this.getGridKey(e),i=localStorage.getItem(t);if(i){let r=ul.decompressFromUTF16(i);if(r){let s=JSON.parse(r);if(s)return this.loadStateInternal(e,s),!0;console.log("GridSave.loadGridState() Failed to parse grid json.  grid: "+t)}else console.log("GridSave.loadGridState() Failed to decompress grid save state. grid: "+t)}return!1}generateState(e){let t={};return t.tiles=this.generateTileStateArray(e),t.characters=this.generateCharacterStateArray(e),t}loadStateInternal(e,t){this.loadTileStateArray(e,t.tiles),this.loadCharacterStateArray(e,t.characters)}generateTileStateArray(e){let t=this,i=[];return ie.allTilesInGrid(e,r=>{i.push(t.generateTileState(r))}),i}loadTileStateArray(e,t){if(!t){console.log("GridSave.loadTileStateArray() no tile state array");return}let i=0,r=this;ie.allTilesInGrid(e,s=>{r.loadTileState(s,t[i]),i++})}generateCharacterStateArray(e){let t=[];if(e.characters.length===0)return t;let i=e.getOriginTileCol(),r=e.getOriginTileRow();for(let s=0;s<e.characters.length;s++){let o=e.characters[s];if(!o.isMonster())continue;let a=this.generateCharacterState(i,r,o);a&&t.push(a)}return t}loadCharacterStateArray(e,t){if(!(!t||t.length===0))for(let i=0;i<t.length;i++)this.loadCharacterState(e,t[i])}generateTileState(e){let t={},i=0;return e.open&&(i+=1),e.lighting.sunlightFull&&(i+=2),e.lighting.sunlightPartial&&(i+=4),e.lighting.everVisibleToCharacter&&(i+=8),t.a=i,t.b=e.tileType.id,e.fixtureDescription&&(t.f={t:e.fixtureDescription.typeName,c:e.fixtureDescription.colorName}),t}loadTileState(e,t){if(!t){console.log("GridSave.loadTileState() no tile state");return}let i=t.a,r=t.b,s=(i&1)===1,o=Yl[r];e.tileInit(s,o);let a=(i&2)===2,h=(i&4)===4,u=(i&8)===8;if(e.lighting.sunlightPartial=h,a&&e.markAsSunlightFull(),u&&e.markTileAsEverVisible(),t.f){let m=t.f.t,g=t.f.c;e.fixtureDescription=ri.getDescription(m,g)}}generateCharacterState(e,t,i){let r=i.position.tile;if(!r)return console.log("GridSave.generateCharacterState() character tile is null"),null;let s={};return s.c=r.getTileCol()-e,s.r=r.getTileRow()-t,s.d=i.getMonsterDescriptionId(),s}loadCharacterState(e,t){if(!t)return;let i=t.c,r=t.r,s=t.d,o=e.getGridTileLocal(i,r);if(!o){console.log("GridSave.loadCharacterState() Failed to find tile for character.  tileCol="+i+" tileRow="+r);return}let a=Jl[s];if(!a){console.log("GridSave.loadCharacterState() Failed to find monster description: "+s);return}this.characterCreator.createMonsterAtTile(a,o)}};var Pt=class{constructor(e,t,i){this.gridKey=e,this.gridCol=t,this.gridRow=i}};var fo=class extends F{constructor(e){super(),this.metadataByKey=new Map,this.gridSave=e,this.maxSizeThreshold=50,this.farColThreshold=8,this.farRowThreshold=6}generateGridStateForExport(e){let t={grids:[]},i=e.grids;for(let r=0;r<i.length;r++){let s=this.gridSave.generateGridStateForExport(i[r]);t.grids.push(s)}return t}importGridState(e,t){if(!t)return console.log("GridSaveManager.importGridState() No world grid state"),!1;if(!t.grids||t.grids.length<e.grids.length)return console.log("GridSaveManager.importGridState() Invalid grids array."),!1;let i=e.grids;for(let r=0;r<i.length;r++){let s=i[r],o=t.grids[r];if(!this.gridSave.importGridState(s,o))return console.log("GridSaveManager.importGridState() Failed to import grid index: "+r),!1;let a=o.key;if(this.metadataByKey.has(a))console.log("GridSaveManager.importGridState() NOT UPDATING METADATA FOR KEY BECAUSE IT WAS ALREADY THERE.");else{let h=new Pt(a,s.getGridCol(),s.getGridRow());this.metadataByKey.set(a,h)}}return!0}addGridSaveMetaFromSave(e){if(this.metadataByKey.has(e.gridKey)){console.log("GridSaveManager.addGridSaveMetaFromSave() added duplicate! key="+e.gridKey),console.trace();return}this.metadataByKey.set(e.gridKey,e)}saveGridState(e){if(!e||e.gridChangeCount===0)return;let t=this.gridSave.getGridKey(e);if(K.startTime("SaveGrid"),this.gridSave.saveGridState(e)){if(!this.metadataByKey.has(t)){let i=new Pt(t,e.getGridCol(),e.getGridRow());this.metadataByKey.set(t,i)}}else console.log("GridSaveManager.saveGridState() Failed to save grid state. key="+t);K.endTime("SaveGrid")}deleteAllGrids(){let e=[];for(let[t]of this.metadataByKey.entries())e.push(t);for(let t=0;t<e.length;t++)this.removeGridState(e[t])}removeGridState(e){this.gridSave.removeGridState(e),this.metadataByKey.delete(e)}loadGridState(e){let t=this.gridSave.getGridKey(e);if(!this.metadataByKey.has(t))return!1;K.startTime("LoadGrid");let r=this.gridSave.loadGridState(e);return K.endTime("LoadGrid"),r?!0:(console.log("GridSaveManager.loadGridState() failed to load grid state. gridKey="+t),!1)}clearDistantGrids(e,t){let i=e.getGridCol(),r=e.getGridRow(),s=[];if(e===t)for(let[o,a]of this.metadataByKey.entries())this.isDistant(i,r,a)&&s.push(o);else{let o=t.getGridCol(),a=t.getGridRow();for(let[h,u]of this.metadataByKey.entries())this.isDistant(i,r,u)&&this.isDistant(o,a,u)&&s.push(h)}for(let o=0;o<s.length;o++)this.removeGridState(s[o])}isDistant(e,t,i){return Math.abs(e-i.gridCol)>this.farColThreshold||Math.abs(t-i.gridRow)>this.farRowThreshold}resetFull(){this.deleteAllGrids()}resetForPrestige(){this.resetFull()}};var To=class{constructor(e,t,i,r,s){this.gridSaveManager=e,this.terrainGenerator=t,this.worldGrid=i,this.crew=r,this.targetList=s}loadGrid(e,t,i){e.isLoaded()&&this.unloadGrid(e),e.origin.set(t,i),e.initializeZonesForGrid(),this.loadOrGenerateTerrain(e,!1)}unloadGrid(e){this.unloadGridInternal(e,!0)}unloadGridInternal(e,t){t&&e.loaded&&!this.targetList.tileHealthNegligible&&this.gridSaveManager.saveGridState(e);let i=this.crew.miners;for(let r=0;r<i.length;r++){let s=i[r];s.position.tile&&s.position.tile.getGrid()===e&&(console.log("GridLoader.unloadGridInternal() Party character is in grid that is being unloaded."),s.onInvalidGrid())}e.unloadGrid(),this.targetList.onGridUnload(e),this.crew.onGridUnload(e)}loadOrGenerateTerrain(e,t){!t&&this.gridSaveManager.loadGridState(e)?this.terrainGenerator.generateTileBackgrounds(e):(K.startTime("GenerateTerrain"),e.nullifyBorderNeighbors(),this.terrainGenerator.generateTerrain(e),K.endTime("GenerateTerrain"),e.markGridAsChanged())}onTerrainGenerationComplete(e){e.gridChangeCount=0,e.loaded=!0,ie.allTilesInGrid(e,function(t){t.open&&t.tileType===X.SKY&&!t.lighting.sunlightFull&&t.handleSunlightStart()})}};var cl=0,ml=1,pl=2,gl=3,fl=4,Tl=5,El=6,Sl=7,Eo=class extends F{constructor(e,t){super(),this.worldGrid=e,this.projection=t,this.centerGrid=null,this.loadedGridTurn=0,this.gridLoader=null,this.crew=null,this.savedGrids=new Array(9)}initializeLoadingManager(e,t){this.gridLoader=e,this.crew=t;let i=n.grid.gridPixelWidth,r=n.grid.gridPixelHeight,s=this.worldGrid.grids,o=U.floor(this.projection.gridCenter.x/i),a=U.floor(this.projection.gridCenter.y/r),h=o*i,u=a*r;this.gridLoader.loadGrid(s[0],h-i,u-r),this.gridLoader.loadGrid(s[1],h,u-r),this.gridLoader.loadGrid(s[2],h+i,u-r),this.gridLoader.loadGrid(s[3],h-i,u),this.gridLoader.loadGrid(s[4],h,u),this.gridLoader.loadGrid(s[5],h+i,u),this.gridLoader.loadGrid(s[6],h-i,u+r),this.gridLoader.loadGrid(s[7],h,u+r),this.gridLoader.loadGrid(s[8],h+i,u+r),this.performPostGridLoadOperations(),this.worldGrid.changeCount++,this.worldGrid.shiftCount++}clearSavedGrid(e){let t=this.savedGrids.indexOf(e);t!==-1?this.savedGrids[t]=null:console.log("GridLoadingManager.clearSavedGrid() did not find grid in saved grids")}setGridIfAlreadyLoaded(e,t,i){let r=this.findSavedGridIndex(e,i);if(r===-1)return;let s=this.savedGrids[r];s.loaded&&(this.savedGrids[r]=null,this.worldGrid.grids[t]=s)}findFirstSavedGridIndex(){for(let e=0;e<this.savedGrids.length;e++)if(this.savedGrids[e])return e;return-1}loadIfUnloaded(e,t,i){let r=this.worldGrid.grids[t];if(r&&r.isLoaded())return;let s=this.findFirstSavedGridIndex();if(s===-1){console.log("GridLoadingManager.loadIfUnloaded() ERROR Failed to find available grid!");return}let o=this.savedGrids[s];this.worldGrid.grids[t]=o,this.savedGrids[s]=null;let a=e.origin.x,h=e.origin.y,u=a,m=h,g=n.grid.gridPixelWidth,_=n.grid.gridPixelHeight;switch(i){case ml:u=a-g,m=h-_;break;case cl:m=h-_;break;case pl:u=a+g,m=h-_;break;case gl:u=a-g;break;case fl:u=a+g;break;case El:m=h+_,u=a-g;break;case Tl:m=h+_;break;case Sl:m=h+_,u=a+g;break;default:return console.log("GridLoadingManager.findSavedGridIndex() Unknown direction: "+i),-1}this.gridLoader.loadGrid(o,u,m)}findSavedGridIndex(e,t){let i=e.getOriginTileCol(),r=e.getOriginTileRow(),s=n.grid.gridTileWidth,o=n.grid.gridTileHeight,a=i,h=r;switch(t){case ml:h=r-o,a=i-s;break;case cl:h=r-o;break;case pl:h=r-o,a=i+s;break;case gl:a=i-s;break;case fl:a=i+s;break;case El:h=r+o,a=i-s;break;case Tl:h=r+o;break;case Sl:h=r+o,a=i+s;break;default:return console.log("GridLoadingManager.findSavedGridIndex() Unknown direction: "+t),-1}for(let u=0;u<this.savedGrids.length;u++){let m=this.savedGrids[u];if(!m||m.getOriginTileCol()!==a)continue;if(m.getOriginTileRow()===h)return u}return-1}manageLoadedGridsForFrame(){let e=this.projection.gridCenter,t=this.worldGrid.findGridContaining(e);if(!t){t=this.worldGrid.grids[4],t.isLoaded()&&this.gridLoader.unloadGrid(t);let r=U.floor(e.x/n.grid.gridPixelWidth),s=U.floor(e.y/n.grid.gridPixelHeight),o=r*n.grid.gridPixelWidth,a=s*n.grid.gridPixelHeight;this.gridLoader.loadGrid(t,o,a),this.centerGrid=null}if(this.centerGrid&&this.centerGrid===t)return;this.worldGrid.changeCount++,this.worldGrid.shiftCount++,this.centerGrid=t;let i=this.worldGrid.grids;for(let r=0;r<i.length;r++)this.savedGrids[r]=i[r],i[r]=null;i[4]=this.centerGrid,this.clearSavedGrid(this.centerGrid),this.setGridIfAlreadyLoaded(this.centerGrid,0,ml),this.setGridIfAlreadyLoaded(this.centerGrid,1,cl),this.setGridIfAlreadyLoaded(this.centerGrid,2,pl),this.setGridIfAlreadyLoaded(this.centerGrid,3,gl),this.setGridIfAlreadyLoaded(this.centerGrid,5,fl),this.setGridIfAlreadyLoaded(this.centerGrid,6,El),this.setGridIfAlreadyLoaded(this.centerGrid,7,Tl),this.setGridIfAlreadyLoaded(this.centerGrid,8,Sl),this.loadIfUnloaded(this.centerGrid,0,ml),this.loadIfUnloaded(this.centerGrid,1,cl),this.loadIfUnloaded(this.centerGrid,2,pl),this.loadIfUnloaded(this.centerGrid,3,gl),this.loadIfUnloaded(this.centerGrid,5,fl),this.loadIfUnloaded(this.centerGrid,6,El),this.loadIfUnloaded(this.centerGrid,7,Tl),this.loadIfUnloaded(this.centerGrid,8,Sl),K.startTime("PostGridLoading"),this.performPostGridLoadOperations(),K.endTime("PostGridLoading")}performPostGridLoadOperations(){if(this.setAllGridNeighbors(),this.findAllGridBorderTileNeighbors(),this.evaulateGridTiles(),this.onLoadingComplete(),this.validateTileReferences(),this.crew&&this.crew.main){let e=null,t=this.crew.main.position.tile;t?e=t.getGrid():this.centerGrid&&(e=this.centerGrid.getWorldGrid().findGridContaining(this.crew.main.position.worldCoordinateOrigin)),e&&this.gridLoader.gridSaveManager.clearDistantGrids(this.centerGrid,e)}}setAllGridNeighbors(){let e=this.worldGrid.grids;e[0].setGridNeighbors(null,e[3],e[1],null),e[1].setGridNeighbors(null,e[4],e[2],e[0]),e[2].setGridNeighbors(null,e[5],null,e[1]),e[3].setGridNeighbors(e[0],e[6],e[4],null),e[4].setGridNeighbors(e[1],e[7],e[5],e[3]),e[5].setGridNeighbors(e[2],e[8],null,e[4]),e[6].setGridNeighbors(e[3],null,e[7],null),e[7].setGridNeighbors(e[4],null,e[8],e[6]),e[8].setGridNeighbors(e[5],null,null,e[7])}onLoadingComplete(){let e=this.worldGrid.grids;for(let t=0;t<e.length;t++)e[t].loaded||this.gridLoader.onTerrainGenerationComplete(e[t])}findAllGridBorderTileNeighbors(){let e=this.worldGrid.grids;for(let t=0;t<e.length;t++)e[t].findWorldGridTileNeighbors()}evaulateGridTiles(){let e=this.worldGrid.grids;for(let t=0;t<e.length;t++){let i=e[t];i.loaded?i.evaluateWorldGridTileNeighborBorders():i.evaluateAllTileBorders()}}validateTileReferences(){let e=this.worldGrid.grids;for(let t=0;t<e.length;t++)this.validateGridTileReferences(e[t])}validateGridTileReferences(e){let t=e.characters;for(let i=0;i<t.length;i++){let r=t[i].position;r.tile&&r.tile.contains(r.worldCoordinateOrigin)||(console.log("GridLoadingManager.validateGridTileReferences() found invalid character. "+r.worldCoordinateOrigin.toString()),t[i].onInvalidGrid())}}regenerateGrids(){let e=this.worldGrid.grids;for(let t=0;t<e.length;t++){let i=e[t];i&&this.gridLoader.regenerateGrid(i)}this.worldGrid.changeCount++}resetFull(){let e=this.worldGrid.grids;for(let t=0;t<e.length;t++){let i=e[t];i&&this.gridLoader.unloadGrid(i)}this.crew=null,this.gridLoader=null}resetForPrestige(){this.resetFull()}};var Ni=class{constructor(e,t){this.a0=e,this.a1=t}};var So=class{constructor(e){this.nextIndex=0,this.arcs=new Array(e);for(let t=0;t<e;t++)this.arcs[t]=new Ni(0,0)}resetCache(){this.nextIndex=0}getArc(e,t){let i;return this.nextIndex>=this.arcs.length?(i=new Ni(e,t),this.arcs.push(i)):(i=this.arcs[this.nextIndex],i.a0=e,i.a1=t),this.nextIndex++,i}};var Co=class{tileLighted(e,t,i){}};var xl=[[0,-1],[1,0],[0,1],[-1,0]],wo=class{constructor(e){this.worldGrid=e}castShadows(e,t,i){}getNeighborCountForRadius(e){return e*8}forEachCircleTile(e,t,i,r){let h=e+-1*i,u=t+1*i,m=null,g=this.getNeighborCountForRadius(i),_=0;for(let C=0;C<xl.length;C++)for(let w=0;w<i*2;w++){let T;if(m!=null?T=m.getNeighborColRow(h,u):T=this.worldGrid.getGridTile(h,u),T&&!this.onCircleTile(T,_,g,i,r))return;_++,h+=xl[C][0],u+=xl[C][1],m=T}}onCircleTile(e,t,i,r,s){}};var Lo=class extends wo{constructor(e){super(e),this.shadows=[],this.cache=new So(2500)}castShadows(e,t,i){if(e==null)return;i.tileLighted(e,0,1);let r=e.getTileCol(),s=e.getTileRow();this.shadows.length=0,this.cache.resetCache();for(let o=1;o<=t;o++)this.forEachCircleTile(r,s,o,i)}onCircleTile(e,t,i,r,s){if(!e)return!0;let o=this.cache.getArc(t>0?2*t-1:2*i-1,2*i),a=this.cache.getArc(2*t+1,2*i),h=e.isOpaque(),u=this.checkVisibility(o,a,h,this.shadows);return u>0&&s.tileLighted(e,r,u),!(this.shadows.length==2&&this.shadows[0].a0==0&&this.shadows[1].a0==this.shadows[1].a1)}checkVisibility(e,t,i,r){if(e.a0>t.a0){let T=this.checkVisibility(e,this.cache.getArc(e.a1,e.a1),i,r),S=this.checkVisibility(this.cache.getArc(0,1),t,i,r);return(T+S)/2}let s=0,o=!1;for(;s<r.length;){let T=r[s],S=T.a0*e.a1-e.a0*T.a1;if(S>=0){S==0&&s%2==0&&(o=!0);break}s++}let a=r.length,h=!1;for(;a--!=0;){let T=r[a],S=t.a0*T.a1-T.a0*t.a1;if(S>=0){S==0&&a%2!=0&&(h=!0);break}}let u=!0;if((s==a&&(o||h)||o&&h&&s+1==a&&a%2!=0||s>a&&s%2!=0)&&(u=!1),!u)return 0;let m,g=a-s+1;if(g%2!=0)if(s%2!=0){let T=r[s],S=T.a1*t.a1;m=(t.a0*T.a1-T.a0*t.a1)/S,i&&r.splice(s,g,t)}else{let T=r[a],S=e.a1*T.a1;m=(T.a0*e.a1-e.a0*T.a1)/S,i&&r.splice(s,g,e)}else if(s%2!=0){let T=r[s],S=r[a],R=T.a1*S.a1;m=(S.a0*T.a1-T.a0*S.a1)/R,i&&r.splice(s,g)}else return i&&r.splice(s,g,e,t),1;let _=e.a1*t.a1,w=(t.a0*e.a1-e.a0*t.a1)/_;return w==0?1:m/w}};var ft=class extends Co{constructor(e,t){super(),this.lightColor=e,this.lightSourceCastRadius=t,this.workingCalculatedLightColor=new j(1,1,1,1)}setValues(e,t){this.lightColor=e,this.lightSourceCastRadius=t}calculatedLightedColor(e,t){let i=1-1*e/this.lightSourceCastRadius;return this.workingCalculatedLightColor.set(this.lightColor),this.workingCalculatedLightColor.mul(i*t),this.workingCalculatedLightColor}};var _o=class extends ft{constructor(e,t){super(e,t)}tileLighted(e,t,i){e.addDynamicLighting(this.calculatedLightedColor(t,i))}};var Pi=class extends ft{constructor(e,t){super(e,t)}tileLighted(e,t,i){e.addPositionalLighting(this.calculatedLightedColor(t,i))}};var Mo=class extends ft{constructor(e,t){super(e,t)}tileLighted(e,t,i){e.addEnvironmentLighting(this.calculatedLightedColor(t,i))}};var Ro=class extends F{constructor(e,t){super(),this.worldGrid=e,this.projection=t,this.visibleTileRadius=13,this.lightSourceRadius=7,this.mainPositionalTileRadius=7,this.secondaryPositionalTileRadius=5,this.lightSourceRecalculationFrames=40,this.maxDynamicLightSources=10,this.elapsedFrameCount=this.lightSourceRecalculationFrames,this.dynamicLightSources=[],this.calculatedTile=null,this.shadowCaster=new Lo(e),this.forceEnvironmentalRecalculation=!1,this.dynamicLightSourceCastCallback=new _o(new j(0,0,0,0),5),this.positionalLightSourceCastCallback=new Pi(new j(0,0,0,1),this.mainPositionalTileRadius),this.secondaryPositionalLightSourceCastCallback=new Pi(new j(0,0,0,1),this.secondaryPositionalTileRadius),this.environmentalLightSourceCastCallback=new Mo(new j(0,0,0,0),5),this.regionResetLightingCallback=r=>{let s=r.getTiles();for(let o=0;o<s.length;o++)s[o].lighting.resetLighting()};let i=this;this.gridEnvironmentalLightingCallback=r=>{let s=r.getLightSources();if(!(!s||s.length===0))for(let o=0;o<s.length;o++){let a=s[o];if(a.isFinishedAndAvailable())continue;let h=a.getTileRadius();i.environmentalLightSourceCastCallback.setValues(a.getColor(),h),i.shadowCaster.castShadows(a.getTile(),h,i.environmentalLightSourceCastCallback)}}}resetLightingCalculator(){this.dynamicLightSources.length=0}addDynamicLightSource(e){if(!e||e.getTile()==null||e.isFinishedAndAvailable())return;this.dynamicLightSources.push(e);let t=this.dynamicLightSources.length-this.maxDynamicLightSources;t>0&&this.dynamicLightSources.splice(this.maxDynamicLightSources-1,t),console.log("LightingCalculator.addDynamicLightSource() size="+this.dynamicLightSources.length)}removeDynamicLightSource(e){if(!e)return;let t=this.dynamicLightSources.indexOf(e);t!==-1&&this.dynamicLightSources.splice(t,1)}resetForFrame(){ie.allVisibleRegions(this.worldGrid,this.projection,this.regionResetLightingCallback)}calculateEnvironmentLighting(e){this.elapsedFrameCount+=e,(this.forceEnvironmentalRecalculation||this.elapsedFrameCount>=this.lightSourceRecalculationFrames)&&(this.elapsedFrameCount=0,ie.allVisibleGrids(this.worldGrid,this.projection,this.gridEnvironmentalLightingCallback))}calculateDynamicLighting(){if(this.dynamicLightSources.length!==0)for(let e=this.dynamicLightSources.length-1;e>=0;e--){let t=this.dynamicLightSources[e];if(t.isFinishedAndAvailable()){this.dynamicLightSources.splice(e,1);continue}let i=t.getTile();if(!i){this.dynamicLightSources.splice(e,1);continue}let r=t.getTileRadius(),s=i.getOrigin();this.projection.isVisible(s.x+n.tile.halfSize,s.y+n.tile.halfSize,n.tile.size*r)&&(this.dynamicLightSourceCastCallback.setValues(t.getColor(),r),this.shadowCaster.castShadows(i,r,this.dynamicLightSourceCastCallback))}}calculatePrimaryPositionalLighting(e){e&&this.shadowCaster.castShadows(e,this.mainPositionalTileRadius,this.positionalLightSourceCastCallback)}calculateSecondaryPositionalLighting(e){e&&this.shadowCaster.castShadows(e,this.secondaryPositionalTileRadius,this.secondaryPositionalLightSourceCastCallback)}onEnvironmentalLightSourceChange(){this.forceEnvironmentalRecalculation=!0}onWallBroken(){this.forceRecalculation()}forceRecalculation(){this.forceEnvironmentalRecalculation=!0}resetFull(){this.dynamicLightSources.length=0,this.calculatedTile=null,this.forceEnvironmentalRecalculation=!1}resetForPrestige(){this.resetFull()}};var yi=class{constructor(){this.collisionVector=new P(0,0)}static isStandingOnTileOrigin(e){let t=e.position.tile;if(!t)return!0;let i=e.position.worldCoordinateOrigin;return U.floor(i.y)===t.origin.y}static isStandingOnTopOfClosedTile(e){let t=e.position.tile;if(!t)return!0;let i=e.position.worldCoordinateOrigin;if(U.floor(i.y)!==t.origin.y)return!1;let s=t.getNeighborBottom();return s&&!s.isTraversable()}isCollisionDown(e,t){let i=e.position.tile;if(!i)return!0;let r=i.getNeighborBottom();if(!r)return!0;if(r.open)return!1;let s=e.position.worldCoordinateOrigin.y+n.tile.size+t;return i.containsXY(e.position.worldCoordinateOrigin.x,s)?!i.open:r.containsXY(e.position.worldCoordinateOrigin.x,s)?!r.open:!1}};var Ao=class{constructor(e,t,i){this.worldGrid=e,this.projection=t,this.collision=new yi,this.gameTime=i;let r=this;this.frameTimeRatio=1,this.applyForcesOnCharactersFunction=function(s){for(let o=s.characters.length-1;o>=0;o--){let a=s.characters[o];a.isPartyMember()||a.position.tile&&(a.position.pathPlan.length>0||r.applyGravity(a,r.frameTimeRatio))}}}updatePhysicsForFrame(e){this.frameTimeRatio=e,ie.allVisibleGrids(this.worldGrid,this.projection,this.applyForcesOnCharactersFunction)}applyGravity(e,t){if(yi.isStandingOnTopOfClosedTile(e)){e.position.setPositionToTileOrigin(),e.position.gravityThisFrame>0&&(e.position.gravityThisFrame=0,e.setCharacterAction(H.STAND));return}e.position.gravityThisFrame=n.physics.gravityRatePerFrame*t,this.collision.isCollisionDown(e,e.position.gravityThisFrame)?(e.position.setPositionToTileOrigin(),e.position.gravityThisFrame>0&&(e.position.gravityThisFrame=0,e.setCharacterAction(H.STAND))):(e.position.moveY(e.position.gravityThisFrame),e.setCharacterAction(H.FALL))}};var No=class{constructor(e,t,i){this.characterPhysics=new Ao(e,t,i)}updatePhysicsForFrame(e){this.characterPhysics.updatePhysicsForFrame(e)}};var It=Gl(Ol());var bi=class{constructor(){}static generateSave(e){let t={};return t.gridCenter={x:e.gridCenter.x,y:e.gridCenter.y},t.zoom=e.zoom,t.centerOnCharacter=e.stayCenteredOnCharacter,t}static loadSave(e,t){t&&(e.setGridCenter(t.gridCenter.x,t.gridCenter.y),e.setZoom(t.zoom),e.stayCenteredOnCharacter=!1,t.centerOnCharacter&&(e.stayCenteredOnCharacter=!0))}};var Ii=class{constructor(){}static generateSave(e){let t={};return t.v=1,t.seed=e.worldSeed,t}static loadSave(e,t){t&&(e.worldSeed=t.seed)}};var A=class{constructor(){}static save(e){return e?[e.m,e.e]:[0,0]}static load(e,t){e&&t.set(e[0],e[1])}};var Oe=class{constructor(){}static generateSave(e){let t={};t.sum=A.save(e.sum),t.startTurn=e.startTurn,t.valuePerTurn=A.save(e.valuePerTurn),t.rateIndex=e.rateIndex,t.rates=[];for(let i=0;i<e.rates.length;i++)t.rates.push(A.save(e.rates[i]));return t}static loadSave(e,t){if(t&&(A.load(t.sum,e.sum),t.startTurn&&(e.startTurn=t.startTurn),A.load(t.valuePerTurn,e.valuePerTurn),e.rateIndex=0,t.rateIndex&&(e.rateIndex=t.rateIndex),t.rates)){e.rates.length=0;for(let i=0;i<t.rates.length;i++){let r=new c(0);A.load(t.rates[i],r),e.rates.push(r)}}}};var Oi=class{constructor(){}static generateSave(e){let t={};return t.ore=A.save(e.ore),t.gold=A.save(e.gold),t.goldSum=A.save(e.goldSum),t.ruby=A.save(e.ruby),t.silver=A.save(e.silver),t.silverSum=A.save(e.silverSum),t.prestige=A.save(e.prestige),t.prestigeSum=A.save(e.prestigePointsSum),t.unclaimed=A.save(e.unclaimedPrestige),t.prestigePerTurn=A.save(e.prestigePerTurn),t.goldPerTurn=A.save(e.goldPerTurn),t.orePerTurn=A.save(e.orePerTurn),t.rubyPerTurn=A.save(e.rubyPerTurn),t.silverPerTurn=A.save(e.silverPerTurn),t.offlinePrestige=A.save(e.offlinePrestige),t.offlineGold=A.save(e.offlineGold),t.offlineOre=A.save(e.offlineOre),t.offlineRuby=A.save(e.offlineRuby),t.offlineSilver=A.save(e.offlineSilver),t.offlineSeconds=e.offlineSeconds,t.countedOfflineSeconds=e.countedOfflineSeconds,t.prestigePerTurnCalc=Oe.generateSave(e.prestigeRatePerTurnCalculator),t.goldPerTurnCalc=Oe.generateSave(e.goldRatePerTurnCalculator),t.orePerTurnCalc=Oe.generateSave(e.oreRatePerTurnCalculator),t.rubyPerTurnCalc=Oe.generateSave(e.rubyRatePerTurnCalculator),t.silverPerTurnCalc=Oe.generateSave(e.silverRatePerTurnCalculator),t}static loadSave(e,t){t&&(A.load(t.ore,e.ore),A.load(t.gold,e.gold),A.load(t.goldSum,e.goldSum),A.load(t.ruby,e.ruby),A.load(t.silver,e.silver),A.load(t.silverSum,e.silverSum),A.load(t.prestige,e.prestige),A.load(t.prestigeSum,e.prestigePointsSum),A.load(t.unclaimed,e.unclaimedPrestige),A.load(t.prestigePerTurn,e.prestigePerTurn),A.load(t.goldPerTurn,e.goldPerTurn),A.load(t.orePerTurn,e.orePerTurn),A.load(t.rubyPerTurn,e.rubyPerTurn),A.load(t.silverPerTurn,e.silverPerTurn),A.load(t.offlinePrestige,e.offlinePrestige),A.load(t.offlineGold,e.offlineGold),A.load(t.offlineOre,e.offlineOre),A.load(t.offlineRuby,e.offlineRuby),A.load(t.offlineSilver,e.offlineSilver),t.offlineSeconds&&(e.offlineSeconds=t.offlineSeconds),t.countedOfflineSeconds&&(e.countedOfflineSeconds=t.countedOfflineSeconds),Oe.loadSave(e.prestigeRatePerTurnCalculator,t.prestigePerTurnCalc),Oe.loadSave(e.goldRatePerTurnCalculator,t.goldPerTurnCalc),Oe.loadSave(e.oreRatePerTurnCalculator,t.orePerTurnCalc),Oe.loadSave(e.rubyRatePerTurnCalculator,t.rubyPerTurnCalc),Oe.loadSave(e.silverRatePerTurnCalculator,t.silverPerTurnCalc))}};var xi=class{constructor(){}static generateSave(e){let t={};return t.turn=e.turnNumber,t.frame=e.frameNumber,t.time=Date.now(),t}static loadSave(e,t){t&&(e.turnNumber=t.turn,e.saveTime=t.time,t.frame&&(e.frameNumber=t.frame))}};var Di=class{constructor(){}static generateSave(e){let t={};return t.mineDamageMultiplier=A.save(e.minedDamageBonusMultiplier.getValue()),t.mineOreBonus=A.save(e.minedOreBonus.getValue()),t}static loadSave(e,t){t&&(A.load(t.mineDamageMultiplier,e.minedDamageBonusMultiplier.getValue()),A.load(t.mineOreBonus,e.minedOreBonus.getValue()))}};var vi=class{constructor(){}static generateSave(e){let t={};t.upgrades=[];for(let i=0;i<e.upgrades.length;i++)e.upgrades[i]&&t.upgrades.push(this.generateUpgradeSave(e.upgrades[i]));return t}static loadSave(e,t,i){if(!i){console.log("MinedUpgradeCollectionSave.loadSave no save state");return}let r=i.upgrades;if(!r){console.log("MinedUpgradeCollectionSave.loadSave state empty");return}for(let s=0;s<r.length;s++){let o=this.loadUpgradeSave(t,r[s]);o&&e.addBulk(o)}e.addBulkCompleted()}static generateUpgradeSave(e){let t=e.getCreatorId(),i={};return i.creatorId=t,t===ct.mineDamage?this.generateFreeValueUpgradeSave(e,i):t===ct.mineOre?this.generateMinedOreUpgradeSave(e,i):console.log("MinedUpgradeCollectionSave.generateUpgradeSave() No save logic associated with creatorId: "+t),i}static loadUpgradeSave(e,t){if(!t)return null;let i=t.creatorId;if(!i)return null;let r=e.getUpgradeCreatorById(i);return r?i===ct.mineDamage?this.loadFreeValueUpgradeSave(r,t):i===ct.mineOre?this.loadMinedOreUpgradeSave(r,t):(console.log("MinedUpgradeCollectionSave.loadUpgradeSave() No save logic associated with creatorId: "+i),null):(console.log("MinedUpgradeCollectionSave.loadUpgradeSave() Failed to find upgrade creator ID="+i),null)}static generateFreeValueUpgradeSave(e,t){e.cost&&(t.cost=A.save(e.cost)),t.value=A.save(e.valueDelta)}static loadFreeValueUpgradeSave(e,t){let i=new c(0);return A.load(t.value,i),e.createFreeValueUpgradeFromSave(i)}static generateMinedOreUpgradeSave(e,t){e.cost&&(t.cost=A.save(e.cost)),t.value=A.save(e.ore)}static loadMinedOreUpgradeSave(e,t){let i=new c(0);return A.load(t.value,i),e.createFreeValueUpgradeFromSave(i)}};var oi=class{constructor(){}static generateSave(e){let t={};return t.position={x:e.position.worldCoordinateOrigin.x,y:e.position.worldCoordinateOrigin.y},t.facingLeft=e.position.facingLeft,e.skillId&&(t.skillId=e.skillId),t}static loadSave(e,t){t&&(e.position.setWorldCoordinateOriginXY(t.position.x,t.position.y),e.position.facingLeft=t.facingLeft,t.skillId&&(e.skillId=t.skillId))}};var Gi=class{constructor(){}static generateSave(e){let t={};t.miners=[];for(let i=0;i<e.miners.length;i++)t.miners.push(oi.generateSave(e.miners[i]));return t}static loadSave(e,t){if(!t){console.log("CrewSave.loadSave() No save state. Not loading crew!");return}let i=t.miners;if(!i||i.length===0){console.log("CrewSave.loadSave() No miners data found");return}console.log("CrewSave.loadSave() create main miner");let r=e.createMainMiner();oi.loadSave(r,i[0]);for(let s=1;s<i.length;s++){let o=e.addNewMinerForSaveLoad();oi.loadSave(o,i[s])}}};var Po=class extends F{constructor(e,t){super(),this.totals=e,this.damage=t,this.layerDescription=ce.DIRT_LAYER,this.nextLayerDescription=this.findNextLayerDescription(),this.defaultMineSeconds=1,this.targetMineSeconds=1,this.targetRow=0,this.workingBrickHealth=new c(0),this.halfDeltaRows=15}deriveTargetSecondsForRow(e){if(this.layerDescription.containsRow(e)){this.deriveTargetSecondsInternal(this.layerDescription,e);return}let t=this.layerDescription.prevLayer;if(t&&t.containsRow(e)){this.deriveTargetSecondsInternal(t,e);return}let i=this.layerDescription.nextLayer;if(i&&i.containsRow(e)){this.deriveTargetSecondsInternal(i,e);return}let r=eh(e);if(r){this.deriveTargetSecondsInternal(r,e);return}console.log("PartyTarget.deriveTargetSecondsForRow() Failed to update target mine seconds")}deriveTargetSecondsInternal(e,t){e.calculateTileHealth(t,this.workingBrickHealth),this.targetMineSeconds=this.damage.calculateMineSeconds(this.workingBrickHealth)}calculateTargetRow(){this.damage.calculateMaxBrickHealth(this.targetMineSeconds,this.workingBrickHealth);let e=th(this.layerDescription,this.workingBrickHealth);this.targetRow=Math.max(n.target.minTargetRow,e.calculateTileDepth(this.workingBrickHealth))}setLayerDescriptionFromSave(e){this.layerDescription=e,this.nextLayerDescription=this.findNextLayerDescription(),this.calculateTargetRow()}findNextLayerDescription(){let e=this.layerDescription.nextLayer;if(e)return e;for(let t=0;t<Me.length;t++){let i=Me[t];if(i.prevLayer===this.layerDescription)return i}return null}unlockNextLayer(){if(!this.nextLayerDescription){console.log("PartyTarget.unlockNextLayer() No next layer!");return}this.layerDescription=this.nextLayerDescription,this.calculateTargetRow(),this.nextLayerDescription=this.findNextLayerDescription()}resetFull(){this.layerDescription=ce.DIRT_LAYER,this.nextLayerDescription=this.findNextLayerDescription(),this.targetMineSeconds=this.defaultMineSeconds,this.calculateTargetRow()}resetForPrestige(){this.resetFull()}};var ki=class{constructor(){}static generateSave(e){let t={};return t.layerId=e.layerDescription.id,t.targetMineSeconds=e.targetMineSeconds,t}static loadSave(e,t){if(!t)return;t.targetMineSeconds&&(e.targetMineSeconds=t.targetMineSeconds);let i=t.layerId,r=$l[i];r?e.setLayerDescriptionFromSave(r):console.log("PartyTargetSave.loadSave() Failed to find layer description: "+i)}};var Fi=class{constructor(){}static generateSave(e){let t={};t.metaArray=[];for(let i of e.metadataByKey.values()){let r=this.generateMetaState(i);r&&t.metaArray.push(r)}return t}static loadSave(e,t){if(!t){console.log("GridSaveManagerSave.loadSave() no data found in save 1");return}let i=t.metaArray;if(!i||i.length===0){console.log("GridSaveManagerSave.loadSave() no data found in save 2");return}for(let r=0;r<i.length;r++){let s=this.loadMetaState(i[r]);s&&e.addGridSaveMetaFromSave(s)}}static generateMetaState(e){let t={};return t.k=e.gridKey,t.c=e.gridCol,t.r=e.gridRow,t}static loadMetaState(e){return e?new Pt(e.k,e.c,e.r):null}};var yo=class{constructor(){}getNextPurchaseCost(e,t){}calculateBulkPurchaseCost(e,t,i){}calculateMaxAffordable(e,t){return 0}};var ue={purchaseOne:1,purchaseFive:5,purchaseTen:10,purchaseMax:-1};var Tt=class extends Zt{constructor(e,t,i,r,s){super(t,i),this.id=e,this.costCalculator=r,this.maxCount=s,this.singlePurchaseCost=new c(0),this.cost=new c(0),this.countToPurchase=ue.purchaseOne,this.countToPurchaseUsedInCalculation=ue.purchaseOne,this.maxAffordableCount=0,this.nextActualPurchaseCount=0,this.workingCost=new c(0)}initializeCosts(){this.calculateCostsAfterCountChange()}isVisible(){return!0}isMaxCountReached(){let e=this.getMaxPurchaseCount();return e>0&&this.purchasedCount>=e}getMaxPurchaseCount(){return this.maxCount}getPurchasedCount(){return this.purchasedCount}setPurchasedCount(e){this.purchasedCount=this.maxCount>0?Math.min(this.maxCount,e):e,this.calculateCostsAfterCountChange()}setPurchasedCountFromSave(e){this.setPurchasedCount(e),this.onUpgradePurchased(0,this.purchasedCount)}getSinglePurchaseCost(){return this.singlePurchaseCost}getCostForActualCount(e,t){return e<=0?(t.setZero(),t):e===1?(t.copy(this.singlePurchaseCost),t):this.costCalculator.calculateBulkPurchaseCost(this.singlePurchaseCost,e,t)}getPurchaseCountNumber(){return this.getActualCountToPurchase(this.getCountToPurchaseSetting())}getActualCountToPurchase(e){if(e===ue.purchaseMax)return this.maxAffordableCount;{let t=this.getMaxPurchaseCount();if(t>0){let i=this.getPurchasedCount();return i+e<=t?e:t-i}else return e}}purchaseAmount(e){return this.purchaseActualAmount(this.getActualCountToPurchase(e))}purchaseActualAmount(e){let t=this.getMaxPurchaseCount(),i=this.getPurchasedCount();if(t>0&&i>=t)return!1;t>0&&e+i>t&&(e=t-i);let r=this.getCostForActualCount(e,this.workingCost);return r.lessThanEqualsZero()||r.greaterThan(this.getMoney())?!1:(this.decrementMoney(r),this.onUpgradePurchased(i,e),this.setPurchasedCount(i+e),!0)}calculateCostsAfterCountChange(){this.costCalculator.getNextPurchaseCost(this.getPurchasedCount(),this.singlePurchaseCost);let e=this.getCountToPurchaseSetting();e===ue.purchaseMax?(this.recalculateMaxPurchaseCount(),this.nextActualPurchaseCount=this.maxAffordableCount):(this.nextActualPurchaseCount=this.getActualCountToPurchase(e),this.cost=this.getCostForActualCount(this.nextActualPurchaseCount,this.cost))}recalculateMaxPurchaseCount(){let e=this.getMoney();if(this.maxAffordableCount=this.costCalculator.calculateMaxAffordable(e,this.singlePurchaseCost),this.maxAffordableCount>0){let t=this.getPurchasedCount(),i=this.getMaxPurchaseCount();if(i>0&&t+this.maxAffordableCount>i&&(this.maxAffordableCount=Math.max(0,i-t),this.maxAffordableCount===0)){this.cost.copy(this.singlePurchaseCost);return}this.cost=this.costCalculator.calculateBulkPurchaseCost(this.singlePurchaseCost,this.maxAffordableCount,this.cost)}else this.cost.copy(this.singlePurchaseCost)}getCountToPurchaseSetting(){return this.countToPurchase}getMoney(){}decrementMoney(e){}onUpgradePurchased(e,t){}isPurchasable(){return this.isAffordable()&&!this.isMaxCountReached()}isAffordable(){return this.cost.lessThanEquals(this.getMoney())}getCost(){let e=this.getCountToPurchaseSetting();return this.countToPurchaseUsedInCalculation!==e?(this.countToPurchaseUsedInCalculation=e,this.calculateCostsAfterCountChange()):e===ue.purchaseMax&&this.calculateCostsAfterCountChange(),this.cost}purchase(){return this.purchaseAmount(this.getCountToPurchaseSetting())}resetUpgrade(){super.resetUpgrade(),this.calculateCostsAfterCountChange()}};var ni=class extends qt{constructor(){super(),this.countToPurchase=ue.purchaseOne}setCountToPurchase(e){if(this.countToPurchase!==e){this.countToPurchase=e;for(let t=0;t<this.upgrades.length;t++)this.upgrades[t].countToPurchase=e}}initializeUpgrades(e,t,i){}findById(e){for(let t=0;t<this.upgrades.length;t++){let i=this.upgrades[t];if(i.id===e)return i}return null}resetFull(){for(let e=0;e<this.upgrades.length;e++)this.upgrades[e].resetUpgrade()}};var we=class extends yo{constructor(e,t){super(),this.baseCost=e,this.costGrowthRate=new c(t),this.working=new c(0),this.working2=new c(0),this.one=new c(1),this.logCostFactor=Math.log(t)}getNextPurchaseCost(e,t){t.copy(this.costGrowthRate).pow(e).multiply(this.baseCost).floor()}calculateBulkPurchaseCost(e,t,i){return this.working.copy(this.costGrowthRate),this.working.pow(t).sub(this.one),this.working2.copy(this.costGrowthRate),this.working2.sub(this.one),this.working.divide(this.working2),i.copy(e).multiply(this.working).floor(),i}calculateMaxAffordable(e,t){return t.greaterThan(e)?0:(this.working.copy(this.costGrowthRate).sub(this.one),this.working.multiply(e).divide(t),this.working.add(this.one),this.working.ln()/this.logCostFactor|0)}};var Bi={FREE:"free",ORE:"Ore",GOLD:"Gold",SILVER:"Silver",PRESTIGE:"Prestige"};var Vi=class extends Tt{constructor(e,t,i,r,s,o,a,h,u,m,g,_){super(e,t,i,r,g),this.totals=s,this.mineDamageLogic=o,this.upgradeBonusValue=a,this.valuePerUpgrade=h,this.dependentUpgrade=u,this.requiredPurchaseCount=m,this.workingValue=new c(0),this.additiveUpgrade=_,this.initializeCosts()}isVisible(){return!(this.purchasedCount>=this.maxCount||this.dependentUpgrade&&this.dependentUpgrade.purchasedCount<this.requiredPurchaseCount)}getCostUnit(){return Bi.ORE}getMoney(){return this.totals.ore}decrementMoney(e){this.totals.decrementOre(e)}onUpgradePurchased(e,t){this.workingValue.copy(this.valuePerUpgrade),t>1&&this.workingValue.mulNumber(t),this.upgradeBonusValue.incrementValue(this.workingValue),this.mineDamageLogic.calculateTotalMineDamagePerTurn()}};var bo=class extends ni{constructor(e,t,i){super(),this.initializeUpgrades(e,t,i)}initializeUpgrades(e,t,i){let r=null;for(let s=0;s<100;s++)r=this.generateBaseDamageUpgrade(s,e,t,i,r);r=null;for(let s=1;s<100;s++)r=this.generateMultiplicativeUpgrade(s,e,t,i,r);this.addBulkCompleted()}generateMultiplicativeUpgrade(e,t,i,r,s){let o=e<10?.1:e<20?.2:e<30?.4:e<40?.6:e<50?.8:e<60?1:e<70?1.5:e<80?2:e<90?3:4,a=new c(o*e),h=this.createCostCalculator(e),u="Multiplier: +"+L.formatBigNum(a),m=new Vi("m"+e,u,b.pick,h,t,r,i.baseMultiplicativeBonusValue,a,s,20,150,!1);return this.addBulk(m),m}generateBaseDamageUpgrade(e,t,i,r,s){let h=e+.01,u=new c(1.35);u.pow(h*2.5);let m=new c(0);m.copy(u),m.mulNumber(n.time.turnsPerSecond);let g=L.formatBigNum(m),_=this.createCostCalculator(e+1);console.log("PICK BASE: i="+e+" perTurn="+L.formatBigNum(u)+" perSec="+g);let C=new Vi("add"+e,"Base: +"+g+"/sec",b.pick,_,t,r,i.baseAdditiveBonusPerTurn,u,s,20,150,!0);return this.addBulk(C),C}createCostCalculator(e){let s=Math.max(1,Math.floor(Math.pow(2,e*4.4)));return new we(new c(s),1.1)}resetForPrestige(){this.resetFull()}};var Ui=class{constructor(){}static generateSave(e){let t={};t.upgrades=[];for(let i=0;i<e.upgrades.length;i++){let r=this.generateUpgradeSave(e.upgrades[i]);r&&t.upgrades.push(r)}return t.countToPurchase=e.countToPurchase,t}static loadSave(e,t){if(!t){console.log("PickUpgradeCollectionSave.loadSave no save state");return}if(!t.upgrades){console.log("PickUpgradeCollectionSave.loadSave state empty");return}for(let s=0;s<t.upgrades.length;s++)this.loadUpgradeSave(e,t.upgrades[s]);let r=t.countToPurchase;r&&e.setCountToPurchase(r)}static generateUpgradeSave(e){if(e.purchasedCount===0)return null;let t={};return t.id=e.id,t.c=e.purchasedCount,t}static loadUpgradeSave(e,t){if(!t)return;let i=t.id,r=e.findById(i);if(!r){console.log("PickUpgradeCollectionSave.loadUpgradeSave() failed to find upgrade id="+i);return}let s=t.c;s!==void 0&&r.setPurchasedCountFromSave(s)}};var yt=class{constructor(){}static generateSave(e){let t={};return t.ore=A.save(e.totalOre),t.gold=A.save(e.totalGold),t.ruby=A.save(e.totalRuby),t.prestige=A.save(e.totalPrestigePoints),t.silver=A.save(e.totalSilver),t.upgradeOre=A.save(e.upgradeOre),t.maxDepth=e.maxDepth,t.turns=e.totalTurns,t.tiles=A.save(e.tilesMined),t.tilesCommon=A.save(e.tilesMinedCommon),t.tilesOre=A.save(e.tilesMinedOre),t.tilesGold=A.save(e.tilesMinedGold),t.tilesSilver=A.save(e.tilesMinedSilver),t.tilesRuby=A.save(e.tilesMinedRuby),t.tilesUpgrade=A.save(e.tilesMinedUpgrade),t.tilesLaser=A.save(e.tilesMinedLaser),t.tilesDrill=A.save(e.tilesMinedDrill),t.tilesOrbit=A.save(e.tilesMinedOrbit),t.tilesMissile=A.save(e.tilesMinedMissile),t}static loadSave(e,t){t&&(A.load(t.ore,e.totalOre),A.load(t.gold,e.totalGold),A.load(t.ruby,e.totalRuby),A.load(t.silver,e.totalSilver),A.load(t.prestige,e.totalPrestigePoints),A.load(t.upgradeOre,e.upgradeOre),t.maxDepth&&(e.maxDepth=t.maxDepth),t.turns&&(e.totalTurns=t.turns),A.load(t.tiles,e.tilesMined),A.load(t.tilesCommon,e.tilesMinedCommon),A.load(t.tilesOre,e.tilesMinedOre),A.load(t.tilesGold,e.tilesMinedGold),A.load(t.tilesSilver,e.tilesMinedSilver),A.load(t.tilesRuby,e.tilesMinedRuby),A.load(t.tilesUpgrade,e.tilesMinedUpgrade),A.load(t.tilesLaser,e.tilesMinedLaser),A.load(t.tilesDrill,e.tilesMinedDrill),A.load(t.tilesOrbit,e.tilesMinedOrbit),A.load(t.tilesMissile,e.tilesMinedMissile))}};var Io=class{constructor(e,t){this.durationUpgrades=e,this.coolDownUpgrades=t,this.skillActive=!1,this.startTurn=0}initialize(e,t){this.skillActive=!1,this.startTurn=e-Se.getSkillCoolDownTurns(this.coolDownUpgrades)+t}updateForTurn(e){let t=e-this.startTurn;this.skillActive?this.skillActive=t<Se.getSkillActivationTurns(this.durationUpgrades):t>Se.getSkillCoolDownTurns(this.coolDownUpgrades)&&(this.startTurn=e,this.skillActive=!0)}isSkillActive(){return this.skillActive}};var Oo=class{constructor(e,t,i){this.groupOffset=e,this.durationUpgrades=t,this.coolDownUpgrades=i,this.staggeredTurns=n.time.turnsPerSecond*20,this.activationTimers=[]}setMinerCount(e,t){for(;this.activationTimers.length<t;)this.activationTimers.push(new Io(this.durationUpgrades,this.coolDownUpgrades));this.initializeTimers(e)}initializeTimers(e){let t=0;for(let i=0;i<this.activationTimers.length;i++)this.activationTimers[i].initialize(e,this.groupOffset+t),t+=this.staggeredTurns}updateForTurn(e){for(let t=0;t<this.activationTimers.length;t++)this.activationTimers[t].updateForTurn(e)}isSkillActive(e){return this.activationTimers[e].isSkillActive()}resetForPrestige(){this.initializeTimers(0)}};var et=class{constructor(){this.screenCoordinate=new P(0,0)}renderSkill(e,t){}renderSprite(e,t,i,r){if(!i)return;let s=i.getSize(),o=n.tile.size*t.zoom;e.drawImage(i.getImage(),i.spriteX,i.spriteY,s,s,r.x,r.y,o,o)}};var xo=class extends F{constructor(){super()}onUpgradePurchased(e){}};var Do=class extends Tt{constructor(e,t,i,r,s,o){super(e,t,i,r,s),this.totals=o,this.initializeCosts()}getCostUnit(){return Bi.SILVER}getMoney(){return this.totals.silver}decrementMoney(e){this.totals.decrementSilver(e)}};var le=class extends Do{constructor(e,t,i,r,s,o,a,h,u,m){super(e,t,r,s,o,a),this.description=i,this.purchaseListener=m,this.requiredPurchaseCount=u,this.dependentSkillUpgrade=h,this.initializeCosts()}getDescription(){return this.description}onUpgradePurchased(e,t){super.onUpgradePurchased(e,t),this.purchaseListener.onUpgradePurchased(this.cost)}isVisible(){return!(this.isMaxCountReached()&&!this.isVisibleWhenMaxed()||this.dependentSkillUpgrade&&this.dependentSkillUpgrade.purchasedCount<this.requiredPurchaseCount)}isVisibleWhenMaxed(){return!0}isPurchasable(){return this.isVisible()&&super.isPurchasable()}};var Ie=class extends xo{constructor(e,t,i,r){super(),this.id=e,this.id=e,this.title=t,this.description=i,this.spriteFileName=r,this.upgrades=[],this.unlocked=!1,this.durationUpgrades=new q(null,0),this.coolDownUpgrades=new q(null,0),this.pointsSpent=new c(0),this.collapsed=!1,this.purchaseable=!1}createMinerCostCalculator(){return new we(new c(50),10)}createLimitedAttributeCostCalculator(){return new we(new c(250),1.6)}createCoolDurationCostCalculator(){return new we(new c(150),1.13)}createMiscCostCalculator1(){return new we(new c(250),1.1)}createMiscCostCalculator2(){return new we(new c(8e3),1.08)}createDamageCostCalculator2(){return new we(new c(340),1.1)}createDamageCostCalculator3(){return new we(new c(3e3),1.1)}createDamageCostCalculator4(){return new we(new c(4e3),1.1)}createAutomationUnlockCostCalculator(){return new we(new c(2e3),1)}addNode(e){return this.upgrades.push(e),e}isUnlocked(){return this.unlocked}getRenderer(){return null}updatePurchasable(){this.purchaseable=!1;for(let e=0;e<this.upgrades.length;e++)if(this.upgrades[e].isPurchasable()){this.purchaseable=!0;return}}updateSkillForFrame(e,t,i){}getSkillUpgradeById(e){for(let t=0;t<this.upgrades.length;t++){let i=this.upgrades[t];if(e===i.id)return i}return null}onUpgradePurchased(e){this.unlocked=!0,this.pointsSpent.add(e)}resetFull(){this.unlocked=!1,this.pointsSpent.setZero(),this.collapsed=!1;for(let e=0;e<this.upgrades.length;e++)this.upgrades[e].resetUpgrade();this.coolDownUpgrades.reset(),this.durationUpgrades.reset()}resetForPrestige(){}};var vo=class{constructor(e,t,i){this.gameTime=e,this.skillType=t,this.miners=[],this.skillActivationTracker=new Oo(i,t.durationUpgrades,t.coolDownUpgrades)}addMiner(e){this.miners.push(e),this.skillActivationTracker.setMinerCount(this.gameTime.turnNumber,this.miners.length)}updateSkillsForTurn(e){this.skillActivationTracker.updateForTurn(e)}updateSkillsForFrame(e){for(let t=0;t<this.miners.length;t++)this.skillType.updateSkillForFrame(this.miners[t],e,this.skillActivationTracker.isSkillActive(t))}resetForPrestige(){this.skillActivationTracker.resetForPrestige()}};var Ae=class{constructor(){}static projectPosition(e,t,i,r){return r.copy(e),r.x+=Math.cos(i)*t,r.y+=Math.sin(i)*t,r}static findClosestTileInRange(e,t,i){if(t.length===0)return null;let r=null,s=1e4;for(let o=0;o<t.length;o++){let a=t[o];if(!a||a.open)continue;let h=e.distanceSquared(a.origin);h>i||(!r||h<s)&&(r=a,s=h)}return r}static findClosestTile(e,t){if(t.length===0)return null;let i=null,r=1e4;for(let s=0;s<t.length;s++){let o=t[s];if(!o||o.open)continue;let a=e.distanceSquared(o.origin);(!i||a<r)&&(i=o,r=a)}return i}};var Go=class{constructor(e,t,i){this.worldGrid=e,this.tileMinedLogic=t,this.missiles=i,this.active=!1,this.startPosition=new P(0,0),this.position=new P(0,0),this.movementUnitVector=new P(0,0),this.movementVector=new P(0,0),this.tile=null,this.spriteDirection=0,this.distance=0,this.missileDamage=new c(0)}resetMissile(){this.active=!1,this.tile=null,this.distance=0}onMissileFire(e,t,i){this.resetMissile(),this.startPosition.copy(e),this.startPosition.addXY(n.tile.halfSize,n.tile.halfSize);let r=this.applyRandom(t);this.spriteDirection=i,this.active=!0,Ae.projectPosition(this.startPosition,n.tile.size,r,this.position),this.tileMinedLogic.calculateMissileDamage(this.missileDamage),this.movementUnitVector.copy(this.position),this.movementUnitVector.subtract(this.startPosition),U.nor(this.movementUnitVector)}applyRandom(e){let t=Math.PI/16*Math.random();return Math.random()<.5?e-t:e+t}updateForFrame(e){if(this.movementVector.copy(this.movementUnitVector),this.movementVector.scale(e),this.distance+=e,this.position.add(this.movementVector),this.tile=this.worldGrid.findGridTile(this.position),!this.tile){this.active=!1;return}if(this.tile){this.tile.lighting.everVisibleToCharacter||this.tile.markTileAsCurrentlyVisible();let i=this.tile.open?this.findCollisionTile(this.position,this.tile):this.tile;if(i&&(i.lighting.everVisibleToCharacter||i.markTileAsCurrentlyVisible(),this.tileMinedLogic.missileTile(i,this.missileDamage),i.open&&this.missiles.addExplosion(this.position),this.missileDamage.lessThanEqualsZero())){this.active=!1;return}}let t=20*n.tile.size;if(this.distance>=t){this.active=!1;return}}findCollisionTile(e,t){for(let r=0;r<t.neighbors.length;r++){let s=t.neighbors[r];if(!(!s||s.open)&&s.intersects(e.x,e.y,3))return s}return null}};var zi=class{constructor(){this.position=new P(0,0),this.time=Date.now(),this.active=!1}activate(e){this.position.copy(e),this.time=Date.now(),this.active=!0}deactivate(){this.active=!1}};var Dl=Math.PI*2,ko=class{constructor(e,t,i,r,s){this.worldGrid=e,this.targetList=t,this.values=s,this.missilesUpgrades=i,this.tileMinedLogic=r,this.missileExplosions=new Array(3);for(let o=0;o<this.missileExplosions.length;o++)this.missileExplosions[o]=new zi;this.missiles=[],this.activeMissiles=0,this.lastFireTime=0,this.millisBetweenFires=550,this.skillActive=!1,this.burstActive=!1,this.burstCount=0,this.burstTime=0,this.burstDelay=70,this.radians=0,this.spriteDirection=0}onSkillActivation(){this.skillActive=!0;let e=Date.now();this.burstActive=!1,this.burstTime=e-this.burstDelay,this.activeMissiles=0,this.lastFireTime=e-this.millisBetweenFires;for(let t=0;t<this.missileExplosions.length;t++)this.missileExplosions[t].deactivate();for(let t=0;t<this.missiles.length;t++)this.missiles[t].resetMissile()}onSkillDeactivation(){this.skillActive=!1;for(let e=0;e<this.missileExplosions.length;e++)this.missileExplosions[e].deactivate();this.burstActive=!1,this.activeMissiles=0}updateForFrame(e,t){if(!e.position.tile)return;let i=Date.now();if(!this.burstActive&&this.activeMissiles===0&&i-this.lastFireTime>this.millisBetweenFires&&(this.burstActive=!0,this.burstCount=0,this.burstTime=i-this.burstDelay,this.chooseBestFireDirection(e)),this.burstActive){let r=Se.getMissileCount(this.missilesUpgrades);for(;this.missiles.length<r;)this.missiles.push(new Go(this.worldGrid,this.tileMinedLogic,this));if(i-this.burstTime>=this.burstDelay){this.burstTime=i;let s=this.missiles[this.burstCount];this.burstCount++,s.onMissileFire(e.position.worldCoordinateOrigin,this.radians,this.spriteDirection),this.activeMissiles++}this.burstCount>=r&&(this.burstActive=!1)}if(this.activeMissiles>0){let r=this.getMissileMovementPerFrame(t);this.activeMissiles=0;for(let s=0;s<this.missiles.length;s++){let o=this.missiles[s];!o||!o.active||(o.updateForFrame(r),o.active&&this.activeMissiles++)}this.activeMissiles===0&&(this.lastFireTime=i)}}getMissileMovementPerFrame(e){return 6*e}addExplosion(e){let t=this.findAvailableExplosion();if(!t){console.log("Missiles.addExplosion() failed to find available explosion.");return}t.activate(e)}findAvailableExplosion(){let e=Se.getMissileCount(this.missilesUpgrades);if(this.missileExplosions.length<e){for(let i=0;i<this.missileExplosions.length;i++){let r=this.missileExplosions[i];if(!r.active)return r}let t=new zi;return this.missileExplosions.push(t),t}else{let t=null,i=0;for(let r=0;r<this.missileExplosions.length;r++){let s=this.missileExplosions[r];if(!s.active)return s;(!t||s.time<i)&&(t=s,i=s.time)}return t}}chooseBestFireDirection(e){let t=this.chooseTargetTile(e);t&&t!==e.position.tile?(this.radians=this.calculateAngle(e.position.worldCoordinateOrigin,t.origin),this.spriteDirection=this.calculateSpriteDirection(this.radians)):this.chooseRandomDirection()}calculateAngle(e,t){return this.clamp(Math.atan2(t.y-e.y,t.x-e.x))}clamp(e){return e<0?e+Dl:e>Dl?e-Dl:e}chooseTargetTile(e){let t=e.position.worldCoordinateOrigin,i=Ae.findClosestTile(t,this.targetList.priorityMiningCandidates);if(i)return i;let r=e.target.mineTile;if(r)return r;let s=e.target.targetTile;return s||null}calculateSpriteDirection(e){let t=e*180/Math.PI;return t>=337.5||t<22.5?me.EAST:t>=22.5&&t<67.5?me.SOUTH_EAST:t>=67.5&&t<112.5?me.SOUTH:t>=112.5&&t<157.5?me.SOUTH_WEST:t>=157.5&&t<202.5?me.WEST:t>=202.5&&t<247.5?me.NORTH_WEST:t>=247.5&&t<292.5?me.NORTH:t>=292.5&&t<337.5?me.NORTH_EAST:me.NORTH}chooseRandomDirection(){let e=2*Math.PI;switch(de.randomInt(8)){case 0:this.radians=0,this.spriteDirection=me.EAST;break;case 1:this.radians=e*(1/8),this.spriteDirection=me.SOUTH_EAST;break;case 2:this.radians=e*(1/4),this.spriteDirection=me.SOUTH;break;case 3:this.radians=e*(3/8),this.spriteDirection=me.SOUTH_WEST;break;case 4:this.radians=e*(1/2),this.spriteDirection=me.WEST;break;case 5:this.radians=e*(5/8),this.spriteDirection=me.NORTH_WEST;break;case 6:this.radians=e*(3/4),this.spriteDirection=me.NORTH;break;case 7:this.radians=e*(7/8),this.spriteDirection=me.NORTH_EAST;break}}};var Fo=class extends et{constructor(e,t){super(),this.missilesArray=e,this.spellFxSpritesheet=t,this.missilesSkillAnimation=null,this.skillStart=0,this.missilesExplosionAnimation=null}renderSkill(e,t){if(this.missilesArray.length===0)return;let i=Date.now();i-this.skillStart>1e5&&(this.skillStart=i),this.missilesSkillAnimation||(this.missilesSkillAnimation=this.spellFxSpritesheet.getSpriteAnimation(O.MISSILE_EFFECT_NAME_FAT_ARROW),this.missilesExplosionAnimation=this.spellFxSpritesheet.getSpriteAnimation(O.DAMAGE_EFFECT_NAME_BLUE_DAMAGE));let r=e.lineWidth;e.lineWidth=4,e.strokeStyle="#FFA1";for(let s=0;s<this.missilesArray.length;s++)this.renderMissiles(e,t,this.missilesArray[s]);e.lineWidth=r}renderMissiles(e,t,i){if(!i.skillActive)return;let r=i.missiles;for(let a=0;a<r.length;a++){let h=r[a];if(!h||!h.active)continue;let u=h.startPosition,m=h.position;e.beginPath(),t.worldToScreen(u,this.screenCoordinate),e.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),this.screenCoordinate.copy(m),t.worldToScreen(this.screenCoordinate,this.screenCoordinate),e.lineTo(this.screenCoordinate.x,this.screenCoordinate.y),e.stroke(),this.screenCoordinate.copy(m),this.screenCoordinate.subtractXY(n.tile.halfSize,n.tile.halfSize),t.worldToScreen(this.screenCoordinate,this.screenCoordinate);let g=this.missilesSkillAnimation.getDirectionSprite(h.spriteDirection);this.renderSprite(e,t,g,this.screenCoordinate)}let s=Date.now(),o=i.missileExplosions;for(let a=0;a<o.length;a++){let h=o[a];if(!h.active)continue;let u=this.missilesExplosionAnimation.getSlowCurrentSpriteAsOfNoLooping(s,h.time);if(!u){h.deactivate();continue}this.screenCoordinate.copy(h.position),this.screenCoordinate.subtractXY(n.tile.halfSize,n.tile.halfSize),t.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.renderSprite(e,t,u,this.screenCoordinate)}}};var Ne={MISSILE:"missile",LASER:"laser",DRILL:"drill",ORBIT:"orbit",DAMAGE:"damage",MISC:"misc",ORE_BONUS:"oreBonus",UPGRADE_BONUS_MULTIPLICATIVE:"upgradeBonusMult",UPGRADE_BONUS_ADDITIVE:"upgradeBonusAdd",PRESTIGE_BONUS:"prestigeBonus",POINTS_BONUS:"pointsBonus",RUBY_BONUS:"rubyBonus",BLOCKS_BONUS:"blocksBonus",DEPTH_BONUS:"depthBonus",OFFLINE_BONUS:"offlineBonus",FALL_BONUS:"fallBonus",MINED_AUTOMATION:"minedAutomation",PICK_AUTOMATION:"pickAutomation",PRESTIGE_AUTOMATION:"prestigeAutomation"};var tt=class extends le{constructor(e,t,i,r,s,o,a,h,u,m,g,_){super(e,t,i,r,s,o,a,h,u,m),this.crew=g,this.skillId=_}onUpgradePurchased(e,t){super.onUpgradePurchased(e,t);for(let i=0;i<t;i++)this.crew.addNewMinerNearMain(this.skillId)}};var Pe=class extends le{constructor(e,t,i,r,s,o,a,h,u,m,g,_){super(e,t,i,r,s,o,a,h,u,m),this.valuePerSkillLevel=g,this.numberValue=_}onUpgradePurchased(e,t){super.onUpgradePurchased(e,t);let i=e+t,r=this.numberValue.initialValue+this.valuePerSkillLevel*i;this.numberValue.setValue(r)}};var Bo=class extends Pe{constructor(e,t,i,r,s,o,a,h,u,m){super(e,"Missiles + "+n.skill.missiles.missilesPerUpgrade,null,t,i,r,s,o,a,h,u,m)}getDescription(){return"Missiles: "+Se.getMissileCount(this.numberValue)}};var it=class extends Pe{constructor(e,t,i,r,s,o,a,h,u,m){super(e,"Cool Down - "+n.skill.common.coolDownSecondsPerUpgrade+" sec",null,t,i,r,s,o,a,h,u,m)}getDescription(){return Se.getSkillCoolDownSeconds(this.numberValue)+" seconds"}};var rt=class extends Pe{constructor(e,t,i,r,s,o,a,h,u,m){super(e,"Duration + "+n.skill.common.activationSecondsPerUpgrade+" sec",null,t,i,r,s,o,a,h,u,m)}getDescription(){return Se.getSkillActivationSeconds(this.numberValue)+" seconds"}};var Vo=class extends Ie{constructor(e,t,i,r,s,o,a){super(Ne.MISSILE,"Missile Miner","Fire volleys of missiles",b.skill.missiles),this.worldGrid=e,this.tileMinedLogic=i,this.targetList=s,this.values=o,this.missilesUpgrades=new q(null,0),this.missilesArray=[],this.missilesByCharacter={},this.renderer=new Fo(this.missilesArray,a);let h=this.createMinerCostCalculator(),u=this.createLimitedAttributeCostCalculator(),m=this.createCoolDurationCostCalculator(),g=this.addNode(new tt("addMissileMiner","+1 Missile Miner","Larger Crew!",b.skill.missiles,h,4,t,null,1,this,r,Ne.MISSILE));this.addNode(new Bo("missileBonus",b.skill.missiles,u,9,t,g,1,this,1,this.missilesUpgrades)),this.addNode(new it("missileCool",b.skill.missiles,m,29,t,g,1,this,1,this.coolDownUpgrades)),this.addNode(new rt("missileDur",b.skill.missiles,m,30,t,g,1,this,1,this.durationUpgrades))}updateSkillForFrame(e,t,i){let r=this.missilesByCharacter[e.id];r||(r=new ko(this.worldGrid,this.targetList,this.missilesUpgrades,this.tileMinedLogic,this.values),this.missilesByCharacter[e.id]=r,this.missilesArray.push(r)),i&&!r.skillActive?r.onSkillActivation():!i&&r.skillActive&&r.onSkillDeactivation(),i&&r.updateForFrame(e,t)}getRenderer(){return this.renderer}resetFull(){super.resetFull(),this.missilesArray.length=0,this.missilesByCharacter={},this.missilesUpgrades.reset()}};var ai=class{constructor(e){this.worldGrid=e,this.startPoint=new P(0,0),this.endPoint=new P(0,0),this.workingPosition=new P(0,0)}getProjectedTile(e,t){return e&&e.contains(t)?e:this.worldGrid.findGridTile(t)}};var Et=1e3,zh=Math.PI/32,Uo=Math.PI*2,ih=Math.PI,zo=class extends ai{constructor(e,t,i,r,s){super(e),this.targetList=i,this.gameTime=t,this.tileMinedLogic=r,this.laserRangeUpgrades=s,this.prevLaserTargetTile=null,this.actualRadians=Et,this.skillActive=!1,this.laserVisible=!1,this.prevTurn=0}onSkillActivation(){this.actualRadians=Et,this.skillActive=!0,this.prevLaserTargetTile=null}onSkillDeactivation(){this.actualRadians=Et,this.skillActive=!1,this.laserVisible=!1,this.prevLaserTargetTile=null}updateForFrame(e,t){if(!e.position.tile){this.laserVisible=!1,this.actualRadians=Et;return}this.startPoint.copy(e.position.worldCoordinateOrigin),this.startPoint.addXY(n.tile.halfSize,n.tile.halfSize);let i=(n.skill.laser.minRange+n.skill.laser.tilesPerUpgrade*this.laserRangeUpgrades.getValue())*n.tile.size,r=this.chooseLaserRadians(e,i,this.startPoint);if(r===Et){this.laserVisible=!1,this.actualRadians=Et;return}this.actualRadians===Et?this.actualRadians=r:this.actualRadians=this.updateRadians(this.actualRadians,r,t);let s=this.findFirstClosedTileOnLine(this.startPoint,this.actualRadians,i);if(!s){this.laserVisible=!1,this.actualRadians=Et;return}s.markTileAsCurrentlyVisible(),this.endPoint.copy(s.origin),this.endPoint.addXY(n.tile.halfSize,n.tile.halfSize),s.open||this.tileMinedLogic.laserTileForFrame(s,t),this.laserVisible=!0}updateRadians(e,t,i){let r=zh*i,s=this.getRadiansPositiveDirection(e,t),o=this.getRadiansNegativeDirection(e,t);return s<o?s<r||s>=ih?t:this.clamp(e+r):o<r||o>=ih?t:this.clamp(e-r)}clamp(e){return e<0?e+Uo:e>Uo?e-Uo:e}getRadiansPositiveDirection(e,t){return t<e?Uo-e+t:t-e}getRadiansNegativeDirection(e,t){return t<e?e-t:Uo-t+e}chooseLaserRadians(e,t,i){let r=this.chooseLaserTargetTile(e,t);return r?(this.workingPosition.copy(r.origin),this.workingPosition.addXY(n.tile.halfSize,n.tile.halfSize),this.calculateAngle(i,this.workingPosition)):Et}chooseLaserTargetTile(e,t){let i=t*t,r=e.position.worldCoordinateOrigin,s=Ae.findClosestTileInRange(r,this.targetList.priorityMiningCandidates,i);if(s)return this.prevLaserTargetTile=s,s;let o=Ae.findClosestTileInRange(r,this.targetList.commonMiningCandidates,i);if(o)return this.prevLaserTargetTile=o,o;let a=e.target.mineTile;if(a&&this.isTileInLaserRange(r,a,i))return this.prevLaserTargetTile=a,a;let h=e.target.targetTile;return h&&e.position.tile!==h&&this.isTileInLaserRange(r,h,i)?(this.prevLaserTargetTile=h,h):this.prevLaserTargetTile&&!this.prevLaserTargetTile.open&&this.isTileInLaserRange(r,this.prevLaserTargetTile,i)?this.prevLaserTargetTile:(this.prevLaserTargetTile=null,null)}isTileInLaserRange(e,t,i){return e.distanceSquared(t.origin)<=i}findFirstClosedTileOnLine(e,t,i){let r=null;for(let s=n.tile.halfSize;s<=i;s+=n.tile.halfSize){let o=Ae.projectPosition(e,s,t,this.workingPosition),a=this.getProjectedTile(r,o);if(!a)break;if(r!==a){if(a.lighting.everVisibleToCharacter||a.markTileAsCurrentlyVisible(),!a.open)return a;r=a}}return r}calculateAngle(e,t){return this.clamp(Math.atan2(t.y-e.y,t.x-e.x))}};var Ho=class extends et{constructor(e,t){super(),this.laserArray=e,this.spellFxSpritesheet=t,this.skillAnimation=null,this.skillStart=Date.now()}renderSkill(e,t){if(this.laserArray.length!==0)for(let i=0;i<this.laserArray.length;i++)this.renderLaser(e,t,this.laserArray[i])}renderLaser(e,t,i){if(!i.laserVisible)return;let r=Date.now();r-this.skillStart>1e5&&(this.skillStart=r),this.skillAnimation||(this.skillAnimation=this.spellFxSpritesheet.getSpriteAnimation(O.EFFECT_NAME_SPARKLE_RED));let s=i.startPoint,o=i.endPoint,a=e.lineWidth;if(e.lineWidth=5,e.strokeStyle="#F00",e.beginPath(),t.worldToScreen(s,this.screenCoordinate),e.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),t.worldToScreen(o,this.screenCoordinate),e.lineTo(this.screenCoordinate.x,this.screenCoordinate.y),e.stroke(),e.lineWidth=1,e.strokeStyle="#FFF",e.beginPath(),t.worldToScreen(s,this.screenCoordinate),e.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),t.worldToScreen(o,this.screenCoordinate),e.lineTo(this.screenCoordinate.x,this.screenCoordinate.y),e.stroke(),e.lineWidth=a,t.isVisible(o,n.tile.size)){this.screenCoordinate.copy(o),this.screenCoordinate.x-=n.tile.halfSize,this.screenCoordinate.y-=n.tile.halfSize,t.worldToScreen(this.screenCoordinate,this.screenCoordinate);let h=this.skillAnimation.getSpriteAsOf(Date.now(),this.skillStart);this.renderSprite(e,t,h,this.screenCoordinate)}}};var li=class extends Pe{constructor(e,t,i,r,s,o,a,h,u,m,g){super(e,"+"+u+" Tile",null,t,i,r,s,o,a,h,u,m),this.minRange=g}getDescription(){return"Range: "+(this.minRange+this.valuePerSkillLevel*this.numberValue.getValue())+" Tiles"}};var Wo=class extends Ie{constructor(e,t,i,r,s,o,a){super(Ne.LASER,"Laser Miner","Blasts stone with a laser",b.skill.laser),this.worldGrid=e,this.tileMinedLogic=i,this.totals=t,this.crew=r,this.gameTime=s,this.targetList=a,this.laserRangeUpgrades=new q(null,0),this.laserArray=[],this.laserByCharacter={},this.renderer=new Ho(this.laserArray,o);let h=this.createMinerCostCalculator(),u=this.createLimitedAttributeCostCalculator(),m=this.createCoolDurationCostCalculator(),g=this.addNode(new tt("addLaserMiner","+1 Laser Miner","Add Miners!",b.skill.laser,h,4,t,null,1,this,r,Ne.LASER));this.addNode(new li("laserRange",b.skill.laser,u,9,t,g,1,this,n.skill.laser.tilesPerUpgrade,this.laserRangeUpgrades,n.skill.laser.minRange)),this.addNode(new it("laserCool",b.skill.laser,m,29,t,g,1,this,1,this.coolDownUpgrades)),this.addNode(new rt("laserDur",b.skill.laser,m,30,t,g,1,this,1,this.durationUpgrades))}updateSkillForFrame(e,t,i){let r=this.laserByCharacter[e.id];r||(r=new zo(this.worldGrid,this.gameTime,this.targetList,this.tileMinedLogic,this.laserRangeUpgrades),this.laserByCharacter[e.id]=r,this.laserArray.push(r)),i&&!r.skillActive?r.onSkillActivation():!i&&r.skillActive&&r.onSkillDeactivation(),i&&r.updateForFrame(e,t)}getRenderer(){return this.renderer}resetFull(){super.resetFull(),this.laserArray.length=0,this.laserByCharacter={},this.laserRangeUpgrades.reset()}};var Hh=Math.PI/2,Yo=class extends ai{constructor(e,t,i){super(e),this.tileMinedLogic=t,this.depthUpgradeCount=i,this.drillTile=null,this.goalTile=null,this.skillActive=!1}onSkillActivation(){this.skillActive=!0}onSkillDeactivation(){this.skillActive=!1,this.drillTile=null}updateForFrame(e,t){this.startPoint.copy(e.position.worldCoordinateOrigin),this.startPoint.addXY(n.tile.halfSize,n.tile.halfSize);let i=(n.skill.drill.minRange+n.skill.drill.tilesPerUpgrade*this.depthUpgradeCount.getValue())*n.tile.size;if(this.workingPosition.copy(this.startPoint),this.workingPosition.y+=i,this.goalTile=this.worldGrid.findGridTile(this.workingPosition),this.drillTile=this.goalTile,!!this.goalTile){if(this.drillTile=this.findFirstClosedTileOnLine(this.startPoint,Hh,i),!this.drillTile){this.endPoint.copy(this.goalTile.origin),this.endPoint.x=this.startPoint.x,this.endPoint.y+=n.tile.halfSize;return}this.drillTile.markTileAsCurrentlyVisible(),this.endPoint.copy(this.drillTile.origin),this.endPoint.x=this.startPoint.x,this.endPoint.y+=n.tile.halfSize,this.drillTile.open||this.tileMinedLogic.drillTileForFrame(this.drillTile,t)}}findFirstClosedTileOnLine(e,t,i){let r=null;for(let s=n.tile.halfSize;s<=i;s+=n.tile.halfSize){let o=Ae.projectPosition(e,s,t,this.workingPosition),a=this.getProjectedTile(r,o);if(!a)break;if(r!==a){if(a.lighting.everVisibleToCharacter||a.markTileAsCurrentlyVisible(),!a.open)return a;r=a}}return r&&!r.open?r:null}};var Ko=class extends et{constructor(e,t){super(),this.drillArray=e,this.spellFxSpritesheet=t,this.skillAnimation=null,this.skillStart=Date.now()}renderSkill(e,t){if(this.drillArray.length!==0)for(let i=0;i<this.drillArray.length;i++)this.renderDrill(e,t,this.drillArray[i])}renderDrill(e,t,i){if(!i.skillActive||!i.goalTile)return;let r=Date.now();r-this.skillStart>1e5&&(this.skillStart=r),this.skillAnimation||(this.skillAnimation=this.spellFxSpritesheet.getSpriteAnimation(O.EFFECT_NAME_SPARKLE_BLUE));let s=i.startPoint,o=i.endPoint,a=e.lineWidth;if(e.lineWidth=5,e.strokeStyle="#00F",e.beginPath(),t.worldToScreen(s,this.screenCoordinate),e.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),t.worldToScreen(o,this.screenCoordinate),e.lineTo(this.screenCoordinate.x,this.screenCoordinate.y),e.stroke(),e.lineWidth=1,e.strokeStyle="#FFF",e.beginPath(),t.worldToScreen(s,this.screenCoordinate),e.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),t.worldToScreen(o,this.screenCoordinate),e.lineTo(this.screenCoordinate.x,this.screenCoordinate.y),e.stroke(),e.lineWidth=a,t.isVisible(o,n.tile.size)){this.screenCoordinate.copy(o),this.screenCoordinate.x-=n.tile.halfSize,this.screenCoordinate.y-=n.tile.halfSize,t.worldToScreen(this.screenCoordinate,this.screenCoordinate);let h=this.skillAnimation.getSpriteAsOf(Date.now(),this.skillStart);this.renderSprite(e,t,h,this.screenCoordinate)}}};var Xo=class extends Ie{constructor(e,t,i,r,s){super(Ne.DRILL,"Drill Miner","Drills straight down",b.skill.drill),this.worldGrid=e,this.tileMinedLogic=i,this.totals=t,this.crew=r,this.drillArray=[],this.drillByCharacter={},this.depthUpgrades=new q(null,0),this.renderer=new Ko(this.drillArray,s);let o=this.createMinerCostCalculator(),a=this.createLimitedAttributeCostCalculator(),h=this.createCoolDurationCostCalculator(),u=this.addNode(new tt("addDrillMiner","+1 Drill Miner","Add to your crew",b.skill.drill,o,4,t,null,1,this,r,Ne.DRILL));this.addNode(new li("drillRange",b.skill.drill,a,9,t,u,1,this,n.skill.drill.tilesPerUpgrade,this.depthUpgrades,n.skill.drill.minRange)),this.addNode(new it("drillCool",b.skill.drill,h,29,t,u,1,this,1,this.coolDownUpgrades)),this.addNode(new rt("drillDur",b.skill.drill,h,30,t,u,1,this,1,this.durationUpgrades))}updateSkillForFrame(e,t,i){let r=this.drillByCharacter[e.id];r||(r=new Yo(this.worldGrid,this.tileMinedLogic,this.depthUpgrades),this.drillByCharacter[e.id]=r,this.drillArray.push(r)),i&&!r.skillActive?r.onSkillActivation():!i&&r.skillActive&&r.onSkillDeactivation(),i&&r.updateForFrame(e,t)}getRenderer(){return this.renderer}resetFull(){super.resetFull(),this.drillArray.length=0,this.drillByCharacter={},this.depthUpgrades.reset()}};var rh=2*Math.PI,Wh=Math.PI/50,jo=class{constructor(e,t,i,r){this.worldGrid=e,this.tileMinedLogic=t,this.character=i,this.center=new P(0,0),this.range=0,this.radians=0,this.endPoint=new P(0,0),this.initialize(r)}onSkillActivation(e){this.initialize(e)}initialize(e){this.center.copy(this.character.position.worldCoordinateOrigin),this.center.addXY(n.tile.halfSize,n.tile.halfSize),this.range=e,Ae.projectPosition(this.center,this.range,this.radians,this.endPoint)}updateForFrame(e){this.center.copy(this.character.position.worldCoordinateOrigin),this.center.addXY(n.tile.halfSize,n.tile.halfSize),this.radians+=e*Wh,this.radians>rh&&(this.radians-=rh),Ae.projectPosition(this.center,this.range,this.radians,this.endPoint);let t=this.worldGrid.findGridTile(this.endPoint);t&&(t.lighting.everVisibleToCharacter||t.markTileAsCurrentlyVisible(),t.open||this.tileMinedLogic.orbitTileForFrame(t,e))}};var Zo=class{constructor(e,t,i,r){this.worldGrid=e,this.orbitRangeUpgrades=t,this.orbMaxUpgrades=i,this.tileMinedLogic=r,this.orbitPairs=[],this.lastPairTime=0,this.orbitIntervalMillis=500,this.skillActive=!1}onSkillActivation(){this.skillActive=!0;let e=n.skill.orbit.minRangePixels+this.orbitRangeUpgrades.getValue()*n.skill.orbit.rangePixelsPerUpgrade;for(let t=0;t<this.orbitPairs.length;t++)this.orbitPairs[t].onSkillActivation(e)}onSkillDeactivation(){this.skillActive=!1}updateForFrame(e,t){let i=n.skill.orbit.minRangePixels+this.orbitRangeUpgrades.getValue()*n.skill.orbit.rangePixelsPerUpgrade,r=!1,s=1+this.orbMaxUpgrades.getValue();for(;this.orbitPairs.length<s;)this.orbitPairs.push(new jo(this.worldGrid,this.tileMinedLogic,e,i)),r=!0;if(r&&this.orbitPairs.length>1){let o=2*Math.PI/this.orbitPairs.length,a=0;for(let h=0;h<this.orbitPairs.length;h++)this.orbitPairs[h].radians=a,a+=o}for(let o=0;o<this.orbitPairs.length;o++)this.orbitPairs[o].range=i,this.orbitPairs[o].updateForFrame(t)}};var qo=class extends et{constructor(e,t){super(),this.orbitArray=e,this.spellFxSpritesheet=t,this.skillAnimation=null,this.skillStart=Date.now()}renderSkill(e,t){if(this.orbitArray.length===0)return;let i=e.lineWidth;e.lineWidth=4,e.strokeStyle="#AFA1";for(let r=0;r<this.orbitArray.length;r++)this.renderOrbit(e,t,this.orbitArray[r]);e.lineWidth=i}renderOrbit(e,t,i){if(!i.skillActive)return;let r=Date.now();r-this.skillStart>1e5&&(this.skillStart=r),this.skillAnimation||(this.skillAnimation=this.spellFxSpritesheet.getSpriteAnimation(O.EFFECT_NAME_ORANGE_STAR));let s=i.orbitPairs;for(let o=0;o<s.length;o++){let a=s[o];e.beginPath(),t.worldToScreen(a.center,this.screenCoordinate),e.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),this.screenCoordinate.copy(a.endPoint),this.screenCoordinate.addXY(n.tile.halfSize,n.tile.halfSize),t.worldToScreen(this.screenCoordinate,this.screenCoordinate),e.lineTo(this.screenCoordinate.x,this.screenCoordinate.y),e.stroke(),this.screenCoordinate.copy(a.endPoint),t.worldToScreen(this.screenCoordinate,this.screenCoordinate);let h=this.skillAnimation.getSpriteAsOf(Date.now(),this.skillStart);this.renderSprite(e,t,h,this.screenCoordinate)}}};var Jo=class extends Ie{constructor(e,t,i,r,s){super(Ne.ORBIT,"Orbit Miner","Inflicts Orbiting Damage",b.skill.orbit),this.worldGrid=e,this.tileMinedLogic=i,this.totals=t,this.crew=r,this.orbMaxUpgrades=new q(null,0),this.orbitRangeUpgrades=new q(null,0),this.orbitArray=[],this.orbitByCharacter={},this.renderer=new qo(this.orbitArray,s);let o=this.createMinerCostCalculator(),a=this.createLimitedAttributeCostCalculator(),h=this.createCoolDurationCostCalculator(),u=this.addNode(new tt("addOrbitMiner","+1 Orbit Miner","More Miners!",b.skill.orbit,o,4,t,null,1,this,r,Ne.ORBIT));this.addNode(new Pe("orbitRange","+1/2 Tile","Tile Range +0.5",b.skill.orbit,a,9,t,u,1,this,1,this.orbitRangeUpgrades)),this.addNode(new Pe("orbitBonus","+1 Orb","More Orbs",b.skill.orbit,a,9,t,u,1,this,1,this.orbMaxUpgrades)),this.addNode(new it("orbitCool",b.skill.orbit,h,29,t,u,1,this,1,this.coolDownUpgrades)),this.addNode(new rt("orbitDur",b.skill.orbit,h,30,t,u,1,this,1,this.durationUpgrades))}updateSkillForFrame(e,t,i){let r=this.orbitByCharacter[e.id];r||(r=new Zo(this.worldGrid,this.orbitRangeUpgrades,this.orbMaxUpgrades,this.tileMinedLogic),this.orbitByCharacter[e.id]=r,this.orbitArray.push(r)),i&&!r.skillActive?r.onSkillActivation():!i&&r.skillActive&&r.onSkillDeactivation(),i&&r.updateForFrame(e,t)}getRenderer(){return this.renderer}resetFull(){super.resetFull(),this.orbitArray.length=0,this.orbitByCharacter={},this.orbMaxUpgrades.reset(),this.orbitRangeUpgrades.reset()}};var Qo=class extends le{constructor(e,t,i,r,s,o,a,h,u,m){super(e,null,null,t,i,r,s,o,a,h),this.values=u,this.mineDamageLogic=m}getTitle(){return"Depth Damage +"+L.formatNumber(n.depth.incrementBonusPerUpgrade*(this.purchasedCount+1))}getDescription(){let e=this.values.skillDepthBonusMultiplier.getValue();return e===0?"Damage: 0":"Damage: "+L.formatNumber(e)}onUpgradePurchased(e,t){super.onUpgradePurchased(e,t);let i=e+t,r=0;for(let s=0;s<i;s++)r+=n.depth.incrementBonusPerUpgrade*(s+1);this.values.skillDepthBonusMultiplier.setValue(r),this.mineDamageLogic.calculateTotalMineDamagePerTurn()}};var $o=class extends le{constructor(e,t,i,r,s,o,a,h,u,m){super(e,null,null,t,i,r,s,o,a,h),this.values=u,this.mineDamageLogic=m}getTitle(){return"Damage / Silver +"+L.formatNumber(n.silver.incrementBonusPerUpgrade*(this.purchasedCount+1))}getDescription(){let e=this.values.skillSilverBonusMultiplier.getValue();return"Damage: "+L.formatNumber(e)}onUpgradePurchased(e,t){super.onUpgradePurchased(e,t);let i=e+t,r=0;for(let s=0;s<i;s++)r+=n.silver.incrementBonusPerUpgrade*(s+1);this.values.skillSilverBonusMultiplier.setValue(r),this.mineDamageLogic.calculateTotalMineDamagePerTurn()}};var en=class extends le{constructor(e,t,i,r,s,o,a,h,u,m){super(e,null,null,t,i,r,s,o,a,h),this.values=u,this.mineDamageLogic=m}isVisible(){return super.isVisible()&&this.totals.ruby.greaterThanZero()}getTitle(){return"Damage / Ruby +"+L.formatNumber(n.ruby.incrementBonusPerUpgrade*(this.purchasedCount+1))}getDescription(){let e=this.values.skillRubyBonusMultiplier.getValue();return"Damage: "+L.formatNumber(e)}onUpgradePurchased(e,t){super.onUpgradePurchased(e,t);let i=e+t,r=0;for(let s=0;s<i;s++)r+=n.ruby.incrementBonusPerUpgrade*(s+1);this.values.skillRubyBonusMultiplier.setValue(r),this.mineDamageLogic.calculateTotalMineDamagePerTurn()}};var tn=class extends le{constructor(e,t,i,r,s,o,a,h,u,m){super(e,null,null,t,i,r,s,o,a,h),this.values=u,this.mineDamageLogic=m}getTitle(){return"Damage / Block +"+L.formatNumber(n.blocks.incrementBonusPerUpgrade*(this.purchasedCount+1))}getDescription(){let e=this.values.skillBlockBonusMultiplier.getValue();return"Damage: "+L.formatNumber(e)}onUpgradePurchased(e,t){super.onUpgradePurchased(e,t);let i=e+t,r=0;for(let s=0;s<i;s++)r+=n.blocks.incrementBonusPerUpgrade*(s+1);this.values.skillBlockBonusMultiplier.setValue(r),this.mineDamageLogic.calculateTotalMineDamagePerTurn()}};var rn=class extends le{constructor(e,t,i,r,s,o,a,h,u){super(e,null,null,t,i,r,s,o,a,h),this.values=u}getTitle(){return"Mined Damage +"+L.formatNumber(n.minedDamage.incrementBonusPerUpgrade*(this.purchasedCount+1))}getDescription(){let e=this.values.skillMinedDamageBonus.getValue();return"Bonus: +"+L.formatNumber(e)}onUpgradePurchased(e,t){super.onUpgradePurchased(e,t);let i=e+t,r=0;for(let s=0;s<i;s++)r+=n.minedDamage.incrementBonusPerUpgrade*(s+1);this.values.skillMinedDamageBonus.setValue(r)}};var sn=class extends Ie{constructor(e,t,i){super(Ne.DAMAGE,"Damage Skills","Upgrade Damage",b.currency.silver),this.values=t;let r=this.createDamageCostCalculator3(),s=this.createDamageCostCalculator4();this.addNode(new Qo("depthBonus",b.currency.depth,r,-1,e,null,0,this,t,i)),this.addNode(new rn("minedDamageBonus",b.currency.depth,r,-1,e,null,0,this,t)),this.addNode(new $o("silverBonus",b.currency.silver,s,-1,e,null,0,this,t,i)),this.addNode(new tn("blocksBonus",b.block,s,-1,e,null,0,this,t,i)),this.addNode(new en("rubyBonus",b.currency.ruby,r,-1,e,null,0,this,t,i))}};var Ue=class{constructor(){}static formatElapsedTime(e){if(e<0)return"Error: negative time";let t=e/36e5|0,i=e/6e4%60|0,r=e/1e3%60|0;return(t<10?"0":"")+t+":"+(i<10?"0":"")+i+":"+(r<10?"0":"")+r}static formatElapsedTimeNoHours(e){if(e<0)return"Error: negative time";let t=e/36e5|0,i=e/6e4%60|0,r=e/1e3%60|0;return t>0?(t<10?"0":"")+t+":"+(i<10?"0":"")+i+":"+(r<10?"0":"")+r:(i<10?"0":"")+i+":"+(r<10?"0":"")+r}};var on=class extends le{constructor(e,t,i,r,s,o,a,h,u){super(e,"Offline +"+n.offline.minutesPerUpgrade+" min",null,t,i,r,s,o,a,h),this.values=u,this.displayedMillis=-1,this.description=null}getDescription(){let t=(n.offline.defaultOfflineMinutes+this.values.offlineTimeUpgrades.getValue()*n.offline.minutesPerUpgrade)*60*1e3;return(!this.description||t!=this.displayedMillis)&&(this.displayedMillis=t,this.description="Time: "+Ue.formatElapsedTime(t)),this.description}onUpgradePurchased(e,t){super.onUpgradePurchased(e,t),this.values.offlineTimeUpgrades.incrementValue(t)}};var nn=class extends le{constructor(e,t,i,r,s,o,a,h,u){super(e,null,null,t,i,r,s,o,a,h),this.values=u,this.displayedBonus=new c(-10),this.description=null}getTitle(){return"Ore +"+L.formatNumber(n.skill.bonus.oreBonusMultiplierPerUpgrade*(this.purchasedCount+1))}getDescription(){let e=this.values.skillOreBonusMultiplier.getValue();return(!this.description||!e.equals(this.displayedBonus))&&(this.displayedBonus.copy(e),this.description="Bonus: x"+L.formatBigNum(e)),this.description}onUpgradePurchased(e,t){super.onUpgradePurchased(e,t);let i=e+t,r=1;for(let o=0;o<i;o++)r+=n.skill.bonus.oreBonusMultiplierPerUpgrade*(o+1);this.values.skillOreBonusMultiplier.getValue().setValue(r)}};var an=class extends le{constructor(e,t,i,r,s,o,a,h,u){super(e,t,i,r,s,1,o,a,h,u)}isVisibleWhenMaxed(){return!1}};var ln=class extends an{constructor(e,t,i,r,s,o,a,h,u,m){super(e,t,i,r,s,o,a,h,u),this.unlockValue=m}onUpgradePurchased(e,t){super.onUpgradePurchased(e,t);let i=e+t;this.unlockValue.setValue(i>0)}};var hn=class extends Pe{constructor(e,t,i,r,s,o,a,h,u){super(e,"Auto Purchase Delay -"+n.automation.secondsPerRateUpgrade+"s",null,t,i,r,s,o,a,h,1,u),this.displayedTurns=-1,this.description=null}getDescription(){let e=n.automation.baseUpgradeDelayTurns,t=n.automation.turnsPerRateUpgrade*this.numberValue.getValue(),i=Math.max(n.automation.minDelayTurns,e-t);return(!this.description||i!=this.displayedTurns)&&(this.displayedTurns=i,this.description="Current Delay: "+L.formatNumber(i*n.time.secondsPerTurn)+"s"),this.description}};var dn=class extends le{constructor(e,t,i,r,s,o,a,h,u){super(e,"Silver +1/block",null,t,i,r,s,o,a,h),this.values=u,this.displayedBonus=new c(-10),this.description=null}getDescription(){let e=this.values.silverPerBlockBonus.getValue();return(!this.description||!e.equals(this.displayedBonus))&&(this.displayedBonus.copy(e),this.description="+"+L.formatBigNum(e)+"/block"),this.description}onUpgradePurchased(e,t){super.onUpgradePurchased(e,t),this.values.silverPerBlockBonus.getValue().addNumber(t)}};var un=class extends Ie{constructor(e,t){super(Ne.MISC,"Misc","Upgrades",b.currency.silver),this.values=t;let i=this.createAutomationUnlockCostCalculator(),r=this.createMiscCostCalculator1(),s=this.createMiscCostCalculator2();this.addNode(new on("offlineBonus",b.offline,r,50,e,null,0,this,t)),this.addNode(new nn("oreBonus",b.currency.ore,r,-1,e,null,0,this,t));let o=this.addNode(new ln("pickAutomationUnlock","Auto Purchase","Ore Upgrades",b.currency.ore,i,e,null,0,this,this.values.pickAutomationUnlocked));this.addNode(new hn("pickAutomation",b.currency.ore,r,12,e,o,1,this,t.pickAutomationRateUpgrades)),this.addNode(new dn("silverBonus",b.currency.silver,s,-1,e,null,0,this,t))}};var cn=class extends F{constructor(e,t,i,r,s,o,a,h,u){super(),this.gameTime=e,this.skills=[],this.skillById={},this.skillGroups=[],this.skillGroupMinerCount=-1,this.crew=a,this.addSkill(new Xo(t,i,s,a,u)),this.addSkill(new Jo(t,i,s,a,u)),this.addSkill(new Wo(t,i,s,a,e,u,h)),this.addSkill(new Vo(t,i,s,a,h,r,u)),this.addSkill(new sn(i,r,o)),this.addSkill(new un(i,r))}addSkill(e){this.skills.push(e),this.skillById[e.id]=e}findSkillById(e){return this.skillById[e]}findSkillGroupById(e){for(let t=0;t<this.skillGroups.length;t++){let i=this.skillGroups[t];if(e===i.skillType.id)return i}return null}rebuildSkillGroups(){this.skillGroups.length=0;let e=this.crew.miners,t=0;for(let i=0;i<e.length;i++){let r=e[i],s=r.skillId;if(!s)continue;let o=this.findSkillGroupById(s);if(!o){let a=this.findSkillById(s);if(!a){console.log("SkillTreeGraph.rebuildSkillGroups() Failed to find skill: "+s);continue}o=new vo(this.gameTime,a,t),this.skillGroups.push(o),t+=n.time.turnsPerSecond*5}o.addMiner(r)}}updateSkillsForTurn(){this.assertMinerCountMatchesSkillGroups();let e=this.gameTime.turnNumber;for(let t=0;t<this.skillGroups.length;t++)this.skillGroups[t].updateSkillsForTurn(e);for(let t=0;t<this.skills.length;t++)this.skills[t].updatePurchasable()}updateSkillsForFrame(e){this.assertMinerCountMatchesSkillGroups();for(let t=0;t<this.skillGroups.length;t++)this.skillGroups[t].updateSkillsForFrame(e)}assertMinerCountMatchesSkillGroups(){let e=this.crew.miners;this.skillGroupMinerCount!=e.length&&(this.skillGroupMinerCount=e.length,this.rebuildSkillGroups())}resetFull(){for(let e=0;e<this.skills.length;e++)this.skills[e].resetFull();this.skillGroups.length=0}resetForPrestige(){for(let e=0;e<this.skillGroups.length;e++)this.skillGroups[e].resetForPrestige()}};var Hi=class{constructor(){}static generateSave(e){let t={};t.skills=[];for(let i=0;i<e.skills.length;i++)t.skills.push(this.generateSkillSave(e.skills[i]));return t}static loadSave(e,t){if(!t){console.log("SkillTreeSave.loadSave() No save state. Not loading skills!");return}let i=t.skills;if(!i||i.length===0){console.log("SkillTreeSave.loadSave() No skill save data found");return}for(let r=0;r<i.length;r++)try{this.loadSkillSave(e,i[r])}catch(s){console.error("SkillTreeSave.loadSave() Failed to load skill.",s.message)}}static generateSkillSave(e){let t={};t.id=e.id,t.points=A.save(e.pointsSpent),t.unlocked=e.unlocked,t.collapsed=e.collapsed,t.upgrades=[];for(let i=0;i<e.upgrades.length;i++)t.upgrades.push(this.generateSkillUpgradeSave(e.upgrades[i]));return t}static loadSkillSave(e,t){if(!t)return;let i=t.id;if(!i){console.log("SkillTreeSave.loadSkillSave() No id found for skill.");return}let r=e.findSkillById(i);if(!r){console.log("SkillTreeSave.loadSkillSave() Failed to find skill for id="+i);return}A.load(t.points,r.pointsSpent),r.unlocked=t.unlocked,r.collapsed=t.collapsed;let s=t.upgrades;if(!s||s.length===0){console.log("SkillTreeSave.loadSkillSave() No skill upgrades saved for skill id="+i);return}for(let o=0;o<s.length;o++)this.loadSkillUpgradeSave(r,s[o])}static generateSkillUpgradeSave(e){let t={};return t.id=e.id,t.c=e.purchasedCount,t}static loadSkillUpgradeSave(e,t){if(!t){console.log("SkillTreeSave.loadSkillUpgradeSave() No node save state.");return}let i=t.id;if(!i){console.log("SkillTreeSave.loadSkillUpgradeSave() No id found for skill node.");return}let r=e.getSkillUpgradeById(i);if(!r){console.log("SkillTreeSave.loadSkillUpgradeSave() No skill node found for id="+i);return}let s=t.c;s!==void 0&&r.setPurchasedCountFromSave(s)}};var Wi=class{constructor(){}static generateSave(e){let t={};return t.basePick=A.save(e.basePickDamagePerTurn),t.totalPick=A.save(e.totalPickDamagePerTurn),t}static loadSave(e,t){t&&(A.load(t.basePick,e.basePickDamagePerTurn),A.load(t.totalPick,e.totalPickDamagePerTurn))}};var mn=class{constructor(e,t,i,r,s,o,a,h){this.id=e,this.title=t,this.description=i,this.spriteFileName=r,this.gameTime=s,this.totals=o,this.cost=a,this.activationTurns=h,this.activated=!1,this.startTurn=0}getTitle(){return this.title}getDescription(){return this.description}isAffordable(){return this.cost.lessThanEquals(this.totals.gold)}isPurchasable(){return!(this.activated||!this.isAffordable())}onPurchase(){this.isPurchasable()&&(this.totals.decrementGold(this.cost),this.onActivation())}getActivationPercent(){if(!this.activated)return 0;let e=this.gameTime.turnNumber-this.startTurn;return Math.min(1,e/this.activationTurns)*100}onActivation(){return this.activated?!1:(this.startTurn=this.gameTime.turnNumber,this.activated=!0,!0)}onActivationFromSave(){this.activated=!0}onDeactivation(){return this.activated?(this.activated=!1,!0):!1}updateForTurn(){if(this.activated){let e=this.gameTime.turnNumber;this.activated=e-this.startTurn<this.activationTurns,this.activated||this.onDeactivation()}}getActivationValue(){}reset(){this.activated=!1,this.startTurn=0}};var St=class{constructor(e,t,i){this.id=e,this.gameTime=t,this.totals=i}createBonus(){}createBonusFromSave(e){}};var Ct=class extends mn{constructor(e,t,i,r,s,o,a,h,u,m){super(e,t,i,r,s,o,a,h),this.numberValue=u,this.activeValue=m}onActivation(){return super.onActivation()?(this.numberValue.incrementValue(this.activeValue),!0):!1}onActivationFromSave(){super.onActivationFromSave(),this.numberValue.incrementValue(this.activeValue)}onDeactivation(){return super.onDeactivation()?(this.numberValue.decrementValue(this.activeValue),!0):!1}getActivationValue(){return this.activeValue}reset(){super.reset(),this.numberValue.reset()}};var pn=class extends St{constructor(e,t,i,r){super(e,t,i),this.numberValue=r,this.cost=new c(n.bonus.activationCost)}createBonus(){return this.createBonusInternal(2)}createBonusFromSave(e){return this.createBonusInternal(e)}createBonusInternal(e){let t=n.bonus.activationTurns;return new Ct(this.id,"Gold Bonus","Gold +"+e,b.currency.gold,this.gameTime,this.totals,this.cost,t,this.numberValue,e)}};var gn=class extends St{constructor(e,t,i,r){super(e,t,i),this.numberValue=r,this.cost=new c(n.bonus.activationCost)}createBonus(){return this.createBonusInternal(50)}createBonusFromSave(e){return this.createBonusInternal(e)}createBonusInternal(e){let t=n.bonus.activationTurns;return new Ct(this.id,"Ore Multiplier","Ore x"+e,b.currency.ore,this.gameTime,this.totals,this.cost,t,this.numberValue,e)}};var fn=class extends St{constructor(e,t,i,r){super(e,t,i),this.numberValue=r,this.cost=new c(n.bonus.activationCost)}createBonus(){return this.createBonusInternal(10)}createBonusFromSave(e){return this.createBonusInternal(e)}createBonusInternal(e){let t=n.bonus.activationTurns;return new Ct(this.id,"Upgrade Multiplier","Upgrades x"+e,b.currency.upgrades,this.gameTime,this.totals,this.cost,t,this.numberValue,e)}};var Tn=class extends F{constructor(e,t,i){super(),this.gameTime=e,this.totals=t,this.values=i,this.availableBonuses=[],this.activeBonuses=[],this.availableChangeCount=0,this.activeChangeCount=0,this.bonusCreators=[],this.bonusCreatorById={},this.prevBonusTurn=-n.bonus.newBonusTurns,this.addBonusCreator(new gn("oreBonus",this.gameTime,this.totals,this.values.bonusOreMultiplier)),this.addBonusCreator(new fn("upgradeBonus",this.gameTime,this.totals,this.values.bonusUpgradeMultiplier)),this.addBonusCreator(new pn("goldBonus",this.gameTime,this.totals,this.values.bonusGoldIncrement))}addBonusCreator(e){this.bonusCreators.push(e),this.bonusCreatorById[e.id]=e}add(e){if(!e){console.log("BonusCollection.add() null bonus");return}this.availableBonuses.push(e),this.availableChangeCount++}addActiveBonusFromSave(e){if(!e){console.log("BonusCollection.addActiveBonusFromSave() null bonus");return}this.activeBonuses.push(e),this.activeChangeCount++,console.log("********** addActiveBonusFromSave() ADDED ACTIVE. len="+this.activeBonuses.length)}activateBonus(e){if(console.log("****************** activatebonus "+e.id+"   current length: "+this.activeBonuses.length),e.activated){console.log("BonusCollection.activateBonus() bonus already activated.");return}this.remove(e)?(e.onPurchase(),console.log("********** activateBonus() BONUS IS ACTIVATED: "+e.activated),this.activeBonuses.push(e),this.activeChangeCount++,console.log("********** activateBonus() ADDED ACTIVE. len="+this.activeBonuses.length)):console.log("**************** failed to add active")}remove(e){if(!e)return console.log("BonusCollection.remove() bonus null"),!1;let t=this.availableBonuses.indexOf(e);return t===-1?(console.log("BonusCollection.remove() did not find bonus in list"),!1):(this.availableBonuses.splice(t,1),this.availableChangeCount++,!0)}updateForTurn(){for(let t=this.activeBonuses.length-1;t>=0;t--){let i=this.activeBonuses[t];i.updateForTurn(),i.activated||(this.activeBonuses.splice(t,1),this.activeChangeCount++)}if(this.gameTime.turnNumber-this.prevBonusTurn>=n.bonus.newBonusTurns){this.prevBonusTurn=this.gameTime.turnNumber;let t=this.createRandomBonus();this.add(t)}}createRandomBonus(){let e=de.randomInt(this.bonusCreators.length);return this.bonusCreators[e].createBonus()}createBonusFromSave(e,t){let i=this.bonusCreatorById[e];return i?i.createBonusFromSave(t):(console.log("BonusCollection.createBonusById() Failed to find creator by id: "+e),null)}purchaseBonus(e){return e?e.isPurchasable()?this.availableBonuses.indexOf(e)<0?(console.log("BonusCollection.purchaseBonus() failed to find bonus in available list"),!1):(this.activateBonus(e),!0):(console.log("BonusCollection.purchaseBonus() bonus not purchasable"),!1):(console.log("BonusCollection.purchaseBonus() null bonus"),!1)}resetFull(){for(let e=0;e<this.activeBonuses.length;e++)this.activeBonuses[e].reset();this.availableBonuses.length=0,this.activeBonuses.length=0,this.availableChangeCount=0,this.activeChangeCount=0,this.prevBonusTurn=-n.bonus.newBonusTurns}resetForPrestige(){this.resetFull()}};var Yi=class{constructor(){}static generateSave(e){let t={};t.availableBonuses=[],t.activeBonuses=[],t.prevBonusTurn=e.prevBonusTurn;for(let i=0;i<e.activeBonuses.length;i++)e.activeBonuses[i]&&t.activeBonuses.push(this.generateBonusSave(e.activeBonuses[i]));for(let i=0;i<e.availableBonuses.length;i++)e.availableBonuses[i]&&t.availableBonuses.push(this.generateBonusSave(e.availableBonuses[i]));return t}static loadSave(e,t){if(!t){console.log("BonusCollectionSave.loadSave no save state");return}let i=t.prevBonusTurn;if(i&&(e.prevBonusTurn=i),t.availableBonuses)for(let r=0;r<t.availableBonuses.length;r++)this.loadBonusSave(e,t.availableBonuses[r]);if(t.activeBonuses)for(let r=0;r<t.activeBonuses.length;r++)this.loadBonusSave(e,t.activeBonuses[r])}static generateBonusSave(e){let t={};return t.id=e.id,t.activated=e.activated,t.startTurn=e.startTurn,t.activationValue=e.getActivationValue(),t}static loadBonusSave(e,t){if(!t)return;let i=t.id,r=t.activated,s=t.startTurn,o=t.activationValue,a=e.createBonusFromSave(i,o);if(!a){console.log("BonusCollectionSave.loadBonusSave() no bonus created for: "+i);return}a.startTurn=s,r?(e.addActiveBonusFromSave(a),a.onActivationFromSave()):e.add(a)}};var En=class extends F{constructor(){super(),this.CALLBACK_GAME_RESET=1,this.CALLBACK_GAME_DELETE=2,this.CALLBACK_GAME_IMPORT=3,this.CALLBACK_GAME_PRESTIGE=4}getState(){return null}startGame(){}prestigeGame(){}resetGame(){}deleteGame(){}importSave(e){}modelLoadCallback(e){}};var Ki=class extends F{constructor(e,t,i,r,s){super(),this.gameTime=e,this.automationUnlockedValue=t,this.automationRateUpgrades=i,this.baseUpgradeDelayTurns=r,this.turnsPerRateUpgrade=s,this.lastAutomationTurn=0,this.lastAutomationFrame=0,this.active=!0}getDelayTurns(){return Math.max(n.automation.minDelayTurns,this.baseUpgradeDelayTurns-this.automationRateUpgrades.getValue()*this.turnsPerRateUpgrade)}updateForTurn(){if(!this.active||!this.automationUnlockedValue.isValue())return;let e=this.gameTime.turnNumber,t=this.getDelayTurns();e-this.lastAutomationTurn<t||(this.lastAutomationTurn=e,this.lastAutomationFrame=this.gameTime.frameNumber,this.purchaseUpgrade())}purchaseUpgrade(){}isUnlocked(){return this.automationUnlockedValue.isValue()}toggleActiveFlag(){this.active=!this.active}getActivationPercent(){if(!this.active)return 0;let e=this.getDelayTurns()*n.time.turnFrames,t=this.gameTime.frameNumber-this.lastAutomationFrame;return Math.min(1,t/e)*100|0}resetFull(){this.lastAutomationTurn=0,this.lastAutomationFrame=0}resetForPrestige(){this.lastAutomationTurn=0,this.lastAutomationFrame=0}};var Sn=class extends Ki{constructor(e,t,i){super(e,i.pickAutomationUnlocked,i.pickAutomationRateUpgrades,n.automation.baseUpgradeDelayTurns,n.automation.turnsPerRateUpgrade),this.pickUpgradeCollection=t,this.validUpgrades=[],this.workingScore=new c(0),this.bestScore=new c(0),this.additive=!0}purchaseUpgrade(){if(this.pickUpgradeCollection.upgrades.length===0||(this.additive=!this.additive,this.findValidUpgrades(),this.validUpgrades.length===0))return;let t=this.selectBestUpgrade(this.additive);t&&t.purchase()}findValidUpgrades(){this.validUpgrades.length=0;let e=this.pickUpgradeCollection.upgrades;for(let t=0;t<e.length;t++){let i=e[t];this.isValidUpgrade(i)&&this.validUpgrades.push(i)}}selectBestUpgrade(e){let t=this.selectBestUpgradeByType(!0),i=this.selectBestUpgradeByType(!1);return!t&&!i?null:t?i?e?t:i:t:i}selectBestUpgradeByType(e){this.bestScore.setZero();let t=null;for(let i=0;i<this.validUpgrades.length;i++){let r=this.validUpgrades[i];if(r.additiveUpgrade!==e)continue;let s=this.getUpgradeScore(r);(!t||s.greaterThan(this.bestScore))&&(t=r,this.bestScore.copy(s))}return t}getUpgradeScore(e){return this.workingScore.copy(e.valuePerUpgrade),this.workingScore.mulNumber(e.nextActualPurchaseCount),this.workingScore.div(e.getCost()),this.workingScore}isValidUpgrade(e){return e?e.isVisible()&&e.isPurchasable():!1}};var Cn=class extends F{constructor(e,t,i,r,s){super(),this.gameTime=s,this.pickUpgradeAutomation=new Sn(s,e,i,s)}updateForTurn(){this.pickUpgradeAutomation.updateForTurn()}resetFull(){this.pickUpgradeAutomation.resetFull()}resetForPrestige(){this.pickUpgradeAutomation.resetForPrestige()}};var Xi=class{constructor(){}static generateSave(e){let t={};return t.prevTurn=e.prevTurn,t.pickAutomation=this.generateAutomationSave(e.pickUpgradeAutomation),t}static loadSave(e,t){t&&(e.prevTurn=t.prevTurn,this.loadAutomationSave(e.pickUpgradeAutomation,t.pickAutomation))}static generateAutomationSave(e){let t={};return t.lastAutomationTurn=e.lastAutomationTurn,t.lastAutomationFrame=e.lastAutomationFrame,t.active=e.active,t}static loadAutomationSave(e,t){t&&(e.lastAutomationTurn=t.lastAutomationTurn,t.lastAutomationFrame&&(e.lastAutomationFrame=t.lastAutomationFrame),e.active=t.active)}};var wt=class extends Tt{constructor(e,t,i,r,s,o){super(e,t,i,r,s),this.totals=o,this.initializeCosts()}getCostUnit(){return Bi.GOLD}getMoney(){return this.totals.gold}decrementMoney(e){this.totals.decrementGold(e)}};var wn=class extends wt{constructor(e,t,i,r,s,o,a,h){super(e,t,i,r,s,o),this.values=a,this.mineDamageLogic=h,this.displayedMultiplier=-10,this.description=null}getTitle(){return"Gold Damage +"+L.formatNumber(n.gold.damageMultiplierPerUpgrade*(this.purchasedCount+1))}getDescription(){let e=this.values.skillGoldBonusMultiplier.getValue();return(!this.description||this.damageMultiplier!==e)&&(this.displayedMultiplier=e,e===0?this.description="Damage: 1":this.description="Damage: "+L.formatNumber(1+e)),this.description}onUpgradePurchased(e,t){super.onUpgradePurchased(e,t);let i=e+t,r=0;for(let s=0;s<i;s++)r+=n.gold.damageMultiplierPerUpgrade*(s+1);this.values.skillGoldBonusMultiplier.setValue(r),this.mineDamageLogic.calculateTotalMineDamagePerTurn()}};var Ln=class extends wt{constructor(e,t,i,r,s,o,a){super(e,t,i,r,s,o),this.oreBonusValue=a,this.displayedMultiplier=new c(-10),this.description=null}getTitle(){return"Ore Bonus: +"+L.formatNumber(n.gold.oreBonusMultiplierPerUpgrade*(this.purchasedCount+1))}getDescription(){let e=this.oreBonusValue.getValue();return(!this.description||!e.equals(this.displayedMultiplier))&&(this.displayedMultiplier.copy(e),this.description="Bonus: x"+L.formatBigNum(e)),this.description}onUpgradePurchased(e,t){super.onUpgradePurchased(e,t);let i=e+t,r=0;for(let s=0;s<i;s++)r+=n.gold.oreBonusMultiplierPerUpgrade*(s+1);this.oreBonusValue.getValue().setValue(r)}};var _n=class extends wt{constructor(e,t,i,r,s,o,a){super(e,t,i,r,s,o),this.goldBonusValue=a,this.displayedBonus=new c(-10),this.description=null}getDescription(){let e=this.goldBonusValue.getValue();return(!this.description||!e.equals(this.displayedBonus))&&(this.displayedBonus.copy(e),this.description="+"+L.formatBigNum(e)+"/block"),this.description}onUpgradePurchased(e,t){super.onUpgradePurchased(e,t),this.goldBonusValue.incrementValue(new c(t))}};var Mn=class extends ni{constructor(e,t,i,r){super(),this.initializeUpgrades(e,t,i,r)}initializeUpgrades(e,t,i,r){this.generateDamageBonusUpgrade("goldDamage",e,this.createCostCalculator(),i,t),this.generateOreBonusUpgrade("goldOre",e,this.createCostCalculator(),t),this.generateGoldBonusUpgrade("goldPerBlock",e,this.createGoldCostCalculator(),t),this.addBulkCompleted()}generateOreBonusUpgrade(e,t,i,r){let s=n.gold.oreBonusMultiplierPerUpgrade,o=new Ln(e,"Ore: x"+s,b.currency.ore,i,100,t,r.goldOreBonusMultiplier);this.addBulk(o)}generateDamageBonusUpgrade(e,t,i,r,s){let o=n.gold.damageMultiplierPerUpgrade,a=new wn(e,"Mine: x"+o,b.pick,i,100,t,s,r);this.addBulk(a)}generateGoldBonusUpgrade(e,t,i,r){let s=new _n(e,"Gold: +1/block",b.currency.gold,i,100,t,r.goldPerBlockBonus);this.addBulk(s)}createCostCalculator(){let r=Math.max(1,Math.floor(Math.pow(50,1.1)));return new we(new c(r),1.1)}createGoldCostCalculator(){let r=Math.max(1,Math.floor(Math.pow(300,1.1)));return new we(new c(r),1.12)}resetForPrestige(){}};var ji=class{constructor(){}static generateSave(e){let t={};t.upgrades=[];for(let i=0;i<e.upgrades.length;i++){let r=this.generateUpgradeSave(e.upgrades[i]);r&&t.upgrades.push(r)}return t.countToPurchase=e.countToPurchase,t}static loadSave(e,t){if(!t){console.log("GoldUpgradeCollectionSave.loadSave no save state");return}if(!t.upgrades){console.log("GoldUpgradeCollectionSave.loadSave state empty");return}for(let s=0;s<t.upgrades.length;s++)this.loadUpgradeSave(e,t.upgrades[s]);let r=t.countToPurchase;r&&e.setCountToPurchase(r)}static generateUpgradeSave(e){if(e.purchasedCount===0)return null;let t={};return t.id=e.id,t.c=e.purchasedCount,t}static loadUpgradeSave(e,t){if(!t)return;let i=t.id,r=e.findById(i);if(!r){console.log("GoldUpgradeCollectionSave.loadUpgradeSave() failed to find upgrade id="+i);return}let s=t.c;s!==void 0&&r.setPurchasedCountFromSave(s)}};var Rn=class extends F{constructor(e,t,i,r,s){super(),this.worldGrid=e,this.projection=t,this.targetList=i,this.partyTarget=r,this.crew=s,this.startTileOrigin=null,this.targetListNumber=0;let o=this;this.minePremiumTileRegionCallback=function(a){let h=a.mineTiles;a.targetListNumber=o.targetList.targetListNumber;for(let u=0;u<h.length;u++){let m=h[u];!m||m.open||(o.targetList.priorityMiningCandidates.push(m),m.pathData.setMineScore(ye.PRIORITY,o.targetList.targetListNumber))}},this.commonTileRegionCallback=function(a){let h=a.tiles;for(let u=0;u<h.length;u++){let m=h[u];if(!m||m.tileType.rarityModifier!==f.COMMON||!m.lighting.everVisibleToCharacter||m.open)continue;let g=o.calculateCommonTileMineScore(m);m.pathData.setMineScore(g,o.targetListNumber),g>ye.WORTHLESS&&o.targetList.commonMiningCandidates.push(m)}}}generateTargetList(e,t,i,r,s){if(!e){console.log("TargetListGenerator - not generating: no tile");return}if(!e.getGrid().isLoaded()){console.log("TargetListGenerator - not generating: grid not loaded?");return}if(K.startTime("FindTargets"),this.startTileOrigin=e.origin,this.targetList.commonMiningCandidates.length=0,this.targetList.priorityMiningCandidates.length=0,this.targetList.ignoreCommonTiles=t,this.targetList.ignorePriorityTiles=i,this.targetList.destinationTileCandidates.fill(null),this.targetList.targetListNumber++,this.targetList.centerTile=e,this.targetListNumber=this.targetList.targetListNumber,!i){let h=(r?12:25)*n.tile.size;ie.allNearbyRegions(this.worldGrid,this.projection,this.startTileOrigin,h,this.minePremiumTileRegionCallback)}let a=this.targetList.priorityMiningCandidates.length;if(!t&&a<this.crew.miners.length){let h=(r?6:15)*n.tile.size;ie.allNearbyRegions(this.worldGrid,this.projection,this.startTileOrigin,h,this.commonTileRegionCallback)}this.addDestinationTiles(e,s,r),K.endTime("FindTargets")}addDestinationTiles(e,t,i){e&&(t===1?this.addDownDestinationTiles(e,i):t===2?this.addUpDestinationTiles(e,i):t===3&&this.addRightDestinationTiles(e,i))}addDownDestinationTiles(e,t){let i=this.targetList.destinationTileCandidates,r=n.tile.size*(t?15:25),s=0,o=this.worldGrid.findGridTileXY(e.origin.x,e.origin.y+r);for(;!o&&r>0;)r-=n.tile.size*n.grid.numTileColsInRegion,o=this.worldGrid.findGridTileXY(e.origin.x,e.origin.y+r);o&&(i.length<=s?i.push(o):i[s]=o,s++);for(let a=0;a<15;a++){let h=(a+1)*n.tile.size,u=this.worldGrid.findGridTileXY(e.origin.x-h,e.origin.y+r);u&&(i.length<=s?i.push(u):i[s]=u,s++)}for(let a=0;a<15;a++){let h=(a+1)*n.tile.size,u=this.worldGrid.findGridTileXY(e.origin.x+h,e.origin.y+r);u&&(i.length<=s?i.push(u):i[s]=u,s++)}}addUpDestinationTiles(e,t){let i=this.targetList.destinationTileCandidates,r=n.tile.size*(t?15:25),s=0,o=this.worldGrid.findGridTileXY(e.origin.x,e.origin.y-r);for(;!o&&r>0;)r-=n.tile.size*n.grid.numTileColsInRegion,o=this.worldGrid.findGridTileXY(e.origin.x,e.origin.y-r);o&&(i.length<=s?i.push(o):i[s]=o,s++);for(let a=0;a<15;a++){let h=(a+1)*n.tile.size,u=this.worldGrid.findGridTileXY(e.origin.x-h,e.origin.y-r);u&&(i.length<=s?i.push(u):i[s]=u,s++)}for(let a=0;a<15;a++){let h=(a+1)*n.tile.size,u=this.worldGrid.findGridTileXY(e.origin.x+h,e.origin.y-r);u&&(i.length<=s?i.push(u):i[s]=u,s++)}}addRightDestinationTiles(e,t){let i=this.targetList.destinationTileCandidates,r=n.tile.size*25,s=0,o=this.worldGrid.findGridTileXY(e.origin.x+r,e.origin.y);for(;!o&&r>0;)r-=n.tile.size*n.grid.numTileColsInRegion,o=this.worldGrid.findGridTileXY(e.origin.x+r,e.origin.y);o&&(i.length<=s?i.push(o):i[s]=o,s++);for(let a=0;a<15;a++){let h=(a+1)*n.tile.size,u=this.worldGrid.findGridTileXY(e.origin.x+r,e.origin.y-h);u&&(i.length<=s?i.push(u):i[s]=u,s++)}for(let a=0;a<15;a++){let h=(a+1)*n.tile.size,u=this.worldGrid.findGridTileXY(e.origin.x+r,e.origin.y+h);u&&(i.length<=s?i.push(u):i[s]=u,s++)}}addCenterDestinationTiles(e){let t=this.targetList.destinationTileCandidates;t.push(e);let i=e.neighbors;for(let h=0;h<i.length;h++){let u=i[h];u&&t.push(u)}let r=e.getNeighborTopLeft(),s=e.getNeighborTopRight(),o=e.getNeighborBottomLeft(),a=e.getNeighborBottomRight();r&&t.push(r),s&&t.push(s),o&&t.push(o),a&&t.push(a)}calculateCommonTileMineScore(e){return e.borderCode===pe.ALL_BORDERS_OPEN?ye.WORTHLESS:this.calculateNeighborTileScore(e)}calculateNeighborTileScore(e){let t=!1,i=!1,r=e.neighbors;for(let o=0;o<r.length;o++){let a=r[o];a&&(a.lighting.everVisibleToCharacter||!a.tileType.lightingSupported||(a.open?i=!0:t=!0))}let s=0;return t&&(s+=ye.COMMON_HIDDEN_NEIGHBOR),i&&(s+=ye.COMMON_REVEAL_CAVERN),s}resetFull(){}resetForPrestige(){}};var bt=class{constructor(e,t,i){this.id=e,this.name=t,this.iconFileName=i}};var he={MINE_DEEPER:new bt("1","Deeper",b.pick),MINE_SHALLOWER:new bt("2","Shallower",b.pick),MINE_CURRENT:new bt("3","Current Depth",b.pick),MINE_AUTO:new bt("4","Automated",b.pick)};var J={LOCKED_NO_MOVE:-3,MOVE_UP_LARGE:-2,MOVE_UP_SMALL:-1,CURRENT:0,MOVE_DOWN_SMALL:1,MOVE_DOWN_LARGE:2},An=class extends F{constructor(e,t,i,r,s,o){super(),this.crew=e,this.partyTarget=t,this.damage=i,this.worldGrid=r,this.targetListGenerator=s,this.targetList=o,this.crewModes=[he.MINE_DEEPER,he.MINE_SHALLOWER,he.MINE_CURRENT,he.MINE_AUTO],this.mineTileStep=40,this.prevTotalPickDamagePerTurn=new c(0),this.prevMode=null,this.workingHealth=new c(0),this.tileHealthPerDamageThreshold=new c(.05),this.debugTileHealthNegligible=!1,this.debugSearchGridSmall=!1,this.debugIgnorePriority=!1,this.debugIgnoreCommon=!1,this.debugGoalDescription="",this.activeMode=he.MINE_AUTO}setModeActive(e){this.activeMode=e}setActiveModeById(e){let t=this.findModeById(e);if(!t){console.log("MineControl.setActiveModeById() Failed to find mode id: "+e);return}this.setModeActive(t)}findModeById(e){for(let t=0;t<this.crewModes.length;t++){let i=this.crewModes[t];if(i.id===e)return i}return null}updateForTurn(){let e=this.crew.calculateCrewCenterTile();if(!e){console.log("MineControl.updateForTurn() no crew center tile");return}if(this.activeMode===he.MINE_AUTO){let t=this.partyTarget.targetMineSeconds!==this.partyTarget.defaultMineSeconds,i=!this.prevTotalPickDamagePerTurn.equals(this.damage.totalPickDamagePerTurn);(t||i)&&(this.partyTarget.targetMineSeconds=this.partyTarget.defaultMineSeconds,this.prevTotalPickDamagePerTurn.copy(this.damage.totalPickDamagePerTurn),this.partyTarget.calculateTargetRow())}else this.checkForTargetAdjust(e,this.prevMode!==this.activeMode);this.prevMode=this.activeMode,this.targetList.tileHealthNegligible=this.isTileHealthNegligible(e),this.debugTileHealthNegligible=this.targetList.tileHealthNegligible,this.applyMiningLogic(e)}isTileHealthNegligible(e){return e.tileType.layerDescription.calculateTileHealth(e.getTileRow(),this.workingHealth),this.workingHealth.div(this.damage.totalPickDamagePerTurn),this.workingHealth.lessThan(this.tileHealthPerDamageThreshold)}checkForTargetAdjust(e,t){let i=e.getTileRow();if(t)this.activeMode===he.MINE_CURRENT?this.applyMineCurrentTargetAdjust(i):this.activeMode===he.MINE_SHALLOWER?this.applyMineShallowerTargetAdjust(i):this.activeMode===he.MINE_DEEPER&&this.applyMineDeeperTargetAdjust(i);else{let r=this.partyTarget.targetRow,s=r-15,o=r+15;i<s?this.activeMode===he.MINE_SHALLOWER&&this.applyMineShallowerTargetAdjust(i):i>o?this.activeMode===he.MINE_DEEPER&&this.applyMineDeeperTargetAdjust(i):this.activeMode===he.MINE_DEEPER?this.applyMineDeeperTargetAdjust(i):this.activeMode===he.MINE_SHALLOWER&&this.applyMineShallowerTargetAdjust(i)}}applyMineCurrentTargetAdjust(e){this.partyTarget.deriveTargetSecondsForRow(e),this.partyTarget.calculateTargetRow()}applyMineShallowerTargetAdjust(e){let t=Math.max(n.target.minTargetRow,e-this.mineTileStep);this.partyTarget.deriveTargetSecondsForRow(t),this.partyTarget.calculateTargetRow()}applyMineDeeperTargetAdjust(e){this.partyTarget.deriveTargetSecondsForRow(e+this.mineTileStep),this.partyTarget.calculateTargetRow()}applyMiningLogic(e){let t=this.targetList.centerTile?this.targetList.centerTile:e,i=t.getTileRow(),r=e.getTileRow(),s=this.partyTarget.targetRow,o=this.targetList.isPriorityTileVisible(),a=0,h=15,u=25;if(this.activeMode===he.MINE_CURRENT)r<-5?a=J.MOVE_DOWN_LARGE:a=J.CURRENT;else if(this.activeMode===he.MINE_SHALLOWER)a=i>n.target.minTargetRow?J.MOVE_UP_LARGE:J.CURRENT;else if(this.activeMode===he.MINE_DEEPER)a=J.MOVE_DOWN_LARGE;else{let y=Math.max(n.target.minTargetRow,s-h),I=Math.max(n.target.minTargetRow,s-u),N=s+h,D=s+u;i<I?a=J.MOVE_DOWN_LARGE:i<y?a=J.MOVE_DOWN_SMALL:i>D?a=J.MOVE_UP_LARGE:i>N?a=J.MOVE_UP_SMALL:a=J.CURRENT}o&&a!==J.MOVE_DOWN_LARGE&&a!==J.MOVE_UP_LARGE&&(a=J.LOCKED_NO_MOVE);let m=s*n.tile.size,g=e.origin.y,_=h*n.tile.size,C=!1,w=this.targetList.tileHealthNegligible,T=!1;a===J.LOCKED_NO_MOVE?this.debugGoalDescription="mine priority tiles":a===J.MOVE_DOWN_LARGE?(C=this.targetList.tileHealthNegligible,w=!0,this.debugGoalDescription="mine downwards"):a===J.MOVE_DOWN_SMALL?this.debugGoalDescription="mine down a little":a===J.MOVE_UP_LARGE?(C=this.targetList.tileHealthNegligible,w=!0,this.debugGoalDescription="mine upwards"):a===J.MOVE_UP_SMALL?this.debugGoalDescription="mine up a little":this.debugGoalDescription="mine around target depth";let S;if(a===J.LOCKED_NO_MOVE)S=t;else if(a===J.CURRENT)S=this.calculateSearchAreaCenterTile(e,this.targetList.centerTile,a,m);else if(a===J.MOVE_DOWN_LARGE||a===J.MOVE_DOWN_SMALL){let y=Math.min(m,g+_),I=this.targetList.centerTile?Math.max(this.targetList.centerTile.origin.y,y):y;S=this.calculateSearchAreaCenterTile(e,this.targetList.centerTile,a,I)}else if(a===J.MOVE_UP_LARGE||a===J.MOVE_UP_SMALL){let y=Math.max(m,g-_),I=this.targetList.centerTile?Math.min(this.targetList.centerTile.origin.y,y):y;S=this.calculateSearchAreaCenterTile(e,this.targetList.centerTile,a,I)}this.debugSearchGridSmall=T,this.debugIgnorePriority=C,this.debugIgnoreCommon=w;let R=0;switch(a){case J.CURRENT:R=3;break;case J.LOCKED_NO_MOVE:R=0;break;case J.MOVE_DOWN_LARGE:case J.MOVE_DOWN_SMALL:R=1;break;case J.MOVE_UP_LARGE:case J.MOVE_UP_SMALL:R=2;break}this.targetListGenerator.generateTargetList(S,w,C,T,R)}calculateSearchAreaCenterTile(e,t,i,r){if(!t)return console.log("MineControl.calculateSearchAreaCenterTile() - no vector field center tile"),e;if(i===J.LOCKED_NO_MOVE)return t;let s=this.worldGrid.findGridTileXY(e.origin.x,r);return s||t}resetFull(){this.setModeActive(he.MINE_AUTO)}resetForPrestige(){}};var Zi=class{constructor(){}static generateSave(e){let t={};return t.activeId=e.activeMode.id,t}static loadSave(e,t){if(!t)return;let i=t.activeId;i?e.setActiveModeById(i):(console.log("MineControlSave.loadSave() Failed to load mine mode."),e.setModeActive(he.MINE_AUTO))}};var qi=class{constructor(){}static generateSave(e){let t={};return t.crewBrainDebugEnabled=e.crewBrainDebugEnabled,t.maxFps=e.maxFps,t.displayFps=e.displayFps,t.dynamicLightingEnabled=e.dynamicLightingEnabled,t.effectsRenderingEnabled=e.effectsRenderingEnabled,t.depthColumnRendered=e.depthColumnRendered,t.wireframeModeEnabled=e.wireframeModeEnabled,t}static loadSave(e,t){t&&(e.crewBrainDebugEnabled=!1,t.crewBrainDebugEnabled&&(e.crewBrainDebugEnabled=!0),t.maxFps&&(e.maxFps=t.maxFps),e.displayFps=!1,t.displayFps&&(e.displayFps=!0),e.dynamicLightingEnabled=!0,t.dynamicLightingEnabled!==void 0&&(e.dynamicLightingEnabled=t.dynamicLightingEnabled),e.effectsRenderingEnabled=!0,t.effectsRenderingEnabled!==void 0&&(e.effectsRenderingEnabled=t.effectsRenderingEnabled),e.depthColumnRendered=!0,t.depthColumnRendered!==void 0&&(e.depthColumnRendered=t.depthColumnRendered),e.wireframeModeEnabled=!1,t.wireframeModeEnabled&&(e.wireframeModeEnabled=!0))}};var Nn=class{constructor(e){this.gridSaveManager=e,this.modelsSaveKey="modelsSaveV2"}loadSave(e){return this.loadModels(e)}saveGame(e){this.saveAllLoadedGrids(e),this.saveModels(e)}deleteSave(){localStorage.removeItem(this.modelsSaveKey),this.gridSaveManager.deleteAllGrids()}saveModels(e){let t=this.generateModelState(e);if(!t){console.log("SaveManager.saveModels() Failed to generate models save state");return}let i=JSON.stringify(t);if(!i){console.log("SaveManager.saveModels() Failed to stringify models state");return}let r=It.compressToUTF16(i);if(!r){console.log("SaveManager.saveModels() Failed to compress state for models");return}localStorage.setItem(this.modelsSaveKey,r)}loadModels(e){let t=localStorage.getItem(this.modelsSaveKey);if(!t)return console.log("SaveManager.loadModels() No save found."),!1;let i=It.decompressFromUTF16(t);if(!i)return console.log("SaveManager.loadModels() Failed to decompress save."),!1;let r=JSON.parse(i);return r?this.loadModelState(e,r):(console.log("SaveManager.loadModels() Failed to parse save as JSON."),!1)}generateModelState(e){let t={};return t.state=Ii.generateSave(e),t.gridSaveManager=Fi.generateSave(e.gridSaveManager),t.time=xi.generateSave(e.gameTime),t.projection=bi.generateSave(e.projection),t.partyTarget=ki.generateSave(e.partyTarget),t.gameOptions=qi.generateSave(e.gameOptions),t.crew=Gi.generateSave(e.crew),t.totals=Oi.generateSave(e.totals),t.damage=Wi.generateSave(e.damage),t.values=Di.generateSave(e.values),t.runStats=yt.generateSave(e.runStatistics),t.globalStats=yt.generateSave(e.globalStatistics),t.minedUpgradeCollection=vi.generateSave(e.minedUpgradeCollection),t.pickUpgradeCollection=Ui.generateSave(e.pickUpgradeCollection),t.goldUpgradeCollection=ji.generateSave(e.goldUpgradeCollection),t.bonusCollection=Yi.generateSave(e.bonusCollection),t.automation=Xi.generateSave(e.automationManager),t.mineControl=Zi.generateSave(e.mineControl),t.skillTree=Hi.generateSave(e.skillTreeGraph),t}loadModelState(e,t){if(!t)return!1;let i=!0;try{Ii.loadSave(e,t.state)}catch(r){console.error("SaveManager.loadModelState() Failed to load State:",r.message),i=!1}try{Fi.loadSave(e.gridSaveManager,t.gridSaveManager)}catch(r){console.error("SaveManager.loadModelState() Failed to load GridSaveManager:",r.message),i=!1}try{xi.loadSave(e.gameTime,t.time)}catch(r){console.error("SaveManager.loadModelState() Failed to load GameTime:",r.message),i=!1}try{bi.loadSave(e.projection,t.projection)}catch(r){console.error("SaveManager.loadModelState() Failed to load Projection:",r.message),i=!1}try{Gi.loadSave(e.crew,t.crew)}catch(r){console.error("SaveManager.loadModelState() Failed to load Crew:",r.message),i=!1}try{Oi.loadSave(e.totals,t.totals)}catch(r){console.error("SaveManager.loadModelState() Failed to load Totals:",r.message),i=!1}try{Wi.loadSave(e.damage,t.damage)}catch(r){console.error("SaveManager.loadModelState() Failed to load Damage:",r.message),i=!1}try{Di.loadSave(e.values,t.values)}catch(r){console.error("SaveManager.loadModelState() Failed to load Values:",r.message),i=!1}try{yt.loadSave(e.runStatistics,t.runStats)}catch(r){console.error("SaveManager.loadModelState() Failed to load Statistics (run):",r.message),i=!1}try{yt.loadSave(e.globalStatistics,t.globalStats)}catch(r){console.error("SaveManager.loadModelState() Failed to load Statistics (global):",r.message),i=!1}try{ki.loadSave(e.partyTarget,t.partyTarget)}catch(r){console.error("SaveManager.loadModelState() Failed to load PartyTarget:",r.message),i=!1}try{qi.loadSave(e.gameOptions,t.gameOptions)}catch(r){console.error("SaveManager.loadModelState() Failed to load PartyTarget:",r.message),i=!1}try{vi.loadSave(e.minedUpgradeCollection,e.upgradeCreators,t.minedUpgradeCollection)}catch(r){console.error("SaveManager.loadModelState() Failed to load MinedUpgradeCollection:",r.message),i=!1}try{Ui.loadSave(e.pickUpgradeCollection,t.pickUpgradeCollection)}catch(r){console.error("SaveManager.loadModelState() Failed to load PickUpgradeCollection:",r.message),i=!1}try{ji.loadSave(e.goldUpgradeCollection,t.goldUpgradeCollection)}catch(r){console.error("SaveManager.loadModelState() Failed to load GoldUpgradeCollection:",r.message),i=!1}try{Yi.loadSave(e.bonusCollection,t.bonusCollection)}catch(r){console.error("SaveManager.loadModelState() Failed to load BonusCollection:",r.message),i=!1}try{Xi.loadSave(e.automationManager,t.automation)}catch(r){console.error("SaveManager.loadModelState() Failed to load AutomationSave:",r.message),i=!1}try{Zi.loadSave(e.mineControl,t.mineControl)}catch(r){console.error("SaveManager.loadModelState() Failed to load MineControlSave:",r.message),i=!1}try{Hi.loadSave(e.skillTreeGraph,t.skillTree)}catch(r){console.error("SaveManager.loadModelState() Failed to load SkillTreeSave:",r.message),i=!1}return i}saveAllLoadedGrids(e){let t=e.worldGrid.grids;for(let i=0;i<t.length;i++){let r=t[i];r&&r.isLoaded()&&this.gridSaveManager.saveGridState(r)}}getSaveStateForExport(e){let t=this.generateModelState(e);if(!t)return console.log("SaveManager.getSaveState() Failed to generate models save state"),null;let i=this.gridSaveManager.generateGridStateForExport(e.worldGrid);i||console.log("SaveManager.getSaveState() Failed to generate grid state");let s=JSON.stringify({model:t,grid:i});if(!s)return console.log("SaveManager.getSaveState() Failed to stringify state"),null;let o=It.compressToBase64(s);return o||(console.log("SaveManager.getSaveState() Failed to compress state"),null)}importSave(e,t){if(!t)return console.log("SaveManager.importSave() No save found."),!1;let i=It.decompressFromBase64(t);if(!i)return console.log("SaveManager.importSave() Failed to decompress save."),!1;let r=JSON.parse(i);if(!r)return console.log("SaveManager.importSave() Failed to parse save as JSON."),!1;let s=r.model,o=r.grid,a=this.loadModelState(e,s);if(console.log("SaveManager.importSave() load model state:"+a),!a)return!1;this.gridSaveManager.deleteAllGrids();let h=this.gridSaveManager.importGridState(e.worldGrid,o);if(console.log("SaveManager.importSave() import grid state:"+h),h){console.log("SaveManager.importSave() saving newly imported state.");let u=e.worldGrid.grids;for(let m=0;m<u.length;m++){let g=u[m];g&&(console.log("SaveManager.importSave() SAVING GRID STATE."),this.gridSaveManager.saveGridState(g))}this.saveModels(e)}else console.log("SaveManager.importSave() FAIL modelStateLoaded="+a+" worldGridStateLoaded="+h);return h}};var Pn=class{constructor(){}playSound(e){}};var yn=class extends F{constructor(e,t){super(),this.projection=e,this.crew=t,this.animating=!1,this.workingCenter=new P(0,0),this.deltaThreshold=1.5,this.targetAnimationMillis=200}startAnimation(){if(this.animating)return;if(this.crew.calculateCrewCenterCoordinate(this.workingCenter),U.dist(this.workingCenter,this.projection.gridCenter)>n.grid.gridPixelWidth*2){this.projection.setGridCenter(this.workingCenter.x,this.workingCenter.y),this.projection.stayCenteredOnCharacter=!0;return}let t=this.workingCenter.x-this.projection.gridCenter.x,i=this.workingCenter.y-this.projection.gridCenter.y;if(t===0&&i===0){this.animating=!1,this.projection.stayCenteredOnCharacter=!0;return}this.animating=!0}updateForFrame(e){if(!this.animating)return!1;this.crew.calculateCrewCenterCoordinate(this.workingCenter);let t=this.workingCenter.x-this.projection.gridCenter.x,i=this.workingCenter.y-this.projection.gridCenter.y;if(t===0&&i===0)return this.animating=!1,!0;let r=Math.abs(t),s=Math.abs(i),o=t/this.targetAnimationMillis*n.time.defaultMillisPerFrame,a=i/this.targetAnimationMillis*n.time.defaultMillisPerFrame,h=o*e,u=a*e,m,g,_,C;return r<this.deltaThreshold||r<h?(m=this.workingCenter.x,_=!0):(m=this.projection.gridCenter.x+h,_=!1),s<this.deltaThreshold||s<u?(g=this.workingCenter.y,C=!0):(g=this.projection.gridCenter.y+u,C=!1),this.projection.setGridCenter(m,g),_&&C?(this.projection.stayCenteredOnCharacter=!0,this.animating=!1,!0):!1}resetFull(){this.animating=!1}resetForPrestige(){this.resetFull()}};var bn=class extends zt{constructor(e){super(),this.tileMinedLogic=e}performAction(e,t,i){let r=e.position.tile;if(!r){e.resetTurnState();return}let s=e.target.mineTile;if(!s){e.resetTurnState();return}if(s.open){e.resetTurnState();return}if(!r.isNeighborTile(s)){e.resetTurnState();return}e.setCharacterAction(H.MINE),e.position.worldCoordinateOrigin.x!==s.origin.x&&(e.position.facingLeft=e.position.worldCoordinateOrigin.x>s.origin.x),i&&this.tileMinedLogic.mineTileForTurn(e,s)&&e.resetTurnState()}toString(){return"MineTurnAction"}};var In=class extends ei{constructor(e,t,i,r){super(),this.statisticsIncrementor=e,this.mineDamageLogic=t,this.tileMinedLogic=i,this.targetList=r}performAction(e,t,i){e.position.tile&&!e.position.tile.open&&this.targetList.tileHealthNegligible&&this.tileMinedLogic.mineTileIstantly(e,e.position.tile),super.performAction(e,t,i);let r=e.position.tile;if(!r)return;!r.open&&this.targetList.tileHealthNegligible&&this.tileMinedLogic.mineTileIstantly(e,r);let s=this.statisticsIncrementor.globalStatitics.maxDepth,o=r.getTileRow();this.statisticsIncrementor.tileDepth(o),s<o&&this.mineDamageLogic.calculateTotalMineDamagePerTurn()}};var On=class{constructor(e,t,i,r,s,o,a){this.crew=e,this.targetList=t,this.partyTarget=i,this.pathPlanFinder=r,this.mineTurnAction=new bn(s),this.moveTurnAction=new In(a,o,s,t),this.unassignedMiners=[],this.unassignedMinerCount=0,this.claimedTiles=[],this.bestTiles=[],this.workingPosition=new P(0,0),this.nearDistance2=5*n.tile.size*(5*n.tile.size)}updateForTurn(){this.targetList.ignoreCommonTiles&&this.targetList.ignorePriorityTiles?this.assignTurnsForDestinationTiles():this.targetList.isMineTargetsEmpty()?this.assignTurnsForDestinationTiles():this.assignTurnsForTargetList(),this.setTurnActions()}assignTurnsForDestinationTiles(){let e=this.crew.miners,t=this.targetList.destinationTileCandidates;for(let i=0;i<e.length;i++){let r=e[i],s=this.findClosestTile(r.position.worldCoordinateOrigin,t);if(s){if(this.evaluateMinerDestination(r,s))continue;this.assignMinerTarget(r,s,null);continue}r.resetTurnState()}}assignTurnsForTargetList(){let e=this.crew.miners,t=this.targetList.priorityMiningCandidates,i=this.targetList.commonMiningCandidates;if(this.claimedTiles.length=0,this.unassignedMiners.fill(null),this.unassignedMinerCount=0,t.length>0)for(let r=0;r<e.length;r++)this.evaluateMinerTargetForPriority(e[r]);else for(let r=0;r<e.length;r++)this.evaluateMinerTarget(e[r]);if(this.unassignedMinerCount!==0){if(t.length>0){for(let r=0;r<this.unassignedMiners.length;r++){let s=this.unassignedMiners[r];s&&this.findCandidateTiles(s,t)}if(this.assignClosestCandidates(),this.unassignedMinerCount===0)return;for(let r=0;r<this.unassignedMiners.length;r++){let s=this.unassignedMiners[r];s&&this.assignMinerToClosestAvailableTile(s,r,t)}}if(this.unassignedMinerCount!==0){for(let r=0;r<this.unassignedMiners.length;r++){let s=this.unassignedMiners[r];if(!s)continue;let o=s.target.mineTile;if(o&&this.isCurrentMineTargetValid(o)){this.unassignedMiners[r]=null,this.unassignedMinerCount--;continue}i.length>0&&this.assignMinerToClosestAvailableTile(s,r,i)}if(this.unassignedMinerCount!==0){for(let r=this.unassignedMiners.length-1;r>=0;r--){let s=this.unassignedMiners[r];s&&this.assignMinerToHelpOthers(s,r)}if(this.unassignedMinerCount!==0)for(let r=0;r<this.unassignedMiners.length;r++){let s=this.unassignedMiners[r];s&&(s.resetTurnState(),s.setCharacterAction(H.STAND))}}}}}findCandidateTiles(e,t){let i=e.position.worldCoordinateOrigin,r=e.target;r.candidateTile=null,r.candidateDist=1e4;for(let s=0;s<t.length;s++){let o=t[s],a=i.distanceSquared(o.origin);(!r.candidateTile||a<r.candidateDist)&&(r.candidateTile=o,r.candidateDist=a)}}assignClosestCandidates(){for(let e=0;e<this.unassignedMiners.length;e++){let t=this.unassignedMiners[e];if(!t)continue;let r=t.target.candidateTile;r&&this.claimedTiles.indexOf(r)===-1&&this.assignClosestMinerToCandidateTile(r)}}assignClosestMinerToCandidateTile(e){let t=null,i=1e4,r=-1;for(let s=0;s<this.unassignedMiners.length;s++){let o=this.unassignedMiners[s];if(!o)continue;let a=o.target;e===a.candidateTile&&(!t||a.candidateDist<i?(t=o,i=a.candidateDist,r=s):(a.candidateTile=null,a.candidateDist=1e3))}t&&this.claimTargetForMiner(t,e)&&(this.unassignedMiners[r]=null,this.unassignedMinerCount--)}assignMinerToHelpOthers(e,t){let i=this.findClosestTargetedMineTile(e.position.tile.origin);if(!i)return;let r=this.findBestNeighborTile(i,e.position.tile);if(!r){console.log("CrewBrain.assignMinerToHelpOthers() failed to find miner for tile.");return}this.unassignedMiners[t]=null,this.unassignedMinerCount--,this.assignMinerTarget(e,r,i)}assignMinerToClosestAvailableTile(e,t,i){let r=this.findClosestUnclaimedTile(e.position.worldCoordinateOrigin,i);return!r||!this.claimTargetForMiner(e,r)?!1:(this.unassignedMiners[t]=null,this.unassignedMinerCount--,!0)}claimTargetForMiner(e,t){let i=this.findBestNeighborTile(t,e.position.tile);return i?(this.assignMinerTarget(e,i,t),this.claimedTiles.push(t),!0):(console.log("CrewBrain.assignTargetForMiner() failed to find miner for tile."),!1)}evaluateMinerTargetForPriority(e){if(!e.position.tile)return;let t=e.target.mineTile;if(t&&this.isCurrentMineTargetValidPriority(t)){this.claimedTiles.push(t);return}this.unassignedMiners[this.unassignedMinerCount]=e,this.unassignedMinerCount++}evaluateMinerTarget(e){if(!e.position.tile)return;let t=e.target.mineTile;if(t&&this.isCurrentMineTargetValid(t)){this.claimedTiles.push(t);return}this.unassignedMiners[this.unassignedMinerCount]=e,this.unassignedMinerCount++}evaluateMinerDestination(e,t){if(!e.position.tile)return!0;let i=e.target.targetTile;return!!(i&&e.position.pathPlan.length>0&&i.origin.distanceSquared(t.origin)<=this.nearDistance2)}isCurrentMineTargetValidPriority(e){return!e||e.open||!e.isPriority()?!1:e.pathData.getMineScore(this.targetList.targetListNumber)!==ye.PRIORITY}isCurrentMineTargetValid(e){return!e||e.open?!1:e.pathData.getMineScore(this.targetList.targetListNumber)>ye.WORTHLESS}findClosestTargetedMineTile(e){let t=this.crew.miners,i=null,r=1e6;for(let s=0;s<t.length;s++){let o=t[s].target.mineTile;if(!o)continue;let a=e.distanceSquared(o.origin);(!i||r>a)&&(i=o,r=a)}return i}findClosestUnclaimedTile(e,t){let i=null,r=1e6;for(let s=0;s<t.length;s++){let o=t[s],a=e.distanceSquared(o.origin);if(!i||r>a){if(this.claimedTiles.indexOf(o)!==-1)continue;i=o,r=a}}return i}findClosestTile(e,t){let i=null,r=1e6;for(let s=0;s<t.length;s++){let o=t[s];if(!o)continue;let a=e.distanceSquared(o.origin);(!i||r>a)&&(i=o,r=a)}return i}findClosestOpenTile(e,t){let i=null,r=1e6;for(let s=0;s<t.length;s++){let o=t[s];if(!o||!o.open)continue;let a=e.distanceSquared(o.origin);(!i||r>a)&&(i=o,r=a)}return i}setTurnActions(){let e=this.crew.miners;for(let t=0;t<e.length;t++)this.setMinerTurnAction(e[t])}setMinerTurnAction(e){let t=e.target.mineTile;e.position.pathPlan.length>0?e.turnAction=this.moveTurnAction:t&&!t.open&&e.position.tile.isNeighborTile(t)?e.turnAction=this.mineTurnAction:e.resetTurnState()}findBestNeighborTile(e,t){if(e.isNeighborTile(t))return t;let i=e.getNeighbors(),r=this.findClosestOpenTile(t.origin,i);if(r&&r.open)return r;for(let a=0;a<i.length;a++){let h=i[a];if(!(!h||!h.open)&&h.isNeighborTile(t))return h}let s=null,o=1e6;for(let a=0;a<i.length;a++){let h=i[a];if(!h)continue;let u=h.origin.distanceSquared(t.origin);(!s||o>u)&&(s=h,o=u)}return s}assignMinerTarget(e,t,i){if(e.target.setTargetTile(t,i,"crewBrain"),t!==e.position.tile){let r=!0;e.position.isCenteredOnTile()||(e.position.isNearTileOrigin()?(e.position.setPositionToTileOrigin(),e.resetTurnState()):r=!1),this.pathPlanFinder.findPartyCharacterPathPlan(e.position.tile,t,e.position.pathPlan,r)}}};var xn=class extends jt{constructor(){super()}resetForPrestige(){}};var Dn=class{constructor(e,t,i){this.totals=e,this.values=t,this.statisticsIncrementor=i,this.tempFormatValue=new c(0),this.workingOre=new c(0),this.workingGold=new c(0),this.workingRuby=new c(0),this.workingSilver=new c(0)}calculateOfflineEarnings(){let e=this.totals.offlineSeconds;if(e<=0)return;console.log("OfflineLogic.calculateOfflineEarnings() offlineSeconds="+Ue.formatElapsedTime(e*1e3));let t=e*n.time.turnsPerSecond,i=n.offline.defaultOfflineTurns+this.values.offlineTimeUpgrades.getValue()*n.offline.turnsPerUpgrade,r=Math.min(i,t);if(r<=0){this.totals.offlineSeconds=0,this.totals.countedOfflineSeconds=0;return}this.calculateOfflineCurrency(r,this.totals.goldPerTurn,this.workingGold),this.workingGold.greaterThanZero()&&this.totals.incrementOfflineGold(this.workingGold),this.calculateOfflineCurrency(r,this.totals.rubyPerTurn,this.workingRuby),this.workingRuby.greaterThanZero()&&this.totals.incrementOfflineRuby(this.workingRuby),this.calculateOfflineCurrency(r,this.totals.silverPerTurn,this.workingSilver),this.workingSilver.greaterThanZero()&&this.totals.incrementOfflineSilver(this.workingSilver),this.calculateOfflineCurrency(r,this.totals.orePerTurn,this.workingOre),this.workingOre.greaterThanZero()&&this.totals.incrementOfflineOre(this.workingOre),this.totals.countedOfflineSeconds=r*n.time.secondsPerTurn|0,this.totals.offlineSeconds=0}claimOfflineEarnings(){this.totals.countedOfflineSeconds=0,this.statisticsIncrementor.incrementGold(this.totals.offlineGold),this.totals.gold.add(this.totals.offlineGold),this.totals.offlineGold.setZero(),this.statisticsIncrementor.incrementOre(this.totals.offlineOre),this.totals.ore.add(this.totals.offlineOre),this.totals.offlineOre.setZero(),this.statisticsIncrementor.incrementRuby(this.totals.offlineRuby),this.totals.ruby.add(this.totals.offlineRuby),this.totals.offlineRuby.setZero(),this.statisticsIncrementor.incrementSilver(this.totals.offlineSilver),this.totals.silver.add(this.totals.offlineSilver),this.totals.silverSum.add(this.totals.offlineSilver),this.totals.offlineSilver.setZero()}calculateOfflineCurrency(e,t,i){if(t.equalsZero()){i.setZero();return}i.copy(t),i.mulNumber(e),i.floor()}};var vn=class extends F{constructor(e){super(),this.gameModels=[],this.sprites=new Rr,this.worldGrid=new Ar,this.gameModels.push(this.worldGrid),this.projection=new xr,this.gameModels.push(this.projection),this.gameTime=new Ur,this.gameModels.push(this.gameTime),this.globalStatistics=new xn,this.gameModels.push(this.globalStatistics),this.runStatistics=new jt,this.gameModels.push(this.runStatistics),this.gameOptions=new Ts,this.statisticsIncrementor=new as(this.globalStatistics,this.runStatistics),this.values=new Hr,this.gameModels.push(this.values),this.crew=new Wr(this.worldGrid,this.gameTime,this.sprites.characterSpritesheet,this.sprites.itemOverlaySpritesheet,this.values),this.gameModels.push(this.crew),this.gridLoadingManager=new Eo(this.worldGrid,this.projection),this.gameModels.push(this.gridLoadingManager),this.gameVisible=!0,this.gamePaused=!1,this.worldSeed=1,this.currentFps=0,this.targetList=new Ss,this.gameModels.push(this.targetList),this.totals=new Kr(this.gameTime),this.gameModels.push(this.totals),this.damage=new Yr,this.gameModels.push(this.damage),this.effectManager=new rs(this.projection),this.gameModels.push(this.effectManager),this.lightSourceCreators=new Jr,this.gameModels.push(this.lightSourceCreators),this.effectCreators=new is(this.lightSourceCreators,this.sprites.spellFxSpritesheet),this.gameModels.push(this.effectCreators),this.lightingCalculator=new Ro(this.worldGrid,this.projection),this.gameModels.push(this.lightingCalculator),this.physicsManager=new No(this.worldGrid,this.projection,this.gameTime),this.soundEffectManager=new Pn,this.infoTextProcessor=new ns(this.projection),this.gameModels.push(this.infoTextProcessor),this.partyTarget=new Po(this.totals,this.damage),this.gameModels.push(this.partyTarget),this.mineDamageLogic=new ls(this.values,this.totals,this.damage,this.globalStatistics),this.offlineLogic=new Dn(this.totals,this.values,this.statisticsIncrementor),this.minedUpgradeCollection=new gs,this.gameModels.push(this.minedUpgradeCollection),this.pickUpgradeCollection=new bo(this.totals,this.values,this.mineDamageLogic),this.gameModels.push(this.pickUpgradeCollection),this.goldUpgradeCollection=new Mn(this.totals,this.values,this.mineDamageLogic,this.damage),this.gameModels.push(this.goldUpgradeCollection),this.bonusCollection=new Tn(this.gameTime,this.totals,this.values),this.gameModels.push(this.bonusCollection),this.targetListGenerator=new Rn(this.worldGrid,this.projection,this.targetList,this.partyTarget,this.crew),this.gameModels.push(this.targetListGenerator),this.oreCalculationLogic=new hs(this.values),this.upgradeCreators=new fs(this.values,this.totals,this.oreCalculationLogic,this.mineDamageLogic,this.minedUpgradeCollection,this.statisticsIncrementor),this.tileMinedLogic=new Es(this.crew,this.totals,this.damage,this.values,this.statisticsIncrementor,this.minedUpgradeCollection,this.upgradeCreators,this.infoTextProcessor,this.effectCreators,this.effectManager,this.oreCalculationLogic,this.mineDamageLogic,this.gameOptions),this.skillTreeGraph=new cn(this.gameTime,this.worldGrid,this.totals,this.values,this.tileMinedLogic,this.mineDamageLogic,this.crew,this.targetList,this.sprites.spellFxSpritesheet),this.gameModels.push(this.skillTreeGraph),this.automationManager=new Cn(this.pickUpgradeCollection,e,this.values,this.totals,this.gameTime),this.gameModels.push(this.automationManager),this.pathPlanFinder=new to(this.worldGrid,this.targetList,this.tileMinedLogic),this.gameModels.push(this.pathPlanFinder),this.crewBrain=new On(this.crew,this.targetList,this.partyTarget,this.pathPlanFinder,this.tileMinedLogic,this.mineDamageLogic,this.statisticsIncrementor),this.mineControl=new An(this.crew,this.partyTarget,this.damage,this.worldGrid,this.targetListGenerator,this.targetList),this.gameModels.push(this.mineControl),this.characterBrains=new ro(this.pathPlanFinder),this.characterCreator=new so(this.sprites.monsterSpritesheet,this.characterBrains),this.gameModels.push(this.characterCreator),this.gridSave=new go(this.characterCreator),this.gridSaveManager=new fo(this.gridSave),this.gameModels.push(this.gridSaveManager),this.saveManager=new Nn(this.gridSaveManager),this.panAnimation=new yn(this.projection,this.crew),this.gameModels.push(this.panAnimation)}initializeState(e){let t=new po(this.worldSeed,this.characterCreator),i=new To(this.gridSaveManager,t,this.worldGrid,this.crew,this.targetList);if(this.gridLoadingManager.initializeLoadingManager(i,this.crew),this.crew.main){let r=this.worldGrid.findGridTile(this.crew.main.position.worldCoordinateOrigin);r&&this.crew.main.position.setTileAndOriginPosition(r,r.origin.x,r.origin.y)}else{let r=this.crew.createMainMiner(),s=null;e?s=this.worldGrid.findGridTile(r.position.worldCoordinateOrigin):s=this.worldGrid.findGridTileXY(n.start.startX,n.start.startY),s?r.position.setTileAndOriginPosition(s,s.origin.x,s.origin.y):e||r.position.setWorldCoordinateOriginXY(n.start.startX,n.start.startY)}if(e){let r=Date.now(),s=this.gameTime.saveTime,a=(r-s)/1e3|0;a>0&&(this.totals.offlineSeconds+=a,this.offlineLogic.calculateOfflineEarnings())}this.mineDamageLogic.calculateTotalMineDamagePerTurn()}beforeImportSave(){for(let e=0;e<this.gameModels.length;e++)this.gameModels[e].resetFull()}afterImportSave(){this.initializeState(!0),this.projection.setGridCenter(n.start.startX,n.start.startY),this.gridLoadingManager.manageLoadedGridsForFrame()}resetForPrestige(){for(let e=0;e<this.gameModels.length;e++)this.gameModels[e].resetForPrestige();this.worldSeed++,this.initializeState(!1),this.projection.setGridCenter(n.start.startX,n.start.startY),this.gridLoadingManager.manageLoadedGridsForFrame()}resetFull(){for(let e=0;e<this.gameModels.length;e++)this.gameModels[e].resetFull();this.worldSeed++,this.initializeState(!1),this.projection.setGridCenter(n.start.startX,n.start.startY),this.gridLoadingManager.manageLoadedGridsForFrame()}};var d=class l{constructor(){}static getElement(e){return document.getElementById(e)}static createTextElement(e){return document.createTextNode(e)}static setInnerHtml(e,t){var i=l.getElement(e);i&&(i.innerHTML=t)}static createElement(e,t,i,r){var s=document.createElement(e);return r&&(s.className=r),i&&(s.id=i),t&&t.appendChild(s),s}static createInputElement(e,t,i,r){var s=document.createElement("input");return s.type=e,r&&(s.className=r),i&&(s.id=i),t&&t.appendChild(s),s}static clearChildren(e){var t=l.getElement(e);if(t)for(;t.firstChild;)t.removeChild(t.firstChild)}static removeElementById(e,t){this.removeElement(e,l.getElement(t))}static removeElement(e,t){var i=l.getElement(e);if(!(!i||!t))try{i.removeChild(t)}catch(r){r instanceof DOMException?(console.error("Caught a DOMException. parentId="+e+" elementId="+t.id,r.name,r.message),r.name==="SyntaxError"&&console.warn("Invalid CSS selector used.")):console.error("Caught a non-DOMException error.  parentId="+e+" elementId="+t.id,r)}}static hideElement(e){e&&(e.style.display="none")}static showElement(e){this.showElementWithValue(e,"block")}static showElementIdWithValue(e,t){l.showElementWithValue(l.getElement(e),t)}static showElementWithValue(e,t){e&&(e.style.display=t)}static hideElementId(e){l.hideElement(l.getElement(e))}static showElementId(e){l.showElement(l.getElement(e))}};var G=class{constructor(e,t){this.parentId=e,this.elementId=t,this.viewVisible=!0,this.currentlyVisible=!1,this.inialized=!1}getElementId(){return this.elementId}setCurrentlyVisible(e){this.currentlyVisible=e}isViewVisible(){return this.viewVisible}setViewVisible(e){this.viewVisible!==e&&(this.viewVisible=e,this.currentlyVisible=!e)}setInitialVisibility(e){this.currentlyVisible=!e,this.viewVisible=e}clearChildViews(){}updateView(){if(this.inialized||console.log("View.updateView() Not initialized: "+this.constructor.name),this.elementId){var e=this.isViewVisible();this.currentlyVisible!==e&&(this.currentlyVisible=e,e?d.showElementIdWithValue(this.elementId,this.getVisibileDisplayValue()):d.hideElementId(this.elementId)),e&&this.updateViewContents()}}getVisibileDisplayValue(){return"block"}initializeView(){this.inialized=!0}updateViewContents(){}removeAll(){this.parentId&&d.removeElementById(this.parentId,this.elementId)}};var B=class extends G{constructor(e,t){super(e,t),this.childViews=null}getChildViews(){return this.childViews}clearChildViews(){if(this.childViews&&this.childViews.length>0){for(let e=0;e<this.childViews.length;e++)this.childViews[e].clearChildViews();this.childViews.length=0}}removeAll(){if(this.childViews)for(let e=0;e<this.childViews.length;e++)this.childViews[e].removeAll();this.childViews=null,super.removeAll()}removeChildViewElements(){if(!this.childViews||this.childViews.length===0)return;let e=this.getElementId();for(let t=0;t<this.childViews.length;t++)d.removeElementById(e,this.childViews[t].getElementId());this.clearChildViews()}removeViewAtIndex(e){if(!this.childViews||this.childViews.length===0)return;let t=this.childViews[e],i=this.getElementId();d.removeElementById(i,t.getElementId()),this.childViews.splice(e,1)}removeView(e){if(!this.childViews||this.childViews.length===0)return;let t=this.getElementId(),i=-1;for(let s=0;s<this.childViews.length;s++)if(this.childViews[s].getElementId()===e){i=s;break}if(i===-1){console.log("ParentView.removeView() Failed to find child id: "+e);return}let r=this.childViews[i];d.removeElementById(t,r.getElementId()),this.childViews.splice(i,1)}addView(e){e&&(this.childViews||(this.childViews=[]),this.childViews.push(e))}initializeView(){if(this.childViews)for(let e=0;e<this.childViews.length;e++)this.childViews[e].initializeView();super.initializeView()}updateViewContents(){this.updateChildViews()}updateChildViews(){if(this.childViews)for(let e=0;e<this.childViews.length;e++)this.childViews[e].updateView()}};var Y={GAME_VIEW_CONTAINER:"gameViewContainer",GAME_VIEW_OVERLAY_CONTAINER:"gameViewOverlayContainer",GAME_SKILL_TOGGLE_CONTAINER:"gameSkillToggleContainer",GAME_CANVAS:"gameCanvas",SKILL_TREE_GRAPH:"skillTreeGraph",CENTER_ON_CHARACTER_BUTTON:"centerOnCharacterButton",AUTO_PLAY_BUTTON:"autoPlayButton",ACTIVE_SKILLS_PANEL:"activeSkillsPanel",ACTIVE_BONUSES_PANEL:"activeBonusesPanel",PRIMARY_UPGRADE_PANEL:"primaryUpgradePanel",PRIMARY_UPGRADE_PANEL_TAB_BAR:"primaryUpgradePanelTabBar",UPGRADE_TAB_MENU_ITEM_CREW:"crewUpgradesMenuItem",SKILL_TREE_TAB_MENU_ITEM:"skillTreeMenuItem",FREE_UPGRADES_PANEL:"freeUpgradesPanel",MINED_UPGRADES_PANEL:"minedUpgradesPanel",PICK_UPGRADES_PANEL:"pickUpgradesPanel",GOLD_UPGRADES_PANEL:"goldUpgradesPanel",BONUS_PANEL:"bonusPanel",POINT_UPGRADES_PANEL:"pointUpgradesPanel",CREW_UPGRADES_PANEL:"crewUpgradesPanel",SKILL_SELECTION_PANEL:"skillSelectionPanel",SKILL_TREE_PANEL:"skillTreePanel",MENU_PANEL:"menuPanel",CREW_TAB_UPGRADE_COLLECTION:"upgradeCollection",CREW_PICK_UPGRADE_CONTENTS:"pickUpgradeBody",MINE_DAMAGE_VIEW:"mineDamageDisplay",MAX_DEPTH_VIEW:"maxDepth",MAX_LAYER_VIEW:"maxLayer",CURRENT_LAYER_VIEW:"currentLayer",CREW_MODE_VIEW:"crewMode",CURRENCY_VIEW:"currencyView",PRESTIGE_POPUP:"prestigePopup",OFFLINE_POPUP:"offlinePopup",STATISTICS_POPUP:"statisticsPopup",SAVE_POPUP:"savePopup",CLOSE_SKILL_TREE_POPUP:"closeSkillTree",PERFORMANCE_POPUP:"performancePopup",GAME_OPTIONS_POPUP:"gameOptionsPopup",VERSION_POPUP:"versionPopup"};var Ji=class{constructor(){this.firstMovement=!0,this.leftMouseDown=!1,this.prevMouseX=0,this.prevMouseY=0,this.mouseX=0,this.mouseY=0,this.mouseDeltaX=0,this.mouseDeltaY=0,this.mouseDownTime=0,this.mouseDownX=0,this.mouseDownY=0,this.leftMouseClick=!1,this.clickX=0,this.clickY=0,this.mouseWheelMotion=0,this.mouseMoved=!1}attachListeners(e,t){let i=this;t.onmouseover=function(r){return t.focus(),i.mouseX=r.clientX,i.mouseY=r.clientY,!1},t.onmouseout=function(r){i.leftMouseDown=!1,i.mouseX=r.clientX,i.mouseY=r.clientY,i.firstMovement=!0},e&&(e.onmouseout=function(r){i.leftMouseDown=!1,i.mouseX=r.clientX,i.mouseY=r.clientY,i.firstMovement=!0}),t.addEventListener("mousewheel",function(r){return i.mouseWheelMotion=-(r.wheelDelta||r.detail),!1},!1),t.addEventListener("DOMMouseScroll",function(r){return i.mouseWheelMotion=r.wheelDelta||r.detail,!1},!1),t.onmousedown=function(r){return i.mouseX=r.clientX,i.mouseY=r.clientY,i.prevMouseX=r.clientX,i.prevMouseY=r.clientY,i.mouseMoved=!1,i.mouseDeltaX=0,i.mouseDeltaY=0,i.mouseDownX=r.clientX,i.mouseDownY=r.clientY,i.mouseDownTime=Date.now(),(r.button===0||r.button===1)&&(i.leftMouseDown=!0),!1},t.onmouseup=function(r){if(i.mouseX=r.clientX,i.mouseY=r.clientY,i.mouseDeltaX=i.mouseX-i.prevMouseX,i.mouseDeltaY=i.mouseY-i.prevMouseY,i.prevMouseX=i.mouseX,i.prevMouseY=i.mouseY,r.button===0||r.button===1){i.leftMouseDown=!1;let s=i.mouseX-i.mouseDownX,o=i.mouseY-i.mouseDownY;Math.abs(s)<5&&Math.abs(o)<5&&Date.now()-i.mouseDownTime<250&&(i.leftMouseClick=!0,i.clickX=r.clientX,i.clickY=r.clientY)}return!1},t.onmousemove=function(r){return i.onMouseMove(r.clientX,r.clientY),!1}}onMouseMove(e,t){this.mouseX=e,this.mouseY=t,this.mouseMoved=!0,this.firstMovement?this.firstMovement=!1:(this.mouseDeltaX+=this.mouseX-this.prevMouseX,this.mouseDeltaY+=this.mouseY-this.prevMouseY),this.prevMouseX=this.mouseX,this.prevMouseY=this.mouseY}resetInputState(){this.leftMouseClick=!1,this.mouseWheelMotion=0,this.mouseDeltaX=0,this.mouseDeltaY=0,this.mouseMoved=!1}};var Gn=class extends G{constructor(e,t,i){super(e,Y.GAME_CANVAS),this.canvas=null,this.context=null,this.userInput=i,this.projection=t.projection,this.sprites=t.sprites,this.tileDamageSpriteOverlay=this.sprites.tileDamageSpriteOverlay,this.oreSpriteOverlay=this.sprites.oreSpriteOverlay,this.upgradeSpriteOverlay=this.sprites.tileSpriteOverlaySpritesheet.upgradeSpriteOverlay,this.crew=t.crew,this.partyTarget=t.partyTarget,this.state=t,this.worldGrid=t.worldGrid,this.targetList=t.targetList,this.infoTextProcessor=t.infoTextProcessor,this.spriteSize=0,this.scaledSize=0,this.screenCoordinate=new P(0,0),this.screenCoordinate2=new P(0,0),this.worldCoordinate=new P(0,0),this.tileHealthNum=new c(0),this.crewBrain=t.crewBrain;let r=this;this.renderRegionBorderDebugCallback=s=>{s.targetListNumber==this.targetList.targetListNumber&&r.renderRegionBorder(s)},this.renderTilesCallback=s=>{r.renderTile(s)},this.renderWireframeTilesCallback=s=>{r.renderTileWireframe(s)},this.renderMonstersCallback=s=>{r.renderMonsterCharacters(s)}}initializeView(){let e=d.getElement(this.parentId);this.canvas=d.createElement("canvas",e,Y.GAME_CANVAS,"game-canvas"),this.context=this.canvas.getContext("2d"),this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.userInput.attachListeners(document,this.canvas),this.projection.setCanvas(this.canvas),this.setInitialVisibility(!0),super.initializeView()}getCanvas(){return this.canvas}updateViewContents(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.font="12pt helvetica",this.context.imageSmoothingEnabled=!1,K.startTime("Render-total"),this.renderWorld(),K.endTime("Render-total")}renderWorld(){this.spriteSize=this.sprites.tileSpritesheet.spriteSize,this.scaledSize=this.spriteSize*this.projection.zoom,K.startTime("Render-blocks"),this.state.gameOptions.wireframeModeEnabled?ie.allVisibleTiles(this.worldGrid,this.projection,this.renderWireframeTilesCallback):ie.allVisibleTiles(this.worldGrid,this.projection,this.renderTilesCallback),K.endTime("Render-blocks"),this.renderInfoText(),ie.allVisibleGrids(this.worldGrid,this.projection,this.renderMonstersCallback),this.state.gameOptions.crewBrainDebugEnabled&&(this.renderRegionBordersDebug(),this.renderTargetListTargets()),this.state.gameOptions.depthColumnRendered&&this.renderTileDepths(),this.state.gameOptions.effectsRenderingEnabled&&(K.startTime("Render-effects"),this.renderEffects(),this.renderSkills(),K.endTime("Render-effects")),K.startTime("Render-crew"),this.renderCrew(),K.endTime("Render-crew"),this.state.gameOptions.crewBrainDebugEnabled&&this.renderPaths(),this.state.gameOptions.displayFps&&(this.context.fillStyle="#FFFA",this.context.fillText("FPS: "+this.state.currentFps,270,this.canvas.height-100))}renderPaths(){let e=this.crew.miners;for(let t=0;t<e.length;t++)this.renderPath(e[t])}renderPath(e){if(e.position.tile&&!(e.position.pathPlan.length<2)){this.context.strokeStyle="#F834",this.context.lineWidth=4,this.context.beginPath();for(let t=0;t<e.position.pathPlan.length;t++){let i=e.position.pathPlan[t];this.screenCoordinate.copy(i.startTile.origin),this.screenCoordinate.addXY(n.tile.halfSize,n.tile.halfSize),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.context.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),this.screenCoordinate.copy(i.endTile.origin),this.screenCoordinate.addXY(n.tile.halfSize,n.tile.halfSize),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.context.lineTo(this.screenCoordinate.x,this.screenCoordinate.y)}this.context.stroke()}}renderCrew(){let e=this.crew.miners;this.spriteSize=this.sprites.itemOverlaySpritesheet.spriteSize,this.scaledSize=this.spriteSize*this.projection.zoom;for(let t=0;t<e.length;t++)this.renderThruster(e[t]);this.spriteSize=this.sprites.tileSpritesheet.spriteSize,this.scaledSize=this.spriteSize*this.projection.zoom;for(let t=0;t<e.length;t++)this.renderCharacter(e[t],!1);this.spriteSize=this.sprites.itemOverlaySpritesheet.spriteSize,this.scaledSize=this.spriteSize*this.projection.zoom;for(let t=0;t<e.length;t++)this.renderItemOverlay(e[t])}renderInfoText(){let e=this.infoTextProcessor.infoTextArray;if(e.length!==0){this.context.fillStyle="white";for(let t=0;t<e.length;t++){let i=e[t];this.context.fillText(i.text,i.textX,i.textY)}}}renderRegionBordersDebug(){if(!this.state.targetList.centerTile)return;let e=this.state.targetList.centerTile.origin,t=25*n.tile.size;ie.allNearbyRegions(this.worldGrid,this.projection,e,t,this.renderRegionBorderDebugCallback)}renderRegionBorder(e){this.screenCoordinate.copy(e.origin),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.screenCoordinate2.copy(e.origin),this.screenCoordinate2.addXY(n.grid.regionPixelWidth,n.grid.regionPixelHeight),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2);let t=Math.abs(this.screenCoordinate2.x-this.screenCoordinate.x),i=Math.abs(this.screenCoordinate2.y-this.screenCoordinate.y);this.context.strokeStyle="#22222288",this.context.lineWidth=2,this.context.strokeRect(this.screenCoordinate.x,this.screenCoordinate.y,t,i)}renderTargetListTargets(){this.context.fillStyle="#FF0000",this.renderTargetList(this.targetList.priorityMiningCandidates),this.context.fillStyle="#FF00FF",this.renderTargetList(this.targetList.commonMiningCandidates);for(let r=0;r<this.crew.miners.length;r++){let s=this.crew.miners[r],o=s.target.targetTile,a=s.target.mineTile;this.renderMineTarget(s.position.tile,o,a)}let e=this.targetList.centerTile;e&&(this.screenCoordinate.copy(e.origin),this.screenCoordinate.addXY(4,4),this.screenCoordinate2.copy(e.origin),this.screenCoordinate2.addXY(n.tile.size-4,n.tile.size-4),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),this.context.fillStyle="#FFFFFF",this.context.fillRect(this.screenCoordinate.x,this.screenCoordinate.y,this.screenCoordinate2.x-this.screenCoordinate.x,this.screenCoordinate2.y-this.screenCoordinate.y));let t=this.crew.centerTile;t&&(this.screenCoordinate.copy(t.origin),this.screenCoordinate.addXY(4,4),this.screenCoordinate2.copy(t.origin),this.screenCoordinate2.addXY(n.tile.size-4,n.tile.size-4),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),this.context.fillStyle="#00FFFF",this.context.fillRect(this.screenCoordinate.x,this.screenCoordinate.y,this.screenCoordinate2.x-this.screenCoordinate.x,this.screenCoordinate2.y-this.screenCoordinate.y));let i=this.targetList.destinationTileCandidates;if(i.length>0){this.context.strokeStyle="#FF02",this.context.lineWidth=2;for(let r=0;r<i.length;r++){let s=i[r];if(!s)break;this.screenCoordinate.copy(s.origin),this.screenCoordinate.addXY(4,4),this.screenCoordinate2.copy(s.origin),this.screenCoordinate2.addXY(n.tile.size-4,n.tile.size-4),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),this.context.strokeRect(this.screenCoordinate.x,this.screenCoordinate.y,this.screenCoordinate2.x-this.screenCoordinate.x,this.screenCoordinate2.y-this.screenCoordinate.y)}}this.context.fillStyle="#888",this.context.fillText("瓷砖生命值: "+(this.state.mineControl.debugTileHealthNegligible?"negligible":"normal"),250,this.canvas.height-280),this.context.fillText("高级块: "+(this.state.mineControl.debugIgnorePriority?"ignored":"targeted"),250,this.canvas.height-260),this.context.fillText("普通块: "+(this.state.mineControl.debugIgnoreCommon?"ignored":"targeted"),250,this.canvas.height-240),this.context.fillText("目标描述: "+this.state.mineControl.debugGoalDescription,250,this.canvas.height-220)}renderMineTarget(e,t,i){e&&(i&&(this.screenCoordinate.copy(i.origin),this.screenCoordinate.addXY(n.tile.quarterSize+2,n.tile.quarterSize+2),this.screenCoordinate2.copy(i.origin),this.screenCoordinate2.addXY(n.tile.threeQuarterSize-2,n.tile.threeQuarterSize-2),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),this.context.fillStyle="#4444FF",this.context.fillRect(this.screenCoordinate.x,this.screenCoordinate.y,this.screenCoordinate2.x-this.screenCoordinate.x,this.screenCoordinate2.y-this.screenCoordinate.y)),t&&(this.screenCoordinate.copy(t.origin),this.screenCoordinate.addXY(n.tile.quarterSize+2,n.tile.quarterSize+2),this.screenCoordinate2.copy(t.origin),this.screenCoordinate2.addXY(n.tile.threeQuarterSize-2,n.tile.threeQuarterSize-2),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),this.context.fillStyle="#FF4444",this.context.fillRect(this.screenCoordinate.x,this.screenCoordinate.y,this.screenCoordinate2.x-this.screenCoordinate.x,this.screenCoordinate2.y-this.screenCoordinate.y),this.renderLineDebug(e,t,"#AAF4")))}renderLineDebug(e,t,i){this.context.strokeStyle=i,this.context.lineWidth=4,this.context.beginPath(),this.screenCoordinate.copy(e.origin),this.screenCoordinate.addXY(n.tile.halfSize,n.tile.halfSize),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.context.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),this.screenCoordinate.copy(t.origin),this.screenCoordinate.addXY(n.tile.halfSize,n.tile.halfSize),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.context.lineTo(this.screenCoordinate.x,this.screenCoordinate.y),this.context.stroke()}renderTargetList(e){for(let t=0;t<e.length;t++){let i=e[t];this.screenCoordinate.copy(i.origin),this.screenCoordinate.addXY(n.tile.quarterSize,n.tile.quarterSize),this.screenCoordinate2.copy(i.origin),this.screenCoordinate2.addXY(n.tile.threeQuarterSize,n.tile.threeQuarterSize),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),this.context.fillRect(this.screenCoordinate.x,this.screenCoordinate.y,this.screenCoordinate2.x-this.screenCoordinate.x,this.screenCoordinate2.y-this.screenCoordinate.y)}}renderGridBorders(){this.context.strokeStyle="#11111122",this.context.lineWidth=1;let e=this.spriteSize*this.projection.zoom*n.grid.gridTileWidth,t=this.worldGrid.grids;for(let i=0;i<t.length;i++){let r=t[i];this.projection.isVisibleGridBox(r)&&(this.projection.worldToScreen(r.origin,this.screenCoordinate),this.context.strokeRect(this.screenCoordinate.x,this.screenCoordinate.y,e,e))}}renderTileDepths(){this.context.fillStyle="#22222211",this.context.fillRect(0,0,190,this.canvas.height);let t=this.worldGrid.findGridTile(this.projection.gridCenter);if(!t)return;this.context.fillStyle="#666666FF";let i=t;for(this.renderTileDepth(i),this.renderTileHealth(i),i=t.getNeighborTop();i&&this.projection.isVisibleGridBox(i);)this.renderTileDepth(i),this.renderTileHealth(i),i=i.getNeighborTop();for(i=t.getNeighborBottom();i&&this.projection.isVisibleGridBox(i);)this.renderTileDepth(i),this.renderTileHealth(i),i=i.getNeighborBottom();this.context.fillStyle="#111111EE",this.context.fillRect(0,this.canvas.height-30,190,30),this.context.fillStyle="#666666FF",this.context.fillText("深度",5,this.canvas.height-10),this.context.fillText("生命值",100,this.canvas.height-10)}renderTileDepth(e){let i=e.getTileRow();i===this.partyTarget.targetRow?(this.screenCoordinate.copy(e.origin),this.screenCoordinate.y+=n.tile.size,this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.context.fillStyle="#FF8822FF",this.context.fillRect(0,this.screenCoordinate.y,80,3),this.context.fillText(""+this.partyTarget.targetRow+" target",5,this.screenCoordinate.y-5)):i%5===0&&(this.screenCoordinate.copy(e.origin),this.screenCoordinate.y+=n.tile.size,this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.context.fillStyle="#666666FF",this.context.fillRect(0,this.screenCoordinate.y,80,2),this.context.fillText(""+i,5,this.screenCoordinate.y-5))}renderTileHealth(e){let t=e.getTileRow();if(t<0)return;this.screenCoordinate.copy(e.origin),this.screenCoordinate.y+=n.tile.size,this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),e.tileType.layerDescription.calculateTileHealth(t,this.tileHealthNum),this.context.fillStyle="#666666FF",this.context.fillText(L.formatBigNum(this.tileHealthNum),100,this.screenCoordinate.y-5)}renderMonsterCharacters(e){let t=e.characters;for(let i=0;i<t.length;i++)t[i].isMonster()&&this.renderCharacter(t[i],!0)}renderCharacter(e,t){let i=e.position.tile;if(!i||!this.projection.isVisible(e.position.worldCoordinateOrigin,n.tile.size))return;if(t){let s=i.lighting;if(t&&!s.everVisibleToCharacter||i.tileType.lightingSupported&&s.shadowColor.a===0)return}let r=e.getCharacterSprite();e.position.facingLeft?(this.projection.worldToScreen(e.position.worldCoordinateOrigin,this.screenCoordinate),this.renderSprite(r,this.screenCoordinate)):(this.worldCoordinate.copy(e.position.worldCoordinateOrigin),this.worldCoordinate.addXY(this.spriteSize,0),this.projection.worldToScreen(this.worldCoordinate,this.screenCoordinate),this.context.save(),this.context.translate(this.screenCoordinate.x,this.screenCoordinate.y),this.context.scale(-1,1),this.screenCoordinate.set(0,0),this.renderSprite(r,this.screenCoordinate),this.context.restore())}renderItemOverlay(e){this.projection.isVisible(e.position.worldCoordinateOrigin,n.tile.size)&&this.renderOverlaySprite(e,e.getItemOverlaySprite())}renderThruster(e){this.projection.isVisible(e.position.worldCoordinateOrigin,n.tile.size)&&this.renderOverlaySprite(e,e.getThrusterOverlaySprite())}renderOverlaySprite(e,t){t&&(e.position.facingLeft?(this.worldCoordinate.copy(e.position.worldCoordinateOrigin),this.worldCoordinate.subtractXY(n.tile.size,n.tile.size),this.projection.worldToScreen(this.worldCoordinate,this.screenCoordinate),this.renderSprite(t,this.screenCoordinate)):(this.worldCoordinate.copy(e.position.worldCoordinateOrigin),this.worldCoordinate.subtractXY(n.tile.size,n.tile.size),this.worldCoordinate.addXY(this.spriteSize,0),this.projection.worldToScreen(this.worldCoordinate,this.screenCoordinate),this.context.save(),this.context.translate(this.screenCoordinate.x,this.screenCoordinate.y),this.context.scale(-1,1),this.screenCoordinate.set(0,0),this.renderSprite(t,this.screenCoordinate),this.context.restore()))}renderTile(e){if(e){if(!e.tileType.lightingSupported)this.projection.worldToScreen(e.origin,this.screenCoordinate),e.open?this.renderSprite(e.backgroundSprite,this.screenCoordinate):this.renderSprite(e.sprite,this.screenCoordinate);else{let t=e.lighting;if(!t.everVisibleToCharacter)return;this.projection.worldToScreen(e.origin,this.screenCoordinate);let i=t.calculateShadowColor();if(i.a>0){if(e.open?(this.renderSprite(e.backgroundSprite,this.screenCoordinate),e.fixtureDescription&&(e.fixtureDescription.sprite||(e.fixtureDescription.sprite=this.sprites.staticFixtureSpritesheet.getSprite(e.fixtureDescription.spriteName)),this.renderSprite(e.fixtureDescription.sprite,this.screenCoordinate))):this.renderSprite(e.sprite,this.screenCoordinate),!e.open&&e.healthPercent!=100){let r=this.tileDamageSpriteOverlay.getDamageSprite(e);r&&(this.context.globalAlpha=.7,this.renderSprite(r,this.screenCoordinate),this.context.globalAlpha=1)}if(!e.open&&e.tileType.rarityModifier!==f.COMMON)if(e.tileType.rarityModifier===f.UPGRADE){let r=this.upgradeSpriteOverlay.getCurrentSpriteDefault();r&&this.renderSprite(r,this.screenCoordinate)}else{let r=this.oreSpriteOverlay.getOreSprite(e);r&&this.renderSprite(r,this.screenCoordinate)}i.a<1&&(this.context.fillStyle=i.getFillColor(),this.context.fillRect(this.screenCoordinate.x,this.screenCoordinate.y,this.scaledSize,this.scaledSize))}}this.state.gameOptions.crewBrainDebugEnabled&&this.renderTileDebug(e)}}renderTileWire(e,t){e&&(this.screenCoordinate.copy(e.origin),this.screenCoordinate.addXY(2,2),this.screenCoordinate2.copy(e.origin),this.screenCoordinate2.addXY(n.tile.size-2,n.tile.size-2),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),e.open?(this.context.strokeStyle=t,this.context.lineWidth=2,this.context.strokeRect(this.screenCoordinate.x,this.screenCoordinate.y,this.screenCoordinate2.x-this.screenCoordinate.x,this.screenCoordinate2.y-this.screenCoordinate.y)):(this.context.fillStyle=t,this.context.fillRect(this.screenCoordinate.x,this.screenCoordinate.y,this.screenCoordinate2.x-this.screenCoordinate.x,this.screenCoordinate2.y-this.screenCoordinate.y)))}renderTileWireframe(e){if(e){if(!e.tileType.lightingSupported)e.open?this.renderTileWire(e,e.tileType.openColor):this.renderTileWire(e,e.tileType.closedColor);else{if(!e.lighting.everVisibleToCharacter)return;e.open?this.renderTileWire(e,e.tileType.openColor):!e.open&&e.tileType.rarityModifier!==f.COMMON?e.tileType.rarityModifier===f.UPGRADE?this.renderTileWire(e,"#073f42"):e.tileType.rarityModifier===f.GOLD?this.renderTileWire(e,"#FFD700"):e.tileType.rarityModifier===f.ORE?this.renderTileWire(e,"#3d1b6d"):e.tileType.rarityModifier===f.RUBY?this.renderTileWire(e,"#cc1827"):e.tileType.rarityModifier===f.SILVER?this.renderTileWire(e,"#BBBBBB"):this.renderTileWire(e,"#AAF4"):this.renderTileWire(e,e.tileType.closedColor)}this.state.gameOptions.crewBrainDebugEnabled&&this.renderTileDebug(e)}}renderTileDebug(e){let t=this.targetList.targetListNumber,i=e.pathData.getMineScore(t);i!==ye.UNSET&&(this.screenCoordinate.copy(e.origin),this.screenCoordinate.addXY(n.tile.quarterSize,n.tile.quarterSize),this.screenCoordinate2.copy(e.origin),this.screenCoordinate2.addXY(n.tile.threeQuarterSize,n.tile.threeQuarterSize),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),i===ye.IN_RANGE_UNSEEN?this.context.fillStyle="#8665":i===ye.WORTHLESS&&(this.context.fillStyle="#8885"),this.context.fillRect(this.screenCoordinate.x,this.screenCoordinate.y,this.screenCoordinate2.x-this.screenCoordinate.x,this.screenCoordinate2.y-this.screenCoordinate.y))}renderSkills(){let e=this.state.skillTreeGraph.skills;for(let t=0;t<e.length;t++){let i=e[t];if(!i.isUnlocked())continue;let r=i.getRenderer();r&&r.renderSkill(this.context,this.projection)}}renderEffects(){this.renderSpriteEffects()}renderSpriteEffects(){let e=this.state.effectManager.spriteEffects;e.length!==0&&this.renderEffectList(e)}renderEffectList(e){for(let t=0;t<e.length;t++){let i=e[t];if(!i||i.isEffectFinished()||i.isNotStarted())continue;let r=i.getSprite();if(!r)continue;let s=i.getPosition();this.projection.isVisible(s,n.tile.size)&&(this.projection.worldToScreen(s,this.screenCoordinate),this.renderScaledSprite(r,this.screenCoordinate))}}renderScaledSprite(e,t){if(e){let i=e.getSize();this.context.drawImage(e.getImage(),e.spriteX,e.spriteY,i,i,t.x,t.y,this.scaledSize,this.scaledSize)}}renderSprite(e,t){e&&this.context.drawImage(e.getImage(),e.spriteX,e.spriteY,this.spriteSize,this.spriteSize,t.x,t.y,this.scaledSize,this.scaledSize)}};var Yh=-1,Qi=class extends G{constructor(e,t,i){super(e,t),this.bonus=i,this.mainElement=null,this.activeProgressElement=null,this.titleElement=null,this.descriptionElement=null,this.displayedTitle=null,this.displayedDescription=null,this.displayState=Yh}initializeView(){let e=this.getElementId(),t=d.getElement(this.parentId);if(!t){console.log("ActiveSkillView.initializeView() No parent element found! parentId="+this.parentId);return}this.mainElement=d.createElement("div",t,e,"active-skill-button-outer-active"),this.activeProgressElement=d.createElement("div",this.mainElement,null,"active-skill-panel-activated");let i=d.createElement("div",this.mainElement,null,"active-skill-button-body"),r=d.createElement("div",i,null,"icon-container"),s=d.createElement("div",i,null,"active-skill-title-description-container"),o=d.createElement("img",r,null,null);o.src=this.bonus.spriteFileName,this.titleElement=d.createElement("div",s,null,"skill-panel-row1-title"),this.titleElement.innerHTML="",this.descriptionElement=d.createElement("div",s,null,"skill-panel-row2-description"),this.descriptionElement.innerHTML="",this.setInitialVisibility(!0),super.initializeView()}updateViewContents(){let e=this.bonus.getTitle();e!==this.displayedTitle&&(this.displayedTitle=e,this.titleElement.innerHTML=e);let t=this.bonus.getDescription();t&&t!==this.displayedDescription&&(this.displayedDescription=t,this.descriptionElement&&(this.descriptionElement.innerHTML=t));let i=this.bonus.getActivationPercent();this.activeProgressElement.style.width=i+"%"}};var kn=class extends B{constructor(e,t){super(e,Y.ACTIVE_BONUSES_PANEL);let i=this.getElementId(),r=t.activeBonuses;for(let s=0;s<r.length;s++){let o=new Qi(i,i+"_"+s,r[s]);this.addView(o)}this.bonusCollection=t,this.displayedChangeCount=-1}initializeView(){let e=d.getElement(this.parentId);d.createElement("div",e,this.getElementId(),"active-skills-panel"),super.initializeView()}updateViewContents(){if(this.displayedChangeCount!==this.bonusCollection.activeChangeCount){this.displayedChangeCount=this.bonusCollection.activeChangeCount,console.log("-------------------------------"),console.log("active change count: "+this.bonusCollection.activeChangeCount),console.log("   active bonuses:  "+this.bonusCollection.activeBonuses.length),this.removeChildViewElements();let e=this.getElementId(),t=this.bonusCollection.activeBonuses;for(let i=0;i<t.length;i++){let r=new Qi(e,e+"_"+i,t[i]);this.addView(r),console.log("  adding view: "+t[i].id),r.initializeView()}}super.updateViewContents()}getVisibileDisplayValue(){return"flex"}};var Fn=class extends G{constructor(e,t,i){super(e,Y.CENTER_ON_CHARACTER_BUTTON),this.projection=t,this.panAnimation=i,this.setInitialVisibility(!1)}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,this.elementId,"center-on-character-button");t.style.display="none";let i=d.createElement("img",t,null,null);i.src="images/ui_center_button.png",i.title="Center on Crew";let r=this;t.onclick=function(){r.panAnimation.startAnimation()},super.initializeView()}updateView(){let e=!this.projection.stayCenteredOnCharacter&&!this.panAnimation.animating;e!==this.isViewVisible()&&this.setViewVisible(e),super.updateView()}};var Bn=class extends B{constructor(e,t,i,r){super(e,t),this.addView(new Fn(t,i,r))}initializeView(){let e=d.getElement(this.parentId);d.createElement("div",e,this.getElementId(),"bottom-row-button-container"),super.initializeView()}};var Vn=class extends G{constructor(e,t,i){super(e,e+"_base_ore"),this.damage=t,this.values=i,this.displayedBaseDamagePerTurn=new c(0),this.basePickDamageString=null,this.workingNum=new c(0),this.turnsPerSecond=new c(n.time.turnsPerSecond),this.baseAdditiveBody=null,this.setInitialVisibility(!0)}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,null,"mine-damage-panel-main-section"),i=d.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Base",this.baseAdditiveBody=d.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.baseDamagePerTurn;(!this.basePickDamageString||!e.equals(this.displayedBaseDamagePerTurn))&&(this.displayedBaseDamagePerTurn.copy(e),this.workingNum.copy(e),this.workingNum.mul(this.turnsPerSecond),this.basePickDamageString=L.formatBigNum(this.workingNum)+"/s",this.baseAdditiveBody.innerHTML=this.basePickDamageString),super.updateViewContents()}};var Un=class extends G{constructor(e,t){super(e,e+"_depth"),this.damage=t,this.displayedDamageMultiplier=new c(-10),this.bonusString=null,this.body=null,this.setInitialVisibility(!0)}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,this.getElementId(),"mine-damage-panel-main-section"),i=d.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Depth",this.body=d.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.depthDamageMultiplier;(!this.bonusString||!e.equals(this.displayedDamageMultiplier))&&(this.displayedDamageMultiplier.copy(e),this.bonusString=L.formatBigNum(e),this.body.innerHTML=this.bonusString),super.updateViewContents()}getVisibileDisplayValue(){return"inline-block"}};var zn=class extends G{constructor(e,t){super(e,e+"_gold"),this.damage=t,this.displayedGoldDamageMultiplier=new c(-1),this.goldBonusString=null,this.body=null,this.setInitialVisibility(!0)}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,this.getElementId(),"mine-damage-panel-main-section"),i=d.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Gold",this.body=d.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.goldDamageMultiplier;(!this.goldBonusString||!e.equals(this.displayedGoldDamageMultiplier))&&(this.displayedGoldDamageMultiplier.copy(e),this.goldBonusString=L.formatBigNum(e),this.body.innerHTML=this.goldBonusString),super.updateViewContents()}getVisibileDisplayValue(){return"inline-block"}};var Hn=class extends G{constructor(e){super(e,null),this.setInitialVisibility(!0)}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,null,"mine-damage-panel-operator-section"),i=d.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML+="Mine";let r=d.createElement("div",t,null,"mine-damage-panel-section-body");r.innerHTML="Damage:",super.initializeView()}};var Wn=class extends G{constructor(e,t){super(e,e+"_multore"),this.damage=t,this.displayedBonus=new c(0),this.displayedValue=null,this.body=null,this.setInitialVisibility(!0)}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,null,"mine-damage-panel-main-section"),i=d.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Ore Multi",this.body=d.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.oreDamageMultiplier;(!this.displayedValue||!e.equals(this.displayedBonus))&&(this.displayedBonus.copy(e),this.displayedValue=L.formatBigNum(e),this.body.innerHTML=this.displayedValue),super.updateViewContents()}};var Yn=class extends G{constructor(e,t){super(e,e+"_ruby"),this.damage=t,this.displayedDamageMultiplier=new c(-1),this.damageBonusString=null,this.body=null,this.setInitialVisibility(!0)}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,this.getElementId(),"mine-damage-panel-main-section"),i=d.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Ruby",this.body=d.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.rubyDamageMultiplier;(!this.damageBonusString||!e.equals(this.displayedDamageMultiplier))&&(this.displayedDamageMultiplier.copy(e),this.damageBonusString=L.formatBigNum(e),this.body.innerHTML=this.damageBonusString),super.updateViewContents()}getVisibileDisplayValue(){return"inline-block"}};var je=class extends G{constructor(e,t,i){super(e,t),this.operator=i,this.setInitialVisibility(!0)}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,this.getElementId(),"mine-damage-panel-operator-section"),i=d.createElement("div",t,null,null);i.innerHTML+="&nbsp;";let r=d.createElement("div",t,null,null);r.innerHTML=this.operator,super.initializeView()}getVisibileDisplayValue(){return"inline-block"}};var Kn=class extends G{constructor(e,t){super(e,e+"_tot"),this.damage=t,this.displayedTotalDamage=new c(0),this.totalDamageString=null,this.workingNum=new c(0),this.turnsPerSecond=new c(n.time.turnsPerSecond),this.baseTotalBody=null,this.setInitialVisibility(!0)}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,null,"mine-damage-panel-main-section"),i=d.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Total Damage",this.baseTotalBody=d.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.totalPickDamagePerTurn;(!this.totalDamageString||!e.equals(this.displayedTotalDamage))&&(this.displayedTotalDamage.copy(e),this.workingNum.copy(e),this.workingNum.mul(this.turnsPerSecond),this.totalDamageString=L.formatBigNum(this.workingNum),this.baseTotalBody.innerHTML=this.totalDamageString+"/Sec")}};var Xn=class extends G{constructor(e,t){super(e,e+"_mined"),this.damage=t,this.displayedDamageMultiplier=new c(0),this.bonusString=null,this.body=null,this.setInitialVisibility(!0)}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,this.getElementId(),"mine-damage-panel-main-section"),i=d.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Mined",this.body=d.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.minedDamageMultiplier;(!this.bonusString||!e.equals(this.displayedDamageMultiplier))&&(this.displayedDamageMultiplier.copy(e),this.bonusString=L.formatBigNum(e),this.body.innerHTML=this.bonusString),super.updateViewContents()}getVisibileDisplayValue(){return"inline-block"}};var jn=class extends G{constructor(e,t){super(e,e+"_blocks"),this.damage=t,this.displayedDamageMultiplier=new c(-1),this.damageBonusString=null,this.body=null,this.setInitialVisibility(!0)}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,this.getElementId(),"mine-damage-panel-main-section"),i=d.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Blocks",this.body=d.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.blockDamageMultiplier;(!this.damageBonusString||!e.equals(this.displayedDamageMultiplier))&&(this.displayedDamageMultiplier.copy(e),this.damageBonusString=L.formatBigNum(e),this.body.innerHTML=this.damageBonusString),super.updateViewContents()}getVisibileDisplayValue(){return"inline-block"}};var Zn=class extends G{constructor(e,t){super(e,e+"_silver"),this.damage=t,this.displayedDamageMultiplier=new c(0),this.bonusString=null,this.body=null,this.setInitialVisibility(!0)}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,this.getElementId(),"mine-damage-panel-main-section"),i=d.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Silver",this.body=d.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.silverDamageMultiplier;(!this.bonusString||!e.equals(this.displayedDamageMultiplier))&&(this.displayedDamageMultiplier.copy(e),this.bonusString=L.formatBigNum(e),this.body.innerHTML=this.bonusString),super.updateViewContents()}getVisibileDisplayValue(){return"inline-block"}};var qn=class extends B{constructor(e,t,i,r){super(e,Y.MINE_DAMAGE_VIEW),this.one=new c(1),this.damage=t,this.minedDamageVisible=!1,this.silverDamageVisible=!1,this.goldDamageVisible=!1,this.depthDamageVisible=!1,this.rubyDamageVisible=!1,this.blocksDamageVisible=!1,this.addView(new Hn(this.elementId)),this.addView(new Vn(this.elementId,t,i)),this.addView(new je(this.elementId,this.elementId+"3"," x ")),this.addView(new Wn(this.elementId,t)),this.minedDamageOperator=new je(this.elementId,this.elementId+"6"," x "),this.minedDamageView=new Xn(this.elementId,t),this.addView(this.minedDamageOperator),this.addView(this.minedDamageView),this.minedDamageOperator.setInitialVisibility(!1),this.minedDamageView.setInitialVisibility(!1),this.silverOperator=new je(this.elementId,this.elementId+"7"," x "),this.silverDamageView=new Zn(this.elementId,t),this.addView(this.silverOperator),this.addView(this.silverDamageView),this.silverOperator.setInitialVisibility(!1),this.silverDamageView.setInitialVisibility(!1),this.goldOperator=new je(this.elementId,this.elementId+"8"," x "),this.goldDamageView=new zn(this.elementId,t),this.addView(this.goldOperator),this.addView(this.goldDamageView),this.goldOperator.setInitialVisibility(!1),this.goldDamageView.setInitialVisibility(!1),this.depthOperator=new je(this.elementId,this.elementId+"9"," x "),this.depthDamageView=new Un(this.elementId,t),this.addView(this.depthOperator),this.addView(this.depthDamageView),this.depthOperator.setInitialVisibility(!1),this.depthDamageView.setInitialVisibility(!1),this.rubyOperator=new je(this.elementId,this.elementId+"10"," x "),this.rubyDamageView=new Yn(this.elementId,t),this.addView(this.rubyOperator),this.addView(this.rubyDamageView),this.rubyOperator.setInitialVisibility(!1),this.rubyDamageView.setInitialVisibility(!1),this.blocksOperator=new je(this.elementId,this.elementId+"11"," x "),this.blocksDamageView=new jn(this.elementId,t),this.addView(this.blocksOperator),this.addView(this.blocksDamageView),this.blocksOperator.setInitialVisibility(!1),this.blocksDamageView.setInitialVisibility(!1),this.addView(new je(this.elementId,this.elementId+"12"," = ")),this.addView(new Kn(this.elementId,t)),this.setInitialVisibility(!0)}initializeView(){let e=d.getElement(this.parentId);d.createElement("div",e,this.getElementId(),"mine-damage-panel"),super.initializeView()}updateView(){let e=this.damage.minedDamageMultiplier.greaterThan(this.one),t=this.damage.silverDamageMultiplier.greaterThan(this.one),i=this.damage.goldDamageMultiplier.greaterThan(this.one),r=this.damage.depthDamageMultiplier.greaterThan(this.one),s=this.damage.rubyDamageMultiplier.greaterThan(this.one),o=this.damage.blockDamageMultiplier.greaterThan(this.one);this.minedDamageVisible!==e&&(this.minedDamageVisible=e,this.minedDamageOperator.setViewVisible(e),this.minedDamageView.setViewVisible(e)),this.silverDamageVisible!==t&&(this.silverDamageVisible=t,this.silverOperator.setViewVisible(t),this.silverDamageView.setViewVisible(t)),this.goldDamageVisible!==i&&(this.goldDamageVisible=i,this.goldOperator.setViewVisible(i),this.goldDamageView.setViewVisible(i)),this.depthDamageVisible!==r&&(this.depthDamageVisible=r,this.depthOperator.setViewVisible(r),this.depthDamageView.setViewVisible(r)),this.rubyDamageVisible!==s&&(this.rubyDamageVisible=s,this.rubyOperator.setViewVisible(s),this.rubyDamageView.setViewVisible(s)),this.blocksDamageVisible!==o&&(this.blocksDamageVisible=o,this.blocksOperator.setViewVisible(o),this.blocksDamageView.setViewVisible(o)),super.updateView()}getVisibileDisplayValue(){return"inline-block"}};var Jn=class extends B{constructor(e,t,i,r,s){super(e,t),this.addView(new qn(t,i,r,s))}initializeView(){let e=d.getElement(this.parentId);d.createElement("div",e,this.getElementId(),"bottom-row-damage"),super.initializeView()}};var Qn=class extends G{constructor(e,t){super(e,e+"_target"),this.partyTarget=t,this.displayedTargetRow=-10,this.baseBody=null,this.setInitialVisibility(!0)}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,null,"mine-damage-panel-main-section"),i=d.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Target Depth",this.baseBody=d.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.partyTarget.targetRow;this.displayedTargetRow!=e&&(this.displayedTargetRow=e,this.baseBody.innerHTML=L.formatNumber(e))}};var Ot=class extends G{constructor(e,t,i,r,s,o){super(e,t),this.mineControl=i,this.mineMode=r,this.topRowText=s,this.bottomRowText=o,this.mainElement=null,this.displayedActive=!1}initializeView(){let e=this.getElementId(),t=d.getElement(this.parentId);if(!t){console.log("MineModeOption.initializeView() No parent element found! parentId="+this.parentId);return}this.displayedActive=this.mineControl.activeMode===this.mineMode,this.mainElement=d.createElement("div",t,e,this.displayedActive?"mine-mode-button-outer-active":"mine-mode-button-outer-not-active");let i=d.createElement("div",this.mainElement,null,"mine-mode-button-row"),r=d.createElement("div",i,null,"icon-container"),s=d.createElement("img",r,null,"icon-container");s.src=b.pick;let o=d.createElement("div",i,null,"pick-upgrade-title-description-container"),a=d.createElement("div",o,null,null);a.innerHTML=this.topRowText;let h=d.createElement("div",o,null,"mined-upgrade-button-description");h.innerHTML=this.bottomRowText;let u=this;this.mainElement.onclick=function(){console.log("MineModeOption click mode="+u.mineMode.id),u.mineControl.setModeActive(u.mineMode)},super.initializeView()}updateViewContents(){let e=this.mineControl.activeMode===this.mineMode;this.displayedActive!==e&&(this.displayedActive=e,e?this.mainElement.className="mine-mode-button-outer-active":this.mainElement.className="mine-mode-button-outer-not-active")}getVisibileDisplayValue(){return"inline-block"}};var $n=class extends B{constructor(e,t,i){super(e,"mineControl"),this.addView(new Ot(this.elementId,this.elementId+"_up",t,he.MINE_SHALLOWER,"Mine","Shallower")),this.addView(new Ot(this.elementId,this.elementId+"_down",t,he.MINE_DEEPER,"Mine","Deeper")),this.addView(new Ot(this.elementId,this.elementId+"_current",t,he.MINE_CURRENT,"Mine","Current")),this.addView(new Ot(this.elementId,this.elementId+"_auto",t,he.MINE_AUTO,"Mine","Auto")),this.addView(new Qn(this.elementId,i))}initializeView(){let e=d.getElement(this.parentId);d.createElement("div",e,this.getElementId(),"mine-control-panel"),super.initializeView()}getVisibileDisplayValue(){return"inline-block"}};var ea=class extends B{constructor(e,t,i,r){super(e,t),this.addView(new $n(t,i,r))}initializeView(){let e=d.getElement(this.parentId);d.createElement("div",e,this.getElementId(),"bottom-row-mine-control"),super.initializeView()}};var ta=class extends B{constructor(e,t,i,r,s,o,a,h,u,m){super(e,t),this.addView(new ea(t,"bottomRowMineControl",o,s)),this.addView(new Jn(t,"bottomRowDamage",i,r,s)),this.addView(new Bn(t,"bottomRowButtonContainer",h,u))}initializeView(){let e=d.getElement(this.parentId);d.createElement("div",e,this.getElementId(),"bottom-row"),super.initializeView()}};var ia=class extends G{constructor(e){super(e,e+"_title")}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,null,"game-title-container"),i=d.createElement("div",t,null,"game-title-body"),r=d.createElement("div",i,null,"game-title-display");r.innerHTML="Mining";let s=d.createElement("div",i,null,"game-title-display");s.innerHTML="Crew",super.initializeView()}};var Ze=class extends G{constructor(e,t,i,r,s){super(e,t),this.title=i,this.iconFileName=r,this.totals=s,this.displayedDescription=null,this.valueElement=null,this.setInitialVisibility(!1)}initializeView(){let e=this.getElementId(),t=d.getElement(this.parentId);if(!t){console.log("CurrencyContainerSectionView.initializeView() No parent element found! parentId="+this.parentId);return}let i=d.createElement("div",t,e,"currency-container-section"),r=d.createElement("div",i,null,"currency-container-body"),s=d.createElement("div",r,null,"icon-container"),o=d.createElement("img",s,null,"icon-container");o.src=this.iconFileName;let a=d.createElement("div",r,this.elementId+"_text","mined-upgrade-title-description-container"),h=d.createElement("div",a,null,null);h.innerHTML=this.title,this.valueElement=d.createElement("div",a,null,"mined-upgrade-button-description"),this.valueElement.innerHTML="",this.setInitialVisibility(this.isCurrencyVisible()),super.initializeView()}updateView(){this.setViewVisible(this.isCurrencyVisible()),super.updateView()}getVisibileDisplayValue(){return"inline-block"}isCurrencyVisible(){return!0}};var ra=class extends Ze{constructor(e,t){super(e,e+"gold_section","Gold",b.currency.gold,t),this.displayedValue=new c(0),this.formattedValue=null}updateViewContents(){let e=this.totals.gold;(!this.formattedValue||!e.equals(this.displayedValue))&&(this.displayedValue.copy(e),this.formattedValue=L.formatBigNum(e),this.valueElement.innerHTML=this.formattedValue)}isCurrencyVisible(){return this.totals.goldSum.greaterThanZero()}};var sa=class extends Ze{constructor(e,t){super(e,e+"ruby_section","Ruby",b.currency.ruby,t),this.displayedValue=new c(0),this.formattedValue=null}updateViewContents(){let e=this.totals.ruby;(!this.formattedValue||!e.equals(this.displayedValue))&&(this.displayedValue.copy(e),this.formattedValue=L.formatBigNum(e),this.valueElement.innerHTML=this.formattedValue)}isCurrencyVisible(){return this.totals.ruby.greaterThanZero()}};var oa=class extends Ze{constructor(e,t){super(e,e+"ore_section","Ore",b.currency.ore,t),this.displayedValue=new c(0),this.formattedValue=null}updateViewContents(){let e=this.totals.ore;(!this.formattedValue||!e.equals(this.displayedValue))&&(this.displayedValue.copy(e),this.formattedValue=L.formatBigNum(e),this.valueElement.innerHTML=this.formattedValue)}};var na=class extends Ze{constructor(e,t){super(e,e+"silver_section","Silver",b.currency.silver,t),this.displayedValue=new c(0),this.formattedValue=null}updateViewContents(){let e=this.totals.silver;(!this.formattedValue||!e.equals(this.displayedValue))&&(this.displayedValue.copy(e),this.formattedValue=L.formatBigNum(e),this.valueElement.innerHTML=this.formattedValue)}isCurrencyVisible(){return this.totals.silverSum.greaterThanZero()}};var aa=class extends B{constructor(e,t){super(e,Y.CURRENCY_VIEW),this.addView(new oa(this.elementId,t)),this.addView(new na(this.elementId,t)),this.addView(new ra(this.elementId,t)),this.addView(new sa(this.elementId,t)),this.setInitialVisibility(!0)}initializeView(){let e=d.getElement(this.parentId);d.createElement("div",e,this.getElementId(),"currency-container-view"),super.initializeView()}getVisibileDisplayValue(){return"inline-block"}};var la=class extends B{constructor(e,t){super(e,e+"_one"),this.addView(new aa(this.elementId,t))}initializeView(){let e=d.getElement(this.parentId);d.createElement("div",e,this.getElementId(),"top-row-one"),super.initializeView()}};var ha=class extends G{constructor(e,t,i,r){super(e,t),this.partyTarget=i,this.statistics=r,this.displayedLayerDescription=null,this.mainElement=null,this.imgElement=null,this.titleElement=null,this.progressElement=null,this.displayedTitle=null,this.displayedDescription=null,this.descriptionElement=null,this.displayedIconFileName=null,this.displayPercent=-1,this.displayMaxDepth=-1}initializeView(){let e=this.getElementId(),t=d.getElement(this.parentId);if(!t){console.log("UnlockTerrainLayerView.initializeView() No parent element found! parentId="+this.parentId);return}this.mainElement=d.createElement("div",t,e,"terrain-layer-progress-outer");let i=d.createElement("div",this.mainElement,null,"mined-upgrade-button-body"),r=d.createElement("div",i,null,"icon-container"),s=d.createElement("div",i,this.elementId+"_text","mined-upgrade-title-description-container");this.imgElement=d.createElement("img",r,null,"icon-container"),this.imgElement.src=b.pick,this.titleElement=d.createElement("div",s,null,null),this.titleElement.innerHTML="",this.descriptionElement=d.createElement("div",s,null,"mined-upgrade-button-description"),this.descriptionElement.innerHTML="",this.progressElement=d.createElement("div",this.mainElement,null,"terrain-layer-progress-slider"),this.setInitialVisibility(!0),super.initializeView()}getVisibileDisplayValue(){return"inline-block"}generateDescription(){return"Depth: "+L.formatNumber(this.statistics.maxDepth)+" / "+L.formatNumber(this.displayedLayerDescription.maxDepth)}updateViewContents(){let e=this.partyTarget.layerDescription,t=this.statistics.maxDepth;if(this.displayedLayerDescription!==e||this.displayMaxDepth!=t){this.displayedLayerDescription=e,this.displayMaxDepth=t;let s=e.nominalIndex;if(s>0){let o=Me[Me.length-1];this.titleElement.innerHTML=e.name+" ("+s+"/"+o.nominalIndex+")"}else this.titleElement.innerHTML=e.name;this.descriptionElement.innerHTML=this.generateDescription()}if(!this.displayedLayerDescription)return;let i=this.displayedLayerDescription.iconFileName;this.displayedIconFileName!==i&&(this.displayedIconFileName=i,this.imgElement.src="images/layers/"+i);let r=e.getDepthPercent(t);r!=this.displayPercent&&(this.displayPercent=r,r>=100?this.progressElement.style.width="0px":this.progressElement.style.width=r+"%")}};var da=class extends B{constructor(e,t,i){super(e,e+"_layer"),this.addView(new ha(this.elementId,this.elementId+"_progress",t,i))}initializeView(){let e=d.getElement(this.parentId);d.createElement("div",e,this.getElementId(),"top-row-two"),super.initializeView()}};var ua=class extends B{constructor(e,t,i,r){super(e,e+"_panel"),this.addView(new la(this.elementId,t)),this.addView(new da(this.elementId,i,r))}initializeView(){let e=d.getElement(this.parentId);d.createElement("div",e,this.getElementId(),"top-row-panel"),super.initializeView()}};var ca=class extends B{constructor(e,t,i,r,s){super(e,t),this.addView(new ia(t)),this.addView(new ua(t,i,r,s))}initializeView(){let e=d.getElement(this.parentId);d.createElement("div",e,this.getElementId(),"top-row"),super.initializeView()}};var ma=class{constructor(){this.popupViews=[],this.popupById={}}addPopupView(e){this.popupViews.push(e),this.popupById[e.getElementId()]=e}isPopupVisible(e){let t=this.popupById[e];return t?t.isViewVisible():(console.log("PopupViewController.isPopupVisible() UNKNOWN VIEW. viewId="+e),!1)}setPopupVisible(e){for(let t=0;t<this.popupViews.length;t++){let i=this.popupViews[t];i.setViewVisible(i.getElementId()===e)}}setDoublePopupVisible(e,t){for(let i=0;i<this.popupViews.length;i++){let r=this.popupViews[i];r.setViewVisible(r.getElementId()===e||r.getElementId()===t)}}hideAllPopups(){for(let e=0;e<this.popupViews.length;e++)this.popupViews[e].setViewVisible(!1)}setPopupHidden(e){let t=this.popupById[e];if(!t){console.log("PopupViewController.setPopupHidden() UNKNOWN VIEW. viewId="+e);return}t.setViewVisible(!1)}};var ze=class extends G{constructor(e,t,i,r){super(e,t),this.title=i,this.gameOptions=r,this.mainElement=null,this.displayedEnabled=!1}initializeView(){let e=this.getElementId(),t=d.getElement(this.parentId);if(!t){console.log("GameOptionsToggle.initializeView() No parent element found! parentId="+this.parentId);return}this.mainElement=d.createElement("div",t,e,"upgrade-button-outer");let i=d.createElement("div",this.mainElement,null,"button-row-icon-text"),r=d.createElement("img",i,null,"pick-upgrade-icon");r.src=b.pick;let s=d.createElement("div",i,null,"pick-upgrade-title-description-container"),o=d.createElement("div",s,null,"pick-upgrade-button-title-single-row");o.innerHTML=this.title;let a=this;this.mainElement.onclick=function(){a.toggleEnabled()},super.initializeView()}updateViewContents(){let e=this.isEnabled();this.displayedEnabled!==e&&(this.displayedEnabled=e,e?this.mainElement.className="popup-toggle-button-outer-open":this.mainElement.className="upgrade-button-outer")}setEnabled(e){}isEnabled(){return!1}toggleEnabled(){}};var pa=class extends ze{constructor(e,t,i,r){super(e,t,i,r)}setEnabled(e){this.gameOptions.crewBrainDebugEnabled=e}isEnabled(){return this.gameOptions.crewBrainDebugEnabled}toggleEnabled(){this.gameOptions.crewBrainDebugEnabled=!this.gameOptions.crewBrainDebugEnabled}};var ga=class extends ze{constructor(e,t,i,r){super(e,t,i,r)}setEnabled(e){this.gameOptions.depthColumnRendered=e}isEnabled(){return this.gameOptions.depthColumnRendered}toggleEnabled(){this.gameOptions.depthColumnRendered=!this.gameOptions.depthColumnRendered}};var fa=class extends ze{constructor(e,t,i,r){super(e,t,i,r)}setEnabled(e){this.gameOptions.displayFps=e}isEnabled(){return this.gameOptions.displayFps}toggleEnabled(){this.gameOptions.displayFps=!this.gameOptions.displayFps}};var Ta=class extends ze{constructor(e,t,i,r){super(e,t,i,r)}setEnabled(e){this.gameOptions.effectsRenderingEnabled=e}isEnabled(){return this.gameOptions.effectsRenderingEnabled}toggleEnabled(){this.gameOptions.effectsRenderingEnabled=!this.gameOptions.effectsRenderingEnabled}};var Ea=class extends G{constructor(e,t,i){super(e,t),this.gameOptions=i,this.mainElement=null,this.option15=null,this.option30=null,this.option60=null,this.option120=null,this.optionNone=null,this.displayedMaxFps=-1e3}initializeView(){let e=this.getElementId(),t=d.getElement(this.parentId);if(!t){console.log("FpsThrottleSettingView.initializeView() No parent element found! parentId="+this.parentId);return}this.mainElement=d.createElement("div",t,e,"settings-row-outer");let i=d.createElement("div",this.mainElement,null,null);i.innerHTML="FPS Throttle";let r=d.createElement("div",this.mainElement,null,"settings-row-fps-throttle");this.option15=d.createElement("div",r,"option15","settings-row-toggle-button"),this.option15.innerHTML="15",this.option30=d.createElement("div",r,"option30","settings-row-toggle-button"),this.option30.innerHTML="30",this.option60=d.createElement("div",r,"option60","settings-row-toggle-button"),this.option60.innerHTML="60",this.option120=d.createElement("div",r,"option120","settings-row-toggle-button"),this.option120.innerHTML="120",this.optionNone=d.createElement("div",r,"optionNone","settings-row-toggle-button"),this.optionNone.innerHTML="None";let s=this;this.option15.onclick=function(){s.gameOptions.maxFps=16},this.option30.onclick=function(){s.gameOptions.maxFps=32},this.option60.onclick=function(){s.gameOptions.maxFps=64},this.option120.onclick=function(){s.gameOptions.maxFps=130},this.optionNone.onclick=function(){s.gameOptions.maxFps=-1},super.initializeView()}updateViewContents(){let e=this.gameOptions.maxFps;this.displayedMaxFps!==e&&(this.displayedMaxFps=e,this.option15.className=e===16?"settings-row-toggle-button-selected":"settings-row-toggle-button",this.option30.className=e===32?"settings-row-toggle-button-selected":"settings-row-toggle-button",this.option60.className=e===64?"settings-row-toggle-button-selected":"settings-row-toggle-button",this.option120.className=e===130?"settings-row-toggle-button-selected":"settings-row-toggle-button",this.optionNone.className=e===-1?"settings-row-toggle-button-selected":"settings-row-toggle-button"),super.updateViewContents()}};var Sa=class extends ze{constructor(e,t,i,r){super(e,t,i,r)}setEnabled(e){this.gameOptions.wireframeModeEnabled=e}isEnabled(){return this.gameOptions.wireframeModeEnabled}toggleEnabled(){this.gameOptions.wireframeModeEnabled=!this.gameOptions.wireframeModeEnabled}};var Ca=class extends B{constructor(e,t){super(e,Y.GAME_OPTIONS_POPUP),this.gameOptions=t,this.container=null,this.containerId="gameOptionsContainer",this.addView(new pa(this.containerId,this.containerId+"_brain","Crew Brain Debug",t)),this.addView(new fa(this.containerId,this.containerId+"_fps","Display FPS",t)),this.addView(new Ta(this.containerId,this.containerId+"_fx","Effect/Skill Rendering",t)),this.addView(new ga(this.containerId,this.containerId+"_depth","Depth Column Rendered",t)),this.addView(new Sa(this.containerId,this.containerId+"_wire","Wireframe Tiles",t)),this.addView(new Ea(this.containerId,this.containerId+"_throttle",t))}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,this.getElementId(),"popup-window-prestige"),i=d.createElement("div",t,null,null),r=d.createElement("div",i,null,"popup-window-header");r.innerHTML="Settings";let s=this;r.onclick=function(){return s.setViewVisible(!1),!1};let o=d.createElement("div",i,null,"menu-section-body");this.container=d.createElement("div",o,this.containerId,null),this.setInitialVisibility(!1),super.initializeView()}};var wa=class extends G{constructor(e,t,i){super(e,Y.OFFLINE_POPUP),this.totals=t,this.offlineLogic=i,this.container=null,this.offlineTimeInfo=null,this.goldEarnedInfo=null,this.oreEarnedInfo=null,this.rubyEarnedInfo=null,this.silverEarnedInfo=null,this.displayedGold=new c(-10),this.displayedOre=new c(-10),this.displayedRuby=new c(-10),this.displayedSilver=new c(-10),this.displayedOfflineSeconds=0,this.working=new c(0),this.one=new c(1)}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,this.getElementId(),"popup-window-prestige"),i=d.createElement("div",t,null,null),r=d.createElement("div",i,null,"popup-window-header");r.innerHTML="Offline Progress";let s=this;r.onclick=function(){return s.offlineLogic.claimOfflineEarnings(),s.setViewVisible(!1),!1};let o=d.createElement("div",i,null,"menu-section-body");this.container=d.createElement("div",o,null,null);let a=d.createElement("div",this.container,null,"offline-info");a.innerHTML="You have offline earnings!",this.offlineTimeInfo=d.createElement("div",this.container,null,"offline-info"),this.offlineTimeInfo.innerHTML="",this.oreEarnedInfo=d.createElement("div",this.container,null,"offline-info"),this.oreEarnedInfo.innerHTML="",this.silverEarnedInfo=d.createElement("div",this.container,null,"offline-info"),this.silverEarnedInfo.innerHTML="",this.goldEarnedInfo=d.createElement("div",this.container,null,"offline-info"),this.goldEarnedInfo.innerHTML="",this.rubyEarnedInfo=d.createElement("div",this.container,null,"offline-info"),this.rubyEarnedInfo.innerHTML="";let h=d.createElement("div",this.container,null,"save-popup-button-row"),u=d.createElement("div",h,"claimButton","game-button prestige-button");u.style.marginTop="10px",u.innerHTML="Claim Earnings",u.onclick=function(){return s.offlineLogic.claimOfflineEarnings(),s.setViewVisible(!1),!1},this.setInitialVisibility(!1),super.initializeView()}getGoldRate(){return this.getRate(this.totals.goldPerTurn)}getOreRate(){return this.getRate(this.totals.orePerTurn)}getRubyRate(){return this.getRate(this.totals.rubyPerTurn)}getSilverRate(){return this.getRate(this.totals.silverPerTurn)}getRate(e){return this.working.copy(e),this.working.mulNumber(n.time.turnsPerSecond),this.working.lessThan(this.one)?this.working.toNumber().toFixed(4)+" / second":L.formatBigNum(this.working)+" / second"}updateViewContents(){let e=this.totals.offlineGold,t=this.totals.offlineOre,i=this.totals.offlineRuby,r=this.totals.offlineSilver,s=this.totals.countedOfflineSeconds;this.displayedOfflineSeconds!==s&&(this.displayedOfflineSeconds=s,this.offlineTimeInfo.innerHTML="Offline time: "+Ue.formatElapsedTime(s*1e3)),this.displayedGold.equals(e)||(this.displayedGold.copy(e),this.goldEarnedInfo.innerHTML="Gold earned: "+L.formatBigNum(e)+" ("+this.getGoldRate()+")"),this.displayedOre.equals(t)||(this.displayedOre.copy(t),this.oreEarnedInfo.innerHTML="Ore earned: "+L.formatBigNum(t)+" ("+this.getOreRate()+")"),this.displayedRuby.equals(i)||(this.displayedRuby.copy(i),this.rubyEarnedInfo.innerHTML="Ruby earned: "+L.formatBigNum(i)+" ("+this.getRubyRate()+")"),this.displayedSilver.equals(r)||(this.displayedSilver.copy(r),this.silverEarnedInfo.innerHTML="Silver earned: "+L.formatBigNum(r)+" ("+this.getSilverRate()+")")}};var La=class extends G{constructor(e,t,i){super(e,t),this.performanceTrack=i,this.countSpan=null,this.averageSpan=null,this.totalSpan=null,this.displayedCount=-1,this.displayedAverage=-1,this.displayedTotal=-1}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,null,"performance-row"),i=d.createElement("span",t,null,null);i.innerHTML=this.performanceTrack.subject,this.countSpan=d.createElement("span",t,null,"performance-value"),this.countSpan.innerHTML="",this.averageSpan=d.createElement("span",t,null,"performance-value"),this.averageSpan.innerHTML="",this.totalSpan=d.createElement("span",t,null,"performance-value"),this.totalSpan.innerHTML="",this.setInitialVisibility(!0),super.initializeView()}updateViewContents(){let e=this.performanceTrack.count,t=this.performanceTrack.elapsed,i=e>0?t/e:0;this.displayedCount!=e&&(this.displayedCount=e,this.countSpan.innerHTML=L.formatNumber(e)),this.displayedAverage!=i&&(this.displayedAverage=i,this.averageSpan.innerHTML=L.formatNumber(i)),this.displayedTotal!=t&&(this.displayedTotal!=t,this.totalSpan.innerHTML=L.formatNumber(t)),super.updateViewContents()}};var _a=class extends B{constructor(e){super(e,Y.PERFORMANCE_POPUP),this.container=null,this.contentElement=null,this.displayedContent=null,this.prevTimestamp=Date.now()-1e3,this.currentKeys={}}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,this.getElementId(),"popup-window-prestige"),i=d.createElement("div",t,null,null),r=d.createElement("div",i,null,"popup-window-header");r.innerHTML="Performance Info";let s=this;r.onclick=function(){return s.setViewVisible(!1),!1};let o=d.createElement("div",i,null,"menu-section-body");this.container=d.createElement("div",o,null,null),this.contentElement=d.createElement("div",this.container,"performanceContent","offline-info");let a=d.createElement("div",this.contentElement,null,"performance-row"),h=d.createElement("span",a,null,null);h.innerHTML="Activity";let u=d.createElement("span",a,null,"performance-value");u.innerHTML="Count";let m=d.createElement("span",a,null,"performance-value");m.innerHTML="Ave Millis";let g=d.createElement("span",a,null,"performance-value");g.innerHTML="Tot Millis";let _=d.createElement("div",this.container,null,"save-popup-button-row"),C=d.createElement("div",_,"resetButton","game-button prestige-button");C.style.marginTop="10px",C.innerHTML="Reset",C.onclick=function(){return K.reset(),this.displayedContent=null,!1},this.setInitialVisibility(!1),super.initializeView()}updateViewContents(){let e=Date.now();if(e-this.prevTimestamp>1e3){this.prevTimestamp=e;let i=K.getKeys();for(let r=0;r<i.length;r++){let s=i[r];if(!this.currentKeys[s]){this.currentKeys[s]=!0;let o=K.getPerformanceTrack(s);if(o){let a=new La("performanceContent","performanceContent_"+r,o);this.addView(a),a.initializeView()}else console.log("PerformanceMetricsPopupView.updateViewContents() failed to find: "+s)}}}super.updateViewContents()}};var Ma=class extends G{constructor(e,t){super(e,Y.SAVE_POPUP),this.gameStateControl=t,this.setCurrentlyVisible(!0),this.setViewVisible(!1)}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,this.elementId,"popup-window-save"),i=d.createElement("div",t,null,null),r=d.createElement("div",i,null,"popup-window-header");r.innerHTML="Save Controls",r.onclick=function(){return Ee.setViewVisible(!1),!1};let s=d.createElement("div",i,null,"menu-section-body"),o=d.createElement("div",s,"saveButtonsContainer","save-popup-buttons-container"),a=d.createElement("div",o,"exportSaveButton","game-button");a.innerHTML="Export Save";let h=d.createElement("div",o,"importSaveButton","game-button");h.innerHTML="Import Save";let u=d.createElement("div",o,"resetGameButton","game-button");u.innerHTML="Reset Game";let m=d.createElement("div",o,"deleteSaveButton","game-button");m.innerHTML="Delete Save";let g=d.createElement("div",o,"teleportButton","game-button");g.innerHTML="Teleport Up 100 Rows";let _=d.createElement("div",o,"teleportButton","game-button");_.innerHTML="Teleport to Target Row";let C=d.createElement("div",s,"importContainer","save-popup-content-container");C.style.display="none";let w=d.createElement("div",C,null,null),T=d.createElement("textarea",w,"importTextArea","import-export-textarea");T.title="Paste exported save here and click import.";let S=d.createElement("div",w,null,"save-popup-button-row"),R=d.createElement("div",S,"importButtonActual","game-button save-button");R.innerHTML="Import";let y=d.createElement("div",S,"closeImportButton","game-button save-button");y.innerHTML="Close";let I=d.createElement("div",s,"exportContainer","save-popup-content-container");I.style.display="none";let N=d.createElement("div",I,null,null),D=d.createElement("textarea",N,"exportTextArea","import-export-textarea"),Q=d.createElement("div",I,null,"save-popup-button-row"),V=d.createElement("div",Q,"copyToClipboardButton","game-button save-button");V.style.width="130px",V.innerHTML="Copy to Clipboard";let ot=d.createElement("div",Q,"closeExportButton","game-button save-button");ot.innerHTML="Close";let De=d.createElement("div",s,"resetConfirmationContainer","save-popup-content-container");De.style.display="none";let He=d.createElement("div",De,null,null);He.style.padding="10px",He.innerHTML="Are you sure you want to reset? You will not lose your victory count.";let We=d.createElement("div",De,null,"save-popup-button-row"),ui=d.createElement("div",We,"resetButtonActual","game-button save-button");ui.innerHTML="Reset";let ci=d.createElement("div",We,"closeResetButton","game-button save-button");ci.innerHTML="Close";let _t=d.createElement("div",s,"deleteConfirmationContainer","save-popup-content-container");_t.style.display="none";let xt=d.createElement("div",_t,null,null);xt.style.padding="10px",xt.innerHTML="Are you sure you want to delete? You will lose everything and start over.";let Dt=d.createElement("div",_t,null,"save-popup-button-row"),mi=d.createElement("div",Dt,"deleteButtonActual","game-button save-button");mi.innerHTML="Delete";let pi=d.createElement("div",Dt,"closeDeleteButton","game-button save-button");pi.innerHTML="Close",this.setInitialVisibility(!1),super.initializeView();let Ee=this;this.saveTimeDiv=d.getElement("lastSaveTime"),this.displayedSaveTime=-1,a.onclick=function(){return Ee.displayExportSave(),!1},h.onclick=function(){return Ee.displayImportSave(),!1},y.onclick=function(){return Ee.closeImportContainer(),!1},R.onclick=function(){return Ee.handleImportSave(),!1},ot.onclick=function(){return Ee.closeExportContainer(),!1},V.onclick=function(){D.select(),navigator.clipboard.writeText(D.value).then(()=>{console.log("clipboard successfully set")},()=>{console.error("clipboard write failed")})},g.onclick=function(){return Ee.gameStateControl.getState().crew.teleportUpwards(100),!1},_.onclick=function(){let vt=Ee.gameStateControl.getState();return vt.crew.teleportToRow(vt.partyTarget.targetRow),!1},u.onclick=function(){return Ee.displayResetConfirmation(),!1},m.onclick=function(){return Ee.displayDeleteConfirmation(),!1},ui.onclick=function(){return Ee.handleGameReset(),!1},mi.onclick=function(){return Ee.handleGameDelete(),!1},ci.onclick=function(){return Ee.closeResetConfirmation(),!1},pi.onclick=function(){return Ee.closeDeleteConfirmation(),!1}}displayExportSave(){d.hideElementId("saveButtonsContainer"),d.showElementId("exportContainer");var e=d.getElement("exportTextArea");let t=this.gameStateControl.getState();e.value=t.saveManager.getSaveStateForExport(t)}displayImportSave(){d.hideElementId("saveButtonsContainer"),d.showElementId("importContainer"),d.showElementId("importButtonActual")}closeImportContainer(){var e=d.getElement("importTextArea");e.value="",d.hideElementId("importContainer"),d.showElementIdWithValue("saveButtonsContainer","grid")}closeExportContainer(){var e=d.getElement("exportTextArea");e.value="",d.hideElementId("exportContainer"),d.showElementIdWithValue("saveButtonsContainer","grid")}handleImportSave(){console.log("SavePopupView.handleImportSave()");let e=d.getElement("importTextArea").value;this.gameStateControl.importSave(e)}handleGameReset(){this.gameStateControl.resetGame()}handleGameDelete(){this.gameStateControl.deleteGame()}displayResetConfirmation(){d.hideElementId("saveButtonsContainer"),d.showElementId("resetConfirmationContainer")}displayDeleteConfirmation(){d.hideElementId("saveButtonsContainer"),d.showElementId("deleteConfirmationContainer")}closeResetConfirmation(){d.hideElementId("resetConfirmationContainer"),d.showElementIdWithValue("saveButtonsContainer","grid")}closeDeleteConfirmation(){d.hideElementId("deleteConfirmationContainer"),d.showElementIdWithValue("saveButtonsContainer","grid")}};var $i=class extends G{constructor(e,t,i,r){super(e,t),this.statistics=i,this.headerText=r,this.displayedSeconds=-1,this.displayedTotalOre=new c(-1),this.displayedTotalGold=new c(-1),this.displayedTotalRuby=new c(-1),this.displayedTotalSilver=new c(-1),this.displayedUpgradeOre=new c(-1),this.displayedMaxDepth=-1,this.displayedTilesMined=new c(-1),this.displayedTilesMinedCommon=new c(-1),this.displayedTilesMinedOre=new c(-1),this.displayedTilesMinedGold=new c(-1),this.displayedTilesMinedSilver=new c(-1),this.displayedTilesMinedRuby=new c(-1),this.displayedTilesMinedUpgrade=new c(-1),this.displayedTilesMinedLaser=new c(-1),this.displayedTilesMinedDrill=new c(-1),this.displayedTilesMinedOrbit=new c(-1),this.displayedTilesMinedMissile=new c(-1),this.totalTurnsElement=null,this.totalOreElement=null,this.totalGoldElement=null,this.totalRubyElement=null,this.totalSilverElement=null,this.upgradeOreElement=null,this.maxDepthElement=null,this.tilesMinedElement=null,this.tilesMinedCommonElement=null,this.tilesMinedOreElement=null,this.tilesMinedGoldElement=null,this.tilesMinedSilverElement=null,this.tilesMinedRubyElement=null,this.tilesMinedUpgradeElement=null,this.tilesMinedLaserElement=null,this.tilesMinedDrillElement=null,this.tilesMinedOrbitElement=null,this.tilesMinedMissileElement=null,this.setViewVisible(!1)}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,null,"stats-view"),i=d.createElement("div",t,null,"stats-header");i.innerHTML=this.headerText;let r=d.createElement("div",t,null,"menu-section-body");this.totalTurnsElement=this.createStatsSection(r,"Time","Time",!1),this.totalOreElement=this.createStatsSection(r,"Total Ore","Ore",!1),this.totalGoldElement=this.createStatsSection(r,"Total Gold","Gold",!1),this.totalRubyElement=this.createStatsSection(r,"Total Ruby","Ruby",!1),this.totalSilverElement=this.createStatsSection(r,"Total Silver","Silver",!1),this.maxDepthElement=this.createStatsSection(r,"Max Depth","Blocks",!1),this.upgradeOreElement=this.createStatsSection(r,"Upgrade Ore","Ore",!1),this.tilesMinedElement=this.createStatsSection(r,"Type: Any","Blocks",!0),this.tilesMinedCommonElement=this.createStatsSection(r,"Type: Common","Blocks",!1),this.tilesMinedOreElement=this.createStatsSection(r,"Type: Ore","Blocks",!1),this.tilesMinedGoldElement=this.createStatsSection(r,"Type: Gold","Blocks",!1),this.tilesMinedSilverElement=this.createStatsSection(r,"Type: Silver","Blocks",!1),this.tilesMinedRubyElement=this.createStatsSection(r,"Type: Ruby","Blocks",!1),this.tilesMinedUpgradeElement=this.createStatsSection(r,"Type: Upgrade","Blocks",!1),this.tilesMinedLaserElement=this.createStatsSection(r,"Skill: Laser","Blocks",!0),this.tilesMinedDrillElement=this.createStatsSection(r,"Skill: Drill","Blocks",!1),this.tilesMinedOrbitElement=this.createStatsSection(r,"Skill: Orbit","Blocks",!1),this.tilesMinedMissileElement=this.createStatsSection(r,"Skill: Missile","Blocks",!1),this.setInitialVisibility(!0),super.initializeView()}createStatsSection(e,t,i,r){let s=d.createElement("div",e,null,"numbers-section-row");r&&(s.style.marginTop="10px");let o=d.createElement("div",s,null,"numbers-section-label");o.innerHTML=t;let a=d.createElement("div",s,null,"numbers-section-unit");return a.innerHTML=i,d.createElement("div",s,null,"numbers-section-value")}updateViewContents(){let e=this.statistics.totalTurns*n.time.secondsPerTurn|0;this.displayedSeconds!==e&&(this.displayedSeconds=e,this.totalTurnsElement.innerHTML=Ue.formatElapsedTime(e*1e3));let t=this.statistics.totalOre;this.displayedTotalOre.equals(t)||(this.displayedTotalOre.copy(t),this.totalOreElement.innerHTML=L.formatBigNum(t));let i=this.statistics.totalGold;this.displayedTotalGold.equals(i)||(this.displayedTotalGold.copy(i),this.totalGoldElement.innerHTML=L.formatBigNum(i));let r=this.statistics.totalRuby;this.displayedTotalRuby.equals(r)||(this.displayedTotalRuby.copy(r),this.totalRubyElement.innerHTML=L.formatBigNum(r));let s=this.statistics.totalSilver;this.displayedTotalSilver.equals(s)||(this.displayedTotalSilver.compare(s),this.totalSilverElement.innerHTML=L.formatBigNum(s));let o=this.statistics.upgradeOre;this.displayedUpgradeOre.equals(o)||(this.displayedUpgradeOre.copy(o),this.upgradeOreElement.innerHTML=L.formatBigNum(o));let a=this.statistics.maxDepth;this.displayedMaxDepth!==a&&(this.displayedMaxDepth=a,this.maxDepthElement.innerHTML=L.formatNumber(a));let h=this.statistics.tilesMined;this.displayedTilesMined.equals(h)||(this.displayedTilesMined.copy(h),this.tilesMinedElement.innerHTML=L.formatBigNum(h));let u=this.statistics.tilesMinedCommon;this.displayedTilesMinedCommon.equals(u)||(this.displayedTilesMinedCommon.copy(u),this.tilesMinedCommonElement.innerHTML=L.formatBigNum(u));let m=this.statistics.tilesMinedOre;this.displayedTilesMinedOre.equals(m)||(this.displayedTilesMinedOre.copy(m),this.tilesMinedOreElement.innerHTML=L.formatBigNum(m));let g=this.statistics.tilesMinedGold;this.displayedTilesMinedGold.equals(g)||(this.displayedTilesMinedGold.copy(g),this.tilesMinedGoldElement.innerHTML=L.formatBigNum(g));let _=this.statistics.tilesMinedSilver;this.displayedTilesMinedSilver.equals(_)||(this.displayedTilesMinedSilver.copy(_),this.tilesMinedSilverElement.innerHTML=L.formatBigNum(_));let C=this.statistics.tilesMinedRuby;this.displayedTilesMinedRuby.equals(C)||(this.displayedTilesMinedRuby.copy(C),this.tilesMinedRubyElement.innerHTML=L.formatBigNum(C));let w=this.statistics.tilesMinedUpgrade;this.displayedTilesMinedUpgrade.equals(w)||(this.displayedTilesMinedUpgrade.copy(w),this.tilesMinedUpgradeElement.innerHTML=L.formatBigNum(w));let T=this.statistics.tilesMinedLaser;this.displayedTilesMinedLaser.equals(T)||(this.displayedTilesMinedLaser.copy(T),this.tilesMinedLaserElement.innerHTML=L.formatBigNum(T));let S=this.statistics.tilesMinedDrill;this.displayedTilesMinedDrill.equals(S)||(this.displayedTilesMinedDrill.copy(S),this.tilesMinedDrillElement.innerHTML=L.formatBigNum(S));let R=this.statistics.tilesMinedOrbit;this.displayedTilesMinedOrbit.equals(R)||(this.displayedTilesMinedOrbit.copy(R),this.tilesMinedOrbitElement.innerHTML=L.formatBigNum(R));let y=this.statistics.tilesMinedMissile;this.displayedTilesMinedMissile.equals(y)||(this.displayedTilesMinedMissile.copy(y),this.tilesMinedMissileElement.innerHTML=L.formatBigNum(y))}};var Ra=class extends B{constructor(e,t,i){super(e,e+"_container");let r=this.getElementId();this.addView(new $i(r,r+"_run",t,"Current Run Statistics")),this.addView(new $i(r,r+"_global",i,"Cumulative Statistics"))}initializeView(){let e=d.getElement(this.parentId);d.createElement("div",e,this.getElementId(),"stats-container"),this.setInitialVisibility(!0),super.initializeView()}getVisibileDisplayValue(){return"grid"}};var Aa=class extends B{constructor(e,t,i){super(e,Y.STATISTICS_POPUP),this.addView(new Ra(this.getElementId(),t,i))}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,this.getElementId(),"popup-window-statistics"),i=d.createElement("div",t,null,"popup-window-header");i.innerHTML="Statistics";let r=this;i.onclick=function(){return r.setViewVisible(!1),!1},this.setInitialVisibility(!1),super.initializeView()}};var Na=class extends G{constructor(e){super(e,Y.VERSION_POPUP),this.versions=[{name:"Update 16",date:"12 Oct 2025",bullets:["Removed prestige and fall mechanic.","Removed fall speed skill, removed prestige damage upgrades.","Prestige is completely removed (for now).","Prestige points replaced by silver block.","Upgrade skills by spending silver.","Reworked gold upgrades, removed OP damage upgrades.","Removed terrible skill tree UI, replaced with simpler button UI.","Mined upgrades are claimed automatically by default.","Rebalanced all skill damage upgrades and remaining gold upgrades.","Loads of small things that I don't remember"]},{name:"Update 15",date:"3 Oct 2025",bullets:["Fixed prestige timer reset on save load","Gold per block more expensive","Version / Release Notes view (this popup)"]},{name:"Update 14",date:"2 Oct 2025",bullets:["Gold upgrades are more expensive.","Figured out where the jittery motion when falling comes from.","Stopped saving grids during fast falling that will never be loaded again","Fixed issue where deepest layer was not appearing in the layer progress view."]},{name:"Update 13",date:"1 Oct 2025",bullets:["Added a bunch of gold upgrades including gold per block.","Fixed max speed of auto purchase/claim skills","Offline earnings included in the statistics.","Slightly improved wireframe rendering mode"]},{name:"Update 12",date:"30 Sept 2025",bullets:["Simplified auto prestige"]},{name:"Update 11",date:"30 Sept 2025",bullets:["Prestige 'Layer Clear Countdown' is 5 minutes instead of 10","Crew doesn't all start out on the same spot after prestige","Settings screen: enable/disable fps displayed on the screen","Settings screen: brain debug option moved to the settings screen","Settings screen: block health column rendered","Settings screen: skills/effects rendered","Settings screen: wireframe mode (render blocks as rectangles to lower GPU usage)","Settings screen: FPS throttle (15 fps, 30 fps, etc)"]},{name:"Update 10",date:"29 Sept 2025",bullets:["Tinkering with the laser to get it to fire more","Fixed null pointer bug reported by player","Doubled the value of the 'Mined Damage' bonus"]},{name:"Update 9",date:"29 Sept 2025",bullets:["Fixed another looping/stuck miner bug.","Added block damage skill (too OP?)","Missiles speed increases when fall speed is accelerated.","Popup window background color is darker to make things easier to read"]},{name:"Update 8",date:"29 Sept 2025",bullets:["Hopefully fixed 'cycle bug' where miner gets stuck in a loop.","Hopefully fixed 'pause and do nothing' bug where miners just sit there and do nothing","Added ruby upgrades"]},{name:"Update 7",date:"28 Sept 2025",bullets:["Reworked crew search area logic","Fall speed skill"]},{name:"Update 6",date:"20 Sept 2025",bullets:["Fix: Blocks destroyed by missiles can drop loot"]},{name:"Update 5",date:"20 Sept 2025",bullets:["Improvements to laser targeting logic","Missiles fire towards targets.","Path finding optimization","Miners aren't slowed when plowing through wimpy blocks","Missiles fly a little faster","On-screen debug text."]},{name:"Update 4",date:"16 Sept 2025",bullets:["Path optimization when blocks have very low health","Terrain save optimization","Crew focuses on going deeper when bloks are wimpy","Laser should be shooting at more stuff now."]},{name:"Update 3",date:"15 Sept 2025",bullets:["Fixed skill duration bug","Fixed sprite for Defective Cobalt layer.","Orbit: range is larger, fixed UI bug in skill tree.","Laser: tinkering w/ laser targeting logic","Offline earnings adjusted","Offline prestige earnings changed.","Crew Brain Debug View","Performance View","Depth damage multiplier bug on game reset.","Crew brain changes"]},{name:"Update 2",date:"13 Sept 2025",bullets:["Fixed offline earnings crash bug","Re-implemented how offline earnings are calculated","Offline earnings enabled by default","Offline support added for: ore, ruby","Narrower prestige popup window"]},{name:"Update 1",date:"11 Sept 2025",bullets:["Reduced rate at which block health increases per depth.","Mining a tile reveals more tiles in the direction of mining.","Unlocking 1st extra miner costs 1 prestige point instead of 2.","Minor improvements to character decision making.","Increased prestige damage bonus from 10% to 20%/prestige.","Slightly increased mined ore earnings."]},{name:"Initial Beta Release",date:"10 Sept 2025",bullets:["Yay"]}]}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,this.getElementId(),"popup-window-version"),i=d.createElement("div",t,null,null),r=d.createElement("div",i,null,"popup-window-header");r.innerHTML="Version";let s=this;r.onclick=function(){return s.setViewVisible(!1),!1};let o=d.createElement("div",i,null,"version-body");for(let a=0;a<this.versions.length;a++)this.addSection(o,this.versions[a]);this.setInitialVisibility(!1),super.initializeView()}addSection(e,t){let i=d.createElement("div",e,null,"version-section"),r=d.createElement("div",i,null,"version-section-top"),s=d.createElement("div",r,null,null);s.innerHTML=t.name;let o=d.createElement("div",r,null,"version-date");o.innerHTML=t.date;let a=d.createElement("div",i,null,null),h=d.createElement("ul",a,null,null);for(let u=0;u<t.bullets.length;u++){let m=d.createElement("li",h,null,null);m.innerHTML=t.bullets[u]}}};var Pa=class extends B{constructor(e,t,i,r,s,o,a,h,u){super(e,t),this.totals=s,this.popupViewController=u;let m=new Aa(t,i,r),g=new Ma(t,a),_=new wa(t,s,h),C=new Na(t),w=new Ca(t,o),T=new _a(t);u.addPopupView(m),u.addPopupView(g),u.addPopupView(_),u.addPopupView(C),u.addPopupView(w),u.addPopupView(T),this.addView(m),this.addView(g),this.addView(_),this.addView(C),this.addView(w),this.addView(T)}initializeView(){let e=d.getElement(this.parentId);d.createElement("div",e,this.getElementId(),"popup-container"),super.initializeView()}updateView(){this.totals.countedOfflineSeconds>0&&!this.popupViewController.isPopupVisible(Y.OFFLINE_POPUP)&&this.popupViewController.setPopupVisible(Y.OFFLINE_POPUP),super.updateView()}};var xe=class extends G{constructor(e,t,i){super(e,t),this.headerText=i,this.headerElement=null,this.setInitialVisibility(!0)}initializeView(){let e=d.getElement(this.parentId);if(!e){console.log("HeaderView.initializeView() No parent element found! parentId="+this.parentId);return}this.headerElement=d.createElement("div",e,this.elementId,"header-panel"),this.headerElement.innerHTML=this.headerText,super.initializeView()}};var Lt=class extends G{constructor(e,t,i,r,s){super(e,t),this.popupViewController=i,this.popupViewId=r,this.secondaryPopupViewId=null,this.title=s,this.mainElement=null,this.displayedVisible=!1}initializeView(){let e=this.getElementId(),t=d.getElement(this.parentId);if(!t){console.log("PopupViewToggle.initializeView() No parent element found! parentId="+this.parentId);return}this.mainElement=d.createElement("div",t,e,"upgrade-button-outer");let i=d.createElement("div",this.mainElement,null,"button-row-icon-text"),r=d.createElement("img",i,null,"pick-upgrade-icon");r.src=b.pick;let s=d.createElement("div",i,null,"pick-upgrade-title-description-container"),o=d.createElement("div",s,null,"pick-upgrade-button-title-single-row");o.innerHTML=this.title;let a=this;this.mainElement.onclick=function(){a.popupViewController.isPopupVisible(a.popupViewId)?a.popupViewController.hideAllPopups():a.secondaryPopupViewId?a.popupViewController.setDoublePopupVisible(a.popupViewId,a.secondaryPopupViewId):a.popupViewController.setPopupVisible(a.popupViewId)},super.initializeView()}updateViewContents(){let e=this.popupViewController.isPopupVisible(this.popupViewId);this.displayedVisible!==e&&(this.displayedVisible=e,e?this.mainElement.className="popup-toggle-button-outer-open":this.mainElement.className="upgrade-button-outer")}};var ya=class extends B{constructor(e,t){super(e,Y.MENU_PANEL),this.addView(new xe(this.elementId,this.elementId+"_header","Menu")),this.addView(new Lt(this.elementId,this.elementId+"_stats",t,Y.STATISTICS_POPUP,"Statistics View")),this.addView(new Lt(this.elementId,this.elementId+"_save",t,Y.SAVE_POPUP,"Save View")),this.addView(new Lt(this.elementId,this.elementId+"_version",t,Y.VERSION_POPUP,"Version / Release Notes")),this.addView(new Lt(this.elementId,this.elementId+"_options",t,Y.GAME_OPTIONS_POPUP,"Settings")),this.addView(new Lt(this.elementId,this.elementId+"_performance",t,Y.PERFORMANCE_POPUP,"Performance View (Dev tool)"))}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,this.elementId,null);t.style.display="none",this.setViewVisible(!1),this.setCurrentlyVisible(!0),super.initializeView()}};var st=class extends G{constructor(e,t,i,r,s){super(e,t),this.tabContentsView=i,this.tabContainerView=r,this.tabIconPath=s,this.tabItem=null}getVisibileDisplayValue(){return"inline-block"}initializeView(){let e=this,t=this.getElementId(),i=d.getElement(this.parentId);this.tabItem=d.createElement("button",i,t,"upgrade-tab-menu-item");let r=d.createElement("img",this.tabItem,null,"icon-container");r.src=this.tabIconPath,this.tabItem.onclick=function(){e.tabContainerView.onTabItemViewClicked(e)},this.setInitialVisibility(!0),super.initializeView()}setTabSelected(e){e?this.tabItem.className="upgrade-tab-menu-item-selected":this.tabItem.className="upgrade-tab-menu-item"}};var ba=class extends B{constructor(e){super(e,Y.PRIMARY_UPGRADE_PANEL_TAB_BAR),this.tabItemViews=[],this.setViewVisible(!0),this.setCurrentlyVisible(!1)}addTab(e){this.tabItemViews.push(e),this.addView(e)}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,this.getElementId(),"upgrade-tab-menu-bar");super.initializeView(),d.createElement("div",t,null,"upgrade-tab-menu-bar-fill-remaining"),this.tabItemViews.length>0&&this.onTabItemViewClicked(this.tabItemViews[0])}onTabItemViewClicked(e){for(let t=0;t<this.tabItemViews.length;t++){let i=this.tabItemViews[t],r=i===e;i.setTabSelected(r),i.tabContentsView.setViewVisible(r)}}getVisibileDisplayValue(){return"flex"}};var Ia=class extends G{constructor(e,t,i,r){super(e,t),this.headerText=i,this.automation=r,this.mainElement=null,this.activeProgressElement=null,this.titleElement=null,this.descriptionElement=null,this.displayedActive=r.active,this.displayedPercent=-1,this.setInitialVisibility(!0)}initializeView(){let e=d.getElement(this.parentId);if(!e){console.log("AutomationView.initializeView() No parent element found! parentId="+this.parentId);return}let t=this.automation.active?"automation-button-outer-active":"automation-button-outer-not-active";this.mainElement=d.createElement("div",e,this.elementId,t),this.activeProgressElement=d.createElement("div",this.mainElement,null,this.getProgressElementClassName());let i=d.createElement("div",this.mainElement,null,"active-skill-button-body"),r=d.createElement("div",i,null,"icon-container"),s=d.createElement("div",i,null,null),o=d.createElement("img",r,null,null);o.src=b.pick,this.titleElement=d.createElement("div",s,null,null),this.titleElement.innerHTML=this.headerText,this.descriptionElement=d.createElement("div",s,null,"skill-panel-row2-description"),this.descriptionElement.innerHTML=this.getDescription(),this.setInitialVisibility(!1);let a=this;this.mainElement.onclick=function(){a.automation.toggleActiveFlag()},super.initializeView()}getProgressElementClassName(){return"automation-progress-panel"}updateView(){let e=this.automation.isUnlocked();e!==this.isViewVisible()&&this.setViewVisible(e),super.updateView()}updateViewContents(){let e=this.automation.active;if(this.displayedActive!==e){this.displayedActive=e;let i=e?"automation-button-outer-active":"automation-button-outer-not-active";this.mainElement.className=i,this.descriptionElement.innerHTML=this.getDescription()}let t=this.automation.getActivationPercent();this.displayedPercent!==t&&(this.displayedPercent=t,this.activeProgressElement.style.width=t+"%")}getDescription(){return this.automation.active?"Active":"Not Active"}};var Oa=class extends G{constructor(e,t,i){super(e,t),this.upgradeCollection=i,this.purchaseOneButton=null,this.purchaseFiveButton=null,this.purchaseTenButton=null,this.purchaseMaxButton=null,this.displayedPurchaseCount=ue.purchaseOne,this.setCurrentlyVisible(!1),this.setViewVisible(!0)}getVisibileDisplayValue(){return"grid"}initializeView(){super.initializeView();let e=this.getElementId(),t=d.getElement(this.parentId);if(!t){console.log("CountToPurchaseView.initializeView() No element found! id="+e);return}let i=d.createElement("div",t,e,"purchase-count-button-container");this.purchaseOneButton=d.createElement("div",i,e+"_one","purchase-count-button-selected"),this.purchaseFiveButton=d.createElement("div",i,e+"_five","purchase-count-button"),this.purchaseTenButton=d.createElement("div",i,e+"_ten","purchase-count-button"),this.purchaseMaxButton=d.createElement("div",i,e+"_max","purchase-count-button"),this.purchaseOneButton.innerHTML="1",this.purchaseFiveButton.innerHTML="5",this.purchaseTenButton.innerHTML="10",this.purchaseMaxButton.innerHTML="Max";let r=this;this.purchaseOneButton.onclick=function(){r.upgradeCollection.setCountToPurchase(ue.purchaseOne)},this.purchaseFiveButton.onclick=function(){r.upgradeCollection.setCountToPurchase(ue.purchaseFive)},this.purchaseTenButton.onclick=function(){r.upgradeCollection.setCountToPurchase(ue.purchaseTen)},this.purchaseMaxButton.onclick=function(){r.upgradeCollection.setCountToPurchase(ue.purchaseMax)}}updateViewContents(){let e=this.upgradeCollection.countToPurchase;this.displayedPurchaseCount!==e&&(this.displayedPurchaseCount===ue.purchaseOne?this.purchaseOneButton.className="purchase-count-button":this.displayedPurchaseCount===ue.purchaseFive?this.purchaseFiveButton.className="purchase-count-button":this.displayedPurchaseCount===ue.purchaseTen?this.purchaseTenButton.className="purchase-count-button":this.displayedPurchaseCount===ue.purchaseMax&&(this.purchaseMaxButton.className="purchase-count-button"),e===ue.purchaseOne?this.purchaseOneButton.className="purchase-count-button-selected":e===ue.purchaseFive?this.purchaseFiveButton.className="purchase-count-button-selected":e===ue.purchaseTen?this.purchaseTenButton.className="purchase-count-button-selected":e===ue.purchaseMax&&(this.purchaseMaxButton.className="purchase-count-button-selected"),this.displayedPurchaseCount=e)}};var hi=class extends G{constructor(e,t,i,r){super(e,t),this.upgrade=i,this.displayDescriptionRow=r,this.mainElement=null,this.titleElement=null,this.descriptionElement=null,this.costElement=null,this.displayedCost=new c(-10),this.countElement=null,this.displayedCount=-10,this.displayedNextActualPurchaseCount=-10,this.displayedTitle=null,this.displayedDescription=null,this.displayedPurchasable=!this.upgrade.isPurchasable()}setClassicUpgrade(e){this.upgrade=e}initializeView(){let e=this.getElementId(),t=d.getElement(this.parentId);if(!t){console.log("PickUpgradeView.initializeView() No parent element found! parentId="+this.parentId);return}this.displayedPurchasable=this.upgrade.isPurchasable();let i=this.displayedPurchasable?"upgrade-button-outer":"upgrade-button-outer-not-purchasable";this.mainElement=d.createElement("div",t,e,i);let r=d.createElement("div",this.mainElement,null,"pick-upgrade-button-row1"),s=d.createElement("img",r,null,"pick-upgrade-icon");s.src=b.pick;let o=d.createElement("div",r,null,"pick-upgrade-title-description-container");this.displayDescriptionRow?(this.titleElement=d.createElement("div",o,null,null),this.descriptionElement=d.createElement("div",o,null,"pick-upgrade-button-description"),this.descriptionElement.innerHTML=""):this.titleElement=d.createElement("div",o,null,"pick-upgrade-button-title-single-row"),this.titleElement.innerHTML="";let a=d.createElement("div",r,null,null);this.countElement=d.createElement("div",a,null,"pick-upgrade-count"),this.costElement=d.createElement("div",a,null,"pick-upgrade-cost"),this.setInitialVisibility(this.upgrade.isVisible());let h=this;this.mainElement.onclick=function(){h.upgrade.isPurchasable()&&h.upgrade.purchase()},super.initializeView()}updateView(){this.setViewVisible(this.upgrade&&this.upgrade.isVisible()),super.updateView()}updateViewContents(){let e=this.upgrade.getCost(),t=this.upgrade.purchasedCount,i=this.upgrade.isPurchasable(),r=this.upgrade.getCountToPurchaseSetting(),s=this.upgrade.nextActualPurchaseCount;e.equals(this.displayedCost)||(this.displayedCost.copy(e),this.costElement.innerHTML=L.formatBigNum(e)+" "+this.upgrade.getCostUnit()),(t!==this.displayedCount||s!==this.displayedNextActualPurchaseCount)&&(this.displayedCount=t,this.displayedNextActualPurchaseCount=s,r===ue.purchaseOne?this.countElement.innerHTML=""+t:this.countElement.innerHTML=""+t+"+"+s);let o=this.upgrade.getTitle();if(o!==this.displayedTitle&&(this.displayedTitle=o,this.titleElement.innerHTML=o),this.displayDescriptionRow){let a=this.upgrade.getDescription();a&&a!==this.displayedDescription&&(this.displayedDescription=a,this.descriptionElement.innerHTML=a)}i!==this.displayedPurchasable&&(this.displayedPurchasable=i,i?this.mainElement.className="upgrade-button-outer":this.mainElement.className="upgrade-button-outer-not-purchasable")}};var di=class extends B{constructor(e,t,i){super(e,t),this.upgradeCollection=i,this.upgradeViews=[],this.idSequence=0;let r=this.upgradeCollection.upgrades;for(let s=0;s<r.length;s++){let o=r[s];if(!o||!o.isVisible())continue;let a=this.createUpgradeView(r[s]);this.upgradeViews.push(a),this.addView(a)}}getNextId(){return++this.idSequence}initializeView(){let e=d.getElement(this.parentId);d.createElement("div",e,this.elementId,null),super.initializeView()}updateViewContents(){let e=this.upgradeCollection.upgrades,t=0,i=0;for(;t<e.length&&i<this.upgradeViews.length;t++){let r=e[t];!r||!r.isVisible()||(this.upgradeViews[i].setClassicUpgrade(r),i++)}if(t<e.length)for(;t<e.length;t++){let r=e[t];if(!r||!r.isVisible())continue;let s=this.createUpgradeView(e[t]);this.upgradeViews.push(s),this.addView(s),s.initializeView()}else if(i<this.upgradeViews.length)for(;i<this.upgradeViews.length;i++)this.upgradeViews[i].setClassicUpgrade(null);super.updateViewContents()}createUpgradeView(e){return new hi(this.elementId,this.elementId+"_"+this.getNextId(),e,!1)}};var xa=class extends B{constructor(e,t,i,r){super(e,t),this.addView(new xe(this.elementId,this.elementId+"_header","Ore Upgrades")),this.addView(new di(this.elementId,this.elementId+"_upgrades",i)),this.addView(new xe(this.elementId,this.elementId+"_settings_header","Purchase Settings")),this.addView(new Oa(this.elementId,this.elementId+"_ctp",i)),this.addView(new Ia(this.elementId,this.elementId+"_auto","Auto Purchase",r))}initializeView(){let e=d.getElement(this.parentId),t=d.createElement("div",e,this.elementId,"primary-upgrade-panel-body");t.style.display="none",this.setViewVisible(!1),this.setCurrentlyVisible(!0),super.initializeView()}};var Da=class extends di{constructor(e,t,i){super(e,t,i)}createUpgradeView(e){return new hi(this.elementId,this.elementId+"_"+this.getNextId(),e,!0)}};var va=class extends B{constructor(e,t,i){super(e,t),this.addView(new xe(this.elementId,this.elementId+"_header","Gold Upgrades")),this.addView(new Da(this.elementId,this.elementId+"_gold_upgrades",i))}initializeView(){let e=d.getElement(this.parentId);d.createElement("div",e,this.elementId,"primary-upgrade-panel-body"),this.setInitialVisibility(!1),super.initializeView()}};var Ga=class extends G{constructor(e,t,i){super(e,t),this.titleDescriptionContainerId=t+"_text",this.minedUpgradeCollection=i,this.upgrade=null,this.mainElement=null,this.activeProgressElement=null,this.titleDescriptionContainer=null,this.imgElement=null,this.titleElement=null,this.displayedTitle=null,this.displayedDescription=null,this.descriptionElement=null,this.displayedIconFileName=null,this.displayedPurchasable=!0,this.displayedPercent=-1}setUpgrade(e){if(this.upgrade!==e)if(this.upgrade=e,e){let t=this.upgrade.getDescription();this.displayedDescription=null,t?this.descriptionElement||(this.descriptionElement=d.createElement("div",this.titleDescriptionContainer,null,"mined-upgrade-button-description"),this.descriptionElement.innerHTML="",this.titleElement.className=""):(this.descriptionElement&&(d.removeElement(this.titleDescriptionContainerId,this.descriptionElement),this.descriptionElement=null),this.titleElement.className="mined-upgrade-button-title-single-row"),this.displayedPurchasable=!this.upgrade.isPurchasable(),this.setViewVisible(!0)}else this.setViewVisible(!1)}initializeView(){let e=this.getElementId(),t=d.getElement(this.parentId);if(!t){console.log("UpgradeView.initializeView() No parent element found! parentId="+this.parentId);return}this.mainElement=d.createElement("div",t,e,"upgrade-button-outer"),this.activeProgressElement=d.createElement("div",this.mainElement,null,"mined-upgrade-progress-panel");let i=d.createElement("div",this.mainElement,null,"mined-upgrade-button-body"),r=d.createElement("div",i,null,"icon-container");this.titleDescriptionContainer=d.createElement("div",i,this.titleDescriptionContainerId,"mined-upgrade-title-description-container"),this.imgElement=d.createElement("img",r,null,null),this.imgElement.src=b.pick,this.titleElement=d.createElement("div",this.titleDescriptionContainer,null,"mined-upgrade-button-title-single-row"),this.titleElement.innerHTML="",d.hideElement(this.mainElement),this.setViewVisible(!1);let s=this;this.mainElement.onclick=function(){!s.upgrade||!s.upgrade.isPurchasable()||s.upgrade.purchase()&&(s.minedUpgradeCollection.remove(s.upgrade),s.upgrade=null,s.setViewVisible(!1))},super.initializeView()}updateViewContents(){if(!this.upgrade)return;let e=this.upgrade.title;e!==this.displayedTitle&&(this.displayedTitle=e,this.titleElement.innerHTML=e);let t=this.upgrade.getDescription();t&&t!==this.displayedDescription&&(this.displayedDescription=t,this.descriptionElement?this.descriptionElement.innerHTML=t:console.log("MinedUpgradeView.updateViewContents() null description element"));let i=this.upgrade.iconFileName;this.displayedIconFileName!==i&&(this.displayedIconFileName=i,this.imgElement.src=i);let r=this.upgrade.isPurchasable();this.displayedPurchasable!==r&&(this.displayedPurchasable=r,r?this.mainElement.className="upgrade-button-outer":this.mainElement.className="upgrade-button-outer-not-purchasable");let s=this.upgrade.getAutoClaimPercent();this.displayedPercent!==s&&(this.displayedPercent=s,this.activeProgressElement.style.width=s+"%")}};var ka=class extends B{constructor(e,t,i){super(e,t),this.minedUpgradeCollection=i,this.displayedChangeCount=-1,this.maxDisplayCount=15,this.upgradeViews=[],this.addView(new xe(this.elementId,this.elementId+"_header","Mined Upgrades"));for(let r=0;r<this.maxDisplayCount;r++){let s=new Ga(t,t+"_"+r,i);this.upgradeViews.push(s),this.addView(s)}this.setCurrentlyVisible(!0)}initializeView(){let e=d.getElement(this.parentId);d.createElement("div",e,this.elementId,null),super.initializeView()}updateView(){super.updateView()}updateViewContents(){this.displayedChangeCount!==this.minedUpgradeCollection.changeCount&&(this.displayedChangeCount=this.minedUpgradeCollection.changeCount,this.updateUpgrades()),super.updateViewContents()}updateUpgrades(){let e=this.minedUpgradeCollection.upgrades,t=Math.min(e.length,this.maxDisplayCount),i=0;for(;i<t;i++)i<this.upgradeViews.length&&this.upgradeViews[i].setUpgrade(e[i]);for(;i<this.upgradeViews.length;i++)this.upgradeViews[i].setUpgrade(null)}};var Fa=class extends B{constructor(e,t,i){super(e,Y.FREE_UPGRADES_PANEL),this.addView(new ka(this.elementId,Y.MINED_UPGRADES_PANEL,t))}initializeView(){let e=d.getElement(this.parentId);d.createElement("div",e,this.elementId,"primary-upgrade-panel-body"),super.initializeView()}};var Ba=class extends st{constructor(e,t,i,r,s,o){super(e,t,i,r,s),this.totals=o}initializeView(){super.initializeView(),this.setInitialVisibility(this.totals.goldSum.greaterThanZero())}updateView(){this.setViewVisible(this.totals.goldSum.greaterThanZero()),super.updateView()}};var Va=class extends G{constructor(e,t,i,r){super(e,t),this.skill=i,this.skillUpgrade=r,this.mainElement=null,this.titleElement=null,this.displayedTitle=null,this.descriptionElement=null,this.displayedDescription=null,this.costElement=null,this.displayedCost=new c(-10),this.countElement=null,this.displayedCount=-10;let s=r.isVisible();this.setViewVisible(s),this.setCurrentlyVisible(!s)}initializeView(){let e=this.getElementId(),t=this.skillUpgrade.getDescription(),i=d.getElement(this.parentId);if(!i){console.log("SkillPartView.initializeView() No parent element found! parentId="+this.parentId);return}this.mainElement=d.createElement("div",i,e,"upgrade-button-outer");let r=d.createElement("div",this.mainElement,null,"pick-upgrade-button-row1"),s=d.createElement("img",r,null,"icon-container");s.src=this.skillUpgrade.iconFileName;let o=d.createElement("div",r,null,"pick-upgrade-title-description-container"),a=t?null:"pick-upgrade-button-title-single-row";this.titleElement=d.createElement("div",o,null,a),this.titleElement.innerHTML="",t&&(this.descriptionElement=d.createElement("div",o,null,"pick-upgrade-button-description"),this.descriptionElement.innerHTML=t,this.displayedDescription=t);let h=d.createElement("div",r,null,null);this.countElement=d.createElement("div",h,null,"pick-upgrade-count"),this.costElement=d.createElement("div",h,null,"pick-upgrade-cost");let u=this.skillUpgrade.isVisible();this.setViewVisible(u),this.setCurrentlyVisible(!u);let m=this;this.mainElement.onclick=function(){m.skillUpgrade.isPurchasable()&&(m.displayedCost.copy(m.skillUpgrade.getCost()),m.skillUpgrade.purchase())},super.initializeView()}updateView(){this.setViewVisible(this.skillUpgrade.isVisible()),super.updateView()}updateViewContents(){let e=this.skillUpgrade.getCost(),t=this.skillUpgrade.purchasedCount,i=this.skillUpgrade.isPurchasable();if(e.equals(this.displayedCost)||(this.displayedCost.copy(e),this.costElement.innerHTML=L.formatBigNum(e)+" Silver"),t!==this.displayedCount){let o=this.skillUpgrade.maxCount;this.displayedCount=t,o!==-1?this.countElement.innerHTML=t+"/"+o:this.countElement.innerHTML=""+t}let r=this.skillUpgrade.getTitle();r!==this.displayedTitle&&(this.displayedTitle=r,this.titleElement.innerHTML=r);let s=this.skillUpgrade.getDescription();s&&s!==this.displayedDescription&&(this.displayedDescription=s,this.descriptionElement?this.descriptionElement.innerHTML=s:console.log("SkillPartView.updateViewContents() no description element!  skillPart.id="+this.skillUpgrade.id)),i?this.mainElement.className!=="upgrade-button-outer"&&(this.mainElement.className="upgrade-button-outer"):this.mainElement.className==="upgrade-button-outer"&&(this.mainElement.className="upgrade-button-outer-not-purchasable")}};var Ua=class extends B{constructor(e,t,i){super(e,t),this.skill=i,this.mainElement=null;let r=this.skill.upgrades;for(let s=0;s<r.length;s++)this.addView(new Va(t,t+"_"+s,i,r[s]))}initializeView(){let e=this.getElementId(),t=d.getElement(this.parentId);if(!t){console.log("SkillPartContainerView.initializeView() No parent element found! parentId="+this.parentId);return}this.mainElement=d.createElement("div",t,e,null),super.initializeView()}};var za=class extends B{constructor(e,t,i){super(e,t),this.skill=i,this.mainElement=null,this.displayedPurchaseable=!1,this.containerView=new Ua(t,t+"Container",i),this.containerView.setInitialVisibility(!this.skill.collapsed),this.addView(this.containerView)}initializeView(){let e=this.getElementId(),t=d.getElement(this.parentId);if(!t){console.log("SkillView.initializeView() No parent element found! parentId="+this.parentId);return}this.mainElement=d.createElement("div",t,e,"skill-panel-outer");let i=d.createElement("div",this.mainElement,null,"skill-panel-row1"),r=d.createElement("img",i,null,"icon-container");r.src=this.skill.spriteFileName;let s=d.createElement("div",i,null,null),o=d.createElement("div",s,null,"skill-panel-row1-title");o.innerHTML=this.skill.title;let a=d.createElement("div",s,null,"skill-panel-row2-description");a.innerHTML=this.skill.description,this.setCurrentlyVisible(!1),this.setViewVisible(!0);let h=this;i.onclick=function(){h.skill.collapsed=!h.skill.collapsed,h.containerView.setViewVisible(!h.skill.collapsed)},super.initializeView()}updateViewContents(){let e=this.skill.purchaseable&&this.skill.collapsed;this.displayedPurchaseable!==e&&(this.displayedPurchaseable=e,this.mainElement.className=e?"skill-panel-outer-purchaseable":"skill-panel-outer"),super.updateViewContents()}};var Ha=class extends B{constructor(e,t,i){super(e,t),this.skillTree=i;let r=this.skillTree.skills;for(let s=0;s<r.length;s++)this.addView(new za(t,t+"_"+s,r[s]))}initializeView(){let e=d.getElement(this.parentId);if(!e){console.log("SkillTreeView.initializeView() No parent element found! parentId="+this.parentId);return}d.createElement("div",e,this.elementId,null),super.initializeView()}};var Wa=class extends B{constructor(e,t,i){super(e,t),this.skillTree=i,this.addView(new xe(this.elementId,this.elementId+"_header","Silver Upgrades")),this.addView(new Ha(this.elementId,"skillTreeView",i)),this.setInitialVisibility(!1)}initializeView(){let e=d.getElement(this.parentId);d.createElement("div",e,this.elementId,"primary-upgrade-panel-body"),this.setInitialVisibility(!1),super.initializeView()}};var Ya=class extends st{constructor(e,t,i,r,s,o){super(e,t,i,r,s),this.totals=o}initializeView(){super.initializeView(),this.setInitialVisibility(this.totals.silverSum.greaterThanZero())}updateView(){this.setViewVisible(this.totals.silverSum.greaterThanZero()),super.updateView()}};var Ka=class extends B{constructor(e,t,i,r,s,o,a,h,u){super(e,Y.PRIMARY_UPGRADE_PANEL);let m=new ba(this.elementId);this.addView(m);let g=new Fa(this.elementId,t,i),_=new xa(this.elementId,Y.PICK_UPGRADES_PANEL,r,s),C=new Wa(this.elementId,Y.SKILL_TREE_PANEL,o),w=new va(this.elementId,Y.GOLD_UPGRADES_PANEL,a),T=new ya(this.elementId,h);this.addView(g),this.addView(_),this.addView(w),this.addView(C),this.addView(T);let S=Y.PRIMARY_UPGRADE_PANEL_TAB_BAR;m.addTab(new st(S,"minedUpgrades_tab",g,m,b.currency.upgrades)),m.addTab(new st(S,"pickUpgrades_tab",_,m,b.currency.ore)),m.addTab(new Ya(S,"skillTree_tab",C,m,b.currency.silver,u)),m.addTab(new Ba(S,"goldUpgrades_tab",w,m,b.currency.gold,u)),m.addTab(new st(S,"menuPanel_tab",T,m,b.pick)),this.setInitialVisibility(!0)}initializeView(){let e=d.getElement(this.parentId);d.createElement("div",e,this.getElementId(),"primary-upgrade-panel"),super.initializeView()}getVisibileDisplayValue(){return"flex"}};var Xa=class extends B{constructor(e,t,i,r){super(e,Y.GAME_VIEW_OVERLAY_CONTAINER);let s=this.getElementId();this.addView(new ca(s,"topRowContainer",t.totals,t.partyTarget,t.runStatistics)),this.addView(new kn(s,t.bonusCollection)),this.addView(new Pa(s,"popupContainer",t.runStatistics,t.globalStatistics,t.totals,t.gameOptions,i,t.offlineLogic,r)),this.addView(new Ka(s,t.minedUpgradeCollection,t.automationManager.minedUpgradeAutomation,t.pickUpgradeCollection,t.automationManager.pickUpgradeAutomation,t.skillTreeGraph,t.goldUpgradeCollection,r,t.totals)),this.addView(new ta(s,"bottomRowContainer",t.damage,t.values,t.partyTarget,t.mineControl,t.crew,t.projection,t.panAnimation,t.runStatistics))}initializeView(){let e=d.getElement(this.parentId);d.createElement("div",e,this.elementId,"view-overlay-container"),this.setInitialVisibility(!0),super.initializeView()}};var ja=class extends B{constructor(e,t,i){super(null,Y.GAME_VIEW_CONTAINER),this.canvasView=null,this.mineCanvasUserInput=t,this.skillTreeUserInput=i,this.gameStateControl=e}createChildren(e){let t=this.getElementId();this.removeChildViewElements(),d.clearChildren(t),this.canvasView=new Gn(t,e,this.mineCanvasUserInput),this.addView(this.canvasView);let i=new ma;this.addView(new Xa(t,e,this.gameStateControl,i)),this.initializeView()}getCanvas(){return this.canvasView.getCanvas()}resetGameView(){this.removeAll()}};var Za=class{constructor(e,t,i,r){this.userInput=e,this.projection=t,this.worldGrid=i,this.panAnimation=r,this.mapPanned=!1,this.mapPannedTime=0,this.delta=new P(0,0),this.screenCoordinate=new P(0,0),this.clickWorldCoordinate=new P(0,0),this.hoverWorldCoordinate=new P(0,0)}handleInput(){this.userInput.leftMouseClick?this.handleMouseClick():(this.handlePanning(),this.handleZoomInput())}resetInputHandler(){this.userInput.resetInputState()}handleMouseClick(){this.screenCoordinate.set(this.userInput.clickX,this.userInput.clickY),this.projection.screenToWorld(this.screenCoordinate,this.clickWorldCoordinate)}handlePanning(){this.userInput.leftMouseDown?(this.delta.x=this.userInput.mouseDeltaX,this.delta.y=this.userInput.mouseDeltaY):(this.delta.x*=n.input.panning.decayFactor,this.delta.y*=n.input.panning.decayFactor,Math.abs(this.delta.x)<1&&(this.delta.x=0),Math.abs(this.delta.y)<1&&(this.delta.y=0)),this.delta.x!==0||this.delta.y!==0?(this.mapPanned=!0,this.mapPannedTime=Date.now(),this.projection.updateSpaceCenter(this.projection.screenToWorldDistance(-this.delta.x),this.projection.screenToWorldDistance(-this.delta.y)),this.projection.stayCenteredOnCharacter=!1,this.panAnimation.animating=!1):this.mapPanned=!1}handleZoomInput(){var e=this.userInput.mouseWheelMotion;e<0?this.projection.zoomIn():e>0&&this.projection.zoomOut()}};var qa=class{constructor(e,t){this.userInput=e,this.skillTreeGraph=t,this.mapPanned=!1,this.mapPannedTime=0,this.delta=new P(0,0)}handleInput(){this.userInput.leftMouseClick||(this.handlePanning(),this.handleZoomInput())}resetInputHandler(){this.userInput.resetInputState()}handlePanning(){this.userInput.leftMouseDown?(this.delta.x=this.userInput.mouseDeltaX,this.delta.y=this.userInput.mouseDeltaY):(this.delta.x*=n.input.panning.decayFactor,this.delta.y*=n.input.panning.decayFactor,Math.abs(this.delta.x)<1&&(this.delta.x=0),Math.abs(this.delta.y)<1&&(this.delta.y=0)),this.delta.x!==0||this.delta.y!==0?(this.mapPanned=!0,this.mapPannedTime=Date.now(),this.skillTreeGraph.updateCenter(this.delta.x,this.delta.y)):this.mapPanned=!1}handleZoomInput(){var e=this.userInput.mouseWheelMotion;e<0?this.skillTreeGraph.zoomIn():e>0&&this.skillTreeGraph.zoomOut()}};var Ja=class{constructor(e,t){this.inputHandler=e,this.skillTreeInputHandler=t,this.elapsedTurnFrames=0,this.prevWorldGridShiftCount=-1,this.frameTimeRatio=1,this.turnStart=!1,this.lastSaveTime=Date.now(),this.workingGridCenter=new P(0,0),this.elapsedSaveThreshold=1e3*60*2;let i=this;this.performMonsterFrameActionsForGrid=function(r){let s=r.characters;for(let o=0;o<s.length;o++)s[o].isMonster()&&s[o].performFrameActions(i.frameTimeRatio,i.turnStart)},this.processMonsterTurnsForGrid=function(r){let s=r.characters;for(let o=0;o<s.length;o++){let a=s[o],h=a.position.tile;a.isMonster()&&h&&h.lighting.everVisibleToCharacter&&a.chooseTurn()}}}processFrameLogic(e,t){e.gameTime.frameNumber+=t,e.gameTime.frameNumber>1e10&&(e.gameTime.frameNumber=0),this.inputHandler.handleInput(),this.skillTreeInputHandler.handleInput();let i=!1;this.elapsedTurnFrames+=t,this.elapsedTurnFrames>=n.time.turnFrames&&(i=!0,this.elapsedTurnFrames-=n.time.turnFrames);let r=e.worldGrid.shiftCount;this.prevWorldGridShiftCount!==r&&(this.prevWorldGridShiftCount=r),i&&this.processTurnLogic(e),this.performCharacterActions(e,t,i),e.partyTarget.nextLayerDescription&&e.partyTarget.nextLayerDescription.minDepth<=e.runStatistics.maxDepth&&e.partyTarget.unlockNextLayer(),e.physicsManager.updatePhysicsForFrame(t),e.effectManager.updateEffectsForFrame(t),e.minedUpgradeCollection.updateForFrame(t),this.updateGridCenter(e,t),e.projection.updateProjectionForFrame(),e.gridLoadingManager.manageLoadedGridsForFrame(),i&&(this.updateDynamicLighting(e.lightingCalculator,e.crew,e.gameOptions),e.skillTreeGraph.updateSkillsForTurn()),e.skillTreeGraph.updateSkillsForFrame(t),e.sprites.spriteAnimationManager.updateForFrame(t),e.infoTextProcessor.updateTextForFrame(t);let s=Date.now();s-this.lastSaveTime>this.elapsedSaveThreshold&&(e.saveManager.saveGame(e),this.lastSaveTime=s)}updateDynamicLighting(e,t,i){K.startTime("LightingReset"),e.resetForFrame(),K.endTime("LightingReset");let r=t.miners;K.startTime("DynamicLighting");for(let s=0;s<r.length;s++){let o=r[s].position.tile;o&&(s===0?e.calculatePrimaryPositionalLighting(o):e.calculateSecondaryPositionalLighting(o))}K.endTime("DynamicLighting")}updateGridCenter(e,t){if(!e.panAnimation.animating&&!e.projection.stayCenteredOnCharacter&&Date.now()-this.inputHandler.mapPannedTime>1e3*10&&e.panAnimation.startAnimation(),e.panAnimation.animating){e.panAnimation.updateForFrame(t);return}e.projection.stayCenteredOnCharacter&&(e.crew.calculateCrewCenterCoordinate(this.workingGridCenter),e.projection.setGridCenter(this.workingGridCenter.x+n.tile.halfSize,this.workingGridCenter.y+n.tile.halfSize))}performCharacterActions(e,t,i){let r=e.crew.miners;for(let s=0;s<r.length;s++){let o=r[s];o.position.tile&&o.performFrameActions(t,i)}this.frameTimeRatio=t,this.turnStart=i,ie.allVisibleGrids(e.worldGrid,e.projection,this.performMonsterFrameActionsForGrid)}validateCrewTiles(e,t){let i=t.calculateCrewCenterTile();if(!i)return!1;let r=t.miners;for(let s=0;s<r.length;s++){let o=r[s];if(!this.validateCharacterTile(e,o)){let h=Wt.findAvailableNearbyTile(o,t,i);h?(console.log("FrameLogic.validateCrewTiles() moving miner to valid grid near crew center."),o.position.setTileAndOriginPosition(h,h.origin.x,h.origin.y)):console.log("FrameLogic.validateCrewTiles() failed to move miner near crew center")}}return!0}validateCharacterTile(e,t){let i=e.findGridTile(t.position.worldCoordinateOrigin);return t.position.tile?i&&i!==t.position.tile?(t.onInvalidGrid(),t.position.setTileAndOriginPosition(i,i.origin.x,i.origin.y),!0):i?!0:(t.onInvalidGrid(),!1):i?(t.onInvalidGrid(),t.position.setTileAndOriginPosition(i,i.origin.x,i.origin.y),!0):!1}processTurnLogic(e){if(e.gameTime.turnNumber++,e.statisticsIncrementor.incrementTurns(1),!this.validateCrewTiles(e.worldGrid,e.crew)){e.targetList.reset();return}e.automationManager.updateForTurn(),e.mineControl.updateForTurn(),e.crewBrain.updateForTurn(),ie.allVisibleGrids(e.worldGrid,e.projection,this.processMonsterTurnsForGrid)}};var Qa=class{constructor(e,t,i,r){this.state=e,this.gameView=t,this.inputHandler=i,this.skillTreeInputHandler=r,this.prevTimeStamp=performance.now(),this.frameLogic=new Ja(i,r);let s=this;this.gameLoopReference=function(){s.gameLoop()},this.fpsFrameCount=0,this.fpsMillis=0,this.offlineThresholdMillis=1e3*60*30,this.gameStateControl=null,this.callbackCode=-1,this.prevFrameVisible=!1}requestGameStateCallback(e,t){this.gameStateControl=e,this.callbackCode=t}startGameLoop(){this.fpsFrameCount=0,this.fpsMillis=0,this.prevTimeStamp=performance.now(),window.requestAnimationFrame(this.gameLoopReference)}gameLoop(){window.requestAnimationFrame(this.gameLoopReference);let e=performance.now(),t=e-this.prevTimeStamp;if(t<this.state.gameOptions.getFpsMillis())return;this.prevTimeStamp=e;let i=t>0?t:this.state.currentFps>0?1e3/this.state.currentFps:1e3/60;if(!this.state.gameVisible||!this.prevFrameVisible){let r=t/1e3|0;r>0&&(console.log("GameLoop.gameLoop() earned offline credit: "+Ue.formatElapsedTime(r*1e3)),this.state.totals.offlineSeconds+=r),this.state.gameVisible&&!this.prevFrameVisible&&this.state.totals.offlineSeconds>0&&this.state.offlineLogic.calculateOfflineEarnings()}if(this.prevFrameVisible=this.state.gameVisible,this.gameStateControl)this.gameStateControl.modelLoadCallback(this.callbackCode),this.gameStateControl=null,this.callbackCode=0;else if(this.state.gameVisible&&!this.state.gamePaused){let r=i/n.time.defaultMillisPerFrame;this.frameLogic.processFrameLogic(this.state,r),this.gameView.updateView()}this.inputHandler.resetInputHandler(),this.skillTreeInputHandler.resetInputHandler(),this.fpsFrameCount++,this.fpsMillis+=t,this.fpsFrameCount>=60&&(this.state.currentFps=this.fpsFrameCount/(this.fpsMillis/1e3)|0,this.fpsFrameCount=0,this.fpsMillis=0)}};var $a=class extends En{constructor(){super(),this.state=new vn(this),this.mineCanvasUserInput=new Ji,this.skillTreeUserInput=new Ji,this.gameView=new ja(this,this.mineCanvasUserInput,this.skillTreeUserInput),this.inputHandler=new Za(this.mineCanvasUserInput,this.state.projection,this.state.worldGrid,this.state.panAnimation),this.skillTreeInputHandler=new qa(this.skillTreeUserInput,this.state.skillTreeGraph),this.gameLoop=new Qa(this.state,this.gameView,this.inputHandler,this.skillTreeInputHandler),this.started=!1,this.gameInitialized=!1,this.saveStateText=null}onVisibilityChange(e){this.state.gameVisible=e}onWindowResize(e,t){let i=this.gameView.getCanvas();i&&(i.width=e,i.height=t)}saveGame(){this.state.saveManager.saveGame(this.state)}getState(){return this.state}isStarted(){return this.started}startGame(){this.started||(this.gameInitialized||this.initialize(),this.gameLoop.startGameLoop(),this.started=!0)}initialize(){if(this.gameInitialized)return;this.state.sprites.isInitialized()||console.log("GameState.initialize() ERROR The sprites have not been initialed yet.");let e=this.state.saveManager.loadSave(this.state);this.state.initializeState(e),this.gameView.createChildren(this.state),this.gameInitialized=!0}prestigeGame(){this.gameLoop.requestGameStateCallback(this,this.CALLBACK_GAME_PRESTIGE)}resetGame(){this.gameLoop.requestGameStateCallback(this,this.CALLBACK_GAME_RESET)}deleteGame(){this.gameLoop.requestGameStateCallback(this,this.CALLBACK_GAME_DELETE)}importSave(e){this.saveStateText=e,this.gameLoop.requestGameStateCallback(this,this.CALLBACK_GAME_IMPORT)}modelLoadCallback(e){e===this.CALLBACK_GAME_RESET?this.resetInternal():e===this.CALLBACK_GAME_DELETE?this.deleteInternal():e===this.CALLBACK_GAME_IMPORT?this.importInternal():e===this.CALLBACK_GAME_PRESTIGE?this.prestigeInternal():console.log("GameState.modelLoadCallback(callbackCode) Invalid callback code: "+e)}resetInternal(){let e=this.state.saveManager;e.deleteSave(),this.state.resetForPrestige(),this.gameView.resetGameView(),this.gameView.createChildren(this.state),e.saveGame(this.state)}deleteInternal(){let e=this.state.saveManager;e.deleteSave(),this.state.resetFull(),this.gameView.resetGameView(),this.gameView.createChildren(this.state),e.saveGame(this.state)}prestigeInternal(){this.state.statisticsIncrementor.incrementPrestigePoints(this.state.totals.unclaimedPrestige),this.state.totals.onPrestige(),this.resetInternal()}importInternal(){console.log("GameState.importInternal() START");let e=this.state.saveManager,t=e.getSaveStateForExport(this.state);this.state.beforeImportSave(),e.importSave(this.state,this.saveStateText)||(console.log("GameState.importInternal() IMPORT FAILED. REVERTING TO PREV SAVE"),this.state.beforeImportSave(),e.importSave(this.state,t)),this.saveStateText=null,this.state.afterImportSave(),this.gameView.resetGameView(),this.gameView.createChildren(this.state),console.log("GameState.importInternal() DONE")}};var el=class{constructor(){this.gameState=new $a;let e=this;this.resourceLoadingLoop=function(){e.waitForResourcesToLoad()}}onResize(e){this.gameState.onWindowResize(e.innerWidth,e.innerHeight)}onVisibilityChange(){typeof document.hidden<"u"&&(console.log("Game.onVisibilityChange() hidden="+document.hidden),this.gameState.onVisibilityChange(!document.hidden))}onLoad(e,t){if(this.gameState.isStarted())return;console.log("Game.onLoad() Loading game.");let i=this;t.addEventListener("visibilitychange",function(r){i.onVisibilityChange()},!1),this.waitForResourcesToLoad()}onUnload(){console.log("Game.onUnload()"),this.gameState.saveGame()}waitForResourcesToLoad(){this.gameState.state.sprites.isInitialized()?(console.log("Game.waitForResourcesToLoad() Resources are loaded. Starting game."),this.gameState.startGame()):(console.log("Game.waitForResourcesToLoad() Resources not yet loaded. Waiting..."),window.requestAnimationFrame(this.resourceLoadingLoop))}};(()=>{let l=new el;window.onresize=function(){l.onResize(window)},window.onload=function(){l.onLoad(window,document)},window.onbeforeunload=function(){l.onUnload()}})();})();
