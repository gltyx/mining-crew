(()=>{var $l=Object.create;var Il=Object.defineProperty;var ed=Object.getOwnPropertyDescriptor;var td=Object.getOwnPropertyNames;var id=Object.getPrototypeOf,sd=Object.prototype.hasOwnProperty;var rd=(l,e)=>()=>(e||l((e={exports:{}}).exports,e),e.exports);var od=(l,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of td(e))!sd.call(l,s)&&s!==t&&Il(l,s,{get:()=>e[s],enumerable:!(i=ed(e,s))||i.enumerable});return l};var xl=(l,e,t)=>(t=l!=null?$l(id(l)):{},od(e||!l||!l.__esModule?Il(t,"default",{value:l,enumerable:!0}):t,l));var Rl=rd((gx,al)=>{var _l=(function(){var l=String.fromCharCode,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",i={};function s(o,a){if(!i[o]){i[o]={};for(var h=0;h<o.length;h++)i[o][o.charAt(h)]=h}return i[o][a]}var r={compressToBase64:function(o){if(o==null)return"";var a=r._compress(o,6,function(h){return e.charAt(h)});switch(a.length%4){default:case 0:return a;case 1:return a+"===";case 2:return a+"==";case 3:return a+"="}},decompressFromBase64:function(o){return o==null?"":o==""?null:r._decompress(o.length,32,function(a){return s(e,o.charAt(a))})},compressToUTF16:function(o){return o==null?"":r._compress(o,15,function(a){return l(a+32)})+" "},decompressFromUTF16:function(o){return o==null?"":o==""?null:r._decompress(o.length,16384,function(a){return o.charCodeAt(a)-32})},compressToUint8Array:function(o){for(var a=r.compress(o),h=new Uint8Array(a.length*2),m=0,p=a.length;m<p;m++){var f=a.charCodeAt(m);h[m*2]=f>>>8,h[m*2+1]=f%256}return h},decompressFromUint8Array:function(o){if(o==null)return r.decompress(o);for(var a=new Array(o.length/2),h=0,m=a.length;h<m;h++)a[h]=o[h*2]*256+o[h*2+1];var p=[];return a.forEach(function(f){p.push(l(f))}),r.decompress(p.join(""))},compressToEncodedURIComponent:function(o){return o==null?"":r._compress(o,6,function(a){return t.charAt(a)})},decompressFromEncodedURIComponent:function(o){return o==null?"":o==""?null:(o=o.replace(/ /g,"+"),r._decompress(o.length,32,function(a){return s(t,o.charAt(a))}))},compress:function(o){return r._compress(o,16,function(a){return l(a)})},_compress:function(o,a,h){if(o==null)return"";var m,p,f={},S={},E="",w="",C="",T=2,A=3,N=2,P=[],M=0,y=0,V;for(V=0;V<o.length;V+=1)if(E=o.charAt(V),Object.prototype.hasOwnProperty.call(f,E)||(f[E]=A++,S[E]=!0),w=C+E,Object.prototype.hasOwnProperty.call(f,w))C=w;else{if(Object.prototype.hasOwnProperty.call(S,C)){if(C.charCodeAt(0)<256){for(m=0;m<N;m++)M=M<<1,y==a-1?(y=0,P.push(h(M)),M=0):y++;for(p=C.charCodeAt(0),m=0;m<8;m++)M=M<<1|p&1,y==a-1?(y=0,P.push(h(M)),M=0):y++,p=p>>1}else{for(p=1,m=0;m<N;m++)M=M<<1|p,y==a-1?(y=0,P.push(h(M)),M=0):y++,p=0;for(p=C.charCodeAt(0),m=0;m<16;m++)M=M<<1|p&1,y==a-1?(y=0,P.push(h(M)),M=0):y++,p=p>>1}T--,T==0&&(T=Math.pow(2,N),N++),delete S[C]}else for(p=f[C],m=0;m<N;m++)M=M<<1|p&1,y==a-1?(y=0,P.push(h(M)),M=0):y++,p=p>>1;T--,T==0&&(T=Math.pow(2,N),N++),f[w]=A++,C=String(E)}if(C!==""){if(Object.prototype.hasOwnProperty.call(S,C)){if(C.charCodeAt(0)<256){for(m=0;m<N;m++)M=M<<1,y==a-1?(y=0,P.push(h(M)),M=0):y++;for(p=C.charCodeAt(0),m=0;m<8;m++)M=M<<1|p&1,y==a-1?(y=0,P.push(h(M)),M=0):y++,p=p>>1}else{for(p=1,m=0;m<N;m++)M=M<<1|p,y==a-1?(y=0,P.push(h(M)),M=0):y++,p=0;for(p=C.charCodeAt(0),m=0;m<16;m++)M=M<<1|p&1,y==a-1?(y=0,P.push(h(M)),M=0):y++,p=p>>1}T--,T==0&&(T=Math.pow(2,N),N++),delete S[C]}else for(p=f[C],m=0;m<N;m++)M=M<<1|p&1,y==a-1?(y=0,P.push(h(M)),M=0):y++,p=p>>1;T--,T==0&&(T=Math.pow(2,N),N++)}for(p=2,m=0;m<N;m++)M=M<<1|p&1,y==a-1?(y=0,P.push(h(M)),M=0):y++,p=p>>1;for(;;)if(M=M<<1,y==a-1){P.push(h(M));break}else y++;return P.join("")},decompress:function(o){return o==null?"":o==""?null:r._decompress(o.length,32768,function(a){return o.charCodeAt(a)})},_decompress:function(o,a,h){var m=[],p,f=4,S=4,E=3,w="",C=[],T,A,N,P,M,y,V,O={val:h(0),position:a,index:1};for(T=0;T<3;T+=1)m[T]=T;for(N=0,M=Math.pow(2,2),y=1;y!=M;)P=O.val&O.position,O.position>>=1,O.position==0&&(O.position=a,O.val=h(O.index++)),N|=(P>0?1:0)*y,y<<=1;switch(p=N){case 0:for(N=0,M=Math.pow(2,8),y=1;y!=M;)P=O.val&O.position,O.position>>=1,O.position==0&&(O.position=a,O.val=h(O.index++)),N|=(P>0?1:0)*y,y<<=1;V=l(N);break;case 1:for(N=0,M=Math.pow(2,16),y=1;y!=M;)P=O.val&O.position,O.position>>=1,O.position==0&&(O.position=a,O.val=h(O.index++)),N|=(P>0?1:0)*y,y<<=1;V=l(N);break;case 2:return""}for(m[3]=V,A=V,C.push(V);;){if(O.index>o)return"";for(N=0,M=Math.pow(2,E),y=1;y!=M;)P=O.val&O.position,O.position>>=1,O.position==0&&(O.position=a,O.val=h(O.index++)),N|=(P>0?1:0)*y,y<<=1;switch(V=N){case 0:for(N=0,M=Math.pow(2,8),y=1;y!=M;)P=O.val&O.position,O.position>>=1,O.position==0&&(O.position=a,O.val=h(O.index++)),N|=(P>0?1:0)*y,y<<=1;m[S++]=l(N),V=S-1,f--;break;case 1:for(N=0,M=Math.pow(2,16),y=1;y!=M;)P=O.val&O.position,O.position>>=1,O.position==0&&(O.position=a,O.val=h(O.index++)),N|=(P>0?1:0)*y,y<<=1;m[S++]=l(N),V=S-1,f--;break;case 2:return C.join("")}if(f==0&&(f=Math.pow(2,E),E++),m[V])w=m[V];else if(V===S)w=A+A.charAt(0);else return null;C.push(w),m[S++]=A+w.charAt(0),f--,A=w,f==0&&(f=Math.pow(2,E),E++)}}};return r})();typeof define=="function"&&define.amd?define(function(){return _l}):typeof al<"u"&&al!=null?al.exports=_l:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return _l})});var Ne=class{constructor(e,t,i){this.id=e,this.spriteName=t,this.brainId=i}};var n={};n.time={defaultFramesPerSecond:60,defaultMillisPerFrame:1e3/60,turnsPerSecond:4,secondsPerTurn:.25,millisPerTurn:250,turnFrames:15};n.target={minTargetRow:5};n.damage={baseDamagePerSecond:30,baseDamagePerTurn:30*n.time.secondsPerTurn};n.tile={size:16,halfSize:8,halfSizeSquared:64,threeQuarterSize:12,quarterSize:4,eighthSize:2,doubleSize:32};n.skillGraph={cellWidth:260,cellHeight:110,connectorOffsetX:100,connectorOffsetY:40,minZoom:20,maxZoom:100,zoomStep:10,nodeViewWidth:180};n.physics={gravityRatePerFrame:4,walkRatePerFrame:2,jumpRatePerFrame:2};n.character={jumpPower:2.5*n.tile.size,maxJumpPixelsPerFrame:2,halfWidth:5};n.combat={critialHitMultiplier:1.5};n.input={panning:{decayFactor:.95}};n.projection={zoomInScaleLimit:8,zoomOutScaleLimit:1.5,zoomDefault:2,zoomStep:.25,startCenterX:0,startCenterY:0};n.text={maxInfoTextCount:7,maxDamageTextCount:4,textFrameDuration:45};n.grid={numZoneColsInGrid:3,numZoneRowsInGrid:3,numRegionColsInZone:2,numRegionRowsInZone:2,numTileColsInRegion:5,numTileRowsInRegion:5};n.grid.regionTileWidth=n.grid.numTileColsInRegion;n.grid.regionTileHeight=n.grid.numTileRowsInRegion;n.grid.zoneTileWidth=n.grid.numRegionColsInZone*n.grid.regionTileWidth;n.grid.zoneTileHeight=n.grid.numRegionRowsInZone*n.grid.regionTileHeight;n.grid.gridTileWidth=n.grid.numZoneColsInGrid*n.grid.zoneTileWidth;n.grid.gridTileHeight=n.grid.numZoneRowsInGrid*n.grid.zoneTileHeight;n.grid.regionPixelWidth=n.grid.regionTileWidth*n.tile.size;n.grid.regionPixelHeight=n.grid.regionTileHeight*n.tile.size;n.grid.zonePixelWidth=n.grid.zoneTileWidth*n.tile.size;n.grid.zonePixelHeight=n.grid.zoneTileHeight*n.tile.size;n.grid.gridPixelWidth=n.grid.gridTileWidth*n.tile.size;n.grid.gridPixelHeight=n.grid.gridTileHeight*n.tile.size;n.start={startX:2e4,startY:-100*n.tile.size};n.effect={effectTravelPixlesPerFrame:5.5,fastEffectTravelPixelsPerFrame:6.5,slowEffectTravelPixelsPerFrame:3,lightningFrames:n.time.turnFrames*2};n.lighting={lightSourceRadius:5};n.skill={};n.bonus={newBonusTurns:n.time.turnsPerSecond*900,activationTurns:n.time.turnsPerSecond*300,activationCost:1e3};n.prestige={multiplierPerPrestige:.2,incrementBonusPerUpgrade:.2,baseBonusPerUpgrade:.2};n.ruby={multiplierPerRuby:1,incrementBonusPerUpgrade:.2,baseBonusPerUpgrade:.2};n.blocks={multiplierPerBlock:0,incrementBonusPerUpgrade:.01,baseBonusPerUpgrade:.01};n.depth={multiplierPerDepth:.025,incrementBonusPerUpgrade:.025,baseBonusPerUpgrade:.025};n.minedDamage={incrementBonusPerUpgrade:1,baseBonusPerUpgrade:1};n.gold={upgradeBaseCost:25e3,damageMultiplierPerUpgrade:10,oreBonusMultiplierPerUpgrade:10};n.skill.costs={addDrill1:0,addOrbit1:1,addMissile1:2,addLaser1:3,addMiner1:5,addMiner2:20,addMiner3:40,addMiner4:60,increment:2};n.skill.fissure={delayMillis:2500,forkChance:75,secondForkChance:85,minBlocks:3,blocksPerUpgrade:2};n.skill.lightning={minRange:3,delayMillis:2500,forkChance:75,secondForkChance:85,minBlocks:3,blocksPerUpgrade:1,tilesPerUpgrade:1};n.skill.chain={minRange:3,minSize:3,delayMillis:2500,blocksPerUpgrade:1,tilesPerUpgrade:1};n.skill.laser={minRange:3,tilesPerUpgrade:1};n.skill.drill={minRange:3,tilesPerUpgrade:1};n.skill.missiles={initialMissiles:5,missilesPerUpgrade:3};n.skill.orbit={minRangePixels:2*n.tile.size,rangePixelsPerUpgrade:n.tile.halfSize};n.skill.bonus={oreBonusMultiplierPerUpgrade:10,additiveUpgradeBonusMultiplerPerUpgrade:2,multiplicativeUpgradeBonusMultiplerPerUpgrade:10,minedOreBaseTiles:8,minedOreBonusPerUpgrade:1,fallSpeedMuliplierPerUgrade:.15};n.skill.common={damagePercentPerUpgrade:25,damagePerUpgrade:.25,baseActivationTurns:n.time.turnsPerSecond*10,baseCoolDownTurns:n.time.turnsPerSecond*60,activationSecondsPerUpgrade:3,coolDownSecondsPerUpgrade:5,activationTurnsPerUpgrade:n.time.turnsPerSecond*3,coolDownTurnsPerUpgrade:n.time.turnsPerSecond*5};n.automation={minDelayTurns:n.time.turnsPerSecond*2,baseUpgradeDelayTurns:n.time.turnsPerSecond*61,turnsPerRateUpgrade:n.time.turnsPerSecond*5,prestigeUpgradeDelayTurns:n.time.turnsPerSecond*3660,prestigeTurnsPerRateUpgrade:n.time.turnsPerSecond*300,prestigeMinTurnsSinceLastChange:n.time.turnsPerSecond*600,secondsPerRateUpgrade:5,minutesPerPrestigeRateUpgrade:5};n.offline={defaultOfflineMinutes:30,defaultOfflineTurns:1800*n.time.turnsPerSecond,minutesPerUpgrade:30,turnsPerUpgrade:30*(60*n.time.turnsPerSecond)};var ni=class{constructor(e,t){this.spriteX=e,this.spriteY=t}getImage(){}getSize(){return n.tile.size}};var Et=class{constructor(){this.finishedAndAvailable=!0,this.listener=null}isFinishedAndAvailable(){return this.finishedAndAvailable}reset(e){this.finishedAndAvailable!=e&&this.listener&&this.listener.onAvailabilityChanged(e),this.finishedAndAvailable=e}setCycleCacheListener(e){this.listener=e}};var $={STAND:"STAND",WALK:"WALK",JUMP:"JUMP",FALL:"FALL",MINE:"MINE"};var v=class l{constructor(e,t){this.x=e,this.y=t}set(e,t){this.x=e,this.y=t}copy(e){this.x=e.x,this.y=e.y}clone(){return new l(this.x,this.y)}add(e){this.x+=e.x,this.y+=e.y}addXY(e,t){this.x+=e,this.y+=t}subtract(e){this.x-=e.x,this.y-=e.y}subtractXY(e,t){this.x-=e,this.y-=t}scale(e){this.x*=e,this.y*=e}distance(e){let t=e.x-this.x,i=e.y-this.y;return Math.sqrt(t*t+i*i)}distanceSquared(e){let t=e.x-this.x,i=e.y-this.y;return t*t+i*i}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}equals(e){return e&&this.x===e.x&&this.y===e.y}toString(){return"("+this.x+", "+this.y+")"}hash(){let e=23;return e=e*31+this.x,e=e*31+this.y,e}};var Ct=class{constructor(e){this.origin=e}getOrigin(){return this.origin}getPixelWidth(){return 0}getPixelHeight(){return 0}getOriginTileCol(){return this.origin.x/n.tile.size}getOriginTileRow(){return this.origin.y/n.tile.size}contains(e){return e.x>=this.origin.x&&e.x<this.origin.x+this.getPixelWidth()&&e.y>=this.origin.y&&e.y<this.origin.y+this.getPixelHeight()}containsXY(e,t){return e>=this.origin.x&&e<this.origin.x+this.getPixelWidth()&&t>=this.origin.y&&t<this.origin.y+this.getPixelHeight()}intersects(e,t,i){return!(e+i<this.origin.x||e-i>this.origin.x+this.getPixelWidth()||t+i<this.origin.y||t-i>this.origin.y+this.getPixelHeight())}};var ki=class{constructor(e,t){this.m=e,this.e=t}set(e,t){return this.m=e,this.e=t,this}setZero(){return this.m=0,this.e=0,this}copy(e){return typeof e=="number"&&(console.log("ManExp.copy() passed number instead of ManExp"),console.trace()),this.m=e.m,this.e=e.e,this}lessThan(e){return typeof e=="number"&&(console.log("ManExp.lessThan() passed number instead of ManExp"),console.trace()),this.m===0?e.m>0:e.m===0?this.m<=0:this.e===e.e?this.m<e.m:this.m>0?e.m>0&&this.e<e.e:e.m>0||this.e>e.e}lessThanEquals(e){return!this.greaterThan(e)}greaterThan(e){return typeof e=="number"&&(console.log("ManExp.greaterThan() passed number instead of ManExp"),console.trace()),this.m===0?e.m<0:e.m===0?this.m>0:this.e===e.e?this.m>e.m:this.m>0?e.m<0||this.e>e.e:e.m<0&&this.e<e.e}greaterThanEquals(e){return!this.lessThan(e)}compare(e){if(typeof e=="number"&&(console.log("ManExp.compare() passed number instead of ManExp"),console.trace()),this.m===0){if(e.m===0)return 0;if(e.m<0)return 1;if(e.m>0)return-1}if(e.m===0){if(this.m<0)return-1;if(this.m>0)return 1}if(this.m>0)return e.m<0||this.e>e.e?1:this.e<e.e?-1:this.m>e.m?1:this.m<e.m?-1:0;if(this.m<0)return e.m>0||this.e>e.e?-1:this.e<e.e||this.m>e.m?1:this.m<e.m?-1:0}equals(e){return this.e===e.e&&this.m===e.m}equalsZero(){return this.e===0&&this.m===0}};var ai=17,qt=9e15,Cl=308,Fi=-324,nd=1e-10,Ol=[];for(let l=Fi+1;l<=Cl;l++)Ol.push(+("1e"+l));var te=class l{constructor(){}static powerOf10(e){return Ol[e+323]}static fromNumber(e,t){return isNaN(t)?(e.m=Number.NaN,e.e=Number.NaN):t===Number.POSITIVE_INFINITY?(e.m=1,e.e=qt):t===Number.NEGATIVE_INFINITY?(e.m=-1,e.e=qt):t===0?(e.m=0,e.e=0):(e.e=Math.floor(Math.log10(Math.abs(t))),e.m=e.e===Fi?t*10/1e-323:t/l.powerOf10(e.e),l.normalize(e)),e}static negate(e){return typeof value=="number"&&(console.log("BigNumMath.negate() passed number instead of BigNum"),console.trace()),e.m=-e.m,e}static copy(e,t){return typeof t=="number"&&(console.log("BigNumMath.copy() passed number instead of BigNum"),console.trace()),e.m=t.m,e.e=t.e,e}static normalize(e){if(e.m>=1&&e.m<10)return e;if(e.m===0)return e.m=0,e.e=0,e;let t=Math.floor(Math.log10(Math.abs(e.m)));return e.m=t===Fi?e.m*10/1e-323:e.m/l.powerOf10(t),e.e+=t,e}static multiply(e,t){return typeof t=="number"&&(console.log("BigNumMath.multiply() passed number instead of BigNum"),console.trace()),e.m*=t.m,e.e+=t.e,l.normalize(e)}static add(e,t){if(typeof t=="number"&&(console.log("BigNumMath.add() passed number instead of BigNum"),console.trace()),e.m===0)return e.m=t.m,e.e=t.e,e;if(t.m===0)return e;let i,s,r,o;if(e.e>=t.e?(i=e.m,s=e.e,r=t.m,o=t.e):(i=t.m,s=t.e,r=e.m,o=e.e),s-o>ai)return e.m=i,e.e=s,e;let a=Math.round(1e14*i+1e14*r*l.powerOf10(o-s));return e.m=a,e.e=s-14,l.normalize(e)}static log10(e){return typeof e=="number"&&(console.log("BigNumMath.log10() passed number instead of BigNum"),console.trace()),e.e+Math.log10(e.m)}static log2(e){return 3.321928094887362*l.log10(e)}static ln(e){return 2.302585092994045*l.log10(e)}static log(e,t){return Math.LN10/Math.log(t)*l.log10(e)}static pow10(e,t){return Number.isInteger(t)?(e.set(1,t),e):(e.set(Math.pow(10,t%1),Math.trunc(t)),l.normalize(e))}static pow(e,t){let i=t,s=e.e*i,r;if(Number.isSafeInteger(s)&&(r=Math.pow(e.m,i),isFinite(r)&&r!==0))return e.m=r,e.e=s,l.normalize(e);let o=Math.trunc(s),a=s-o;return r=Math.pow(10,i*Math.log10(e.m)+a),isFinite(r)&&r!==0?(e.m=r,e.e=o,l.normalize(e)):(l.pow10(e,i*l.absLog10(e)),l.sign(e)===-1?Math.abs(i%2)===1?l.negate(e):(Math.abs(i%2)===0||(e.m=Number.NaN,e.e=Number.NaN),e):e)}static toString(e){return typeof e=="number"&&(console.log("BigNumMath.toString() passed number instead of BigNum"),console.trace()),isNaN(e.m)||isNaN(e.e)?"NaN":e.e>=qt?e.m>0?"Infinity":"-Infinity":e.e<=-qt||e.m===0?"0":e.e<21&&e.e>-7?l.toNumber(e).toString():e.m+"e"+(e.e>=0?"+":"")+e.e}static toNumber(e){if(typeof e=="number"&&(console.log("BigNumMath.toNumber() passed number instead of BigNum"),console.trace()),!isFinite(e.e))return Number.NaN;if(e.e>Cl)return e.m>0?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY;if(e.e<Fi)return 0;if(e.e===Fi)return e.m>0?5e-324:-5e-324;let t=e.m*l.powerOf10(e.e);if(!isFinite(t)||e.e<0)return t;let i=Math.round(t);return Math.abs(i-t)<nd?i:t}static toExponential(e,t){if(typeof e=="number"&&(console.log("BigNumMath.toExponential() passed number instead of BigNum"),console.trace()),isNaN(e.m)||isNaN(e.e))return"NaN";if(e.e>=qt)return e.m>0?"Infinity":"-Infinity";if(e.e<=-qt||e.m===0)return"0"+(t>0?l.padEnd(".",t+1,"0"):"")+"e+0";if(e.e>Fi&&e.e<Cl)return l.toNumber(e).toExponential(t);isFinite(t)||(t=ai);let i=t+1,s=Math.max(1,Math.ceil(Math.log10(Math.abs(e.m))));return(Math.round(e.m*Math.pow(10,i-s))*Math.pow(10,s-i)).toFixed(Math.max(i-s,0))+"e"+(e.e>=0?"+":"")+e.e}static toFixed(e,t){return typeof e=="number"&&(console.log("BigNumMath.toFixed() passed number instead of BigNum"),console.trace()),isNaN(e.m)||isNaN(e.e)?"NaN":e.e>=qt?e.m>0?"Infinity":"-Infinity":e.e<=-qt||e.m===0?"0"+(t>0?l.padEnd(".",t+1,"0"):""):e.e>=ai?e.m.toString().replace(".","").padEnd(e.e+1,"0")+(t>0?l.padEnd(".",t+1,"0"):""):l.toNumber(e).toFixed(t)}static toPrecision(e,t){return typeof e=="number"&&(console.log("BigNumMath.toPrecision() passed number instead of BigNum"),console.trace()),e.e<=-7?l.toExponential(e,t-1):t>e.e?l.toFixed(e,t-e.e-1):l.toExponential(e,t-1)}static valueOf(e){return l.toString(e)}static toJSON(e){return l.toString(e)}static toStringWithDecimalPlaces(e,t){return l.toExponential(e,t)}static abs(e){return typeof value=="number"&&(console.log("BigNumMath.abs() passed number instead of BigNum"),console.trace()),e.m=Math.abs(e.m),e}static sign(e){return typeof e=="number"&&(console.log("BigNumMath.sign() passed number instead of BigNum"),console.trace()),Math.sign(e.m)}static round(e){return e.e<-1?e.setZero():e.e<ai?l.fromNumber(e,Math.round(l.toNumber(e))):e}static floor(e){return e.e<-1?Math.sign(e.m)>=0?e.setZero():l.fromNumber(e,-1):e.e<ai?l.fromNumber(e,Math.floor(l.toNumber(e))):e}static ceil(e){return e.e<-1?Math.sign(e.m)>0?l.fromNumber(e,1):e.setZero():e.e<ai?l.fromNumber(e,Math.ceil(l.toNumber(e))):e}static trunc(e){return e.e<0?e.setZero():e.e<ai?l.fromNumber(e,Math.trunc(l.toNumber(e))):e}static recip(e){return e.m=1/e.m,e.e=-e.e,l.normalize(e)}static absLog10(e){return e.e+Math.log10(Math.abs(e.m))}static padEnd(e,t,i){if(e==null||t==null)return e;let s=String(e),r=typeof t=="number"?t:parseInt(t,10);if(isNaN(r)||!isFinite(r))return s;let o=s.length;if(o>=r)return s;let a=i==null?"":String(i);a===""&&(a=" ");let h=r-o;for(;a.length<h;)a+=a;let m=a.length>h?a.substr(0,h):a;return s+m}};var me=new ki(0,0),d=class l extends ki{constructor(e){super(0,0),this.setValue(e)}setValue(e){return te.fromNumber(this,e),this}multiplyNumber(e){return e instanceof l&&(console.log("BigNum.multiplyNumber() passed BigNum instead of number"),console.trace()),te.fromNumber(me,e),te.multiply(this,me)}mulNumber(e){return this.multiplyNumber(e)}multiply(e){return te.multiply(this,e)}mul(e){return this.multiply(e)}addNumber(e){return e instanceof l&&(console.log("BigNum.addNumber() passed BigNum instead of number"),console.trace()),te.fromNumber(me,e),te.add(this,me)}add(e){return te.add(this,e)}subNumber(e){return e instanceof l&&(console.log("BigNum.subNumber() passed BigNum instead of number"),console.trace()),te.fromNumber(me,-e),te.add(this,me)}subtractNumber(e){return this.subNumber(e)}sub(e){return te.copy(me,e),te.negate(me),te.add(this,me)}subtract(e){return this.sub(e)}recip(){return te.recip(this)}divideNumber(e){return e instanceof l&&(console.log("BigNum.divideNumber() passed BigNum instead of number"),console.trace()),te.fromNumber(me,e),te.recip(me),te.multiply(this,me)}divNumber(e){return this.divideNumber(e)}divide(e){return te.copy(me,e),te.recip(me),te.multiply(this,me)}div(e){return this.divide(e)}round(){return te.round(this)}floor(){return te.floor(this)}ceil(){return te.ceil(this)}trunc(){return te.trunc(this)}abs(){return te.abs(this)}log10(){return te.log10(this)}log2(){return te.log2(this)}ln(){return te.ln(this)}log(e){return te.log(this,e)}pow(e){return te.pow(this,e)}toString(){return te.toString(this)}toDebugString(){return this.toString()+", (m="+this.m+", e="+this.e+")"}toNumber(){return te.toNumber(this)}toExponential(e){return te.toExponential(this,e)}toFixed(e){return te.toFixed(this,e)}toPrecision(e){return te.toPrecision(this,e)}valueOf(){return te.valueOf(this)}toJSON(){return te.toJSON(this)}toStringWithDecimalPlaces(e){return te.toStringWithDecimalPlaces(this,e)}sign(){return te.sign(this)}equalsNumber(e){return e instanceof l&&(console.log("BigNum.equalsNumber() passed BigNum instead of number"),console.trace()),te.fromNumber(me,e),this.equals(me)}lessThanNumber(e){return e instanceof l&&(console.log("BigNum.lessThanNumber() passed BigNum instead of number"),console.trace()),te.fromNumber(me,e),this.lessThan(me)}lessThanZero(){return me.setZero(),this.lessThan(me)}lessThanEqualsZero(){return me.setZero(),!this.greaterThan(me)}lessThanEqualsNumber(e){return e instanceof l&&(console.log("BigNum.lessThanEqualsNumber() passed BigNum instead of number"),console.trace()),te.fromNumber(me,e),this.lessThanEquals(me)}greaterThanNumber(e){return e instanceof l&&(console.log("BigNum.greaterThanNumber() passed BigNum instead of number"),console.trace()),te.fromNumber(me,e),this.greaterThan(me)}greaterThanEqualsNumber(e){return e instanceof l&&(console.log("BigNum.greaterThanEqualsNumber() passed BigNum instead of number"),console.trace()),te.fromNumber(me,e),!this.lessThan(me)}equalsZero(){return me.setZero(),this.equals(me)}greaterThanZero(){return me.setZero(),this.greaterThan(me)}greaterThanEqualsZero(){return me.setZero(),!this.lessThan(me)}};var gs=class{constructor(){this.working=new d(0),this.hundredThousand=new d(1e5),this.noDecimalPlacesOptions={maximumFractionDigits:0}}formatNumber(e){return e<1e5?this.formatSmallNumber(e):(te.fromNumber(this.working,e),this.bigNumToGameString(this.working))}formatBigNum(e){return e.lessThan(this.hundredThousand)?this.formatSmallNumber(e.toNumber()):this.bigNumToGameString(e)}formatSmallNumber(e){return e<100?Number.isInteger(e)?e.toFixed(0):e.toFixed(2):e<1e3?Number.isInteger(e)?e.toFixed(0):e.toFixed(1):e.toLocaleString(void 0,this.noDecimalPlacesOptions)}bigNumToGameString(e){return typeof e=="number"&&(console.log("BigNumMath.toGameString() passed number instead of BigNum"),console.trace()),isNaN(e.m)||isNaN(e.e)?"NaN":e.e<10?e.m.toFixed(3)+"E"+e.e:e.e<100?e.m.toFixed(2)+"E"+e.e:e.m.toFixed(1)+"E"+e.e}};var vl=new gs,I=class{constructor(){}static formatBigNum(e){return typeof e=="number"&&(console.log("NumberFormatter.formatBigNum() passed number instead of BigNum"),console.trace()),e?vl.formatBigNum(e):"0"}static formatNumber(e){return e instanceof d&&(console.log("NumberFormatter.formatNumber() passed BigNum instead of number"),console.trace()),vl.formatNumber(e)}};var _={UNSET:0,COMMON:1,ORE:2,GOLD:3,UPGRADE:4,RUBY:5};var fs=new d(0),Jt=class{constructor(e,t){this.primaryTileType=e,this.id=e.id,this.name=e.name,this.nominalIndex=t,this.iconFileName=e.iconFileName,this.minDepth=0,this.maxDepth=0,this.oreStep=new d(0),this.baseOre=new d(0),this.healthStep=new d(0),this.baseHealth=new d(0),this.baseGold=null,this.additiveBonusFactor=0,this.multiplicativeBonusFactor=0,this.maxHealth=new d(0),this.oreTileType=ws(e),this.goldTileType=Ts(e),this.upgradeTileType=Cs(e),this.rubyTileType=Es(e),this.prevLayer=null,this.nextLayer=null,this.monsterDescriptions=[],e.layerDescription&&console.log("LayerDescription ERROR: primary tile type already has a layer desc. Tile Reuse? layer: "+this.id+" tileType="+e.id),e.layerDescription=this,this.oreTileType&&(this.oreTileType.layerDescription&&console.log("LayerDescription ERROR: ore tile type already has a layer desc. Tile Reuse? layer: "+this.id+" tileType="+this.oreTileType.id),this.oreTileType.rarityModifier!==_.ORE&&console.log("LayerDescription ERROR layer="+this.name+": ORE tile type with rarity: "+this.oreTileType.rarityModifier),this.oreTileType.layerDescription=this),this.goldTileType&&(this.goldTileType.layerDescription&&console.log("LayerDescription ERROR: GOLD tile type already has a layer desc. Tile Reuse? layer: "+this.id+" tileType="+this.goldTileType.id),this.goldTileType.rarityModifier!==_.GOLD&&console.log("LayerDescription ERROR layer="+this.name+": GOLD tile type with rarity: "+this.goldTileType.rarityModifier),this.goldTileType.layerDescription=this),this.upgradeTileType&&(this.upgradeTileType.layerDescription&&console.log("LayerDescription ERROR: upgrade tile type already has a layer desc. Tile Reuse? "+this.id+" tileType="+this.upgradeTileType.id),this.upgradeTileType.rarityModifier!==_.UPGRADE&&console.log("LayerDescription ERROR layer="+this.name+": UPGRADE tile type with rarity: "+this.upgradeTileType.rarityModifier),this.upgradeTileType.layerDescription=this),this.rubyTileType&&(this.rubyTileType.layerDescription&&console.log("LayerDescription ERROR: RUBY tile type already has a layer desc. Tile Reuse? "+this.id+" tileType="+this.rubyTileType.id),this.rubyTileType.rarityModifier!==_.RUBY&&console.log("LayerDescription ERROR layer="+this.name+": RUBY tile type with rarity: "+this.rubyTileType.rarityModifier),this.rubyTileType.layerDescription=this)}isDeeperThan(e){return this.minDepth>e.minDepth}getDepthPercent(e){if(e<=this.minDepth)return 0;if(e>=this.maxDepth)return 100;let t=e-this.minDepth,i=this.maxDepth-this.minDepth;return t/i*100}initializeLayerValues(e,t,i,s,r){this.oreStep.copy(s),this.healthStep.copy(r),this.baseGold=new d(e),this.additiveBonusFactor=t,this.multiplicativeBonusFactor=i}initializeLayer(e,t,i){if(this.prevLayer=e,this.prevLayer&&(this.prevLayer.nextLayer=this),this.minDepth=e.maxDepth,t===-1?this.maxDepth=this.minDepth+1e7:this.maxDepth=this.minDepth+t,i)this.baseHealth.copy(this.healthStep),this.baseOre.copy(this.oreStep);else if(e){let s=e.maxDepth-e.minDepth;this.baseHealth.setValue(s),this.baseHealth.mul(e.healthStep),this.baseHealth.add(e.baseHealth),this.baseHealth.add(this.healthStep),this.baseOre.setValue(s),this.baseOre.mul(e.oreStep),this.baseOre.add(e.baseOre),this.baseOre.add(this.oreStep)}else console.log("LayerDescription.initializeLayer() REACHED UNEXPECTED BLOCK. name="+this.name),this.baseHealth.setValue(1),this.baseOre.setValue(1);this.calculateTileHealth(this.maxDepth,this.maxHealth),console.log("Layer: "+this.name+" minDepth="+this.minDepth+" maxDepth="+this.maxDepth+" baseHealth="+I.formatBigNum(this.baseHealth)+" maxHealth="+I.formatBigNum(this.maxHealth)+" baseOre="+I.formatBigNum(this.baseOre))}calculateTileOre(e,t){let i=Math.max(1,e)-this.minDepth;i<=0?t.copy(this.baseOre):(t.copy(this.oreStep),t.mulNumber(i),t.add(this.baseOre))}calculateTileHealth(e,t){let i=Math.max(1,e)-this.minDepth;i<=0?t.copy(this.baseHealth):(t.copy(this.healthStep),t.mulNumber(i),t.add(this.baseHealth))}calculateTileDepth(e){return e.lessThanEquals(this.baseHealth)?this.minDepth:e.greaterThanEquals(this.maxHealth)?this.maxDepth:(fs.copy(e),fs.sub(this.baseHealth),fs.div(this.healthStep),fs.addNumber(this.minDepth),Math.max(0,fs.toNumber()|0))}containsRow(e){return this.maxDepth<=e&&this.maxDepth>e}};var lt=class{constructor(e,t){this.fileName=e,this.loaded=!1,this.spriteSize=t;let i=this;this.image=new Image,this.image.onload=function(){i.populateSpriteMap()}}loadImage(){this.image.src=this.fileName}populateSpriteMap(){}};var Ss=class{constructor(){this.defaultFrameIncrement=0,this.defaultElapsedFrameCount=0,this.defaultAnimationFramesPerFrame=30,this.defaultMillisPerFrame=150,this.slowMillisPerFrame=250,this.fastMillisPerFrame=80,this.superFastMillisPerFrame=30}updateForFrame(e){this.defaultElapsedFrameCount+=e,this.defaultElapsedFrameCount>=this.defaultAnimationFramesPerFrame&&(this.defaultFrameIncrement++,this.defaultElapsedFrameCount=0,this.defaultFrameIncrement>=5e4&&(this.defaultFrameIncrement=0))}getDefaultFrameIndex(e){return this.defaultFrameIncrement%e|0}getFrameIndex(e,t,i,s){return this.getFrameIndexInternal(e,t,i,s,this.defaultMillisPerFrame)}getFastFrameIndex(e,t,i,s){return this.getFrameIndexInternal(e,t,i,s,this.fastMillisPerFrame)}getSlowFrameIndex(e,t,i,s){return this.getFrameIndexInternal(e,t,i,s,this.slowMillisPerFrame)}getSuperFastFrameIndex(e,t,i,s){return this.getFrameIndexInternal(e,t,i,s,this.superFastMillisPerFrame)}getFrameIndexInternal(e,t,i,s,r){let o=this.calculateElapsedFrameCount(e,t,r);return s?o%i|0:o<i?o:-1}calculateElapsedFrameCount(e,t,i){return Math.max(0,e-t)/i|0}isDefaultAnimationLoopCompleted(e,t,i){return this.calculateElapsedFrameCount(e,t,this.defaultMillisPerFrame)>=i}isFastAnimationLoopCompleted(e,t,i){return this.calculateElapsedFrameCount(e,t,this.fastMillisPerFrame)>=i}isSuperFastAnimationLoopCompleted(e,t,i){return this.calculateElapsedFrameCount(e,t,this.superFastMillisPerFrame)>=i}};var wt=class{constructor(e,t,i,s){this.sprites=e,this.spriteAnimationManager=t,this.fastAnimation=i,this.loopingAnimation=s}getSpriteAsOf(e,t){return this.sprites.length===1?this.sprites[0]:this.fastAnimation?this.getFastCurrentSpriteAsOf(e,t):this.getCurrentSpriteAsOf(e,t)}getSpriteAtIndex(e){return e<0||e>=this.sprites.length?null:this.sprites[e]}getCurrentSpriteDefault(){let e=this.spriteAnimationManager.getDefaultFrameIndex(this.sprites.length);return this.sprites[e]}getCurrentSpriteAsOf(e,t){let i=this.spriteAnimationManager.getFrameIndex(e,t,this.sprites.length,this.loopingAnimation);return i<0?null:this.sprites[i]}getCurrentSpriteAsOfNoLooping(e,t){let i=this.spriteAnimationManager.getFrameIndex(e,t,this.sprites.length,!1);return i<0?null:this.sprites[i]}getSlowCurrentSpriteAsOfNoLooping(e,t){let i=this.spriteAnimationManager.getSlowFrameIndex(e,t,this.sprites.length,!1);return i<0?null:this.sprites[i]}getFastCurrentSpriteAsOf(e,t){let i=this.spriteAnimationManager.getFastFrameIndex(e,t,this.sprites.length,this.loopingAnimation);return i<0?null:this.sprites[i]}getSuperFastCurrentSpriteAsOf(e,t){let i=this.spriteAnimationManager.getSuperFastFrameIndex(e,t,this.sprites.length,this.loopingAnimation);return i<0?null:this.sprites[i]}isAnimationLoopCompleted(e){return this.fastAnimation?this.spriteAnimationManager.isFastAnimationLoopCompleted(Date.now(),e,this.sprites.length):this.spriteAnimationManager.isDefaultAnimationLoopCompleted(Date.now(),e,this.sprites.length)}getDirectionSprite(e){return this.sprites[e]}isDirectionalSprite(){return!1}};var Re=class extends ni{constructor(e,t,i){super(t,i),this.spritesheet=e}getImage(){return this.spritesheet.image}getSize(){return this.spritesheet.spriteSize}};var Bt=class extends lt{constructor(e,t){super(e,t),this.step=this.calculateSpriteStep(t)}calculateSpriteStep(e){}parseRow(e,t){let i=[],s=e*this.step,r=0;for(let o=0;o<t;o++)i.push(new Re(this,r,s)),r+=this.step;return i}};var Ns=class extends Bt{constructor(e,t,i){super(e,t),this.spriteAnimationManager=i,this.defaultAnimation=null,this.spriteAnimationMap={},this.loadImage()}getSpriteAnimation(e){let t=this.spriteAnimationMap[e];return t||this.defaultAnimation}calculateSpriteStep(e){return e+1}populateSpriteMap(){let e=0;this.defaultAnimation=this.populateSpriteAnimation(e++,1,!1,!0),this.spriteAnimationManager[$.STAND]=this.defaultAnimation,this.spriteAnimationManager[$.FALL]=this.defaultAnimation,this.spriteAnimationManager[$.MINE]=this.defaultAnimation,this.spriteAnimationManager[$.JUMP]=this.populateSpriteAnimation(e++,1,!1,!0),this.spriteAnimationManager[$.WALK]=this.populateSpriteAnimation(e++,2,!1,!0),this.loaded=!0}populateSpriteAnimation(e,t,i,s){let r=this.parseRow(e,t);return new wt(r,this.spriteAnimationManager,i,s)}};var Ps=class extends lt{constructor(e,t){super(e,t),this.goldRow=0,this.oreRow=1,this.rubyRow=2,this.upgradeRow=3,this.loadImage()}populateSpriteMap(){let e=4;this.loadTileType(ge.SKY,e),e++,this.loadTileTypePlusSpecial(ge.GRASS,e),e++,this.loadTileTypePlusSpecial(ge.DIRT,e),e++;for(let t=0;t<St.length;t++)this.loadTileTypePlusSpecial(St[t],e),e++;this.loaded=!0}loadTileTypePlusSpecial(e,t){this.loadTileType(e,t),this.loadTileType(Ts(e),this.goldRow),this.loadTileType(ws(e),this.oreRow),this.loadTileType(Cs(e),this.upgradeRow),this.loadTileType(Es(e),this.rubyRow)}loadTileType(e,t){let i=(this.spriteSize+1)*16,s=0,r=i,o=2*i;e.tileTemplate=this.parseTileTemplate(s,t),e.tileTemplate2=this.parseTileTemplate(r,t),e.tileTemplate3=this.parseTileTemplate(o,t)}parseTileTemplate(e,t){let i=this.spriteSize+1,s=t*i,r=new As;return r.northBorder=new Re(this,e,s),e+=i,r.eastBorder=new Re(this,e,s),e+=i,r.southBorder=new Re(this,e,s),e+=i,r.westBorder=new Re(this,e,s),e+=i,r.northEastBorder=new Re(this,e,s),e+=i,r.northSouthBorder=new Re(this,e,s),e+=i,r.northWestBorder=new Re(this,e,s),e+=i,r.southEastBorder=new Re(this,e,s),e+=i,r.eastWestBorder=new Re(this,e,s),e+=i,r.southWestBorder=new Re(this,e,s),e+=i,r.northEastSouthBorder=new Re(this,e,s),e+=i,r.northSouthWestBorder=new Re(this,e,s),e+=i,r.northEastWestBorder=new Re(this,e,s),e+=i,r.eastWestSouthBorder=new Re(this,e,s),e+=i,r.northEastSouthWestBorder=new Re(this,e,s),e+=i,r.noBorder=new Re(this,e,s),r}};var Ms=class{constructor(){this.sprites=[]}};var _s=class extends lt{constructor(e,t){super(e,t),this.loadImage()}populateSpriteMap(){let e=4;this.loadTileType(ge.SKY,e),e++,this.loadTileType(ge.GRASS,e),e++,this.loadTileType(ge.DIRT,e),e++;for(let t=0;t<St.length;t++)this.loadTileType(St[t],e),e++;this.loaded=!0}loadTileType(e,t){e.tileTypeBackground=this.parseRow(t)}parseRow(e){let t=this.spriteSize+1,i=48,s=e*t,r=0,o=new Ms;for(let a=0;a<i;a++)o.sprites.push(new Re(this,r,s)),r+=t;return o}};var Le={thruster:{icon:"",staticOverlay:"",activeOverlay:"thruster"},pick:{icon:"",staticOverlay:"pick_s",activeOverlay:"pick_a"},club:{icon:"",staticOverlay:"club_s",activeOverlay:"club_a"},axe:{icon:"",staticOverlay:"axe_s",activeOverlay:"axe_a"},broadSword:{icon:"",staticOverlay:"broad_sword_s",activeOverlay:"broad_sword_a"},mace:{icon:"",staticOverlay:"mace_s",activeOverlay:"mace_a"},twoHandedAxe:{icon:"",staticOverlay:"two_handed_axe_s",activeOverlay:"two_handed_axe_a"},twoHandedClub:{icon:"",staticOverlay:"two_handed_club_s",activeOverlay:"two_handed_club_a"},darkSword:{icon:"",staticOverlay:"dark_sword_s",activeOverlay:"dark_sword_a"},redSword:{icon:"",staticOverlay:"red_sword_s",activeOverlay:"red_sword_a"}};var Rs=class extends Bt{constructor(e,t,i){super(e,t),this.spriteAnimationManager=i,this.spriteAnimationMap={},this.loadImage()}getSpriteAnimation(e){return this.spriteAnimationMap[e]}calculateSpriteStep(e){return e}populateSpriteMap(){let e=0;this.populateSpriteAnimation(Le.thruster.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(Le.pick.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(Le.pick.activeOverlay,e,4,!0,!0),e++,this.populateSpriteAnimation(Le.club.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(Le.club.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(Le.axe.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(Le.axe.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(Le.broadSword.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(Le.broadSword.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(Le.mace.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(Le.mace.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(Le.twoHandedAxe.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(Le.twoHandedAxe.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(Le.twoHandedClub.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(Le.twoHandedClub.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(Le.darkSword.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(Le.darkSword.activeOverlay,e,5,!0,!0),e++,this.populateSpriteAnimation(Le.redSword.staticOverlay,e,1,!1,!0),e++,this.populateSpriteAnimation(Le.redSword.activeOverlay,e,5,!0,!0),this.loaded=!0}populateSpriteAnimation(e,t,i,s,r){let o=new wt(this.parseRow(t,i),this.spriteAnimationManager,s,r);this.spriteAnimationMap[e]=o}};var wl={GREEN_DARK_GREEN1_DARK_GREEN2:"A0",DARK_BROWN1_GREY_ORANGE_BROWN:"A1",LIGHT_BROWN2_BROWN3_YELLOW_BROWN:"A2",LIGHT_YELLOW_YELLOW_ORANGE_YELLOW:"A3",LIGHT_PINK_DARK_PURPLE_YELLOW:"A4",GRAY_DARK_GRAY_LIGHTER_GRAY:"A5",BLUE_DARK_BLUE_LIGHT_GRAY:"A6",LIGHT_GRAY_BLUE_DARK_BLUE:"A7",ORANGE_ORANGE_YELLOW_DARK_ORANGE:"A8",BLUE_DARK_BLUE_PURPLE:"A9",BLUE_ORANGE_YELLOW_PURPLE:"B0",TEAL_LIGHT_BLUE1_PALE_AQUA:"B1",DARK_BROWN_RED_DARK_RED_RED:"B2",DARK_GRAY_ORANGE_RED_BLUE:"B3",DARK_GRAY_LIGHT_PURPLE1_TAN_GREEN:"B4",TAN_GREEN_DARK_GRAY_LIGHT_PURPLE1:"B5",SKY_BLUE_PALE_BLUE_LIGHT_BLUE2:"B6",LIGHT_BROWN2_REDDISH_BROWN_ORANGE_BROWN:"B7",ORANGE_BROWN_REDDISH_BROWN_LIGHT_BROWN2:"B8",DARKER_PURPLE_LIGHT_PURPLE2_LIGHT_YELLOW:"B9",ORANGE_YELLOW_ORANGE_BROWN_LIGHT_BROWN2:"C0",DARK_GRAY_LIGHT_PURPLE1_GREEN_BLUE:"C1",BLUE_ORANGE_YELLOW_DARK_GRAY:"C2",SKY_BLUE_BLUE_LIGHT_GREEN:"C3",VERY_DARK_GREEN_TAN_WHITE_YELLOW:"C4",BROWNISH_GREEN_DARK_RED_SUPER_DARK_GREEN:"C5",YELLOW_ORANGE_DARK_GREEN2:"C6",LIGHT_PURPLE2_DARKER_PURPLE_LIGHT_YELLOW:"C7",DARK_GRAY_DARK_ORANGE_LIGHTER_GRAY:"C8",DARK_ORANGE_DARK_GRAY_LIGHTER_GRAY:"C9",LIGHTER_GRAY_DARK_ORANGE_DARK_GRAY:"D0",LIME_GREEN1_DARK_BLUE_DARK_GRAY:"D1",VERY_DARK_RED_SUPER_DARK_RED_ORANGE_RED:"D2",ORANGE_RED_VERY_DARK_RED_SUPER_DARK_RED:"D3",PURPLE_VERY_DARK_RED_SUPER_DARK_RED:"D4",DARK_GRAY_LIGHT_GRAY_DARK_RED_PINK:"D5",BLACK_LIGHT_BLUE1_LIGHT_BLUE2:"D6",GREEN_BLUE_LIME_GREEN1_BLUE:"D7",GREY_BLUE_GREEN_LIME_GREEN2_YELLOW_BROWN:"D8",ORANGE_YELLOW_YELLOW_BROWN_TAN_GREEN:"D9",LIGHT_BLUE_GREEN_BROWNISH_GREEN_LIME_GREEN2:"E0",LIME_GREEN2_BROWNISH_GREEN_DARK_RED_ORANGE:"E1",GRAY_DARK_BROWN3_DARKER_BROWN:"E2",BLACK_DARKER_BROWN_DARK_BROWN3:"E3",DARK_PURPLE_PURPLE_LIGHT_PURPLE1:"E4",LIGHT_PURPLE1_ORANGE_RED_PURPLE:"E5",GREEN_BROWN_DARK_BROWN2_DARK_GRAY:"E6",SKY_BLUE_BROWNISH_GREEN_LIME_GREEN2:"E7",RED_SKY_BLUE_BROWNISH_GREEN:"E8"};function ad(){let l=[];for(let e of Object.values(wl))l.push(e);return l}var Sl=ad();var R={VINE_TOP0:"V0",VINE_TOP1:"V1",VINE_TOP2:"V2",VINE_TOP3:"V3",VINE_TOP4:"V4",VINE_TOP5:"V5",VINE_TOP6:"V6",VINE_TOP7:"V7",VINE_PARTIAL0:"v0",VINE_PARTIAL1:"v1",VINE_PARTIAL2:"v2",VINE_PARTIAL3:"v3",VINE_PARTIAL4:"v4",VINE_PARTIAL5:"v5",VINE_PARTIAL6:"v6",VINE_PARTIAL7:"v7",FLOOR_PLANT0:"P0",FLOOR_PLANT1:"P1",FLOOR_PLANT2:"P2",FLOOR_PLANT3:"P3",FLOOR_PLANT4:"P4",FLOOR_PLANT5:"P5",FLOOR_PLANT6:"P6",FLOOR_PLANT7:"P7",FLOOR_GRASS0:"G0",FLOOR_GRASS1:"G1",FLOOR_GRASS2:"G2",FLOOR_GRASS3:"G3",FLOOR_GRASS4:"G4",FLOOR_GRASS5:"G5",FLOOR_GRASS6:"G6",FLOOR_GRASS7:"G7",FLOOR_MUSHROOM0:"M0",FLOOR_MUSHROOM1:"M1",FLOOR_MUSHROOM2:"M2",FLOOR_MUSHROOM3:"M3",FLOOR_MUSHROOM4:"M4",FLOOR_MUSHROOM5:"M5",FLOOR_MUSHROOM6:"M6",FLOOR_MUSHROOM7:"M7",WALL_FLOWER0:"W0",WALL_FLOWER1:"W1",WALL_FLOWER2:"W2",WALL_FLOWER3:"W3",WALL_FLOWER4:"W4",WALL_FLOWER5:"W5",WALL_FLOWER6:"W6",WALL_FLOWER7:"W7",STALACTITE0:"S0",STALACTITE1:"S1",STALACTITE2:"S2",STALACTITE3:"S3",STALACTITE4:"S4",STALACTITE5:"S5",STALACTITE6:"S6",STALACTITE7:"S7",STALAGMITE0:"s0",STALAGMITE1:"s1",STALAGMITE2:"s2",STALAGMITE3:"s3",STALAGMITE4:"s4",STALAGMITE5:"s5",STALAGMITE6:"s6",STALAGMITE7:"s7",FLOOR_POKIES0:"f0",FLOOR_POKIES1:"f1",FLOOR_POKIES2:"f2",FLOOR_POKIES3:"f3",FLOOR_POKIES4:"f4",FLOOR_POKIES5:"f5",FLOOR_POKIES6:"f6",FLOOR_POKIES7:"f7",CEILING_POKIES0:"p0",CEILING_POKIES1:"p1",CEILING_POKIES2:"p2",CEILING_POKIES3:"p3",CEILING_POKIES4:"p4",CEILING_POKIES5:"p5",CEILING_POKIES6:"p6",CEILING_POKIES7:"p7",WALL_CRACKS0:"C0",WALL_CRACKS1:"C1",WALL_CRACKS2:"C2",WALL_CRACKS3:"C3",WALL_CRACKS4:"C4",WALL_CRACKS5:"C5",WALL_CRACKS6:"C6",WALL_CRACKS7:"C7",TALL_GRASS0:"g0",TALL_GRASS1:"g1",TALL_GRASS2:"g2",TALL_GRASS3:"g3",TALL_GRASS4:"g4",TALL_GRASS5:"g5",TALL_GRASS6:"g6",TALL_GRASS7:"g7",CEILING_GRASS0:"c0",CEILING_GRASS1:"c1",CEILING_GRASS2:"c2",CEILING_GRASS3:"c3",CEILING_GRASS4:"c4",CEILING_GRASS5:"c5",CEILING_GRASS6:"c6",CEILING_GRASS7:"c7",CURVED_PLANTS0:"a0",CURVED_PLANTS1:"a1",CURVED_PLANTS2:"a2",CURVED_PLANTS3:"a3",CURVED_PLANTS4:"a4",CURVED_PLANTS5:"a5",CURVED_PLANTS6:"a6",CURVED_PLANTS7:"a7",FLOWERS0:"b0",FLOWERS1:"b1",FLOWERS2:"b2",FLOWERS3:"b3",FLOWERS4:"b4",FLOWERS5:"b5",FLOWERS6:"b6",FLOWERS7:"b7",FLOOR_SPIKES0:"d0",FLOOR_SPIKES1:"d1",FLOOR_SPIKES2:"d2",FLOOR_SPIKES3:"d3",FLOOR_SPIKES4:"d4",FLOOR_SPIKES5:"d5",FLOOR_SPIKES6:"d6",FLOOR_SPIKES7:"d7",CEILING_SPIKES0:"e0",CEILING_SPIKES1:"e1",CEILING_SPIKES2:"e2",CEILING_SPIKES3:"e3",CEILING_SPIKES4:"e4",CEILING_SPIKES5:"e5",CEILING_SPIKES6:"e6",CEILING_SPIKES7:"e7",WALL_HOLES0:"h0",WALL_HOLES1:"h1",WALL_HOLES2:"h2",WALL_HOLES3:"h3",WALL_HOLES4:"h4",WALL_HOLES5:"h5",WALL_HOLES6:"h6",WALL_HOLES7:"h7"},ld=[R.VINE_TOP0,R.VINE_TOP1,R.VINE_TOP2,R.VINE_TOP3,R.VINE_TOP4,R.VINE_TOP5,R.VINE_TOP6,R.VINE_TOP7],dd=[R.VINE_PARTIAL0,R.VINE_PARTIAL1,R.VINE_PARTIAL2,R.VINE_PARTIAL3,R.VINE_PARTIAL4,R.VINE_PARTIAL5,R.VINE_PARTIAL6,R.VINE_PARTIAL7],hd=[R.FLOOR_PLANT0,R.FLOOR_PLANT1,R.FLOOR_PLANT2,R.FLOOR_PLANT3,R.FLOOR_PLANT4,R.FLOOR_PLANT5,R.FLOOR_PLANT6,R.FLOOR_PLANT7],ud=[R.FLOOR_GRASS0,R.FLOOR_GRASS1,R.FLOOR_GRASS2,R.FLOOR_GRASS3,R.FLOOR_GRASS4,R.FLOOR_GRASS5,R.FLOOR_GRASS6,R.FLOOR_GRASS7],cd=[R.FLOOR_MUSHROOM0,R.FLOOR_MUSHROOM1,R.FLOOR_MUSHROOM2,R.FLOOR_MUSHROOM3,R.FLOOR_MUSHROOM4,R.FLOOR_MUSHROOM5,R.FLOOR_MUSHROOM6,R.FLOOR_MUSHROOM7],md=[R.WALL_FLOWER0,R.WALL_FLOWER1,R.WALL_FLOWER2,R.WALL_FLOWER3,R.WALL_FLOWER4,R.WALL_FLOWER5,R.WALL_FLOWER6,R.WALL_FLOWER7],pd=[R.STALACTITE0,R.STALACTITE1,R.STALACTITE2,R.STALACTITE3,R.STALACTITE4,R.STALACTITE5,R.STALACTITE6,R.STALACTITE7],gd=[R.STALAGMITE0,R.STALAGMITE1,R.STALAGMITE2,R.STALAGMITE3,R.STALAGMITE4,R.STALAGMITE5,R.STALAGMITE6,R.STALAGMITE7],fd=[R.FLOOR_POKIES0,R.FLOOR_POKIES1,R.FLOOR_POKIES2,R.FLOOR_POKIES3,R.FLOOR_POKIES4,R.FLOOR_POKIES5,R.FLOOR_POKIES6,R.FLOOR_POKIES7],Td=[R.CEILING_POKIES0,R.CEILING_POKIES1,R.CEILING_POKIES2,R.CEILING_POKIES3,R.CEILING_POKIES4,R.CEILING_POKIES5,R.CEILING_POKIES6,R.CEILING_POKIES7],Ed=[R.TALL_GRASS0,R.TALL_GRASS1,R.TALL_GRASS2,R.TALL_GRASS3,R.TALL_GRASS4,R.TALL_GRASS5,R.TALL_GRASS6,R.TALL_GRASS7],Cd=[R.CEILING_GRASS0,R.CEILING_GRASS1,R.CEILING_GRASS2,R.CEILING_GRASS3,R.CEILING_GRASS4,R.CEILING_GRASS5,R.CEILING_GRASS6,R.CEILING_GRASS7],wd=[R.CURVED_PLANTS0,R.CURVED_PLANTS1,R.CURVED_PLANTS2,R.CURVED_PLANTS3,R.CURVED_PLANTS4,R.CURVED_PLANTS5,R.CURVED_PLANTS6,R.CURVED_PLANTS7],Sd=[R.FLOWERS0,R.FLOWERS1,R.FLOWERS2,R.FLOWERS3,R.FLOWERS4,R.FLOWERS5,R.FLOWERS6,R.FLOWERS7],Nd=[R.FLOOR_SPIKES0,R.FLOOR_SPIKES1,R.FLOOR_SPIKES2,R.FLOOR_SPIKES3,R.FLOOR_SPIKES4,R.FLOOR_SPIKES5,R.FLOOR_SPIKES6,R.FLOOR_SPIKES7],Pd=[R.CEILING_SPIKES0,R.CEILING_SPIKES1,R.CEILING_SPIKES2,R.CEILING_SPIKES3,R.CEILING_SPIKES4,R.CEILING_SPIKES5,R.CEILING_SPIKES6,R.CEILING_SPIKES7],Ad=[R.WALL_HOLES0,R.WALL_HOLES1,R.WALL_HOLES2,R.WALL_HOLES3,R.WALL_HOLES4,R.WALL_HOLES5,R.WALL_HOLES6,R.WALL_HOLES7],Nl=[ld,pd,Td,Cd,Pd],Pl=[dd,md,Ad],Al=[hd,ud,cd,gd,fd,Ed,wd,Sd,Nd];var li=class extends lt{constructor(e,t){super(e,t),this.spriteMap={}}getSprite(e){return this.spriteMap[e]}};var di=class l extends li{constructor(e,t){super(e,t),this.loadImage()}static getSpriteName(e,t){return e+"_"+t}populateSpriteMap(){let e=0;for(let t of Object.values(R))this.parseRow(e,t),e++;this.loaded=!0}parseRow(e,t){let i=this.spriteSize+1,s=e*i,r=0;for(let o of Object.values(wl)){let a=l.getSpriteName(t,o);this.spriteMap[a]=new Re(this,r,s),r+=i}}getFixtureSprite(e,t){return this.getSprite(l.getSpriteName(e,t))}};var g={AQUATIC_SNAKE_TAN_1:"AQUATIC_SNAKE_TAN1",AQUATIC_SNAKE_TAN_2:"AQUATIC_SNAKE_TAN2",AQUATIC_SNAKE_BLACK_1:"AQUATIC_SNAKE_BLACK1",AQUATIC_SNAKE_BLACK_2:"AQUATIC_SNAKE_BLACK2",AQUATIC_MONSTER:"AQUATIC_MONSTER",AVIAN_BAT_BROWN_SMALL:"AVIAN_BAT_BROWN_SMALL",AVIAN_BAT_BROWN_LARGE:"AVIAN_BAT_BROWN_LARGE",AVIAN_BAT_BLACK_LARGE:"AVIAN_BAT_BLACK_LARGE",AVIAN_BAT_BROWN_SMALL2:"AVIAN_BAT_BROWN_SMALL2",AVIAN_BAT_BROWN_LARGE2:"AVIAN_BAT_BROWN_LARGE2",DEMON_REPTILIAN_GREEN:"DEMON_REPTILIAN_GREEN",DEMON_REPTILIAN_WINGED:"DEMON_REPTILIAN_WINGED",DEMON_BROWN:"DEMON_BROWN",DEMON_BLOB:"DEMON_BLOB",DEMON_BLUE:"DEMON_BLUE",DEMON_BLUE_WINGED:"DEMON_BLUE_WINGED",DEMON_RED_GLOWING:"DEMON_RED_GLOWING",DEMON_RED_WINGED_1:"DEMON_RED_WINGED1",DEMON_RED_WINGED_2:"DEMON_RED_WINGED2",DEMON_RED_DARK_LARGE:"DEMON_RED_DARK_LARGE",DEMON_RED_LARGE:"DEMON_RED_LARGE",DEMON_RED_PALE_LARGE:"DEMON_RED_PALE_LARGE",DEMON_BLUE_LARGE:"DEMON_BLUE_LARGE",DEMON_BLUE_RED_LARGE:"DEMON_BLUE_RED_LARGE",DEMON_GREEN_EYE_STOCKS:"DEMON_GREEN_EYE_STOCKS",DEMON_GREEN_EVIL_WINGED:"DEMON_GREEN_EVIL_WINGED",DEMON_RED_DARK_WHIP:"DEMON_RED_DARK_WHIP",DEMON_RED_TINY_JUMPING:"DEMON_RED_TINY_JUMPING",DEMON_RED_SMALL_JUMPING:"DEMON_RED_SMALL_JUMPING",DEMON_ARMORED:"DEMON_ARMORED",DEMON_HELMET_HORNED:"DEMON_HELMET_HORNED",DEMON_RED_FANGED:"DEMON_RED_FANGED",DEMON_GREEN_FROG_LIKE:"DEMON_GREEN_FROG_LIKE",ELEMENTAL_WARRIOR:"ELEMENTAL_WARRIOR",ELEMENTAL_SQUID:"ELEMENTAL_SQUID",ELEMENTAL_GOLEM:"ELEMENTAL_GOLEM",ELEMENTAL_GOLEM_DARK:"ELEMENTAL_GOLEM_DARK",ELEMENTAL_GOLEM_RUSTY:"ELEMENTAL_GOLEM_RUSTY",ELEMENTAL_BLOODY:"ELEMENTAL_BLOODY",ELEMENTAL_STONE:"ELEMENTAL_STONE",ELEMENTAL_SWIRL_ORANGE:"ELEMENTAL_SWIRL_ORANGE",ELEMENTAL_SWIRL_YELLOW:"ELEMENTAL_SWIRL_YELLOW",ELEMENTAL_SWIRL_BLUE_DARK:"ELEMENTAL_SWIRL_BLUE_DARK",ELEMENTAL_SWIRL_BLUE_LIGHT:"ELEMENTAL_SWIRL_BLUE_LIGHT",ELEMENTAL_SWIRL_RED:"ELEMENTAL_SWIRL_RED",ELEMENTAL_CREEPY_RED:"ELEMENTAL_CREEPY_RED",ELEMENTAL_CREEPY_BROWN:"ELEMENTAL_CREEPY_BROWN",ELEMENTAL_CREEPY_LIGHT_BLUE:"ELEMENTAL_CREEPY_LIGHT_BLUE",ELEMENTAL_BALL_GREEN:"ELEMENTAL_BALL_GREEN",ELEMENTAL_BALL_BLUE:"ELEMENTAL_BALL_BLUE",ELEMENTAL_BALL_RED:"ELEMENTAL_BALL_RED",ELEMENTAL_BALL_BLACK:"ELEMENTAL_BALL_BLACK",ELEMENTAL_EYE_WHITE:"ELEMENTAL_EYE_WHITE",ELEMENTAL_EYE_RED:"ELEMENTAL_EYE_RED",ELEMENTAL_EYE_BEHOLDER:"ELEMENTAL_EYE_BEHOLDER",HUMANOID_210_SASQUATCH:"HUMANOID_210_SASQUATCH",HUMANOID_000:"HUMANOID_000",HUMANOID_001:"HUMANOID_001",HUMANOID_002:"HUMANOID_002",HUMANOID_003:"HUMANOID_003",HUMANOID_004:"HUMANOID_004",HUMANOID_005:"HUMANOID_005",HUMANOID_006:"HUMANOID_006",HUMANOID_007:"HUMANOID_007",HUMANOID_010_MINOTAUR:"HUMANOID_010_MINOTAUR",HUMANOID_011_CYCLOPS:"HUMANOID_011_CYCLOPS",HUMANOID_040_WALRUS_MAN:"HUMANOID_040_WALRUS_MAN",HUMANOID_041_WALRUS_MAN:"HUMANOID_041_WALRUS_MAN",HUMANOID_042_WALRUS_MAN:"HUMANOID_042_WALRUS_MAN",HUMANOID_043_WALRUS_MAN:"HUMANOID_043_WALRUS_MAN",HUMANOID_044_WALRUS_MAN:"HUMANOID_044_WALRUS_MAN",HUMANOID_045_WALRUS_MAN:"HUMANOID_045_WALRUS_MAN",HUMANOID_046_WALRUS_MAN:"HUMANOID_046_WALRUS_MAN",HUMANOID_070:"HUMANOID_070",HUMANOID_071:"HUMANOID_071",HUMANOID_072:"HUMANOID_072",HUMANOID_073:"HUMANOID_073",HUMANOID_170_STONE_SERPENT:"HUMANOID_170_STONE_SERPENT",HUMANOID_171_STONE_SERPENT:"HUMANOID_171_STONE_SERPENT",MISC_ANIMAL_70:"MISC_ANIMAL_70",HUMANOID_190_DEMON_BASHER:"HUMANOID_190_DEMON_BASHER",HUMANOID_191_DEMON_BASHER:"HUMANOID_191_DEMON_BASHER",HUMANOID_200_SQUID_DEMON:"HUMANOID_200_SQUID_DEMON",HUMANOID_201_SQUID_DEMON:"HUMANOID_201_SQUID_DEMON",MISC_ANIMAL_03_OWL:"MISC_ANIMAL_03_OWL",MISC_ANIMAL_04:"MISC_ANIMAL_04",MISC_ANIMAL_05:"MISC_ANIMAL_05",MISC_ANIMAL_06:"MISC_ANIMAL_06",MISC_ANIMAL_11:"MISC_ANIMAL_11",MISC_ANIMAL_12:"MISC_ANIMAL_12",MISC_ANIMAL_50:"MISC_ANIMAL_50",MISC_ANIMAL_51:"MISC_ANIMAL_51",MISC_ANIMAL_52:"MISC_ANIMAL_52",MISC_ANIMAL_53:"MISC_ANIMAL_53",PEST_LADYBUG_100:"PEST_LADYBUG_100",PEST_LADYBUG_101:"PEST_LADYBUG_101",PEST_TINY_00:"PEST_TINY_00",PEST_TINY_01:"PEST_TINY_01",PEST_TINY_02:"PEST_TINY_02",PEST_TINY_03:"PEST_TINY_03",PEST_TINY_04:"PEST_TINY_04",PEST_TINY_05:"PEST_TINY_05",PEST_TINY_WORM_1:"PEST_TINY_WORM1",PEST_TINY_WORM_2:"PEST_TINY_WORM2",PEST_ANT_10:"PEST_INSECT_10",PEST_INSECT_11:"PEST_INSECT_11",PEST_INSECT_12:"PEST_INSECT_12",PEST_INSECT_13:"PEST_INSECT_13",PEST_INSECT_14:"PEST_INSECT_14",PEST_SPIDER_20:"PEST_SPIDER_20",PEST_SPIDER_21:"PEST_SPIDER_21",PEST_SPIDER_22:"PEST_SPIDER_22",PEST_SCORPION_23:"PEST_SCORPION_23",PEST_SCORPION_24:"PEST_SCORPION_24",PEST_SCORPION_25:"PEST_SCORPION_25",PEST_WORM_30:"PEST_WORM_30",PEST_WORM_31:"PEST_WORM_31",PEST_BALL:"PEST_BALL",PEST_WORM_33:"PEST_WORM_33",PEST_WORM_34:"PEST_WORM_34",PEST_GIANT_ANT_40:"PEST_GIANT_ANT_40",PEST_GIANT_ANT_41:"PEST_GIANT_ANT_41",PEST_GIANT_ANT_42:"PEST_GIANT_ANT_42",PEST_GIANT_ANT_43:"PEST_GIANT_ANT_43",PEST_SLUG_70:"PEST_SLUG_70",PEST_SLUG_71:"PEST_SLUG_71",PEST_SNAIL_72:"PEST_SNAIL_72",PEST_SNAIL_73:"PEST_SNAIL_73",PEST_INSECT_60:"PEST_INSECT_60",PEST_INSECT_61:"PEST_INSECT_61",PEST_INSECT_80:"PEST_INSECT_80",PEST_INSECT_81:"PEST_INSECT_81",MINOR_DEVIL:"PLAYER_130_MINOR_DEVIL",MINOR_DEVIL_WARRIOR:"PLAYER_131_MINOR_DEVIL_WARRIOR",ORC1:"PLAYER_120_ORC",ORC_WARRIOR:"PLAYER_121_ORC_WARRIOR",ORC_FIGHTER:"PLAYER_122_ORC_FIGHTER",ORC_KARATE:"PLAYER_123_ORC_KARATE",ORC_PIRATE:"PLAYER_124_ORC_PIRATE",ORC2:"PLAYER_125_ORC",ORC3:"PLAYER_126_ORC",ORC4:"PLAYER_127_ORC",DRAGON_MAN_BASIC:"PLAYER_140_DRAGON_MAN_BASIC",DRAGON_MAN_EXPLORER:"PLAYER_141_DRAGON_MAN_EXPLORER",DRAGON_MAN_FIGHTER:"PLAYER_142_DRAGON_MAN_FIGHTER",DRAGON_MAN_RUFFIAN:"PLAYER_143_DRAGON_MAN_RUFFIAN",DRAGON_MAN_RANGER:"PLAYER_144_DRAGON_MAN_RANGER",DRAGON_MAN_TERRIBLE:"PLAYER_145_DRAGON_MAN_TERRIBLE",DRAGON_MAN_MERCILESS:"PLAYER_146_DRAGON_MAN_MERCILESS",DRAGON_MAN_FIERY:"PLAYER_147_DRAGON_MAN_FIERY",QUADRUPED_000:"QUADRUPED_000",QUADRUPED_001:"QUADRUPED_001",QUADRUPED_002:"QUADRUPED_002",QUADRUPED_003:"QUADRUPED_003",QUADRUPED_004:"QUADRUPED_004",QUADRUPED_005:"QUADRUPED_005",QUADRUPED_006:"QUADRUPED_006",QUADRUPED_007:"QUADRUPED_007",RODENT_10_RAT_SMALL:"RODENT_10_RAT_SMALL",RODENT_11_RAT:"RODENT_11_RAT",RODENT_12_RAT_LARGE_BROWN:"RODENT_12_RAT_LARGE_BROWN",RODENT_13_RAT_LARGE_GREY:"RODENT_13_RAT_LARGE_GREY",RODENT_20_RAT_POISONOUS:"RODENT_20_RAT_POISONOUS",RODENT_21_RAT_ZOMBIE:"RODENT_21_RAT_ZOMBIE",RODENT_22_MOLE:"RODENT_22_MOLE",SLIME_BLUE_00:"SLIME_BLUE_00",SLIME_BROWN_01:"SLIME_BROWN_01",SLIME_WHITE_02:"SLIME_WHITE_02",SLIME_GREEN_03:"SLIME_GREEN_03",SLIME_PINK_04:"SLIME_PINK_04",SLIME_PURPLE_05:"SLIME_PURPLE_05",SLIME_MUCUS_GREEN_40:"SLIME_MUCUS_GREEN_40",SLIME_MUCUS_BLUE_41:"SLIME_MUCUS_BLUE_41",SLIME_CORRODED_20:"SLIME_CORRODED_20",SLIME_SEEING_21:"SLIME_SEEING_21",SLIME_ORANGE_22:"SLIME_ORANGE_22",SLIME_MINI_BLUE_30:"SLIME_MINI_BLUE_30",SLIME_MINI_31:"SLIME_MINI_31",SLIME_MINI_ORANGE_32:"SLIME_MINI_ORANGE_32",UNDEAD_WRAITH_0600:"UNDEAD_WRAITH_0600",UNDEAD_WRAITH_0601:"UNDEAD_WRAITH_0601",UNDEAD_GOBLIN0:"UNDEAD_GOBLIN0",UNDEAD_GOBLIN1:"UNDEAD_GOBLIN1",UNDEAD_GOBLIN2:"UNDEAD_GOBLIN2",UNDEAD_GOBLIN3:"UNDEAD_GOBLIN3",UNDEAD_GOBLIN4:"UNDEAD_GOBLIN4",UNDEAD_GOBLIN5:"UNDEAD_GOBLIN5",UNDEAD_GOBLIN6:"UNDEAD_GOBLIN6",UNDEAD_GOBLIN7:"UNDEAD_GOBLIN7",UNDEAD_KOBOLD_SKELETON_0200:"UNDEAD_KOBOLD_SKELETON_0200",UNDEAD_KOBOLD_SKELETON_0201:"UNDEAD_KOBOLD_SKELETON_0201",UNDEAD_KOBOLD_SKELETON_0202:"UNDEAD_KOBOLD_SKELETON_0202",UNDEAD_KOBOLD_SKELETON_0203:"UNDEAD_KOBOLD_SKELETON_0203",UNDEAD_KOBOLD4:"UNDEAD_KOBOLD4",UNDEAD_KOBOLD5:"UNDEAD_KOBOLD5",UNDEAD_KOBOLD_KING_0206:"UNDEAD_KOBOLD_KING_0206",UNDEAD_KOBOLD_ANCIENT_EVIL7:"UNDEAD_KOBOLD_ANCIENT_EVIL7",UNDEAD_GHOST_0400:"UNDEAD_GHOST_0400",UNDEAD_GHOST_0401:"UNDEAD_GHOST_0401",UNDEAD_GHOST_0402:"UNDEAD_GHOST_0402",UNDEAD_GHOST_0403:"UNDEAD_GHOST_0403",UNDEAD_REAPER_0500:"UNDEAD_REAPER_0500",UNDEAD_REAPER_0501:"UNDEAD_REAPER_0501",UNDEAD_REAPER_0502:"UNDEAD_REAPER_0502",UNDEAD_DARKNESS_0801:"UNDEAD_DARKNESS_0801",REPTILE_FLYING_SERPENT_SMALL_002:"REPTILE_FLYING_SERPENT_SMALL_002",REPTILE_FLYING_SERPENT_003:"REPTILE_FLYING_SERPENT_003",REPTILE_BROWN_SERPENT_SMALL_040:"REPTILE_BROWN_SERPENT_SMALL_040",REPTILE_BROWN_SERPENT_041:"REPTILE_BROWN_SERPENT_041",REPTILE_BROWN_SERPENT_LARGE_042:"REPTILE_BROWN_SERPENT_LARGE_042",REPTILE_BLACK_SERPENT_043:"REPTILE_BLACK_SERPENT_043",REPTILE_BLACK_SERPENT_LARGE_044:"REPTILE_BLACK_SERPENT_LARGE_044",REPTILE_BLACK_SERPENT_POISONOUS_045:"REPTILE_BLACK_SERPENT_POISONOUS_045",REPTILE_GREEN_SNAKE_SMALL_046:"REPTILE_GREEN_SNAKE_SMALL_046",REPTILE_GREEN_SNAKE_047:"REPTILE_GREEN_SNAKE_047"};var ys=class extends ni{constructor(e,t,i,s,r){super(s,r),this.spriteAnimationManager=e,this.spritesheet0=t,this.spritesheet1=i}getImage(){return this.spriteAnimationManager.getDefaultFrameIndex(2)==0?this.spritesheet0.image:this.spritesheet1.image}getSize(){return this.spritesheet0.spriteSize}};var Gi=class extends li{constructor(e,t,i){super(e,t),this.monsterSpritesheet=i,this.loadImage()}populateSpriteMap(){this.loaded=!0,this.monsterSpritesheet.onSpritesheetLoaded()}};var Ls=class{constructor(e,t,i,s){this.spriteAnimationManager=s,this.spriteSize=i,this.spriteMap={},this.animationFrameSpritesheet0=new Gi(e,i,this),this.animationFrameSpritesheet1=new Gi(t,i,this)}onSpritesheetLoaded(){this.animationFrameSpritesheet0.loaded&&this.animationFrameSpritesheet1.loaded&&this.populateSpriteMap()}isLoaded(){return this.animationFrameSpritesheet0.loaded&&this.animationFrameSpritesheet1.loaded}getSprite(e){return this.spriteMap[e]}populateSpriteMap(){let e=0;this.parseRow(e,[g.AQUATIC_SNAKE_TAN_1,g.AQUATIC_SNAKE_TAN_2,g.AQUATIC_SNAKE_BLACK_1,g.AQUATIC_SNAKE_BLACK_2,g.AQUATIC_MONSTER,g.AVIAN_BAT_BROWN_SMALL,g.AVIAN_BAT_BROWN_LARGE,g.AVIAN_BAT_BLACK_LARGE]),e++,this.parseRow(e,[g.AVIAN_BAT_BROWN_SMALL2,g.AVIAN_BAT_BROWN_LARGE2,g.DEMON_REPTILIAN_GREEN,g.DEMON_REPTILIAN_WINGED,g.DEMON_BROWN,g.DEMON_BLOB,g.DEMON_BLUE,g.DEMON_BLUE_WINGED]),e++,this.parseRow(e,[g.DEMON_RED_GLOWING,g.DEMON_RED_WINGED_1,g.DEMON_RED_WINGED_2,g.DEMON_RED_DARK_LARGE,g.DEMON_RED_LARGE,g.DEMON_RED_PALE_LARGE,g.DEMON_BLUE_LARGE,g.DEMON_BLUE_RED_LARGE]),e++,this.parseRow(e,[g.DEMON_GREEN_EYE_STOCKS,g.DEMON_GREEN_EVIL_WINGED,g.DEMON_RED_DARK_WHIP,g.DEMON_RED_TINY_JUMPING,g.DEMON_RED_SMALL_JUMPING,g.DEMON_ARMORED,g.DEMON_HELMET_HORNED,g.DEMON_RED_FANGED]),e++,this.parseRow(e,[g.DEMON_GREEN_FROG_LIKE,g.ELEMENTAL_WARRIOR,g.ELEMENTAL_SQUID,g.ELEMENTAL_GOLEM,g.ELEMENTAL_GOLEM_DARK,g.ELEMENTAL_GOLEM_RUSTY,g.ELEMENTAL_BLOODY,g.ELEMENTAL_STONE]),e++,this.parseRow(e,[g.ELEMENTAL_SWIRL_ORANGE,g.ELEMENTAL_SWIRL_YELLOW,g.ELEMENTAL_SWIRL_BLUE_DARK,g.ELEMENTAL_SWIRL_BLUE_LIGHT,g.ELEMENTAL_SWIRL_RED,g.ELEMENTAL_CREEPY_RED,g.ELEMENTAL_CREEPY_BROWN,g.ELEMENTAL_CREEPY_LIGHT_BLUE]),e++,this.parseRow(e,[g.ELEMENTAL_BALL_GREEN,g.ELEMENTAL_BALL_BLUE,g.ELEMENTAL_BALL_RED,g.ELEMENTAL_BALL_BLACK,g.ELEMENTAL_EYE_WHITE,g.ELEMENTAL_EYE_RED,g.ELEMENTAL_EYE_BEHOLDER,g.HUMANOID_210_SASQUATCH]),e++,this.parseRow(e,[g.HUMANOID_000,g.HUMANOID_001,g.HUMANOID_002,g.HUMANOID_003,g.HUMANOID_004,g.HUMANOID_005,g.HUMANOID_006,g.HUMANOID_007]),e++,this.parseRow(e,[g.HUMANOID_010_MINOTAUR,g.HUMANOID_011_CYCLOPS,g.HUMANOID_040_WALRUS_MAN,g.HUMANOID_041_WALRUS_MAN,g.HUMANOID_042_WALRUS_MAN,g.HUMANOID_043_WALRUS_MAN,g.HUMANOID_044_WALRUS_MAN,g.HUMANOID_045_WALRUS_MAN]),e++,this.parseRow(e,[g.HUMANOID_046_WALRUS_MAN,g.HUMANOID_070,g.HUMANOID_071,g.HUMANOID_072,g.HUMANOID_073,g.HUMANOID_170_STONE_SERPENT,g.HUMANOID_171_STONE_SERPENT,g.MISC_ANIMAL_70]),e++,this.parseRow(e,[g.HUMANOID_190_DEMON_BASHER,g.HUMANOID_191_DEMON_BASHER,g.HUMANOID_200_SQUID_DEMON,g.HUMANOID_201_SQUID_DEMON,g.MISC_ANIMAL_03_OWL,g.MISC_ANIMAL_04,g.MISC_ANIMAL_05,g.MISC_ANIMAL_06]),e++,this.parseRow(e,[g.MISC_ANIMAL_11,g.MISC_ANIMAL_12,g.MISC_ANIMAL_50,g.MISC_ANIMAL_51,g.MISC_ANIMAL_52,g.MISC_ANIMAL_53,g.PEST_LADYBUG_100,g.PEST_LADYBUG_101]),e++,this.parseRow(e,[g.PEST_TINY_00,g.PEST_TINY_01,g.PEST_TINY_02,g.PEST_TINY_03,g.PEST_TINY_04,g.PEST_TINY_05,g.PEST_TINY_WORM_1,g.PEST_TINY_WORM_2]),e++,this.parseRow(e,[g.PEST_ANT_10,g.PEST_INSECT_11,g.PEST_INSECT_12,g.PEST_INSECT_13,g.PEST_INSECT_14,g.PEST_SPIDER_20,g.PEST_SPIDER_21,g.PEST_SPIDER_22]),e++,this.parseRow(e,[g.PEST_SCORPION_23,g.PEST_SCORPION_24,g.PEST_SCORPION_25,g.PEST_WORM_30,g.PEST_WORM_31,g.PEST_BALL,g.PEST_WORM_33,g.PEST_WORM_34]),e++,this.parseRow(e,[g.PEST_GIANT_ANT_40,g.PEST_GIANT_ANT_41,g.PEST_GIANT_ANT_42,g.PEST_GIANT_ANT_43,g.PEST_SLUG_70,g.PEST_SLUG_71,g.PEST_SNAIL_72,g.PEST_SNAIL_73]),e++,this.parseRow(e,[g.PEST_INSECT_60,g.PEST_INSECT_61,g.PEST_INSECT_80,g.PEST_INSECT_81,g.MINOR_DEVIL,g.MINOR_DEVIL_WARRIOR]),e++,this.parseRow(e,[g.ORC1,g.ORC_WARRIOR,g.ORC_FIGHTER,g.ORC_KARATE,g.ORC_PIRATE,g.ORC2,g.ORC3,g.ORC4]),e++,this.parseRow(e,[g.DRAGON_MAN_BASIC,g.DRAGON_MAN_EXPLORER,g.DRAGON_MAN_FIGHTER,g.DRAGON_MAN_RUFFIAN,g.DRAGON_MAN_RANGER,g.DRAGON_MAN_TERRIBLE,g.DRAGON_MAN_MERCILESS,g.DRAGON_MAN_FIERY]),e++,this.parseRow(e,[g.QUADRUPED_000,g.QUADRUPED_001,g.QUADRUPED_002,g.QUADRUPED_003,g.QUADRUPED_004,g.QUADRUPED_005,g.QUADRUPED_006,g.QUADRUPED_007]),e++,this.parseRow(e,[g.RODENT_10_RAT_SMALL,g.RODENT_11_RAT,g.RODENT_12_RAT_LARGE_BROWN,g.RODENT_13_RAT_LARGE_GREY,g.RODENT_20_RAT_POISONOUS,g.RODENT_21_RAT_ZOMBIE,g.RODENT_22_MOLE]),e++,this.parseRow(e,[g.SLIME_BLUE_00,g.SLIME_BROWN_01,g.SLIME_WHITE_02,g.SLIME_GREEN_03,g.SLIME_PINK_04,g.SLIME_PURPLE_05,g.SLIME_MUCUS_GREEN_40,g.SLIME_MUCUS_BLUE_41]),e++,this.parseRow(e,[g.SLIME_CORRODED_20,g.SLIME_SEEING_21,g.SLIME_ORANGE_22,g.SLIME_MINI_BLUE_30,g.SLIME_MINI_31,g.SLIME_MINI_ORANGE_32,g.UNDEAD_WRAITH_0600,g.UNDEAD_WRAITH_0601]),e++,this.parseRow(e,[g.UNDEAD_GOBLIN0,g.UNDEAD_GOBLIN1,g.UNDEAD_GOBLIN2,g.UNDEAD_GOBLIN3,g.UNDEAD_GOBLIN4,g.UNDEAD_GOBLIN5,g.UNDEAD_GOBLIN6,g.UNDEAD_GOBLIN7]),e++,this.parseRow(e,[g.UNDEAD_KOBOLD_SKELETON_0200,g.UNDEAD_KOBOLD_SKELETON_0201,g.UNDEAD_KOBOLD_SKELETON_0202,g.UNDEAD_KOBOLD_SKELETON_0203,g.UNDEAD_KOBOLD4,g.UNDEAD_KOBOLD5,g.UNDEAD_KOBOLD_KING_0206,g.UNDEAD_KOBOLD_ANCIENT_EVIL7]),e++,this.parseRow(e,[g.UNDEAD_GHOST_0400,g.UNDEAD_GHOST_0401,g.UNDEAD_GHOST_0402,g.UNDEAD_GHOST_0403,g.UNDEAD_REAPER_0500,g.UNDEAD_REAPER_0501,g.UNDEAD_REAPER_0502,g.UNDEAD_DARKNESS_0801]),e++,this.parseRow(e,[g.REPTILE_FLYING_SERPENT_SMALL_002,g.REPTILE_FLYING_SERPENT_003]),e++,this.parseRow(e,[g.REPTILE_BROWN_SERPENT_SMALL_040,g.REPTILE_BROWN_SERPENT_041,g.REPTILE_BROWN_SERPENT_LARGE_042,g.REPTILE_BLACK_SERPENT_043,g.REPTILE_BLACK_SERPENT_LARGE_044,g.REPTILE_BLACK_SERPENT_POISONOUS_045,g.REPTILE_GREEN_SNAKE_SMALL_046,g.REPTILE_GREEN_SNAKE_047]),e++,this.loaded=!0}parseRow(e,t){let i=this.spriteSize+1,s=e*i,r=0;for(let o=0;o<+t.length;o++)this.spriteMap[t[o]]=new ys(this.spriteAnimationManager,this.animationFrameSpritesheet0,this.animationFrameSpritesheet1,r,s),r+=i}};var bs=class{constructor(){this.oreSpriteLists=[]}addSeries(e){this.oreSpriteLists.push(e)}getOreSprite(e){if(!e||e.open||e.tileType.rarityModifier!==_.ORE)return null;let t=e.getTileRow(),s=Math.min(.999,t/1e4),r=this.oreSpriteLists.length*s|0,o=this.oreSpriteLists[r];return o[e.hash()%o.length]}};var hi=class{constructor(e){this.sprites=e,this.step=100/e.length}getDamageSprite(e){if(e>=100)return null;let t=this.sprites.length-1-e/this.step|0;return t>=this.sprites.length||t<0?(console.log("getDamageSprite() bad index calculated. healthPercent="+e+" idx="+t),null):this.sprites[t]}};var Is=class{constructor(){this.spriteSeries=[]}add(e){this.spriteSeries.push(e)}getDamageSprite(e){if(!e||e.open)return null;let t=e.healthPercent;if(t===100)return null;let i=Math.abs(e.hash()%this.spriteSeries.length);return this.spriteSeries[i].getDamageSprite(t)}};var xs=class extends Bt{constructor(e,t,i,s,r){super(e,t),this.upgradeSpriteOverlay=null,this.spriteAnimationManager=i,this.tileDamageSpriteOverlay=s,this.oreSpriteOverlay=r,this.loadImage()}calculateSpriteStep(e){return e+1}populateSpriteMap(){let e=this.parseRow(0,2);this.upgradeSpriteOverlay=new wt(e,this.spriteAnimationManager,!1,!0);let t=this.parseRow(1,8),i=new hi(t);this.tileDamageSpriteOverlay.add(i);let s=this.parseRow(2,8),r=new hi(s);this.tileDamageSpriteOverlay.add(r);let o=this.parseRow(3,8),a=new hi(o);this.tileDamageSpriteOverlay.add(a),this.oreSpriteOverlay.addSeries(this.parseRow(5,8)),this.oreSpriteOverlay.addSeries(this.parseRow(6,8)),this.oreSpriteOverlay.addSeries(this.parseRow(7,8)),this.oreSpriteOverlay.addSeries(this.parseRow(8,8)),this.oreSpriteOverlay.addSeries(this.parseRow(9,8)),this.oreSpriteOverlay.addSeries(this.parseRow(10,8)),this.oreSpriteOverlay.addSeries(this.parseRow(11,8)),this.oreSpriteOverlay.addSeries(this.parseRow(12,8)),this.oreSpriteOverlay.addSeries(this.parseRow(13,8)),this.oreSpriteOverlay.addSeries(this.parseRow(14,8)),this.oreSpriteOverlay.addSeries(this.parseRow(15,8)),this.oreSpriteOverlay.addSeries(this.parseRow(16,8)),this.oreSpriteOverlay.addSeries(this.parseRow(17,8)),this.loaded=!0}};var Os=class extends wt{constructor(e,t,i,s,r){super(e,t,i,!0),this.directionalSprite=r,this.superFastAnimation=s}getSpriteAsOf(e,t){return this.fastAnimation?this.getFastCurrentSpriteAsOf(e,t):this.superFastAnimation?this.getSuperFastCurrentSpriteAsOf(e,t):this.getCurrentSpriteAsOf(e,t)}isAnimationLoopCompleted(e){return this.directionalSprite?!1:this.fastAnimation?this.spriteAnimationManager.isFastAnimationLoopCompleted(Date.now(),e,this.sprites.length):this.superFastAnimation?this.spriteAnimationManager.isSuperFastAnimationLoopCompleted(Date.now(),e,this.sprites.length):this.spriteAnimationManager.isDefaultAnimationLoopCompleted(Date.now(),e,this.sprites.length)}isDirectionalSprite(){return this.directionalSprite}};var vs=class extends lt{constructor(e,t,i,s,r){super(e,t),this.sheetEndCol=s,this.spritesheetMetadata=i,this.spriteAnimationManager=r,this.spriteMap={},this.loadImage()}populateSpriteMap(){for(let e=0;e<this.spritesheetMetadata.length;e++){let t=this.spritesheetMetadata[e],i=this.loadSpriteAnimation(t);this.spriteMap[t.animationName]=i}this.loaded=!0}loadSpriteAnimation(e){let t=Object.hasOwn(e,"directional")?e.directional:!1,i=Object.hasOwn(e,"fastAnimation")?e.fastAnimation:!1,s=Object.hasOwn(e,"superFastAnimation")?e.superFastAnimation:!1,r=this.createSpriteFrames(e);return new Os(r,this.spriteAnimationManager,i,s,t)}createSpriteFrames(e){let t=[],i=e.startRow,s=e.endRow,r=e.startCol,o=e.endCol,a=this.spriteSize;for(let h=i;h<=s;h++){let m=h*a,p;h<s?p=this.sheetEndCol:p=Math.min(o,this.sheetEndCol);for(let f=r;f<=p;f++){let S=f*a;t.push(new Re(this,S,m))}}return t}getSpriteAnimation(e){return this.spriteMap[e]}};var Dl=[{animationName:"Red Arrow",startCol:0,startRow:0,endCol:7,endRow:0,directional:!0},{animationName:"Green Arrow",startCol:0,startRow:1,endCol:7,endRow:1,directional:!0},{animationName:"Pink Arrow",startCol:0,startRow:2,endCol:7,endRow:2,directional:!0},{animationName:"Pink Lightning",startCol:0,startRow:3,endCol:7,endRow:3,directional:!0},{animationName:"Green Projectile",startCol:0,startRow:4,endCol:7,endRow:4,directional:!0},{animationName:"Small Green Projectiles",startCol:0,startRow:5,endCol:7,endRow:5,directional:!0},{animationName:"Fire Projectile",startCol:0,startRow:6,endCol:7,endRow:6,directional:!0},{animationName:"Fire Arrow",startCol:0,startRow:7,endCol:7,endRow:7,directional:!0},{animationName:"Ice Projectile",startCol:0,startRow:8,endCol:7,endRow:8,directional:!0},{animationName:"Ice Arrow",startCol:0,startRow:9,endCol:7,endRow:9,directional:!0},{animationName:"Lightning",startCol:0,startRow:10,endCol:7,endRow:10,directional:!0},{animationName:"Lightning Arrow",startCol:0,startRow:11,endCol:7,endRow:11,directional:!0},{animationName:"Grey Bullet",startCol:0,startRow:12,endCol:7,endRow:12,directional:!0},{animationName:"Yellow Bullet",startCol:0,startRow:13,endCol:7,endRow:13,directional:!0},{animationName:"Ninja Star",startCol:0,startRow:14,endCol:7,endRow:14,directional:!0},{animationName:"Pink Star Projectile",startCol:0,startRow:15,endCol:7,endRow:15,directional:!0},{animationName:"Web",startCol:0,startRow:16,endCol:7,endRow:16,directional:!0},{animationName:"Pink Ball Projectile",startCol:0,startRow:17,endCol:7,endRow:17,directional:!0},{animationName:"Yellow Star Projectile",startCol:0,startRow:18,endCol:7,endRow:18,directional:!1},{animationName:"Gold Sparkles",startCol:0,startRow:19,endCol:7,endRow:19},{animationName:"Green Sparkles",startCol:0,startRow:20,endCol:7,endRow:20},{animationName:"Blue Sparkles",startCol:0,startRow:21,endCol:7,endRow:21},{animationName:"Orange Sparkles",startCol:0,startRow:22,endCol:7,endRow:22},{animationName:"Pink Sparkles",startCol:0,startRow:23,endCol:7,endRow:23},{animationName:"Red Sparkles",startCol:0,startRow:24,endCol:7,endRow:24},{animationName:"Green Skull",startCol:0,startRow:25,endCol:7,endRow:25},{animationName:"Yellow Key",startCol:0,startRow:26,endCol:7,endRow:26},{animationName:"Skull Cross",startCol:0,startRow:27,endCol:7,endRow:27},{animationName:"Shields",startCol:0,startRow:28,endCol:7,endRow:28},{animationName:"Red Crosses",startCol:0,startRow:29,endCol:7,endRow:29},{animationName:"Fire Ring",startCol:0,startRow:30,endCol:7,endRow:30},{animationName:"Ice Ring",startCol:0,startRow:31,endCol:7,endRow:31},{animationName:"Green Ring",startCol:0,startRow:32,endCol:7,endRow:32},{animationName:"Pink Ring",startCol:0,startRow:33,endCol:7,endRow:33},{animationName:"Yellow Star",startCol:0,startRow:34,endCol:7,endRow:34},{animationName:"Blue Star",startCol:0,startRow:35,endCol:7,endRow:35},{animationName:"Green Star",startCol:0,startRow:36,endCol:7,endRow:36},{animationName:"White Crosses",startCol:0,startRow:37,endCol:7,endRow:37},{animationName:"Spider Web",startCol:0,startRow:38,endCol:7,endRow:38},{animationName:"Torch",startCol:0,startRow:39,endCol:7,endRow:39},{animationName:"Frost",startCol:0,startRow:40,endCol:7,endRow:41,fastAnimation:!0},{animationName:"Yellow Star Circle",startCol:0,startRow:42,endCol:6,endRow:43},{animationName:"Circles",startCol:0,startRow:44,endCol:4,endRow:45},{animationName:"Gold Shield Spiral",startCol:0,startRow:46,endCol:7,endRow:47,fastAnimation:!0},{animationName:"Green Shield Spiral",startCol:0,startRow:48,endCol:7,endRow:49,fastAnimation:!0},{animationName:"Blue Shield Spiral",startCol:0,startRow:50,endCol:7,endRow:51,fastAnimation:!0},{animationName:"Pink Shield Spiral",startCol:0,startRow:52,endCol:7,endRow:53,fastAnimation:!0},{animationName:"Blue Firework",startCol:0,startRow:54,endCol:7,endRow:55,fastAnimation:!0},{animationName:"Red Firework",startCol:0,startRow:56,endCol:7,endRow:57,fastAnimation:!0},{animationName:"Bubbles",startCol:0,startRow:58,endCol:2,endRow:60,fastAnimation:!0},{animationName:"Shield",startCol:0,startRow:61,endCol:7,endRow:62,fastAnimation:!0},{animationName:"Color Spiral",startCol:0,startRow:63,endCol:7,endRow:64},{animationName:"Arm Flex",startCol:0,startRow:65,endCol:4,endRow:66,fastAnimation:!0},{animationName:"Super Speed",startCol:0,startRow:67,endCol:7,endRow:68,fastAnimation:!0},{animationName:"Target",startCol:0,startRow:69,endCol:7,endRow:70,fastAnimation:!0},{animationName:"Yellow Shield Spiral",startCol:0,startRow:71,endCol:6,endRow:72,fastAnimation:!0},{animationName:"Pink Star Circle",startCol:0,startRow:73,endCol:6,endRow:74},{animationName:"Blue Star Circle",startCol:0,startRow:75,endCol:6,endRow:76},{animationName:"Green Star Circle",startCol:0,startRow:77,endCol:6,endRow:78},{animationName:"Gold Star Circle",startCol:0,startRow:79,endCol:6,endRow:80},{animationName:"Bread",startCol:0,startRow:81,endCol:7,endRow:81},{animationName:"Yellow Fire Ring",startCol:0,startRow:82,endCol:7,endRow:82},{animationName:"Totems",startCol:0,startRow:83,endCol:7,endRow:83},{animationName:"Eye Blink",startCol:0,startRow:84,endCol:7,endRow:84},{animationName:"Pink Star",startCol:0,startRow:85,endCol:7,endRow:85},{animationName:"Orange Star",startCol:0,startRow:86,endCol:7,endRow:86},{animationName:"Red Eye Blink",startCol:0,startRow:87,endCol:6,endRow:88},{animationName:"Eagle",startCol:0,startRow:89,endCol:7,endRow:89},{animationName:"Sleep",startCol:0,startRow:90,endCol:6,endRow:91},{animationName:"Armor",startCol:0,startRow:92,endCol:7,endRow:92},{animationName:"Blind Eye Blink",startCol:0,startRow:93,endCol:7,endRow:93},{animationName:"Fire Rain",startCol:0,startRow:94,endCol:7,endRow:96,fastAnimation:!0},{animationName:"Blue Rain",startCol:0,startRow:97,endCol:7,endRow:99,fastAnimation:!0},{animationName:"Green Rain",startCol:0,startRow:100,endCol:7,endRow:102,fastAnimation:!0},{animationName:"Lightning Rain",startCol:0,startRow:103,endCol:7,endRow:105,fastAnimation:!0},{animationName:"Pink Rain",startCol:0,startRow:106,endCol:7,endRow:108,fastAnimation:!0},{animationName:"Rainbow Rain",startCol:0,startRow:109,endCol:7,endRow:111,fastAnimation:!0},{animationName:"Spear",startCol:0,startRow:112,endCol:7,endRow:112,directional:!0,customScale:1.5},{animationName:"Red Damage",startCol:0,startRow:113,endCol:2,endRow:113},{animationName:"White Damage",startCol:0,startRow:114,endCol:2,endRow:114},{animationName:"Blue Damage",startCol:0,startRow:115,endCol:2,endRow:115},{animationName:"Green Damage",startCol:0,startRow:116,endCol:2,endRow:116},{animationName:"Red Splat",startCol:0,startRow:117,endCol:2,endRow:117},{animationName:"Electric Damage",startCol:0,startRow:118,endCol:2,endRow:118},{animationName:"Fire Damage",startCol:0,startRow:119,endCol:2,endRow:119},{animationName:"Poison Damage",startCol:0,startRow:120,endCol:2,endRow:120},{animationName:"Sonic Damage",startCol:0,startRow:121,endCol:2,endRow:121},{animationName:"Pink Damage",startCol:0,startRow:122,endCol:2,endRow:122},{animationName:"Fat Red Arrow",startCol:0,startRow:123,endCol:7,endRow:123,directional:!0},{animationName:"Wall Arrow",startCol:0,startRow:124,endCol:7,endRow:124,directional:!0}];var Ds=class{constructor(){this.spriteAnimationManager=new Ss,this.tileDamageSpriteOverlay=new Is,this.oreSpriteOverlay=new bs,this.loaded=!1,this.tileSpritesheet=new Ps("spritesheet/tile_spritesheet.png",n.tile.size),this.tileTypeBackgroundSpritesheet=new _s("spritesheet/tile_type_background.png",n.tile.size),this.characterSpritesheet=new Ns("spritesheet/character_spritesheet.png",n.tile.size,this.spriteAnimationManager),this.itemOverlaySpritesheet=new Rs("spritesheet/item_overlay_spritesheet.png",n.tile.size*3,this.spriteAnimationManager),this.staticFixtureSpritesheet=new di("spritesheet/static_fixture_spritesheet.png",n.tile.size),this.monsterSpritesheet=new Ls("spritesheet/monsters0.png","spritesheet/monsters1.png",n.tile.size,this.spriteAnimationManager),this.tileSpriteOverlaySpritesheet=new xs("spritesheet/tile_overlay.png",n.tile.size,this.spriteAnimationManager,this.tileDamageSpriteOverlay,this.oreSpriteOverlay),this.spellFxSpritesheet=new vs("spritesheet/SpellFX.png",31,Dl,7,this.spriteAnimationManager)}isInitialized(){return this.loaded||(this.loaded=this.tileSpritesheet.loaded&&this.tileTypeBackgroundSpritesheet.loaded&&this.characterSpritesheet.loaded&&this.itemOverlaySpritesheet.loaded&&this.staticFixtureSpritesheet.loaded&&this.monsterSpritesheet.isLoaded()&&this.tileSpriteOverlaySpritesheet.loaded&&this.spellFxSpritesheet.loaded),this.loaded}};var qe={NO_OPEN_BORDERS:0,NORTH_BORDER_OPEN:1,SOUTH_BORDER_OPEN:2,NORTH_SOUTH_OPEN:3,WEST_BORDER_OPEN:4,NORTH_WEST_OPEN:5,SOUTH_WEST_OPEN:6,NORTH_SOUTH_WEST_OPEN:7,EAST_BORDER_OPEN:8,NORTH_EAST_OPEN:9,SOUTH_EAST_OPEN:10,NORTH_SOUTH_EAST_OPEN:11,WEST_EAST_OPEN:12,NORTH_WEST_EAST:13,SOUTH_WEST_EAST:14,ALL_BORDERS_OPEN:15};var As=class{constructor(){this.northBorder=null,this.eastBorder=null,this.southBorder=null,this.westBorder=null,this.northEastBorder=null,this.northSouthBorder=null,this.northWestBorder=null,this.southEastBorder=null,this.eastWestBorder=null,this.southWestBorder=null,this.northEastSouthBorder=null,this.northSouthWestBorder=null,this.northEastWestBorder=null,this.eastWestSouthBorder=null,this.northEastSouthWestBorder=null,this.noBorder=null}getTileSprite(e){switch(e){case qe.NO_OPEN_BORDERS:return this.noBorder;case qe.NORTH_BORDER_OPEN:return this.northBorder;case qe.SOUTH_BORDER_OPEN:return this.southBorder;case qe.NORTH_SOUTH_OPEN:return this.northSouthBorder;case qe.WEST_BORDER_OPEN:return this.westBorder;case qe.NORTH_WEST_OPEN:return this.northWestBorder;case qe.SOUTH_WEST_OPEN:return this.southWestBorder;case qe.NORTH_SOUTH_WEST_OPEN:return this.northSouthWestBorder;case qe.EAST_BORDER_OPEN:return this.eastBorder;case qe.NORTH_EAST_OPEN:return this.northEastBorder;case qe.SOUTH_EAST_OPEN:return this.southEastBorder;case qe.NORTH_SOUTH_EAST_OPEN:return this.northEastSouthBorder;case qe.WEST_EAST_OPEN:return this.eastWestBorder;case qe.NORTH_WEST_EAST:return this.northEastWestBorder;case qe.SOUTH_WEST_EAST:return this.eastWestSouthBorder;case qe.ALL_BORDERS_OPEN:return this.northEastSouthWestBorder;default:return console.log("TileTemplate.getTileSprite() invalid border code: "+e),this.noBorder}}};var x=class{constructor(e,t,i,s,r,o){this.id=e,this.name=t,this.iconFileName=i,this.opaque=s,this.lightingSupported=r,this.rarityModifier=o,this.tileTemplate=null,this.tileTemplate2=null,this.tileTemplate3=null,this.tileTypeBackground=null,this.layerDescription=null}getRandomTemplate(){let e=Math.random();return e<.333?this.tileTemplate:e<.666?this.tileTemplate2:this.tileTemplate3}};var ge={EMPTY:new x("0","Empty","sky.png",!0,!1,_.COMMON),SKY:new x("1","Sky","sky.png",!0,!1,_.COMMON),GRASS:new x("2","Grass","grass.png",!0,!1,_.COMMON),DIRT:new x("10","Dirt","dirt.png",!0,!0,_.COMMON)};function _d(){let l=[],e=11;return l.push(new x(""+e++,"Blue Green Clay","blue_green_clay.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Red Clay","red_clay.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Grey Sandstone","grey_sandstone.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Brown Sandstone","brown_sandstone.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Green Pyronxenite","green_pyronxenite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Blue Dunite","blue_dunite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Deficient Hematite","deficient_hematite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Blue Sandstone","blue_sandstone.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Pink Slate","pink_slate.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Green Basalt","green_basalt.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Deep Bismuth","deep_bismuth.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Dark Phrenite","dark_phrenite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Blue Stone","blue_stone.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Orange Alexandrite","orange_alexandrite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Defective Cobalt","defective_cobalt.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Green Schist","green_schist.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Pale Blue Stone","pale_blue_stone.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Red Pyronxenite","red_pyronxenite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Teal Clay","teal_clay.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Bloodstone","bloodstone.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Grey Orange Granite","grey_orange_granite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Aqua Carnelion","aqua_carnelion.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Purple Grey Quartz","purple_grey_quartz.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Substandard Gypsum","substandard_gypsum.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Red Magnetite","red_magnetite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Arkose Sandstone","arkose_sandstone.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Gabbro","gabbro.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Dark Purple Clay","dark_purple_clay.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Rose Stone","rose_stone.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Purple Grey Granite","purple_grey_granite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Green Slate","green_slate.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Blue Schist","blue_schist.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Rotten Vanadium","rotten_vanadium.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Green Quartz","green_quartz.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Golden Slate","golden_slate.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Slimy Pyrrhotite","slimy_pyrrhotite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Green Jasper","green_jasper.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Blood Agate","blood_agate.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Compressed Bauxite","compressed_bauxite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Darkest Adventurine","darkest_adventurine.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Pink Amethyst","pink_amethyst.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Dark Iron Stone","dark_iron_stone.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Brown Jasper","brown_jasper.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Hellish Agate","hellish_agate.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Nasty Bauxite","nasty_bauxite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Diabolical Malachite","diabolical_malachite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Sun Stone","red_sunstone.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Cruek Cesium","cruel_cesium.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Orange Carnelion","orange_carnelion.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Purple Charoite","purple_charoite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Heliotrope Granite","heliotrope_granite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Pink Kunzite","pink_kunzite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Fractured Slate","fractured_slate.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Pink Grey Granite","pink_grey_granite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Blue Galaxy Granite","blue_galaxy_granite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Black Quartz","black_quartz.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Vile Hematite","vile_hematite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Green Clay","green_clay.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Purple Granite","purple_granite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Blue Quartz","blue_quartz.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Orange Basalt","orange_basalt.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Yellow Sandstone","yellow_sandstone.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Blue Green Agate","blue_green_agate.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Calamitous Calcite","calamitous_calcite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Brown Basalt","brown_basalt.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Emerald Dolomite","emerald_dolomite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Dark Pyroxenite","dark_pyroxenite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Violet Tanzanite","violet_tanzanite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Green Serpentine","green_serpentine.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Ruby Basalt","ruby_basalt.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Purple Schist","purple_schist.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Green Aragonite","green_aragonite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Red Spinel","red_spinel.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Infected Schist","infected_schist.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Salmon Basalt","salmon_basalt.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Enchanted Jasper","enchanted_jasper.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Cursed Basalt","cursed_basalt.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Sinister Slate","sinister_slate.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Orange Apocalypse","orange_apocalypse.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Devil Stone","devil_stone.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Asbestos","asbestos.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Bleak Vanadium","bleak_vanadium.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Poisoned Aragonite","poisoned_aragonite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Purple Dunite","purple_dunite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Corrupted Agate","corrupted_agate.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Torched Aragonite","torched_aragonite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Forbidden Quartz","forbidden_quartz.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Violet Pyroxenite","violet_pyroxenite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Slate Soulstone","slate_soulstone.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Fractured Jasper","fractured_jasper.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Sky Quartz","sky_quartz.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Toxic Granite","toxic_granite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Corroded Ruby","corroded_ruby.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Offensive Shale","offensive_shale.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Petrified Flamingos","petrified_flamingos.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Crystallized Onyx","crystallized_onyx.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Orange Jasper","orange_jasper.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Satanic Slate","satanic_slate.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Malignant Pyrite","malignant_pyrite.png",!0,!0,_.COMMON)),l.push(new x(""+e++,"Pink Shale","pink_shale.png",!0,!0,_.COMMON)),l}var St=_d(),Bl={},kl={},Fl={},Gl={};function Ts(l){if(l===ge.EMPTY||l===ge.SKY)return null;let e=Bl[l.id];return e||(e=new x(l.id+"_g","Gold","gold.png",!0,!0,_.GOLD),Bl[l.id]=e),e}function Es(l){if(l===ge.EMPTY||l===ge.SKY)return null;let e=kl[l.id];return e||(e=new x(l.id+"_d","Ruby","ruby.png",!0,!0,_.RUBY),kl[l.id]=e),e}function Cs(l){if(l===ge.EMPTY||l===ge.SKY)return null;let e=Gl[l.id];return e||(e=new x(l.id+"_u","Upgrade","onyx.png",!0,!0,_.UPGRADE),Gl[l.id]=e),e}function ws(l){if(l===ge.EMPTY||l===ge.SKY)return null;let e=Fl[l.id];return e||(e=new x(l.id+"_o","Ore","purple_ore.png",!0,!0,_.ORE),Fl[l.id]=e),e}function Qa(l,e){if(l[e.id]=e,e===ge.EMPTY||e===ge.SKY)return;let t=Ts(e);l[t.id]=t;let i=ws(e);l[i.id]=i;let s=Cs(e);l[s.id]=s;let r=Es(e);l[r.id]=r}function Rd(){let l={};Qa(l,ge.SKY),Qa(l,ge.GRASS),Qa(l,ge.DIRT);for(let e=0;e<St.length;e++)Qa(l,St[e]);return l}var Vl=Rd();var zl=new ArrayBuffer(4),Ul=new Uint32Array(zl),Hl=new Float32Array(zl),q=class{constructor(){}static floor(e){if(e<0){let t=-this.floorPositive(-e);return e===t?t:t-1}else return this.floorPositive(e)}static floorPositive(e){return e<2147483648?e|0:Math.floor(e)}static len(e){return 1/this.invSqrt(e.x*e.x+e.y*e.y)}static nor(e){let t=this.len(e);return t!=0&&(e.x/=t,e.y/=t),e}static dist(e,t){let i=e.x-t.x,s=e.y-t.y;return 1/this.invSqrt(i*i+s*s)}static invSqrt(e){Hl[0]=e,Ul[0]=1597463007-(Ul[0]>>1);let t=Hl[0];return t*(1.5-.5*t*t*e)}};var K=class{constructor(){}resetFull(){}resetForPrestige(){}};var Bs=class extends K{constructor(){super(),this.origin=new v(0,0),this.grids=this.instantiateGrids();for(let e=0;e<this.grids.length;e++)this.grids[e].findTileNeighborsFull();this.changeCount=0,this.shiftCount=0}instantiateGrids(){let e=n.grid.gridPixelWidth,t=n.grid.gridPixelHeight,i=new Array(9);return i[0]=new dt(this,new v(-e,-t)),i[1]=new dt(this,new v(0,-t)),i[2]=new dt(this,new v(e,-t)),i[3]=new dt(this,new v(-e,0)),i[4]=new dt(this,new v(0,0)),i[5]=new dt(this,new v(e,0)),i[6]=new dt(this,new v(-e,t)),i[7]=new dt(this,new v(0,t)),i[8]=new dt(this,new v(e,t)),i}getGridTile(e,t){let i=this.getGrid(e,t);return i?i.getGridTile(e,t):null}getGrid(e,t){let i=e*n.tile.size,s=t*n.tile.size,r=this.grids[4];if(!r)return null;if(r.containsXY(i,s))return r;let o=r.origin.x,a=o+n.grid.gridPixelWidth,h=r.origin.y,m=h+n.grid.gridPixelHeight,p=null;return i>=o&&i<a?s<h?p=this.grids[1]:s>=m&&(p=this.grids[7]):i<r.origin.x?s>=h&&s<m?p=this.grids[3]:s<h?p=this.grids[0]:s>=m&&(p=this.grids[6]):i>=a&&(s>=h&&s<m?p=this.grids[5]:s<h?p=this.grids[2]:s>=m&&(p=this.grids[8])),p&&p.containsXY(i,s)?p:null}findGridContaining(e){let t=q.floor(e.x/n.tile.size),i=q.floor(e.y/n.tile.size);return this.getGrid(t,i)}findGridTile(e){let t=q.floor(e.x/n.tile.size),i=q.floor(e.y/n.tile.size);return this.getGridTile(t,i)}findGridTileXY(e,t){let i=q.floor(e/n.tile.size),s=q.floor(t/n.tile.size);return this.getGridTile(i,s)}findGridRegion(e){if(!this.groups)return null;let t=this.findGridTile(e);return t!=null?t.getRegion():null}resetFull(){this.changeCount=0,this.shiftCount=0}resetForPrestige(){this.resetFull()}};var ks=class extends Ct{constructor(e,t){super(t),this.zone=e,this.tiles=this.createTiles(),this.mineTiles=[],this.vectorFieldNumber=-1}createTiles(){let e=new Array(n.grid.numTileColsInRegion*n.grid.numTileRowsInRegion),t=this.zone.grid,i=this.getOrigin(),s=i.x,r=i.y,o=0;for(let a=0;a<n.grid.numTileColsInRegion;a++)for(let h=0;h<n.grid.numTileRowsInRegion;h++)e[o++]=new Fs(t,this,new v(s+n.tile.size*a,r+n.tile.size*h));return e}initialize(e,t){this.origin.set(e,t);let i=this.origin.x,s=this.origin.y,r=0;for(let o=0;o<n.grid.numTileColsInRegion;o++)for(let a=0;a<n.grid.numTileRowsInRegion;a++)this.tiles[r++].initialize(i+n.tile.size*o,s+n.tile.size*a);this.mineTiles.length=0,this.vectorFieldNumber=-1}getTileIndex(e){let t=e.getTileCol()-this.getOriginTileCol(),i=e.getTileRow()-this.getOriginTileRow();return t*n.grid.numTileRowsInRegion+i}getZone(){return this.zone}getGrid(){return this.zone.grid}getWorldGrid(){return this.zone.getWorldGrid()}getTiles(){return this.tiles}getPixelWidth(){return n.grid.regionPixelWidth}getPixelHeight(){return n.grid.regionPixelHeight}findGridTile(e){let t=q.floor(e.x/n.tile.size),i=q.floor(e.y/n.tile.size);return this.getGridTileAbsolute(t,i)}getGridTileAbsolute(e,t){let i=this.origin,s=q.floor(i.x/n.tile.size),r=q.floor(i.y/n.tile.size);return this.getGridTileLocal(e-s,t-r)}getGridTileLocal(e,t){if(e<0||e>=n.grid.numTileColsInRegion||t<0||t>=n.grid.numTileRowsInRegion)return null;let i=e*n.grid.numTileRowsInRegion+t;return i>=0&&i<this.tiles.length?this.tiles[i]:(console.log("GridRegion.getGridTileLocal() Failed to find tile. col="+e+" row="+t+" index="+i),null)}findTileNeighborsFull(){for(let e=0;e<this.tiles.length;e++)this.tiles[e].findNeighbors()}getTile(e,t){return this.tiles[e*n.grid.numTileRowsInRegion+t]}findRegionBorderTileNeighbors(){let e=n.grid.numTileColsInRegion-1,t=n.grid.numTileRowsInRegion-1,i=0,s=0;this.getTile(e,t).findNeighbors(),this.getTile(e,i).findNeighbors(),this.getTile(s,t).findNeighbors(),this.getTile(s,i).findNeighbors();for(let r=1;r<n.grid.numTileRowsInRegion-1;r++)this.getTile(e,r).findNeighbors();for(let r=1;r<n.grid.numTileRowsInRegion-1;r++)this.getTile(s,r).findNeighbors();for(let r=1;r<n.grid.numTileColsInRegion-1;r++)this.getTile(r,i).findNeighbors();for(let r=1;r<n.grid.numTileColsInRegion-1;r++)this.getTile(r,t).findNeighbors()}findTileNeighborsBorderRight(){let e=n.grid.numTileColsInRegion-1;for(let t=0;t<n.grid.numTileRowsInRegion;t++)this.getTile(e,t).findNeighborRight()}nullifyTileNeighborsBorderRight(){let e=n.grid.numTileColsInRegion-1;for(let t=0;t<n.grid.numTileRowsInRegion;t++)this.getTile(e,t).nullifyNeighborRight()}evaluateTileBordersRight(){let e=n.grid.numTileColsInRegion-1;for(let t=0;t<n.grid.numTileRowsInRegion;t++)this.getTile(e,t).evaluateBorders()}findTileNeighborsBorderLeft(){for(let e=0;e<n.grid.numTileRowsInRegion;e++)this.getTile(0,e).findNeighborLeft()}nullifyTileNeighborsBorderLeft(){for(let e=0;e<n.grid.numTileRowsInRegion;e++)this.getTile(0,e).nullifyNeighborLeft()}evaluateTileBordersLeft(){for(let e=0;e<n.grid.numTileRowsInRegion;e++)this.getTile(0,e).evaluateBorders()}findTileNeighborsBorderBottom(){let e=n.grid.numTileRowsInRegion-1;for(let t=0;t<n.grid.numTileColsInRegion;t++)this.getTile(t,e).findNeighborBottom()}nullifyTileNeighborsBorderBottom(){let e=n.grid.numTileRowsInRegion-1;for(let t=0;t<n.grid.numTileColsInRegion;t++)this.getTile(t,e).nullifyNeighborBottom()}evaluateTileBordersBottom(){let e=n.grid.numTileRowsInRegion-1;for(let t=0;t<n.grid.numTileColsInRegion;t++)this.getTile(t,e).evaluateBorders()}findTileNeighborsBorderTop(){for(let e=0;e<n.grid.numTileColsInRegion;e++)this.getTile(e,0).findNeighborTop()}nullifyTileNeighborsBorderTop(){for(let e=0;e<n.grid.numTileColsInRegion;e++)this.getTile(e,0).nullifyNeighborTop()}evaluateTileBordersTop(){for(let e=0;e<n.grid.numTileColsInRegion;e++)this.getTile(e,0).evaluateBorders()}};var $a=["00","01","02","03","04","05","06","07","08","09","0A","0B","0C","0D","0E","0F","10","11","12","13","14","15","16","17","18","19","1A","1B","1C","1D","1E","1F","20","21","22","23","24","25","26","27","28","29","2A","2B","2C","2D","2E","2F","30","31","32","33","34","35","36","37","38","39","3A","3B","3C","3D","3E","3F","40","41","42","43","44","45","46","47","48","49","4A","4B","4C","4D","4E","4F","50","51","52","53","54","55","56","57","58","59","5A","5B","5C","5D","5E","5F","60","61","62","63","64","65","66","67","68","69","6A","6B","6C","6D","6E","6F","70","71","72","73","74","75","76","77","78","79","7A","7B","7C","7D","7E","7F","80","81","82","83","84","85","86","87","88","89","8A","8B","8C","8D","8E","8F","90","91","92","93","94","95","96","97","98","99","9A","9B","9C","9D","9E","9F","A0","A1","A2","A3","A4","A5","A6","A7","A8","A9","AA","AB","AC","AD","AE","AF","B0","B1","B2","B3","B4","B5","B6","B7","B8","B9","BA","BB","BC","BD","BE","BF","C0","C1","C2","C3","C4","C5","C6","C7","C8","C9","CA","CB","CC","CD","CE","CF","D0","D1","D2","D3","D4","D5","D6","D7","D8","D9","DA","DB","DC","DD","DE","DF","E0","E1","E2","E3","E4","E5","E6","E7","E8","E9","EA","EB","EC","ED","EE","EF","F0","F1","F2","F3","F4","F5","F6","F7","F8","F9","FA","FB","FC","FD","FE","FF"],ce=class l{constructor(e,t,i,s){this.r=e,this.g=t,this.b=i,this.a=s,this.fillColor=null,this.clamp()}static createColor(e){let t=(e&4278190080)>>24,i=(e&16711680)>>16,s=(e&65280)>>8,r=e&255;return new l(t/255,i/255,s/255,r/255)}set(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this.fillColor=null}setAlpha(e){this.a=e}addAlpha(e){this.a+=e,this.a>1&&(this.a=1)}reset(){this.r=0,this.g=0,this.b=0,this.a=0}setRgba(e,t,i,s){this.r=e,this.g=t,this.b=i,this.a=s,this.clamp(),this.fillColor=null}setRgbaFast(e,t,i,s){this.r=e,this.g=t,this.b=i,this.a=s,this.fillColor=null}resetFast(){this.r=0,this.g=0,this.b=0,this.a=0,this.fillColor=null}mul(e){this.r*=e,this.g*=e,this.b*=e,this.a*=e,this.clamp(),this.fillColor=null}add(e){this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this.clamp(),this.fillColor=null}addFast(e){this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this.fillColor=null}addRgba(e,t,i,s){this.r+=e,this.g+=t,this.b+=i,this.a+=s,this.clamp(),this.fillColor=null}addFastRgba(e,t,i,s){this.r+=e,this.g+=t,this.b+=i,this.a+=s,this.fillColor=null}getFillColor(){return this.fillColor||(this.fillColor=this.createFillColor()),this.fillColor}createFillColor(){let e=(1-this.a)*255|0,t=this.r*255|0,i=this.g*255|0,s=this.b*255|0;return"#"+$a[t]+$a[i]+$a[s]+$a[e]}clamp(){this.r<0?this.r=0:this.r>1&&(this.r=1),this.g<0?this.g=0:this.g>1&&(this.g=1),this.b<0?this.b=0:this.b>1&&(this.b=1),this.a<0?this.a=0:this.a>1&&(this.a=1)}};var yd=new ce(0,0,0,.3),Gs=class{constructor(){this.everVisibleToCharacter=!1,this.currentlyVisibleToCharacter=!1,this.environmentLighting=new ce(0,0,0,0),this.dynamicLighting=new ce(0,0,0,0),this.positionalLighting=new ce(0,0,0,0),this.shadowColor=new ce(0,0,0,0),this.sunlightFull=!1,this.sunlightPartial=0}resetLighting(){this.dynamicLighting.resetFast(),this.environmentLighting.resetFast(),this.positionalLighting.resetFast(),this.currentlyVisibleToCharacter=!1}resetPositionalLighting(){this.positionalLighting.resetFast(),this.currentlyVisibleToCharacter=!1}resetEnvironmentLighting(){this.environmentLighting.resetFast()}resetDynamicLighting(){this.dynamicLighting.resetFast()}addPositionalLighting(e){this.positionalLighting.add(e)}addEnvironmentLighting(e){this.environmentLighting.add(e)}addDynamicLighting(e){this.dynamicLighting.add(e)}markTileAsCurrentlyVisible(){this.currentlyVisibleToCharacter=!0,this.everVisibleToCharacter=!0}markAsSunlightFull(){this.sunlightFull=!0,this.everVisibleToCharacter=!0}isSunlightPartial(){return this.sunlightPartial>0}sunlightPartialIncrement(){this.sunlightPartial++,this.everVisibleToCharacter=!0}sunlightPartialDecrement(){this.sunlightPartial>0&&this.sunlightPartial--}calculateShadowColor(){return this.shadowColor.set(yd),this.currentlyVisibleToCharacter&&(this.shadowColor.addFast(this.environmentLighting),this.shadowColor.addFast(this.dynamicLighting),this.shadowColor.addFast(this.positionalLighting),this.shadowColor.clamp()),this.sunlightFull?this.shadowColor.setAlpha(1):this.sunlightPartial>0&&this.shadowColor.addAlpha(.3),this.shadowColor}reset(){this.everVisibleToCharacter=!1,this.currentlyVisibleToCharacter=!1,this.sunlightFull=!1,this.sunlightPartial=0}};var at={PREMIUM:100,COMMON_REVEAL_CAVERN:5,COMMON_HIDDEN_NEIGHBOR:3,WORTHLESS:0,IN_RANGE_OPEN:-10,IN_RANGE_UNSEEN:-20,UNSET:-1e3};var Vs=class{constructor(){this.pathNumber=0,this.closed=!1,this.cameFrom=null,this.cost=0,this.score=0,this.inOpenList=!1,this.mineScore=-1,this.mineVectorFieldNumber=-1}getCameFrom(e){return this.pathNumber!=e&&this.reset(e),this.cameFrom}set(e,t,i,s){this.pathNumber!=s&&this.reset(s),this.cameFrom=e,this.cost=t,this.score=i}getCost(e){return this.pathNumber!=e&&this.reset(e),this.cost}setCost(e,t){this.pathNumber!=t&&this.reset(t),this.cost=e}getScore(e){return this.pathNumber!=e&&this.reset(e),this.score}setClosed(e,t){this.pathNumber!=t&&this.reset(t),this.closed=e}isClosed(e){return this.pathNumber!=e&&this.reset(e),this.closed}setInOpenList(e,t){this.pathNumber!=t&&this.reset(t),this.inOpenList=e}isInOpenList(e){return this.pathNumber!=e&&this.reset(e),this.inOpenList}getMineScore(e){return this.mineVectorFieldNumber!=e?at.UNSET:this.mineScore}setMineScore(e,t){this.mineVectorFieldNumber=t,this.mineScore=e}reset(e){this.pathNumber=e,this.closed=!1,this.cameFrom=null,this.cost=0,this.score=0,this.inOpenList=!1}};var Us=class{constructor(e,t,i,s){this.spriteName=e,this.traversable=t,this.opaque=i,this.stateSavable=s,this.sprite=null}};var mt=0,pt=1,It=2,xt=3,Ml=new d(0),Fs=class extends Ct{constructor(e,t,i){super(i),this.grid=e,this.region=t,this.sprite=null,this.backgroundSprite=null,this.neighbors=new Array(4),this.neighbors[mt]=null,this.neighbors[pt]=null,this.neighbors[It]=null,this.neighbors[xt]=null,this.tileType=ge.EMPTY,this.tileTemplate=null,this.borderCode=0,this.open=!1,this.fixtureDescription=null,this.lighting=new Gs,this.pathData=new Vs,this.initialHealth=null,this.health=null,this.healthPercent=100,this.mineTileIndex=-1}initialize(e,t){this.origin.set(e,t),this.tileType=ge.EMPTY,this.tileTemplate=null,this.sprite=null,this.fixtureDescription=null,this.backgroundSprite=null,this.open=!1,this.mineTileIndex=-1,this.health=null,this.initialHealth=null,this.healthPercent=100,this.lighting.reset()}tileInit(e,t){this.borderCode=-1,this.open=e,this.setTileType(t)}setTileType(e){if(!e){console.log("GridTyple.setTileType is null");return}this.tileType!==e&&(this.tileType=e,this.tileTemplate=e.getRandomTemplate(),this.tileTemplate&&!this.open&&this.borderCode!=-1&&(this.sprite=this.tileTemplate.getTileSprite(this.borderCode)))}getHealth(){return this.open?null:(this.health||this.calculateTileHealth(),this.health)}calculateTileGold(e){if(this.tileType.rarityModifier!==_.GOLD){e.setZero();return}e.copy(this.tileType.layerDescription.baseGold)}calculateTileHealth(){this.open?this.health=null:(this.health=new d(0),this.tileType.layerDescription.calculateTileHealth(this.getTileRow(),this.health),this.initialHealth=new d(0),this.initialHealth.copy(this.health))}isCommon(){return this.tileType.rarityModifier===_.COMMON}isCurrency(){return this.tileType.rarityModifier===_.ORE}isPriority(){return this.tileType.rarityModifier===_.GOLD||this.tileType.rarityModifier===_.RUBY||this.tileType.rarityModifier===_.UPGRADE}getGrid(){return this.grid}getRegion(){return this.region}getWorldGrid(){return this.grid.getWorldGrid()}getSprite(){return this.sprite}setSprite(e){this.sprite=e}createCenterPositionVector(){let e=new v(0,0);return this.assignCenterPosition(e),e}assignCenterPosition(e){e.set(this.origin.x+n.tile.halfSize,this.origin.y+n.tile.halfSize)}isTraversable(){return this.open?!this.fixtureDescription||this.fixtureDescription.traversable:!1}isOpaque(){return this.open?this.fixtureDescription&&this.fixtureDescription.opaque:this.tileType.opaque}getPixelWidth(){return n.tile.size}getPixelHeight(){return n.tile.size}getTileCol(){return this.getOriginTileCol()}getTileRow(){return this.getOriginTileRow()}createId(){return this.getTileCol()+"_"+this.getTileRow()}getNeighbors(){return this.neighbors}findNeighbors(){this.neighbors[0]=null,this.neighbors[1]=null,this.neighbors[2]=null,this.neighbors[3]=null;let e=this.getTileCol(),t=this.getTileRow(),i=this.getNeighborColRow(e,t-1);i&&(this.neighbors[mt]=i,i.neighbors[pt]=this);let s=this.getNeighborColRow(e,t+1);s&&(this.neighbors[pt]=s,s.neighbors[mt]=this);let r=this.getNeighborColRow(e+1,t);r&&(this.neighbors[It]=r,r.neighbors[xt]=this);let o=this.getNeighborColRow(e-1,t);o&&(this.neighbors[xt]=o,o.neighbors[It]=this)}nullifyNeighborRight(){this.neighbors[It]=null}nullifyNeighborLeft(){this.neighbors[xt]=null}nullifyNeighborBottom(){this.neighbors[pt]=null}nullifyNeighborTop(){this.neighbors[mt]=null}findNeighborRight(){this.neighbors[It]=null;let e=this.getTileCol(),t=this.getTileRow(),i=this.getNeighborColRow(e+1,t);i&&(this.neighbors[It]=i,i.neighbors[xt]=this)}findNeighborLeft(){this.neighbors[xt]=null;let e=this.getTileCol(),t=this.getTileRow(),i=this.getNeighborColRow(e-1,t);i&&(this.neighbors[xt]=i,i.neighbors[It]=this)}findNeighborTop(){this.neighbors[mt]=null;let e=this.getTileCol(),t=this.getTileRow(),i=this.getNeighborColRow(e,t-1);i&&(this.neighbors[mt]=i,i.neighbors[pt]=this)}findNeighborBottom(){this.neighbors[pt]=null;let e=this.getTileCol(),t=this.getTileRow(),i=this.getNeighborColRow(e,t+1);i&&(this.neighbors[pt]=i,i.neighbors[mt]=this)}isAdjacentTo(e){let t=this.getTileRow(),i=e.getTileRow();if(Math.abs(t-i)>1)return!1;let s=this.getTileCol(),r=e.getTileCol();return!(Math.abs(s-r)>1)}isNeighborTile(e){return e===this.neighbors[0]||e===this.neighbors[1]||e===this.neighbors[2]||e===this.neighbors[3]}getNeighborColRow(e,t){let i=this.region.getGridTileAbsolute(e,t);if(!i){let s=this.region.zone;i=s.getGridTileAbsolute(e,t),i||(i=s.grid.getGridTileAbsolute(e,t),i||(i=s.grid.worldGrid.getGridTile(e,t)))}return i}getNeighbor(e){if(this.contains(e))return this;let t=this.findNeighborContaining(e);if(t)return t;let i=q.floor(e.x/n.tile.size),s=q.floor(e.y/n.tile.size);return this.getNeighborColRow(i,s)}getNeighborLeft(){return this.neighbors[xt]}getNeighborRight(){return this.neighbors[It]}getNeighborTop(){return this.neighbors[mt]}getNeighborBottom(){return this.neighbors[pt]}getNeighborTopLeft(){let e=this.neighbors[mt];return e?e.getNeighborLeft():null}getNeighborTopRight(){let e=this.neighbors[mt];return e?e.getNeighborRight():null}getNeighborBottomLeft(){let e=this.neighbors[pt];return e?e.getNeighborLeft():null}getNeighborBottomRight(){let e=this.neighbors[pt];return e?e.getNeighborRight():null}isNeighborLeft(e){return e===this.neighbors[xt]}isNeighborRight(e){return e===this.neighbors[It]}isNeighborTop(e){return e===this.neighbors[mt]}isNeighborBottom(e){return e===this.neighbors[pt]}findNeighborContaining(e){for(let o=0;o<this.neighbors.length;o++){let a=this.neighbors[o];if(a&&a.contains(e))return a}let t=this.getNeighborTopLeft();if(t&&t.contains(e))return t;let i=this.getNeighborTopRight();if(i&&i.contains(e))return i;let s=this.getNeighborBottomLeft();if(s&&s.contains(e))return s;let r=this.getNeighborBottomRight();return r&&r.contains(e)?r:null}findRelativeTile(e,t){let i=this.getGrid().getWorldGrid(),s=this.getTileCol()+e,r=this.getTileRow()+t;return i.getGridTile(s,r)}evaluateBorders(){if(this.open)this.borderCode=0,this.sprite=null;else{let e=this.borderCode,t=this.neighbors[mt],i=this.neighbors[pt],s=this.neighbors[It],r=this.neighbors[xt],o=t&&t.open?1:0,a=i&&i.open?2:0,h=r&&r.open?4:0,m=s&&s.open?8:0;this.borderCode=o+a+h+m,e!==this.borderCode&&this.tileTemplate&&(this.sprite=this.tileTemplate.getTileSprite(this.borderCode))}}onTileDamaged(e){this.open||!e||(this.health||this.calculateTileHealth(),this.health.sub(e),this.health.lessThanEqualsZero()?this.onTileBreak():this.healthPercent=this.calculateHealthPercent())}calculateHealthPercent(){return this.open?0:this.health?this.health.equalsZero()?0:(Ml.copy(this.health),Ml.divide(this.initialHealth),Ml.toNumber()*100|0):100}isTileDamaged(){return this.open||!this.health?!1:!this.health.equals(this.initialHealth)}onTileBreak(){if(!this.open){this.open=!0,this.borderCode=-1,this.evaluateBorders(),this.handleTileOpened();let e=this.getNeighborTop();e&&e.open&&e.fixtureDescription&&(e.fixtureDescription=null);let t=this.getNeighborBottom();t&&t.open&&t.fixtureDescription&&(t.fixtureDescription=null),this.pathData.mineScore=0,this.pathData.mineVectorFieldNumber=0,this.health=null,this.initialHealth=null,this.healthPercent=0,this.mineTileIndex>=0&&(this.region.mineTiles[this.mineTileIndex]=null,this.mineTileIndex=-1),this.getGrid().markGridAsChanged()}for(let e=0;e<this.neighbors.length;e++){let t=this.neighbors[e];t&&t.evaluateBorders()}}handleTileOpened(){if(!this.open)return;let e=this.getNeighborTop();e&&e.open&&e.lighting.sunlightFull&&this.handleSunlightStart()}handleSunlightStart(){this.markAsSunlightFull();let e=this.getNeighborLeft();e&&!e.lighting.sunlightFull&&e.lighting.sunlightPartialIncrement();let t=this.getNeighborRight();if(t&&!t.lighting.sunlightFull&&t.lighting.sunlightPartialIncrement(),!this.open)return;let i=this.getNeighborBottom();i&&!i.lighting.sunlightFull&&i.handleSunlightStart()}handleSunlightStop(){this.lighting.sunlightFull=!1;let e=this.getNeighborLeft();e&&e.lighting.sunlightPartialDecrement();let t=this.getNeighborRight();if(t&&t.lighting.sunlightPartialDecrement(),!this.open)return;let i=this.getNeighborBottom();i&&i.lighting.sunlightFull&&i.handleSunlightStop()}markTileAsEverVisible(){this.lighting.everVisibleToCharacter=!0,this.mineTileIndex<0&&!this.open&&(this.isCurrency()||this.isPriority())&&(this.region.mineTiles.push(this),this.mineTileIndex=this.region.mineTiles.length-1)}markTileAsCurrentlyVisible(){this.lighting.markTileAsCurrentlyVisible(),this.mineTileIndex<0&&!this.open&&(this.isCurrency()||this.isPriority())&&(this.region.mineTiles.push(this),this.mineTileIndex=this.region.mineTiles.length-1)}markAsSunlightFull(){this.lighting.markAsSunlightFull(),this.mineTileIndex<0&&!this.open&&(this.isCurrency()||this.isPriority())&&(this.region.mineTiles.push(this),this.mineTileIndex=this.region.mineTiles.length-1)}addPositionalLighting(e){this.lighting.addPositionalLighting(e),this.markTileAsCurrentlyVisible()}addEnvironmentLighting(e){this.lighting.addEnvironmentLighting(e),this.markTileAsEverVisible()}addDynamicLighting(e){this.lighting.addDynamicLighting(e),this.markTileAsEverVisible()}hash(){let e=this.origin.x/n.tile.size,t=this.origin.y/n.tile.size,i=17;return i=31*i+e,i=31*i+t,i}};var Hs=class extends Ct{constructor(e,t){super(t),this.grid=e,this.regions=this.createRegions()}createRegions(){let e=this.getOrigin(),t=e.x,i=e.y,s=new Array(n.grid.numRegionColsInZone*n.grid.numRegionRowsInZone),r=0;for(let o=0;o<n.grid.numRegionColsInZone;o++)for(let a=0;a<n.grid.numRegionRowsInZone;a++)s[r++]=new ks(this,new v(t+n.grid.regionPixelWidth*o,i+n.grid.regionPixelHeight*a));return s}initialize(e,t){this.origin.set(e,t);let i=this.origin.x,s=this.origin.y,r=0;for(let o=0;o<n.grid.numRegionColsInZone;o++)for(let a=0;a<n.grid.numRegionRowsInZone;a++)this.regions[r++].initialize(i+n.grid.regionPixelWidth*o,s+n.grid.regionPixelHeight*a)}getWorldGrid(){return this.grid.getWorldGrid()}getGrid(){return this.grid}getRegions(){return this.regions}getPixelWidth(){return n.grid.zonePixelWidth}getPixelHeight(){return n.grid.zonePixelHeight}getGridTileAbsolute(e,t){let i=this.origin,s=q.floor(i.x/n.tile.size),r=q.floor(i.y/n.tile.size);return this.getGridTileLocal(e-s,t-r)}getGridTileLocal(e,t){let i=q.floor(e/n.grid.regionTileWidth),s=q.floor(t/n.grid.regionTileHeight);if(i<0||i>=n.grid.numRegionColsInZone||s<0||s>=n.grid.numRegionRowsInZone)return null;let r=i*n.grid.numRegionRowsInZone+s;if(r>=0&&r<this.regions.length){let o=this.regions[r],a=this.getOrigin(),h=q.floor(a.x/n.tile.size),m=q.floor(a.y/n.tile.size),p=o.getOrigin(),f=q.floor(p.x/n.tile.size),S=q.floor(p.y/n.tile.size);return o.getGridTileLocal(e+h-f,t+m-S)}else return console.log("GridZone.getGridTileLocal() Failed to find tile. col="+e+" row="+t+" index="+r),null}findTileNeighborsFull(){for(let e=0;e<this.regions.length;e++)this.regions[e].findTileNeighborsFull()}findRegionNeighborsBorderEast(){let e=n.grid.numRegionColsInZone-1;for(let t=0;t<n.grid.numRegionRowsInZone;t++)this.findRegion(e,t).findTileNeighborsBorderRight()}findRegionNeighborsBorderWest(){for(let e=0;e<n.grid.numRegionRowsInZone;e++)this.findRegion(0,e).findTileNeighborsBorderLeft()}findRegionNeighborsBorderSouth(){let e=n.grid.numRegionColsInZone-1;for(let t=0;t<n.grid.numRegionColsInZone;t++)this.findRegion(t,e).findTileNeighborsBorderBottom()}findRegionNeighborsBorderNorth(){for(let e=0;e<n.grid.numRegionColsInZone;e++)this.findRegion(e,0).findTileNeighborsBorderTop()}findRegion(e,t){return this.regions[e*n.grid.numRegionRowsInZone+t]}findZoneBorderRegionNeighbors(){let e=n.grid.numRegionColsInZone-1,t=n.grid.numRegionRowsInZone-1,i=0,s=0,r=this.findRegion(e,t),o=this.findRegion(e,i),a=this.findRegion(s,t),h=this.findRegion(s,i);if(r.findTileNeighborsBorderTop(),r.findTileNeighborsBorderRight(),o.findTileNeighborsBorderBottom(),o.findTileNeighborsBorderRight(),a.findTileNeighborsBorderTop(),a.findTileNeighborsBorderLeft(),h.findTileNeighborsBorderBottom(),h.findTileNeighborsBorderLeft(),n.grid.numRegionRowsInZone>2){for(let m=1;m<n.grid.numRegionRowsInZone-1;m++)this.findRegion(e,m).findTileNeighborsBorderRight();for(let m=1;m<n.grid.numRegionRowsInZone-1;m++)this.findRegion(s,m).findTileNeighborsBorderLeft()}if(n.grid.numRegionColsInZone>2){for(let m=1;m<n.grid.numRegionColsInZone-1;m++)this.findRegion(m,i).findTileNeighborsBorderBottom();for(let m=1;m<n.grid.numRegionColsInZone-1;m++)this.findRegion(m,t).findTileNeighborsBorderTop()}}findTileNeighborsZoneBorderRight(){let e=n.grid.numRegionColsInZone-1;for(let t=0;t<n.grid.numRegionRowsInZone;t++)this.findRegion(e,t).findTileNeighborsBorderRight()}nullifyTileNeighborsZoneBorderRight(){let e=n.grid.numRegionColsInZone-1;for(let t=0;t<n.grid.numRegionRowsInZone;t++)this.findRegion(e,t).nullifyTileNeighborsBorderRight()}findTileNeighborsZoneBorderLeft(){for(let e=0;e<n.grid.numRegionRowsInZone;e++)this.findRegion(0,e).findTileNeighborsBorderLeft()}nullifyTileNeighborsZoneBorderLeft(){for(let e=0;e<n.grid.numRegionRowsInZone;e++)this.findRegion(0,e).nullifyTileNeighborsBorderLeft()}findTileNeighborsZoneBorderBottom(){let e=n.grid.numRegionRowsInZone-1;for(let t=0;t<n.grid.numRegionColsInZone;t++)this.findRegion(t,e).findTileNeighborsBorderBottom()}nullifyTileNeighborsZoneBorderBottom(){let e=n.grid.numRegionRowsInZone-1;for(let t=0;t<n.grid.numRegionColsInZone;t++)this.findRegion(t,e).nullifyTileNeighborsBorderBottom()}findTileNeighborsZoneBorderTop(){for(let e=0;e<n.grid.numRegionColsInZone;e++)this.findRegion(e,0).findTileNeighborsBorderTop()}nullifyTileNeighborsZoneBorderTop(){for(let e=0;e<n.grid.numRegionColsInZone;e++)this.findRegion(e,0).nullifyTileNeighborsBorderTop()}evaluateTileBordersRight(){let e=n.grid.numRegionColsInZone-1;for(let t=0;t<n.grid.numRegionRowsInZone;t++)this.findRegion(e,t).evaluateTileBordersRight()}evaluateTileBordersLeft(){for(let e=0;e<n.grid.numRegionRowsInZone;e++)this.findRegion(0,e).evaluateTileBordersLeft()}evaluateTileBordersBottom(){let e=n.grid.numRegionRowsInZone-1;for(let t=0;t<n.grid.numRegionColsInZone;t++)this.findRegion(t,e).evaluateTileBordersBottom()}evaluateTileBordersTop(){for(let e=0;e<n.grid.numRegionColsInZone;e++)this.findRegion(e,0).evaluateTileBordersTop()}};var zs=class extends K{constructor(){super(),this.gridCenter=new v(n.start.startX,n.start.startY),this.stayCenteredOnCharacter=!0,this.screenOrigin=new v(0,0),this.visibleHalfWidth=0,this.visibleHalfHeight=0,this.visibleHalfWidthWorld=0,this.visibleHalfHeightWorld=0,this.screenScaleFactor=1,this.zoom=n.projection.zoomDefault,this.canvas=null}setCanvas(e){this.canvas=e}resetProjectionState(){this.setGridCenter(n.projection.startCenterX,n.projection.startCenterY),this.zoom=n.projection.zoomDefault,this.canvas=null}setGridCenter(e,t){this.gridCenter.set(e,t)}updateSpaceCenter(e,t){this.gridCenter.addXY(e,t)}updateProjectionForFrame(){this.canvas&&(this.visibleHalfWidth=this.canvas.width/2,this.visibleHalfHeight=this.canvas.height/2,this.visibleHalfWidthWorld=this.visibleHalfWidth/this.zoom,this.visibleHalfHeightWorld=this.visibleHalfHeight/this.zoom,this.screenOrigin.set(this.zoom*this.gridCenter.x-this.visibleHalfWidth,this.zoom*this.gridCenter.y-this.visibleHalfHeight),this.screenOrigin.x=this.screenOrigin.x|0,this.screenOrigin.y=this.screenOrigin.y|0)}screenToWorldDistance(e){return e/this.zoom}screenToWorld(e,t){var i=1/this.zoom;t.set(i*(this.screenOrigin.x+e.x),i*(this.screenOrigin.y+e.y))}worldToScreen(e,t){t.x=this.zoom*e.x-this.screenOrigin.x,t.y=this.zoom*e.y-this.screenOrigin.y}setZoom(e){this.zoom=e,this.zoom<n.projection.zoomOutScaleLimit&&(this.zoom=n.projection.zoomOutScaleLimit),this.zoom>n.projection.zoomInScaleLimit&&(this.zoom=n.projection.zoomInScaleLimit)}zoomOut(){this.zoom-=n.projection.zoomStep,this.zoom<n.projection.zoomOutScaleLimit&&(this.zoom=n.projection.zoomOutScaleLimit)}zoomIn(){this.zoom+=n.projection.zoomStep,this.zoom>n.projection.zoomInScaleLimit&&(this.zoom=n.projection.zoomInScaleLimit)}isNearby(e,t,i){return this.isNearbyX(e.origin.x,e.getPixelWidth(),t,i)&&this.isNearbyY(e.origin.y,e.getPixelHeight(),t,i)}isNearbyXY(e,t,i,s){return this.isNearbyX(e,1,i,s)&&this.isNearbyY(t,1,i,s)}isVisible(e,t){return this.isVisibleX(e.x,t)&&this.isVisibleY(e.y,t)}isVisibleXY(e,t,i){return this.isVisibleX(e,i)&&this.isVisibleY(t,i)}isVisibleGridBox(e){return this.isVisibleX(e.origin.x,e.getPixelWidth())&&this.isVisibleY(e.origin.y,e.getPixelHeight())}isVisibleX(e,t){return e<this.gridCenter.x+this.visibleHalfWidthWorld&&e+t>=this.gridCenter.x-this.visibleHalfWidthWorld}isVisibleY(e,t){return e<this.gridCenter.y+this.visibleHalfHeightWorld&&e+t>=this.gridCenter.y-this.visibleHalfHeightWorld}getMaxVisibleHalfWidth(){return Math.max(this.visibleHalfHeightWorld,this.visibleHalfWidthWorld)}isNearbyX(e,t,i,s){return e<i.x+s&&e+t>=i.x-s}isNearbyY(e,t,i,s){return e<i.y+s&&e+t>=i.y-s}clampToScreen(e,t,i){let s=Math.min(Math.max(e.x,0),this.canvas.width-t),r=Math.min(Math.max(e.y,0),this.canvas.height-i);e.set(s,r)}resetFull(){this.resetProjectionState()}resetForPrestige(){this.resetProjectionState()}};var be=class{constructor(){}static allVisibleGrids(e,t,i){let s=e.grids;for(let r=0;r<s.length;r++){let o=s[r];o&&o.loaded&&t.isVisibleGridBox(o)&&i(o)}}static allVisibleRegions(e,t,i){let s=e.grids;for(let r=0;r<s.length;r++){let o=s[r];o&&o.loaded&&t.isVisibleGridBox(o)&&this.allVisibleRegionsInGrid(o,t,i)}}static allVisibleTiles(e,t,i){let s=e.grids;for(let r=0;r<s.length;r++){let o=s[r];o&&t.isVisibleGridBox(o)&&this.allVisibleTilesInGrid(o,t,i)}}static allNearbyRegions(e,t,i,s,r){let o=e.grids;for(let a=0;a<o.length;a++){let h=o[a];!h||!h.isLoaded()||(h.contains(i)||t.isNearby(h,i,s))&&this.allNearbyRegionsInGrid(h,t,r,i,s)}}static allVisibleTilesInGrid(e,t,i){if(!e)return;let s=e.zones;for(let r=0;r<s.length;r++){let o=s[r];if(t.isVisibleGridBox(o)){let a=o.getRegions();for(let h=0;h<a.length;h++){let m=a[h];if(t.isVisibleGridBox(m)){let p=m.getTiles();for(let f=0;f<p.length;f++){let S=p[f];t.isVisibleGridBox(S)&&i(S)}}}}}}static allTilesInGrid(e,t){if(!e)return;let i=e.zones;for(let s=0;s<i.length;s++){let r=i[s].getRegions();for(let o=0;o<r.length;o++){let a=r[o].getTiles();for(let h=0;h<a.length;h++)t(a[h])}}}static allTilesInGridZone(e,t){if(!e)return;let i=e.getRegions();for(let s=0;s<i.length;s++){let r=i[s].getTiles();for(let o=0;o<r.length;o++)t(r[o])}}static allVisibleRegionsInGrid(e,t,i){if(!e)return;let s=e.zones;for(let r=0;r<s.length;r++){let o=s[r];if(t.isVisibleGridBox(o)){let a=o.getRegions();for(let h=0;h<a.length;h++){let m=a[h];t.isVisibleGridBox(m)&&i(m)}}}}static allNearbyRegionsInGrid(e,t,i,s,r){if(!e)return;let o=e.zones;for(let a=0;a<o.length;a++){let h=o[a];if(t.isNearby(h,s,r)){let m=h.getRegions();for(let p=0;p<m.length;p++){let f=m[p];t.isNearby(f,s,r)&&i(f)}}}}static allRegionsInGrid(e,t){if(!e)return;let i=e.zones;for(let s=0;s<i.length;s++){let o=i[s].getRegions();for(let a=0;a<o.length;a++)t(o[a])}}};var ui=class extends Et{constructor(){super(),this.color=null,this.radius=0,this.tile=null}set(e,t,i){this.tile=e,this.color=t,this.radius=i}getTile(){return this.tile}setTile(e){this.tile=e}getColor(){return this.color}getTileRadius(){return this.radius}reset(e){super.reset(e),this.color=null,this.radius=0,this.tile=null}};var el=0,tl=1,il=2,sl=3,dt=class extends Ct{constructor(e,t){super(t),this.worldGrid=e,this.gridChangeCount=0,this.zones=this.createZoneArray(),this.neighbors=new Array(4),this.neighbors[el]=null,this.neighbors[tl]=null,this.neighbors[il]=null,this.neighbors[sl]=null,this.characters=[],this.lightSources=[],this.loaded=!1}createZoneArray(){let e=new Array(n.grid.numZoneColsInGrid*n.grid.numZoneRowsInGrid),t=this.origin,i=t.x,s=t.y,r=0;for(let o=0;o<n.grid.numZoneColsInGrid;o++)for(let a=0;a<n.grid.numZoneRowsInGrid;a++)e[r++]=new Hs(this,new v(i+n.grid.zonePixelWidth*o,s+n.grid.zonePixelHeight*a));return e}unloadGrid(){if(this.characters.length>0){let e=this.characters.length;for(let t=e-1;t>=0;t--){let i=this.characters[t];i.isMonster()?i.isFinishedAndAvailable()||i.reset(!0):i.isPartyMember()&&(console.log("Grid.unloadGrid() party character is in grid that is being unloaded."),i.position.resetFull(),i.resetTurnState())}this.characters.length=0}if(this.lightSources!=null){let e=this.lightSources.length;for(let t=e-1;t>=0;t--){let i=this.lightSources[t];i.isFinishedAndAvailable()||i.reset(!0)}this.lightSources.length=0}this.loaded=!1}getLightSources(){return this.lightSources}addLightSource(e){this.lightSources.push(e)}removeLightSource(e){if(this.lightSources==null||this.lightSources.length===0||!e)return;let t=this.lightSources.indexOf(e);t>=0&&this.lightSources.splice(t,1)}removeLightSourceForTile(e){if(!(this.lightSources==null||this.lightSources.length===0||e==null)){for(let t=0;t<this.lightSources.length;t++)if(this.lightSources[t].getTile()===e){this.lightSources.splice[1];break}}}addCharacter(e){e&&this.characters.push(e)}removeCharacter(e){if(e){let t=this.characters.indexOf(e);t!==-1&&this.characters.splice(t,1)}}initializeZonesForGrid(){this.gridChangeCount=0;let e=this.zones,t=this.origin,i=t.x,s=t.y,r=0;for(let o=0;o<n.grid.numZoneColsInGrid;o++)for(let a=0;a<n.grid.numZoneRowsInGrid;a++)e[r++].initialize(i+n.grid.zonePixelWidth*o,s+n.grid.zonePixelHeight*a)}setGridNeighbors(e,t,i,s){this.neighbors[el]=e,this.neighbors[tl]=t,this.neighbors[il]=i,this.neighbors[sl]=s}markGridAsChanged(){this.gridChangeCount++,this.worldGrid.changeCount++}getWorldGrid(){return this.worldGrid}isLoaded(){return this.loaded}getZones(){return this.zones}getGridCol(){return q.floor(this.origin.x/n.grid.gridPixelWidth)}getGridRow(){return q.floor(this.origin.y/n.grid.gridPixelHeight)}static calculateGridCol(e){return q.floor(e/n.grid.gridTileWidth)}static calculateGridRow(e){return q.floor(e/n.grid.gridTileHeight)}getPixelWidth(){return n.grid.gridPixelWidth}getPixelHeight(){return n.grid.gridPixelHeight}getGridTile(e,t){return this.getGridTileAbsolute(e,t)}findGridTile(e){if(!this.contains(e))return null;let t=q.floor(e.x/n.tile.size),i=q.floor(e.y/n.tile.size);return this.getGridTileAbsolute(t,i)}getGridTileAbsolute(e,t){let i=this.origin,s=q.floor(i.x/n.tile.size),r=q.floor(i.y/n.tile.size);return this.getGridTileLocal(e-s,t-r)}getGridTileLocal(e,t){let i=q.floor(e/n.grid.zoneTileWidth),s=q.floor(t/n.grid.zoneTileHeight);if(i<0||i>=n.grid.numZoneColsInGrid||s<0||s>=n.grid.numZoneRowsInGrid)return null;let r=i*n.grid.numZoneRowsInGrid+s;if(r>=0&&r<this.zones.length){let o=this.zones[r],a=this.origin,h=a.x/n.tile.size,m=a.y/n.tile.size,p=o.origin,f=p.x/n.tile.size,S=p.y/n.tile.size;return o.getGridTileLocal(e+h-f,t+m-S)}else return console.log("Grid.getGridTileLocal() Failed to find tile. col="+e+" row="+t+" index="+r),null}isTileType(e,t,i){let s=this.getGridTile(e,t);return s!==null&&s.getTileType()===i}isNotTileType(e,t,i){let s=this.getGridTile(e,t);return s===null||s.getTileType()!==i}createCenterVector(){let e=new v;return this.assignCenterVector(e),e}assignCenterVector(e){let t=q.floor(n.grid.gridPixelWidth/2),i=q.floor(n.grid.gridPixelHeight/2),s=this.getOrigin();e.x=s.x+t,e.y=s.y+i}findTileNeighborsFull(){for(let e=0;e<this.zones.length;e++)this.zones[e].findTileNeighborsFull()}findWorldGridTileNeighbors(){this.neighbors[el]?this.findTileNeighborsGridBorderTop():this.nullifyTileNeighborsGridBorderTop(),this.neighbors[tl]?this.findTileNeighborsGridBorderBottom():this.nullifyTileNeighborsGridBorderBottom(),this.neighbors[sl]?this.findTileNeighborsGridBorderLeft():this.nullifyTileNeighborsGridBorderLeft(),this.neighbors[il]?this.findTileNeighborsGridBorderRight():this.nullifyTileNeighborsGridBorderRight()}evaluateWorldGridTileNeighborBorders(){this.neighbors[el]&&this.evaluateTileBordersTop(),this.neighbors[tl]&&this.evaluateTileBordersBottom(),this.neighbors[sl]&&this.evaluateTileBordersLeft(),this.neighbors[il]&&this.evaluateTileBordersRight()}evaluateAllTileBorders(){be.allTilesInGrid(this,function(e){e.evaluateBorders()})}nullifyBorderNeighbors(){this.nullifyTileNeighborsGridBorderRight(),this.nullifyTileNeighborsGridBorderLeft(),this.nullifyTileNeighborsGridBorderBottom(),this.nullifyTileNeighborsGridBorderTop()}findTileNeighborsGridBorderRight(){let e=n.grid.numZoneColsInGrid-1;for(let t=0;t<n.grid.numZoneRowsInGrid;t++)this.findZone(e,t).findTileNeighborsZoneBorderRight()}nullifyTileNeighborsGridBorderRight(){let e=n.grid.numZoneColsInGrid-1;for(let t=0;t<n.grid.numZoneRowsInGrid;t++)this.findZone(e,t).nullifyTileNeighborsZoneBorderRight()}evaluateTileBordersRight(){let e=n.grid.numZoneColsInGrid-1;for(let t=0;t<n.grid.numZoneRowsInGrid;t++)this.findZone(e,t).evaluateTileBordersRight()}findTileNeighborsGridBorderLeft(){for(let e=0;e<n.grid.numZoneRowsInGrid;e++)this.findZone(0,e).findTileNeighborsZoneBorderLeft()}nullifyTileNeighborsGridBorderLeft(){for(let e=0;e<n.grid.numZoneRowsInGrid;e++)this.findZone(0,e).nullifyTileNeighborsZoneBorderLeft()}evaluateTileBordersLeft(){for(let e=0;e<n.grid.numZoneRowsInGrid;e++)this.findZone(0,e).evaluateTileBordersLeft()}findTileNeighborsGridBorderBottom(){let e=n.grid.numZoneRowsInGrid-1;for(let t=0;t<n.grid.numZoneColsInGrid;t++)this.findZone(t,e).findTileNeighborsZoneBorderBottom()}nullifyTileNeighborsGridBorderBottom(){let e=n.grid.numZoneRowsInGrid-1;for(let t=0;t<n.grid.numZoneColsInGrid;t++)this.findZone(t,e).nullifyTileNeighborsZoneBorderBottom()}evaluateTileBordersBottom(){let e=n.grid.numZoneRowsInGrid-1;for(let t=0;t<n.grid.numZoneColsInGrid;t++)this.findZone(t,e).evaluateTileBordersBottom()}findTileNeighborsGridBorderTop(){for(let e=0;e<n.grid.numZoneColsInGrid;e++)this.findZone(e,0).findTileNeighborsZoneBorderTop()}nullifyTileNeighborsGridBorderTop(){for(let e=0;e<n.grid.numZoneColsInGrid;e++)this.findZone(e,0).nullifyTileNeighborsZoneBorderTop()}evaluateTileBordersTop(){for(let e=0;e<n.grid.numZoneColsInGrid;e++)this.findZone(e,0).evaluateTileBordersTop()}findZone(e,t){return this.zones[e*n.grid.numZoneRowsInGrid+t]}};var Ws=class{constructor(){this.targetTile=null,this.mineTile=null,this.invalidated=!1,this.behaviorId=null}setTargetTile(e,t,i){this.resetTarget(),this.targetTile=e,this.mineTile=t,this.invalidated=!1,this.behaviorId=i}onGridUnload(e){if(this.targetTile&&this.targetTile.grid===e){this.resetTarget();return}this.mineTile&&this.mineTile.grid===e&&this.resetTarget()}resetTarget(){this.targetTile=null,this.mineTile=null,this.invalidated=!1,this.behaviorId=null}};var Ie=class{constructor(e,t,i){this.startTile=e,this.endTile=t,this.pathSteps=i,this.fallSpeedMultiplier=1}isSolidFloorRequiredAtStart(){return!0}executePlan(e,t,i){}walkLeftToCenterX(e,t,i){let s=e.position.worldCoordinateCenter.x,r=Math.abs(s-i);if(r===0)return!0;e.setCharacterAction($.WALK),e.position.facingLeft=!0;let o=this.getWalkDistanceThisFrame(t);return r<o?(e.position.moveX(-r),!0):(e.position.moveX(-o),!1)}walkRightToCenterX(e,t,i){let s=e.position.worldCoordinateCenter.x,r=Math.abs(i-s);if(r===0)return!0;e.setCharacterAction($.WALK),e.position.facingLeft=!1;let o=this.getWalkDistanceThisFrame(t);return r<o?(e.position.moveX(r),!0):(e.position.moveX(o),!1)}jumpUp(e,t,i){e.setCharacterAction($.JUMP);let s=this.getJumpDistanceThisFrame(t);return e.position.worldCoordinateOrigin.y-i.origin.y<s?(e.position.setY(i.origin.y),!0):(e.position.moveY(-s),!1)}jumpUpAndLeft(e,t,i,s){let r=i.x,o=s.x,a=(r-o)/2,h=o+a,m=i.y-s.y+n.tile.halfSize,p=i.y-m,f=this.getWalkDistanceThisFrame(t);if(e.position.facingLeft=!0,e.position.worldCoordinateCenter.x>h){e.setCharacterAction($.JUMP);let C=this.getJumpDistanceThisFrame(t),T=e.position.worldCoordinateCenter.x-h,A=e.position.worldCoordinateOrigin.y-p;if(T>A){let N=this.calcRatio(A,T),P=Math.min(N*C,A),M=Math.min(f,T);e.position.moveXY(-M,-P)}else{let N=this.calcRatio(T,A),P=Math.min(N*f,T),M=Math.min(C,A);e.position.moveXY(-P,-M)}return}e.setCharacterAction($.FALL);let S=this.getFallDistanceThisFrame(t),E=e.position.worldCoordinateCenter.x-o,w=this.endTile.origin.y-e.position.worldCoordinateOrigin.y;if(!(E===0&&w===0))if(E>w){let C=this.calcRatio(w,E),T=Math.min(C*S,w),A=Math.min(f,E);e.position.moveXY(-A,T)}else{let C=this.calcRatio(E,w),T=Math.min(C*f,E),A=Math.min(S,w);e.position.moveXY(-T,A)}}jumpUpAndRight(e,t,i,s){let r=i.x,o=s.x,a=(o-r)/2,h=r+a,m=i.y-s.y+n.tile.halfSize,p=i.y-m,f=this.getWalkDistanceThisFrame(t);if(e.position.facingLeft=!1,e.position.worldCoordinateCenter.x<h){e.setCharacterAction($.JUMP);let C=this.getJumpDistanceThisFrame(t),T=h-e.position.worldCoordinateCenter.x,A=e.position.worldCoordinateOrigin.y-p;if(T>A){let N=this.calcRatio(A,T),P=Math.min(N*C,A),M=Math.min(f,T);e.position.moveXY(M,-P)}else{let N=this.calcRatio(T,A),P=Math.min(N*f,T),M=Math.min(C,A);e.position.moveXY(P,-M)}return}e.setCharacterAction($.FALL);let S=this.getFallDistanceThisFrame(t),E=o-e.position.worldCoordinateCenter.x,w=s.y-e.position.worldCoordinateOrigin.y;if(!(E===0&&w===0))if(E>w){let C=this.calcRatio(w,E),T=Math.min(C*S,w),A=Math.min(f,E);e.position.moveXY(A,T)}else{let C=this.calcRatio(E,w),T=Math.min(C*f,E),A=Math.min(S,w);e.position.moveXY(T,A)}}jumpDownAndLeft(e,t,i,s){let r=i.x,o=s.x,a=(r-o)/2,h=o+a,m=n.tile.halfSize,p=i.y-m,f=this.getWalkDistanceThisFrame(t);if(e.position.facingLeft=!0,e.position.worldCoordinateCenter.x>h){e.setCharacterAction($.JUMP);let C=this.getJumpDistanceThisFrame(t),T=e.position.worldCoordinateCenter.x-h,A=e.position.worldCoordinateOrigin.y-p;if(T>A){let N=this.calcRatio(A,T),P=Math.min(N*C,A),M=Math.min(f,T);e.position.moveXY(-M,-P)}else{let N=this.calcRatio(T,A),P=Math.min(N*f,T),M=Math.min(C,A);e.position.moveXY(-P,-M)}return}e.setCharacterAction($.FALL);let S=this.getFallDistanceThisFrame(t),E=e.position.worldCoordinateCenter.x-o,w=this.endTile.origin.y-e.position.worldCoordinateOrigin.y;if(!(E===0&&w===0))if(E>w){let C=this.calcRatio(w,E),T=Math.min(C*S,w),A=Math.min(f,E);e.position.moveXY(-A,T)}else{let C=this.calcRatio(E,w),T=Math.min(C*f,E),A=Math.min(S,w);e.position.moveXY(-T,A)}}jumpDownAndRight(e,t,i,s){let r=i.x,o=s.x,a=(o-r)/2,h=r+a,m=n.tile.halfSize,p=i.y-m,f=this.getWalkDistanceThisFrame(t);if(e.position.facingLeft=!1,e.position.worldCoordinateCenter.x<h){e.setCharacterAction($.JUMP);let C=this.getJumpDistanceThisFrame(t),T=h-e.position.worldCoordinateCenter.x,A=e.position.worldCoordinateOrigin.y-p;if(T>A){let N=this.calcRatio(A,T),P=Math.min(N*C,A),M=Math.min(f,T);e.position.moveXY(M,-P)}else{let N=this.calcRatio(T,A),P=Math.min(N*f,T),M=Math.min(C,A);e.position.moveXY(P,-M)}return}e.setCharacterAction($.FALL);let S=this.getFallDistanceThisFrame(t),E=o-e.position.worldCoordinateCenter.x,w=s.y-e.position.worldCoordinateOrigin.y;if(!(E===0&&w===0))if(E>w){let C=this.calcRatio(w,E),T=Math.min(C*S,w),A=Math.min(f,E);e.position.moveXY(A,T)}else{let C=this.calcRatio(E,w),T=Math.min(C*f,E),A=Math.min(S,w);e.position.moveXY(T,A)}}jumpLeft(e,t,i,s,r){let o=i.x,a=s.x,h=(o-a)/2,m=a+h,p=i.y-r,f=this.getWalkDistanceThisFrame(t);if(e.position.facingLeft=!0,e.position.worldCoordinateCenter.x>m){e.setCharacterAction($.JUMP);let C=this.getJumpDistanceThisFrame(t),T=e.position.worldCoordinateCenter.x-m,A=e.position.worldCoordinateOrigin.y-p;if(T>A){let N=this.calcRatio(A,T),P=Math.min(N*C,A),M=Math.min(f,T);e.position.moveXY(-M,-P)}else{let N=this.calcRatio(T,A),P=Math.min(N*f,T),M=Math.min(C,A);e.position.moveXY(-P,-M)}return}e.setCharacterAction($.FALL);let S=this.getFallDistanceThisFrame(t),E=e.position.worldCoordinateCenter.x-a,w=this.endTile.origin.y-e.position.worldCoordinateOrigin.y;if(!(E===0&&w===0))if(E>w){let C=this.calcRatio(w,E),T=Math.min(C*S,w),A=Math.min(f,E);e.position.moveXY(-A,T)}else{let C=this.calcRatio(E,w),T=Math.min(C*f,E),A=Math.min(S,w);e.position.moveXY(-T,A)}}jumpRight(e,t,i,s,r){let o=i.x,a=s.x,h=(a-o)/2,m=o+h,p=i.y-r,f=this.getWalkDistanceThisFrame(t);if(e.position.facingLeft=!1,e.position.worldCoordinateCenter.x<m){e.setCharacterAction($.JUMP);let C=this.getJumpDistanceThisFrame(t),T=m-e.position.worldCoordinateCenter.x,A=e.position.worldCoordinateOrigin.y-p;if(T>A){let N=this.calcRatio(A,T),P=Math.min(N*C,A),M=Math.min(f,T);e.position.moveXY(M,-P)}else{let N=this.calcRatio(T,A),P=Math.min(N*f,T),M=Math.min(C,A);e.position.moveXY(P,-M)}return}e.setCharacterAction($.FALL);let S=this.getFallDistanceThisFrame(t),E=a-e.position.worldCoordinateCenter.x,w=s.y-e.position.worldCoordinateOrigin.y;if(!(E===0&&w===0))if(E>w){let C=this.calcRatio(w,E),T=Math.min(C*S,w),A=Math.min(f,E);e.position.moveXY(A,T)}else{let C=this.calcRatio(E,w),T=Math.min(C*f,E),A=Math.min(S,w);e.position.moveXY(T,A)}}fallDownAndLeft(e,t,i){e.position.facingLeft=!0,e.setCharacterAction($.FALL);let s=this.getFallDistanceThisFrame(t),r=this.getWalkDistanceThisFrame(t),o=e.position.worldCoordinateCenter.x-i.x,a=i.y-e.position.worldCoordinateOrigin.y,h=Math.min(r,o),m=Math.min(s,a);e.position.moveXY(-h,m)}fallDownAndRight(e,t,i){e.position.facingLeft=!1,e.setCharacterAction($.FALL);let s=this.getFallDistanceThisFrame(t),r=this.getWalkDistanceThisFrame(t),o=i.x-e.position.worldCoordinateCenter.x,a=i.y-e.position.worldCoordinateOrigin.y,h=Math.min(r,o),m=Math.min(s,a);e.position.moveXY(h,m)}fallDown(e,t,i){e.setCharacterAction($.FALL);let s=this.getFallDistanceThisFrame(t),r=i.origin.y-e.position.worldCoordinateOrigin.y;return s<r?(e.position.moveY(s),!1):(e.position.setY(i.origin.y),!0)}getWalkDistanceThisFrame(e){return n.physics.walkRatePerFrame*e}getFallDistanceThisFrame(e){return n.physics.gravityRatePerFrame*e*this.fallSpeedMultiplier}getJumpDistanceThisFrame(e){return n.physics.jumpRatePerFrame*e}getDistanceAboveFloor(e){let t=e.tile.origin.y,i=e.worldCoordinateOrigin.y;return t-i}assertEndTileReached(e,t){if(e.position.tile!==t){let i=t.origin;e.position.setTileAndOriginPosition(t,i.x,i.y)}else e.position.setPositionToTileOrigin()}calcRatio(e,t){return e===t?1:e===0?0:t===0?(console.log("calcRatio() 0 denominator"),1e3):e/t}toString(){return"Base PathPlan toString() sub-class did not override."}};var Ys=class{constructor(e){this.character=e,this.worldCoordinateOrigin=new v(0,0),this.worldCoordinateCenter=new v(0,0),this.tile=null,this.grid=null,this.facingLeft=!0,this.gravityThisFrame=0,this.pathPlan=[]}setGrid(e){this.grid!=e&&(this.grid&&this.grid.removeCharacter(this.character),e?.addCharacter(this.character),this.grid=e)}castVerticalPositionToInteger(){this.worldCoordinateOrigin.y=q.floor(this.worldCoordinateOrigin.y),this.worldCoordinateCenter.y=this.worldCoordinateOrigin.y+n.tile.halfSize}setTileAndOriginPosition(e,t,i){this.worldCoordinateOrigin.set(t,i),this.tile=e,this.onWorldCoordinateChange()}isNearTileOrigin(){if(!this.tile)return!1;let e=this.worldCoordinateOrigin.x-this.tile.origin.x,t=this.worldCoordinateOrigin.y-this.tile.origin.y;return Math.abs(e)<=n.tile.quarterSize&&Math.abs(t)<=n.tile.quarterSize}setPositionToTileOrigin(){this.tile&&this.setTileAndOriginPosition(this.tile,this.tile.origin.x,this.tile.origin.y)}findClosestNeighbor(){let e=this.tile.neighbors,t=null,i=1e6;for(let s=0;s<e.length;s++){let r=e[s];if(!r||!r.open)continue;let o=this.tile.origin.distanceSquared(r.origin);(!t||o<i)&&(t=r,i=o)}return t}isCenteredOnTile(){return this.tile&&this.tile.origin.equals(this.worldCoordinateOrigin)}setWorldCoordinateOrigin(e){this.worldCoordinateOrigin.copy(e),this.onWorldCoordinateChange()}setWorldCoordinateOriginXY(e,t){this.worldCoordinateOrigin.set(e,t),this.onWorldCoordinateChange()}moveX(e){this.worldCoordinateOrigin.addXY(e,0),this.onWorldCoordinateChange()}moveY(e){this.worldCoordinateOrigin.addXY(0,e),this.onWorldCoordinateChange()}setX(e){this.worldCoordinateOrigin.x=e,this.onWorldCoordinateChange()}setY(e){this.worldCoordinateOrigin.y=e,this.onWorldCoordinateChange()}moveXY(e,t){this.worldCoordinateOrigin.addXY(e,t),this.onWorldCoordinateChange()}onWorldCoordinateChange(){if(this.worldCoordinateCenter.copy(this.worldCoordinateOrigin),this.worldCoordinateCenter.addXY(n.tile.halfSize,n.tile.halfSize),!this.tile){console.log("Position.onWorldCoordinateChange() tile is null");return}if(!this.tile.contains(this.worldCoordinateOrigin)){let e=this.tile;this.tile=this.tile.findNeighborContaining(this.worldCoordinateOrigin),this.tile||(this.grid&&(this.tile=this.grid.findGridTile(this.worldCoordinateOrigin)),this.tile||(this.tile=e.getWorldGrid().findGridTile(this.worldCoordinateOrigin)))}this.tile?this.setGrid(this.tile.grid):(console.log("Position.onWorldCoordinateChange() character lost their tile after move."),this.character.onInvalidGrid())}resetPathPlan(){this.pathPlan.length>0&&(this.pathPlan.length=0,this.setPositionToTileOrigin())}resetFull(){this.resetPathPlan(),this.setGrid(null),this.tile=null,this.gravityThisFrame=0}};var ci=class{constructor(){}performAction(e,t,i){}isMovementAction(){return!1}toString(){return"BaseTurnAction"}};var mi=class extends Et{constructor(){super(),this.position=new Ys(this),this.target=new Ws,this.turnAction=null,this.pathCompletedTime=0}isMonster(){return!0}isPartyMember(){return!1}isMinion(){return!1}isDead(){return!1}getMinerIndex(){return-1}getMonsterDescriptionId(){return null}getCharacterLevel(){return 1}setCharacterAction(e){}getCharacterSprite(){return null}getItemOverlaySprite(){return null}isThrusterActive(){return!1}followPathPlan(e,t){if(this.position.pathPlan.length===0)return;this.position.pathPlan[0].executePlan(this,e,t)&&this.position.pathPlan.shift()}chooseTurn(){}performFrameActions(e,t){this.turnAction&&this.turnAction.performAction(this,e,t)}resetTurnState(){this.turnAction=null,this.characterAction=$.STAND,this.target.resetTarget(),this.position.resetPathPlan()}onInvalidGrid(){this.resetGameModel()}resetGameModel(){this.position.resetFull(),this.resetTurnState()}};var Ks=class{constructor(e){this.behaviorId=e}applyIfAppropriate(e){return!1}isAutoPlayBehavior(){return!1}getName(){return"CharacterBehavior****"}};var Xs=class{constructor(e,t){this.id=e,this.behaviors=t}chooseTurn(e){if(!e.position.isCenteredOnTile()){if(e.turnAction&&e.turnAction.isMovementAction()&&e.position.pathPlan.length>0)return;e.position.gravityThisFrame===0&&(console.log("CharacterBrain.chooseTurn() not centered on tile and have no path plan. partyMember="+e.isPartyMember()+" monster="+e.isMonster()),e.resetTurnState())}e.turnAction=null;let t=e.position.tile;if(!t){e.resetTurnState();return}if(!t.grid.isLoaded()){console.log("CharacterBarin.chooseTurn() character in grid that is not loaded."),e.resetTurnState();return}e.position.gravityThisFrame>0||(this.applyBehaviors(e,this.behaviors),e.turnAction||(e.position.resetPathPlan(),e.setCharacterAction($.STAND)))}applyBehaviors(e,t){let i=!1;for(let s=0;s<t.length;s++)if(t[s].applyIfAppropriate(e)){i=!0;break}i||e.target.resetTarget()}};var js=class extends mi{constructor(){super(),this.sprite=null,this.monsterDescription=null,this.brain=null,this.damage=1}set(e,t,i){this.brain=e,this.sprite=t,this.monsterDescription=i}isMonster(){return!0}getMonsterDescriptionId(){return this.monsterDescription.id}getCharacterSprite(){return this.sprite}getDamage(){return this.damage}chooseTurn(){this.brain.chooseTurn(this)}reset(e){super.reset(e),this.finishedAndAvailable&&(this.position.resetFull(),this.resetTurnState(),this.brain=null)}};var Nt=class{constructor(){this.cache=[],this.index=0,this.totalSize=0,this.count=0,this.currentActiveCount=0,this.maxActiveCount=0}get(){this.cache.length==0&&this.growCache(this.getInitialSize()),this.index>=this.cache.length&&(this.index=0),this.index=this.findNextAvailableIndex(this.index);let e=this.cache[this.index];return this.index++,e.reset(!1),e}findNextAvailableIndex(e){let t=this.cache.length;this.maxActiveCount>=t&&(e=t,this.growCache(this.getGrowAmount()),t=this.cache.length);let i=0;do{if(e>=t&&(i++,i==1?e=0:(this.growCache(this.getGrowAmount()),t=this.cache.length)),this.cache[e].isFinishedAndAvailable())return e;e++}while(i<2)}getUnderlyingCache(){return this.cache}growCache(e){for(let t=0;t<e;t++){let i=this.createInstance();i.setCycleCacheListener(this),this.cache.push(i)}console.log("CyclingCache.growCache() amount="+e+" newSize="+this.cache.length+" Type: "+this.constructor.name)}shrinkToSize(e){let t=this.cache.length-e;t>0&&this.cache.splice(e,t)}resetCache(){let e=this.cache.length;if(e==0)return;this.count++,this.totalSize+=this.maxActiveCount;let t=this.totalSize/this.count;for(let i=0;i<e;i++){let s=this.cache[i];s.isFinishedAndAvailable()||s.reset(!0)}if(this.count>5){let i=this.getGrowAmount(),s=this.getInitialSize()+2*i;if(e>t*1.75&&e>s){let r=t*1.2|0,o=this.getInitialSize();for(;o<r;)o+=i;o<e&&this.shrinkToSize(o),this.totalSize=0,this.count=0}}this.maxActiveCount=0,this.currentActiveCount=0,this.index=0}getGrowAmount(){}getInitialSize(){}createInstance(){}onAvailabilityChanged(e){e?this.currentActiveCount--:(this.currentActiveCount++,this.maxActiveCount=Math.max(this.maxActiveCount,this.currentActiveCount))}};var Zs=class extends Nt{constructor(){super(),this.initialCacheSize=50,this.growAmount=15}getGrowAmount(){return this.growAmount}getInitialSize(){return this.initialCacheSize}createInstance(){return new js}};var Ae={BASIC:"B"};var ze=class{constructor(){}static randomInt(e){return Math.random()*e|0}};var pi=class{constructor(){}static findAvailableTileNearMainMiner(e,t){return this.findAvailableNearbyTile(e,t,t.main.position.tile)}static findAvailableNearbyTile(e,t,i){if(!i)return null;let s=this.findAvailableNeighborTile(e,t,i);if(s)return s;let r=this.findAvailableRegionTile(e,t,i.region);if(r)return r;let o=this.forceFindTileInRegion(i.region);if(o)return o;let a=this.findAvailableZoneTile(e,t,i.region.zone);if(a)return a;let h=this.forceFindTileInZone(i.region.zone);return h||(console.log("NearbyTileUtil.findAvailableTileNearMainMiner() Complete failure."),null)}static findAvailableNeighborTile(e,t,i){let s=i.neighbors;for(let r=0;r<5;r++){let o=s[ze.randomInt(s.length)];if(o&&this.isTileClear(e,t,o))return o}return null}static findAvailableZoneTile(e,t,i){let s=i.regions;for(let r=0;r<5;r++){let o=s[ze.randomInt(s.length)],a=this.findAvailableRegionTile(e,t,o);if(a)return a}return null}static forceFindTileInZone(e){let t=e.regions;for(let i=0;i<t.length;i++){let s=this.forceFindTileInRegion(t[i]);if(s)return s}return null}static findAvailableRegionTile(e,t,i){let s=i.tiles;for(let r=0;r<12;r++){let o=s[ze.randomInt(s.length)];if(o&&this.isTileClear(e,t,o))return o}return null}static forceFindTileInRegion(e){if(!e)return null;let t=e.tiles[ze.randomInt(e.tiles.length)];return t.open||t.onTileBreak(),t}static isClosedTileAvailable(e,t,i){for(let s=0;s<t.miners.length;s++){let r=t.miners[s];if(r!==e&&i===r.target.targetTile)return!1}return!0}static isTileClear(e,t,i){if(!i||!i.isTraversable())return!1;for(let s=0;s<t.miners.length;s++){let r=t.miners[s];if(r!==e&&(i===r.position.tile||i===r.target.targetTile))return!1}return!0}};var gi=class{constructor(e){this.characterSpritesheet=e}getSprite(e,t){let i=this.characterSpritesheet.getSpriteAnimation(e);return i?i.getSpriteAsOf(Date.now(),t):null}};var Vi=class{constructor(e,t,i,s,r,o){this.id=e,this.name=t,this.attackType=i,this.armor=s,this.accessory=r,this.iconSpriteName=o}};var qs=class{constructor(e,t,i,s){this.itemType=e,this.iconSprite=t,this.staticAnimation=i,this.activeAnimation=s,this.itemActive=!1,this.itemAnimating=!1,this.activeAnimationStartTime=0}setItemActive(e){this.itemActive=e,e?this.itemAnimating||(this.activeAnimationStartTime=Date.now(),this.itemAnimating=!0):this.itemAnimating&&this.activeAnimation.isAnimationLoopCompleted(this.activeAnimationStartTime)&&(this.itemAnimating=!1,this.activeAnimationStartTime=0)}getItemOverlaySprite(){if(this.itemActive)return this.activeAnimation.getSpriteAsOf(Date.now(),this.activeAnimationStartTime);if(this.itemAnimating)if(this.activeAnimation.isAnimationLoopCompleted(this.activeAnimationStartTime))this.itemAnimating=!1;else return this.activeAnimation.getSpriteAsOf(Date.now(),this.activeAnimationStartTime);return this.staticAnimation.getSpriteAsOf(Date.now(),this.activeAnimationStartTime)}isAnimationLoopCompleted(){return this.itemAnimating?this.activeAnimation.isAnimationLoopCompleted(this.activeAnimationStartTime):!0}};var Js=class extends K{constructor(){super(),this.turnNumber=0,this.frameNumber=0,this.saveTime=0}resetFull(){this.turnNumber=0,this.frameNumber=0,this.saveTime=0}resetForPrestige(){this.turnNumber=0,this.frameNumber=0}};var Qs=class{constructor(e,t){this.animation=e,this.gameTime=t,this.active=!1,this.activeTurn=-1,this.animationStartTime=0}setActive(e){e&&!this.active&&(this.animationStartTime=Date.now()),e&&(this.activeTurn=this.gameTime.turnNumber),this.active=e}deactivateNow(){this.active=!1,this.activeTurn=-1}isActive(){return this.active||this.activeTurn>=this.gameTime.turnNumber-1}getOverlaySprite(){return this.isActive()?this.animation.getSpriteAsOf(Date.now(),this.animationStartTime):null}};var Qt={NUMBER:1,BOOLEAN:2,BIG_NUM:3};var kt=class{constructor(e){this.id=e}reset(){}getValueType(){return Qt.BIG_NUM}isAtInitialValue(){return!0}isValueApplicable(){return!0}};var Ot=class extends kt{constructor(e,t){super(e),this.initialValue=new d(0).copy(t),this.value=new d(0).copy(t)}getValue(){return this.value}setValue(e){this.value.copy(e)}setZero(){this.value.setZero()}incrementValue(e){this.value.add(e)}reset(){this.value.copy(this.initialValue)}getValueType(){return Qt.BIG_NUM}isAtInitialValue(){return this.value.equals(this.initialValue)}isValueApplicable(){return this.value.greaterThanZero()}};var Ce=class extends kt{constructor(e,t){super(e),this.value=t,this.initialValue=t}getValue(){return this.value}setValue(e){this.value=e}incrementValue(e){this.value+=e}decrementValue(e){this.value-=e,this.value<this.initialValue&&(this.value=this.initialValue)}isPercentageApplied(){return this.value<=0?!1:this.value>=100?!0:ze.randomInt(100)<this.value}getPercentAsFraction(){return this.value===0?0:this.value/100}reset(){this.value=this.initialValue}getValueType(){return Qt.NUMBER}isAtInitialValue(){return this.value===this.initialValue}isValueApplicable(){return this.value>0}};var $t=class extends kt{constructor(e,t){super(e),this.initialValue=t,this.value=t}isValue(){return this.value}setValue(e){this.value=e}toggleValue(){this.value=!this.value}reset(){this.value=this.initialValue}getValueType(){return Qt.BOOLEAN}isAtInitialValue(){return this.value===this.initialValue}isValueApplicable(){return this.value!=this.initialValue}};var $s=class extends K{constructor(){super(),this.baseAdditiveBonusPerTurn=new Ot("baseAdditiveBonusPerTurn",new d(0)),this.baseMultiplicativeBonusValue=new Ot("baseMultiBonusValue",new d(0)),this.minedDamageBonusMultiplier=new Ot("minedDamageBonusValue",new d(0)),this.minedOreBonus=new Ot("minedOreBonusValue",new d(0)),this.bonusOreMultiplier=new Ce(null,0),this.bonusUpgradeMultiplier=new Ce(null,0),this.bonusGoldIncrement=new Ce(null,0),this.goldOreBonusMultiplier=new Ot(null,new d(1)),this.skillOreBonusMultiplier=new Ot(null,new d(0)),this.skillPrestigeBonusMultiplier=new Ce(null,0),this.skillRubyBonusMultiplier=new Ce(null,0),this.skillBlockBonusMultiplier=new Ce(null,0),this.skillDepthBonusMultiplier=new Ce(null,0),this.skillUpgradeAdditiveBonusMultiplier=new Ce(null,0),this.skillUpgradeMultiplicativeBonusMultiplier=new Ce(null,0),this.fallSpeedUpgrades=new Ce(null,0),this.fallSpeedBonusActive=new $t(null,!1),this.skillMinedDamageBonus=new Ce(null,0),this.skillMinedOreBonusUpgrades=new Ce(null,0),this.minedAutomationUnlocked=new $t(null,!1),this.minedAutomationRateUpgrades=new Ce(null,0),this.pickAutomationUnlocked=new $t(null,!1),this.pickAutomationRateUpgrades=new Ce(null,0),this.prestigeAutomationUnlocked=new $t(null,!1),this.prestigeAutomationRateUpgrades=new Ce(null,0),this.offlineTimeUpgrades=new Ce(null,0)}resetFull(){this.resetForPrestige(),this.goldOreBonusMultiplier.reset(),this.skillOreBonusMultiplier.reset(),this.skillPrestigeBonusMultiplier.reset(),this.skillRubyBonusMultiplier.reset(),this.skillBlockBonusMultiplier.reset(),this.skillDepthBonusMultiplier.reset(),this.fallSpeedUpgrades.reset(),this.skillUpgradeAdditiveBonusMultiplier.reset(),this.skillUpgradeMultiplicativeBonusMultiplier.reset(),this.skillMinedDamageBonus.reset(),this.skillMinedOreBonusUpgrades.reset(),this.minedAutomationUnlocked.reset(),this.minedAutomationRateUpgrades.reset(),this.pickAutomationUnlocked.reset(),this.pickAutomationRateUpgrades.reset(),this.prestigeAutomationUnlocked.reset(),this.prestigeAutomationRateUpgrades.reset(),this.offlineTimeUpgrades.reset()}resetForPrestige(){this.baseAdditiveBonusPerTurn.reset(),this.baseMultiplicativeBonusValue.reset(),this.minedDamageBonusMultiplier.reset(),this.minedOreBonus.reset(),this.bonusOreMultiplier.reset(),this.bonusUpgradeMultiplier.reset(),this.bonusGoldIncrement.reset()}};var Ke=class{constructor(){}static calculateMinedDamageUpgradeValue(e){let t=(80+ze.randomInt(20))/100;return new d(e.tileType.layerDescription.multiplicativeBonusFactor*t)}static getDamageMultiplier(e){return 1+n.skill.common.damagePerUpgrade*e.getValue()}static getDamagePercent(e){return n.skill.common.damagePercentPerUpgrade*e.getValue()}static getSkillActivationTurns(e){return n.skill.common.baseActivationTurns+e.getValue()*n.skill.common.activationTurnsPerUpgrade}static getSkillActivationSeconds(e){return this.getSkillActivationTurns(e)*n.time.secondsPerTurn}static getSkillCoolDownTurns(e){let t=e.getValue()*n.skill.common.coolDownTurnsPerUpgrade;return Math.max(8,n.skill.common.baseCoolDownTurns-t)}static getSkillCoolDownSeconds(e){return this.getSkillCoolDownTurns(e)*n.time.secondsPerTurn}static getMissileCount(e){return n.skill.missiles.initialMissiles+n.skill.missiles.missilesPerUpgrade*e.getValue()}static getFallSpeedMultiplier(e){return 1+e*n.skill.bonus.fallSpeedMuliplierPerUgrade}};var fi=class extends mi{constructor(e,t,i){super(),this.id=""+i,this.characterClass=e,this.values=t,this.minerIndex=i,this.pick=null,this.thruster=null,this.characterAction=$.STAND,this.characterActionStart=Date.now(),this.skillId=null}isMonster(){return!1}isPartyMember(){return!0}getMinerIndex(){return this.minerIndex}performFrameActions(e,t){if(!this.turnAction){this.updateThrusterStatus();return}this.turnAction.performAction(this,e,t)}followPathPlan(e,t){if(this.position.pathPlan.length===0)return;let i=this.position.pathPlan[0];this.values.fallSpeedBonusActive.isValue()?i.fallSpeedMultiplier=Ke.getFallSpeedMultiplier(this.values.fallSpeedUpgrades.getValue()):i.fallSpeedMultiplier=1,i.executePlan(this,e,t)&&(this.position.pathPlan.shift(),this.position.pathPlan.length>0?this.position.pathPlan[0].isSolidFloorRequiredAtStart()&&this.updateThrusterStatus():(this.updateThrusterStatus(),this.pathCompletedTime=Date.now()))}updateThrusterStatus(){let t=this.position.tile.getNeighborBottom();!t||t.isTraversable()?this.thruster.setActive(!0):this.thruster.deactivateNow()}setCharacterAction(e){this.characterAction!==e&&(this.characterAction=e,this.characterActionStart=Date.now()),this.pick.setItemActive(this.characterAction===$.MINE),this.characterAction!==$.JUMP&&this.characterAction!==$.FALL&&this.updateThrusterStatus()}getCharacterSprite(){return this.characterClass.getSprite(this.characterAction,this.characterActionStart)}getItemOverlaySprite(){return this.pick?this.pick.getItemOverlaySprite():null}getThrusterOverlaySprite(){return this.thruster.getOverlaySprite()}isThrusterActive(){return this.thruster.isActive()}};var Wl={pick:new Vi("1","Pick",!1,!1,Le.pick.icon),sword:new Vi("2","Sword",!1,!1,Le.broadSword.icon)};var er=class extends K{constructor(e,t,i,s,r){super(),this.worldGrid=e,this.gameTime=t,this.characterSpritesheet=i,this.values=r,this.itemOverlaySpritesheet=s,this.main=null,this.miners=[],this.centerTile=null,this.workingCenter=new v(0,0)}resetTargets(){for(let e=0;e<this.miners.length;e++)this.miners[e].target.resetTarget()}findMinerIndex(e){return this.miners.indexOf(e)}calculateCrewCenterCoordinate(e){if(this.miners.length===1){e.copy(this.miners[0].position.worldCoordinateOrigin);return}let t=0,i=0;for(let s=0;s<this.miners.length;s++){let r=this.miners[s].position.worldCoordinateOrigin;t+=r.x,i+=r.y}t=t/this.miners.length,i=i/this.miners.length,e.x=t,e.y=i}calculateCrewCenterTile(){if(this.miners.length===1){let e=this.miners[0].position.tile;return e?(this.centerTile=e,e):(this.centerTile=this.worldGrid.findGridTile(this.miners[0].position.worldCoordinateOrigin),this.centerTile)}else{this.calculateCrewCenterCoordinate(this.workingCenter);let e=this.worldGrid.findGridTile(this.workingCenter);if(e)return this.centerTile=e,e;console.log("Crew.getCrewCenterTile() failed to find tile: "+this.workingCenter.toString());for(let t=0;t<this.miners.length;t++){let i=this.miners[t].position.tile;if(i)return this.centerTile=i,this.centerTile}return null}}createMainMiner(){return this.main=new fi(new gi(this.characterSpritesheet),this.values,this.miners.length),this.initializeCharacter(this.main),this.miners.push(this.main),this.main}addNewMinerNearMain(e){if(!this.main.position.tile){console.log("Crew.addNewMinerNearMain() ERROR main miner does not have a tile.");return}let t=pi.findAvailableTileNearMainMiner(null,this),i=new fi(new gi(this.characterSpritesheet),this.values,this.miners.length);i.skillId=e,this.initializeCharacter(i),this.miners.push(i),i.position.setTileAndOriginPosition(t,t.origin.x,t.origin.y)}addNewMinerForSaveLoad(){let e=new fi(new gi(this.characterSpritesheet),this.values,this.miners.length);return this.initializeCharacter(e),this.miners.push(e),e}initializeCharacter(e){this.itemOverlaySpritesheet.loaded||console.log("Crew.initializeCharacter() itemOverlaySpritesheet not loaded yet");let t=this.itemOverlaySpritesheet.getSpriteAnimation(Le.pick.staticOverlay),i=this.itemOverlaySpritesheet.getSpriteAnimation(Le.pick.activeOverlay),s=this.itemOverlaySpritesheet.getSpriteAnimation(Le.thruster.activeOverlay);e.pick=new qs(Wl.pick,null,t,i),e.thruster=new Qs(s,this.gameTime)}onGridUnload(e){for(let t=0;t<this.miners.length;t++)this.miners[t].target.onGridUnload(e)}resetFull(){this.miners.length=0,this.main=null,this.centerTile=null}resetForPrestige(){for(let e=0;e<this.miners.length;e++){let t=this.miners[e];t.resetGameModel(),t.position.setWorldCoordinateOriginXY(n.start.startX,n.start.startY)}this.centerTile=null}};var tr=class extends K{constructor(){super(),this.basePickDamagePerTurn=new d(n.damage.baseDamagePerTurn),this.totalPickDamagePerTurn=new d(n.damage.baseDamagePerTurn),this.minedDamageMultiplier=new d(1),this.prestigeDamageMultiplier=new d(1),this.goldDamageMultiplier=new d(1),this.depthDamageMultiplier=new d(1),this.rubyDamageMultiplier=new d(1),this.blockDamageMultiplier=new d(1),this.totalPickDamagePerFrame=new d(1),this.totalPickDamagePerFrame.copy(this.totalPickDamagePerTurn),this.totalPickDamagePerFrame.divNumber(n.time.turnFrames),this.working=new d(0)}calculateMaxBrickHealth(e,t){let i=e*n.time.turnsPerSecond;t.copy(this.totalPickDamagePerTurn),t.mulNumber(i)}calculateMineSeconds(e){return this.working.copy(e),this.working.div(this.totalPickDamagePerTurn),this.working.mulNumber(n.time.secondsPerTurn),this.working.toNumber()}resetFull(){this.resetForPrestige(),this.minedDamageMultiplier.setValue(1),this.prestigeDamageMultiplier.setValue(1),this.goldDamageMultiplier.setValue(1),this.depthDamageMultiplier.setValue(1),this.rubyDamageMultiplier.setValue(1)}resetForPrestige(){this.basePickDamagePerTurn.setValue(n.damage.baseDamagePerTurn),this.totalPickDamagePerTurn.setValue(n.damage.baseDamagePerTurn),this.totalPickDamagePerFrame.setValue(1)}};var ei=class extends K{constructor(e,t,i){super(),this.gameTime=e,this.batchTurnSize=t*n.time.turnsPerSecond,this.penaltyFactor=new d(i),this.sum=new d(0),this.startTurn=e.turnNumber,this.valuePerTurn=new d(0),this.rates=[],this.rateIndex=0}add(e,t){this.sum.add(e);let i=this.gameTime.turnNumber-this.startTurn;i>this.batchTurnSize&&(this.sum.divNumber(i),this.addToRollingAverage(this.sum),this.calculateValuePerTurn(),this.startTurn=this.gameTime.turnNumber,this.sum.setZero()),t.copy(this.valuePerTurn)}addToRollingAverage(e){if(this.rates.length<10){let t=new d(0);t.copy(e),this.rates.push(t)}else this.rates[this.rateIndex].copy(e),this.rateIndex++,this.rateIndex>=this.rates.length&&(this.rateIndex=0)}calculateValuePerTurn(){if(this.valuePerTurn.setZero(),this.rates.length>0){for(let e=0;e<this.rates.length;e++)this.valuePerTurn.add(this.rates[e]);this.valuePerTurn.divNumber(this.rates.length),this.valuePerTurn.mul(this.penaltyFactor)}}resetFull(){this.sum.setZero(),this.startTurn=this.gameTime.turnNumber,this.rates.length=0,this.rateIndex=0,this.valuePerTurn.setZero()}resetForPrestige(){this.startTurn=this.gameTime.turnNumber}};var ir=class extends K{constructor(e){super(),this.oreRatePerTurnCalculator=new ei(e,20,.5),this.goldRatePerTurnCalculator=new ei(e,20,.5),this.prestigeRatePerTurnCalculator=new ei(e,20,.5),this.rubyRatePerTurnCalculator=new ei(e,20,.5),this.ore=new d(0),this.gold=new d(0),this.ruby=new d(0),this.prestige=new d(0),this.prestigePointsSum=new d(0),this.unclaimedPrestige=new d(0),this.working=new d(0),this.prestigePerTurn=new d(0),this.goldPerTurn=new d(0),this.orePerTurn=new d(0),this.rubyPerTurn=new d(0),this.offlinePrestige=new d(0),this.offlineGold=new d(0),this.offlineOre=new d(0),this.offlineRuby=new d(0),this.offlineSeconds=0,this.countedOfflineSeconds=0,this.one=new d(1)}incrementOre(e){this.ore.add(e),this.oreRatePerTurnCalculator.add(e,this.orePerTurn)}decrementOre(e){this.ore.sub(e),this.ore.lessThanZero()&&this.ore.setZero()}incrementGold(e){this.gold.add(e),this.goldRatePerTurnCalculator.add(e,this.goldPerTurn)}decrementGold(e){this.gold.sub(e),this.gold.lessThanZero()&&this.gold.setZero()}incrementRuby(e){this.ruby.add(e),this.rubyRatePerTurnCalculator.add(e,this.rubyPerTurn)}decrementPrestige(e){this.prestige.sub(e),this.prestige.lessThanZero()&&this.prestige.setZero()}onTerrainLayerUnlocked(){this.unclaimedPrestige.add(this.one)}incrementOfflinePrestige(e){this.offlinePrestige.add(e)}incrementOfflineGold(e){this.offlineGold.add(e)}incrementOfflineOre(e){this.offlineOre.add(e)}incrementOfflineRuby(e){this.offlineRuby.add(e)}claimOfflineEarnings(){this.countedOfflineSeconds=0,this.prestige.add(this.offlinePrestige),this.prestigePointsSum.add(this.offlinePrestige),this.offlinePrestige.setZero(),this.gold.add(this.offlineGold),this.offlineGold.setZero(),this.ore.add(this.offlineOre),this.offlineOre.setZero(),this.ruby.add(this.offlineRuby),this.offlineRuby.setZero()}onPrestige(){this.prestigeRatePerTurnCalculator.add(this.unclaimedPrestige,this.prestigePerTurn),this.prestige.add(this.unclaimedPrestige),this.prestigePointsSum.add(this.unclaimedPrestige),this.unclaimedPrestige.setZero()}resetFull(){this.prestige.setZero(),this.prestigePointsSum.setZero(),this.unclaimedPrestige.setZero(),this.gold.setZero(),this.ruby.setZero(),this.orePerTurn.setZero(),this.prestigePerTurn.setZero(),this.goldPerTurn.setZero(),this.rubyPerTurn.setZero(),this.offlinePrestige.setZero(),this.offlineGold.setZero(),this.offlineOre.setZero(),this.offlineRuby.setZero(),this.oreRatePerTurnCalculator.resetFull(),this.goldRatePerTurnCalculator.resetFull(),this.prestigeRatePerTurnCalculator.resetFull(),this.rubyRatePerTurnCalculator.resetFull(),this.resetForPrestige()}resetForPrestige(){this.ore.setZero(),this.oreRatePerTurnCalculator.resetForPrestige(),this.goldRatePerTurnCalculator.resetForPrestige(),this.prestigeRatePerTurnCalculator.resetForPrestige(),this.rubyRatePerTurnCalculator.resetForPrestige()}};var Ze={NORTH:0,NORTH_EAST:1,EAST:2,SOUTH_EAST:3,SOUTH:4,SOUTH_WEST:5,WEST:6,NORTH_WEST:7};var it={FINISHED_AND_AVAILABLE_FOR_CACHE:1,FINISHED_BUT_IN_USE:2,NOT_STARTED:3,STARTED_NOT_FINISHED:4};var rl={SPRITE_EFFECT:0,LIGHTNING_EFFECT:1,AREA_EFFECT:2};var sr=class extends Et{constructor(){super(),this.effectOwner=null,this.effectStatus=it.FINISHED_AND_AVAILABLE_FOR_CACHE,this.startTime=0}set(e){this.effectOwner=e,this.effectStatus=it.NOT_STARTED,this.startTime=Date.now()}getSpriteDirection(){return Ze.NORTH}getEffectType(){return rl.SPRITE_EFFECT}getEffectOwner(){return this.effectOwner}getSprite(){return null}getPosition(){return null}isEffectStarted(){return this.effectStatus===it.STARTED_NOT_FINISHED}isNotStarted(){return this.effectStatus===it.NOT_STARTED}isEffectFinished(){return this.effectStatus===it.FINISHED_AND_AVAILABLE_FOR_CACHE||this.effectStatus===it.FINISHED_BUT_IN_USE}markEffectAsFinishedButInUse(){this.effectStatus!==it.FINISHED_AND_AVAILABLE_FOR_CACHE&&(this.effectStatus=it.FINISHED_BUT_IN_USE)}updateEffectForFrame(e){this.isEffectFinished()||(this.effectStatus===it.NOT_STARTED&&(this.startTime=Date.now()),this.effectStatus=it.STARTED_NOT_FINISHED,this.updateEffectForFrameInternal(e))}updateEffectForFrameInternal(e){}getStartTime(){return this.startTime}getEffectStatus(){return this.effectStatus}refreshStartTime(e){this.startTime=e}isFinishedAndAvailable(){return this.effectStatus==it.FINISHED_AND_AVAILABLE_FOR_CACHE}reset(e){this.effectStatus==it.FINISHED_AND_AVAILABLE_FOR_CACHE!=e&&(e&&(this.spriteAnimation=null),this.effectStatus=e?it.FINISHED_AND_AVAILABLE_FOR_CACHE:it.NOT_STARTED,this.startTime=0,this.listener.onAvailabilityChanged(e))}};var rr=class{constructor(){}createEffect(e,t){return null}createEffectAtTile(e,t){return null}createEffectAtPosition(e,t){return null}getSpriteAnimation(){return null}};var Oe={BLACK_OPACITY:ce.createColor(336338048),RED_OPACITY:ce.createColor(3494267008),DARK_GRAY_OPACITY:ce.createColor(1313492864),DARK_RED_OPACITY:ce.createColor(1143223424),BLACK:ce.createColor(336338175),DARK_RED:ce.createColor(1143223551),DARK_BLUE:ce.createColor(808742399),DARK_GRAY:ce.createColor(1313492991),BROWN:ce.createColor(2236363007),DARK_GREEN:ce.createColor(879043839),RED:ce.createColor(3494267135),LIGHT_GRAY:ce.createColor(1970364927),LIGHT_BLUE:ce.createColor(1501417215),ORANGE:ce.createColor(3531418879),BLUE_GRAY:ce.createColor(2241176063),LIGHT_GREEN:ce.createColor(1839869183),PEACH:ce.createColor(3534395903),CYAN:ce.createColor(1841482495),YELLOW:ce.createColor(3671351039),WHITE:ce.createColor(3740194559)};var or=class extends ui{constructor(){super(),this.flickerColor=new ce(1,1,1,1)}getColor(){this.flickerColor.set(this.color);let e=-.05+.1*Math.random();return this.flickerColor.add(e,e,e,0),this.flickerColor}getTileRadius(){return this.radius+(Math.random()<.15?1:0)}};var Ti=class extends Nt{constructor(){super()}getGrowAmount(){return 5}getInitialSize(){return 5}createInstance(){return new ui}};var nr=class extends Ti{constructor(){super()}createInstance(){return new or}};var ye=class{constructor(e,t,i){this.color=e,this.radius=t,this.lightSourceCache=i}createLightSource(e){let t=this.lightSourceCache.get();return t.set(e,this.color,this.radius),t}};var ar=class extends K{constructor(){super();let e=n.lighting.lightSourceRadius;this.lightSourceCache=new Ti,this.flickeringLightSourceCache=new nr,this.lightGreenFlickering=new ye(Oe.LIGHT_GREEN,e,this.flickeringLightSourceCache),this.darkGreenFlickering=new ye(Oe.DARK_GREEN,e,this.flickeringLightSourceCache),this.cyanFlickering=new ye(Oe.CYAN,e,this.flickeringLightSourceCache),this.orangeFlickering=new ye(Oe.ORANGE,e,this.flickeringLightSourceCache),this.yellowFlickering=new ye(Oe.YELLOW,e,this.flickeringLightSourceCache),this.peachFlickering=new ye(Oe.PEACH,e,this.flickeringLightSourceCache),this.lightBlueFlickering=new ye(Oe.LIGHT_BLUE,e,this.flickeringLightSourceCache),this.darkBlueFlickering=new ye(Oe.DARK_BLUE,e,this.flickeringLightSourceCache),this.whiteFlickering=new ye(Oe.WHITE,e,this.flickeringLightSourceCache),this.redFlickering=new ye(Oe.RED,e,this.flickeringLightSourceCache),this.darkRedFlickering=new ye(Oe.DARK_RED,e,this.flickeringLightSourceCache),this.lightGrayFlickering=new ye(Oe.LIGHT_GRAY,e,this.flickeringLightSourceCache),this.lightGreen=new ye(Oe.LIGHT_GREEN,e,this.lightSourceCache),this.darkGreen=new ye(Oe.DARK_GREEN,e,this.lightSourceCache),this.cyan=new ye(Oe.CYAN,e,this.lightSourceCache),this.orange=new ye(Oe.ORANGE,e,this.lightSourceCache),this.yellow=new ye(Oe.YELLOW,e,this.lightSourceCache),this.peach=new ye(Oe.PEACH,e,this.lightSourceCache),this.lightBlue=new ye(Oe.LIGHT_BLUE,e,this.lightSourceCache),this.darkBlue=new ye(Oe.DARK_BLUE,e,this.lightSourceCache),this.white=new ye(Oe.WHITE,e,this.lightSourceCache),this.red=new ye(Oe.RED,e,this.lightSourceCache),this.darkRed=new ye(Oe.DARK_RED,e,this.lightSourceCache),this.lightGray=new ye(Oe.LIGHT_GRAY,e,this.lightSourceCache)}resetFull(){this.lightSourceCache.resetCache(),this.flickeringLightSourceCache.resetCache()}resetForPrestige(){this.resetFull()}};var xe=class{constructor(e,t){this.volume=e,this.soundPaths=t}getVolume(){return this.volume}getSoundPaths(){return this.soundPaths}getRandomSoundPath(){return!this.soundPaths||this.soundPaths.length==0?null:this.soundPaths.length==1?this.soundPaths[0]:this.soundPaths[ze.randomInt(this.soundPaths.length)]}};var Y={buttonClick:new xe(1,"sound/effects/ui/Snd_click.mp3"),coins:new xe(.5,"sound/effects/coins/handleCoins.mp3","sound/effects/coins/handleCoins2.mp3"),tab:new xe(1,"sound/effects/ui/metalLatch.mp3"),minionDeath:new xe(1,"sound/effects/deathMinion/bite-small.mp3"),travelEffect:new xe(1,"sound/effects/travelEffect/dropLeather.mp3"),deathBell:new xe(1,"sound/effects/deathBell/churchbell.mp3"),deathScream:new xe(1,"sound/effects/deathScream/death_01.mp3","sound/effects/deathScream/death_02.mp3","sound/effects/deathScream/death_04.mp3","sound/effects/deathScream/death_05.mp3","sound/effects/deathScream/death_06.mp3","sound/effects/deathScream/death_07.mp3"),resurrection:new xe(1,"sound/effects/resurrection/JRPG_characterRevived.mp3"),questCompletion:new xe(1,"sound/effects/questCompleted/Jingle_Achievement_00_128.mp3"),collectibleFound:new xe(1,"sound/effects/collectibleFound/teleport_02.mp3"),achievement:new xe(1,"sound/effects/achievement/cursespell.mp3"),partyRankEarned:new xe(1,"sound/effects/partyRank/retro_beep_04.mp3"),spellBlastEffect:new xe(1,"sound/effects/spellBlastArea/sfx_exp_cluster2.mp3","sound/effects/spellBlastArea/sfx_exp_short_hard2.mp3","sound/effects/spellBlastArea/sfx_exp_short_hard3.mp3","sound/effects/spellBlastArea/sfx_exp_short_hard6.mp3","sound/effects/spellBlastArea/sfx_exp_short_hard10.mp3","sound/effects/spellBlastArea/sfx_exp_short_hard12.mp3","sound/effects/spellBlastArea/sfx_exp_short_hard13.mp3","sound/effects/spellBlastArea/missile_explosion.mp3"),damage:new xe(1,"sound/effects/damage/sfx_exp_shortest_hard6.mp3","sound/effects/damage/sfx_exp_shortest_soft1.mp3","sound/effects/damage/sfx_exp_shortest_soft2.mp3","sound/effects/damage/sfx_exp_shortest_soft6.mp3","sound/effects/damage/sfx_exp_shortest_soft7.mp3","sound/effects/damage/sfx_exp_shortest_soft8.mp3","sound/effects/damage/sfx_exp_shortest_soft9.mp3"),doorOpenEffect:new xe(1,"sound/effects/doorOpen/sfx_movement_dooropen1.mp3","sound/effects/doorOpen/doorOpen_1.mp3","sound/effects/doorOpen/doorOpen_2.mp3"),barrelOpen:new xe(1,"sound/effects/open/boots-leather-step-01.mp3"),itemDrop:new xe(1,"sound/effects/itemDrop/water-drop-02.mp3"),potBroken:new xe(1,"sound/effects/breakPot/wood-bowl-spoon-04.mp3"),sackLooted:new xe(1,"sound/effects/sackLooted/knife-sheathe-01.mp3"),chestOpen:new xe(1,"sound/effects/chestOpen/match-light-01.mp3","sound/effects/chestOpen/quiver-leather-squeeze-01.mp3"),fixtureBreak:new xe(1,"sound/effects/fixtureBreak/item_wood_02.mp3","sound/effects/fixtureBreak/misc_03.mp3","sound/effects/fixtureBreak/wood_01.mp3","sound/effects/fixtureBreak/wood_04.mp3"),rareWeaponFound:new xe(1,"sound/effects/foundRare/levelup.mp3")};var F={DAMAGE_EFFECT_NAME_RED_SPLAT:"Red Splat",DAMAGE_EFFECT_NAME_RED_DAMAGE:"Red Damage",DAMAGE_EFFECT_NAME_WHITE_DAMAGE:"White Damage",DAMAGE_EFFECT_NAME_BLUE_DAMAGE:"Blue Damage",DAMAGE_EFFECT_NAME_GREEN_DAMAGE:"Green Damage",DAMAGE_EFFECT_NAME_SHOCK_DAMAGE:"Electric Damage",DAMAGE_EFFECT_NAME_FIRE_DAMAGE:"Fire Damage",DAMAGE_EFFECT_NAME_POISON_DAMAGE:"Poison Damage",DAMAGE_EFFECT_NAME_SONIC_DAMAGE:"Sonic Damage",DAMAGE_EFFECT_NAME_PINK_DAMAGE:"Pink Damage",MISSILE_EFFECT_NAME_ARROW:"Red Arrow",MISSILE_EFFECT_NAME_FAT_ARROW:"Fat Red Arrow",MISSILE_EFFECT_NAME_GREEN_ARROW:"Green Arrow",MISSILE_EFFECT_NAME_PINK_ARROW:"Pink Arrow",MISSILE_EFFECT_NAME_ARROW_WALL:"Wall Arrow",MISSILE_EFFECT_NAME_SPEAR:"Spear",MISSILE_EFFECT_NAME_PINK_LIGHTNING:"Pink Lightning",MISSILE_EFFECT_NAME_GREEN_PROJECTILE:"Green Projectile",MISSILE_EFFECT_NAME_SMALL_GREEN_PROJECTILE:"Small Green Projectiles",MISSILE_EFFECT_NAME_FIRE_PROJECTILE:"Fire Projectile",MISSILE_EFFECT_NAME_FIRE_ARROW:"Fire Arrow",MISSILE_EFFECT_NAME_ICE_PROJECTILE:"Ice Projectile",MISSILE_EFFECT_NAME_ICE_ARROW:"Ice Arrow",MISSILE_EFFECT_NAME_LIGHTNING:"Lightning",MISSILE_EFFECT_NAME_LIGHTNING_ARROW:"Lightning Arrow",MISSILE_EFFECT_NAME_GREY_BULLET:"Grey Bullet",MISSILE_EFFECT_NAME_YELLOW_BULLET:"Yellow Bullet",MISSILE_EFFECT_NAME_NINJA_STAR:"Ninja Star",MISSILE_EFFECT_NAME_WEB:"Web",MISSILE_EFFECT_NAME_PINK_STAR_PROJECTILE:"Pink Star Projectile",MISSILE_EFFECT_NAME_PINK_BALL_PROJECTILE:"Pink Ball Projectile",MISSILE_EFFECT_NAME_YELLOW_STAR_PROJECTILE:"Yellow Star Projectile",EFFECT_NAME_SPARKLE_GOLD:"Gold Sparkles",EFFECT_NAME_SPARKLE_GREEN:"Green Sparkles",EFFECT_NAME_SPARKLE_BLUE:"Blue Sparkles",EFFECT_NAME_SPARKLE_ORANGE:"Orange Sparkles",EFFECT_NAME_SPARKLE_PINK:"Pink Sparkles",EFFECT_NAME_SPARKLE_RED:"Red Sparkles",EFFECT_NAME_GREEN_SKULL:"Green Skull",EFFECT_NAME_YELLOW_KEY:"Yellow Key",EFFECT_NAME_SKULL_CROSS:"Skull Cross",EFFECT_NAME_SHIELDS:"Shields",EFFECT_NAME_RED_CROSSES:"Red Crosses",EFFECT_NAME_FIRE_RING:"Fire Ring",EFFECT_NAME_ICE_RING:"Ice Ring",EFFECT_NAME_GREEN_RING:"Green Ring",EFFECT_NAME_PINK_RING:"Pink Ring",EFFECT_NAME_YELLOW_STAR:"Yellow Star",EFFECT_NAME_BLUE_STAR:"Blue Star",EFFECT_NAME_GREEN_STAR:"Green Star",EFFECT_NAME_WEB:"Spider Web",EFFECT_NAME_WHITE_CROSSES:"White Crosses",EFFECT_NAME_TORCH:"Torch",EFFECT_NAME_FROST:"Frost",EFFECT_NAME_YELLOW_STAR_CIRCLE:"Yellow Star Circle",EFFECT_NAME_CIRCLES:"Circles",EFFECT_NAME_GOLD_SHIELD_SPIRAL:"Gold Shield Spiral",EFFECT_NAME_GREEN_SHIELD_SPIRAL:"Green Shield Spiral",EFFECT_NAME_BLUE_SHIELD_SPIRAL:"Blue Shield Spiral",EFFECT_NAME_PINK_SHIELD_SPIRAL:"Pink Shield Spiral",EFFECT_NAME_BLUE_FIREWORK:"Blue Firework",EFFECT_NAME_RED_FIREWORK:"Red Firework",EFFECT_NAME_BUBBLES:"Bubbles",EFFECT_NAME_SHIELD:"Shield",EFFECT_NAME_COLOR_SPIRAL:"Color Spiral",EFFECT_NAME_ARM_FLEX:"Arm Flex",EFFECT_NAME_SUPER_SPEED:"Super Speed",EFFECT_NAME_TARGET:"Target",EFFECT_NAME_YELLOW_SHIELD_SPIRAL:"Yellow Shield Spiral",EFFECT_NAME_PINK_STAR_CIRCLE:"Pink Star Circle",EFFECT_NAME_BLUE_STAR_CIRCLE:"Blue Star Circle",EFFECT_NAME_GREEN_STAR_CIRCLE:"Green Star Circle",EFFECT_NAME_GOLD_STAR_CIRCLE:"Gold Star Circle",EFFECT_NAME_BREAD:"Bread",EFFECT_NAME_YELLOW_FIRE_RING:"Yellow Fire Ring",EFFECT_NAME_TOTEMS:"Totems",EFFECT_NAME_EYE_BLINK:"Eye Blink",EFFECT_NAME_PINK_STAR:"Pink Star",EFFECT_NAME_ORANGE_STAR:"Orange Star",EFFECT_NAME_RED_EYE_BLINK:"Red Eye Blink",EFFECT_NAME_EAGLE:"Eagle",EFFECT_NAME_SLEEP:"Sleep",EFFECT_NAME_ARMOR:"Armor",EFFECT_NAME_BLIND_EYE_BLINK:"Blind Eye Blink",EFFECT_NAME_FIRE_RAIN:"Fire Rain",EFFECT_NAME_BLUE_RAIN:"Blue Rain",EFFECT_NAME_GREEN_RAIN:"Green Rain",EFFECT_NAME_LIGHTNING_RAIN:"Lightning Rain",EFFECT_NAME_PINK_RAIN:"Pink Rain",EFFECT_NAME_RAINBOW_RAIN:"Rainbow Rain"};var lr=class extends sr{constructor(){super(),this.spriteAnimation=null}set(e,t){super.set(e),this.spriteAnimation=t}getEffectType(){return rl.SPRITE_EFFECT}getSprite(){return this.spriteAnimation.getSpriteAsOf(Date.now(),this.startTime)}};var dr=class extends lr{constructor(){super(),this.effectPosition=new v(0,0)}set(e,t,i){super.set(e,t),this.effectPosition.copy(i)}updateEffectForFrameInternal(e){this.spriteAnimation.isAnimationLoopCompleted(this.getStartTime())&&!this.isFinishedAndAvailable()&&this.markEffectAsFinishedButInUse()}getPosition(){return this.effectPosition}};var hr=class extends Nt{constructor(){super(),this.initialCacheSize=20,this.growAmount=10}getGrowAmount(){return this.growAmount}getInitialSize(){return this.initialCacheSize}};var ur=class extends hr{constructor(){super()}createInstance(){return new dr}};var H=class extends rr{constructor(e,t,i,s,r){super(),this.spellFxSpritesheet=e,this.spriteName=t,this.spriteAnimation=null,this.soundEffect=i,this.lightSourceCreator=s,this.basicSpriteEffectCache=r}createEffect(e,t){!this.spriteAnimation&&this.spellFxSpritesheet&&(this.spriteAnimation=this.spellFxSpritesheet.getSpriteAnimation(this.spriteName));let i=this.basicSpriteEffectCache.get();return i.set(e,this.spriteAnimation,t),i}createEffectAtTile(e,t){!this.spriteAnimation&&this.spellFxSpritesheet&&(this.spriteAnimation=this.spellFxSpritesheet.getSpriteAnimation(this.spriteName));let i=this.basicSpriteEffectCache.get();return i.set(e,this.spriteAnimation,t.origin),i}createEffectAtPosition(e,t){!this.spriteAnimation&&this.spellFxSpritesheet&&(this.spriteAnimation=this.spellFxSpritesheet.getSpriteAnimation(this.spriteName));let i=this.basicSpriteEffectCache.get();return i.set(e,this.spriteAnimation,t),i}getSpriteAnimation(){return this.spriteAnimation}};var cr=class extends K{constructor(e,t){super(),this.basicSpriteEffectCache=new ur,this.effectGreenSkull=new H(t,F.EFFECT_NAME_GREEN_SKULL,Y.damage,e.darkGreenFlickering,this.basicSpriteEffectCache),this.damageEffectBloodSplatter=new H(t,F.DAMAGE_EFFECT_NAME_RED_SPLAT,Y.damage,null,this.basicSpriteEffectCache),this.damageEffectRedDamage=new H(t,F.DAMAGE_EFFECT_NAME_RED_DAMAGE,Y.damage,e.red,this.basicSpriteEffectCache),this.damageEffectWhiteDamage=new H(t,F.DAMAGE_EFFECT_NAME_WHITE_DAMAGE,Y.damage,e.white,this.basicSpriteEffectCache),this.damageEffectBlueDamage=new H(t,F.DAMAGE_EFFECT_NAME_BLUE_DAMAGE,Y.damage,e.darkBlue,this.basicSpriteEffectCache),this.damageEffectGreenDamage=new H(t,F.DAMAGE_EFFECT_NAME_GREEN_DAMAGE,Y.damage,e.lightGreen,this.basicSpriteEffectCache),this.damageEffectShockDamage=new H(t,F.DAMAGE_EFFECT_NAME_SHOCK_DAMAGE,Y.damage,e.lightBlueFlickering,this.basicSpriteEffectCache),this.damageEffectFireDamage=new H(t,F.DAMAGE_EFFECT_NAME_FIRE_DAMAGE,Y.damage,e.orange,this.basicSpriteEffectCache),this.damageEffectPoisonDamage=new H(t,F.DAMAGE_EFFECT_NAME_POISON_DAMAGE,Y.damage,e.darkGreen,this.basicSpriteEffectCache),this.damageEffectSonicDamage=new H(t,F.DAMAGE_EFFECT_NAME_SONIC_DAMAGE,Y.damage,e.peach,this.basicSpriteEffectCache),this.damageEffectPinkDamage=new H(t,F.DAMAGE_EFFECT_NAME_PINK_DAMAGE,Y.damage,null,this.basicSpriteEffectCache),this.effectSparkleGold=new H(t,F.EFFECT_NAME_SPARKLE_GOLD,Y.damage,e.yellowFlickering,this.basicSpriteEffectCache),this.effectSparkleGreen=new H(t,F.EFFECT_NAME_SPARKLE_GREEN,Y.damage,e.darkGreenFlickering,this.basicSpriteEffectCache),this.effectSparkleBlue=new H(t,F.EFFECT_NAME_SPARKLE_BLUE,Y.damage,e.lightBlueFlickering,this.basicSpriteEffectCache),this.effectSparklePink=new H(t,F.EFFECT_NAME_SPARKLE_PINK,Y.damage,e.peachFlickering,this.basicSpriteEffectCache),this.effectSparkleOrange=new H(t,F.EFFECT_NAME_SPARKLE_ORANGE,Y.damage,e.redFlickering,this.basicSpriteEffectCache),this.effectSparkleRed=new H(t,F.EFFECT_NAME_SPARKLE_RED,Y.damage,null,this.basicSpriteEffectCache),this.effectGreenSkull=new H(t,F.EFFECT_NAME_GREEN_SKULL,Y.damage,e.darkGreenFlickering,this.basicSpriteEffectCache),this.effectYellowKey=new H(t,F.EFFECT_NAME_YELLOW_KEY,Y.damage,e.peachFlickering,this.basicSpriteEffectCache),this.effectSkullCross=new H(t,F.EFFECT_NAME_SKULL_CROSS,Y.damage,e.darkRed,this.basicSpriteEffectCache),this.effectShields=new H(t,F.EFFECT_NAME_SHIELDS,Y.damage,e.darkBlue,this.basicSpriteEffectCache),this.effectRedCrosses=new H(t,F.EFFECT_NAME_RED_CROSSES,Y.damage,e.yellow,this.basicSpriteEffectCache),this.effectFireRing=new H(t,F.EFFECT_NAME_FIRE_RING,Y.damage,e.orange,this.basicSpriteEffectCache),this.effectIceRing=new H(t,F.EFFECT_NAME_ICE_RING,Y.damage,e.lightBlue,this.basicSpriteEffectCache),this.effectGreenRing=new H(t,F.EFFECT_NAME_GREEN_RING,Y.damage,e.lightGreen,this.basicSpriteEffectCache),this.effectPinkRing=new H(t,F.EFFECT_NAME_PINK_RING,Y.damage,e.peach,this.basicSpriteEffectCache),this.effectYellowStar=new H(t,F.EFFECT_NAME_YELLOW_STAR,Y.damage,null,this.basicSpriteEffectCache),this.effectBlueStar=new H(t,F.EFFECT_NAME_BLUE_STAR,Y.damage,e.lightBlueFlickering,this.basicSpriteEffectCache),this.effectGreenStar=new H(t,F.EFFECT_NAME_GREEN_STAR,Y.damage,e.lightGreenFlickering,this.basicSpriteEffectCache),this.effectWhiteCrosses=new H(t,F.EFFECT_NAME_WHITE_CROSSES,Y.damage,e.cyan,this.basicSpriteEffectCache),this.effectWeb=new H(t,F.EFFECT_NAME_WEB,Y.damage,null,this.basicSpriteEffectCache),this.effectTorch=new H(t,F.EFFECT_NAME_TORCH,Y.damage,e.orange,this.basicSpriteEffectCache),this.effectFrost=new H(t,F.EFFECT_NAME_FROST,Y.damage,e.white,this.basicSpriteEffectCache),this.effectYellowStarCircle=new H(t,F.EFFECT_NAME_YELLOW_STAR_CIRCLE,Y.damage,null,this.basicSpriteEffectCache),this.effectCircles=new H(t,F.EFFECT_NAME_CIRCLES,Y.damage,e.peach,this.basicSpriteEffectCache),this.effectGoldShieldSpiral=new H(t,F.EFFECT_NAME_GOLD_SHIELD_SPIRAL,Y.damage,e.yellow,this.basicSpriteEffectCache),this.effectGreenShieldSpiral=new H(t,F.EFFECT_NAME_GREEN_SHIELD_SPIRAL,Y.damage,e.lightGreen,this.basicSpriteEffectCache),this.effectBlueShieldSpiral=new H(t,F.EFFECT_NAME_BLUE_SHIELD_SPIRAL,null,e.lightBlue,this.basicSpriteEffectCache),this.effectPinkShieldSpiral=new H(t,F.EFFECT_NAME_PINK_SHIELD_SPIRAL,Y.damage,e.peach,this.basicSpriteEffectCache),this.effectBlueFirework=new H(t,F.EFFECT_NAME_BLUE_FIREWORK,Y.damage,e.lightBlue,this.basicSpriteEffectCache),this.effectRedFirework=new H(t,F.EFFECT_NAME_RED_FIREWORK,Y.damage,e.red,this.basicSpriteEffectCache),this.effectStun=new H(t,F.EFFECT_NAME_BUBBLES,Y.damage,e.peachFlickering,this.basicSpriteEffectCache),this.effectShield=new H(t,F.EFFECT_NAME_SHIELD,Y.damage,e.lightGray,this.basicSpriteEffectCache),this.colorSpiralEffect=new H(t,F.EFFECT_NAME_COLOR_SPIRAL,Y.damage,e.white,this.basicSpriteEffectCache),this.effectArmFlex=new H(t,F.EFFECT_NAME_ARM_FLEX,Y.damage,e.lightBlue,this.basicSpriteEffectCache),this.effectSuperSpeed=new H(t,F.EFFECT_NAME_SUPER_SPEED,Y.damage,e.yellow,this.basicSpriteEffectCache),this.effectTarget=new H(t,F.EFFECT_NAME_TARGET,Y.damage,e.red,this.basicSpriteEffectCache),this.effectYellowShieldSpiral=new H(t,F.EFFECT_NAME_YELLOW_SHIELD_SPIRAL,Y.damage,e.yellow,this.basicSpriteEffectCache),this.effectPinkStarCircle=new H(t,F.EFFECT_NAME_PINK_STAR_CIRCLE,Y.damage,e.peach,this.basicSpriteEffectCache),this.effectBlueStarCircle=new H(t,F.EFFECT_NAME_BLUE_STAR_CIRCLE,Y.damage,e.lightBlue,this.basicSpriteEffectCache),this.effectGreenStarCircle=new H(t,F.EFFECT_NAME_GREEN_STAR_CIRCLE,Y.damage,e.lightGreen,this.basicSpriteEffectCache),this.effectGoldStarCircle=new H(t,F.EFFECT_NAME_GOLD_STAR_CIRCLE,Y.damage,e.yellow,this.basicSpriteEffectCache),this.effectBread=new H(t,F.EFFECT_NAME_BREAD,Y.damage,e.peach,this.basicSpriteEffectCache),this.effectYellowFireFing=new H(t,F.EFFECT_NAME_YELLOW_FIRE_RING,Y.damage,e.yellow,this.basicSpriteEffectCache),this.effectTotems=new H(t,F.EFFECT_NAME_TOTEMS,Y.damage,e.peach,this.basicSpriteEffectCache),this.effectEyeBlink=new H(t,F.EFFECT_NAME_EYE_BLINK,Y.damage,e.orange,this.basicSpriteEffectCache),this.effectPinkStar=new H(t,F.EFFECT_NAME_PINK_STAR,Y.damage,e.peachFlickering,this.basicSpriteEffectCache),this.effectOrangeStar=new H(t,F.EFFECT_NAME_ORANGE_STAR,Y.damage,e.yellowFlickering,this.basicSpriteEffectCache),this.effectRedEyeBlink=new H(t,F.EFFECT_NAME_RED_EYE_BLINK,Y.damage,e.red,this.basicSpriteEffectCache),this.effectEagle=new H(t,F.EFFECT_NAME_EAGLE,Y.damage,e.lightBlue,this.basicSpriteEffectCache),this.effectSleep=new H(t,F.EFFECT_NAME_SLEEP,null,e.orange,this.basicSpriteEffectCache),this.effectArmor=new H(t,F.EFFECT_NAME_ARMOR,Y.damage,e.red,this.basicSpriteEffectCache),this.effectBlindEyeBlink=new H(t,F.EFFECT_NAME_BLIND_EYE_BLINK,Y.damage,e.lightBlue,this.basicSpriteEffectCache),this.effectFireRain=new H(t,F.EFFECT_NAME_FIRE_RAIN,Y.damage,e.yellowFlickering,this.basicSpriteEffectCache),this.effectBlueRain=new H(t,F.EFFECT_NAME_BLUE_RAIN,Y.damage,e.lightBlueFlickering,this.basicSpriteEffectCache),this.effectGreenRain=new H(t,F.EFFECT_NAME_GREEN_RAIN,Y.damage,e.lightGreenFlickering,this.basicSpriteEffectCache),this.effectLightningRain=new H(t,F.EFFECT_NAME_LIGHTNING_RAIN,Y.damage,e.yellowFlickering,this.basicSpriteEffectCache),this.effectPinkRain=new H(t,F.EFFECT_NAME_PINK_RAIN,Y.damage,e.peachFlickering,this.basicSpriteEffectCache),this.effectRainbowRain=new H(t,F.EFFECT_NAME_RAINBOW_RAIN,Y.damage,e.yellowFlickering,this.basicSpriteEffectCache)}resetFull(){this.basicSpriteEffectCache.resetCache()}resetForPrestige(){this.resetFull()}};var mr=class extends K{constructor(e){super(),this.projection=e,this.spriteEffects=[]}resetEffectList(e){if(e.length>0){for(let t=0;t<e.length;t++)e[t].reset(!0);e.length=0}}updateEffectsForFrame(e){this.updateEffectListForFrame(this.spriteEffects,e,!0)}updateEffectListForFrame(e,t,i){let s=!1;for(let r=e.length-1;r>=0;r--){let o=e[r];if(!o||o.isFinishedAndAvailable()){e.splice(r,1),s=!0;continue}o.updateEffectForFrame(t),o.isEffectFinished()&&(i&&!o.isFinishedAndAvailable()&&o.reset(!0),e.splice(r,1),s=!0)}return s}addEffect(e){this.addEffectWithSoundFlag(e,!0)}addEffectWithSoundFlag(e,t){if(!e||e.isFinishedAndAvailable())return;this.spriteEffects.push(e)}resetEffectManager(){this.resetEffectList(this.spriteEffects)}resetFull(){this.resetEffectManager()}resetForPrestige(){this.resetEffectManager()}};var pr=class extends Et{constructor(){super(),this.text="",this.textX=0,this.textY=0,this.frameCount=0,this.incrementX=0,this.incrementY=0,this.frameToggle=!1}set(e){this.text=e,this.incrementX=this.calculateTextMotion(),this.incrementY=1+(Math.random()>.5?1:0),this.frameToggle=!0,this.frameCount=0}calculateTextMotion(){let e=1+(Math.random()>.5?1:0);return Math.random()<.5?-e:e}isTextFinished(){return this.frameCount>=n.text.textFrameDuration}updateTextForFrame(e){return this.frameToggle&&(Math.random()<.5&&(this.textX+=this.incrementX),this.textY-=this.incrementY),this.frameToggle=!this.frameToggle,this.frameCount+=e,this.textY<=0||this.isTextFinished()}};var gr=class extends Nt{constructor(){super()}getGrowAmount(){return 10}getInitialSize(){return 10}createInstance(){return new pr}};var fr=class extends K{constructor(e){super(),this.projection=e,this.infoTextCache=new gr,this.infoTextArray=[],this.workingVector=new v}addOreText(e,t){if(!this.projection.isVisibleGridBox(e))return;let i=I.formatBigNum(t);this.addCurrencyInternal(e,i)}addGoldText(e,t){if(!this.projection.isVisibleGridBox(e))return;let i=I.formatBigNum(t)+" Gold!";this.addCurrencyInternal(e,i)}addRubyText(e,t){if(!this.projection.isVisibleGridBox(e))return;let i=I.formatBigNum(t)+" Ruby!";this.addCurrencyInternal(e,i)}addCurrencyInternal(e,t){if(!this.projection.isVisibleGridBox(e))return;for(;this.infoTextArray.length>=n.text.maxInfoTextCount;)this.infoTextArray[0].reset(!0),this.infoTextArray.splice(0,1);let i=this.infoTextCache.get();i.set(t),this.setTextPosition(i,e.origin),this.infoTextArray.push(i)}setTextPosition(e,t){this.projection.worldToScreen(t,this.workingVector),e.textX=this.workingVector.x+n.tile.halfSize,e.textY=this.workingVector.y}updateTextForFrame(e){for(let t=this.infoTextArray.length-1;t>=0;t--){let i=this.infoTextArray[t];i.updateTextForFrame(e)&&(i.reset(!0),this.infoTextArray.splice(t,1))}}clearInfoText(){this.infoTextArray.length>0&&(this.resetInfoTextList(this.infoTextArray),this.infoTextArray.length=0)}resetInfoTextList(e){for(let t=0;t<e.length;t++)e[t].reset(!0)}resetFull(){this.infoTextArray.length=0,this.infoTextCache.resetCache()}resetForPrestige(){this.resetFull()}};var Ei=class extends K{constructor(){super(),this.totalOre=new d(0),this.totalGold=new d(0),this.totalRuby=new d(0),this.totalPrestigePoints=new d(0),this.maxDepth=0,this.upgradeOre=new d(0),this.totalTurns=0,this.tilesMined=new d(0),this.tilesMinedCommon=new d(0),this.tilesMinedOre=new d(0),this.tilesMinedGold=new d(0),this.tilesMinedRuby=new d(0),this.tilesMinedUpgrade=new d(0),this.tilesMinedLaser=new d(0),this.tilesMinedDrill=new d(0),this.tilesMinedOrbit=new d(0),this.tilesMinedFissure=new d(0),this.tilesMinedLightning=new d(0),this.tilesMinedMissile=new d(0),this.one=new d(1)}tileDepth(e){e>this.maxDepth&&(this.maxDepth=e)}onTileMined(e){switch(this.tilesMined.add(this.one),e.tileType.rarityModifier){case _.COMMON:this.tilesMinedCommon.add(this.one);break;case _.ORE:this.tilesMinedOre.add(this.one);break;case _.GOLD:this.tilesMinedGold.add(this.one);break;case _.RUBY:this.tilesMinedRuby.add(this.one);break;case _.UPGRADE:this.tilesMinedUpgrade.add(this.one);break}}incrementTurns(e){this.totalTurns+=e}incrementOre(e){this.totalOre.add(e)}incrementUpgradeOre(e){this.upgradeOre.add(e)}incrementGold(e){this.totalGold.add(e)}incrementRuby(e){this.totalRuby.add(e)}incrementPrestigePoints(e){this.totalPrestigePoints.add(e)}incrementMinedByLaser(){this.tilesMinedLaser.add(this.one)}incrementMinedByDrill(){this.tilesMinedDrill.add(this.one)}incrementMinedByOrbit(){this.tilesMinedOrbit.add(this.one)}incrementMinedByFissure(){this.tilesMinedFissure.add(this.one)}incrementMinedByLightning(){this.tilesMinedLightning.add(this.one)}incrementMinedByMissile(){this.tilesMinedMissile.add(this.one)}resetFull(){this.totalOre.setZero(),this.totalGold.setZero(),this.totalRuby.setZero(),this.totalPrestigePoints.setZero(),this.upgradeOre.setZero(),this.maxDepth=0,this.totalTurns=0,this.tilesMined.setZero(),this.tilesMinedCommon.setZero(),this.tilesMinedOre.setZero(),this.tilesMinedGold.setZero(),this.tilesMinedRuby.setZero(),this.tilesMinedUpgrade.setZero(),this.tilesMinedLaser.setZero(),this.tilesMinedDrill.setZero(),this.tilesMinedOrbit.setZero(),this.tilesMinedFissure.setZero(),this.tilesMinedLightning.setZero(),this.tilesMinedMissile.setZero()}resetForPrestige(){this.resetFull()}};var Tr=class{constructor(e,t){this.globalStatitics=e,this.runStatistics=t}incrementTurns(e){this.globalStatitics.incrementTurns(e),this.runStatistics.incrementTurns(e)}tileDepth(e){this.globalStatitics.tileDepth(e),this.runStatistics.tileDepth(e)}onTileMined(e){this.globalStatitics.onTileMined(e),this.runStatistics.onTileMined(e)}incrementOre(e){this.globalStatitics.incrementOre(e),this.runStatistics.incrementOre(e)}incrementUpgradeOre(e){this.globalStatitics.incrementUpgradeOre(e),this.runStatistics.incrementUpgradeOre(e)}incrementGold(e){this.globalStatitics.incrementGold(e),this.runStatistics.incrementGold(e)}incrementRuby(e){this.globalStatitics.incrementRuby(e),this.runStatistics.incrementRuby(e)}incrementPrestigePoints(e){this.globalStatitics.incrementPrestigePoints(e),this.runStatistics.incrementPrestigePoints(e)}incrementMinedByLaser(){this.globalStatitics.incrementMinedByLaser(),this.runStatistics.incrementMinedByLaser()}incrementMinedByDrill(){this.globalStatitics.incrementMinedByDrill(),this.runStatistics.incrementMinedByDrill()}incrementMinedByOrbit(){this.globalStatitics.incrementMinedByOrbit(),this.runStatistics.incrementMinedByOrbit()}incrementMinedByFissure(){this.globalStatitics.incrementMinedByFissure(),this.runStatistics.incrementMinedByFissure()}incrementMinedByLightning(){this.globalStatitics.incrementMinedByLightning(),this.runStatistics.incrementMinedByLightning()}incrementMinedByMissile(){this.globalStatitics.incrementMinedByMissile(),this.runStatistics.incrementMinedByMissile()}};var Ci=class{constructor(e,t){this.title=e,this.iconFileName=t,this.purchasedCount=0}getDescription(){return null}isPurchasable(){return this.isAffordable()}isAffordable(){return!1}getCost(){return null}getCostUnit(){return null}getPurchasedCount(){return this.purchasedCount}setPurchasedCount(e){this.purchasedCount=e}setPurchasedCountFromSave(e){this.setPurchasedCount(e)}purchase(){return!1}resetUpgrade(){this.purchasedCount=0}};var wi=class extends K{constructor(){super(),this.upgrades=[],this.changeCount=0}add(e){if(!e){console.log("UpgradeCollection.add() null upgrade");return}this.upgrades.push(e),this.changeCount++}addBulk(e){if(!e){console.log("UpgradeCollection.addBulk() null upgrade");return}this.upgrades.push(e)}addBulkCompleted(){this.changeCount++}remove(e){if(!e){console.log("UpgradeCollection.remove() upgrade null");return}let t=this.upgrades.indexOf(e);if(t===-1){console.log("UpgradeCollection.remove() did not find upgrade in list");return}this.upgrades.splice(t,1),this.changeCount++}resetFull(){this.upgrades.length=0,this.changeCount=0}resetForPrestige(){this.resetFull()}};var Er=class{constructor(e,t,i,s){this.values=e,this.totals=t,this.damage=i,this.globalStatistics=s,this.workingMineDamage=new d(0),this.minedDamageBonus=new d(0),this.prestigeBonus=new d(0),this.prestigeMultiplier=new d(n.prestige.multiplierPerPrestige),this.rubyMultiplier=new d(n.ruby.multiplierPerRuby),this.rubyBonus=new d(0),this.blockMultiplier=new d(n.blocks.multiplierPerBlock),this.blockBonus=new d(0),this.workingDepthDamageMultiplier=new d(0),this.workingMultiBonus=new d(0),this.workingPrestige=new d(0),this.oneBigNum=new d(1),this.perFrameConversionFactor=new d(1/n.time.turnFrames)}calculateTotalMineDamagePerTurn(){this.workingMineDamage.copy(this.damage.basePickDamagePerTurn),this.workingMineDamage.add(this.values.baseAdditiveBonusPerTurn.getValue()),this.workingMultiBonus.copy(this.oneBigNum),this.workingMultiBonus.add(this.values.baseMultiplicativeBonusValue.getValue()),this.minedDamageBonus.copy(this.oneBigNum),this.minedDamageBonus.add(this.values.minedDamageBonusMultiplier.getValue()),this.damage.minedDamageMultiplier.copy(this.minedDamageBonus),this.prestigeMultiplier.setValue(n.prestige.multiplierPerPrestige+this.values.skillPrestigeBonusMultiplier.getValue()),this.prestigeBonus.copy(this.totals.prestigePointsSum),this.prestigeBonus.mul(this.prestigeMultiplier),this.prestigeBonus.add(this.oneBigNum),this.damage.prestigeDamageMultiplier.copy(this.prestigeBonus),this.totals.ruby.greaterThanZero()?(this.rubyMultiplier.setValue(n.ruby.multiplierPerRuby+this.values.skillRubyBonusMultiplier.getValue()),this.rubyBonus.copy(this.totals.ruby),this.rubyBonus.mul(this.rubyMultiplier),this.rubyBonus.add(this.oneBigNum),this.damage.rubyDamageMultiplier.copy(this.rubyBonus)):this.damage.rubyDamageMultiplier.copy(this.oneBigNum);let e=this.values.skillBlockBonusMultiplier.getValue();e>0&&this.globalStatistics.tilesMined.greaterThanZero()?(this.blockMultiplier.setValue(n.blocks.multiplierPerBlock+e),this.blockBonus.copy(this.globalStatistics.tilesMined),this.blockBonus.mul(this.blockMultiplier),this.blockBonus.add(this.oneBigNum),this.damage.blockDamageMultiplier.copy(this.blockBonus)):this.damage.blockDamageMultiplier.copy(this.oneBigNum);let t=this.values.skillDepthBonusMultiplier.getValue();t>0?(this.workingDepthDamageMultiplier.setValue(this.globalStatistics.maxDepth),this.workingDepthDamageMultiplier.mulNumber(t),this.damage.depthDamageMultiplier.copy(this.workingDepthDamageMultiplier)):(this.workingDepthDamageMultiplier.copy(this.oneBigNum),this.damage.depthDamageMultiplier.copy(this.oneBigNum)),this.workingMineDamage.multiply(this.workingMultiBonus),this.minedDamageBonus.greaterThan(this.oneBigNum)&&this.workingMineDamage.multiply(this.minedDamageBonus),this.prestigeBonus.greaterThan(this.oneBigNum)&&this.workingMineDamage.multiply(this.prestigeBonus),this.workingDepthDamageMultiplier.greaterThan(this.oneBigNum)&&this.workingMineDamage.multiply(this.workingDepthDamageMultiplier),this.damage.goldDamageMultiplier.greaterThan(this.oneBigNum)&&this.workingMineDamage.multiply(this.damage.goldDamageMultiplier),this.damage.rubyDamageMultiplier.greaterThan(this.oneBigNum)&&this.workingMineDamage.multiply(this.damage.rubyDamageMultiplier),this.damage.blockDamageMultiplier.greaterThan(this.oneBigNum)&&this.workingMineDamage.multiply(this.damage.blockDamageMultiplier),this.damage.totalPickDamagePerTurn.copy(this.workingMineDamage),this.damage.totalPickDamagePerFrame.copy(this.damage.totalPickDamagePerTurn),this.damage.totalPickDamagePerFrame.mul(this.perFrameConversionFactor)}};var Cr=class{constructor(e){this.values=e,this.one=new d(1)}calculateOreForDepth(e,t){e.tileType.layerDescription.calculateTileOre(e.getTileRow(),t),this.applyMultipliers(t)}applyMultipliers(e){let t=this.values.skillOreBonusMultiplier.getValue();t.greaterThan(this.one)&&e.mul(t);let i=this.values.goldOreBonusMultiplier.getValue();i.greaterThan(this.one)&&e.mul(i)}};var u={pick:"images/pick_40x40.png",miner:"images/pick_40x40.png",offline:"images/pick_40x40.png",currency:{ore:"images/layers/purple_ore.png",gold:"images/layers/gold.png",ruby:"images/layers/ruby.png",prestige:"images/pick_40x40.png",depth:"images/pick_40x40.png",upgrades:"images/upgrades_40x40.png"},skill:{missiles:"images/missile_40x40.png",orbit:"images/orbit_40x40.png",laser:"images/laser_40x40.png",lightning:"images/laser_40x40.png",chain:"images/laser_40x40.png",drill:"images/drill_40x40.png",radar:"images/laser_40x40.png",fissure:"images/laser_40x40.png",minions:"images/laser_40x40.png",dynamite:"images/dynamite_40x40.png",damage:"images/laser_40x40.png",activation:"images/laser_40x40.png"}};var wr=class{constructor(e){this.id=e}getId(){return this.id}createMinedUpgrade(e){}createFreeValueUpgradeFromSave(e){}createFreeIdentifierUpgradeFromSave(e){}combineUpgrades(e,t){if(!e||!t){console.log("UpgradeCreator.combineUpgrade() null upgrade");return}if(e.getCreatorId()!==t.getCreatorId()){console.log("UpgradeCreator.combineUpgrade() creatorId mismatch");return}if(this.id!==e.getCreatorId()||this.id!==t.getCreatorId()){console.log("UpgradeCreator.combineUpgrade() creatorId does not match upgrade creator");return}this.combineUpgradesInternal(e,t)}combineUpgradesInternal(e,t){}};var Si=class extends Ci{constructor(e,t,i){super(t,i),this.upgradeCreator=e}getCreatorId(){return this.upgradeCreator.id}isCombineSupported(){return!1}isPurchasable(){return this.purchasedCount===0}isAffordable(){return!0}purchase(){return this.purchasedCount>0?!1:(this.purchasedCount++,this.onUpgradePurchased(),!0)}onUpgradePurchased(){}};var Sr=class extends Si{constructor(e,t,i,s,r,o){super(e,t,i),this.valueDelta=s,this.upgradeBonusValue=r,this.mineDamageLogic=o}onUpgradePurchased(){this.upgradeBonusValue.incrementValue(this.valueDelta),this.mineDamageLogic&&this.mineDamageLogic.calculateTotalMineDamagePerTurn()}isCombineSupported(){return!0}};var Ni=class extends wr{constructor(e,t,i){super(e),this.values=t,this.multiplierValue=i}getUpgradeBonusMultiplier(){let e=this.multiplierValue.getValue();return e>1?e:1}};var Ft={mineDamage:"mineDamage",mineOre:"mineOre"};var Nr=class extends Ni{constructor(e,t){super(Ft.mineDamage,e,null),this.mineDamageLogic=t}createMinedUpgrade(e){let t=Ke.calculateMinedDamageUpgradeValue(e),i=this.values.skillMinedDamageBonus.getValue();return i>0&&t.addNumber(i),this.createInternal(t)}createFreeValueUpgradeFromSave(e){return this.createInternal(e)}createInternal(e){let t=this.createTitle(e);return new Sr(this,t,u.pick,e,this.values.minedDamageBonusMultiplier,this.mineDamageLogic)}combineUpgradesInternal(e,t){e.valueDelta.add(t.valueDelta),e.title=this.createTitle(e.valueDelta)}createTitle(e){return"Multiplier: +"+I.formatBigNum(e)}};var Pr=class extends Si{constructor(e,t,i,s,r,o){super(e,t,i),this.ore=s,this.totals=r,this.statisticsInc=o}onUpgradePurchased(){this.totals.incrementOre(this.ore),this.statisticsInc.incrementOre(this.ore),this.statisticsInc.incrementUpgradeOre(this.ore)}isCombineSupported(){return!0}};var Ar=class extends Ni{constructor(e,t,i,s){super(Ft.mineOre,e,null),this.oreCalculationLogic=t,this.totals=i,this.statisticsInc=s}createMinedUpgrade(e){let t=new d(0);this.oreCalculationLogic.calculateOreForDepth(e,t);let i=n.skill.bonus.minedOreBaseTiles,s=this.values.skillMinedOreBonusUpgrades.getValue();if(s>0){let r=s*n.skill.bonus.minedOreBonusPerUpgrade;i+=r}return t.mulNumber(i),this.createInternal(t)}createFreeValueUpgradeFromSave(e){return this.createInternal(e)}createInternal(e){let t=this.createTitle(e);return new Pr(this,t,u.pick,e,this.totals,this.statisticsInc)}combineUpgradesInternal(e,t){e.ore.add(t.ore),e.title=this.createTitle(e.ore)}createTitle(e){return"Ore: +"+I.formatBigNum(e)}};var Mr=class extends wi{constructor(){super(),this.combineUpgradeThreshold=8}contains(e){for(let t=0;t<this.upgrades.length;t++)if(this.upgrades[t].getCreatorId()===e)return!0;return!1}add(e){super.add(e),this.upgrades.length>this.combineUpgradeThreshold&&this.combineUpgrades()}combineUpgrades(){for(let e=0;e<this.upgrades.length-1;e++){let t=this.upgrades[e];if(t.isCombineSupported())for(let i=this.upgrades.length-1;i>e;i--){let s=this.upgrades[i];if(s.isCombineSupported()&&t.getCreatorId()===s.getCreatorId()){t.upgradeCreator.combineUpgrades(t,s),this.upgrades.splice(i,1),this.changeCount++;break}}}}};var _r=class{constructor(e,t,i,s,r,o){this.creatorsById={},this.minedUpgradeCollection=r,this.mineDamage=new Nr(e,s),this.creatorsById[this.mineDamage.getId()]=this.mineDamage,this.oreBonus=new Ar(e,i,t,o),this.creatorsById[this.oreBonus.getId()]=this.oreBonus}getUpgradeCreatorById(e){return this.creatorsById[e]}getUpgradeCreatorForDrop(){return Math.random()<.65?this.oreBonus:this.mineDamage}};var Rr=class{constructor(e,t,i,s,r,o,a,h,m,p,f,S){this.crew=e,this.totals=t,this.damage=i,this.values=s,this.statisticsInc=r,this.upgradeCollection=o,this.upgradeCreators=a,this.infoTextProcessor=h,this.effectCreators=m,this.effectManager=p,this.oreCalculationLogic=f,this.mineDamageLogic=S,this.workingValue=new d(0),this.workingDamage=new d(0),this.turnsPerSecond=new d(n.time.turnsPerSecond),this.one=new d(1)}mineTileIstantly(e,t){!t||t.open||(t.onTileBreak(),this.revealTilesAfterMine(e,t),this.statisticsInc.onTileMined(t),this.handleTileDrops(t))}mineTileForTurn(e,t){return!t||t.open?!0:(this.workingDamage.copy(this.damage.totalPickDamagePerTurn),t.onTileDamaged(this.workingDamage),t.open?(this.revealTilesAfterMine(e,t),this.statisticsInc.onTileMined(t),this.handleTileDrops(t),!0):!1)}revealTilesAfterMine(e,t){let i=this.getOppositeTile(e.position.tile,t);if(i){this.revealTile(i);for(let s=0;s<i.neighbors.length;s++)this.revealTile(i.neighbors[s]);this.revealTile(i.getNeighborBottomLeft()),this.revealTile(i.getNeighborBottomRight()),this.revealTile(i.getNeighborTopLeft()),this.revealTile(i.getNeighborTopRight())}}revealTile(e){e&&e.markTileAsCurrentlyVisible()}getOppositeTile(e,t){return e?t.isNeighborLeft(e)?t.getNeighborRight():t.isNeighborRight(e)?t.getNeighborLeft():t.isNeighborBottom(e)?t.getNeighborTop():t.isNeighborTop(e)?t.getNeighborBottom():null:null}laserTileForFrame(e,t){!e||e.open||(this.skillDamageForFrame(e,t,this.effectCreators.effectSparkleRed),e.open&&this.statisticsInc.incrementMinedByLaser())}drillTileForFrame(e,t){!e||e.open||(this.skillDamageForFrame(e,t,this.effectCreators.effectSparkleBlue),e.open&&this.statisticsInc.incrementMinedByDrill())}orbitTileForFrame(e,t){!e||e.open||(this.skillDamageForFrame(e,t,this.effectCreators.effectSparkleGold),e.open&&this.statisticsInc.incrementMinedByOrbit())}calculateMissileDamage(e){return e.copy(this.damage.totalPickDamagePerTurn),e}missileTile(e,t){if(!e||e.open)return;let i=e.getHealth();i.lessThan(t)?(t.sub(i),e.onTileBreak(),e.markTileAsCurrentlyVisible(),this.handleTileDrops(e),this.statisticsInc.incrementMinedByMissile()):(e.onTileDamaged(t),t.setZero())}applyFissureSkillForFrame(e,t){!e||e.open||(this.skillDamageForFrame(e,t,null),e.open&&this.statisticsInc.incrementMinedByFissure())}applyLightningSkillForFrame(e,t){!e||e.open||(this.skillDamageForFrame(e,t,this.effectCreators.effectSparkleOrange),e.open&&this.statisticsInc.incrementMinedByLightning())}skillDamageForFrame(e,t,i){if(!(!e||e.open)&&(this.workingDamage.copy(this.damage.totalPickDamagePerFrame),this.workingDamage.mulNumber(t),e.onTileDamaged(this.workingDamage),e.open&&(this.statisticsInc.onTileMined(e),e.markTileAsCurrentlyVisible(),this.handleTileDrops(e),i))){let s=i.createEffectAtPosition(null,e.origin);s?this.effectManager.addEffect(s):console.log("TileMinedLogic.skillDamageForFrame. FAILED TO CREATE SPRITE")}}handleTileDrops(e){let i=e.tileType.rarityModifier;if(!(i===_.UNSET||i===_.COMMON))if(this.workingValue.setZero(),i===_.ORE)this.oreCalculationLogic.calculateOreForDepth(e,this.workingValue),this.totals.incrementOre(this.workingValue),this.statisticsInc.incrementOre(this.workingValue),this.infoTextProcessor.addOreText(e,this.workingValue);else if(i===_.GOLD)e.calculateTileGold(this.workingValue),this.totals.incrementGold(this.workingValue),this.statisticsInc.incrementGold(this.workingValue),this.infoTextProcessor.addGoldText(e,this.workingValue);else if(i===_.UPGRADE){let r=this.upgradeCreators.getUpgradeCreatorForDrop().createMinedUpgrade(e);r?this.upgradeCollection.add(r):console.log("TileMinedLogic.handleTileDrops() no upgrade created")}else i===_.RUBY&&(this.totals.incrementRuby(this.one),this.statisticsInc.incrementRuby(this.one),this.infoTextProcessor.addRubyText(e,this.one),this.mineDamageLogic.calculateTotalMineDamagePerTurn())}};var yr=class extends K{constructor(){super(),this.commonMiningCandidates=[],this.priorityMiningCandidates=[],this.currencyMiningCandidates=[],this.destinationTileCandidates=[],this.ignoreCommonTiles=!1,this.ignorePremiumTiles=!1,this.centerTile=null,this.vectorFieldNumber=0,this.tileHealthNegligible=!1}isVectorFieldMineTargetsEmpty(){return this.commonMiningCandidates.length===0&&this.currencyMiningCandidates.length===0&&this.priorityMiningCandidates.length===0}isPriorityTileVisible(){return this.priorityMiningCandidates.length===0&&this.currencyMiningCandidates.length===0?!1:this.isClosedTileInList(this.priorityMiningCandidates)||this.isClosedTileInList(this.currencyMiningCandidates)}isClosedTileInList(e){for(let t=0;t<e.length;t++)if(!e[t].open)return!0;return!1}onGridUnload(e){return this.centerTile&&this.centerTile.grid===e?(this.reset(),!0):(this.removeTilesForGrid(e,this.commonMiningCandidates),this.removeTilesForGrid(e,this.priorityMiningCandidates),this.removeTilesForGrid(e,this.currencyMiningCandidates),!1)}removeTilesForGrid(e,t){for(let i=t.length-1;i>=0;i--)t[i].grid===e&&t.splice(i,1)}resetFull(){this.reset()}resetForPrestige(){this.reset()}reset(){this.commonMiningCandidates.length>0&&(this.commonMiningCandidates.length=0),this.priorityMiningCandidates.length>0&&(this.priorityMiningCandidates.length=0),this.currencyMiningCandidates.length>0&&(this.currencyMiningCandidates.length=0),this.centerTile=null,this.vectorFieldNumber++,this.vectorFieldNumber>1e5&&(this.vectorFieldNumber=0)}};var Lr=class{constructor(e){this.subject=e,this.startTime=performance.now(),this.elapsed=0,this.count=0}startTimer(){this.startTime=performance.now()}endTimer(){this.elapsed+=performance.now()-this.startTime,this.count++}reset(){this.startTime=performance.now(),this.elapsed=0,this.count=0}};var Pi={},ne=class{constructor(){}static startTime(e){let t=Pi[e];t||(t=new Lr(e),Pi[e]=t),t.startTimer()}static endTime(e){let t=Pi[e];if(!t){console.log("PerformanceMetrics: failed to find: "+e);return}t.endTimer()}static getKeys(){return Object.keys(Pi)}static getPerformanceTrack(e){return Pi[e]}static reset(){for(let[e]of Object.entries(Pi)){let t=Pi[e];t&&t.reset()}}};var br=class{constructor(){this.tiles=new Array(100);for(let t=0;t<100;t++)this.tiles[t]=null;this.pathBuilder=new Array(100);for(let t=0;t<100;t++)this.tiles[t]=null;this.pathBuilderIndex=0,this.size=0}add(e){if(this.size>=this.tiles.length)for(let t=0;t<20;t++)this.tiles.push(null);this.tiles[this.size]=e,this.size++}addToFrontStart(){this.pathBuilderIndex=0}addToFrontEnd(){for(let e=this.pathBuilderIndex-1;e>=0;e--)this.add(this.pathBuilder[e])}addToFront(e){if(this.pathBuilderIndex>=this.pathBuilder.length)for(let t=0;t<20;t++)this.pathBuilder.push(null);this.pathBuilder[this.pathBuilderIndex]=e,this.pathBuilderIndex++}reset(){this.size=0}};var Ir=class{constructor(){this.movementVector=new v(0,0),this.position=new v(0,0),this.nearZero=.001}findPath(e,t,i){if(!t||!i)return!1;if(t===i)return e.add(i),!0;if(t.isNeighborTile(i))return e.add(t),e.add(i),!0;this.position.copy(t.origin);let s=t;e.add(s);let r=n.tile.halfSize;this.movementVector.copy(i.origin),this.movementVector.subtract(this.position);let o=q.len(this.movementVector);if(Math.abs(o)<this.nearZero)return!0;let a=t.getWorldGrid(),h=0;this.movementVector.scale(r/o);let m=!1;do if(this.position.add(this.movementVector),h+=r,!s.contains(this.position)){let p=s,f=s.getNeighbor(this.position);if(!f&&(console.log("DirectLinePathFinder.findPath() stepped to non-neighbor tile somehow!"),f=a.findGridTile(this.position),!f))return!1;if(s=f,this.checkForDiagonal(e,p,s),e.add(s),s===i){m=!0;break}}while(h<o&&s!==i);return m||e.add(i),!0}checkForDiagonal(e,t,i){if(!i.isNeighborTile(t)){let s=t.getNeighborLeft(),r=t.getNeighborRight(),o=t.getNeighborTop(),a=t.getNeighborBottom();i===t.getNeighborBottomLeft()?a.open?e.add(a):e.add(s):i===t.getNeighborBottomRight()?a.open?e.add(a):e.add(r):i===t.getNeighborTopLeft()?o.open?e.add(o):e.add(s):i===t.getNeighborTopRight()&&(o.open?e.add(o):e.add(r))}}};var Ui=class{constructor(){this.score=0,this.tile=null}reset(){this.score=0,this.tile=null}set(e,t){this.score=e,this.tile=t}copy(e){this.score=e.score,this.tile=e.tile}};var xr=class{constructor(){this.queue=new Array(100);for(let t=0;t<100;t++)this.queue[t]=new Ui;this.size=0}add(e,t){this.size>=this.queue.length&&this.grow(this.size+1),this.siftUpUsingComparator(this.size,e,t),this.size=this.size+1}grow(e){let t=this.queue.length,i=e-t,s=t<64?t+2:t>>1,r=Math.max(i,s);console.log("PriorityQueue2.grow() length="+this.queue.length+" min="+i+" pref="+s+" amount="+r);for(let o=0;o<r;o++)this.queue.push(new Ui);console.log("PriorityQueue2.grow() new length: "+this.queue.length)}siftUpUsingComparator(e,t,i){for(;e>0;){let s=e-1>>>1,r=this.queue[s];if(this.compare(t,r.score)>=0)break;this.queue[e].copy(r),e=s}this.queue[e].set(t,i)}siftDownUsingComparator(e,t,i){let s=this.size>>>1;for(;e<s;){let r=(e<<1)+1,o=this.queue[r],a=r+1;if(a<this.size&&this.compare(o.score,this.queue[a].score)>0&&(r=a,o=this.queue[r]),this.compare(t,o.score)<=0)break;this.queue[e].copy(o),e=r}this.queue[e].set(t,i)}poll(){let t=this.queue[0].tile;this.size--;let i=this.queue[this.size],s=i.tile,r=i.score;return i.reset(),this.size>0&&this.siftDownUsingComparator(0,r,s),t}compare(e,t){return e-t}isEmpty(){return this.size===0}clear(){for(let e=0;e<this.size;e++)this.queue[e].reset();this.size=0}};var Or=class{constructor(){this.openAirTileCost=n.tile.size*15,this.closedTileCost=n.tile.size*155,this.gravityDiscount=n.tile.halfSize,this.maxPathDistance=n.tile.size*80,this.openList=new xr,this.pathNumber=0,this.diagonalSize=Math.sqrt(n.tile.size*n.tile.size+n.tile.size*n.tile.size)|0}findPathSpecialCases(e,t,i,s){if(t===i)return s&&e.add(i),!0;if(t.isNeighborTile(i))return s&&(e.add(t),e.add(i)),!0;let r=q.dist(t.origin,i.origin);return r>this.maxPathDistance?(console.log("Path too long: "+r/n.tile.size+" max: "+this.maxPathDistance/n.tile.size),!0):!1}findPath(e,t,i,s,r,o){if(!t||!i){console.log("findPath() null start/end");return}if(this.findPathSpecialCases(e,t,i,s))return;this.pathNumber++,this.openList.clear(),t.pathData.setCost(0,this.pathNumber),this.openList.add(0,t),t.pathData.setInOpenList(!0,this.pathNumber);let a;for(;!this.openList.isEmpty();){if(a=this.openList.poll(),!a){console.log("PathFinder.findPath() current is null. bug");break}if(a.pathData.setInOpenList(!1,this.pathNumber),a===i){this.constructPath(e,i,s);break}else{a.pathData.setClosed(!0,this.pathNumber);let h=a.pathData.getCost(this.pathNumber),m=a.getNeighborBottom(),p=!m||m.isTraversable(),f=a.getNeighbors();for(let S=0;S<f.length;S++){let E=f[S];if(!E||E.pathData.isClosed(this.pathNumber))continue;let w=0;p&&(S===1?w-=this.gravityDiscount:w+=this.openAirTileCost),!E.open&&r&&!o&&(w+=this.closedTileCost);let C=h+this.distanceBetween(a,E)+w,T=E.pathData.isInOpenList(this.pathNumber);if(T&&C>=E.pathData.getCost(this.pathNumber))continue;let A=C+this.calculateHeuristicCostEstimate(E,i);E.pathData.set(a,C,A,this.pathNumber),T||(this.openList.add(A,E),E.pathData.setInOpenList(!0,this.pathNumber))}}}}calculateHeuristicCostEstimate(e,t){return q.dist(e.getOrigin(),t.getOrigin())|0}distanceBetween(e,t){let i=e.getOrigin(),s=t.getOrigin();return i.x==s.x?n.tile.size:i.y==s.y?n.tile.size:this.diagonalSize}constructPath(e,t,i){let s;if(i)s=t;else if(s=t.pathData.getCameFrom(this.pathNumber),s==null)return;e.addToFrontStart();do e.addToFront(s),s=s.pathData.getCameFrom(this.pathNumber);while(s!=null);e.addToFrontEnd()}};var j={IGNORE:-10,OPEN:-9,OPEN_OR_PATH:-11,CLOSED:-8,START:0,END:1e3,PATH:2e3};var ae=class{constructor(e,t){this.startCol=0,this.startRow=0,this.endCol=0,this.endRow=0,this.startColFlipped=0,this.startRowFlipped=0,this.endColFlipped=0,this.endRowFlipped=0,this.pathCount=0,this.pattern=this.convertPattern(e),this.flippedPattern=t?this.convertFlippedPattern(e):null}getMinRequiredPathSteps(){}getPlanIfMatch(e,t,i,s,r){return this.isMatch(i,s,r,this.pattern,this.startCol,this.startRow,this.endCol,this.endRow)?this.getPathPlan(e,t):this.flippedPattern&&this.isMatch(i,s,r,this.flippedPattern,this.startColFlipped,this.startRowFlipped,this.endColFlipped,this.endRowFlipped)?this.getPathPlanFlipped(e,t):null}getPathPlan(e,t){}getPathPlanFlipped(e,t){}isMatch(e,t,i,s,r,o,a,h){if(i.length===0)return!1;let m=e-r,p=t-o;if(m<0||p<0)return!1;let f=i[e][t];if(f<0)return!1;let S=e+(a-r),E=t+(h-o);if(S>=i.length)return!1;let w=i[S];if(E>=w.length||w[E]<f)return!1;for(let T=0;T<s.length;T++){let A=s[T];for(let N=0;N<A.length;N++){let P=A[N];if(P===j.IGNORE||P===j.START||P===j.END)continue;let M=m+T,y=p+N;if(M>=i.length)return!1;let V=i[M];if(y>=V.length)return!1;let O=V[y];if(P===j.OPEN_OR_PATH){if(O===j.OPEN||O>0)continue;return!1}else if(P===j.OPEN){if(O===j.OPEN)continue;return!1}else if(P===j.CLOSED){if(O===j.CLOSED)continue;return!1}else if(P===j.PATH){if(O<0)return!1}else return!1}}return!0}convertPattern(e){if(!e||e.length===0)return console.log("PathTemplatePattern.convertPattern() Invalid empty string pattern"),[];let t=e[0].length,i=e.length,s=new Array(t);for(let r=0;r<t;r++){let o=new Array(i);o.fill(j.IGNORE),s[r]=o}for(let r=0;r<i;r++){let o=e[r];for(let a=0;a<t;a++){let h=o.charAt(a),m=this.convertPatternChar(h);m===j.START?(this.startCol=a,this.startRow=r):m===j.END?(this.endCol=a,this.endRow=r):m===j.PATH&&this.pathCount++,s[a][r]=m}}return s}convertFlippedPattern(e){if(!e||e.length===0)return console.log("PathTemplatePattern.convertPattern() Invalid empty string pattern"),[];let t=e[0].length,i=e.length,s=new Array(t);for(let r=0;r<t;r++){let o=new Array(i);o.fill(j.IGNORE),s[r]=o}for(let r=0;r<i;r++){let o=e[r],a=0;for(let h=t-1;h>=0;h--){let m=o.charAt(h),p=this.convertPatternChar(m);p===j.START?(this.startColFlipped=a,this.startRowFlipped=r):p===j.END&&(this.endColFlipped=a,this.endRowFlipped=r),s[a][r]=p,a++}}return s}convertPatternChar(e){switch(e){case"S":return j.START;case"E":return j.END;case"P":return j.PATH;case"X":return j.CLOSED;case"O":return j.OPEN;case"8":return j.OPEN_OR_PATH;case".":return j.IGNORE}return console.log("PathTemplatePattern.convertPatternChar() Invalid char: "+e),j.IGNORE}findTilePathIndex(e,t,i,s){for(let r=t;r<e.size;r++){let o=e.tiles[r];if(!(o.getTileCol()!==i||o.getTileRow()!=s))return r}return console.log("PathTemplatePattern.findTilePathIndex() failed to find tile in path."),-1}printPattern(e){if(e.length===0){console("printPattern() template empty");return}let t=e[0].length;for(let i=0;i<t;i++){let s="";for(let r=0;r<e.length;r++){let o=e[r][i];o===j.IGNORE?s+=".":o===j.PATH?s+="P":o===j.OPEN?s+="0":o===j.OPEN_OR_PATH?s+="8":o===j.CLOSED?s+="X":o===j.START?s+="S":o===j.END?s+="E":s+="?"}console.log(s)}}toString(){}};var vr=class{constructor(){this.template=this.initializeTemplate(30,30),this.startColIndex=0,this.startRowIndex=0}updateTemplate(e){this.buildTemplate(e)}getPlanIfPatternMatch(e,t,i){let s=t.tiles[i],r=s.getTileCol(),o=s.getTileRow(),a=t.tiles[0],h=a.getTileCol(),m=a.getTileRow(),p=this.startColIndex+(r-h),f=this.startRowIndex+(o-m);return e.getPlanIfMatch(t,i,p,f,this.template)}buildTemplate(e){if(e.size<2)return;let t=e.tiles[0],i=t.getTileCol(),s=i,r=t.getTileRow(),o=r;for(let E=1;E<e.size;E++){let w=e.tiles[E],C=w.getTileCol(),T=w.getTileRow();i=Math.min(i,C),s=Math.max(s,C),r=Math.min(r,T),o=Math.max(o,T)}i--,r--,s+=2,o+=2;let a=s-i,h=o-r;this.growAndClearTemplate(a,h);let m=e.tiles[0];this.startColIndex=m.getTileCol()-i,this.startRowIndex=m.getTileRow()-r;let p=this.startColIndex,f=this.startRowIndex;this.populateTileAndNeighbors(m,p,f,0);let S=m;for(let E=1;E<e.size;E++){let w=e.tiles[E];p+=w.getTileCol()-S.getTileCol(),f+=w.getTileRow()-S.getTileRow(),this.populateTileAndNeighbors(w,p,f,E),S=w}}initializeTemplate(e,t){let i=new Array(e);for(let s=0;s<e;s++){let r=new Array(t);r.fill(j.IGNORE),i[s]=r}return i}growAndClearTemplate(e,t){let i=this.template.length,s=this.template[0].length,r=!1;if(s<t){for(let o=0;o<this.template.length;o++){let a=this.template[o],h=a.length;a.length=t;for(let m=h;m<t;m++)a[m]=j.IGNORE}r=!0}if(i<e){this.template.length=e;let o=Math.max(s,t);for(let a=i;a<e;a++){let h=new Array(o);for(let m=0;m<o;m++)h[m]=j.IGNORE;this.template[a]=h}r=!0}for(let o=0;o<this.template.length;o++)this.template[o].fill(j.IGNORE);r&&console.log("PathTemplate grew. ["+this.template.length+"]["+this.template[0].length+"]")}populateTileAndNeighbors(e,t,i,s){if(e.open?this.template[t][i]=s:this.template[t][i]=j.CLOSED,this.template[t][i-1]===j.IGNORE){let r=e.getNeighborTop();r&&(this.template[t][i-1]=r.open?j.OPEN:j.CLOSED)}if(this.template[t][i+1]===j.IGNORE){let r=e.getNeighborBottom();r&&(this.template[t][i+1]=r.open?j.OPEN:j.CLOSED)}if(this.template[t-1][i]===j.IGNORE){let r=e.getNeighborLeft();r&&(this.template[t-1][i]=r.open?j.OPEN:j.CLOSED)}if(this.template[t+1][i]===j.IGNORE){let r=e.getNeighborRight();r&&(this.template[t+1][i]=r.open?j.OPEN:j.CLOSED)}if(this.template[t-1][i-1]===j.IGNORE){let r=e.getNeighborTopLeft();r&&(this.template[t-1][i-1]=r.open?j.OPEN:j.CLOSED)}if(this.template[t+1][i-1]===j.IGNORE){let r=e.getNeighborTopRight();r&&(this.template[t+1][i-1]=r.open?j.OPEN:j.CLOSED)}if(this.template[t-1][i-1]===j.IGNORE){let r=e.getNeighborBottomLeft();r&&(this.template[t-1][i-1]=r.open?j.OPEN:j.CLOSED)}if(this.template[t+1][i-1]===j.IGNORE){let r=e.getNeighborBottomRight();r&&(this.template[t+1][i-1]=r.open?j.OPEN:j.CLOSED)}}};var Dr=class extends Ie{constructor(e,t,i){super(e,t,i),this.landCoordinate=new v}executePlan(e,t,i){let r=this.startTile.origin.x+n.tile.size+n.character.halfWidth;return e.position.worldCoordinateCenter.x<r?(this.walkRightToCenterX(e,t,r),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x<this.endTile.origin.x||e.position.worldCoordinateOrigin.y<this.endTile.origin.y?(this.fallDownAndRight(e,t,this.landCoordinate),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"FallDownRight("+this.pathSteps+")"}};var Br=class extends Ie{constructor(e,t,i){super(e,t,i),this.landCoordinate=new v(0,0)}executePlan(e,t,i){let r=this.startTile.origin.x-n.character.halfWidth;return e.position.worldCoordinateCenter.x>r?(this.walkLeftToCenterX(e,t,r),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x>this.landCoordinate.x||e.position.worldCoordinateOrigin.y<this.endTile.origin.y?(this.fallDownAndLeft(e,t,this.landCoordinate),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"FallDownLeft("+this.pathSteps+")"}};var kr=class extends ae{constructor(){super(["S8","X8",".E"],!0)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e.tiles[t],s=i.getTileCol()+1,r=i.getTileRow()+2,o=this.findTilePathIndex(e,t+3,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Dr(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],s=i.getTileCol()-1,r=i.getTileRow()+2,o=this.findTilePathIndex(e,t+3,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Br(i,a,h)}toString(){return"PatternFallDown2Side1"}};var Pt=class extends Ie{constructor(e,t,i){super(e,t,i),this.jumpCoordinate=new v(0,0),this.landCoordinate=new v(0,0)}executePlan(e,t,i){this.jumpCoordinate.copy(this.startTile.origin),this.jumpCoordinate.subtractXY(n.character.halfWidth,0);let s=this.jumpCoordinate.x;return e.position.worldCoordinateCenter.x>s?(this.walkLeftToCenterX(e,t,s),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x>this.landCoordinate.x||e.position.worldCoordinateOrigin.y<this.endTile.origin.y?(this.jumpDownAndLeft(e,t,this.jumpCoordinate,this.landCoordinate),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"JumpDownLeft("+this.pathSteps+")"}};var At=class extends Ie{constructor(e,t,i){super(e,t,i),this.jumpCoordinate=new v(0,0),this.landCoordinate=new v(0,0)}executePlan(e,t,i){this.jumpCoordinate.copy(this.startTile.origin),this.jumpCoordinate.addXY(n.tile.size+n.character.halfWidth,0);let s=this.jumpCoordinate.x;return e.position.worldCoordinateCenter.x<s?(this.walkRightToCenterX(e,t,s),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x<this.landCoordinate.x||e.position.worldCoordinateOrigin.y<this.endTile.origin.y?(this.jumpDownAndRight(e,t,this.jumpCoordinate,this.landCoordinate),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"JumpDownRight("+this.pathSteps+")"}};var Fr=class extends ae{constructor(){super([".O.","S88","X8E"],!0)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e.tiles[t],s=i.getTileCol()+2,r=i.getTileRow()+1,o=this.findTilePathIndex(e,t+3,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new At(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],s=i.getTileCol()-2,r=i.getTileRow()+1,o=this.findTilePathIndex(e,t+3,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Pt(i,a,h)}toString(){return"PatternJumpDown1Side2"}};var Gr=class extends ae{constructor(){super([".OO.","S888","X88E"],!0)}getMinRequiredPathSteps(){return 4}getPathPlan(e,t){let i=e.tiles[t],s=i.getTileCol()+3,r=i.getTileRow()+1,o=this.findTilePathIndex(e,t+4,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new At(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],s=i.getTileCol()-3,r=i.getTileRow()+1,o=this.findTilePathIndex(e,t+4,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Pt(i,a,h)}toString(){return"PatternJumpDown1Side3"}};var Vr=class extends ae{constructor(){super([".OO..","S8888","X.88E"],!0)}getMinRequiredPathSteps(){return 5}getPathPlan(e,t){let i=e.tiles[t],s=i.getTileCol()+4,r=i.getTileRow()+1,o=this.findTilePathIndex(e,t+5,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new At(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],s=i.getTileCol()-4,r=i.getTileRow()+1,o=this.findTilePathIndex(e,t+5,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Pt(i,a,h)}toString(){return"PatternJumpDown1Side4"}};var Gt=class extends Ie{constructor(e,t,i,s){super(e,t,i),this.jumpCoordinate=new v(0,0),this.landCoordinate=new v(0,0),this.jumpHeight=s}executePlan(e,t,i){this.jumpCoordinate.copy(this.startTile.origin),this.jumpCoordinate.subtractXY(n.character.halfWidth,0);let s=this.jumpCoordinate.x;return e.position.worldCoordinateCenter.x>s?(this.walkLeftToCenterX(e,t,s),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x>this.landCoordinate.x||e.position.worldCoordinateOrigin.y<this.endTile.origin.y?(this.jumpLeft(e,t,this.jumpCoordinate,this.landCoordinate,this.jumpHeight),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"JumpLeft("+this.pathSteps+")"}};var Vt=class extends Ie{constructor(e,t,i,s){super(e,t,i),this.jumpCoordinate=new v(0,0),this.landCoordinate=new v(0,0),this.jumpHeight=s}executePlan(e,t,i){this.jumpCoordinate.copy(this.startTile.origin),this.jumpCoordinate.addXY(n.tile.size+n.character.halfWidth,0);let s=this.jumpCoordinate.x;return e.position.worldCoordinateCenter.x<s?(this.walkRightToCenterX(e,t,s),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x<this.landCoordinate.x||e.position.worldCoordinateOrigin.y<this.endTile.origin.y?(this.jumpRight(e,t,this.jumpCoordinate,this.landCoordinate,this.jumpHeight),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"JumpRight("+this.pathSteps+")"}};var Ur=class extends ae{constructor(){super([".O.","S8E","X8."],!0)}getMinRequiredPathSteps(){return 2}getPathPlan(e,t){let i=e.tiles[t],s=i.getTileCol()+2,r=i.getTileRow(),o=this.findTilePathIndex(e,t+2,s,r);if(o<0)return console.log("PathTemplatePatternJumpSide2() getPathPlan() failed to find end tile"),null;let a=e.tiles[o],h=o-t;return new Vt(i,a,h,n.tile.halfSize)}getPathPlanFlipped(e,t){let i=e.tiles[t],s=i.getTileCol()-2,r=i.getTileRow(),o=this.findTilePathIndex(e,t+2,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Gt(i,a,h,n.tile.halfSize)}toString(){return"PatternJump0Side2"}};var Hr=class extends ae{constructor(){super([".OO.","S88E","X88."],!0)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e.tiles[t],s=i.getTileCol()+3,r=i.getTileRow(),o=this.findTilePathIndex(e,t+3,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Vt(i,a,h,n.tile.threeQuarterSize)}getPathPlanFlipped(e,t){let i=e.tiles[t],s=i.getTileCol()-3,r=i.getTileRow(),o=this.findTilePathIndex(e,t+3,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Gt(i,a,h,n.tile.threeQuarterSize)}toString(){return"PatternJump0Side3"}};var zr=class extends ae{constructor(){super([".OOO.","S8.8E","X8.8."],!0)}getMinRequiredPathSteps(){return 4}getPathPlan(e,t){let i=e.tiles[t],s=i.getTileCol()+4,r=i.getTileRow(),o=this.findTilePathIndex(e,t+4,s,r);if(o<0)return console.log("PatternJump0Side4 getPathPlan failed to find end index"),null;let a=e.tiles[o],h=o-t;return new Vt(i,a,h,n.tile.size)}getPathPlanFlipped(e,t){let i=e.tiles[t],s=i.getTileCol()-4,r=i.getTileRow(),o=this.findTilePathIndex(e,t+4,s,r);if(o<0)return console.log("PatternJump0Side4 getPathPlanFlipped failed to find end index"),null;let a=e.tiles[o],h=o-t;return new Gt(i,a,h,n.tile.size)}toString(){return"PatternJump0Side4"}};var st=class extends Ie{constructor(e,t,i){super(e,t,i),this.jumpCoordinate=new v(0,0),this.landCoordinate=new v(0,0)}executePlan(e,t,i){this.jumpCoordinate.copy(this.startTile.origin),this.jumpCoordinate.addXY(n.tile.halfSize,0);let s=this.jumpCoordinate.x;return e.position.worldCoordinateCenter.x>s?(this.walkLeftToCenterX(e,t,s),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x>this.landCoordinate.x?(this.jumpUpAndLeft(e,t,this.jumpCoordinate,this.landCoordinate),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"JumpUpLeft("+this.pathSteps+")"}};var rt=class extends Ie{constructor(e,t,i){super(e,t,i),this.jumpCoordinate=new v(0,0),this.landCoordinate=new v(0,0)}executePlan(e,t,i){this.jumpCoordinate.copy(this.startTile.origin),this.jumpCoordinate.addXY(n.tile.halfSize,0);let s=this.jumpCoordinate.x;return e.position.worldCoordinateCenter.x<s?(this.walkRightToCenterX(e,t,s),!1):(this.landCoordinate.copy(this.endTile.origin),this.landCoordinate.addXY(n.tile.halfSize,0),e.position.worldCoordinateCenter.x<this.landCoordinate.x?(this.jumpUpAndRight(e,t,this.jumpCoordinate,this.landCoordinate),!1):(this.assertEndTileReached(e,this.endTile),!0))}toString(){return"JumpUpRight("+this.pathSteps+")"}};var Wr=class extends ae{constructor(){super(["88E","SX."],!0)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e.tiles[t],s=i.getTileCol()+2,r=i.getTileRow()-1,o=this.findTilePathIndex(e,t+3,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new rt(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],s=i.getTileCol()-2,r=i.getTileRow()-1,o=this.findTilePathIndex(e,t+3,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new st(i,a,h)}toString(){return"PatternJumpUp1Side2"}};var Yr=class extends ae{constructor(){super(["888E","S8X."],!0)}getMinRequiredPathSteps(){return 4}getPathPlan(e,t){let i=e.tiles[t],s=i.getTileCol()+3,r=i.getTileRow()-1,o=this.findTilePathIndex(e,t+4,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new rt(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],s=i.getTileCol()-3,r=i.getTileRow()-1,o=this.findTilePathIndex(e,t+4,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new st(i,a,h)}toString(){return"PatternJumpUp1Side3"}};var Mt=class extends Ie{constructor(e,t,i){super(e,t,i)}executePlan(e,t,i){let s=this.endTile.origin.x+n.tile.halfSize,r=this.walkLeftToCenterX(e,t,s);return r&&this.assertEndTileReached(e,this.endTile),r}toString(){return"WalkLeft("+this.pathSteps+")"}};var _t=class extends Ie{constructor(e,t,i){super(e,t,i)}executePlan(e,t,i){let s=this.endTile.origin.x+n.tile.halfSize,r=this.walkRightToCenterX(e,t,s);return r&&this.assertEndTileReached(e,this.endTile),r}toString(){return"WalkRight("+this.pathSteps+")"}};var Kr=class extends ae{constructor(){super(["SPE","XXX"],!0)}getMinRequiredPathSteps(){return 2}getPathPlan(e,t){let i=e.tiles[t],s=e.tiles[t+2];return new _t(i,s,2)}getPathPlanFlipped(e,t){let i=e.tiles[t],s=e.tiles[t+2];return new Mt(i,s,2)}toString(){return"PatternWalkSide2"}};var Xr=class extends ae{constructor(){super(["SPPPE","XXXXX"],!0)}getMinRequiredPathSteps(){return 4}getPathPlan(e,t){let i=e.tiles[t],s=e.tiles[t+4];return new _t(i,s,4)}getPathPlanFlipped(e,t){let i=e.tiles[t],s=e.tiles[t+4];return new Mt(i,s,4)}toString(){return"PatternWalkSide4"}};var ht=class extends Ie{constructor(e,t,i){super(e,t,i)}executePlan(e,t,i){let s=this.fallDown(e,t,this.endTile);return s&&this.assertEndTileReached(e,this.endTile),s}isSolidFloorRequiredAtStart(){return!1}toString(){return"FallDown("+this.pathSteps+")"}};var ut=class extends Ie{constructor(e,t,i){super(e,t,i)}executePlan(e,t,i){let s=this.jumpUp(e,t,this.endTile);return s&&this.assertEndTileReached(e,this.endTile),s}toString(){return"JumpUp("+this.pathSteps+")"}};var jr=class extends ae{constructor(){super(["8E","S."],!0)}getMinRequiredPathSteps(){return 2}getPathPlan(e,t){let i=e.tiles[t],s=i.getTileCol()+1,r=i.getTileRow()-1,o=this.findTilePathIndex(e,t+2,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new rt(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],s=i.getTileCol()-1,r=i.getTileRow()-1,o=this.findTilePathIndex(e,t+2,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new st(i,a,h)}toString(){return"PatternJumpUp1Side1"}};var Zr=class extends ae{constructor(){super([".88E","888X","S8.."],!0)}getMinRequiredPathSteps(){return 5}getPathPlan(e,t){let i=e.tiles[t],s=i.getTileCol()+3,r=i.getTileRow()-2,o=this.findTilePathIndex(e,t+5,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new rt(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],s=i.getTileCol()-3,r=i.getTileRow()-2,o=this.findTilePathIndex(e,t+5,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new st(i,a,h)}toString(){return"PatternJumpUp2Side3"}};var qr=class extends ae{constructor(){super([".8E","88.","S.."],!0)}getMinRequiredPathSteps(){return 4}getPathPlan(e,t){let i=e.tiles[t],s=i.getTileCol()+2,r=i.getTileRow()-2,o=this.findTilePathIndex(e,t+4,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new rt(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],s=i.getTileCol()-2,r=i.getTileRow()-2,o=this.findTilePathIndex(e,t+4,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new st(i,a,h)}toString(){return"PatternJumpUp2Side2"}};var Jr=class extends ae{constructor(){super(["8E","8.","S."],!0)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e.tiles[t],s=i.getTileCol()+1,r=i.getTileRow()-2,o=this.findTilePathIndex(e,t+3,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new rt(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],s=i.getTileCol()-1,r=i.getTileRow()-2,o=this.findTilePathIndex(e,t+3,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new st(i,a,h)}toString(){return"PatternJumpUp2Side1"}};var Qr=class extends ae{constructor(){super([".OO.","S888","X.88","...E","...X"],!0)}getMinRequiredPathSteps(){return 5}getPathPlan(e,t){let i=e.tiles[t],s=i.getTileCol()+3,r=i.getTileRow()+2,o=this.findTilePathIndex(e,t+5,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new At(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],s=i.getTileCol()-3,r=i.getTileRow()+2,o=this.findTilePathIndex(e,t+5,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new Pt(i,a,h)}toString(){return"PatternJumpDown2Side3"}};var $r=class extends ae{constructor(){super(["E","8","S"],!1)}getMinRequiredPathSteps(){return 2}getPathPlan(e,t){let i=e.tiles[t],s=i.getTileCol(),r=i.getTileRow()-2,o=this.findTilePathIndex(e,t+2,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new ut(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],s=i.getTileCol(),r=i.getTileRow()-2,o=this.findTilePathIndex(e,t+3,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new ut(i,a,h)}toString(){return"PatternJumpUp2"}};var eo=class extends ae{constructor(){super(["E","8","8","S"],!1)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e.tiles[t],s=i.getTileCol(),r=i.getTileRow()-3,o=this.findTilePathIndex(e,t+3,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new ut(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],s=i.getTileCol(),r=i.getTileRow()-3,o=this.findTilePathIndex(e,t+3,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new ut(i,a,h)}toString(){return"PatternJumpUp3"}};var to=class extends ae{constructor(){super(["S","8","E"],!1)}getMinRequiredPathSteps(){return 2}getPathPlan(e,t){let i=e.tiles[t],s=i.getTileCol(),r=i.getTileRow()+2,o=this.findTilePathIndex(e,t+2,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new ht(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],s=i.getTileCol(),r=i.getTileRow()+2,o=this.findTilePathIndex(e,t+2,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new ht(i,a,h)}toString(){return"PatternFallDown2"}};var io=class extends ae{constructor(){super(["S","8","8","E"],!1)}getMinRequiredPathSteps(){return 3}getPathPlan(e,t){let i=e.tiles[t],s=i.getTileCol(),r=i.getTileRow()+3,o=this.findTilePathIndex(e,t+3,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new ht(i,a,h)}getPathPlanFlipped(e,t){let i=e.tiles[t],s=i.getTileCol(),r=i.getTileRow()+3,o=this.findTilePathIndex(e,t+3,s,r);if(o<0)return null;let a=e.tiles[o],h=o-t;return new ht(i,a,h)}toString(){return"PatternFallDown3"}};var so=class extends Mt{constructor(e,t,i,s,r){super(e,t,i),this.tileMinedLogic=s,this.tileHealthNegligible=r,this.miningThisTurn=!1}executePlan(e,t,i){if(this.endTile.open){if(this.miningThisTurn)if(i)this.miningThisTurn=!1;else return!1}else if(this.tileHealthNegligible)this.tileMinedLogic.mineTileIstantly(e,this.endTile);else return e.setCharacterAction($.MINE),this.miningThisTurn=!0,e.position.worldCoordinateOrigin.x!==this.endTile.origin.x&&(e.position.facingLeft=e.position.worldCoordinateOrigin.x>this.endTile.origin.x),i&&this.tileMinedLogic.mineTileForTurn(e,this.endTile),!1;return super.executePlan(e,t,i)}toString(){return"MineAndWalkLeft("+this.pathSteps+")"}};var ro=class extends _t{constructor(e,t,i,s,r){super(e,t,i),this.tileMinedLogic=s,this.tileHealthNegligible=r,this.miningThisTurn=!1}executePlan(e,t,i){if(this.endTile.open){if(this.miningThisTurn)if(i)this.miningThisTurn=!1;else return!1}else if(this.tileHealthNegligible)this.tileMinedLogic.mineTileIstantly(e,this.endTile);else return e.setCharacterAction($.MINE),this.miningThisTurn=!0,e.position.worldCoordinateOrigin.x!==this.endTile.origin.x&&(e.position.facingLeft=e.position.worldCoordinateOrigin.x>this.endTile.origin.x),i&&this.tileMinedLogic.mineTileForTurn(e,this.endTile),!1;return super.executePlan(e,t,i)}toString(){return"MineAndWalkRight("+this.pathSteps+")"}};var oo=class extends ut{constructor(e,t,i,s,r){super(e,t,i),this.tileMinedLogic=s,this.tileHealthNegligible=r,this.miningThisTurn=!1}executePlan(e,t,i){if(this.endTile.open){if(this.miningThisTurn)if(i)this.miningThisTurn=!1;else return!1}else if(this.tileHealthNegligible)this.tileMinedLogic.mineTileIstantly(e,this.endTile);else return e.setCharacterAction($.MINE),this.miningThisTurn=!0,e.position.worldCoordinateOrigin.x!==this.endTile.origin.x&&(e.position.facingLeft=e.position.worldCoordinateOrigin.x>this.endTile.origin.x),i&&this.tileMinedLogic.mineTileForTurn(e,this.endTile),!1;return super.executePlan(e,t,i)}toString(){return"MineAndJumpUp("+this.pathSteps+")"}};var no=class extends ht{constructor(e,t,i,s,r){super(e,t,i),this.tileMinedLogic=s,this.tileHealthNegligible=r,this.miningThisTurn=!1}executePlan(e,t,i){if(this.endTile.open){if(this.miningThisTurn)if(i)this.miningThisTurn=!1;else return!1}else if(this.tileHealthNegligible)this.tileMinedLogic.mineTileIstantly(e,this.endTile);else return e.setCharacterAction($.MINE),this.miningThisTurn=!0,e.position.worldCoordinateOrigin.x!==this.endTile.origin.x&&(e.position.facingLeft=e.position.worldCoordinateOrigin.x>this.endTile.origin.x),i&&this.tileMinedLogic.mineTileForTurn(e,this.endTile),!1;return super.executePlan(e,t,i)}toString(){return"MineAndFallDown("+this.pathSteps+")"}};var ao=class{constructor(e){this.tileMinedLogic=e,this.pathTemplate=new vr,this.patterns=[new zr,new Vr,new Zr,new Qr,new Hr,new Yr,new Gr,new qr,new eo,new io,new Ur,new Jr,new Wr,new Fr,new jr,new $r,new to,new kr,new Xr,new Kr],this.claimedPath=new Array(30),this.claimedPath.fill(null)}connectPathToPlan2(e,t,i,s){e.size!==0&&(this.evaluatePathInternal(e,s),t.length=i,this.buildPathPlanFromClaimedPath(e,t,this.claimedPath))}evaluatePath(e,t,i){if(e.size===0){t.length=0;return}this.evaluatePathInternal(e,i),t.length=0,this.buildPathPlanFromClaimedPath(e,t,this.claimedPath)}buildPathPlanFromClaimedPath(e,t,i){let s=null;for(let r=0;r<e.size;r++){let o=i[r];o&&o!==s&&t.push(o),s=o}}evaluatePathInternal(e,t){if(e.size>this.claimedPath.length&&(this.claimedPath.length=e.size),this.claimedPath.fill(null),e.size<3)for(let i=0;i<e.size-1;i++)this.addDefaultPlan(e,i,this.claimedPath);else{this.pathTemplate.updateTemplate(e);for(let i=0;i<e.size-1;i++)this.addMinePlan(e,i,this.claimedPath,t);for(let i=0;i<this.patterns.length;i++)this.checkPatternAgainstPath(this.patterns[i],e,this.claimedPath);for(let i=0;i<e.size-1;i++)this.claimedPath[i]||this.addDefaultPlan(e,i,this.claimedPath)}}checkPatternAgainstPath(e,t,i){let s=0;for(;s<t.size;){if(i[s]){s++;continue}let r=this.getUnclaimedSpaceAvailable(i,t.size,s);if(r<e.getMinRequiredPathSteps()){s++;continue}let o=this.pathTemplate.getPlanIfPatternMatch(e,t,s);if(o){let a=o.pathSteps;if(a===0){console.log("PathPlanEvaluator.checkPatternAgainstPath() pattern="+e.toString()+" used no steps"),s++;continue}if(a<=r){for(let h=0;h<a;h++)i[s]=o,s++;continue}}s++}}getUnclaimedSpaceAvailable(e,t,i){let s=0;for(let r=i;r<t;r++){if(e[r]!==null)return s;s++}return s}addDefaultPlan(e,t,i){let s=e.tiles[t],r=e.tiles[t+1];if(!r.open){this.addMinePlan(e,t,i);return}let o;if(s.isNeighborLeft(r))o=new Mt(s,r,1);else if(s.isNeighborRight(r))o=new _t(s,r,1);else if(s.isNeighborTop(r))o=new ut(s,r,1);else if(s.isNeighborBottom(r))o=new ht(s,r,1);else{console.log("addDefaultPlan() neighbor is not adjacent tile"),this.printPathDebug(e,t);return}i[t]=o}printPathDebug(e,t){console.log("DEBUG BAD INDEX: "+t);for(let i=0;i<e.size;i++)i==0?console.log("DEBUG step="+i+" "+e.tiles[i].origin.toString()):console.log("DEBUG step="+i+" "+e.tiles[i].origin.toString()+" adjacent="+e.tiles[i].isAdjacentTo(e[i-1])+" neighbor="+e.tiles[i].isNeighborTile(e.tiles[i-1])+(i===t?" <-----":""))}addMinePlan(e,t,i,s){let r=e.tiles[t+1];if(r.open)return;let o=e.tiles[t],a;if(o.isNeighborLeft(r))a=new so(o,r,1,this.tileMinedLogic,s);else if(o.isNeighborRight(r))a=new ro(o,r,1,this.tileMinedLogic,s);else if(o.isNeighborTop(r))a=new oo(o,r,1,this.tileMinedLogic,s);else if(o.isNeighborBottom(r))a=new no(o,r,1,this.tileMinedLogic,s);else{console.log("addMinePlan() neighbor is not adjacent tile");return}i[t]=a}};var lo=class extends K{constructor(e,t){super(),this.vectorField=e,this.pathFinder=new Or,this.directLinePathFinder=new Ir,this.pathPlanEvaluator=new ao(t),this.path=new br}findPathPlan(e,t,i,s,r){this.path.reset(),ne.startTime("PathFinding"),this.pathFinder.findPath(this.path,e,t,!0,s,r),ne.endTime("PathFinding"),this.path.size>0?this.pathPlanEvaluator.evaluatePath(this.path,i,!1):i.length=0}findDirectPathPlan(e,t,i){this.path.reset(),ne.startTime("DirectPath");let s=this.directLinePathFinder.findPath(this.path,e,t);return ne.endTime("DirectPath"),s?(this.path.size>0?this.pathPlanEvaluator.evaluatePath(this.path,i,!0):i.length=0,!0):!1}findContinuedDirectPathPlan2(e,t,i){if(i.length<1)return this.findDirectPathPlan(e,t,i);let s=i[0];if(s.endTile===t)return i.length=1,!0;this.path.reset(),ne.startTime("DirectPath");let r=this.directLinePathFinder.findPath(this.path,s.endTile,t);if(ne.endTime("DirectPath"),!r)return this.findDirectPathPlan(e,t,i);if(this.path.size===1){console.log("PathPlanFinder.findContinuedDirectPathPlan() resulting path length 1"),i.length=0;return}return this.path.size>0?(this.pathPlanEvaluator.connectPathToPlan2(this.path,i,1,!0),!0):(console.log("PathPlanFinder.findContinuedDirectPathPlan() did not find a good path."),i.length=0,!1)}findContinuedPathPlan2(e,t,i,s,r){if(i.length<1){this.findPathPlan(e,t,i,s,r);return}let o=i[0];if(o.endTile===t)return i.length=1,!0;if(this.path.reset(),ne.startTime("PathFinding"),this.pathFinder.findPath(this.path,o.endTile,t,!0,s,r),ne.endTime("PathFinding"),this.path.size===1){console.log("NORMAL PATH SIZE 1.  dest="+t.origin.toString()+" path[0]="+this.path.tiles[0].origin.toString()),i.length=0;return}this.path.size>0?this.pathPlanEvaluator.connectPathToPlan2(this.path,i,1,r):console.log("PathPlanFinder.findContinuedPathPlan2() did not find a good path.")}findClosestPathStepIndex(e,t){let i=null,s=1e6,r=-1,o=t.origin;for(let a=0;a<e.length;a++){let h=e[a];if(!h)continue;let m=h.endTile;if(m===t)return a;let p=o.distanceSquared(m.origin);(!i||s>p)&&(i=m,s=p,r=a)}return r}findMonsterPathPlan(e,t,i){this.findPathPlan(e,t,i,!0,!1)}findPartyCharacterPathPlan(e,t,i,s){if(e===t){console.log("findPartyCharacterPathPlan() start == destination."),i.length=0;return}if(this.vectorField.tileHealthNegligible){if(s||i.length===0){if(this.findDirectPathPlan(e,t,i))return}else if(this.findContinuedDirectPathPlan2(e,t,i))return}s||i.length===0?this.findPathPlan(e,t,i,!0,this.vectorField.tileHealthNegligible):this.findContinuedPathPlan2(e,t,i,!0,this.vectorField.tileHealthNegligible)}resetFull(){this.path.reset()}resetForPrestige(){this.resetFull()}};var Ai=class extends ci{constructor(){super()}performAction(e,t,i){let s=e.position;s.pathPlan.length>0&&e.followPathPlan(t,i),s.pathPlan.length===0&&(e.position.resetPathPlan(),e.turnAction=null)}isMovementAction(){return!0}toString(){return"MoveTurnAction"}};var ho=class extends Ks{constructor(e,t,i){super(e),this.pathPlanFinder=t,this.moveTurnAction=i}applyIfAppropriate(e){let t=e.position;if(t.pathPlan.length===0&&(Date.now()-e.pathCompletedTime<3e3||Math.random()<.75))return!1;let i=t.tile;if(!i)return!1;let s=e.target;if(t.pathPlan.length===0){let r=this.chooseRandomNeighborTile(i);if(!r)return!1;s.setTargetTile(r,null,this.behaviorId),this.pathPlanFinder.findMonsterPathPlan(e.position.tile,r,e.position.pathPlan)}if(s.behaviorId===this.behaviorId)return e.turnAction=this.moveTurnAction,!0}chooseRandomNeighborTile(e){let t=null,i=Math.random();if(i<.15){if(t=e.getNeighborLeft(),this.isGoodTargetTile(t)||(t=e.getNeighborRight(),this.isGoodTargetTile(t)))return t}else if(i<.3){if(t=e.getNeighborRight(),this.isGoodTargetTile(t)||(t=e.getNeighborLeft(),this.isGoodTargetTile(t)))return t}else if(i<.45){if(t=e.getNeighborTopLeft(),this.isGoodTargetTile(t)||(t=e.getNeighborTopRight(),this.isGoodTargetTile(t)))return t}else if(i<.6){if(t=e.getNeighborTopRight(),this.isGoodTargetTile(t)||(t=e.getNeighborTopLeft(),this.isGoodTargetTile(t)))return t}else if(i<.75){if(t=e.getNeighborBottomLeft(),this.isGoodTargetTile(t)||(t=e.getNeighborBottomRight(),this.isGoodTargetTile(t)))return t}else if(i<.9&&(t=e.getNeighborBottomRight(),this.isGoodTargetTile(t)||(t=e.getNeighborBottomLeft(),this.isGoodTargetTile(t))))return t;return null}isGoodTargetTile(e){if(!e||!e.isTraversable())return!1;let t=e.getNeighborBottom();return!(!t||t.isTraversable())}};var uo=class{constructor(e){this.moveTurnAction=new Ai,this.monsterWanderBehavior=new ho(1,e,this.moveTurnAction),this.brainById={},this.basicMonsterBrain=new Xs(Ae.BASIC,[this.monsterWanderBehavior]),this.brainById[this.basicMonsterBrain.id]=this.basicMonsterBrain}getBrainById(e){return this.brainById[e]}};var co=class extends K{constructor(e,t){super(),this.monsterSpritesheet=e,this.characterBrains=t,this.monsterCharacterCache=new Zs,this.baseMonsterDamage=5,this.monsterDamageIncrease=.6,this.monsterDamageHundredFactor=.1,this.baseMonsterHealth=5,this.monsterHealthIncrease=.6,this.monsterHealthHundredFactor=.1}createMonsterAtTile(e,t){let i=this.createMonsterCharacter(e),s=t.origin;return i.position.setTileAndOriginPosition(t,s.x,s.y),i}createMonsterCharacter(e){let t=this.monsterSpritesheet.getSprite(e.spriteName);if(t==null)return console.log("CharacterCreator.createMonsterCharacter() Failed to find monster sprite: "+e.spriteName),null;let i=this.characterBrains.getBrainById(e.brainId);if(!i)return console.log("CharacterCreator.createMonsterCharacter() Failed to find monster brain id: "+e.brainId),null;let s=this.monsterCharacterCache.get();return s.set(i,t,e),s}resetFull(){this.monsterCharacterCache.resetCache()}resetForPrestige(){this.resetFull()}};var Yl={ANT:new Ne("1",g.PEST_ANT_10,Ae.BASIC),SPIDER1:new Ne("2",g.PEST_SPIDER_20,Ae.BASIC),SPIDER2:new Ne("3",g.PEST_SPIDER_21,Ae.BASIC),SPIDER3:new Ne("4",g.PEST_SPIDER_22,Ae.BASIC),WORM1:new Ne("5",g.PEST_WORM_30,Ae.BASIC),WORM2:new Ne("6",g.PEST_WORM_31,Ae.BASIC),WORM4:new Ne("7",g.PEST_WORM_33,Ae.BASIC),WORM5:new Ne("8",g.PEST_WORM_34,Ae.BASIC),BALL:new Ne("9",g.PEST_BALL,Ae.BASIC),SLUG1:new Ne("10",g.PEST_SLUG_70,Ae.BASIC),SLUG2:new Ne("11",g.PEST_SLUG_71,Ae.BASIC),SNAIL1:new Ne("12",g.PEST_SNAIL_72,Ae.BASIC),SNAIL2:new Ne("13",g.PEST_SNAIL_73,Ae.BASIC),SLIME01:new Ne("14",g.SLIME_BLUE_00,Ae.BASIC),SLIME02:new Ne("15",g.SLIME_BROWN_01,Ae.BASIC),SLIME03:new Ne("16",g.SLIME_WHITE_02,Ae.BASIC),SLIME04:new Ne("17",g.SLIME_GREEN_03,Ae.BASIC),SLIME05:new Ne("18",g.SLIME_PINK_04,Ae.BASIC),SLIME06:new Ne("19",g.SLIME_MUCUS_GREEN_40,Ae.BASIC),SLIME07:new Ne("20",g.SLIME_MUCUS_BLUE_41,Ae.BASIC),SLIME08:new Ne("21",g.SLIME_CORRODED_20,Ae.BASIC),SLIME09:new Ne("22",g.SLIME_SEEING_21,Ae.BASIC),SLIME10:new Ne("23",g.SLIME_ORANGE_22,Ae.BASIC),SLIME11:new Ne("24",g.SLIME_MINI_BLUE_30,Ae.BASIC),SLIME12:new Ne("25",g.SLIME_MINI_31,Ae.BASIC),SLIME13:new Ne("26",g.SLIME_MINI_ORANGE_32,Ae.BASIC)};function Ld(){let l={};for(let e of Object.values(Yl))l[e.id]=e;return l}function bd(){let l=[];for(let e of Object.values(Yl))l.push(e);return l}var Kl=Ld(),ol=bd();function Xl(){let l=[];return l.push(ol[ze.randomInt(ol.length)]),l.push(ol[ze.randomInt(ol.length)]),l}var Xe={SKY_LAYER:new Jt(ge.SKY,-1),GRASS_LAYER:new Jt(ge.GRASS,-1),DIRT_LAYER:new Jt(ge.DIRT,1)};function Id(){let l=[];l.push(Xe.SKY_LAYER),l.push(Xe.GRASS_LAYER),l.push(Xe.DIRT_LAYER);let e=2;for(let C=0;C<St.length;C++)l.push(new Jt(St[C],e++));Xe.SKY_LAYER.minDepth=-1e6,Xe.SKY_LAYER.maxDepth=-1,Xe.SKY_LAYER.baseHealth=new d(20),Xe.GRASS_LAYER.minDepth=-1,Xe.GRASS_LAYER.maxDepth=0,Xe.GRASS_LAYER.baseHealth=new d(20),Xe.GRASS_LAYER.baseOre=new d(1),Xe.SKY_LAYER.initializeLayerValues(1,1,.05,new d(1),new d(0));let t=1,i=10,s=.1,r=new d(.8),o=new d(12),a=new d(10),h=new d(5),m=2,p=.1,f=.1,S=Xe.GRASS_LAYER,E=500,w=2;for(let C=w;C<l.length;C++){let T=l[C];T.monsterDescriptions=Xl(),T.initializeLayerValues(t,i,s,r,o),C<l.length-1?T.initializeLayer(S,E,C==w):T.initializeLayer(S,-1,!1),S=T,r.mul(h),o.mul(a),i*=m,s+=p,p+=f}return l}var et=Id();function xd(){let l={};for(let e=0;e<et.length;e++){let t=et[e];l[t.id]=t}return l}var jl=xd();function Zl(l){for(let e=0;e<et.length;e++){let t=et[e];if(t.minDepth<=l&&l<t.maxDepth)return t}return et[et.length-1]}function ql(l,e){let t=l;for(;t&&t.prevLayer&&t.baseHealth.greaterThan(e);)t=t.prevLayer;for(;t&&t.nextLayer&&t.maxHealth.lessThan(e);)t=t.nextLayer;return t||(console.log("LayerDescriptions.findLayerForHealth() null layer. using default"),l)}var Mi=class{constructor(e){this.N=624,this.M=397,this.MATRIX_A=2567483615,this.UPPER_MASK=2147483648,this.LOWER_MASK=2147483647,this.randFactor=1/4294967296,this.mag01=[0,this.MATRIX_A],this.mt=new Array(this.N),this.mti=this.N+1,this.setSeed(e)}setSeed(e){this.mti=this.N+1,this.initGenRand2(e)}initGenRand2(e){for(this.mt[0]=e&4294967295,this.mti=1;this.mti<this.N;this.mti++)this.mt[this.mti]=1812433253*(this.mt[this.mti-1]^this.mt[this.mti-1]>>30)+this.mti,this.mt[this.mti]&=4294967295}genRandInt(){var e;if(this.mag01[0]=0,this.mag01[1]=this.MATRIX_A,this.mti>=this.N){var t;for(t=0;t<this.N-this.M;t++)e=this.mt[t]&this.UPPER_MASK|this.mt[t+1]&this.LOWER_MASK,this.mt[t]=this.mt[t+this.M]^e>>>1^this.mag01[e&1];for(;t<this.N-1;t++)e=this.mt[t]&this.UPPER_MASK|this.mt[t+1]&this.LOWER_MASK,this.mt[t]=this.mt[t+(this.M-this.N)]^e>>>1^this.mag01[e&1];e=this.mt[this.N-1]&this.UPPER_MASK|this.mt[0]&this.LOWER_MASK,this.mt[this.N-1]=this.mt[this.M-1]^e>>>1^this.mag01[e&1],this.mti=0}return e=this.mt[this.mti++],e^=e>>>11,e^=e<<7&2636928640,e^=e<<15&4022730752,e^=e>>>18,e>>>0}random(){return this.genRandInt()*this.randFactor}randomInt(e){return this.random()*e|0}};var Je=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],Od=.5*(Math.sqrt(3)-1),mo=(3-Math.sqrt(3))/6,vd=1/3,vt=1/6,po=class{constructor(e){this.perm=this.initializePerm(e)}initializePerm(e){let t=new Mi(e),i=new Array(256);for(let r=0;r<i.length;r++)i[r]=Math.floor(t.random()*256);let s=new Array(512);for(let r=0;r<s.length;r++)s[r]=i[r&255];return s}noise(e,t){let i=(e+t)*Od,s=Math.floor(e+i),r=Math.floor(t+i),o=(s+r)*mo,a=s-o,h=r-o,m=e-a,p=t-h,f,S;m>p?(f=1,S=0):(f=0,S=1);let E=m-f+mo,w=p-S+mo,C=m-1+2*mo,T=p-1+2*mo,A=s&255,N=r&255,P=this.perm[A+this.perm[N]]%12,M=this.perm[A+f+this.perm[N+S]]%12,y=this.perm[A+1+this.perm[N+1]]%12,V,O,Z,Q=.5-m*m-p*p;Q<0?V=0:(Q*=Q,V=Q*Q*(Je[P][0]*m+Je[P][1]*p));let D=.5-E*E-w*w;D<0?O=0:(D*=D,O=D*D*(Je[M][0]*E+Je[M][1]*w));let k=.5-C*C-T*T;return k<0?Z=0:(k*=k,Z=k*k*(Je[y][0]*C+Je[y][1]*T)),70*(V+O+Z)}noise3d(e,t,i){let s=(e+t+i)*vd,r=Math.floor(e+s),o=Math.floor(t+s),a=Math.floor(i+s),h=(r+o+a)*vt,m=r-h,p=o-h,f=a-h,S=e-m,E=t-p,w=i-f,C,T,A,N,P,M;S>=E?E>=w?(C=1,T=0,A=0,N=1,P=1,M=0):S>=w?(C=1,T=0,A=0,N=1,P=0,M=1):(C=0,T=0,A=1,N=1,P=0,M=1):E<w?(C=0,T=0,A=1,N=0,P=1,M=1):S<w?(C=0,T=1,A=0,N=0,P=1,M=1):(C=0,T=1,A=0,N=1,P=1,M=0);let y=S-C+vt,V=E-T+vt,O=w-A+vt,Z=S-N+2*vt,Q=E-P+2*vt,D=w-M+2*vt,k=S-1+3*vt,L=E-1+3*vt,b=w-1+3*vt,Ee=r&255,pe=o&255,_e=a&255,X=this.perm[Ee+this.perm[pe+this.perm[_e]]]%12,G=this.perm[Ee+C+this.perm[pe+T+this.perm[_e+A]]]%12,ie=this.perm[Ee+N+this.perm[pe+P+this.perm[_e+M]]]%12,je=this.perm[Ee+1+this.perm[pe+1+this.perm[_e+1]]]%12,$e,oe,se,W,U=.6-S*S-E*E-w*w;U<0?$e=0:(U*=U,$e=U*U*(Je[X][0]*S+Je[X][1]*E+Je[X][2]*w));let Zt=.6-y*y-V*V-O*O;Zt<0?oe=0:(Zt*=Zt,oe=Zt*Zt*(Je[G][0]*y+Je[G][1]*V+Je[G][2]*O));let Dt=.6-Z*Z-Q*Q-D*D;Dt<0?se=0:(Dt*=Dt,se=Dt*Dt*(Je[ie][0]*Z+Je[ie][1]*Q+Je[ie][2]*D));let bt=.6-k*k-L*L-b*b;return bt<0?W=0:(bt*=bt,W=bt*bt*(Je[je][0]*k+Je[je][1]*L+Je[je][2]*b)),32*($e+oe+se+W)}};var ot=class{constructor(e,t,i,s,r,o){this.simplexNoise=new po(e),this.terrainAmplitude=t,this.terrainLacunarity=i,this.terrainGain=s,this.terrainOctaves=r,this.terrainFrequencyMultiplier=o}calculateNoise(e,t){let i=0,s=this.terrainAmplitude,r=this.terrainFrequencyMultiplier;for(let o=0;o<this.terrainOctaves;o++)i+=s*this.simplexNoise.noise(e*r,t*r),s*=this.terrainGain,r*=this.terrainLacunarity;return i}};var _i=class{getLayerDescription(){}isLayerForGrid(e,t){}isLayerForTile(e,t){}isOreTileSupported(){}isGoldTileSupported(){}isRubyTileSupported(){}isUpgradeTileSupported(){}assignTileToOreType(e){}assignTileToGoldType(e){}assignTileToUpgradeType(e){}assignTileToRubyType(e){}assignTileTerrain(e,t){}};var Dd=60,Ut=class extends _i{constructor(e,t,i,s){super(),this.layerDescription=e,this.maxTileDepth=e.maxDepth,this.minTileDepth=e.minDepth,this.adjustedMinTileDepth=this.minTileDepth-Dd,this.fbm=t,this.goldGenerated=i,this.rubyGenerated=s}getLayerDescription(){return this.layerDescription}isInAdjustedRange(e){return e>=this.adjustedMinTileDepth&&e<this.maxTileDepth}isLayerForGrid(e,t){return!(t<this.adjustedMinTileDepth||e>this.maxTileDepth)}isLayerForTile(e,t){if(!this.isInAdjustedRange(t))return!1;let i=e.origin,s=n.tile.size*this.fbm.calculateNoise(i.y,i.x),r=this.minTileDepth+s;return t>=r}isOreTileSupported(){return this.layerDescription.oreTileType!==null}isGoldTileSupported(){return this.goldGenerated&&this.layerDescription.goldTileType!==null}isRubyTileSupported(){return this.rubyGenerated&&this.layerDescription.rubyTileType!==null}isUpgradeTileSupported(){return this.layerDescription.upgradeTileType!==null}assignTileToOreType(e){e.tileInit(!1,this.layerDescription.oreTileType)}assignTileToGoldType(e){e.tileInit(!1,this.layerDescription.goldTileType)}assignTileToUpgradeType(e){e.tileInit(!1,this.layerDescription.upgradeTileType)}assignTileToRubyType(e){e.tileInit(!1,this.layerDescription.rubyTileType)}assignTileTerrain(e,t){e.tileInit(t,this.layerDescription.primaryTileType)}};var go=class extends _i{constructor(e,t){super(),this.tileType=e,this.layerDescription=t,this.maxSkyTileDepth=20}getLayerDescription(){return this.layerDescription}isLayerForGrid(e,t){return e<this.maxSkyTileDepth}isLayerForTile(e,t){return t<this.maxSkyTileDepth}isOreTileSupported(){return!1}isGoldTileSupported(){return!1}isRubyTileSupported(){return!1}isUpgradeTileSupported(){return!1}assignTileToOreType(e){e.tileInit(!0,this.tileType)}assignTileToGoldType(e){e.tileInit(!0,this.tileType)}assignTileToUpgradeType(e){e.tileInit(!0,this.tileType)}assignTileToRubyType(e){e.tileInit(!0,this.tileType)}assignTileTerrain(e,t){e.tileInit(!0,this.tileType)}};var fo=class extends Ut{constructor(e,t){super(e,t)}isLayerForTile(e,t){if(!this.isInAdjustedRange(t))return!1;let i=e.origin,s=n.tile.size*this.fbm.calculateNoise(i.x,i.x),r=this.minTileDepth+s-5;return t>=r}};var To=class extends Ut{constructor(e,t){super(e,t)}isLayerForTile(e,t){if(!this.isInAdjustedRange(t))return!1;let i=e.origin,s=n.tile.size*this.fbm.calculateNoise(i.x,i.x),r=this.minTileDepth+s-5;return t>=r}};var Eo=class{constructor(e){this.shiftValue=2.2734306378540854,this.indexFbm=new ot(e,1,2.1,.7,5,5e-4),this.indexLookup={},this.indexLookup["0.00"]=0,this.indexLookup["0.01"]=0,this.indexLookup["0.02"]=0,this.indexLookup["0.03"]=0,this.indexLookup["0.04"]=0,this.indexLookup["0.05"]=0,this.indexLookup["0.06"]=0,this.indexLookup["0.07"]=0,this.indexLookup["0.08"]=0,this.indexLookup["0.09"]=0,this.indexLookup["0.10"]=0,this.indexLookup["0.11"]=0,this.indexLookup["0.12"]=0,this.indexLookup["0.13"]=0,this.indexLookup["0.14"]=0,this.indexLookup["0.15"]=0,this.indexLookup["0.16"]=0,this.indexLookup["0.17"]=0,this.indexLookup["0.18"]=0,this.indexLookup["0.19"]=0,this.indexLookup["0.20"]=0,this.indexLookup["0.21"]=0,this.indexLookup["0.22"]=0,this.indexLookup["0.23"]=0,this.indexLookup["0.24"]=0,this.indexLookup["0.25"]=0,this.indexLookup["0.26"]=0,this.indexLookup["0.27"]=0,this.indexLookup["0.28"]=0,this.indexLookup["0.29"]=0,this.indexLookup["0.30"]=0,this.indexLookup["0.31"]=0,this.indexLookup["0.32"]=0,this.indexLookup["0.33"]=0,this.indexLookup["0.34"]=0,this.indexLookup["0.35"]=0,this.indexLookup["0.36"]=0,this.indexLookup["0.37"]=0,this.indexLookup["0.38"]=0,this.indexLookup["0.39"]=0,this.indexLookup["0.40"]=0,this.indexLookup["0.41"]=0,this.indexLookup["0.42"]=0,this.indexLookup["0.43"]=0,this.indexLookup["0.44"]=0,this.indexLookup["0.45"]=0,this.indexLookup["0.46"]=0,this.indexLookup["0.47"]=0,this.indexLookup["0.48"]=0,this.indexLookup["0.49"]=0,this.indexLookup["0.50"]=0,this.indexLookup["0.51"]=0,this.indexLookup["0.52"]=0,this.indexLookup["0.53"]=0,this.indexLookup["0.54"]=0,this.indexLookup["0.55"]=0,this.indexLookup["0.56"]=0,this.indexLookup["0.57"]=0,this.indexLookup["0.58"]=0,this.indexLookup["0.59"]=0,this.indexLookup["0.60"]=0,this.indexLookup["0.61"]=0,this.indexLookup["0.62"]=0,this.indexLookup["0.63"]=0,this.indexLookup["0.64"]=0,this.indexLookup["0.65"]=0,this.indexLookup["0.66"]=0,this.indexLookup["0.67"]=0,this.indexLookup["0.68"]=0,this.indexLookup["0.69"]=0,this.indexLookup["0.70"]=0,this.indexLookup["0.71"]=0,this.indexLookup["0.72"]=0,this.indexLookup["0.73"]=0,this.indexLookup["0.74"]=0,this.indexLookup["0.75"]=0,this.indexLookup["0.76"]=0,this.indexLookup["0.77"]=0,this.indexLookup["0.78"]=0,this.indexLookup["0.79"]=0,this.indexLookup["0.80"]=0,this.indexLookup["0.81"]=0,this.indexLookup["0.82"]=0,this.indexLookup["0.83"]=0,this.indexLookup["0.84"]=0,this.indexLookup["0.85"]=0,this.indexLookup["0.86"]=0,this.indexLookup["0.87"]=0,this.indexLookup["0.88"]=0,this.indexLookup["0.89"]=0,this.indexLookup["0.90"]=0,this.indexLookup["0.91"]=0,this.indexLookup["0.92"]=.01,this.indexLookup["0.93"]=.01,this.indexLookup["0.94"]=.01,this.indexLookup["0.95"]=.01,this.indexLookup["0.96"]=.01,this.indexLookup["0.97"]=.01,this.indexLookup["0.98"]=.01,this.indexLookup["0.99"]=.01,this.indexLookup["1.00"]=.01,this.indexLookup["1.01"]=.01,this.indexLookup["1.02"]=.01,this.indexLookup["1.03"]=.01,this.indexLookup["1.04"]=.01,this.indexLookup["1.05"]=.01,this.indexLookup["1.06"]=.02,this.indexLookup["1.07"]=.02,this.indexLookup["1.08"]=.02,this.indexLookup["1.09"]=.02,this.indexLookup["1.10"]=.02,this.indexLookup["1.11"]=.02,this.indexLookup["1.12"]=.02,this.indexLookup["1.13"]=.02,this.indexLookup["1.14"]=.02,this.indexLookup["1.15"]=.03,this.indexLookup["1.16"]=.03,this.indexLookup["1.17"]=.03,this.indexLookup["1.18"]=.03,this.indexLookup["1.19"]=.03,this.indexLookup["1.20"]=.03,this.indexLookup["1.21"]=.04,this.indexLookup["1.22"]=.04,this.indexLookup["1.23"]=.04,this.indexLookup["1.24"]=.04,this.indexLookup["1.25"]=.04,this.indexLookup["1.26"]=.04,this.indexLookup["1.27"]=.05,this.indexLookup["1.28"]=.05,this.indexLookup["1.29"]=.05,this.indexLookup["1.30"]=.05,this.indexLookup["1.31"]=.05,this.indexLookup["1.32"]=.06,this.indexLookup["1.33"]=.06,this.indexLookup["1.34"]=.06,this.indexLookup["1.35"]=.06,this.indexLookup["1.36"]=.07,this.indexLookup["1.37"]=.07,this.indexLookup["1.38"]=.07,this.indexLookup["1.39"]=.07,this.indexLookup["1.40"]=.08,this.indexLookup["1.41"]=.08,this.indexLookup["1.42"]=.08,this.indexLookup["1.43"]=.08,this.indexLookup["1.44"]=.09,this.indexLookup["1.45"]=.09,this.indexLookup["1.46"]=.09,this.indexLookup["1.47"]=.1,this.indexLookup["1.48"]=.1,this.indexLookup["1.49"]=.1,this.indexLookup["1.50"]=.11,this.indexLookup["1.51"]=.11,this.indexLookup["1.52"]=.11,this.indexLookup["1.53"]=.12,this.indexLookup["1.54"]=.12,this.indexLookup["1.55"]=.12,this.indexLookup["1.56"]=.13,this.indexLookup["1.57"]=.13,this.indexLookup["1.58"]=.13,this.indexLookup["1.59"]=.14,this.indexLookup["1.60"]=.14,this.indexLookup["1.61"]=.15,this.indexLookup["1.62"]=.15,this.indexLookup["1.63"]=.15,this.indexLookup["1.64"]=.16,this.indexLookup["1.65"]=.16,this.indexLookup["1.66"]=.17,this.indexLookup["1.67"]=.17,this.indexLookup["1.68"]=.17,this.indexLookup["1.69"]=.18,this.indexLookup["1.70"]=.18,this.indexLookup["1.71"]=.19,this.indexLookup["1.72"]=.19,this.indexLookup["1.73"]=.2,this.indexLookup["1.74"]=.2,this.indexLookup["1.75"]=.21,this.indexLookup["1.76"]=.21,this.indexLookup["1.77"]=.21,this.indexLookup["1.78"]=.22,this.indexLookup["1.79"]=.22,this.indexLookup["1.80"]=.23,this.indexLookup["1.81"]=.23,this.indexLookup["1.82"]=.24,this.indexLookup["1.83"]=.24,this.indexLookup["1.84"]=.25,this.indexLookup["1.85"]=.25,this.indexLookup["1.86"]=.26,this.indexLookup["1.87"]=.26,this.indexLookup["1.88"]=.27,this.indexLookup["1.89"]=.27,this.indexLookup["1.90"]=.28,this.indexLookup["1.91"]=.29,this.indexLookup["1.92"]=.29,this.indexLookup["1.93"]=.3,this.indexLookup["1.94"]=.3,this.indexLookup["1.95"]=.31,this.indexLookup["1.96"]=.31,this.indexLookup["1.97"]=.32,this.indexLookup["1.98"]=.32,this.indexLookup["1.99"]=.33,this.indexLookup["2.00"]=.34,this.indexLookup["2.01"]=.34,this.indexLookup["2.02"]=.35,this.indexLookup["2.03"]=.35,this.indexLookup["2.04"]=.36,this.indexLookup["2.05"]=.36,this.indexLookup["2.06"]=.37,this.indexLookup["2.07"]=.38,this.indexLookup["2.08"]=.38,this.indexLookup["2.09"]=.39,this.indexLookup["2.10"]=.39,this.indexLookup["2.11"]=.4,this.indexLookup["2.12"]=.41,this.indexLookup["2.13"]=.41,this.indexLookup["2.14"]=.42,this.indexLookup["2.15"]=.42,this.indexLookup["2.16"]=.43,this.indexLookup["2.17"]=.44,this.indexLookup["2.18"]=.44,this.indexLookup["2.19"]=.45,this.indexLookup["2.20"]=.46,this.indexLookup["2.21"]=.46,this.indexLookup["2.22"]=.47,this.indexLookup["2.23"]=.47,this.indexLookup["2.24"]=.48,this.indexLookup["2.25"]=.49,this.indexLookup["2.26"]=.49,this.indexLookup["2.27"]=.5,this.indexLookup["2.28"]=.5,this.indexLookup["2.29"]=.51,this.indexLookup["2.30"]=.52,this.indexLookup["2.31"]=.52,this.indexLookup["2.32"]=.53,this.indexLookup["2.33"]=.53,this.indexLookup["2.34"]=.54,this.indexLookup["2.35"]=.55,this.indexLookup["2.36"]=.55,this.indexLookup["2.37"]=.56,this.indexLookup["2.38"]=.57,this.indexLookup["2.39"]=.57,this.indexLookup["2.40"]=.58,this.indexLookup["2.41"]=.58,this.indexLookup["2.42"]=.59,this.indexLookup["2.43"]=.6,this.indexLookup["2.44"]=.6,this.indexLookup["2.45"]=.61,this.indexLookup["2.46"]=.61,this.indexLookup["2.47"]=.62,this.indexLookup["2.48"]=.63,this.indexLookup["2.49"]=.63,this.indexLookup["2.50"]=.64,this.indexLookup["2.51"]=.64,this.indexLookup["2.52"]=.65,this.indexLookup["2.53"]=.65,this.indexLookup["2.54"]=.66,this.indexLookup["2.55"]=.67,this.indexLookup["2.56"]=.67,this.indexLookup["2.57"]=.68,this.indexLookup["2.58"]=.68,this.indexLookup["2.59"]=.69,this.indexLookup["2.60"]=.69,this.indexLookup["2.61"]=.7,this.indexLookup["2.62"]=.71,this.indexLookup["2.63"]=.71,this.indexLookup["2.64"]=.72,this.indexLookup["2.65"]=.72,this.indexLookup["2.66"]=.73,this.indexLookup["2.67"]=.73,this.indexLookup["2.68"]=.74,this.indexLookup["2.69"]=.74,this.indexLookup["2.70"]=.75,this.indexLookup["2.71"]=.75,this.indexLookup["2.72"]=.76,this.indexLookup["2.73"]=.76,this.indexLookup["2.74"]=.77,this.indexLookup["2.75"]=.77,this.indexLookup["2.76"]=.78,this.indexLookup["2.77"]=.78,this.indexLookup["2.78"]=.79,this.indexLookup["2.79"]=.79,this.indexLookup["2.80"]=.8,this.indexLookup["2.81"]=.8,this.indexLookup["2.82"]=.8,this.indexLookup["2.83"]=.81,this.indexLookup["2.84"]=.81,this.indexLookup["2.85"]=.82,this.indexLookup["2.86"]=.82,this.indexLookup["2.87"]=.83,this.indexLookup["2.88"]=.83,this.indexLookup["2.89"]=.83,this.indexLookup["2.90"]=.84,this.indexLookup["2.91"]=.84,this.indexLookup["2.92"]=.85,this.indexLookup["2.93"]=.85,this.indexLookup["2.94"]=.85,this.indexLookup["2.95"]=.86,this.indexLookup["2.96"]=.86,this.indexLookup["2.97"]=.86,this.indexLookup["2.98"]=.87,this.indexLookup["2.99"]=.87,this.indexLookup["3.00"]=.87,this.indexLookup["3.01"]=.88,this.indexLookup["3.02"]=.88,this.indexLookup["3.03"]=.88,this.indexLookup["3.04"]=.89,this.indexLookup["3.05"]=.89,this.indexLookup["3.06"]=.89,this.indexLookup["3.07"]=.9,this.indexLookup["3.08"]=.9,this.indexLookup["3.09"]=.9,this.indexLookup["3.10"]=.9,this.indexLookup["3.11"]=.91,this.indexLookup["3.12"]=.91,this.indexLookup["3.13"]=.91,this.indexLookup["3.14"]=.92,this.indexLookup["3.15"]=.92,this.indexLookup["3.16"]=.92,this.indexLookup["3.17"]=.92,this.indexLookup["3.18"]=.93,this.indexLookup["3.19"]=.93,this.indexLookup["3.20"]=.93,this.indexLookup["3.21"]=.93,this.indexLookup["3.22"]=.93,this.indexLookup["3.23"]=.94,this.indexLookup["3.24"]=.94,this.indexLookup["3.25"]=.94,this.indexLookup["3.26"]=.94,this.indexLookup["3.27"]=.94,this.indexLookup["3.28"]=.95,this.indexLookup["3.29"]=.95,this.indexLookup["3.30"]=.95,this.indexLookup["3.31"]=.95,this.indexLookup["3.32"]=.95,this.indexLookup["3.33"]=.96,this.indexLookup["3.34"]=.96,this.indexLookup["3.35"]=.96,this.indexLookup["3.36"]=.96,this.indexLookup["3.37"]=.96,this.indexLookup["3.38"]=.96,this.indexLookup["3.39"]=.96,this.indexLookup["3.40"]=.97,this.indexLookup["3.41"]=.97,this.indexLookup["3.42"]=.97,this.indexLookup["3.43"]=.97,this.indexLookup["3.44"]=.97,this.indexLookup["3.45"]=.97,this.indexLookup["3.46"]=.97,this.indexLookup["3.47"]=.97,this.indexLookup["3.48"]=.97,this.indexLookup["3.49"]=.98,this.indexLookup["3.50"]=.98,this.indexLookup["3.51"]=.98,this.indexLookup["3.52"]=.98,this.indexLookup["3.53"]=.98,this.indexLookup["3.54"]=.98,this.indexLookup["3.55"]=.98,this.indexLookup["3.56"]=.98,this.indexLookup["3.57"]=.98,this.indexLookup["3.58"]=.98,this.indexLookup["3.59"]=.98,this.indexLookup["3.60"]=.98,this.indexLookup["3.61"]=.98,this.indexLookup["3.62"]=.99,this.indexLookup["3.63"]=.99,this.indexLookup["3.64"]=.99,this.indexLookup["3.65"]=.99,this.indexLookup["3.66"]=.99,this.indexLookup["3.67"]=.99,this.indexLookup["3.68"]=.99,this.indexLookup["3.69"]=.99,this.indexLookup["3.70"]=.99,this.indexLookup["3.71"]=.99,this.indexLookup["3.72"]=.99,this.indexLookup["3.73"]=.99,this.indexLookup["3.74"]=.99,this.indexLookup["3.75"]=.99,this.indexLookup["3.76"]=.99,this.indexLookup["3.77"]=.99,this.indexLookup["3.78"]=.99,this.indexLookup["3.79"]=.99,this.indexLookup["3.80"]=.99,this.indexLookup["3.81"]=.99,this.indexLookup["3.82"]=.99,this.indexLookup["3.83"]=.99,this.indexLookup["3.84"]=.99,this.indexLookup["3.85"]=.99,this.indexLookup["3.86"]=.99,this.indexLookup["3.87"]=.99,this.indexLookup["3.88"]=.99,this.indexLookup["3.89"]=.99,this.indexLookup["3.90"]=.99,this.indexLookup["3.91"]=.99,this.indexLookup["3.92"]=.99,this.indexLookup["3.93"]=.99,this.indexLookup["3.94"]=.99,this.indexLookup["3.95"]=.99,this.indexLookup["3.96"]=.99,this.indexLookup["3.97"]=.99,this.indexLookup["3.98"]=.99,this.indexLookup["3.99"]=.99,this.indexLookup["4.00"]=.99,this.indexLookup["4.01"]=.99,this.indexLookup["4.02"]=.99,this.indexLookup["4.03"]=.99,this.indexLookup["4.04"]=.99,this.indexLookup["4.05"]=.99,this.indexLookup["4.06"]=.99,this.indexLookup["4.07"]=.99,this.indexLookup["4.08"]=.99,this.indexLookup["4.09"]=.99,this.indexLookup["4.10"]=.99,this.indexLookup["4.11"]=.99,this.indexLookup["4.12"]=.99,this.indexLookup["4.13"]=.99,this.indexLookup["4.14"]=.99,this.indexLookup["4.15"]=.99,this.indexLookup["4.16"]=.99,this.indexLookup["4.17"]=.99,this.indexLookup["4.18"]=.99,this.indexLookup["4.19"]=.99,this.indexLookup["4.20"]=.99,this.indexLookup["4.21"]=.99,this.indexLookup["4.22"]=.99,this.indexLookup["4.23"]=.99,this.indexLookup["4.24"]=.99,this.indexLookup["4.25"]=.99,this.indexLookup["4.26"]=.99,this.indexLookup["4.27"]=.99,this.indexLookup["4.28"]=.99,this.indexLookup["4.29"]=.99,this.indexLookup["4.30"]=.99,this.indexLookup["4.31"]=.99,this.indexLookup["4.32"]=.99,this.indexLookup["4.33"]=.99,this.indexLookup["4.34"]=.99,this.indexLookup["4.35"]=.99,this.indexLookup["4.36"]=.99,this.indexLookup["4.37"]=.99,this.indexLookup["4.38"]=.99,this.indexLookup["4.39"]=.99,this.indexLookup["4.40"]=.99,this.indexLookup["4.41"]=.99}getBucket(e){return e.toFixed(2)}getIndexFromFbm(e,t,i){if(i===1)return 0;let s=this.indexFbm.calculateNoise(e,t)+this.shiftValue;if(s<=0)return 0;let r=this.getBucket(s),o=this.indexLookup[r];return o?i*o|0:0}};var Co=class extends Us{constructor(e,t,i,s,r,o){super(i,s,r,o),this.typeName=e,this.colorName=t}};var Ri={};Ri.getDescription=(l,e)=>{let t=di.getSpriteName(l,e),i=Ri[t];return i||(i=new Co(l,e,t,!0,!1,!1),Ri[t]=i),i};var yi=class{constructor(e,t,i){this.fixtureNames=e,this.colorNames=t,this.probabilityDenominator=i}getFixtureDescription(e){if(this.fixtureNames.length===0||this.colorNames.length===0)return null;let t=e.randomInt(this.fixtureNames.length*this.probabilityDenominator);if(t>=this.fixtureNames.length)return null;let i=this.fixtureNames[t],s=this.colorNames.length===1?this.colorNames[0]:this.colorNames[e.randomInt(this.colorNames.length)];return Ri.getDescription(i,s)}};var Hi=class{constructor(e,t,i){this.ceilingDecoratorTheme=e,this.midDecoratorTheme=t,this.floorDecoratorTheme=i}decorateCavernTile(e,t){let i=e.grid,s=e.getNeighborTop(),r=e.getNeighborBottom(),o=s&&!s.open&&i===s.grid,a=r&&!r.open&&i===r.grid,h=null;o&&a?this.midDecoratorTheme&&(h=this.midDecoratorTheme.getFixtureDescription(t)):o?this.ceilingDecoratorTheme&&(h=this.ceilingDecoratorTheme.getFixtureDescription(t)):a?this.floorDecoratorTheme&&(h=this.floorDecoratorTheme.getFixtureDescription(t)):this.midDecoratorTheme&&(h=this.midDecoratorTheme.getFixtureDescription(t)),e.fixtureDescription=h}};var wo=class{constructor(){}getRandomLayerDecorator(e){let t=this.randomColorScheme(e),i=this.randomColorScheme(e);return[new Hi(this.randomCeilingTheme(e,t),this.randomMidTheme(e,i),this.randomFloorTheme(e,i)),new Hi(this.randomCeilingTheme(e,i),null,this.randomFloorTheme(e,t))]}randomCeilingTheme(e,t){let i=Nl[e.randomInt(Nl.length)];return new yi(i,t,2)}randomMidTheme(e,t){let i=Pl[e.randomInt(Pl.length)];return new yi(i,t,8)}randomFloorTheme(e,t){let i=Al[e.randomInt(Al.length)];return new yi(i,t,2)}randomColorScheme(e){let t=[];return t.push(this.functionRandomColor(e)),t.push(this.functionRandomColor(e)),t.push(this.functionRandomColor(e)),t}functionRandomColor(e){return Sl[e.randomInt(Sl.length)]}};var nl=class{constructor(){}generateTerrain(e){}generateTileBackgrounds(e){}};var So=class extends nl{constructor(e,t){super();let i=e;this.cavernFbmA=new ot(i++,.9,2,1.2,5,41e-5),this.cavernValueAMin=-6,this.cavernValueAMax=-1.3,this.cavernFbmB=new ot(i++,1.2,1.25,.9,5,.00261),this.cavernValueBMin=.8,this.cavernValueBMax=4.1,this.oreFbm=new ot(i++,1,1.5,1.4,5,.002),this.pointsFbm=new ot(i++,1,1.6,1.3,5,.001),this.upgradeFbm=new ot(i++,1,1.6,1.4,5,.001),this.rubyFbm=new ot(i++,1,1.6,1.4,5,.001),this.backgroundFbm=new ot(i++,1,2.1,.7,5,5e-4);let s=new ot(i++,.7,3.5,.8,5,1e-5);this.indexGenerator=new Eo(e),this.characterCreator=t,this.terrainLayers=[];for(let r=0;r<et.length;r++){let o=et[r];if(o===Xe.SKY_LAYER)this.terrainLayers.push(new go(ge.SKY,o));else if(o===Xe.GRASS_LAYER)this.terrainLayers.push(new fo(o,s));else if(o===Xe.DIRT_LAYER)this.terrainLayers.push(new To(o,s));else{let a=r>10,h=r>20;this.terrainLayers.push(new Ut(o,new ot(i++,1,3.5,.9,5,5e-5),a,h))}}this.terrainLayerById={};for(let r=0;r<this.terrainLayers.length;r++){let o=this.terrainLayers[r],a=o.getLayerDescription();if(!a){console.log("LayeredTerrainGenerator No layer description for layer index: "+r);continue}this.terrainLayerById[a.id]=o}this.cavernDecoratorsByLayer={},this.layerDecoratorConfig=new wo,this.rng=new Mi(i);for(let r=0;r<et.length;r++){let o=et[r];o!==Xe.SKY_LAYER&&(o===Xe.GRASS_LAYER?this.cavernDecoratorsByLayer[o.id]=[]:this.cavernDecoratorsByLayer[o.id]=this.layerDecoratorConfig.getRandomLayerDecorator(this.rng))}}generateTerrain(e){let t=this.findApplicableTerrainLayersForGrid(e),i=e.zones;for(let s=0;s<i.length;s++){let o=i[s].regions;for(let a=0;a<o.length;a++){let h=o[a].tiles;for(let m=0;m<h.length;m++)this.assignTileTerrain(h[m],t)}}for(let s=0;s<i.length;s++){let o=i[s].regions;for(let a=0;a<o.length;a++){let h=o[a].tiles;for(let m=0;m<h.length;m++){let p=h[m];!p.open||p.fixtureDescription||this.assignCavernDecorationToTile(p)}}}}generateTileBackgrounds(e){this.generateBackground(e)}isTileCavern(e){let t=e.tileType;if(!t){console.log("LayeredTerrainGenerator.isTileCavern() no tile type");return}let i=t.layerDescription;if(!i){console.log("LayeredTerrainGenerator.isTileCavern() no layer desc. tileType.icon="+t.iconFileName);return}if(!this.terrainLayerById[i.id]){console.log("LayeredTerrainGenerator.isTileCavern() no terrain layer. id="+i.id);return}let r=e.origin,o=this.cavernFbmA.calculateNoise(r.x,r.y);if(o>this.cavernValueAMin&&o<this.cavernValueAMax)return!0;let a=this.cavernFbmB.calculateNoise(r.x/2,r.y*2);return a>this.cavernValueBMin&&a<this.cavernValueBMax}generateBackground(e){let t=this;be.allTilesInGrid(e,function(i){t.assignTileBackgroundSprite(i)})}assignTileBackgroundSprite(e){let t=e.tileType;if(!t){console.log("LayeredTerrainGenerator.setTileBackground() ERROR Tile has no TileType!");return}let i=t.layerDescription;i?e.backgroundSprite=this.getBackgroundSprite(e.origin,i.primaryTileType.tileTypeBackground):t.tileTypeBackground&&(e.backgroundSprite=this.getBackgroundSprite(e.origin,t.tileTypeBackground))}getBackgroundSprite(e,t){let i=Math.abs(this.backgroundFbm.calculateNoise(e.x,e.y)+1),r=Math.min(Math.max(0,i/3.25),1)*(t.sprites.length-1)|0;return t.sprites[r]}assignCavernDecorationToTile(e){let t=e.tileType;if(!t)return;let i=t.layerDescription;if(!i)return;let s=this.cavernDecoratorsByLayer[i.id];if(!s||s.length===0)return;let r=e.origin;if(s[this.indexGenerator.getIndexFromFbm(r.x,r.y,s.length)].decorateCavernTile(e,this.rng),i.monsterDescriptions.length>0&&this.rng.random()<.01){let a=i.monsterDescriptions[this.rng.randomInt(i.monsterDescriptions.length)];this.characterCreator.createMonsterAtTile(a,e)}}assignTileTerrain(e,t){let i=this.findTerrainLayerForTile(e,t);i&&(i.assignTileTerrain(e,!1),this.isTileCavern(e)?e.open=!0:this.assignTypeForNonCavernTile(e,i),this.assignTileBackgroundSprite(e))}assignTypeForNonCavernTile(e,t){let i=e.origin,s=this.rng.random();if(s<.8&&t.isOreTileSupported()&&this.oreFbm.calculateNoise(i.y,i.x/3)<-3.55){t.assignTileToOreType(e);return}if(s<.4&&t.isGoldTileSupported()&&this.pointsFbm.calculateNoise(i.x,i.y)<-3.5){t.assignTileToGoldType(e);return}if(s<.02&&t.isUpgradeTileSupported()&&this.upgradeFbm.calculateNoise(i.x,i.y)<-3){t.assignTileToUpgradeType(e);return}if(s<.01&&t.isRubyTileSupported()&&this.rubyFbm.calculateNoise(i.x,i.y)<-3){t.assignTileToRubyType(e);return}}findApplicableTerrainLayersForGrid(e){let t=e.origin.y/n.tile.size,i=t+n.grid.gridTileHeight,s=[];for(let r=0;r<this.terrainLayers.length;r++){let o=this.terrainLayers[r];o.isLayerForGrid(t,i)&&s.push(o)}return s}findTerrainLayerForTile(e,t){let i=e.origin.y/n.tile.size;for(let s=t.length-1;s>=0;s--){let r=t[s];if(r.isLayerForTile(e,i))return r}return t.length>0?t[0]:null}};var ll=xl(Rl());var No=class{constructor(e){this.characterCreator=e}getGridKey(e){let t=e.getGridCol(),i=e.getGridRow(),s=t>=0?"":"n",r=i>=0?"":"n";return"G_"+s+Math.abs(t)+"_"+r+Math.abs(i)}generateGridStateForExport(e){if(!e)return console.log("GridSave.generateGridStateForExport() Null grid"),null;let t=this.generateState(e);return t?{key:this.getGridKey(e),origin:{x:e.origin.x,y:e.origin.y},state:t}:(console.log("GridSave.generateGridStateForExport() Failed to generate grid state"),null)}importGridState(e,t){if(!e)return console.log("GridSave.importGridState() FAIL. grid is null"),!1;let i=t.origin;return e.origin.set(i.x,i.y),e.initializeZonesForGrid(),this.loadStateInternal(e,t.state),!0}saveGridState(e){if(e.gridChangeCount===0)return;let t=this.generateState(e);if(!t)return console.log("GridSave.saveGridState() Failed to generate grid state"),!1;let i=this.getGridKey(e),s=JSON.stringify(t);if(!s)return console.log("GridSave.saveGridState() Failed to stringify state for grid: "+i),!1;let r=ll.compressToUTF16(s);return r?(localStorage.setItem(i,r),!0):(console.log("GridSave.saveGridState() Failed to compress state for grid: "+i),!1)}removeGridState(e){localStorage.removeItem(e)}loadGridState(e){let t=this.getGridKey(e),i=localStorage.getItem(t);if(i){let s=ll.decompressFromUTF16(i);if(s){let r=JSON.parse(s);if(r)return this.loadStateInternal(e,r),!0;console.log("GridSave.loadGridState() Failed to parse grid json.  grid: "+t)}else console.log("GridSave.loadGridState() Failed to decompress grid save state. grid: "+t)}return!1}generateState(e){let t={};return t.tiles=this.generateTileStateArray(e),t.characters=this.generateCharacterStateArray(e),t}loadStateInternal(e,t){this.loadTileStateArray(e,t.tiles),this.loadCharacterStateArray(e,t.characters)}generateTileStateArray(e){let t=this,i=[];return be.allTilesInGrid(e,s=>{i.push(t.generateTileState(s))}),i}loadTileStateArray(e,t){if(!t){console.log("GridSave.loadTileStateArray() no tile state array");return}let i=0,s=this;be.allTilesInGrid(e,r=>{s.loadTileState(r,t[i]),i++})}generateCharacterStateArray(e){let t=[];if(e.characters.length===0)return t;let i=e.getOriginTileCol(),s=e.getOriginTileRow();for(let r=0;r<e.characters.length;r++){let o=e.characters[r];if(!o.isMonster())continue;let a=this.generateCharacterState(i,s,o);a&&t.push(a)}return t}loadCharacterStateArray(e,t){if(!(!t||t.length===0))for(let i=0;i<t.length;i++)this.loadCharacterState(e,t[i])}generateTileState(e){let t={},i=0;return e.open&&(i+=1),e.lighting.sunlightFull&&(i+=2),e.lighting.sunlightPartial&&(i+=4),e.lighting.everVisibleToCharacter&&(i+=8),t.a=i,t.b=e.tileType.id,e.fixtureDescription&&(t.f={t:e.fixtureDescription.typeName,c:e.fixtureDescription.colorName}),t}loadTileState(e,t){if(!t){console.log("GridSave.loadTileState() no tile state");return}let i=t.a,s=t.b,r=(i&1)===1,o=Vl[s];e.tileInit(r,o);let a=(i&2)===2,h=(i&4)===4,m=(i&8)===8;if(e.lighting.sunlightPartial=h,a&&e.markAsSunlightFull(),m&&e.markTileAsEverVisible(),t.f){let p=t.f.t,f=t.f.c;e.fixtureDescription=Ri.getDescription(p,f)}}generateCharacterState(e,t,i){let s=i.position.tile;if(!s)return console.log("GridSave.generateCharacterState() character tile is null"),null;let r={};return r.c=s.getTileCol()-e,r.r=s.getTileRow()-t,r.d=i.getMonsterDescriptionId(),r}loadCharacterState(e,t){if(!t)return;let i=t.c,s=t.r,r=t.d,o=e.getGridTileLocal(i,s);if(!o){console.log("GridSave.loadCharacterState() Failed to find tile for character.  tileCol="+i+" tileRow="+s);return}let a=Kl[r];if(!a){console.log("GridSave.loadCharacterState() Failed to find monster description: "+r);return}this.characterCreator.createMonsterAtTile(a,o)}};var ti=class{constructor(e,t,i){this.gridKey=e,this.gridCol=t,this.gridRow=i}};var Po=class extends K{constructor(e){super(),this.metadataByKey=new Map,this.gridSave=e,this.maxSizeThreshold=50,this.farColThreshold=8,this.farRowThreshold=6}generateGridStateForExport(e){let t={grids:[]},i=e.grids;for(let s=0;s<i.length;s++){let r=this.gridSave.generateGridStateForExport(i[s]);t.grids.push(r)}return t}importGridState(e,t){if(!t)return console.log("GridSaveManager.importGridState() No world grid state"),!1;if(!t.grids||t.grids.length<e.grids.length)return console.log("GridSaveManager.importGridState() Invalid grids array."),!1;let i=e.grids;for(let s=0;s<i.length;s++){let r=i[s],o=t.grids[s];if(!this.gridSave.importGridState(r,o))return console.log("GridSaveManager.importGridState() Failed to import grid index: "+s),!1;let a=o.key;if(this.metadataByKey.has(a))console.log("GridSaveManager.importGridState() NOT UPDATING METADATA FOR KEY BECAUSE IT WAS ALREADY THERE.");else{let h=new ti(a,r.getGridCol(),r.getGridRow());this.metadataByKey.set(a,h)}}return!0}addGridSaveMetaFromSave(e){if(this.metadataByKey.has(e.gridKey)){console.log("GridSaveManager.addGridSaveMetaFromSave() added duplicate! key="+e.gridKey),console.trace();return}this.metadataByKey.set(e.gridKey,e)}saveGridState(e){if(!e||e.gridChangeCount===0)return;let t=this.gridSave.getGridKey(e);if(ne.startTime("SaveGrid"),this.gridSave.saveGridState(e)){if(!this.metadataByKey.has(t)){let i=new ti(t,e.getGridCol(),e.getGridRow());this.metadataByKey.set(t,i)}}else console.log("GridSaveManager.saveGridState() Failed to save grid state. key="+t);ne.endTime("SaveGrid")}deleteAllGrids(){let e=[];for(let[t]of this.metadataByKey.entries())e.push(t);for(let t=0;t<e.length;t++)this.removeGridState(e[t])}removeGridState(e){this.gridSave.removeGridState(e),this.metadataByKey.delete(e)}loadGridState(e){let t=this.gridSave.getGridKey(e);if(!this.metadataByKey.has(t))return!1;ne.startTime("LoadGrid");let s=this.gridSave.loadGridState(e);return ne.endTime("LoadGrid"),s?!0:(console.log("GridSaveManager.loadGridState() failed to load grid state. gridKey="+t),!1)}clearDistantGrids(e,t){let i=e.getGridCol(),s=e.getGridRow(),r=[];if(e===t)for(let[o,a]of this.metadataByKey.entries())this.isDistant(i,s,a)&&r.push(o);else{let o=t.getGridCol(),a=t.getGridRow();for(let[h,m]of this.metadataByKey.entries())this.isDistant(i,s,m)&&this.isDistant(o,a,m)&&r.push(h)}for(let o=0;o<r.length;o++)this.removeGridState(r[o])}isDistant(e,t,i){return Math.abs(e-i.gridCol)>this.farColThreshold||Math.abs(t-i.gridRow)>this.farRowThreshold}resetFull(){this.deleteAllGrids()}resetForPrestige(){this.resetFull()}};var Ao=class{constructor(e,t,i,s,r){this.gridSaveManager=e,this.terrainGenerator=t,this.worldGrid=i,this.crew=s,this.vectorField=r}loadGrid(e,t,i){e.isLoaded()&&this.unloadGrid(e),e.origin.set(t,i),e.initializeZonesForGrid(),this.loadOrGenerateTerrain(e,!1)}regenerateGrid(e){e.isLoaded()&&this.unloadGridInternal(e,!1),e.initializeZonesForGrid(),this.loadOrGenerateTerrain(e,!0)}unloadGrid(e){this.unloadGridInternal(e,!0)}unloadGridInternal(e,t){t&&e.loaded&&this.gridSaveManager.saveGridState(e);let i=this.crew.miners;for(let s=0;s<i.length;s++){let r=i[s];r.position.tile&&r.position.tile.getGrid()===e&&(console.log("GridLoader.unloadGridInternal() Party character is in grid that is being unloaded."),r.onInvalidGrid())}e.unloadGrid(),this.vectorField.onGridUnload(e),this.crew.onGridUnload(e)}loadOrGenerateTerrain(e,t){!t&&this.gridSaveManager.loadGridState(e)?this.terrainGenerator.generateTileBackgrounds(e):(ne.startTime("GenerateTerrain"),e.nullifyBorderNeighbors(),this.terrainGenerator.generateTerrain(e),ne.endTime("GenerateTerrain"),e.markGridAsChanged())}onTerrainGenerationComplete(e){e.gridChangeCount=0,e.loaded=!0,be.allTilesInGrid(e,function(t){t.open&&t.tileType===ge.SKY&&!t.lighting.sunlightFull&&t.handleSunlightStart()})}};var dl=0,hl=1,ul=2,cl=3,ml=4,pl=5,gl=6,fl=7,Mo=class extends K{constructor(e,t){super(),this.worldGrid=e,this.projection=t,this.centerGrid=null,this.loadedGridTurn=0,this.gridLoader=null,this.crew=null,this.savedGrids=new Array(9)}initializeLoadingManager(e,t){this.gridLoader=e,this.crew=t;let i=n.grid.gridPixelWidth,s=n.grid.gridPixelHeight,r=this.worldGrid.grids,o=q.floor(this.projection.gridCenter.x/i),a=q.floor(this.projection.gridCenter.y/s),h=o*i,m=a*s;this.gridLoader.loadGrid(r[0],h-i,m-s),this.gridLoader.loadGrid(r[1],h,m-s),this.gridLoader.loadGrid(r[2],h+i,m-s),this.gridLoader.loadGrid(r[3],h-i,m),this.gridLoader.loadGrid(r[4],h,m),this.gridLoader.loadGrid(r[5],h+i,m),this.gridLoader.loadGrid(r[6],h-i,m+s),this.gridLoader.loadGrid(r[7],h,m+s),this.gridLoader.loadGrid(r[8],h+i,m+s),this.performPostGridLoadOperations(),this.worldGrid.changeCount++,this.worldGrid.shiftCount++}clearSavedGrid(e){let t=this.savedGrids.indexOf(e);t!==-1?this.savedGrids[t]=null:console.log("GridLoadingManager.clearSavedGrid() did not find grid in saved grids")}setGridIfAlreadyLoaded(e,t,i){let s=this.findSavedGridIndex(e,i);if(s===-1)return;let r=this.savedGrids[s];r.loaded&&(this.savedGrids[s]=null,this.worldGrid.grids[t]=r)}findFirstSavedGridIndex(){for(let e=0;e<this.savedGrids.length;e++)if(this.savedGrids[e])return e;return-1}loadIfUnloaded(e,t,i){let s=this.worldGrid.grids[t];if(s&&s.isLoaded())return;let r=this.findFirstSavedGridIndex();if(r===-1){console.log("GridLoadingManager.loadIfUnloaded() ERROR Failed to find available grid!");return}let o=this.savedGrids[r];this.worldGrid.grids[t]=o,this.savedGrids[r]=null;let a=e.origin.x,h=e.origin.y,m=a,p=h,f=n.grid.gridPixelWidth,S=n.grid.gridPixelHeight;switch(i){case hl:m=a-f,p=h-S;break;case dl:p=h-S;break;case ul:m=a+f,p=h-S;break;case cl:m=a-f;break;case ml:m=a+f;break;case gl:p=h+S,m=a-f;break;case pl:p=h+S;break;case fl:p=h+S,m=a+f;break;default:return console.log("GridLoadingManager.findSavedGridIndex() Unknown direction: "+i),-1}this.gridLoader.loadGrid(o,m,p)}findSavedGridIndex(e,t){let i=e.getOriginTileCol(),s=e.getOriginTileRow(),r=n.grid.gridTileWidth,o=n.grid.gridTileHeight,a=i,h=s;switch(t){case hl:h=s-o,a=i-r;break;case dl:h=s-o;break;case ul:h=s-o,a=i+r;break;case cl:a=i-r;break;case ml:a=i+r;break;case gl:h=s+o,a=i-r;break;case pl:h=s+o;break;case fl:h=s+o,a=i+r;break;default:return console.log("GridLoadingManager.findSavedGridIndex() Unknown direction: "+t),-1}for(let m=0;m<this.savedGrids.length;m++){let p=this.savedGrids[m];if(!p||p.getOriginTileCol()!==a)continue;if(p.getOriginTileRow()===h)return m}return-1}manageLoadedGridsForFrame(){let e=this.projection.gridCenter,t=this.worldGrid.findGridContaining(e);if(!t){t=this.worldGrid.grids[4],t.isLoaded()&&this.gridLoader.unloadGrid(t);let s=q.floor(e.x/n.grid.gridPixelWidth),r=q.floor(e.y/n.grid.gridPixelHeight),o=s*n.grid.gridPixelWidth,a=r*n.grid.gridPixelHeight;this.gridLoader.loadGrid(t,o,a),this.centerGrid=null}if(this.centerGrid&&this.centerGrid===t)return;this.worldGrid.changeCount++,this.worldGrid.shiftCount++,this.centerGrid=t;let i=this.worldGrid.grids;for(let s=0;s<i.length;s++)this.savedGrids[s]=i[s],i[s]=null;i[4]=this.centerGrid,this.clearSavedGrid(this.centerGrid),this.setGridIfAlreadyLoaded(this.centerGrid,0,hl),this.setGridIfAlreadyLoaded(this.centerGrid,1,dl),this.setGridIfAlreadyLoaded(this.centerGrid,2,ul),this.setGridIfAlreadyLoaded(this.centerGrid,3,cl),this.setGridIfAlreadyLoaded(this.centerGrid,5,ml),this.setGridIfAlreadyLoaded(this.centerGrid,6,gl),this.setGridIfAlreadyLoaded(this.centerGrid,7,pl),this.setGridIfAlreadyLoaded(this.centerGrid,8,fl),this.loadIfUnloaded(this.centerGrid,0,hl),this.loadIfUnloaded(this.centerGrid,1,dl),this.loadIfUnloaded(this.centerGrid,2,ul),this.loadIfUnloaded(this.centerGrid,3,cl),this.loadIfUnloaded(this.centerGrid,5,ml),this.loadIfUnloaded(this.centerGrid,6,gl),this.loadIfUnloaded(this.centerGrid,7,pl),this.loadIfUnloaded(this.centerGrid,8,fl),ne.startTime("PostGridLoading"),this.performPostGridLoadOperations(),ne.endTime("PostGridLoading")}performPostGridLoadOperations(){if(this.setAllGridNeighbors(),this.findAllGridBorderTileNeighbors(),this.evaulateGridTiles(),this.onLoadingComplete(),this.validateTileReferences(),this.crew&&this.crew.main){let e=null,t=this.crew.main.position.tile;t?e=t.getGrid():this.centerGrid&&(e=this.centerGrid.getWorldGrid().findGridContaining(this.crew.main.position.worldCoordinateOrigin)),e&&this.gridLoader.gridSaveManager.clearDistantGrids(this.centerGrid,e)}}setAllGridNeighbors(){let e=this.worldGrid.grids;e[0].setGridNeighbors(null,e[3],e[1],null),e[1].setGridNeighbors(null,e[4],e[2],e[0]),e[2].setGridNeighbors(null,e[5],null,e[1]),e[3].setGridNeighbors(e[0],e[6],e[4],null),e[4].setGridNeighbors(e[1],e[7],e[5],e[3]),e[5].setGridNeighbors(e[2],e[8],null,e[4]),e[6].setGridNeighbors(e[3],null,e[7],null),e[7].setGridNeighbors(e[4],null,e[8],e[6]),e[8].setGridNeighbors(e[5],null,null,e[7])}onLoadingComplete(){let e=this.worldGrid.grids;for(let t=0;t<e.length;t++)e[t].loaded||this.gridLoader.onTerrainGenerationComplete(e[t])}findAllGridBorderTileNeighbors(){let e=this.worldGrid.grids;for(let t=0;t<e.length;t++)e[t].findWorldGridTileNeighbors()}evaulateGridTiles(){let e=this.worldGrid.grids;for(let t=0;t<e.length;t++){let i=e[t];i.loaded?i.evaluateWorldGridTileNeighborBorders():i.evaluateAllTileBorders()}}validateTileReferences(){let e=this.worldGrid.grids;for(let t=0;t<e.length;t++)this.validateGridTileReferences(e[t])}validateGridTileReferences(e){let t=e.characters;for(let i=0;i<t.length;i++){let s=t[i].position;s.tile&&s.tile.contains(s.worldCoordinateOrigin)||(console.log("GridLoadingManager.validateGridTileReferences() found invalid character. "+s.worldCoordinateOrigin.toString()),t[i].onInvalidGrid())}}regenerateGrids(){let e=this.worldGrid.grids;for(let t=0;t<e.length;t++){let i=e[t];i&&this.gridLoader.regenerateGrid(i)}this.worldGrid.changeCount++}resetFull(){let e=this.worldGrid.grids;for(let t=0;t<e.length;t++){let i=e[t];i&&this.gridLoader.unloadGrid(i)}this.crew=null,this.gridLoader=null}resetForPrestige(){this.resetFull()}};var zi=class{constructor(e,t){this.a0=e,this.a1=t}};var _o=class{constructor(e){this.nextIndex=0,this.arcs=new Array(e);for(let t=0;t<e;t++)this.arcs[t]=new zi(0,0)}resetCache(){this.nextIndex=0}getArc(e,t){let i;return this.nextIndex>=this.arcs.length?(i=new zi(e,t),this.arcs.push(i)):(i=this.arcs[this.nextIndex],i.a0=e,i.a1=t),this.nextIndex++,i}};var Ro=class{tileLighted(e,t,i){}};var yl=[[0,-1],[1,0],[0,1],[-1,0]],yo=class{constructor(e){this.worldGrid=e}castShadows(e,t,i){}getNeighborCountForRadius(e){return e*8}forEachCircleTile(e,t,i,s){let h=e+-1*i,m=t+1*i,p=null,f=this.getNeighborCountForRadius(i),S=0;for(let E=0;E<yl.length;E++)for(let w=0;w<i*2;w++){let C;if(p!=null?C=p.getNeighborColRow(h,m):C=this.worldGrid.getGridTile(h,m),C&&!this.onCircleTile(C,S,f,i,s))return;S++,h+=yl[E][0],m+=yl[E][1],p=C}}onCircleTile(e,t,i,s,r){}};var Lo=class extends yo{constructor(e){super(e),this.shadows=[],this.cache=new _o(2500)}castShadows(e,t,i){if(e==null)return;i.tileLighted(e,0,1);let s=e.getTileCol(),r=e.getTileRow();this.shadows.length=0,this.cache.resetCache();for(let o=1;o<=t;o++)this.forEachCircleTile(s,r,o,i)}onCircleTile(e,t,i,s,r){if(!e)return!0;let o=this.cache.getArc(t>0?2*t-1:2*i-1,2*i),a=this.cache.getArc(2*t+1,2*i),h=e.isOpaque(),m=this.checkVisibility(o,a,h,this.shadows);return m>0&&r.tileLighted(e,s,m),!(this.shadows.length==2&&this.shadows[0].a0==0&&this.shadows[1].a0==this.shadows[1].a1)}checkVisibility(e,t,i,s){if(e.a0>t.a0){let C=this.checkVisibility(e,this.cache.getArc(e.a1,e.a1),i,s),T=this.checkVisibility(this.cache.getArc(0,1),t,i,s);return(C+T)/2}let r=0,o=!1;for(;r<s.length;){let C=s[r],T=C.a0*e.a1-e.a0*C.a1;if(T>=0){T==0&&r%2==0&&(o=!0);break}r++}let a=s.length,h=!1;for(;a--!=0;){let C=s[a],T=t.a0*C.a1-C.a0*t.a1;if(T>=0){T==0&&a%2!=0&&(h=!0);break}}let m=!0;if((r==a&&(o||h)||o&&h&&r+1==a&&a%2!=0||r>a&&r%2!=0)&&(m=!1),!m)return 0;let p,f=a-r+1;if(f%2!=0)if(r%2!=0){let C=s[r],T=C.a1*t.a1;p=(t.a0*C.a1-C.a0*t.a1)/T,i&&s.splice(r,f,t)}else{let C=s[a],T=e.a1*C.a1;p=(C.a0*e.a1-e.a0*C.a1)/T,i&&s.splice(r,f,e)}else if(r%2!=0){let C=s[r],T=s[a],A=C.a1*T.a1;p=(T.a0*C.a1-C.a0*T.a1)/A,i&&s.splice(r,f)}else return i&&s.splice(r,f,e,t),1;let S=e.a1*t.a1,w=(t.a0*e.a1-e.a0*t.a1)/S;return w==0?1:p/w}};var Ht=class extends Ro{constructor(e,t){super(),this.lightColor=e,this.lightSourceCastRadius=t,this.workingCalculatedLightColor=new ce(1,1,1,1)}setValues(e,t){this.lightColor=e,this.lightSourceCastRadius=t}calculatedLightedColor(e,t){let i=1-1*e/this.lightSourceCastRadius;return this.workingCalculatedLightColor.set(this.lightColor),this.workingCalculatedLightColor.mul(i*t),this.workingCalculatedLightColor}};var bo=class extends Ht{constructor(e,t){super(e,t)}tileLighted(e,t,i){e.addDynamicLighting(this.calculatedLightedColor(t,i))}};var Wi=class extends Ht{constructor(e,t){super(e,t)}tileLighted(e,t,i){e.addPositionalLighting(this.calculatedLightedColor(t,i))}};var Io=class extends Ht{constructor(e,t){super(e,t)}tileLighted(e,t,i){e.addEnvironmentLighting(this.calculatedLightedColor(t,i))}};var xo=class extends K{constructor(e,t){super(),this.worldGrid=e,this.projection=t,this.visibleTileRadius=13,this.lightSourceRadius=7,this.mainPositionalTileRadius=7,this.secondaryPositionalTileRadius=5,this.lightSourceRecalculationFrames=40,this.maxDynamicLightSources=10,this.elapsedFrameCount=this.lightSourceRecalculationFrames,this.dynamicLightSources=[],this.calculatedTile=null,this.shadowCaster=new Lo(e),this.forceEnvironmentalRecalculation=!1,this.dynamicLightSourceCastCallback=new bo(new ce(0,0,0,0),5),this.positionalLightSourceCastCallback=new Wi(new ce(0,0,0,1),this.mainPositionalTileRadius),this.secondaryPositionalLightSourceCastCallback=new Wi(new ce(0,0,0,1),this.secondaryPositionalTileRadius),this.environmentalLightSourceCastCallback=new Io(new ce(0,0,0,0),5),this.regionResetLightingCallback=s=>{let r=s.getTiles();for(let o=0;o<r.length;o++)r[o].lighting.resetLighting()};let i=this;this.gridEnvironmentalLightingCallback=s=>{let r=s.getLightSources();if(!(!r||r.length===0))for(let o=0;o<r.length;o++){let a=r[o];if(a.isFinishedAndAvailable())continue;let h=a.getTileRadius();i.environmentalLightSourceCastCallback.setValues(a.getColor(),h),i.shadowCaster.castShadows(a.getTile(),h,i.environmentalLightSourceCastCallback)}}}resetLightingCalculator(){this.dynamicLightSources.length=0}addDynamicLightSource(e){if(!e||e.getTile()==null||e.isFinishedAndAvailable())return;this.dynamicLightSources.push(e);let t=this.dynamicLightSources.length-this.maxDynamicLightSources;t>0&&this.dynamicLightSources.splice(this.maxDynamicLightSources-1,t),console.log("LightingCalculator.addDynamicLightSource() size="+this.dynamicLightSources.length)}removeDynamicLightSource(e){if(!e)return;let t=this.dynamicLightSources.indexOf(e);t!==-1&&this.dynamicLightSources.splice(t,1)}resetForFrame(){be.allVisibleRegions(this.worldGrid,this.projection,this.regionResetLightingCallback)}calculateEnvironmentLighting(e){this.elapsedFrameCount+=e,(this.forceEnvironmentalRecalculation||this.elapsedFrameCount>=this.lightSourceRecalculationFrames)&&(this.elapsedFrameCount=0,be.allVisibleGrids(this.worldGrid,this.projection,this.gridEnvironmentalLightingCallback))}calculateDynamicLighting(){if(this.dynamicLightSources.length!==0)for(let e=this.dynamicLightSources.length-1;e>=0;e--){let t=this.dynamicLightSources[e];if(t.isFinishedAndAvailable()){this.dynamicLightSources.splice(e,1);continue}let i=t.getTile();if(!i){this.dynamicLightSources.splice(e,1);continue}let s=t.getTileRadius(),r=i.getOrigin();this.projection.isVisible(r.x+n.tile.halfSize,r.y+n.tile.halfSize,n.tile.size*s)&&(this.dynamicLightSourceCastCallback.setValues(t.getColor(),s),this.shadowCaster.castShadows(i,s,this.dynamicLightSourceCastCallback))}}calculatePrimaryPositionalLighting(e){e&&this.shadowCaster.castShadows(e,this.mainPositionalTileRadius,this.positionalLightSourceCastCallback)}calculateSecondaryPositionalLighting(e){e&&this.shadowCaster.castShadows(e,this.secondaryPositionalTileRadius,this.secondaryPositionalLightSourceCastCallback)}onEnvironmentalLightSourceChange(){this.forceEnvironmentalRecalculation=!0}onWallBroken(){this.forceRecalculation()}forceRecalculation(){this.forceEnvironmentalRecalculation=!0}resetFull(){this.dynamicLightSources.length=0,this.calculatedTile=null,this.forceEnvironmentalRecalculation=!1}resetForPrestige(){this.resetFull()}};var Yi=class{constructor(){this.collisionVector=new v(0,0)}static isStandingOnTileOrigin(e){let t=e.position.tile;if(!t)return!0;let i=e.position.worldCoordinateOrigin;return q.floor(i.y)===t.origin.y}static isStandingOnTopOfClosedTile(e){let t=e.position.tile;if(!t)return!0;let i=e.position.worldCoordinateOrigin;if(q.floor(i.y)!==t.origin.y)return!1;let r=t.getNeighborBottom();return r&&!r.isTraversable()}isCollisionDown(e,t){let i=e.position.tile;if(!i)return!0;let s=i.getNeighborBottom();if(!s)return!0;if(s.open)return!1;let r=e.position.worldCoordinateOrigin.y+n.tile.size+t;return i.containsXY(e.position.worldCoordinateOrigin.x,r)?!i.open:s.containsXY(e.position.worldCoordinateOrigin.x,r)?!s.open:!1}};var Oo=class{constructor(e,t,i){this.worldGrid=e,this.projection=t,this.collision=new Yi,this.gameTime=i;let s=this;this.frameTimeRatio=1,this.applyForcesOnCharactersFunction=function(r){for(let o=r.characters.length-1;o>=0;o--){let a=r.characters[o];a.isPartyMember()||a.position.tile&&(a.position.pathPlan.length>0||s.applyGravity(a,s.frameTimeRatio))}}}updatePhysicsForFrame(e){this.frameTimeRatio=e,be.allVisibleGrids(this.worldGrid,this.projection,this.applyForcesOnCharactersFunction)}applyGravity(e,t){if(Yi.isStandingOnTopOfClosedTile(e)){e.position.setPositionToTileOrigin(),e.position.gravityThisFrame>0&&(e.position.gravityThisFrame=0,e.setCharacterAction($.STAND));return}e.position.gravityThisFrame=n.physics.gravityRatePerFrame*t,this.collision.isCollisionDown(e,e.position.gravityThisFrame)?(e.position.setPositionToTileOrigin(),e.position.gravityThisFrame>0&&(e.position.gravityThisFrame=0,e.setCharacterAction($.STAND))):(e.position.moveY(e.position.gravityThisFrame),e.setCharacterAction($.FALL))}};var vo=class{constructor(e,t,i){this.characterPhysics=new Oo(e,t,i)}updatePhysicsForFrame(e){this.characterPhysics.updatePhysicsForFrame(e)}};var ri=xl(Rl());var Ki=class{constructor(){}static generateSave(e){let t={};return t.gridCenter={x:e.gridCenter.x,y:e.gridCenter.y},t.zoom=e.zoom,t.centerOnCharacter=e.stayCenteredOnCharacter,t}static loadSave(e,t){t&&(e.setGridCenter(t.gridCenter.x,t.gridCenter.y),e.setZoom(t.zoom),e.stayCenteredOnCharacter=!1,t.centerOnCharacter&&(e.stayCenteredOnCharacter=!0))}};var Xi=class{constructor(){}static generateSave(e){let t={};return t.v=1,t.seed=e.worldSeed,t}static loadSave(e,t){t&&(e.worldSeed=t.seed)}};var B=class{constructor(){}static save(e){return e?[e.m,e.e]:[0,0]}static load(e,t){e&&t.set(e[0],e[1])}};var gt=class{constructor(){}static generateSave(e){let t={};t.sum=B.save(e.sum),t.startTurn=e.startTurn,t.valuePerTurn=B.save(e.valuePerTurn),t.rateIndex=e.rateIndex,t.rates=[];for(let i=0;i<e.rates.length;i++)t.rates.push(B.save(e.rates[i]));return t}static loadSave(e,t){if(t&&(B.load(t.sum,e.sum),t.startTurn&&(e.startTurn=t.startTurn),B.load(t.valuePerTurn,e.valuePerTurn),e.rateIndex=0,t.rateIndex&&(e.rateIndex=t.rateIndex),t.rates)){e.rates.length=0;for(let i=0;i<t.rates.length;i++){let s=new d(0);B.load(t.rates[i],s),e.rates.push(s)}}}};var ji=class{constructor(){}static generateSave(e){let t={};return t.ore=B.save(e.ore),t.gold=B.save(e.gold),t.ruby=B.save(e.ruby),t.prestige=B.save(e.prestige),t.prestigeSum=B.save(e.prestigePointsSum),t.unclaimed=B.save(e.unclaimedPrestige),t.prestigePerTurn=B.save(e.prestigePerTurn),t.goldPerTurn=B.save(e.goldPerTurn),t.orePerTurn=B.save(e.orePerTurn),t.rubyPerTurn=B.save(e.rubyPerTurn),t.offlinePrestige=B.save(e.offlinePrestige),t.offlineGold=B.save(e.offlineGold),t.offlineOre=B.save(e.offlineOre),t.offlineRuby=B.save(e.offlineRuby),t.offlineSeconds=e.offlineSeconds,t.countedOfflineSeconds=e.countedOfflineSeconds,t.prestigePerTurnCalc=gt.generateSave(e.prestigeRatePerTurnCalculator),t.goldPerTurnCalc=gt.generateSave(e.goldRatePerTurnCalculator),t.orePerTurnCalc=gt.generateSave(e.oreRatePerTurnCalculator),t.rubyPerTurnCalc=gt.generateSave(e.rubyRatePerTurnCalculator),t}static loadSave(e,t){t&&(B.load(t.ore,e.ore),B.load(t.gold,e.gold),B.load(t.ruby,e.ruby),B.load(t.prestige,e.prestige),B.load(t.prestigeSum,e.prestigePointsSum),B.load(t.unclaimed,e.unclaimedPrestige),B.load(t.prestigePerTurn,e.prestigePerTurn),B.load(t.goldPerTurn,e.goldPerTurn),B.load(t.orePerTurn,e.orePerTurn),B.load(t.rubyPerTurn,e.rubyPerTurn),B.load(t.offlinePrestige,e.offlinePrestige),B.load(t.offlineGold,e.offlineGold),B.load(t.offlineOre,e.offlineOre),B.load(t.offlineRuby,e.offlineRuby),t.offlineSeconds&&(e.offlineSeconds=t.offlineSeconds),t.countedOfflineSeconds&&(e.countedOfflineSeconds=t.countedOfflineSeconds),gt.loadSave(e.prestigeRatePerTurnCalculator,t.prestigePerTurnCalc),gt.loadSave(e.goldRatePerTurnCalculator,t.goldPerTurnCalc),gt.loadSave(e.oreRatePerTurnCalculator,t.orePerTurnCalc),gt.loadSave(e.rubyRatePerTurnCalculator,t.rubyPerTurnCalc))}};var Zi=class{constructor(){}static generateSave(e){let t={};return t.turn=e.turnNumber,t.time=Date.now(),t}static loadSave(e,t){t&&(e.turnNumber=t.turn,e.saveTime=t.time)}};var qi=class{constructor(){}static generateSave(e){let t={};return t.mineDamageMultiplier=B.save(e.minedDamageBonusMultiplier.getValue()),t.mineOreBonus=B.save(e.minedOreBonus.getValue()),t}static loadSave(e,t){t&&(B.load(t.mineDamageMultiplier,e.minedDamageBonusMultiplier.getValue()),B.load(t.mineOreBonus,e.minedOreBonus.getValue()))}};var Ji=class{constructor(){}static generateSave(e){let t={};t.upgrades=[];for(let i=0;i<e.upgrades.length;i++)e.upgrades[i]&&t.upgrades.push(this.generateUpgradeSave(e.upgrades[i]));return t}static loadSave(e,t,i){if(!i){console.log("MinedUpgradeCollectionSave.loadSave no save state");return}let s=i.upgrades;if(!s){console.log("MinedUpgradeCollectionSave.loadSave state empty");return}for(let r=0;r<s.length;r++){let o=this.loadUpgradeSave(t,s[r]);o&&e.addBulk(o)}e.addBulkCompleted()}static generateUpgradeSave(e){let t=e.getCreatorId(),i={};return i.creatorId=t,t===Ft.mineDamage?this.generateFreeValueUpgradeSave(e,i):t===Ft.mineOre?this.generateMinedOreUpgradeSave(e,i):console.log("MinedUpgradeCollectionSave.generateUpgradeSave() No save logic associated with creatorId: "+t),i}static loadUpgradeSave(e,t){if(!t)return null;let i=t.creatorId;if(!i)return null;let s=e.getUpgradeCreatorById(i);return s?i===Ft.mineDamage?this.loadFreeValueUpgradeSave(s,t):i===Ft.mineOre?this.loadMinedOreUpgradeSave(s,t):(console.log("MinedUpgradeCollectionSave.loadUpgradeSave() No save logic associated with creatorId: "+i),null):(console.log("MinedUpgradeCollectionSave.loadUpgradeSave() Failed to find upgrade creator ID="+i),null)}static generateFreeValueUpgradeSave(e,t){e.cost&&(t.cost=B.save(e.cost)),t.value=B.save(e.valueDelta)}static loadFreeValueUpgradeSave(e,t){let i=new d(0);return B.load(t.value,i),e.createFreeValueUpgradeFromSave(i)}static generateMinedOreUpgradeSave(e,t){e.cost&&(t.cost=B.save(e.cost)),t.value=B.save(e.ore)}static loadMinedOreUpgradeSave(e,t){let i=new d(0);return B.load(t.value,i),e.createFreeValueUpgradeFromSave(i)}};var Li=class{constructor(){}static generateSave(e){let t={};return t.position={x:e.position.worldCoordinateOrigin.x,y:e.position.worldCoordinateOrigin.y},t.facingLeft=e.position.facingLeft,e.skillId&&(t.skillId=e.skillId),t}static loadSave(e,t){t&&(e.position.setWorldCoordinateOriginXY(t.position.x,t.position.y),e.position.facingLeft=t.facingLeft,t.skillId&&(e.skillId=t.skillId))}};var Qi=class{constructor(){}static generateSave(e){let t={};t.miners=[];for(let i=0;i<e.miners.length;i++)t.miners.push(Li.generateSave(e.miners[i]));return t}static loadSave(e,t){if(!t){console.log("CrewSave.loadSave() No save state. Not loading crew!");return}let i=t.miners;if(!i||i.length===0){console.log("CrewSave.loadSave() No miners data found");return}console.log("CrewSave.loadSave() create main miner");let s=e.createMainMiner();Li.loadSave(s,i[0]);for(let r=1;r<i.length;r++){let o=e.addNewMinerForSaveLoad();Li.loadSave(o,i[r])}}};var Do=class extends K{constructor(e,t){super(),this.totals=e,this.damage=t,this.layerDescription=Xe.DIRT_LAYER,this.nextLayerDescription=this.findNextLayerDescription(),this.defaultMineSeconds=1,this.targetMineSeconds=1,this.targetRow=0,this.workingBrickHealth=new d(0),this.halfDeltaRows=15}deriveTargetSecondsForRow(e){if(this.layerDescription.containsRow(e)){this.deriveTargetSecondsInternal(this.layerDescription,e);return}let t=this.layerDescription.prevLayer;if(t&&t.containsRow(e)){this.deriveTargetSecondsInternal(t,e);return}let i=this.layerDescription.nextLayer;if(i&&i.containsRow(e)){this.deriveTargetSecondsInternal(i,e);return}let s=Zl(e);if(s){this.deriveTargetSecondsInternal(s,e);return}console.log("PartyTarget.deriveTargetSecondsForRow() Failed to update target mine seconds")}deriveTargetSecondsInternal(e,t){e.calculateTileHealth(t,this.workingBrickHealth),this.targetMineSeconds=this.damage.calculateMineSeconds(this.workingBrickHealth)}calculateTargetRow(){this.damage.calculateMaxBrickHealth(this.targetMineSeconds,this.workingBrickHealth);let e=ql(this.layerDescription,this.workingBrickHealth);this.targetRow=Math.max(n.target.minTargetRow,e.calculateTileDepth(this.workingBrickHealth))}setLayerDescriptionFromSave(e){this.layerDescription=e,this.nextLayerDescription=this.findNextLayerDescription(),this.calculateTargetRow()}findNextLayerDescription(){for(let e=0;e<et.length;e++){let t=et[e];if(t.prevLayer===this.layerDescription)return t}return null}unlockNextLayer(){if(!this.nextLayerDescription){console.log("PartyTarget.unlockNextLayer() No next layer!");return}this.layerDescription=this.nextLayerDescription,this.calculateTargetRow(),this.nextLayerDescription=this.findNextLayerDescription(),this.totals.onTerrainLayerUnlocked()}resetFull(){this.layerDescription=Xe.DIRT_LAYER,this.nextLayerDescription=this.findNextLayerDescription(),this.targetMineSeconds=this.defaultMineSeconds,this.calculateTargetRow()}resetForPrestige(){this.resetFull()}};var $i=class{constructor(){}static generateSave(e){let t={};return t.layerId=e.layerDescription.id,t.targetMineSeconds=e.targetMineSeconds,t}static loadSave(e,t){if(!t)return;t.targetMineSeconds&&(e.targetMineSeconds=t.targetMineSeconds);let i=t.layerId,s=jl[i];s?e.setLayerDescriptionFromSave(s):console.log("PartyTargetSave.loadSave() Failed to find layer description: "+i)}};var es=class{constructor(){}static generateSave(e){let t={};t.metaArray=[];for(let i of e.metadataByKey.values()){let s=this.generateMetaState(i);s&&t.metaArray.push(s)}return t}static loadSave(e,t){if(!t){console.log("GridSaveManagerSave.loadSave() no data found in save 1");return}let i=t.metaArray;if(!i||i.length===0){console.log("GridSaveManagerSave.loadSave() no data found in save 2");return}for(let s=0;s<i.length;s++){let r=this.loadMetaState(i[s]);r&&e.addGridSaveMetaFromSave(r)}}static generateMetaState(e){let t={};return t.k=e.gridKey,t.c=e.gridCol,t.r=e.gridRow,t}static loadMetaState(e){return e?new ti(e.k,e.c,e.r):null}};var Bo=class{constructor(){}getNextPurchaseCost(e,t){}calculateBulkPurchaseCost(e,t,i){}calculateMaxAffordable(e,t){return 0}};var He={purchaseOne:1,purchaseFive:5,purchaseTen:10,purchaseMax:-1};var bi=class extends Ci{constructor(e,t,i,s,r){super(t,i),this.id=e,this.costCalculator=s,this.maxCount=r,this.singlePurchaseCost=new d(0),this.cost=new d(0),this.countToPurchase=He.purchaseOne,this.countToPurchaseUsedInCalculation=He.purchaseOne,this.maxAffordableCount=0,this.nextActualPurchaseCount=0,this.workingCost=new d(0)}initializeCosts(){this.calculateCostsAfterCountChange()}isVisible(){return!0}isMaxCountReached(){let e=this.getMaxPurchaseCount();return e>0&&this.purchasedCount>=e}getMaxPurchaseCount(){return this.maxCount}getPurchasedCount(){return this.purchasedCount}setPurchasedCount(e){this.purchasedCount=this.maxCount>0?Math.min(this.maxCount,e):e,this.calculateCostsAfterCountChange()}setPurchasedCountFromSave(e){this.setPurchasedCount(e),this.onUpgradePurchased(0,this.purchasedCount)}getSinglePurchaseCost(){return this.singlePurchaseCost}getCostForActualCount(e,t){return e<=0?(t.setZero(),t):e===1?(t.copy(this.singlePurchaseCost),t):this.costCalculator.calculateBulkPurchaseCost(this.singlePurchaseCost,e,t)}getPurchaseCountNumber(){return this.getActualCountToPurchase(this.getCountToPurchaseSetting())}getActualCountToPurchase(e){if(e===He.purchaseMax)return this.maxAffordableCount;{let t=this.getMaxPurchaseCount(),i=this.getPurchasedCount();return i+e<=t?e:t-i}}purchaseAmount(e){return this.purchaseActualAmount(this.getActualCountToPurchase(e))}purchaseActualAmount(e){let t=this.getMaxPurchaseCount(),i=this.getPurchasedCount();if(t>0&&i>=t)return!1;t>0&&e+i>t&&(e=t-i);let s=this.getCostForActualCount(e,this.workingCost);return s.lessThanEqualsZero()||s.greaterThan(this.getMoney())?!1:(this.decrementMoney(s),this.onUpgradePurchased(i,e),this.setPurchasedCount(i+e),!0)}calculateCostsAfterCountChange(){this.costCalculator.getNextPurchaseCost(this.getPurchasedCount(),this.singlePurchaseCost);let e=this.getCountToPurchaseSetting();e===He.purchaseMax?(this.recalculateMaxPurchaseCount(),this.nextActualPurchaseCount=this.maxAffordableCount):(this.nextActualPurchaseCount=this.getActualCountToPurchase(e),this.cost=this.getCostForActualCount(this.nextActualPurchaseCount,this.cost))}recalculateMaxPurchaseCount(){let e=this.getMoney();if(this.maxAffordableCount=this.costCalculator.calculateMaxAffordable(e,this.singlePurchaseCost),this.maxAffordableCount>0){let t=this.getPurchasedCount(),i=this.getMaxPurchaseCount();if(i>0&&t+this.maxAffordableCount>i&&(this.maxAffordableCount=Math.max(0,i-t),this.maxAffordableCount===0)){this.cost.copy(this.singlePurchaseCost);return}this.cost=this.costCalculator.calculateBulkPurchaseCost(this.singlePurchaseCost,this.maxAffordableCount,this.cost)}else this.cost.copy(this.singlePurchaseCost)}getCountToPurchaseSetting(){return this.countToPurchase}getMoney(){}decrementMoney(e){}onUpgradePurchased(e,t){}isPurchasable(){return this.isAffordable()&&!this.isMaxCountReached()}isAffordable(){return this.cost.lessThanEquals(this.getMoney())}getCost(){let e=this.getCountToPurchaseSetting();return this.countToPurchaseUsedInCalculation!==e?(this.countToPurchaseUsedInCalculation=e,this.calculateCostsAfterCountChange()):e===He.purchaseMax&&this.calculateCostsAfterCountChange(),this.cost}purchase(){return this.purchaseAmount(this.getCountToPurchaseSetting())}resetUpgrade(){super.resetUpgrade(),this.calculateCostsAfterCountChange()}};var Ii=class extends wi{constructor(){super(),this.countToPurchase=He.purchaseOne}setCountToPurchase(e){if(this.countToPurchase!==e){this.countToPurchase=e;for(let t=0;t<this.upgrades.length;t++)this.upgrades[t].countToPurchase=e}}initializeUpgrades(e,t,i){}findById(e){for(let t=0;t<this.upgrades.length;t++){let i=this.upgrades[t];if(i.id===e)return i}return null}resetFull(){for(let e=0;e<this.upgrades.length;e++)this.upgrades[e].resetUpgrade()}};var xi=class extends Bo{constructor(e,t){super(),this.baseCost=e,this.costGrowthRate=new d(t),this.working=new d(0),this.working2=new d(0),this.one=new d(1),this.logCostFactor=Math.log(t)}getNextPurchaseCost(e,t){t.copy(this.costGrowthRate).pow(e).multiply(this.baseCost)}calculateBulkPurchaseCost(e,t,i){return this.working.copy(this.costGrowthRate),this.working.pow(t).sub(this.one),this.working2.copy(this.costGrowthRate),this.working2.sub(this.one),this.working.divide(this.working2),i.copy(e).multiply(this.working),i}calculateMaxAffordable(e,t){return t.greaterThan(e)?0:(this.working.copy(this.costGrowthRate).sub(this.one),this.working.multiply(e).divide(t),this.working.add(this.one),this.working.ln()/this.logCostFactor|0)}};var Tl={FREE:"free",ORE:"Ore",GOLD:"Gold",PRESTIGE:"Prestige"};var ts=class extends bi{constructor(e,t,i,s,r,o,a,h,m,p,f,S){super(e,t,i,s,f),this.totals=r,this.mineDamageLogic=o,this.upgradeBonusValue=a,this.valuePerUpgrade=h,this.dependentUpgrade=m,this.requiredPurchaseCount=p,this.workingValue=new d(0),this.additiveUpgrade=S,this.initializeCosts()}isVisible(){return!(this.purchasedCount>=this.maxCount||this.dependentUpgrade&&this.dependentUpgrade.purchasedCount<this.requiredPurchaseCount)}getCostUnit(){return Tl.ORE}getMoney(){return this.totals.ore}decrementMoney(e){this.totals.decrementOre(e)}onUpgradePurchased(e,t){this.workingValue.copy(this.valuePerUpgrade),t>1&&this.workingValue.mulNumber(t),this.upgradeBonusValue.incrementValue(this.workingValue),this.mineDamageLogic.calculateTotalMineDamagePerTurn()}};var ko=class extends Ii{constructor(e,t,i){super(),this.initializeUpgrades(e,t,i)}initializeUpgrades(e,t,i){let s=null;for(let r=0;r<100;r++)s=this.generateBaseDamageUpgrade(r,e,t,i,s);s=null;for(let r=1;r<100;r++)s=this.generateMultiplicativeUpgrade(r,e,t,i,s);this.addBulkCompleted()}generateMultiplicativeUpgrade(e,t,i,s,r){let o=e<10?.05:e<20?.1:e<30?.2:e<40?.35:e<50?.45:e<60?.7:e<70?1:e<80?1.35:e<90?1.75:2,a=new d(o*e),h=this.createCostCalculator(e),m="Multiplier: +"+I.formatBigNum(a),p=new ts("m"+e,m,u.pick,h,t,s,i.baseMultiplicativeBonusValue,a,r,20,150,!1);return this.addBulk(p),p}generateBaseDamageUpgrade(e,t,i,s,r){let h=e+.01,m=new d(1.35);m.pow(h*2.5);let p=new d(0);p.copy(m),p.mulNumber(n.time.turnsPerSecond);let f=I.formatBigNum(p),S=this.createCostCalculator(e+1);console.log("PICK BASE: i="+e+" perTurn="+I.formatBigNum(m)+" perSec="+f);let E=new ts("add"+e,"Base: +"+f+"/sec",u.pick,S,t,s,i.baseAdditiveBonusPerTurn,m,r,20,150,!0);return this.addBulk(E),E}createCostCalculator(e){let r=Math.max(1,Math.floor(Math.pow(2,e*4.4)));return new xi(new d(r),1.1)}resetForPrestige(){this.resetFull()}};var is=class{constructor(){}static generateSave(e){let t={};t.upgrades=[];for(let i=0;i<e.upgrades.length;i++){let s=this.generateUpgradeSave(e.upgrades[i]);s&&t.upgrades.push(s)}return t.countToPurchase=e.countToPurchase,t}static loadSave(e,t){if(!t){console.log("PickUpgradeCollectionSave.loadSave no save state");return}if(!t.upgrades){console.log("PickUpgradeCollectionSave.loadSave state empty");return}for(let r=0;r<t.upgrades.length;r++)this.loadUpgradeSave(e,t.upgrades[r]);let s=t.countToPurchase;s&&e.setCountToPurchase(s)}static generateUpgradeSave(e){if(e.purchasedCount===0)return null;let t={};return t.id=e.id,t.c=e.purchasedCount,t}static loadUpgradeSave(e,t){if(!t)return;let i=t.id,s=e.findById(i);if(!s){console.log("PickUpgradeCollectionSave.loadUpgradeSave() failed to find upgrade id="+i);return}let r=t.c;r!==void 0&&s.setPurchasedCountFromSave(r)}};var ii=class{constructor(){}static generateSave(e){let t={};return t.ore=B.save(e.totalOre),t.gold=B.save(e.totalGold),t.ruby=B.save(e.totalRuby),t.prestige=B.save(e.totalPrestigePoints),t.upgradeOre=B.save(e.upgradeOre),t.maxDepth=e.maxDepth,t.turns=e.totalTurns,t.tiles=B.save(e.tilesMined),t.tilesCommon=B.save(e.tilesMinedCommon),t.tilesOre=B.save(e.tilesMinedOre),t.tilesGold=B.save(e.tilesMinedGold),t.tilesRuby=B.save(e.tilesMinedRuby),t.tilesUpgrade=B.save(e.tilesMinedUpgrade),t.tilesLaser=B.save(e.tilesMinedLaser),t.tilesDrill=B.save(e.tilesMinedDrill),t.tilesOrbit=B.save(e.tilesMinedOrbit),t.tilesFissure=B.save(e.tilesMinedFissure),t.tilesLightning=B.save(e.tilesMinedLightning),t.tilesMissile=B.save(e.tilesMinedMissile),t}static loadSave(e,t){t&&(B.load(t.ore,e.totalOre),B.load(t.gold,e.totalGold),B.load(t.ruby,e.totalRuby),B.load(t.prestige,e.totalPrestigePoints),B.load(t.upgradeOre,e.upgradeOre),t.maxDepth&&(e.maxDepth=t.maxDepth),t.turns&&(e.totalTurns=t.turns),B.load(t.tiles,e.tilesMined),B.load(t.tilesCommon,e.tilesMinedCommon),B.load(t.tilesOre,e.tilesMinedOre),B.load(t.tilesGold,e.tilesMinedGold),B.load(t.tilesRuby,e.tilesMinedRuby),B.load(t.tilesUpgrade,e.tilesMinedUpgrade),B.load(t.tilesLaser,e.tilesMinedLaser),B.load(t.tilesDrill,e.tilesMinedDrill),B.load(t.tilesOrbit,e.tilesMinedOrbit),B.load(t.tilesFissure,e.tilesMinedFissure),B.load(t.tilesLightning,e.tilesMinedLightning),B.load(t.tilesMissile,e.tilesMinedMissile))}};var Fo=class extends K{constructor(){super()}onNodePurchased(e){}onNodePurchasedFromSave(){}};var ve=class extends K{constructor(e,t,i,s,r,o,a){super(),this.parents=null,this.children=null,this.id=e,this.totals=s,this.title=t,this.description=i,this.iconFileName=r,this.cost=o,this.graphCoordinate=new v(0,0),this.viewCoordinate=new v(0,0),this.nodeVisible=!0,this.purchaseListener=a,this.parentNodePurchased=!1,this.purchased=!1}getTitle(){return this.title}getDescription(){return this.description}setPosition(e,t){this.graphCoordinate.set(n.skillGraph.cellWidth*e,n.skillGraph.cellHeight*t)}getCost(){return this.cost}addParentNode(e){this.parents||(this.parents=[]),this.parents.push(e)}addChildNode(e){this.children||(this.children=[]),this.children.push(e),e.addParentNode(this)}isAffordable(){return this.cost.lessThanEquals(this.totals.prestige)}isPurchasable(){return this.purchased||!this.isAffordable()?!1:!this.parents||this.parents.length===0?!0:this.parentNodePurchased}onPurchase(){return this.purchased?(console.log("SkillNode.onPurchase() node already purchased"),!1):this.isAffordable()?(this.purchased=!0,this.totals.decrementPrestige(this.cost),this.purchaseListener.onNodePurchased(this.cost),this.setChildrenParentNodePurchased(),!0):(console.log("SkillNode.onPurchase() not affordable"),!1)}onPurchaseFromSave(){if(this.purchased)return console.log("SkillNode.onPurchaseFromSave() node already purchased"),!1;this.purchased=!0,this.purchaseListener.onNodePurchasedFromSave(),this.setChildrenParentNodePurchased()}onSaveLoad(){this.purchased&&this.setChildrenParentNodePurchased()}setChildrenParentNodePurchased(){if(this.children)for(let e=0;e<this.children.length;e++)this.children[e].parentNodePurchased=!0}resetFull(){this.parentNodePurchased=!1,this.purchased=!1}resetForPrestige(){}};var fe=class extends ve{constructor(e,t,i,s,r,o,a,h,m){super(e,t,i,s,r,o,a),this.valuePerSkillLevel=h,this.numberValue=m}onPurchase(){return super.onPurchase()?(this.numberValue.incrementValue(this.valuePerSkillLevel),!0):!1}onPurchaseFromSave(){this.numberValue.incrementValue(this.valuePerSkillLevel),super.onPurchaseFromSave()}resetFull(){super.resetFull(),this.numberValue.reset()}};var Me=class extends fe{constructor(e,t,i,s,r,o){super(e,"Delay -"+n.automation.secondsPerRateUpgrade+" sec",null,t,i,s,r,1,o)}getDescription(){let e=n.automation.baseUpgradeDelayTurns,t=n.automation.turnsPerRateUpgrade*this.numberValue.getValue(),i=Math.max(n.automation.minDelayTurns,e-t);return"Current Delay: "+I.formatNumber(i*n.time.secondsPerTurn)+"s"}};var re={MISSILE:"missile",LASER:"laser",DRILL:"drill",ORBIT:"orbit",FISSURE:"fissure",LIGHTNING:"lightning",CHAIN:"chain",DYNAMITE:"dynamite",ORE_BONUS:"oreBonus",UPGRADE_BONUS_MULTIPLICATIVE:"upgradeBonusMult",UPGRADE_BONUS_ADDITIVE:"upgradeBonusAdd",PRESTIGE_BONUS:"prestigeBonus",RUBY_BONUS:"rubyBonus",BLOCKS_BONUS:"blocksBonus",DEPTH_BONUS:"depthBonus",OFFLINE_BONUS:"offlineBonus",FALL_BONUS:"fallBonus",MINED_AUTOMATION:"minedAutomation",PICK_AUTOMATION:"pickAutomation",PRESTIGE_AUTOMATION:"prestigeAutomation"};var Rt=class{constructor(){this.screenCoordinate=new v(0,0)}renderSkill(e,t){}renderSprite(e,t,i,s){if(!i)return;let r=i.getSize(),o=n.tile.size*t.zoom;e.drawImage(i.getImage(),i.spriteX,i.spriteY,r,r,s.x,s.y,o,o)}};var Te=class extends Fo{constructor(e){super(),this.id=e,this.rootNode=null,this.nodes=[],this.unlocked=!1,this.durationUpgrades=new Ce(null,0),this.coolDownUpgrades=new Ce(null,0),this.pointsSpent=new d(0)}addNode(e){return this.rootNode||(this.rootNode=e),this.nodes.push(e),e}getRootNode(){return this.rootNode}isUnlocked(){return this.unlocked}getRenderer(){return null}updateSkillForFrame(e,t,i){}getSkillNodeById(e){for(let t=0;t<this.nodes.length;t++){let i=this.nodes[t];if(e===i.id)return i}return null}onSaveLoad(){for(let e=0;e<this.nodes.length;e++)this.nodes[e].onSaveLoad()}onNodePurchased(e){this.unlocked=!0,this.pointsSpent.add(e)}onNodePurchasedFromSave(){this.unlocked=!0}resetFull(){this.unlocked=!1,this.pointsSpent.setZero();for(let e=0;e<this.nodes.length;e++)this.nodes[e].resetFull();this.coolDownUpgrades.reset(),this.durationUpgrades.reset()}resetForPrestige(){}};var Go=class extends ve{constructor(e,t,i,s,r,o,a){super(e,t,i,s,r,o,a)}};var zt=class extends Go{constructor(e,t,i,s,r,o,a,h){super(e,t,i,s,r,o,a),this.unlockValue=h}onPurchase(){return super.onPurchase()?(this.unlockValue.setValue(!0),!0):!1}onPurchaseFromSave(){super.onPurchaseFromSave(),this.unlockValue.setValue(!0)}};var Vo=class extends Te{constructor(e,t){super(re.MINED_AUTOMATION),this.values=t;let i=5,s=5,r=this.addNode(new zt("minedAutomationUnlock","Auto Claim","Mined Upgrades",e,u.pick,new d(s),this,this.values.minedAutomationUnlocked));s+=i;let o=this.addNode(new Me("minedAutomationBonus1",e,u.pick,new d(s),this,this.values.minedAutomationRateUpgrades));s+=i;let a=this.addNode(new Me("minedAutomationBonus2",e,u.pick,new d(s),this,this.values.minedAutomationRateUpgrades));s+=i;let h=this.addNode(new Me("minedAutomationBonus3",e,u.pick,new d(s),this,this.values.minedAutomationRateUpgrades));s+=i;let m=this.addNode(new Me("minedAutomationBonus4",e,u.pick,new d(s),this,this.values.minedAutomationRateUpgrades));s+=i;let p=this.addNode(new Me("minedAutomationBonus5",e,u.pick,new d(s),this,this.values.minedAutomationRateUpgrades));s+=i;let f=this.addNode(new Me("minedAutomationBonus6",e,u.pick,new d(s),this,this.values.minedAutomationRateUpgrades));s+=i;let S=this.addNode(new Me("minedAutomationBonus7",e,u.pick,new d(s),this,this.values.minedAutomationRateUpgrades));s+=i;let E=this.addNode(new Me("minedAutomationBonus8",e,u.pick,new d(s),this,this.values.minedAutomationRateUpgrades));s+=i;let w=this.addNode(new Me("minedAutomationBonus9",e,u.pick,new d(s),this,this.values.minedAutomationRateUpgrades));s+=i;let C=this.addNode(new Me("minedAutomationBonus10",e,u.pick,new d(s),this,this.values.minedAutomationRateUpgrades));s+=i;let T=this.addNode(new Me("minedAutomationBonus11",e,u.pick,new d(s),this,this.values.minedAutomationRateUpgrades));s+=i;let A=this.addNode(new Me("minedAutomationBonus12",e,u.pick,new d(s),this,this.values.minedAutomationRateUpgrades));r.addChildNode(o),o.addChildNode(a),a.addChildNode(h),h.addChildNode(m),m.addChildNode(p),p.addChildNode(f),f.addChildNode(S),S.addChildNode(E),E.addChildNode(w),w.addChildNode(C),C.addChildNode(T),T.addChildNode(A);let N=-1,P=5;r.setPosition(N,P),o.setPosition(N-1,P),a.setPosition(N-2,P),h.setPosition(N-3,P),m.setPosition(N-4,P),p.setPosition(N-5,P),f.setPosition(N-6,P),S.setPosition(N-6,P-1),E.setPosition(N-5,P-1),w.setPosition(N-4,P-1),C.setPosition(N-3,P-1),T.setPosition(N-2,P-1),A.setPosition(N-1,P-1)}};var Uo=class extends Te{constructor(e,t){super(re.PICK_AUTOMATION),this.values=t;let i=5,s=5,r=this.addNode(new zt("pickAutomationUnlock","Auto Purchase","Ore Upgrades",e,u.pick,new d(s),this,this.values.pickAutomationUnlocked));s+=i;let o=this.addNode(new Me("pickAutomationBonus1",e,u.pick,new d(s),this,this.values.pickAutomationRateUpgrades));s+=i;let a=this.addNode(new Me("pickAutomationBonus2",e,u.pick,new d(s),this,this.values.pickAutomationRateUpgrades));s+=i;let h=this.addNode(new Me("pickAutomationBonus3",e,u.pick,new d(s),this,this.values.pickAutomationRateUpgrades));s+=i;let m=this.addNode(new Me("pickAutomationBonus4",e,u.pick,new d(s),this,this.values.pickAutomationRateUpgrades));s+=i;let p=this.addNode(new Me("pickAutomationBonus5",e,u.pick,new d(s),this,this.values.pickAutomationRateUpgrades));s+=i;let f=this.addNode(new Me("pickAutomationBonus6",e,u.pick,new d(s),this,this.values.pickAutomationRateUpgrades));s+=i;let S=this.addNode(new Me("pickAutomationBonus7",e,u.pick,new d(s),this,this.values.pickAutomationRateUpgrades));s+=i;let E=this.addNode(new Me("pickAutomationBonus8",e,u.pick,new d(s),this,this.values.pickAutomationRateUpgrades));s+=i;let w=this.addNode(new Me("pickAutomationBonus9",e,u.pick,new d(s),this,this.values.pickAutomationRateUpgrades));s+=i;let C=this.addNode(new Me("pickAutomationBonus10",e,u.pick,new d(s),this,this.values.pickAutomationRateUpgrades));s+=i;let T=this.addNode(new Me("pickAutomationBonus11",e,u.pick,new d(s),this,this.values.pickAutomationRateUpgrades));s+=i;let A=this.addNode(new Me("pickAutomationBonus12",e,u.pick,new d(s),this,this.values.pickAutomationRateUpgrades));r.addChildNode(o),o.addChildNode(a),a.addChildNode(h),h.addChildNode(m),m.addChildNode(p),p.addChildNode(f),f.addChildNode(S),S.addChildNode(E),E.addChildNode(w),w.addChildNode(C),C.addChildNode(T),T.addChildNode(A);let N=-1,P=8;r.setPosition(N,P),o.setPosition(N-1,P),a.setPosition(N-2,P),h.setPosition(N-3,P),m.setPosition(N-4,P),p.setPosition(N-5,P),f.setPosition(N-6,P),S.setPosition(N-6,P-1),E.setPosition(N-5,P-1),w.setPosition(N-4,P-1),C.setPosition(N-3,P-1),T.setPosition(N-2,P-1),A.setPosition(N-1,P-1)}};var tt=class extends fe{constructor(e,t,i,s,r,o){super(e,"Delay -"+n.automation.minutesPerPrestigeRateUpgrade+" min",null,t,i,s,r,1,o)}getDescription(){let e=n.automation.prestigeUpgradeDelayTurns,t=n.automation.prestigeTurnsPerRateUpgrade*this.numberValue.getValue(),i=Math.max(n.automation.minDelayTurns,e-t);return"Current Delay: "+I.formatNumber(i*n.time.secondsPerTurn/60)+"m"}};var Ho=class extends Te{constructor(e,t){super(re.PRESTIGE_AUTOMATION),this.values=t;let i=5,s=10,r=this.addNode(new zt("prestigeAutomationUnlock","Auto Prestige","Earn Prestige",e,u.currency.prestige,new d(s),this,this.values.prestigeAutomationUnlocked));s+=i;let o=this.addNode(new tt("prestigeAutomationBonus1",e,u.currency.prestige,new d(s),this,this.values.prestigeAutomationRateUpgrades));s+=i;let a=this.addNode(new tt("prestigeAutomationBonus2",e,u.currency.prestige,new d(s),this,this.values.prestigeAutomationRateUpgrades));s+=i;let h=this.addNode(new tt("prestigeAutomationBonus3",e,u.currency.prestige,new d(s),this,this.values.prestigeAutomationRateUpgrades));s+=i;let m=this.addNode(new tt("prestigeAutomationBonus4",e,u.currency.prestige,new d(s),this,this.values.prestigeAutomationRateUpgrades));s+=i;let p=this.addNode(new tt("prestigeAutomationBonus5",e,u.currency.prestige,new d(s),this,this.values.prestigeAutomationRateUpgrades));s+=i;let f=this.addNode(new tt("prestigeAutomationBonus6",e,u.currency.prestige,new d(s),this,this.values.prestigeAutomationRateUpgrades));s+=i;let S=this.addNode(new tt("prestigeAutomationBonus7",e,u.currency.prestige,new d(s),this,this.values.prestigeAutomationRateUpgrades));s+=i;let E=this.addNode(new tt("prestigeAutomationBonus8",e,u.currency.prestige,new d(s),this,this.values.prestigeAutomationRateUpgrades));s+=i;let w=this.addNode(new tt("prestigeAutomationBonus9",e,u.currency.prestige,new d(s),this,this.values.prestigeAutomationRateUpgrades));s+=i;let C=this.addNode(new tt("prestigeAutomationBonus10",e,u.currency.prestige,new d(s),this,this.values.prestigeAutomationRateUpgrades));s+=i;let T=this.addNode(new tt("prestigeAutomationBonus11",e,u.currency.prestige,new d(s),this,this.values.prestigeAutomationRateUpgrades));s+=i;let A=this.addNode(new tt("prestigeAutomationBonus12",e,u.currency.prestige,new d(s),this,this.values.prestigeAutomationRateUpgrades));r.addChildNode(o),o.addChildNode(a),a.addChildNode(h),h.addChildNode(m),m.addChildNode(p),p.addChildNode(f),f.addChildNode(S),S.addChildNode(E),E.addChildNode(w),w.addChildNode(C),C.addChildNode(T),T.addChildNode(A);let N=-1,P=11;r.setPosition(N,P),o.setPosition(N-1,P),a.setPosition(N-2,P),h.setPosition(N-3,P),m.setPosition(N-4,P),p.setPosition(N-5,P),f.setPosition(N-6,P),S.setPosition(N-6,P-1),E.setPosition(N-5,P-1),w.setPosition(N-4,P-1),C.setPosition(N-3,P-1),T.setPosition(N-2,P-1),A.setPosition(N-1,P-1)}};var De=class extends ve{constructor(e,t,i,s,r,o,a,h){super(e,"Depth Damage +"+I.formatNumber(n.depth.baseBonusPerUpgrade+n.depth.incrementBonusPerUpgrade*h),null,t,i,s,r),this.values=o,this.mineDamageLogic=a,this.purchaseIndex=h}getDescription(){let e=this.values.skillDepthBonusMultiplier.getValue();return e===0?"Damage / Max Depth: 0":"Damage / Max Depth: x"+I.formatNumber(e)}onPurchase(){return super.onPurchase()?(this.applyUpgrade(),this.mineDamageLogic.calculateTotalMineDamagePerTurn(),!0):!1}onPurchaseFromSave(){this.applyUpgrade(),super.onPurchaseFromSave()}applyUpgrade(){let e=n.depth.baseBonusPerUpgrade+n.depth.incrementBonusPerUpgrade*this.purchaseIndex;this.values.skillDepthBonusMultiplier.incrementValue(e)}};var zo=class extends Te{constructor(e,t,i){super(re.DEPTH_BONUS),this.values=t;let s=20,r=20,o=0,a=this.addNode(new De("depthBonus1",e,u.currency.depth,new d(r),this,this.values,i,o));r+=s,o++;let h=this.addNode(new De("depthBonus2",e,u.currency.depth,new d(r),this,this.values,i,o));r+=s,o++;let m=this.addNode(new De("depthBonus3",e,u.currency.depth,new d(r),this,this.values,i,o));r+=s,o++;let p=this.addNode(new De("depthBonus4",e,u.currency.depth,new d(r),this,this.values,i,o));r+=s,o++;let f=this.addNode(new De("depthBonus5",e,u.currency.depth,new d(r),this,this.values,i,o));r+=s,o++;let S=this.addNode(new De("depthBonus6",e,u.currency.depth,new d(r),this,this.values,i,o));r+=s,o++;let E=this.addNode(new De("depthBonus7",e,u.currency.depth,new d(r),this,this.values,i,o));r+=s,o++;let w=this.addNode(new De("depthBonus8",e,u.currency.depth,new d(r),this,this.values,i,o));r+=s,o++;let C=this.addNode(new De("depthBonus9",e,u.currency.depth,new d(r),this,this.values,i,o));r+=s,o++;let T=this.addNode(new De("depthBonus10",e,u.currency.depth,new d(r),this,this.values,i,o));r+=s,o++;let A=this.addNode(new De("depthBonus11",e,u.currency.depth,new d(r),this,this.values,i,o));r+=s,o++;let N=this.addNode(new De("depthBonus12",e,u.currency.depth,new d(r),this,this.values,i,o));r+=s,o++;let P=this.addNode(new De("depthBonus13",e,u.currency.depth,new d(r),this,this.values,i,o));r+=s,o++;let M=this.addNode(new De("depthBonus14",e,u.currency.depth,new d(r),this,this.values,i,o));r+=s,o++;let y=this.addNode(new De("depthBonus15",e,u.currency.depth,new d(r),this,this.values,i,o));r+=s,o++;let V=this.addNode(new De("depthBonus16",e,u.currency.depth,new d(r),this,this.values,i,o));r+=s,o++;let O=this.addNode(new De("depthBonus17",e,u.currency.depth,new d(r),this,this.values,i,o));r+=s,o++;let Z=this.addNode(new De("depthBonus18",e,u.currency.depth,new d(r),this,this.values,i,o));r+=s,o++;let Q=this.addNode(new De("depthBonus19",e,u.currency.depth,new d(r),this,this.values,i,o));r+=s,o++;let D=this.addNode(new De("depthBonus20",e,u.currency.depth,new d(r),this,this.values,i,o));r+=s,o++;let k=this.addNode(new De("depthBonus21",e,u.currency.depth,new d(r),this,this.values,i,o));a.addChildNode(h),h.addChildNode(m),m.addChildNode(p),p.addChildNode(f),f.addChildNode(S),S.addChildNode(E),E.addChildNode(w),w.addChildNode(C),C.addChildNode(T),T.addChildNode(A),A.addChildNode(N),N.addChildNode(P),P.addChildNode(M),M.addChildNode(y),y.addChildNode(V),V.addChildNode(O),O.addChildNode(Z),Z.addChildNode(Q),Q.addChildNode(D),D.addChildNode(k);let L=4,b=-7;a.setPosition(L,b),h.setPosition(L+1,b),m.setPosition(L+2,b),p.setPosition(L+3,b),f.setPosition(L+4,b),S.setPosition(L+5,b),E.setPosition(L+6,b),w.setPosition(L+6,b-1),C.setPosition(L+5,b-1),T.setPosition(L+4,b-1),A.setPosition(L+3,b-1),N.setPosition(L+2,b-1),P.setPosition(L+1,b-1),M.setPosition(L,b-1),y.setPosition(L,b-2),V.setPosition(L+1,b-2),O.setPosition(L+2,b-2),Z.setPosition(L+3,b-2),Q.setPosition(L+4,b-2),D.setPosition(L+5,b-2),k.setPosition(L+6,b-2)}};var nt=class{constructor(){}static formatElapsedTime(e){if(e<0)return"Error: negative time";let t=e/36e5|0,i=e/6e4%60|0,s=e/1e3%60|0;return(t<10?"0":"")+t+":"+(i<10?"0":"")+i+":"+(s<10?"0":"")+s}static formatElapsedTimeNoHours(e){if(e<0)return"Error: negative time";let t=e/36e5|0,i=e/6e4%60|0,s=e/1e3%60|0;return t>0?(t<10?"0":"")+t+":"+(i<10?"0":"")+i+":"+(s<10?"0":"")+s:(i<10?"0":"")+i+":"+(s<10?"0":"")+s}};var Be=class extends ve{constructor(e,t,i,s,r,o){super(e,"Offline +"+n.offline.minutesPerUpgrade+" min",null,t,i,s,r),this.values=o}getDescription(){let t=(n.offline.defaultOfflineMinutes+this.values.offlineTimeUpgrades.getValue()*n.offline.minutesPerUpgrade)*60*1e3;return"Offline Time: "+nt.formatElapsedTime(t)}onPurchase(){return super.onPurchase()?(this.applyUpgrade(),!0):!1}onPurchaseFromSave(){this.applyUpgrade(),super.onPurchaseFromSave()}applyUpgrade(){this.values.offlineTimeUpgrades.incrementValue(1)}};var Wo=class extends Te{constructor(e,t){super(re.OFFLINE_BONUS),this.values=t;let i=10,s=10,r=this.addNode(new Be("offlineBonus1",e,u.offline,new d(s),this,this.values));s+=i;let o=this.addNode(new Be("offlineBonus2",e,u.offline,new d(s),this,this.values));s+=i;let a=this.addNode(new Be("offlineBonus3",e,u.offline,new d(s),this,this.values));s+=i;let h=this.addNode(new Be("offlineBonus4",e,u.offline,new d(s),this,this.values));s+=i;let m=this.addNode(new Be("offlineBonus5",e,u.offline,new d(s),this,this.values));s+=i;let p=this.addNode(new Be("offlineBonus6",e,u.offline,new d(s),this,this.values));s+=i;let f=this.addNode(new Be("offlineBonus7",e,u.offline,new d(s),this,this.values));s+=i;let S=this.addNode(new Be("offlineBonus8",e,u.offline,new d(s),this,this.values));s+=i;let E=this.addNode(new Be("offlineBonus9",e,u.offline,new d(s),this,this.values));s+=i;let w=this.addNode(new Be("offlineBonus10",e,u.offline,new d(s),this,this.values));s+=i;let C=this.addNode(new Be("offlineBonus11",e,u.offline,new d(s),this,this.values));s+=i;let T=this.addNode(new Be("offlineBonus12",e,u.offline,new d(s),this,this.values));s+=i;let A=this.addNode(new Be("offlineBonus13",e,u.offline,new d(s),this,this.values));s+=i;let N=this.addNode(new Be("offlineBonus14",e,u.offline,new d(s),this,this.values));s+=i;let P=this.addNode(new Be("offlineBonus15",e,u.offline,new d(s),this,this.values));s+=i;let M=this.addNode(new Be("offlineBonus16",e,u.offline,new d(s),this,this.values));s+=i;let y=this.addNode(new Be("offlineBonus17",e,u.offline,new d(s),this,this.values));s+=i;let V=this.addNode(new Be("offlineBonus18",e,u.offline,new d(s),this,this.values));s+=i;let O=this.addNode(new Be("offlineBonus19",e,u.offline,new d(s),this,this.values));s+=i;let Z=this.addNode(new Be("offlineBonus20",e,u.offline,new d(s),this,this.values));s+=i;let Q=this.addNode(new Be("offlineBonus21",e,u.offline,new d(s),this,this.values));r.addChildNode(o),o.addChildNode(a),a.addChildNode(h),h.addChildNode(m),m.addChildNode(p),p.addChildNode(f),f.addChildNode(S),S.addChildNode(E),E.addChildNode(w),w.addChildNode(C),C.addChildNode(T),T.addChildNode(A),A.addChildNode(N),N.addChildNode(P),P.addChildNode(M),M.addChildNode(y),y.addChildNode(V),V.addChildNode(O),O.addChildNode(Z),Z.addChildNode(Q);let D=4,k=-11;r.setPosition(D,k),o.setPosition(D+1,k),a.setPosition(D+2,k),h.setPosition(D+3,k),m.setPosition(D+4,k),p.setPosition(D+5,k),f.setPosition(D+6,k),S.setPosition(D+6,k-1),E.setPosition(D+5,k-1),w.setPosition(D+4,k-1),C.setPosition(D+3,k-1),T.setPosition(D+2,k-1),A.setPosition(D+1,k-1),N.setPosition(D,k-1),P.setPosition(D,k-2),M.setPosition(D+1,k-2),y.setPosition(D+2,k-2),V.setPosition(D+3,k-2),O.setPosition(D+4,k-2),Z.setPosition(D+5,k-2),Q.setPosition(D+6,k-2)}};var we=class extends ve{constructor(e,t,i,s,r,o){super(e,"Ore x"+n.skill.bonus.oreBonusMultiplierPerUpgrade,null,t,i,s,r),this.values=o}getDescription(){return"Bonus: x"+I.formatBigNum(this.values.skillOreBonusMultiplier.getValue())}onPurchase(){return super.onPurchase()?(this.applyMultipliers(),!0):!1}onPurchaseFromSave(){this.applyMultipliers(),super.onPurchaseFromSave()}applyMultipliers(){let e=this.values.skillOreBonusMultiplier.getValue();e.lessThanEqualsNumber(1)&&e.setValue(1),e.mulNumber(n.skill.bonus.oreBonusMultiplierPerUpgrade)}};var Yo=class extends Te{constructor(e,t){super(re.ORE_BONUS),this.values=t;let i=5,s=5,r=this.addNode(new we("oreBonus1",e,u.currency.ore,new d(s),this,this.values));s+=i;let o=this.addNode(new we("oreBonus2",e,u.currency.ore,new d(s),this,this.values));s+=i;let a=this.addNode(new we("oreBonus3",e,u.currency.ore,new d(s),this,this.values));s+=i;let h=this.addNode(new we("oreBonus4",e,u.currency.ore,new d(s),this,this.values));s+=i;let m=this.addNode(new we("oreBonus5",e,u.currency.ore,new d(s),this,this.values));s+=i;let p=this.addNode(new we("oreBonus6",e,u.currency.ore,new d(s),this,this.values));s+=i;let f=this.addNode(new we("oreBonus7",e,u.currency.ore,new d(s),this,this.values));s+=i;let S=this.addNode(new we("oreBonus8",e,u.currency.ore,new d(s),this,this.values));s+=i;let E=this.addNode(new we("oreBonus9",e,u.currency.ore,new d(s),this,this.values));s+=i;let w=this.addNode(new we("oreBonus10",e,u.currency.ore,new d(s),this,this.values));s+=i;let C=this.addNode(new we("oreBonus11",e,u.currency.ore,new d(s),this,this.values));s+=i;let T=this.addNode(new we("oreBonus12",e,u.currency.ore,new d(s),this,this.values));s+=i;let A=this.addNode(new we("oreBonus13",e,u.currency.ore,new d(s),this,this.values));s+=i;let N=this.addNode(new we("oreBonus14",e,u.currency.ore,new d(s),this,this.values));s+=i;let P=this.addNode(new we("oreBonus15",e,u.currency.ore,new d(s),this,this.values));s+=i;let M=this.addNode(new we("oreBonus16",e,u.currency.ore,new d(s),this,this.values));s+=i;let y=this.addNode(new we("oreBonus17",e,u.currency.ore,new d(s),this,this.values));s+=i;let V=this.addNode(new we("oreBonus18",e,u.currency.ore,new d(s),this,this.values));s+=i;let O=this.addNode(new we("oreBonus19",e,u.currency.ore,new d(s),this,this.values));s+=i;let Z=this.addNode(new we("oreBonus20",e,u.currency.ore,new d(s),this,this.values));s+=i;let Q=this.addNode(new we("oreBonus21",e,u.currency.ore,new d(s),this,this.values));s+=i;let D=this.addNode(new we("oreBonus22",e,u.currency.ore,new d(s),this,this.values));s+=i;let k=this.addNode(new we("oreBonus23",e,u.currency.ore,new d(s),this,this.values));s+=i;let L=this.addNode(new we("oreBonus24",e,u.currency.ore,new d(s),this,this.values));s+=i;let b=this.addNode(new we("oreBonus25",e,u.currency.ore,new d(s),this,this.values));s+=i;let Ee=this.addNode(new we("oreBonus26",e,u.currency.ore,new d(s),this,this.values));s+=i;let pe=this.addNode(new we("oreBonus27",e,u.currency.ore,new d(s),this,this.values));s+=i;let _e=this.addNode(new we("oreBonus28",e,u.currency.ore,new d(s),this,this.values));r.addChildNode(o),o.addChildNode(a),a.addChildNode(h),h.addChildNode(m),m.addChildNode(p),p.addChildNode(f),f.addChildNode(S),S.addChildNode(E),E.addChildNode(w),w.addChildNode(C),C.addChildNode(T),T.addChildNode(A),A.addChildNode(N),N.addChildNode(P),P.addChildNode(M),M.addChildNode(y),y.addChildNode(V),V.addChildNode(O),O.addChildNode(Z),Z.addChildNode(Q),Q.addChildNode(D),D.addChildNode(k),k.addChildNode(L),L.addChildNode(b),b.addChildNode(Ee),Ee.addChildNode(pe),pe.addChildNode(_e);let X=-1,G=2;r.setPosition(X,G),o.setPosition(X-1,G),a.setPosition(X-2,G),h.setPosition(X-3,G),m.setPosition(X-4,G),p.setPosition(X-5,G),f.setPosition(X-6,G),S.setPosition(X-6,G-1),E.setPosition(X-5,G-1),w.setPosition(X-4,G-1),C.setPosition(X-3,G-1),T.setPosition(X-2,G-1),A.setPosition(X-1,G-1),N.setPosition(X,G-1),P.setPosition(X,G-2),M.setPosition(X-1,G-2),y.setPosition(X-2,G-2),V.setPosition(X-3,G-2),O.setPosition(X-4,G-2),Z.setPosition(X-5,G-2),Q.setPosition(X-6,G-2),D.setPosition(X-6,G-3),k.setPosition(X-5,G-3),L.setPosition(X-4,G-3),b.setPosition(X-3,G-3),Ee.setPosition(X-2,G-3),pe.setPosition(X-1,G-3),_e.setPosition(X,G-3)}};var ke=class extends ve{constructor(e,t,i,s,r,o,a,h){super(e,"Prestige +"+I.formatNumber(n.prestige.baseBonusPerUpgrade+n.prestige.incrementBonusPerUpgrade*h),null,t,i,s,r),this.values=o,this.mineDamageLogic=a,this.purchaseIndex=h}getDescription(){let e=this.values.skillPrestigeBonusMultiplier.getValue()+n.prestige.multiplierPerPrestige;return"Damage / Prestige: x"+I.formatNumber(e)}onPurchase(){return super.onPurchase()?(this.applyUpgrade(),this.mineDamageLogic.calculateTotalMineDamagePerTurn(),!0):!1}onPurchaseFromSave(){this.applyUpgrade(),super.onPurchaseFromSave()}applyUpgrade(){let e=n.prestige.baseBonusPerUpgrade+n.prestige.incrementBonusPerUpgrade*this.purchaseIndex;this.values.skillPrestigeBonusMultiplier.incrementValue(e)}};var Ko=class extends Te{constructor(e,t,i){super(re.PRESTIGE_BONUS),this.values=t;let s=10,r=10,o=0,a=this.addNode(new ke("prestigeBonus1",e,u.currency.prestige,new d(r),this,this.values,i,o));r+=s,o++;let h=this.addNode(new ke("prestigeBonus2",e,u.currency.prestige,new d(r),this,this.values,i,o));r+=s,o++;let m=this.addNode(new ke("prestigeBonus3",e,u.currency.prestige,new d(r),this,this.values,i,o));r+=s,o++;let p=this.addNode(new ke("prestigeBonus4",e,u.currency.prestige,new d(r),this,this.values,i,o));r+=s,o++;let f=this.addNode(new ke("prestigeBonus5",e,u.currency.prestige,new d(r),this,this.values,i,o));r+=s,o++;let S=this.addNode(new ke("prestigeBonus6",e,u.currency.prestige,new d(r),this,this.values,i,o));r+=s,o++;let E=this.addNode(new ke("prestigeBonus7",e,u.currency.prestige,new d(r),this,this.values,i,o));r+=s,o++;let w=this.addNode(new ke("prestigeBonus8",e,u.currency.prestige,new d(r),this,this.values,i,o));r+=s,o++;let C=this.addNode(new ke("prestigeBonus9",e,u.currency.prestige,new d(r),this,this.values,i,o));r+=s,o++;let T=this.addNode(new ke("prestigeBonus10",e,u.currency.prestige,new d(r),this,this.values,i,o));r+=s,o++;let A=this.addNode(new ke("prestigeBonus11",e,u.currency.prestige,new d(r),this,this.values,i,o));r+=s,o++;let N=this.addNode(new ke("prestigeBonus12",e,u.currency.prestige,new d(r),this,this.values,i,o));r+=s,o++;let P=this.addNode(new ke("prestigeBonus13",e,u.currency.prestige,new d(r),this,this.values,i,o));r+=s,o++;let M=this.addNode(new ke("prestigeBonus14",e,u.currency.prestige,new d(r),this,this.values,i,o));r+=s,o++;let y=this.addNode(new ke("prestigeBonus15",e,u.currency.prestige,new d(r),this,this.values,i,o));r+=s,o++;let V=this.addNode(new ke("prestigeBonus16",e,u.currency.prestige,new d(r),this,this.values,i,o));r+=s,o++;let O=this.addNode(new ke("prestigeBonus17",e,u.currency.prestige,new d(r),this,this.values,i,o));r+=s,o++;let Z=this.addNode(new ke("prestigeBonus18",e,u.currency.prestige,new d(r),this,this.values,i,o));r+=s,o++;let Q=this.addNode(new ke("prestigeBonus19",e,u.currency.prestige,new d(r),this,this.values,i,o));r+=s,o++;let D=this.addNode(new ke("prestigeBonus20",e,u.currency.prestige,new d(r),this,this.values,i,o));r+=s,o++;let k=this.addNode(new ke("prestigeBonus21",e,u.currency.prestige,new d(r),this,this.values,i,o));a.addChildNode(h),h.addChildNode(m),m.addChildNode(p),p.addChildNode(f),f.addChildNode(S),S.addChildNode(E),E.addChildNode(w),w.addChildNode(C),C.addChildNode(T),T.addChildNode(A),A.addChildNode(N),N.addChildNode(P),P.addChildNode(M),M.addChildNode(y),y.addChildNode(V),V.addChildNode(O),O.addChildNode(Z),Z.addChildNode(Q),Q.addChildNode(D),D.addChildNode(k);let L=-1,b=-3;a.setPosition(L,b),h.setPosition(L-1,b),m.setPosition(L-2,b),p.setPosition(L-3,b),f.setPosition(L-4,b),S.setPosition(L-5,b),E.setPosition(L-6,b),w.setPosition(L-6,b-1),C.setPosition(L-5,b-1),T.setPosition(L-4,b-1),A.setPosition(L-3,b-1),N.setPosition(L-2,b-1),P.setPosition(L-1,b-1),M.setPosition(L,b-1),y.setPosition(L,b-2),V.setPosition(L-1,b-2),O.setPosition(L-2,b-2),Z.setPosition(L-3,b-2),Q.setPosition(L-4,b-2),D.setPosition(L-5,b-2),k.setPosition(L-6,b-2)}};var Se=class extends ve{constructor(e,t,i,s,r,o,a){super(e,"Mined Damage +"+I.formatNumber(n.minedDamage.baseBonusPerUpgrade+n.minedDamage.incrementBonusPerUpgrade*a),null,t,i,s,r),this.values=o,this.purchaseIndex=a}getDescription(){let e=this.values.skillMinedDamageBonus.getValue();return"Bonus: +"+I.formatNumber(e)}onPurchase(){return super.onPurchase()?(this.applyUpgrade(),!0):!1}onPurchaseFromSave(){this.applyUpgrade(),super.onPurchaseFromSave()}applyUpgrade(){let e=n.minedDamage.baseBonusPerUpgrade+n.minedDamage.incrementBonusPerUpgrade*this.purchaseIndex;this.values.skillMinedDamageBonus.incrementValue(e)}resetFull(){super.resetFull(),this.values.skillMinedDamageBonus.reset()}};var Xo=class extends Te{constructor(e,t){super(re.UPGRADE_BONUS_MULTIPLICATIVE),this.values=t;let i=5,s=5,r=0,o=this.addNode(new Se("upgradeBonusMult1",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let a=this.addNode(new Se("upgradeBonusMult2",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let h=this.addNode(new Se("upgradeBonusMult3",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let m=this.addNode(new Se("upgradeBonusMult4",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let p=this.addNode(new Se("upgradeBonusMult5",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let f=this.addNode(new Se("upgradeBonusMult6",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let S=this.addNode(new Se("upgradeBonusMult7",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let E=this.addNode(new Se("upgradeBonusMult8",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let w=this.addNode(new Se("upgradeBonusMult9",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let C=this.addNode(new Se("upgradeBonusMult10",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let T=this.addNode(new Se("upgradeBonusMult11",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let A=this.addNode(new Se("upgradeBonusMult12",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let N=this.addNode(new Se("upgradeBonusMult13",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let P=this.addNode(new Se("upgradeBonusMult14",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let M=this.addNode(new Se("upgradeBonusMult15",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let y=this.addNode(new Se("upgradeBonusMult16",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let V=this.addNode(new Se("upgradeBonusMult17",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let O=this.addNode(new Se("upgradeBonusMult18",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let Z=this.addNode(new Se("upgradeBonusMult19",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let Q=this.addNode(new Se("upgradeBonusMult20",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let D=this.addNode(new Se("upgradeBonusMult21",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let k=this.addNode(new Se("upgradeBonusMult22",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let L=this.addNode(new Se("upgradeBonusMult23",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let b=this.addNode(new Se("upgradeBonusMult24",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let Ee=this.addNode(new Se("upgradeBonusMult25",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let pe=this.addNode(new Se("upgradeBonusMult26",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let _e=this.addNode(new Se("upgradeBonusMult27",e,u.currency.upgrades,new d(s),this,this.values,r));s+=i,r++;let X=this.addNode(new Se("upgradeBonusMult28",e,u.currency.upgrades,new d(s),this,this.values,r));o.addChildNode(a),a.addChildNode(h),h.addChildNode(m),m.addChildNode(p),p.addChildNode(f),f.addChildNode(S),S.addChildNode(E),E.addChildNode(w),w.addChildNode(C),C.addChildNode(T),T.addChildNode(A),A.addChildNode(N),N.addChildNode(P),P.addChildNode(M),M.addChildNode(y),y.addChildNode(V),V.addChildNode(O),O.addChildNode(Z),Z.addChildNode(Q),Q.addChildNode(D),D.addChildNode(k),k.addChildNode(L),L.addChildNode(b),b.addChildNode(Ee),Ee.addChildNode(pe),pe.addChildNode(_e),_e.addChildNode(X);let G=-1,ie=-7;o.setPosition(G,ie),a.setPosition(G-1,ie),h.setPosition(G-2,ie),m.setPosition(G-3,ie),p.setPosition(G-4,ie),f.setPosition(G-5,ie),S.setPosition(G-6,ie),E.setPosition(G-6,ie-1),w.setPosition(G-5,ie-1),C.setPosition(G-4,ie-1),T.setPosition(G-3,ie-1),A.setPosition(G-2,ie-1),N.setPosition(G-1,ie-1),P.setPosition(G,ie-1),M.setPosition(G,ie-2),y.setPosition(G-1,ie-2),V.setPosition(G-2,ie-2),O.setPosition(G-3,ie-2),Z.setPosition(G-4,ie-2),Q.setPosition(G-5,ie-2),D.setPosition(G-6,ie-2),k.setPosition(G-6,ie-3),L.setPosition(G-5,ie-3),b.setPosition(G-4,ie-3),Ee.setPosition(G-3,ie-3),pe.setPosition(G-2,ie-3),_e.setPosition(G-1,ie-3),X.setPosition(G,ie-3)}};var Oi=class{constructor(e){this.worldGrid=e,this.startPoint=new v(0,0),this.endPoint=new v(0,0),this.workingPosition=new v(0,0)}getProjectedTile(e,t){return e&&e.contains(t)?e:this.worldGrid.findGridTile(t)}};var Qe=class{constructor(){}static projectPosition(e,t,i,s){return s.copy(e),s.x+=Math.cos(i)*t,s.y+=Math.sin(i)*t,s}static findClosestTileInRange(e,t,i){if(t.length===0)return null;let s=null,r=1e4;for(let o=0;o<t.length;o++){let a=t[o];if(!a||a.open)continue;let h=e.distanceSquared(a.origin);h>i||(!s||h<r)&&(s=a,r=h)}return s}static findClosestTile(e,t){if(t.length===0)return null;let i=null,s=1e4;for(let r=0;r<t.length;r++){let o=t[r];if(!o||o.open)continue;let a=e.distanceSquared(o.origin);(!i||a<s)&&(i=o,s=a)}return i}};var Bd=Math.PI/2,jo=class extends Oi{constructor(e,t,i){super(e),this.tileMinedLogic=t,this.depthUpgradeCount=i,this.drillTile=null,this.goalTile=null,this.skillActive=!1}onSkillActivation(){this.skillActive=!0}onSkillDeactivation(){this.skillActive=!1,this.drillTile=null}updateForFrame(e,t){this.startPoint.copy(e.position.worldCoordinateOrigin),this.startPoint.addXY(n.tile.halfSize,n.tile.halfSize);let i=(n.skill.drill.minRange+n.skill.drill.tilesPerUpgrade*this.depthUpgradeCount.getValue())*n.tile.size;if(this.workingPosition.copy(this.startPoint),this.workingPosition.y+=i,this.goalTile=this.worldGrid.findGridTile(this.workingPosition),this.drillTile=this.goalTile,!!this.goalTile){if(this.drillTile=this.findFirstClosedTileOnLine(this.startPoint,Bd,i),!this.drillTile){this.endPoint.copy(this.goalTile.origin),this.endPoint.x=this.startPoint.x,this.endPoint.y+=n.tile.halfSize;return}this.drillTile.markTileAsCurrentlyVisible(),this.endPoint.copy(this.drillTile.origin),this.endPoint.x=this.startPoint.x,this.endPoint.y+=n.tile.halfSize,this.drillTile.open||this.tileMinedLogic.drillTileForFrame(this.drillTile,t)}}findFirstClosedTileOnLine(e,t,i){let s=null;for(let r=n.tile.halfSize;r<=i;r+=n.tile.halfSize){let o=Qe.projectPosition(e,r,t,this.workingPosition),a=this.getProjectedTile(s,o);if(!a)break;if(s!==a){if(a.lighting.everVisibleToCharacter||a.markTileAsCurrentlyVisible(),!a.open)return a;s=a}}return s&&!s.open?s:null}};var Zo=class extends Rt{constructor(e,t){super(),this.drillArray=e,this.spellFxSpritesheet=t,this.skillAnimation=null,this.skillStart=Date.now()}renderSkill(e,t){if(this.drillArray.length!==0)for(let i=0;i<this.drillArray.length;i++)this.renderDrill(e,t,this.drillArray[i])}renderDrill(e,t,i){if(!i.skillActive||!i.goalTile)return;let s=Date.now();s-this.skillStart>1e5&&(this.skillStart=s),this.skillAnimation||(this.skillAnimation=this.spellFxSpritesheet.getSpriteAnimation(F.EFFECT_NAME_SPARKLE_BLUE));let r=i.startPoint,o=i.endPoint,a=e.lineWidth;if(e.lineWidth=5,e.strokeStyle="#00F",e.beginPath(),t.worldToScreen(r,this.screenCoordinate),e.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),t.worldToScreen(o,this.screenCoordinate),e.lineTo(this.screenCoordinate.x,this.screenCoordinate.y),e.stroke(),e.lineWidth=1,e.strokeStyle="#FFF",e.beginPath(),t.worldToScreen(r,this.screenCoordinate),e.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),t.worldToScreen(o,this.screenCoordinate),e.lineTo(this.screenCoordinate.x,this.screenCoordinate.y),e.stroke(),e.lineWidth=a,t.isVisible(o,n.tile.size)){this.screenCoordinate.copy(o),this.screenCoordinate.x-=n.tile.halfSize,this.screenCoordinate.y-=n.tile.halfSize,t.worldToScreen(this.screenCoordinate,this.screenCoordinate);let h=this.skillAnimation.getSpriteAsOf(Date.now(),this.skillStart);this.renderSprite(e,t,h,this.screenCoordinate)}}};var We=class extends ve{constructor(e,t,i,s,r,o,a,h,m){super(e,t,i,s,r,o,a),this.crew=h,this.skillId=m}onPurchase(){return super.onPurchase()?(this.crew.addNewMinerNearMain(this.skillId),!0):!1}};var le=class extends fe{constructor(e,t,i,s,r,o,a){super(e,"Cool Down - "+n.skill.common.coolDownSecondsPerUpgrade+" sec",null,t,i,s,r,o,a)}getDescription(){return Ke.getSkillCoolDownSeconds(this.numberValue)+" seconds"}};var de=class extends fe{constructor(e,t,i,s,r,o,a){super(e,"Duration + "+n.skill.common.activationSecondsPerUpgrade+" sec",null,t,i,s,r,o,a)}getDescription(){return Ke.getSkillActivationSeconds(this.numberValue)+" seconds"}};var Ye=class extends fe{constructor(e,t,i,s,r,o,a,h){super(e,"+"+o+" Tile",null,t,i,s,r,o,a),this.minRange=h}getDescription(){return"Range: "+(this.minRange+this.valuePerSkillLevel*this.numberValue.getValue())+" Tiles"}};var qo=class extends Te{constructor(e,t,i,s,r){super(re.DRILL),this.worldGrid=e,this.tileMinedLogic=i,this.totals=t,this.crew=s,this.drillArray=[],this.drillByCharacter={},this.depthUpgrades=new Ce(null,0),this.renderer=new Zo(this.drillArray,r);let o=1,a=this.addNode(new We("addDrillMiner1","+1 Drill Miner","Drills straight down",t,u.skill.drill,new d(o+n.skill.costs.addDrill1),this,s,re.DRILL));o++;let h=this.addNode(new Ye("drillDepth1",t,u.skill.drill,new d(o),this,n.skill.drill.tilesPerUpgrade,this.depthUpgrades,n.skill.drill.minRange)),m=this.addNode(new le("drillCool1",t,u.skill.drill,new d(o),this,1,this.coolDownUpgrades)),p=this.addNode(new de("drillDur1",t,u.skill.drill,new d(o),this,1,this.durationUpgrades));o++;let f=this.addNode(new Ye("drillDepth2",t,u.skill.drill,new d(o),this,n.skill.drill.tilesPerUpgrade,this.depthUpgrades,n.skill.drill.minRange)),S=this.addNode(new le("drillCool2",t,u.skill.drill,new d(o),this,1,this.coolDownUpgrades)),E=this.addNode(new de("drillDur2",t,u.skill.drill,new d(o),this,1,this.durationUpgrades));o++;let w=this.addNode(new Ye("drillDepth3",t,u.skill.drill,new d(o),this,n.skill.drill.tilesPerUpgrade,this.depthUpgrades,n.skill.drill.minRange)),C=this.addNode(new le("drillCool3",t,u.skill.drill,new d(o),this,1,this.coolDownUpgrades)),T=this.addNode(new de("drillDur3",t,u.skill.drill,new d(o),this,1,this.durationUpgrades)),A=this.addNode(new We("addDrillMiner2","+1 Drill Miner","Drills straight down",t,u.skill.drill,new d(o+n.skill.costs.addMiner2),this,s,re.DRILL));o++;let N=this.addNode(new Ye("drillDepth4",t,u.skill.drill,new d(o),this,n.skill.drill.tilesPerUpgrade,this.depthUpgrades,n.skill.drill.minRange)),P=this.addNode(new le("drillCool4",t,u.skill.drill,new d(o),this,1,this.coolDownUpgrades)),M=this.addNode(new de("drillDur4",t,u.skill.drill,new d(o),this,1,this.durationUpgrades));o++;let y=this.addNode(new Ye("drillDepth5",t,u.skill.drill,new d(o),this,n.skill.drill.tilesPerUpgrade,this.depthUpgrades,n.skill.drill.minRange)),V=this.addNode(new le("drillCool5",t,u.skill.drill,new d(o),this,1,this.coolDownUpgrades)),O=this.addNode(new de("drillDur5",t,u.skill.drill,new d(o),this,1,this.durationUpgrades));o++;let Z=this.addNode(new Ye("drillDepth6",t,u.skill.drill,new d(o),this,n.skill.drill.tilesPerUpgrade,this.depthUpgrades,n.skill.drill.minRange)),Q=this.addNode(new le("drillCool6",t,u.skill.drill,new d(o),this,1,this.coolDownUpgrades)),D=this.addNode(new de("drillDur6",t,u.skill.drill,new d(o),this,1,this.durationUpgrades)),k=this.addNode(new We("addDrillMiner3","+1 Drill Miner","Drills straight down",t,u.skill.drill,new d(o+n.skill.costs.addMiner3),this,s,re.DRILL));o++;let L=this.addNode(new Ye("drillDepth7",t,u.skill.drill,new d(o),this,n.skill.drill.tilesPerUpgrade,this.depthUpgrades,n.skill.drill.minRange)),b=this.addNode(new le("drillCool7",t,u.skill.drill,new d(o),this,1,this.coolDownUpgrades)),Ee=this.addNode(new de("drillDur7",t,u.skill.drill,new d(o),this,1,this.durationUpgrades));o++;let pe=this.addNode(new Ye("drillDepth8",t,u.skill.drill,new d(o),this,n.skill.drill.tilesPerUpgrade,this.depthUpgrades,n.skill.drill.minRange)),_e=this.addNode(new le("drillCool8",t,u.skill.drill,new d(o),this,1,this.coolDownUpgrades)),X=this.addNode(new de("drillDur8",t,u.skill.drill,new d(o),this,1,this.durationUpgrades));o++;let G=this.addNode(new Ye("drillDepth9",t,u.skill.drill,new d(o),this,n.skill.drill.tilesPerUpgrade,this.depthUpgrades,n.skill.drill.minRange)),ie=this.addNode(new le("drillCool9",t,u.skill.drill,new d(o),this,1,this.coolDownUpgrades)),je=this.addNode(new de("drillDur9",t,u.skill.drill,new d(o),this,1,this.durationUpgrades)),$e=this.addNode(new We("addDrillMiner4","+1 Drill Miner","Drills straight down",t,u.skill.drill,new d(o+n.skill.costs.addMiner4),this,s,re.DRILL));a.addChildNode(h),h.addChildNode(f),f.addChildNode(w),w.addChildNode(N),N.addChildNode(y),y.addChildNode(Z),Z.addChildNode(L),L.addChildNode(pe),pe.addChildNode(G),h.addChildNode(m),f.addChildNode(S),w.addChildNode(C),N.addChildNode(P),y.addChildNode(V),Z.addChildNode(Q),L.addChildNode(b),pe.addChildNode(_e),G.addChildNode(ie),h.addChildNode(f),f.addChildNode(w),w.addChildNode(N),N.addChildNode(y),y.addChildNode(Z),Z.addChildNode(L),L.addChildNode(pe),pe.addChildNode(G),w.addChildNode(A),Z.addChildNode(k),G.addChildNode($e),m.addChildNode(p),S.addChildNode(E),C.addChildNode(T),P.addChildNode(M),V.addChildNode(O),Q.addChildNode(D),b.addChildNode(Ee),_e.addChildNode(X),ie.addChildNode(je);let oe=3,se=13;a.setPosition(oe,se),h.setPosition(oe+1,se),f.setPosition(oe+2,se),w.setPosition(oe+3,se),N.setPosition(oe+4,se),y.setPosition(oe+5,se),Z.setPosition(oe+6,se),L.setPosition(oe+7,se),pe.setPosition(oe+8,se),G.setPosition(oe+9,se),m.setPosition(oe+1,se-1),S.setPosition(oe+2,se-1),C.setPosition(oe+3,se-1),P.setPosition(oe+4,se-1),V.setPosition(oe+5,se-1),Q.setPosition(oe+6,se-1),b.setPosition(oe+7,se-1),_e.setPosition(oe+8,se-1),ie.setPosition(oe+9,se-1),p.setPosition(oe+1,se-2),E.setPosition(oe+2,se-2),T.setPosition(oe+3,se-2),M.setPosition(oe+4,se-2),O.setPosition(oe+5,se-2),D.setPosition(oe+6,se-2),Ee.setPosition(oe+7,se-2),X.setPosition(oe+8,se-2),je.setPosition(oe+9,se-2),A.setPosition(oe+3,se+1),k.setPosition(oe+6,se+1),$e.setPosition(oe+9,se+1)}updateSkillForFrame(e,t,i){let s=this.drillByCharacter[e.id];s||(s=new jo(this.worldGrid,this.tileMinedLogic,this.depthUpgrades),this.drillByCharacter[e.id]=s,this.drillArray.push(s)),i&&!s.skillActive?s.onSkillActivation():!i&&s.skillActive&&s.onSkillDeactivation(),i&&s.updateForFrame(e,t)}getRenderer(){return this.renderer}resetFull(){super.resetFull(),this.drillArray.length=0,this.drillByCharacter={},this.depthUpgrades.reset()}};var Wt=1e3,kd=Math.PI/32,Jo=Math.PI*2,Jl=Math.PI,Qo=class extends Oi{constructor(e,t,i,s,r){super(e),this.vectorField=i,this.gameTime=t,this.tileMinedLogic=s,this.laserRangeUpgrades=r,this.prevLaserTargetTile=null,this.actualRadians=Wt,this.skillActive=!1,this.laserVisible=!1,this.prevTurn=0}onSkillActivation(){this.actualRadians=Wt,this.skillActive=!0,this.prevLaserTargetTile=null}onSkillDeactivation(){this.actualRadians=Wt,this.skillActive=!1,this.laserVisible=!1,this.prevLaserTargetTile=null}updateForFrame(e,t){if(!e.position.tile){this.laserVisible=!1,this.actualRadians=Wt;return}this.startPoint.copy(e.position.worldCoordinateOrigin),this.startPoint.addXY(n.tile.halfSize,n.tile.halfSize);let i=(n.skill.laser.minRange+n.skill.laser.tilesPerUpgrade*this.laserRangeUpgrades.getValue())*n.tile.size,s=this.chooseLaserRadians(e,i,this.startPoint);if(s===Wt){this.laserVisible=!1,this.actualRadians=Wt;return}this.actualRadians===Wt?this.actualRadians=s:this.actualRadians=this.updateRadians(this.actualRadians,s,t);let r=this.findFirstClosedTileOnLine(this.startPoint,this.actualRadians,i);if(!r){this.laserVisible=!1,this.actualRadians=Wt;return}r.markTileAsCurrentlyVisible(),this.endPoint.copy(r.origin),this.endPoint.addXY(n.tile.halfSize,n.tile.halfSize),r.open||this.tileMinedLogic.laserTileForFrame(r,t),this.laserVisible=!0}updateRadians(e,t,i){let s=kd*i,r=this.getRadiansPositiveDirection(e,t),o=this.getRadiansNegativeDirection(e,t);return r<o?r<s||r>=Jl?t:this.clamp(e+s):o<s||o>=Jl?t:this.clamp(e-s)}clamp(e){return e<0?e+Jo:e>Jo?e-Jo:e}getRadiansPositiveDirection(e,t){return t<e?Jo-e+t:t-e}getRadiansNegativeDirection(e,t){return t<e?e-t:Jo-t+e}chooseLaserRadians(e,t,i){let s=this.chooseLaserTargetTile(e,t);return s?(this.workingPosition.copy(s.origin),this.workingPosition.addXY(n.tile.halfSize,n.tile.halfSize),this.calculateAngle(i,this.workingPosition)):Wt}chooseLaserTargetTile(e,t){let i=t*t,s=e.position.worldCoordinateOrigin,r=Qe.findClosestTile(s,this.vectorField.priorityMiningCandidates);if(r)return this.prevLaserTargetTile=r,r;let o=Qe.findClosestTile(s,this.vectorField.currencyMiningCandidates);if(o)return this.prevLaserTargetTile=o,o;let a=Qe.findClosestTileInRange(s,this.vectorField.commonMiningCandidates,i);if(a)return this.prevLaserTargetTile=a,a;let h=e.target.mineTile;if(h)return this.prevLaserTargetTile=h,h;let m=e.target.targetTile;return m&&e.position.tile!==m?(this.prevLaserTargetTile=m,m):this.prevLaserTargetTile&&!this.prevLaserTargetTile.open?this.prevLaserTargetTile:(this.prevLaserTargetTile=null,null)}findFirstClosedTileOnLine(e,t,i){let s=null;for(let r=n.tile.halfSize;r<=i;r+=n.tile.halfSize){let o=Qe.projectPosition(e,r,t,this.workingPosition),a=this.getProjectedTile(s,o);if(!a)break;if(s!==a){if(a.lighting.everVisibleToCharacter||a.markTileAsCurrentlyVisible(),!a.open)return a;s=a}}return s}calculateAngle(e,t){return this.clamp(Math.atan2(t.y-e.y,t.x-e.x))}};var $o=class extends Rt{constructor(e,t){super(),this.laserArray=e,this.spellFxSpritesheet=t,this.skillAnimation=null,this.skillStart=Date.now()}renderSkill(e,t){if(this.laserArray.length!==0)for(let i=0;i<this.laserArray.length;i++)this.renderLaser(e,t,this.laserArray[i])}renderLaser(e,t,i){if(!i.laserVisible)return;let s=Date.now();s-this.skillStart>1e5&&(this.skillStart=s),this.skillAnimation||(this.skillAnimation=this.spellFxSpritesheet.getSpriteAnimation(F.EFFECT_NAME_SPARKLE_RED));let r=i.startPoint,o=i.endPoint,a=e.lineWidth;if(e.lineWidth=5,e.strokeStyle="#F00",e.beginPath(),t.worldToScreen(r,this.screenCoordinate),e.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),t.worldToScreen(o,this.screenCoordinate),e.lineTo(this.screenCoordinate.x,this.screenCoordinate.y),e.stroke(),e.lineWidth=1,e.strokeStyle="#FFF",e.beginPath(),t.worldToScreen(r,this.screenCoordinate),e.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),t.worldToScreen(o,this.screenCoordinate),e.lineTo(this.screenCoordinate.x,this.screenCoordinate.y),e.stroke(),e.lineWidth=a,t.isVisible(o,n.tile.size)){this.screenCoordinate.copy(o),this.screenCoordinate.x-=n.tile.halfSize,this.screenCoordinate.y-=n.tile.halfSize,t.worldToScreen(this.screenCoordinate,this.screenCoordinate);let h=this.skillAnimation.getSpriteAsOf(Date.now(),this.skillStart);this.renderSprite(e,t,h,this.screenCoordinate)}}};var en=class extends Te{constructor(e,t,i,s,r,o,a){super(re.LASER),this.worldGrid=e,this.tileMinedLogic=i,this.totals=t,this.crew=s,this.gameTime=r,this.vectorField=a,this.laserRangeUpgrades=new Ce(null,0),this.laserArray=[],this.laserByCharacter={},this.renderer=new $o(this.laserArray,o);let h=1,m=this.addNode(new We("addLaserMiner1","+1 Laser Miner","Blasts stone with a laser",t,u.skill.laser,new d(h+n.skill.costs.addLaser1),this,s,re.LASER));h++;let p=this.addNode(new Ye("laserRange1",t,u.skill.laser,new d(h),this,n.skill.laser.tilesPerUpgrade,this.laserRangeUpgrades,n.skill.laser.minRange)),f=this.addNode(new le("laserCool1",t,u.skill.laser,new d(h),this,1,this.coolDownUpgrades)),S=this.addNode(new de("laserDur1",t,u.skill.laser,new d(h),this,1,this.durationUpgrades));h++;let E=this.addNode(new Ye("laserRange2",t,u.skill.laser,new d(h),this,n.skill.laser.tilesPerUpgrade,this.laserRangeUpgrades,n.skill.laser.minRange)),w=this.addNode(new le("laserCool2",t,u.skill.laser,new d(h),this,1,this.coolDownUpgrades)),C=this.addNode(new de("laserDur2",t,u.skill.laser,new d(h),this,1,this.durationUpgrades));h++;let T=this.addNode(new Ye("laserRange3",t,u.skill.laser,new d(h),this,n.skill.laser.tilesPerUpgrade,this.laserRangeUpgrades,n.skill.laser.minRange)),A=this.addNode(new le("laserCool3",t,u.skill.laser,new d(h),this,1,this.coolDownUpgrades)),N=this.addNode(new de("laserDur3",t,u.skill.laser,new d(h),this,1,this.durationUpgrades));h++;let P=this.addNode(new Ye("laserRange4",t,u.skill.laser,new d(h),this,n.skill.laser.tilesPerUpgrade,this.laserRangeUpgrades,n.skill.laser.minRange)),M=this.addNode(new We("addLaserMiner2","+1 Laser Miner","Blasts stone with a laser",t,u.skill.laser,new d(h+n.skill.costs.addMiner2),this,s,re.LASER)),y=this.addNode(new le("laserCool4",t,u.skill.laser,new d(h),this,1,this.coolDownUpgrades)),V=this.addNode(new de("laserDur4",t,u.skill.laser,new d(h),this,1,this.durationUpgrades));h++;let O=this.addNode(new Ye("laserRange5",t,u.skill.laser,new d(h),this,n.skill.laser.tilesPerUpgrade,this.laserRangeUpgrades,n.skill.laser.minRange)),Z=this.addNode(new le("laserCool5",t,u.skill.laser,new d(h),this,1,this.coolDownUpgrades)),Q=this.addNode(new de("laserDur5",t,u.skill.laser,new d(h),this,1,this.durationUpgrades));h++;let D=this.addNode(new Ye("laserRange6",t,u.skill.laser,new d(h),this,n.skill.laser.tilesPerUpgrade,this.laserRangeUpgrades,n.skill.laser.minRange)),k=this.addNode(new le("laserCool6",t,u.skill.laser,new d(h),this,1,this.coolDownUpgrades)),L=this.addNode(new de("laserDur6",t,u.skill.laser,new d(h),this,1,this.durationUpgrades));h++;let b=this.addNode(new Ye("laserRange7",t,u.skill.laser,new d(h),this,n.skill.laser.tilesPerUpgrade,this.laserRangeUpgrades,n.skill.laser.minRange)),Ee=this.addNode(new We("addLaserMiner3","+1 Laser Miner","Blasts stone with a laser",t,u.skill.laser,new d(h+n.skill.costs.addMiner3),this,s,re.LASER)),pe=this.addNode(new le("laserCool7",t,u.skill.laser,new d(h),this,1,this.coolDownUpgrades)),_e=this.addNode(new de("laserDur7",t,u.skill.laser,new d(h),this,1,this.durationUpgrades));h++;let X=this.addNode(new Ye("laserRange8",t,u.skill.laser,new d(h),this,n.skill.laser.tilesPerUpgrade,this.laserRangeUpgrades,n.skill.laser.minRange)),G=this.addNode(new le("laserCool8",t,u.skill.laser,new d(h),this,1,this.coolDownUpgrades)),ie=this.addNode(new de("laserDur8",t,u.skill.laser,new d(h),this,1,this.durationUpgrades));h++;let je=this.addNode(new Ye("laserRange9",t,u.skill.laser,new d(h),this,n.skill.laser.tilesPerUpgrade,this.laserRangeUpgrades,n.skill.laser.minRange)),$e=this.addNode(new We("addLaserMiner4","+1 Laser Miner","Blasts stone with a laser",t,u.skill.laser,new d(h+n.skill.costs.addMiner4),this,s,re.LASER)),oe=this.addNode(new le("laserCool9",t,u.skill.laser,new d(h),this,1,this.coolDownUpgrades)),se=this.addNode(new de("laserDur9",t,u.skill.laser,new d(h),this,1,this.durationUpgrades));m.addChildNode(p),p.addChildNode(E),E.addChildNode(T),T.addChildNode(P),P.addChildNode(O),O.addChildNode(D),D.addChildNode(b),b.addChildNode(X),X.addChildNode(je),p.addChildNode(f),E.addChildNode(w),T.addChildNode(A),P.addChildNode(y),O.addChildNode(Z),D.addChildNode(k),b.addChildNode(pe),X.addChildNode(G),je.addChildNode(oe),f.addChildNode(S),w.addChildNode(C),A.addChildNode(N),y.addChildNode(V),Z.addChildNode(Q),k.addChildNode(L),pe.addChildNode(_e),G.addChildNode(ie),oe.addChildNode(se),T.addChildNode(M),b.addChildNode(Ee),je.addChildNode($e);let W=3,U=8;m.setPosition(W,U),p.setPosition(W+1,U),E.setPosition(W+2,U),T.setPosition(W+3,U),P.setPosition(W+4,U),O.setPosition(W+5,U),D.setPosition(W+6,U),b.setPosition(W+7,U),X.setPosition(W+8,U),je.setPosition(W+9,U),f.setPosition(W+1,U-1),w.setPosition(W+2,U-1),A.setPosition(W+3,U-1),y.setPosition(W+4,U-1),Z.setPosition(W+5,U-1),k.setPosition(W+6,U-1),pe.setPosition(W+7,U-1),G.setPosition(W+8,U-1),oe.setPosition(W+9,U-1),S.setPosition(W+1,U-2),C.setPosition(W+2,U-2),N.setPosition(W+3,U-2),V.setPosition(W+4,U-2),Q.setPosition(W+5,U-2),L.setPosition(W+6,U-2),_e.setPosition(W+7,U-2),ie.setPosition(W+8,U-2),se.setPosition(W+9,U-2),M.setPosition(W+3,U+1),Ee.setPosition(W+7,U+1),$e.setPosition(W+9,U+1)}updateSkillForFrame(e,t,i){let s=this.laserByCharacter[e.id];s||(s=new Qo(this.worldGrid,this.gameTime,this.vectorField,this.tileMinedLogic,this.laserRangeUpgrades),this.laserByCharacter[e.id]=s,this.laserArray.push(s)),i&&!s.skillActive?s.onSkillActivation():!i&&s.skillActive&&s.onSkillDeactivation(),i&&s.updateForFrame(e,t)}getRenderer(){return this.renderer}resetFull(){super.resetFull(),this.laserArray.length=0,this.laserByCharacter={},this.laserRangeUpgrades.reset()}};var tn=class{constructor(e,t,i){this.worldGrid=e,this.tileMinedLogic=t,this.missiles=i,this.active=!1,this.startPosition=new v(0,0),this.position=new v(0,0),this.movementUnitVector=new v(0,0),this.movementVector=new v(0,0),this.tile=null,this.spriteDirection=0,this.distance=0,this.missileDamage=new d(0)}resetMissile(){this.active=!1,this.tile=null,this.distance=0}onMissileFire(e,t,i){this.resetMissile(),this.startPosition.copy(e),this.startPosition.addXY(n.tile.halfSize,n.tile.halfSize);let s=this.applyRandom(t);this.spriteDirection=i,this.active=!0,Qe.projectPosition(this.startPosition,n.tile.size,s,this.position),this.tileMinedLogic.calculateMissileDamage(this.missileDamage),this.movementUnitVector.copy(this.position),this.movementUnitVector.subtract(this.startPosition),q.nor(this.movementUnitVector)}applyRandom(e){let t=Math.PI/16*Math.random();return Math.random()<.5?e-t:e+t}updateForFrame(e){if(this.movementVector.copy(this.movementUnitVector),this.movementVector.scale(e),this.distance+=e,this.position.add(this.movementVector),this.tile=this.worldGrid.findGridTile(this.position),!this.tile){this.active=!1;return}if(this.tile){this.tile.lighting.everVisibleToCharacter||this.tile.markTileAsCurrentlyVisible();let i=this.tile.open?this.findCollisionTile(this.position,this.tile):this.tile;if(i&&(i.lighting.everVisibleToCharacter||i.markTileAsCurrentlyVisible(),this.tileMinedLogic.missileTile(i,this.missileDamage),i.open&&this.missiles.addExplosion(this.position),this.missileDamage.lessThanEqualsZero())){this.active=!1;return}}let t=20*n.tile.size;if(this.distance>=t){this.active=!1;return}}findCollisionTile(e,t){for(let s=0;s<t.neighbors.length;s++){let r=t.neighbors[s];if(!(!r||r.open)&&r.intersects(e.x,e.y,3))return r}return null}};var ss=class{constructor(){this.position=new v(0,0),this.time=Date.now(),this.active=!1}activate(e){this.position.copy(e),this.time=Date.now(),this.active=!0}deactivate(){this.active=!1}};var Ll=Math.PI*2,sn=class{constructor(e,t,i,s,r){this.worldGrid=e,this.vectorField=t,this.values=r,this.missilesUpgrades=i,this.tileMinedLogic=s,this.missileExplosions=new Array(3);for(let o=0;o<this.missileExplosions.length;o++)this.missileExplosions[o]=new ss;this.missiles=[],this.activeMissiles=0,this.lastFireTime=0,this.millisBetweenFires=550,this.skillActive=!1,this.burstActive=!1,this.burstCount=0,this.burstTime=0,this.burstDelay=70,this.radians=0,this.spriteDirection=0}onSkillActivation(){this.skillActive=!0;let e=Date.now();this.burstActive=!1,this.burstTime=e-this.burstDelay,this.activeMissiles=0,this.lastFireTime=e-this.millisBetweenFires;for(let t=0;t<this.missileExplosions.length;t++)this.missileExplosions[t].deactivate();for(let t=0;t<this.missiles.length;t++)this.missiles[t].resetMissile()}onSkillDeactivation(){this.skillActive=!1;for(let e=0;e<this.missileExplosions.length;e++)this.missileExplosions[e].deactivate();this.burstActive=!1,this.activeMissiles=0}updateForFrame(e,t){if(!e.position.tile)return;let i=Date.now();if(!this.burstActive&&this.activeMissiles===0&&i-this.lastFireTime>this.millisBetweenFires&&(this.burstActive=!0,this.burstCount=0,this.burstTime=i-this.burstDelay,this.chooseBestFireDirection(e)),this.burstActive){let s=Ke.getMissileCount(this.missilesUpgrades);for(;this.missiles.length<s;)this.missiles.push(new tn(this.worldGrid,this.tileMinedLogic,this));if(i-this.burstTime>=this.burstDelay){this.burstTime=i;let r=this.missiles[this.burstCount];this.burstCount++,r.onMissileFire(e.position.worldCoordinateOrigin,this.radians,this.spriteDirection),this.activeMissiles++}this.burstCount>=s&&(this.burstActive=!1)}if(this.activeMissiles>0){let s=this.getMissileMovementPerFrame(t);this.activeMissiles=0;for(let r=0;r<this.missiles.length;r++){let o=this.missiles[r];!o||!o.active||(o.updateForFrame(s),o.active&&this.activeMissiles++)}this.activeMissiles===0&&(this.lastFireTime=i)}}getMissileMovementPerFrame(e){let t=6*e;if(this.values.fallSpeedBonusActive.isValue()){let i=Ke.getFallSpeedMultiplier(this.values.fallSpeedUpgrades.getValue());return t*i}else return t}addExplosion(e){let t=this.findAvailableExplosion();if(!t){console.log("Missiles.addExplosion() failed to find available explosion.");return}t.activate(e)}findAvailableExplosion(){let e=Ke.getMissileCount(this.missilesUpgrades);if(this.missileExplosions.length<e){for(let i=0;i<this.missileExplosions.length;i++){let s=this.missileExplosions[i];if(!s.active)return s}let t=new ss;return this.missileExplosions.push(t),t}else{let t=null,i=0;for(let s=0;s<this.missileExplosions.length;s++){let r=this.missileExplosions[s];if(!r.active)return r;(!t||r.time<i)&&(t=r,i=r.time)}return t}}chooseBestFireDirection(e){let t=this.chooseTargetTile(e);t&&t!==e.position.tile?(this.radians=this.calculateAngle(e.position.worldCoordinateOrigin,t.origin),this.spriteDirection=this.calculateSpriteDirection(this.radians)):this.chooseRandomDirection()}calculateAngle(e,t){return this.clamp(Math.atan2(t.y-e.y,t.x-e.x))}clamp(e){return e<0?e+Ll:e>Ll?e-Ll:e}chooseTargetTile(e){let t=e.position.worldCoordinateOrigin,i=Qe.findClosestTile(t,this.vectorField.priorityMiningCandidates);if(i)return i;let s=Qe.findClosestTile(t,this.vectorField.currencyMiningCandidates);if(s)return s;let r=e.target.mineTile;if(r)return r;let o=e.target.targetTile;return o||null}calculateSpriteDirection(e){let t=e*180/Math.PI;return t>=337.5||t<22.5?Ze.EAST:t>=22.5&&t<67.5?Ze.SOUTH_EAST:t>=67.5&&t<112.5?Ze.SOUTH:t>=112.5&&t<157.5?Ze.SOUTH_WEST:t>=157.5&&t<202.5?Ze.WEST:t>=202.5&&t<247.5?Ze.NORTH_WEST:t>=247.5&&t<292.5?Ze.NORTH:t>=292.5&&t<337.5?Ze.NORTH_EAST:Ze.NORTH}chooseRandomDirection(){let e=2*Math.PI;switch(ze.randomInt(8)){case 0:this.radians=0,this.spriteDirection=Ze.EAST;break;case 1:this.radians=e*(1/8),this.spriteDirection=Ze.SOUTH_EAST;break;case 2:this.radians=e*(1/4),this.spriteDirection=Ze.SOUTH;break;case 3:this.radians=e*(3/8),this.spriteDirection=Ze.SOUTH_WEST;break;case 4:this.radians=e*(1/2),this.spriteDirection=Ze.WEST;break;case 5:this.radians=e*(5/8),this.spriteDirection=Ze.NORTH_WEST;break;case 6:this.radians=e*(3/4),this.spriteDirection=Ze.NORTH;break;case 7:this.radians=e*(7/8),this.spriteDirection=Ze.NORTH_EAST;break}}};var rn=class extends Rt{constructor(e,t){super(),this.missilesArray=e,this.spellFxSpritesheet=t,this.missilesSkillAnimation=null,this.skillStart=0,this.missilesExplosionAnimation=null}renderSkill(e,t){if(this.missilesArray.length===0)return;let i=Date.now();i-this.skillStart>1e5&&(this.skillStart=i),this.missilesSkillAnimation||(this.missilesSkillAnimation=this.spellFxSpritesheet.getSpriteAnimation(F.MISSILE_EFFECT_NAME_FAT_ARROW),this.missilesExplosionAnimation=this.spellFxSpritesheet.getSpriteAnimation(F.DAMAGE_EFFECT_NAME_BLUE_DAMAGE));let s=e.lineWidth;e.lineWidth=4,e.strokeStyle="#FFA1";for(let r=0;r<this.missilesArray.length;r++)this.renderMissiles(e,t,this.missilesArray[r]);e.lineWidth=s}renderMissiles(e,t,i){if(!i.skillActive)return;let s=i.missiles;for(let a=0;a<s.length;a++){let h=s[a];if(!h||!h.active)continue;let m=h.startPosition,p=h.position;e.beginPath(),t.worldToScreen(m,this.screenCoordinate),e.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),this.screenCoordinate.copy(p),t.worldToScreen(this.screenCoordinate,this.screenCoordinate),e.lineTo(this.screenCoordinate.x,this.screenCoordinate.y),e.stroke(),this.screenCoordinate.copy(p),this.screenCoordinate.subtractXY(n.tile.halfSize,n.tile.halfSize),t.worldToScreen(this.screenCoordinate,this.screenCoordinate);let f=this.missilesSkillAnimation.getDirectionSprite(h.spriteDirection);this.renderSprite(e,t,f,this.screenCoordinate)}let r=Date.now(),o=i.missileExplosions;for(let a=0;a<o.length;a++){let h=o[a];if(!h.active)continue;let m=this.missilesExplosionAnimation.getSlowCurrentSpriteAsOfNoLooping(r,h.time);if(!m){h.deactivate();continue}this.screenCoordinate.copy(h.position),this.screenCoordinate.subtractXY(n.tile.halfSize,n.tile.halfSize),t.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.renderSprite(e,t,m,this.screenCoordinate)}}};var ct=class extends fe{constructor(e,t,i,s,r,o,a){super(e,"Missiles + "+n.skill.missiles.missilesPerUpgrade,null,t,i,s,r,o,a)}getDescription(){return"Missiles: "+Ke.getMissileCount(this.numberValue)}};var on=class extends Te{constructor(e,t,i,s,r,o,a){super(re.MISSILE),this.worldGrid=e,this.tileMinedLogic=i,this.vectorField=r,this.values=o,this.missilesUpgrades=new Ce(null,0),this.missilesArray=[],this.missilesByCharacter={},this.renderer=new rn(this.missilesArray,a);let h=1,m=this.addNode(new We("addMissileMiner1","+1 Missile Miner","Fire volleys of missiles",t,u.skill.missiles,new d(h+n.skill.costs.addMissile1),this,s,re.MISSILE));h++;let p=this.addNode(new ct("missileBonus1",t,u.skill.missiles,new d(h),this,1,this.missilesUpgrades)),f=this.addNode(new le("missileCool1",t,u.skill.missiles,new d(h),this,1,this.coolDownUpgrades)),S=this.addNode(new de("missileDur1",t,u.skill.missiles,new d(h),this,1,this.durationUpgrades));h++;let E=this.addNode(new ct("missileBonus2",t,u.skill.missiles,new d(h),this,1,this.missilesUpgrades)),w=this.addNode(new le("missileCool2",t,u.skill.missiles,new d(h),this,1,this.coolDownUpgrades)),C=this.addNode(new de("missileDur2",t,u.skill.missiles,new d(h),this,1,this.durationUpgrades));h++;let T=this.addNode(new ct("missileBonus3",t,u.skill.missiles,new d(h),this,1,this.missilesUpgrades)),A=this.addNode(new le("missileCool3",t,u.skill.missiles,new d(h),this,1,this.coolDownUpgrades)),N=this.addNode(new de("missileDur3",t,u.skill.missiles,new d(h),this,1,this.durationUpgrades)),P=this.addNode(new We("addMissileMiner2","+1 Missile Miner","Fire volleys of missiles",t,u.skill.missiles,new d(h+n.skill.costs.addMiner2),this,s,re.MISSILE));h++;let M=this.addNode(new ct("missileBonus4",t,u.skill.missiles,new d(h),this,1,this.missilesUpgrades)),y=this.addNode(new le("missileCool4",t,u.skill.missiles,new d(h),this,1,this.coolDownUpgrades)),V=this.addNode(new de("missileDur4",t,u.skill.missiles,new d(h),this,1,this.durationUpgrades));h++;let O=this.addNode(new ct("missileBonus5",t,u.skill.missiles,new d(h),this,1,this.missilesUpgrades)),Z=this.addNode(new le("missileCool5",t,u.skill.missiles,new d(h),this,1,this.coolDownUpgrades)),Q=this.addNode(new de("missileDur5",t,u.skill.missiles,new d(h),this,1,this.durationUpgrades));h++;let D=this.addNode(new ct("missileBonus6",t,u.skill.missiles,new d(h),this,1,this.missilesUpgrades)),k=this.addNode(new le("missileCool6",t,u.skill.missiles,new d(h),this,1,this.coolDownUpgrades)),L=this.addNode(new de("missileDur6",t,u.skill.missiles,new d(h),this,1,this.durationUpgrades)),b=this.addNode(new We("addMissileMiner3","+1 Missile Miner","Fire volleys of missiles",t,u.skill.missiles,new d(h+n.skill.costs.addMiner3),this,s,re.MISSILE));h++;let Ee=this.addNode(new ct("missileBonus7",t,u.skill.missiles,new d(h),this,1,this.missilesUpgrades)),pe=this.addNode(new le("missileCool7",t,u.skill.missiles,new d(h),this,1,this.coolDownUpgrades)),_e=this.addNode(new de("missileDur7",t,u.skill.missiles,new d(h),this,1,this.durationUpgrades));h++;let X=this.addNode(new ct("missileBonus8",t,u.skill.missiles,new d(h),this,1,this.missilesUpgrades)),G=this.addNode(new le("missileCool8",t,u.skill.missiles,new d(h),this,1,this.coolDownUpgrades)),ie=this.addNode(new de("missileDur8",t,u.skill.missiles,new d(h),this,1,this.durationUpgrades));h++;let je=this.addNode(new ct("missileBonus9",t,u.skill.missiles,new d(h),this,1,this.missilesUpgrades)),$e=this.addNode(new le("missileCool9",t,u.skill.missiles,new d(h),this,1,this.coolDownUpgrades)),oe=this.addNode(new de("missileDur9",t,u.skill.missiles,new d(h),this,1,this.durationUpgrades)),se=this.addNode(new We("addMissileMiner4","+1 Missile Miner","Fire volleys of missiles",t,u.skill.missiles,new d(h+n.skill.costs.addMiner4),this,s,re.MISSILE));m.addChildNode(p),p.addChildNode(E),E.addChildNode(T),T.addChildNode(M),M.addChildNode(O),O.addChildNode(D),D.addChildNode(Ee),Ee.addChildNode(X),X.addChildNode(je),p.addChildNode(f),E.addChildNode(w),T.addChildNode(A),M.addChildNode(y),O.addChildNode(Z),D.addChildNode(k),Ee.addChildNode(pe),X.addChildNode(G),je.addChildNode($e),f.addChildNode(S),w.addChildNode(C),A.addChildNode(N),y.addChildNode(V),Z.addChildNode(Q),k.addChildNode(L),pe.addChildNode(_e),G.addChildNode(ie),$e.addChildNode(oe),T.addChildNode(P),D.addChildNode(b),je.addChildNode(se);let W=3,U=-3;m.setPosition(W,U),p.setPosition(W+1,U),E.setPosition(W+2,U),T.setPosition(W+3,U),M.setPosition(W+4,U),O.setPosition(W+5,U),D.setPosition(W+6,U),Ee.setPosition(W+7,U),X.setPosition(W+8,U),je.setPosition(W+9,U),f.setPosition(W+1,U-1),w.setPosition(W+2,U-1),A.setPosition(W+3,U-1),y.setPosition(W+4,U-1),Z.setPosition(W+5,U-1),k.setPosition(W+6,U-1),pe.setPosition(W+7,U-1),G.setPosition(W+8,U-1),$e.setPosition(W+9,U-1),S.setPosition(W+1,U-2),C.setPosition(W+2,U-2),N.setPosition(W+3,U-2),V.setPosition(W+4,U-2),Q.setPosition(W+5,U-2),L.setPosition(W+6,U-2),_e.setPosition(W+7,U-2),ie.setPosition(W+8,U-2),oe.setPosition(W+9,U-2),P.setPosition(W+3,U+1),b.setPosition(W+6,U+1),se.setPosition(W+9,U+1)}updateSkillForFrame(e,t,i){let s=this.missilesByCharacter[e.id];s||(s=new sn(this.worldGrid,this.vectorField,this.missilesUpgrades,this.tileMinedLogic,this.values),this.missilesByCharacter[e.id]=s,this.missilesArray.push(s)),i&&!s.skillActive?s.onSkillActivation():!i&&s.skillActive&&s.onSkillDeactivation(),i&&s.updateForFrame(e,t)}getRenderer(){return this.renderer}resetFull(){super.resetFull(),this.missilesArray.length=0,this.missilesByCharacter={},this.missilesUpgrades.reset()}};var Ql=2*Math.PI,Fd=Math.PI/50,nn=class{constructor(e,t,i,s){this.worldGrid=e,this.tileMinedLogic=t,this.character=i,this.center=new v(0,0),this.range=0,this.radians=0,this.endPoint=new v(0,0),this.initialize(s)}onSkillActivation(e){this.initialize(e)}initialize(e){this.center.copy(this.character.position.worldCoordinateOrigin),this.center.addXY(n.tile.halfSize,n.tile.halfSize),this.range=e,Qe.projectPosition(this.center,this.range,this.radians,this.endPoint)}updateForFrame(e){this.center.copy(this.character.position.worldCoordinateOrigin),this.center.addXY(n.tile.halfSize,n.tile.halfSize),this.radians+=e*Fd,this.radians>Ql&&(this.radians-=Ql),Qe.projectPosition(this.center,this.range,this.radians,this.endPoint);let t=this.worldGrid.findGridTile(this.endPoint);t&&(t.lighting.everVisibleToCharacter||t.markTileAsCurrentlyVisible(),t.open||this.tileMinedLogic.orbitTileForFrame(t,e))}};var an=class{constructor(e,t,i,s){this.worldGrid=e,this.orbitRangeUpgrades=t,this.orbMaxUpgrades=i,this.tileMinedLogic=s,this.orbitPairs=[],this.lastPairTime=0,this.orbitIntervalMillis=500,this.skillActive=!1}onSkillActivation(){this.skillActive=!0;let e=n.skill.orbit.minRangePixels+this.orbitRangeUpgrades.getValue()*n.skill.orbit.rangePixelsPerUpgrade;for(let t=0;t<this.orbitPairs.length;t++)this.orbitPairs[t].onSkillActivation(e)}onSkillDeactivation(){this.skillActive=!1}updateForFrame(e,t){let i=n.skill.orbit.minRangePixels+this.orbitRangeUpgrades.getValue()*n.skill.orbit.rangePixelsPerUpgrade,s=!1,r=1+this.orbMaxUpgrades.getValue();for(;this.orbitPairs.length<r;)this.orbitPairs.push(new nn(this.worldGrid,this.tileMinedLogic,e,i)),s=!0;if(s&&this.orbitPairs.length>1){let o=2*Math.PI/this.orbitPairs.length,a=0;for(let h=0;h<this.orbitPairs.length;h++)this.orbitPairs[h].radians=a,a+=o}for(let o=0;o<this.orbitPairs.length;o++)this.orbitPairs[o].range=i,this.orbitPairs[o].updateForFrame(t)}};var ln=class extends Rt{constructor(e,t){super(),this.orbitArray=e,this.spellFxSpritesheet=t,this.skillAnimation=null,this.skillStart=Date.now()}renderSkill(e,t){if(this.orbitArray.length===0)return;let i=e.lineWidth;e.lineWidth=4,e.strokeStyle="#AFA1";for(let s=0;s<this.orbitArray.length;s++)this.renderOrbit(e,t,this.orbitArray[s]);e.lineWidth=i}renderOrbit(e,t,i){if(!i.skillActive)return;let s=Date.now();s-this.skillStart>1e5&&(this.skillStart=s),this.skillAnimation||(this.skillAnimation=this.spellFxSpritesheet.getSpriteAnimation(F.EFFECT_NAME_ORANGE_STAR));let r=i.orbitPairs;for(let o=0;o<r.length;o++){let a=r[o];e.beginPath(),t.worldToScreen(a.center,this.screenCoordinate),e.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),this.screenCoordinate.copy(a.endPoint),this.screenCoordinate.addXY(n.tile.halfSize,n.tile.halfSize),t.worldToScreen(this.screenCoordinate,this.screenCoordinate),e.lineTo(this.screenCoordinate.x,this.screenCoordinate.y),e.stroke(),this.screenCoordinate.copy(a.endPoint),t.worldToScreen(this.screenCoordinate,this.screenCoordinate);let h=this.skillAnimation.getSpriteAsOf(Date.now(),this.skillStart);this.renderSprite(e,t,h,this.screenCoordinate)}}};var dn=class extends Te{constructor(e,t,i,s,r){super(re.ORBIT),this.worldGrid=e,this.tileMinedLogic=i,this.totals=t,this.crew=s,this.orbMaxUpgrades=new Ce(null,0),this.orbitRangeUpgrades=new Ce(null,0),this.orbitArray=[],this.orbitByCharacter={},this.renderer=new ln(this.orbitArray,r);let o=1,a=this.addNode(new We("addOrbitMiner1","+1 Orbit Miner","Orbiting Damage",t,u.skill.orbit,new d(o+n.skill.costs.addOrbit1),this,s,re.ORBIT));o++;let h=this.addNode(new fe("orbitRange1","+1/2 Tile","Tile Range +0.5",t,u.skill.orbit,new d(o),this,1,this.orbitRangeUpgrades)),m=this.addNode(new fe("orbBonus1","+1 Orb","More Orbs",t,u.skill.orbit,new d(o),this,1,this.orbMaxUpgrades)),p=this.addNode(new le("orbCool1",t,u.skill.orbit,new d(o),this,1,this.coolDownUpgrades)),f=this.addNode(new de("orbDur1",t,u.skill.orbit,new d(o),this,1,this.durationUpgrades));o++;let S=this.addNode(new fe("orbitRange2","+1/2 Tile","Tile Range +0.5",t,u.skill.orbit,new d(o),this,1,this.orbitRangeUpgrades)),E=this.addNode(new fe("orbBonus2","+1 Orb","More Orbs",t,u.skill.orbit,new d(o),this,1,this.orbMaxUpgrades)),w=this.addNode(new le("orbCool2",t,u.skill.orbit,new d(o),this,1,this.coolDownUpgrades)),C=this.addNode(new de("orbDur2",t,u.skill.orbit,new d(o),this,1,this.durationUpgrades));o++;let T=this.addNode(new fe("orbitRange3","+1/2 Tile","Tile Range +0.5",t,u.skill.orbit,new d(o),this,1,this.orbitRangeUpgrades)),A=this.addNode(new fe("orbBonus3","+1 Orb","More Orbs",t,u.skill.orbit,new d(o),this,1,this.orbMaxUpgrades)),N=this.addNode(new le("orbCool3",t,u.skill.orbit,new d(o),this,1,this.coolDownUpgrades)),P=this.addNode(new de("orbDur3",t,u.skill.orbit,new d(o),this,1,this.durationUpgrades)),M=this.addNode(new We("addOrbitMiner2","+1 Orbit Miner","Orbiting Damage",t,u.skill.orbit,new d(o+n.skill.costs.addMiner2),this,s,re.ORBIT));o++;let y=this.addNode(new fe("orbitRange4","+1/2 Tile","Tile Range +0.5",t,u.skill.orbit,new d(o),this,1,this.orbitRangeUpgrades)),V=this.addNode(new fe("orbBonus4","+1 Orb","More Orbs",t,u.skill.orbit,new d(o),this,1,this.orbMaxUpgrades)),O=this.addNode(new le("orbCool4",t,u.skill.orbit,new d(o),this,1,this.coolDownUpgrades)),Z=this.addNode(new de("orbDur4",t,u.skill.orbit,new d(o),this,1,this.durationUpgrades));o++;let Q=this.addNode(new fe("orbitRange5","+1/2 Tile","Tile Range +0.5",t,u.skill.orbit,new d(o),this,1,this.orbitRangeUpgrades)),D=this.addNode(new fe("orbBonus5","+1 Orb","More Orbs",t,u.skill.orbit,new d(o),this,1,this.orbMaxUpgrades)),k=this.addNode(new le("orbCool5",t,u.skill.orbit,new d(o),this,1,this.coolDownUpgrades)),L=this.addNode(new de("orbDur5",t,u.skill.orbit,new d(o),this,1,this.durationUpgrades));o++;let b=this.addNode(new fe("orbitRange6","+1/2 Tile","Tile Range +0.5",t,u.skill.orbit,new d(o),this,1,this.orbitRangeUpgrades)),Ee=this.addNode(new fe("orbBonus6","+1 Orb","More Orbs",t,u.skill.orbit,new d(o),this,1,this.orbMaxUpgrades)),pe=this.addNode(new le("orbCool6",t,u.skill.orbit,new d(o),this,1,this.coolDownUpgrades)),_e=this.addNode(new de("orbDur6",t,u.skill.orbit,new d(o),this,1,this.durationUpgrades)),X=this.addNode(new We("addOrbitMiner3","+1 Orbit Miner","Orbiting Damage",t,u.skill.orbit,new d(o+n.skill.costs.addMiner3),this,s,re.ORBIT));o++;let G=this.addNode(new fe("orbitRange7","+1/2 Tile","Tile Range +0.5",t,u.skill.orbit,new d(o),this,1,this.orbitRangeUpgrades)),ie=this.addNode(new fe("orbBonus7","+1 Orb","More Orbs",t,u.skill.orbit,new d(o),this,1,this.orbMaxUpgrades)),je=this.addNode(new le("orbCool7",t,u.skill.orbit,new d(o),this,1,this.coolDownUpgrades)),$e=this.addNode(new de("orbDur7",t,u.skill.orbit,new d(o),this,1,this.durationUpgrades));o++;let oe=this.addNode(new fe("orbitRange8","+1/2 Tile","Tile Range +0.5",t,u.skill.orbit,new d(o),this,1,this.orbitRangeUpgrades)),se=this.addNode(new fe("orbBonus8","+1 Orb","More Orbs",t,u.skill.orbit,new d(o),this,1,this.orbMaxUpgrades)),W=this.addNode(new le("orbCool8",t,u.skill.orbit,new d(o),this,1,this.coolDownUpgrades)),U=this.addNode(new de("orbDur8",t,u.skill.orbit,new d(o),this,1,this.durationUpgrades));o++;let Zt=this.addNode(new fe("orbitRange9","+1/2 Tile","Tile Range +0.5",t,u.skill.orbit,new d(o),this,1,this.orbitRangeUpgrades)),Dt=this.addNode(new le("orbCool9",t,u.skill.orbit,new d(o),this,1,this.coolDownUpgrades)),bt=this.addNode(new fe("orbBonus9","+1 Orb","More Orbs",t,u.skill.orbit,new d(o),this,1,this.orbMaxUpgrades)),El=this.addNode(new de("orbDur9",t,u.skill.orbit,new d(o),this,1,this.durationUpgrades)),bl=this.addNode(new We("addOrbitMiner4","+1 Orbit Miner","Orbiting Damage",t,u.skill.orbit,new d(o+n.skill.costs.addMiner4),this,s,re.ORBIT));a.addChildNode(m),m.addChildNode(E),E.addChildNode(A),A.addChildNode(V),V.addChildNode(D),D.addChildNode(Ee),Ee.addChildNode(ie),ie.addChildNode(se),se.addChildNode(bt),m.addChildNode(p),E.addChildNode(w),A.addChildNode(N),V.addChildNode(O),D.addChildNode(k),Ee.addChildNode(pe),ie.addChildNode(je),se.addChildNode(W),bt.addChildNode(Dt),p.addChildNode(f),w.addChildNode(C),N.addChildNode(P),O.addChildNode(Z),k.addChildNode(L),pe.addChildNode(_e),je.addChildNode($e),W.addChildNode(U),Dt.addChildNode(El),f.addChildNode(h),C.addChildNode(S),P.addChildNode(T),Z.addChildNode(y),L.addChildNode(Q),_e.addChildNode(b),$e.addChildNode(G),U.addChildNode(oe),El.addChildNode(Zt),A.addChildNode(M),Ee.addChildNode(X),bt.addChildNode(bl);let he=3,ue=3;a.setPosition(he,ue),m.setPosition(he+1,ue),E.setPosition(he+2,ue),A.setPosition(he+3,ue),V.setPosition(he+4,ue),D.setPosition(he+5,ue),Ee.setPosition(he+6,ue),ie.setPosition(he+7,ue),se.setPosition(he+8,ue),bt.setPosition(he+9,ue),p.setPosition(he+1,ue-1),w.setPosition(he+2,ue-1),N.setPosition(he+3,ue-1),O.setPosition(he+4,ue-1),k.setPosition(he+5,ue-1),pe.setPosition(he+6,ue-1),je.setPosition(he+7,ue-1),W.setPosition(he+8,ue-1),Dt.setPosition(he+9,ue-1),f.setPosition(he+1,ue-2),C.setPosition(he+2,ue-2),P.setPosition(he+3,ue-2),Z.setPosition(he+4,ue-2),L.setPosition(he+5,ue-2),_e.setPosition(he+6,ue-2),$e.setPosition(he+7,ue-2),U.setPosition(he+8,ue-2),El.setPosition(he+9,ue-2),h.setPosition(he+1,ue-3),S.setPosition(he+2,ue-3),T.setPosition(he+3,ue-3),y.setPosition(he+4,ue-3),Q.setPosition(he+5,ue-3),b.setPosition(he+6,ue-3),G.setPosition(he+7,ue-3),oe.setPosition(he+8,ue-3),Zt.setPosition(he+9,ue-3),M.setPosition(he+3,ue+1),X.setPosition(he+6,ue+1),bl.setPosition(he+9,ue+1)}updateSkillForFrame(e,t,i){let s=this.orbitByCharacter[e.id];s||(s=new an(this.worldGrid,this.orbitRangeUpgrades,this.orbMaxUpgrades,this.tileMinedLogic),this.orbitByCharacter[e.id]=s,this.orbitArray.push(s)),i&&!s.skillActive?s.onSkillActivation():!i&&s.skillActive&&s.onSkillDeactivation(),i&&s.updateForFrame(e,t)}getRenderer(){return this.renderer}resetFull(){super.resetFull(),this.orbitArray.length=0,this.orbitByCharacter={},this.orbMaxUpgrades.reset(),this.orbitRangeUpgrades.reset()}};var hn=class{constructor(e,t){this.durationUpgrades=e,this.coolDownUpgrades=t,this.skillActive=!1,this.startTurn=0}initialize(e,t){this.skillActive=!1,this.startTurn=e-Ke.getSkillCoolDownTurns(this.coolDownUpgrades)+t}updateForTurn(e){let t=e-this.startTurn;this.skillActive?this.skillActive=t<Ke.getSkillActivationTurns(this.durationUpgrades):t>Ke.getSkillCoolDownTurns(this.coolDownUpgrades)&&(this.startTurn=e,this.skillActive=!0)}isSkillActive(){return this.skillActive}};var un=class{constructor(e,t,i){this.groupOffset=e,this.durationUpgrades=t,this.coolDownUpgrades=i,this.staggeredTurns=n.time.turnsPerSecond*20,this.activationTimers=[]}setMinerCount(e,t){for(;this.activationTimers.length<t;)this.activationTimers.push(new hn(this.durationUpgrades,this.coolDownUpgrades));this.initializeTimers(e)}initializeTimers(e){let t=0;for(let i=0;i<this.activationTimers.length;i++)this.activationTimers[i].initialize(e,this.groupOffset+t),t+=this.staggeredTurns}updateForTurn(e){for(let t=0;t<this.activationTimers.length;t++)this.activationTimers[t].updateForTurn(e)}isSkillActive(e){return this.activationTimers[e].isSkillActive()}resetForPrestige(){this.initializeTimers(0)}};var cn=class{constructor(e,t,i){this.gameTime=e,this.skillType=t,this.miners=[],this.skillActivationTracker=new un(i,t.durationUpgrades,t.coolDownUpgrades)}addMiner(e){this.miners.push(e),this.skillActivationTracker.setMinerCount(this.gameTime.turnNumber,this.miners.length)}updateSkillsForTurn(e){this.skillActivationTracker.updateForTurn(e)}updateSkillsForFrame(e){for(let t=0;t<this.miners.length;t++)this.skillType.updateSkillForFrame(this.miners[t],e,this.skillActivationTracker.isSkillActive(t))}resetForPrestige(){this.skillActivationTracker.resetForPrestige()}};var Fe=class extends ve{constructor(e,t,i,s,r,o){super(e,"Fall Speed +"+I.formatNumber(n.skill.bonus.fallSpeedMuliplierPerUgrade),null,t,i,s,r),this.values=o}getDescription(){let e=1+this.values.fallSpeedUpgrades.getValue()*n.skill.bonus.fallSpeedMuliplierPerUgrade;return"FallSpeed: x"+I.formatNumber(e)}onPurchase(){return super.onPurchase()?(this.applyUpgrade(),!0):!1}onPurchaseFromSave(){this.applyUpgrade(),super.onPurchaseFromSave()}applyUpgrade(){this.values.fallSpeedUpgrades.incrementValue(1)}};var mn=class extends Te{constructor(e,t){super(re.FALL_BONUS),this.values=t;let i=15,s=75,r=this.addNode(new Fe("fallBonus1",e,u.offline,new d(s),this,this.values));s+=i;let o=this.addNode(new Fe("fallBonus2",e,u.offline,new d(s),this,this.values));s+=i;let a=this.addNode(new Fe("fallBonus3",e,u.offline,new d(s),this,this.values));s+=i;let h=this.addNode(new Fe("fallBonus4",e,u.offline,new d(s),this,this.values));s+=i;let m=this.addNode(new Fe("fallBonus5",e,u.offline,new d(s),this,this.values));s+=i;let p=this.addNode(new Fe("fallBonus6",e,u.offline,new d(s),this,this.values));s+=i;let f=this.addNode(new Fe("fallBonus7",e,u.offline,new d(s),this,this.values));s+=i;let S=this.addNode(new Fe("fallBonus8",e,u.offline,new d(s),this,this.values));s+=i;let E=this.addNode(new Fe("fallBonus9",e,u.offline,new d(s),this,this.values));s+=i;let w=this.addNode(new Fe("fallBonus10",e,u.offline,new d(s),this,this.values));s+=i;let C=this.addNode(new Fe("fallBonus11",e,u.offline,new d(s),this,this.values));s+=i;let T=this.addNode(new Fe("fallBonus12",e,u.offline,new d(s),this,this.values));s+=i;let A=this.addNode(new Fe("fallBonus13",e,u.offline,new d(s),this,this.values));s+=i;let N=this.addNode(new Fe("fallBonus14",e,u.offline,new d(s),this,this.values));s+=i;let P=this.addNode(new Fe("fallBonus15",e,u.offline,new d(s),this,this.values));s+=i;let M=this.addNode(new Fe("fallBonus16",e,u.offline,new d(s),this,this.values));s+=i;let y=this.addNode(new Fe("fallBonus17",e,u.offline,new d(s),this,this.values));s+=i;let V=this.addNode(new Fe("fallBonus18",e,u.offline,new d(s),this,this.values));s+=i;let O=this.addNode(new Fe("fallBonus19",e,u.offline,new d(s),this,this.values));s+=i;let Z=this.addNode(new Fe("fallBonus20",e,u.offline,new d(s),this,this.values));s+=i;let Q=this.addNode(new Fe("fallBonus21",e,u.offline,new d(s),this,this.values));r.addChildNode(o),o.addChildNode(a),a.addChildNode(h),h.addChildNode(m),m.addChildNode(p),p.addChildNode(f),f.addChildNode(S),S.addChildNode(E),E.addChildNode(w),w.addChildNode(C),C.addChildNode(T),T.addChildNode(A),A.addChildNode(N),N.addChildNode(P),P.addChildNode(M),M.addChildNode(y),y.addChildNode(V),V.addChildNode(O),O.addChildNode(Z),Z.addChildNode(Q);let D=4,k=-15;r.setPosition(D,k),o.setPosition(D+1,k),a.setPosition(D+2,k),h.setPosition(D+3,k),m.setPosition(D+4,k),p.setPosition(D+5,k),f.setPosition(D+6,k),S.setPosition(D+6,k-1),E.setPosition(D+5,k-1),w.setPosition(D+4,k-1),C.setPosition(D+3,k-1),T.setPosition(D+2,k-1),A.setPosition(D+1,k-1),N.setPosition(D,k-1),P.setPosition(D,k-2),M.setPosition(D+1,k-2),y.setPosition(D+2,k-2),V.setPosition(D+3,k-2),O.setPosition(D+4,k-2),Z.setPosition(D+5,k-2),Q.setPosition(D+6,k-2)}};var Ge=class extends ve{constructor(e,t,i,s,r,o,a,h){super(e,"Ruby +"+I.formatNumber(n.ruby.baseBonusPerUpgrade+n.ruby.incrementBonusPerUpgrade*h),null,t,i,s,r),this.values=o,this.mineDamageLogic=a,this.purchaseIndex=h}getDescription(){let e=this.values.skillRubyBonusMultiplier.getValue()+n.ruby.multiplierPerRuby;return"Damage / Ruby: "+I.formatNumber(e)}onPurchase(){return super.onPurchase()?(this.applyUpgrade(),this.mineDamageLogic.calculateTotalMineDamagePerTurn(),!0):!1}onPurchaseFromSave(){this.applyUpgrade(),super.onPurchaseFromSave()}applyUpgrade(){let e=n.ruby.baseBonusPerUpgrade+n.ruby.incrementBonusPerUpgrade*this.purchaseIndex;this.values.skillRubyBonusMultiplier.incrementValue(e)}};var pn=class extends Te{constructor(e,t,i){super(re.RUBY_BONUS),this.values=t;let s=50,r=200,o=0,a=this.addNode(new Ge("rubyBonus1",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let h=this.addNode(new Ge("rubyBonus2",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let m=this.addNode(new Ge("rubyBonus3",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let p=this.addNode(new Ge("rubyBonus4",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let f=this.addNode(new Ge("rubyBonus5",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let S=this.addNode(new Ge("rubyBonus6",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let E=this.addNode(new Ge("rubyBonus7",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let w=this.addNode(new Ge("rubyBonus8",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let C=this.addNode(new Ge("rubyBonus9",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let T=this.addNode(new Ge("rubyBonus10",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let A=this.addNode(new Ge("rubyBonus11",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let N=this.addNode(new Ge("rubyBonus12",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let P=this.addNode(new Ge("rubyBonus13",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let M=this.addNode(new Ge("rubyBonus14",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let y=this.addNode(new Ge("rubyBonus15",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let V=this.addNode(new Ge("rubyBonus16",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let O=this.addNode(new Ge("rubyBonus17",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let Z=this.addNode(new Ge("rubyBonus18",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let Q=this.addNode(new Ge("rubyBonus19",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let D=this.addNode(new Ge("rubyBonus20",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let k=this.addNode(new Ge("rubyBonus21",e,u.currency.ruby,new d(r),this,this.values,i,o));a.addChildNode(h),h.addChildNode(m),m.addChildNode(p),p.addChildNode(f),f.addChildNode(S),S.addChildNode(E),E.addChildNode(w),w.addChildNode(C),C.addChildNode(T),T.addChildNode(A),A.addChildNode(N),N.addChildNode(P),P.addChildNode(M),M.addChildNode(y),y.addChildNode(V),V.addChildNode(O),O.addChildNode(Z),Z.addChildNode(Q),Q.addChildNode(D),D.addChildNode(k);let L=-1,b=-12;a.setPosition(L,b),h.setPosition(L-1,b),m.setPosition(L-2,b),p.setPosition(L-3,b),f.setPosition(L-4,b),S.setPosition(L-5,b),E.setPosition(L-6,b),w.setPosition(L-6,b-1),C.setPosition(L-5,b-1),T.setPosition(L-4,b-1),A.setPosition(L-3,b-1),N.setPosition(L-2,b-1),P.setPosition(L-1,b-1),M.setPosition(L,b-1),y.setPosition(L,b-2),V.setPosition(L-1,b-2),O.setPosition(L-2,b-2),Z.setPosition(L-3,b-2),Q.setPosition(L-4,b-2),D.setPosition(L-5,b-2),k.setPosition(L-6,b-2)}};var Ve=class extends ve{constructor(e,t,i,s,r,o,a,h){super(e,"Mined Blocks +"+I.formatNumber(n.blocks.baseBonusPerUpgrade+n.blocks.incrementBonusPerUpgrade*h),null,t,i,s,r),this.values=o,this.mineDamageLogic=a,this.purchaseIndex=h}getDescription(){let e=this.values.skillBlockBonusMultiplier.getValue()+n.blocks.multiplierPerBlock;return"Damage / Block: "+I.formatNumber(e)}onPurchase(){return super.onPurchase()?(this.applyUpgrade(),this.mineDamageLogic.calculateTotalMineDamagePerTurn(),!0):!1}onPurchaseFromSave(){this.applyUpgrade(),super.onPurchaseFromSave()}applyUpgrade(){let e=n.blocks.baseBonusPerUpgrade+n.blocks.incrementBonusPerUpgrade*this.purchaseIndex;this.values.skillBlockBonusMultiplier.incrementValue(e)}};var gn=class extends Te{constructor(e,t,i){super(re.BLOCKS_BONUS),this.values=t;let s=250,r=500,o=0,a=this.addNode(new Ve("blocksBonus1",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let h=this.addNode(new Ve("blocksBonus2",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let m=this.addNode(new Ve("blocksBonus3",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let p=this.addNode(new Ve("blocksBonus4",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let f=this.addNode(new Ve("blocksBonus5",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let S=this.addNode(new Ve("blocksBonus6",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let E=this.addNode(new Ve("blocksBonus7",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let w=this.addNode(new Ve("blocksBonus8",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let C=this.addNode(new Ve("blocksBonus9",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let T=this.addNode(new Ve("blocksBonus10",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let A=this.addNode(new Ve("blocksBonus11",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let N=this.addNode(new Ve("blocksBonus12",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let P=this.addNode(new Ve("blocksBonus13",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let M=this.addNode(new Ve("blocksBonus14",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let y=this.addNode(new Ve("blocksBonus15",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let V=this.addNode(new Ve("blocksBonus16",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let O=this.addNode(new Ve("blocksBonus17",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let Z=this.addNode(new Ve("blocksBonus18",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let Q=this.addNode(new Ve("blocksBonus19",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let D=this.addNode(new Ve("blocksBonus20",e,u.currency.ruby,new d(r),this,this.values,i,o));r+=s,o++;let k=this.addNode(new Ve("blocksBonus21",e,u.currency.ruby,new d(r),this,this.values,i,o));a.addChildNode(h),h.addChildNode(m),m.addChildNode(p),p.addChildNode(f),f.addChildNode(S),S.addChildNode(E),E.addChildNode(w),w.addChildNode(C),C.addChildNode(T),T.addChildNode(A),A.addChildNode(N),N.addChildNode(P),P.addChildNode(M),M.addChildNode(y),y.addChildNode(V),V.addChildNode(O),O.addChildNode(Z),Z.addChildNode(Q),Q.addChildNode(D),D.addChildNode(k);let L=-1,b=-16;a.setPosition(L,b),h.setPosition(L-1,b),m.setPosition(L-2,b),p.setPosition(L-3,b),f.setPosition(L-4,b),S.setPosition(L-5,b),E.setPosition(L-6,b),w.setPosition(L-6,b-1),C.setPosition(L-5,b-1),T.setPosition(L-4,b-1),A.setPosition(L-3,b-1),N.setPosition(L-2,b-1),P.setPosition(L-1,b-1),M.setPosition(L,b-1),y.setPosition(L,b-2),V.setPosition(L-1,b-2),O.setPosition(L-2,b-2),Z.setPosition(L-3,b-2),Q.setPosition(L-4,b-2),D.setPosition(L-5,b-2),k.setPosition(L-6,b-2)}};var fn=class extends K{constructor(e,t,i,s,r,o,a,h,m){super(),this.gameTime=e,this.skills=[],this.skillById={},this.skillGroups=[],this.skillGroupMinerCount=-1,this.crew=a,this.centerOffset=new v(0,0),this.zoom=100,this.addSkill(new on(t,i,r,a,h,s,m)),this.addSkill(new en(t,i,r,a,e,m,h)),this.addSkill(new qo(t,i,r,a,m)),this.addSkill(new dn(t,i,r,a,m)),this.addSkill(new Yo(i,s)),this.addSkill(new Ko(i,s,o)),this.addSkill(new zo(i,s,o)),this.addSkill(new pn(i,s,o)),this.addSkill(new gn(i,s,o)),this.addSkill(new Wo(i,s)),this.addSkill(new mn(i,s)),this.addSkill(new Xo(i,s)),this.addSkill(new Vo(i,s)),this.addSkill(new Uo(i,s)),this.addSkill(new Ho(i,s))}updateCenter(e,t){let i=this.zoom/100,s=e/i,r=t/i;this.centerOffset.addXY(s,r)}addSkill(e){this.skills.push(e),this.skillById[e.id]=e}findSkillById(e){return this.skillById[e]}findSkillGroupById(e){for(let t=0;t<this.skillGroups.length;t++){let i=this.skillGroups[t];if(e===i.skillType.id)return i}return null}rebuildSkillGroups(){this.skillGroups.length=0;let e=this.crew.miners,t=0;for(let i=0;i<e.length;i++){let s=e[i],r=s.skillId;if(!r)continue;let o=this.findSkillGroupById(r);if(!o){let a=this.findSkillById(r);if(!a){console.log("SkillTreeGraph.rebuildSkillGroups() Failed to find skill: "+r);continue}o=new cn(this.gameTime,a,t),this.skillGroups.push(o),t+=n.time.turnsPerSecond*5}o.addMiner(s)}}updateSkillsForTurn(){this.assertMinerCountMatchesSkillGroups();let e=this.gameTime.turnNumber;for(let t=0;t<this.skillGroups.length;t++)this.skillGroups[t].updateSkillsForTurn(e)}updateSkillsForFrame(e){this.assertMinerCountMatchesSkillGroups();for(let t=0;t<this.skillGroups.length;t++)this.skillGroups[t].updateSkillsForFrame(e)}assertMinerCountMatchesSkillGroups(){let e=this.crew.miners;this.skillGroupMinerCount!=e.length&&(this.skillGroupMinerCount=e.length,this.rebuildSkillGroups())}setZoom(e){this.zoom=e,this.zoom<n.skillGraph.minZoom&&(this.zoom=n.skillGraph.minZoom),this.zoom>n.skillGraph.maxZoom&&(this.zoom=n.skillGraph.maxZoom)}zoomOut(){this.zoom-=n.skillGraph.zoomStep,this.zoom<n.skillGraph.minZoom&&(this.zoom=n.skillGraph.minZoom)}zoomIn(){this.zoom+=n.skillGraph.zoomStep,this.zoom>n.skillGraph.maxZoom&&(this.zoom=n.skillGraph.maxZoom)}resetFull(){for(let e=0;e<this.skills.length;e++)this.skills[e].resetFull();this.skillGroups.length=0}resetForPrestige(){for(let e=0;e<this.skillGroups.length;e++)this.skillGroups[e].resetForPrestige()}};var rs=class{constructor(){}static generateSave(e){let t={};t.skills=[];for(let i=0;i<e.skills.length;i++)t.skills.push(this.generateSkillSave(e.skills[i]));return t}static loadSave(e,t){if(!t){console.log("SkillTreeSave.loadSave() No save state. Not loading skills!");return}let i=t.skills;if(!i||i.length===0){console.log("SkillTreeSave.loadSave() No skill save data found");return}for(let s=0;s<i.length;s++)try{this.loadSkillSave(e,i[s])}catch(r){console.error("SkillTreeSave.loadSave() Failed to load skill.",r.message)}}static generateSkillSave(e){let t={};t.id=e.id,t.points=B.save(e.pointsSpent),t.unlocked=e.unlocked,t.nodes=[];for(let i=0;i<e.nodes.length;i++)t.nodes.push(this.generateSkillNodeSave(e.nodes[i]));return t}static loadSkillSave(e,t){if(!t)return;let i=t.id;if(!i){console.log("SkillTreeSave.loadSkillSave() No id found for skill.");return}let s=e.findSkillById(i);if(!s){console.log("SkillTreeSave.loadSkillSave() Failed to find skill for id="+i);return}B.load(t.points,s.pointsSpent),s.unlocked=t.unlocked;let r=t.nodes;if(!r||r.length===0){console.log("SkillTreeSave.loadSkillSave() No skill nodes saved for skill id="+i);return}for(let o=0;o<r.length;o++)this.loadSkillNodeSave(s,r[o]);s.onSaveLoad()}static generateSkillNodeSave(e){let t={};return t.id=e.id,t.purchased=e.purchased,t}static loadSkillNodeSave(e,t){if(!t){console.log("SkillTreeSave.loadSkillNodeSave() No node save state.");return}let i=t.id;if(!i){console.log("SkillTreeSave.loadSkillNodeSave() No id found for skill node.");return}let s=e.getSkillNodeById(i);if(!s){console.log("SkillTreeSave.loadSkillNodeSave() No skill node found for id="+i);return}if(t.purchased)try{s.onPurchaseFromSave()}catch(r){throw console.error("SaveTreeSave.loadSkillNodeSave() Failed to load skill node: "+i,r.message),r}}};var os=class{constructor(){}static generateSave(e){let t={};return t.basePick=B.save(e.basePickDamagePerTurn),t.totalPick=B.save(e.totalPickDamagePerTurn),t}static loadSave(e,t){t&&(B.load(t.basePick,e.basePickDamagePerTurn),B.load(t.totalPick,e.totalPickDamagePerTurn))}};var Tn=class{constructor(e,t,i,s,r,o,a,h){this.id=e,this.title=t,this.description=i,this.spriteFileName=s,this.gameTime=r,this.totals=o,this.cost=a,this.activationTurns=h,this.activated=!1,this.startTurn=0}getTitle(){return this.title}getDescription(){return this.description}isAffordable(){return this.cost.lessThanEquals(this.totals.gold)}isPurchasable(){return!(this.activated||!this.isAffordable())}onPurchase(){this.isPurchasable()&&(this.totals.decrementGold(this.cost),this.onActivation())}getActivationPercent(){if(!this.activated)return 0;let e=this.gameTime.turnNumber-this.startTurn;return Math.min(1,e/this.activationTurns)*100}onActivation(){return this.activated?!1:(this.startTurn=this.gameTime.turnNumber,this.activated=!0,!0)}onActivationFromSave(){this.activated=!0}onDeactivation(){return this.activated?(this.activated=!1,!0):!1}updateForTurn(){if(this.activated){let e=this.gameTime.turnNumber;this.activated=e-this.startTurn<this.activationTurns,this.activated||this.onDeactivation()}}getActivationValue(){}reset(){this.activated=!1,this.startTurn=0}};var Yt=class{constructor(e,t,i){this.id=e,this.gameTime=t,this.totals=i}createBonus(){}createBonusFromSave(e){}};var Kt=class extends Tn{constructor(e,t,i,s,r,o,a,h,m,p){super(e,t,i,s,r,o,a,h),this.numberValue=m,this.activeValue=p}onActivation(){return super.onActivation()?(this.numberValue.incrementValue(this.activeValue),!0):!1}onActivationFromSave(){super.onActivationFromSave(),this.numberValue.incrementValue(this.activeValue)}onDeactivation(){return super.onDeactivation()?(this.numberValue.decrementValue(this.activeValue),!0):!1}getActivationValue(){return this.activeValue}reset(){super.reset(),this.numberValue.reset()}};var En=class extends Yt{constructor(e,t,i,s){super(e,t,i),this.numberValue=s,this.cost=new d(n.bonus.activationCost)}createBonus(){return this.createBonusInternal(2)}createBonusFromSave(e){return this.createBonusInternal(e)}createBonusInternal(e){let t=n.bonus.activationTurns;return new Kt(this.id,"Gold Bonus","Gold +"+e,u.currency.gold,this.gameTime,this.totals,this.cost,t,this.numberValue,e)}};var Cn=class extends Yt{constructor(e,t,i,s){super(e,t,i),this.numberValue=s,this.cost=new d(n.bonus.activationCost)}createBonus(){return this.createBonusInternal(50)}createBonusFromSave(e){return this.createBonusInternal(e)}createBonusInternal(e){let t=n.bonus.activationTurns;return new Kt(this.id,"Ore Multiplier","Ore x"+e,u.currency.ore,this.gameTime,this.totals,this.cost,t,this.numberValue,e)}};var wn=class extends Yt{constructor(e,t,i,s){super(e,t,i),this.numberValue=s,this.cost=new d(n.bonus.activationCost)}createBonus(){return this.createBonusInternal(10)}createBonusFromSave(e){return this.createBonusInternal(e)}createBonusInternal(e){let t=n.bonus.activationTurns;return new Kt(this.id,"Upgrade Multiplier","Upgrades x"+e,u.currency.upgrades,this.gameTime,this.totals,this.cost,t,this.numberValue,e)}};var Sn=class extends K{constructor(e,t,i){super(),this.gameTime=e,this.totals=t,this.values=i,this.availableBonuses=[],this.activeBonuses=[],this.availableChangeCount=0,this.activeChangeCount=0,this.bonusCreators=[],this.bonusCreatorById={},this.prevBonusTurn=-n.bonus.newBonusTurns,this.addBonusCreator(new Cn("oreBonus",this.gameTime,this.totals,this.values.bonusOreMultiplier)),this.addBonusCreator(new wn("upgradeBonus",this.gameTime,this.totals,this.values.bonusUpgradeMultiplier)),this.addBonusCreator(new En("goldBonus",this.gameTime,this.totals,this.values.bonusGoldIncrement))}addBonusCreator(e){this.bonusCreators.push(e),this.bonusCreatorById[e.id]=e}add(e){if(!e){console.log("BonusCollection.add() null bonus");return}this.availableBonuses.push(e),this.availableChangeCount++}addActiveBonusFromSave(e){if(!e){console.log("BonusCollection.addActiveBonusFromSave() null bonus");return}this.activeBonuses.push(e),this.activeChangeCount++,console.log("********** addActiveBonusFromSave() ADDED ACTIVE. len="+this.activeBonuses.length)}activateBonus(e){if(console.log("****************** activatebonus "+e.id+"   current length: "+this.activeBonuses.length),e.activated){console.log("BonusCollection.activateBonus() bonus already activated.");return}this.remove(e)?(e.onPurchase(),console.log("********** activateBonus() BONUS IS ACTIVATED: "+e.activated),this.activeBonuses.push(e),this.activeChangeCount++,console.log("********** activateBonus() ADDED ACTIVE. len="+this.activeBonuses.length)):console.log("**************** failed to add active")}remove(e){if(!e)return console.log("BonusCollection.remove() bonus null"),!1;let t=this.availableBonuses.indexOf(e);return t===-1?(console.log("BonusCollection.remove() did not find bonus in list"),!1):(this.availableBonuses.splice(t,1),this.availableChangeCount++,!0)}updateForTurn(){for(let t=this.activeBonuses.length-1;t>=0;t--){let i=this.activeBonuses[t];i.updateForTurn(),i.activated||(this.activeBonuses.splice(t,1),this.activeChangeCount++)}if(this.gameTime.turnNumber-this.prevBonusTurn>=n.bonus.newBonusTurns){this.prevBonusTurn=this.gameTime.turnNumber;let t=this.createRandomBonus();this.add(t)}}createRandomBonus(){let e=ze.randomInt(this.bonusCreators.length);return this.bonusCreators[e].createBonus()}createBonusFromSave(e,t){let i=this.bonusCreatorById[e];return i?i.createBonusFromSave(t):(console.log("BonusCollection.createBonusById() Failed to find creator by id: "+e),null)}purchaseBonus(e){return e?e.isPurchasable()?this.availableBonuses.indexOf(e)<0?(console.log("BonusCollection.purchaseBonus() failed to find bonus in available list"),!1):(this.activateBonus(e),!0):(console.log("BonusCollection.purchaseBonus() bonus not purchasable"),!1):(console.log("BonusCollection.purchaseBonus() null bonus"),!1)}resetFull(){for(let e=0;e<this.activeBonuses.length;e++)this.activeBonuses[e].reset();this.availableBonuses.length=0,this.activeBonuses.length=0,this.availableChangeCount=0,this.activeChangeCount=0,this.prevBonusTurn=-n.bonus.newBonusTurns}resetForPrestige(){this.resetFull()}};var ns=class{constructor(){}static generateSave(e){let t={};t.availableBonuses=[],t.activeBonuses=[],t.prevBonusTurn=e.prevBonusTurn;for(let i=0;i<e.activeBonuses.length;i++)e.activeBonuses[i]&&t.activeBonuses.push(this.generateBonusSave(e.activeBonuses[i]));for(let i=0;i<e.availableBonuses.length;i++)e.availableBonuses[i]&&t.availableBonuses.push(this.generateBonusSave(e.availableBonuses[i]));return t}static loadSave(e,t){if(!t){console.log("BonusCollectionSave.loadSave no save state");return}let i=t.prevBonusTurn;if(i&&(e.prevBonusTurn=i),t.availableBonuses)for(let s=0;s<t.availableBonuses.length;s++)this.loadBonusSave(e,t.availableBonuses[s]);if(t.activeBonuses)for(let s=0;s<t.activeBonuses.length;s++)this.loadBonusSave(e,t.activeBonuses[s])}static generateBonusSave(e){let t={};return t.id=e.id,t.activated=e.activated,t.startTurn=e.startTurn,t.activationValue=e.getActivationValue(),t}static loadBonusSave(e,t){if(!t)return;let i=t.id,s=t.activated,r=t.startTurn,o=t.activationValue,a=e.createBonusFromSave(i,o);if(!a){console.log("BonusCollectionSave.loadBonusSave() no bonus created for: "+i);return}a.startTurn=r,s?(e.addActiveBonusFromSave(a),a.onActivationFromSave()):e.add(a)}};var Nn=class extends K{constructor(){super(),this.CALLBACK_GAME_RESET=1,this.CALLBACK_GAME_DELETE=2,this.CALLBACK_GAME_IMPORT=3,this.CALLBACK_GAME_PRESTIGE=4}getState(){return null}startGame(){}prestigeGame(){}resetGame(){}deleteGame(){}importSave(e){}modelLoadCallback(e){}};var Xt=class extends K{constructor(e,t,i,s,r){super(),this.gameTime=e,this.automationUnlockedValue=t,this.automationRateUpgrades=i,this.baseUpgradeDelayTurns=s,this.turnsPerRateUpgrade=r,this.lastAutomationTurn=0,this.lastAutomationFrame=0,this.active=!0}getDelayTurns(){return Math.max(n.automation.minDelayTurns,this.baseUpgradeDelayTurns-this.automationRateUpgrades.getValue()*this.turnsPerRateUpgrade)}updateForTurn(){if(!this.active||!this.automationUnlockedValue.isValue())return;let e=this.gameTime.turnNumber,t=this.getDelayTurns();e-this.lastAutomationTurn<t||(this.lastAutomationTurn=e,this.lastAutomationFrame=this.gameTime.frameNumber,this.purchaseUpgrade())}purchaseUpgrade(){}isUnlocked(){return this.automationUnlockedValue.isValue()}toggleActiveFlag(){this.active=!this.active}getActivationPercent(){if(!this.active)return 0;let e=this.getDelayTurns()*n.time.turnFrames,t=this.gameTime.frameNumber-this.lastAutomationFrame;return Math.min(1,t/e)*100|0}resetFull(){this.lastAutomationTurn=0,this.lastAutomationFrame=0}resetForPrestige(){this.lastAutomationTurn=0,this.lastAutomationFrame=0}};var Pn=class extends Xt{constructor(e,t,i){super(e,i.minedAutomationUnlocked,i.minedAutomationRateUpgrades,n.automation.baseUpgradeDelayTurns,n.automation.turnsPerRateUpgrade),this.minedUpgradeCollection=t}purchaseUpgrade(){let e=this.minedUpgradeCollection.upgrades;if(e.length===0)return;let t=ze.randomInt(e.length),i=e[t];i&&i.isPurchasable()&&(i.purchase(),this.minedUpgradeCollection.remove(i))}};var An=class extends Xt{constructor(e,t,i){super(e,i.pickAutomationUnlocked,i.pickAutomationRateUpgrades,n.automation.baseUpgradeDelayTurns,n.automation.turnsPerRateUpgrade),this.pickUpgradeCollection=t,this.validUpgrades=[],this.workingScore=new d(0),this.bestScore=new d(0),this.additive=!0}purchaseUpgrade(){if(this.pickUpgradeCollection.upgrades.length===0||(this.additive=!this.additive,this.findValidUpgrades(),this.validUpgrades.length===0))return;let t=this.selectBestUpgrade(this.additive);t&&t.purchase()}findValidUpgrades(){this.validUpgrades.length=0;let e=this.pickUpgradeCollection.upgrades;for(let t=0;t<e.length;t++){let i=e[t];this.isValidUpgrade(i)&&this.validUpgrades.push(i)}}selectBestUpgrade(e){let t=this.selectBestUpgradeByType(!0),i=this.selectBestUpgradeByType(!1);return!t&&!i?null:t?i?e?t:i:t:i}selectBestUpgradeByType(e){this.bestScore.setZero();let t=null;for(let i=0;i<this.validUpgrades.length;i++){let s=this.validUpgrades[i];if(s.additiveUpgrade!==e)continue;let r=this.getUpgradeScore(s);(!t||r.greaterThan(this.bestScore))&&(t=s,this.bestScore.copy(r))}return t}getUpgradeScore(e){return this.workingScore.copy(e.valuePerUpgrade),this.workingScore.mulNumber(e.nextActualPurchaseCount),this.workingScore.div(e.getCost()),this.workingScore}isValidUpgrade(e){return e?e.isVisible()&&e.isPurchasable():!1}};var Mn=class extends Xt{constructor(e,t,i,s){super(e,t.prestigeAutomationUnlocked,t.prestigeAutomationRateUpgrades,n.automation.prestigeUpgradeDelayTurns,n.automation.prestigeTurnsPerRateUpgrade),this.gameStateControl=i,this.totals=s,this.prestigePossible=!1,this.prevUnclaimedPrestige=new d(0),this.lastPrestigeChangeTurn=0}updateForTurn(){this.isPrestigeCriteriaSatisfied()&&(this.lastAutomationTurn===0&&(this.lastAutomationTurn=this.gameTime.turnNumber,this.lastAutomationFrame=this.gameTime.frameNumber),super.updateForTurn())}isPrestigeCriteriaSatisfied(){return this.prestigePossible?!0:this.totals.unclaimedPrestige.equalsZero()||(this.prevUnclaimedPrestige.equals(this.totals.unclaimedPrestige)||(this.prevUnclaimedPrestige.copy(this.totals.unclaimedPrestige),this.lastPrestigeChangeTurn=this.gameTime.turnNumber),this.lastPrestigeChangeTurn===0)||this.gameTime.turnNumber-this.lastPrestigeChangeTurn<n.automation.prestigeMinTurnsSinceLastChange?!1:(this.prestigePossible=!0,!0)}getElapsedTurnsSincePrestige(){return this.gameTime.turnNumber-this.lastPrestigeChangeTurn}getCriteriaPercent(){if(this.prestigePossible)return 0;let e=this.gameTime.turnNumber-this.lastPrestigeChangeTurn,t=n.automation.prestigeMinTurnsSinceLastChange;return Math.min(1,e/t)*100|0}getActivationPercent(){return this.prestigePossible?super.getActivationPercent():0}purchaseUpgrade(){this.gameStateControl.prestigeGame()}resetFull(){super.resetFull(),this.resetInternal()}resetForPrestige(){super.resetForPrestige(),this.resetInternal()}resetInternal(){this.prestigePossible=!1,this.lastPrestigeChangeTurn=0,this.prevUnclaimedPrestige.setZero()}};var _n=class extends K{constructor(e,t,i,s,r,o){super(),this.gameTime=o,this.minedUpgradeAutomation=new Pn(o,e,s,o),this.pickUpgradeAutomation=new An(o,t,s,o),this.prestigeAutomation=new Mn(o,s,i,r)}updateForTurn(){this.minedUpgradeAutomation.updateForTurn(),this.pickUpgradeAutomation.updateForTurn(),this.prestigeAutomation.updateForTurn()}resetFull(){this.minedUpgradeAutomation.resetFull(),this.pickUpgradeAutomation.resetFull(),this.prestigeAutomation.resetFull()}resetForPrestige(){this.minedUpgradeAutomation.resetForPrestige(),this.pickUpgradeAutomation.resetForPrestige(),this.prestigeAutomation.resetForPrestige()}};var as=class{constructor(){}static generateSave(e){let t={};return t.prevTurn=e.prevTurn,t.minedAutomation=this.generateAutomationSave(e.minedUpgradeAutomation),t.pickAutomation=this.generateAutomationSave(e.pickUpgradeAutomation),t.prestigeAutomation=this.generatePrestigeAutomationSave(e.prestigeAutomation),t}static loadSave(e,t){t&&(e.prevTurn=t.prevTurn,this.loadAutomationSave(e.minedUpgradeAutomation,t.minedAutomation),this.loadAutomationSave(e.pickUpgradeAutomation,t.pickAutomation),this.loadPrestigeAutomationSave(e.prestigeAutomation,t.prestigeAutomation))}static generateAutomationSave(e){let t={};return t.lastAutomationTurn=e.lastAutomationTurn,t.active=e.active,t}static loadAutomationSave(e,t){t&&(e.lastAutomationTurn=t.lastAutomationTurn,e.active=t.active)}static generatePrestigeAutomationSave(e){let t=this.generateAutomationSave(e);return t.lastPrestigeChangeTurn=e.lastPrestigeChangeTurn,t.prevUnclaimedPrestige=B.save(e.prevUnclaimedPrestige),t}static loadPrestigeAutomationSave(e,t){t&&(this.loadAutomationSave(e,t),t.prevUnclaimedPrestige&&B.load(t.prevUnclaimedPrestige,e.prevUnclaimedPrestige),t.lastPrestigeChangeTurn&&(e.lastPrestigeChangeTurn=t.lastPrestigeChangeTurn))}};var vi=class extends bi{constructor(e,t,i,s,r,o){super(e,t,i,s,r),this.totals=o,this.initializeCosts()}getCostUnit(){return Tl.GOLD}getMoney(){return this.totals.gold}decrementMoney(e){this.totals.decrementGold(e)}};var Rn=class extends vi{constructor(e,t,i,s,r,o,a,h){super(e,t,i,s,r,o),this.damage=h,this.mineDamageLogic=a,this.displayedMultiplier=new d(-10),this.description=null}getDescription(){return(!this.description||!this.damage.goldDamageMultiplier.equals(this.displayedMultiplier))&&(this.displayedMultiplier.copy(this.damage.goldDamageMultiplier),this.description="x"+I.formatBigNum(this.damage.goldDamageMultiplier)),this.description}onUpgradePurchased(e,t){super.onUpgradePurchased(e,t);let i=this.damage.goldDamageMultiplier;i.equalsZero()&&i.setValue(1);let s=new d(n.gold.damageMultiplierPerUpgrade);for(let r=0;r<t;r++)i.multiply(s);this.mineDamageLogic.calculateTotalMineDamagePerTurn()}};var yn=class extends vi{constructor(e,t,i,s,r,o,a){super(e,t,i,s,r,o),this.oreBonusValue=a,this.displayedMultiplier=new d(-10),this.description=null}getDescription(){let e=this.oreBonusValue.getValue();return(!this.description||!e.equals(this.displayedMultiplier))&&(this.displayedMultiplier.copy(e),this.description="x"+I.formatBigNum(e)),this.description}onUpgradePurchased(e,t){super.onUpgradePurchased(e,t);let i=this.oreBonusValue.getValue();i.equalsZero()&&i.setValue(1);let s=new d(n.gold.oreBonusMultiplierPerUpgrade);for(let r=0;r<t;r++)i.mul(s)}};var Ln=class extends Ii{constructor(e,t,i,s){super(),this.initializeUpgrades(e,t,i,s)}initializeUpgrades(e,t,i,s){this.generateDamageBonusUpgrade("goldDamage",e,this.createCostCalculator(),i,s),this.generateOreBonusUpgrade("goldOre",e,this.createCostCalculator(),t),this.addBulkCompleted()}generateDamageBonusUpgrade(e,t,i,s,r){let o=n.gold.damageMultiplierPerUpgrade,a=new Rn(e,"Mine: x"+o,u.pick,i,100,t,s,r);this.addBulk(a)}generateOreBonusUpgrade(e,t,i,s){let r=n.gold.oreBonusMultiplierPerUpgrade,o=new yn(e,"Ore: x"+r,u.currency.ore,i,100,t,s.goldOreBonusMultiplier);this.addBulk(o)}createCostCalculator(){return new xi(new d(n.gold.upgradeBaseCost),1.3)}resetForPrestige(){}};var ls=class{constructor(){}static generateSave(e){let t={};t.upgrades=[];for(let i=0;i<e.upgrades.length;i++){let s=this.generateUpgradeSave(e.upgrades[i]);s&&t.upgrades.push(s)}return t.countToPurchase=e.countToPurchase,t}static loadSave(e,t){if(!t){console.log("GoldUpgradeCollectionSave.loadSave no save state");return}if(!t.upgrades){console.log("GoldUpgradeCollectionSave.loadSave state empty");return}for(let r=0;r<t.upgrades.length;r++)this.loadUpgradeSave(e,t.upgrades[r]);let s=t.countToPurchase;s&&e.setCountToPurchase(s)}static generateUpgradeSave(e){if(e.purchasedCount===0)return null;let t={};return t.id=e.id,t.c=e.purchasedCount,t}static loadUpgradeSave(e,t){if(!t)return;let i=t.id,s=e.findById(i);if(!s){console.log("GoldUpgradeCollectionSave.loadUpgradeSave() failed to find upgrade id="+i);return}let r=t.c;r!==void 0&&s.setPurchasedCountFromSave(r)}};var bn=class extends K{constructor(e,t,i,s,r){super(),this.worldGrid=e,this.projection=t,this.vectorField=i,this.partyTarget=s,this.crew=r,this.startTileOrigin=null,this.vectorFieldNumber=0;let o=this;this.minePremiumTileRegionCallback=function(a){let h=a.mineTiles;a.vectorFieldNumber=o.vectorField.vectorFieldNumber;let m=0;for(let p=0;p<h.length;p++){let f=h[p];!f||f.open||(f.isCurrency()?(o.vectorField.currencyMiningCandidates.push(f),m++):(o.vectorField.priorityMiningCandidates.push(f),m++),f.pathData.setMineScore(at.PREMIUM,o.vectorField.vectorFieldNumber))}},this.commonTileRegionCallback=function(a){let h=a.tiles;for(let m=0;m<h.length;m++){let p=h[m];if(!p||p.tileType.rarityModifier!==_.COMMON||!p.lighting.everVisibleToCharacter||p.open)continue;let f=o.calculateCommonTileMineScore(p);p.pathData.setMineScore(f,o.vectorFieldNumber),f>at.WORTHLESS&&o.vectorField.commonMiningCandidates.push(p)}}}generateVectorField(e,t,i,s,r){if(!e){console.log("VectorFieldGenerator - not generating: no tile");return}if(!e.getGrid().isLoaded()){console.log("VectorFieldGenerator - not generating: grid not loaded?");return}ne.startTime("FindTargets"),this.startTileOrigin=e.origin,this.vectorField.commonMiningCandidates.length=0,this.vectorField.currencyMiningCandidates.length=0,this.vectorField.priorityMiningCandidates.length=0,this.vectorField.ignoreCommonTiles=t,this.vectorField.ignorePremiumTiles=i,this.vectorField.destinationTileCandidates.fill(null),this.vectorField.vectorFieldNumber++,this.vectorField.centerTile=e,this.vectorFieldNumber=this.vectorField.vectorFieldNumber;let a=(s?12:25)*n.tile.size;be.allNearbyRegions(this.worldGrid,this.projection,this.startTileOrigin,a,this.minePremiumTileRegionCallback);let h=this.vectorField.currencyMiningCandidates.length+this.vectorField.priorityMiningCandidates.length;if(!t&&h<this.crew.miners.length){let m=(s?6:15)*n.tile.size;be.allNearbyRegions(this.worldGrid,this.projection,this.startTileOrigin,m,this.commonTileRegionCallback)}this.addDestinationTiles(e,r,s),ne.endTime("FindTargets")}addDestinationTiles(e,t,i){e&&(t===1?this.addDownDestinationTiles(e,i):t===2?this.addUpDestinationTiles(e,i):t===3&&this.addRightDestinationTiles(e,i))}addDownDestinationTiles(e,t){let i=this.vectorField.destinationTileCandidates,s=n.tile.size*(t?15:25),r=0,o=this.worldGrid.findGridTileXY(e.origin.x,e.origin.y+s);for(;!o&&s>0;)s-=n.tile.size*n.grid.numTileColsInRegion,o=this.worldGrid.findGridTileXY(e.origin.x,e.origin.y+s);o&&(i.length<=r?i.push(o):i[r]=o,r++);for(let a=0;a<15;a++){let h=(a+1)*n.tile.size,m=this.worldGrid.findGridTileXY(e.origin.x-h,e.origin.y+s);m&&(i.length<=r?i.push(m):i[r]=m,r++)}for(let a=0;a<15;a++){let h=(a+1)*n.tile.size,m=this.worldGrid.findGridTileXY(e.origin.x+h,e.origin.y+s);m&&(i.length<=r?i.push(m):i[r]=m,r++)}}addUpDestinationTiles(e,t){let i=this.vectorField.destinationTileCandidates,s=n.tile.size*(t?15:25),r=0,o=this.worldGrid.findGridTileXY(e.origin.x,e.origin.y-s);for(;!o&&s>0;)s-=n.tile.size*n.grid.numTileColsInRegion,o=this.worldGrid.findGridTileXY(e.origin.x,e.origin.y-s);o&&(i.length<=r?i.push(o):i[r]=o,r++);for(let a=0;a<15;a++){let h=(a+1)*n.tile.size,m=this.worldGrid.findGridTileXY(e.origin.x-h,e.origin.y-s);m&&(i.length<=r?i.push(m):i[r]=m,r++)}for(let a=0;a<15;a++){let h=(a+1)*n.tile.size,m=this.worldGrid.findGridTileXY(e.origin.x+h,e.origin.y-s);m&&(i.length<=r?i.push(m):i[r]=m,r++)}}addRightDestinationTiles(e,t){let i=this.vectorField.destinationTileCandidates,s=n.tile.size*25,r=0,o=this.worldGrid.findGridTileXY(e.origin.x+s,e.origin.y);for(;!o&&s>0;)s-=n.tile.size*n.grid.numTileColsInRegion,o=this.worldGrid.findGridTileXY(e.origin.x+s,e.origin.y);o&&(i.length<=r?i.push(o):i[r]=o,r++);for(let a=0;a<15;a++){let h=(a+1)*n.tile.size,m=this.worldGrid.findGridTileXY(e.origin.x+s,e.origin.y-h);m&&(i.length<=r?i.push(m):i[r]=m,r++)}for(let a=0;a<15;a++){let h=(a+1)*n.tile.size,m=this.worldGrid.findGridTileXY(e.origin.x+s,e.origin.y+h);m&&(i.length<=r?i.push(m):i[r]=m,r++)}}addCenterDestinationTiles(e){let t=this.vectorField.destinationTileCandidates;t.push(e);let i=e.neighbors;for(let h=0;h<i.length;h++){let m=i[h];m&&t.push(m)}let s=e.getNeighborTopLeft(),r=e.getNeighborTopRight(),o=e.getNeighborBottomLeft(),a=e.getNeighborBottomRight();s&&t.push(s),r&&t.push(r),o&&t.push(o),a&&t.push(a)}calculateCommonTileMineScore(e){return e.borderCode===qe.ALL_BORDERS_OPEN?at.WORTHLESS:this.calculateNeighborTileScore(e)}calculateNeighborTileScore(e){let t=!1,i=!1,s=e.neighbors;for(let o=0;o<s.length;o++){let a=s[o];a&&(a.lighting.everVisibleToCharacter||!a.tileType.lightingSupported||(a.open?i=!0:t=!0))}let r=0;return t&&(r+=at.COMMON_HIDDEN_NEIGHBOR),i&&(r+=at.COMMON_REVEAL_CAVERN),r}resetFull(){}resetForPrestige(){}};var si=class{constructor(e,t,i){this.id=e,this.name=t,this.iconFileName=i}};var Ue={MINE_DEEPER:new si("1","Deeper",u.pick),MINE_SHALLOWER:new si("2","Shallower",u.pick),MINE_CURRENT:new si("3","Current Depth",u.pick),MINE_AUTO:new si("4","Automated",u.pick)};var Pe={LOCKED_NO_MOVE:-3,MOVE_UP_LARGE:-2,MOVE_UP_SMALL:-1,CURRENT:0,MOVE_DOWN_SMALL:1,MOVE_DOWN_LARGE:2},In=class extends K{constructor(e,t,i,s,r,o){super(),this.crew=e,this.partyTarget=t,this.damage=i,this.worldGrid=s,this.vectorFieldGenerator=r,this.vectorField=o,this.crewModes=[Ue.MINE_DEEPER,Ue.MINE_SHALLOWER,Ue.MINE_CURRENT,Ue.MINE_AUTO],this.mineTileStep=40,this.prevTotalPickDamagePerTurn=new d(0),this.prevMode=null,this.workingHealth=new d(0),this.tileHealthPerDamageThreshold=new d(.05),this.debugTileHealthNegligible=!1,this.debugSearchGridSmall=!1,this.debugIgnorePremium=!1,this.debugIgnoreCommon=!1,this.debugGoalDescription="",this.activeMode=Ue.MINE_AUTO}setModeActive(e){this.activeMode=e}setActiveModeById(e){let t=this.findModeById(e);if(!t){console.log("MineControl.setActiveModeById() Failed to find mode id: "+e);return}this.setModeActive(t)}findModeById(e){for(let t=0;t<this.crewModes.length;t++){let i=this.crewModes[t];if(i.id===e)return i}return null}updateForTurn(){let e=this.crew.calculateCrewCenterTile();if(!e){console.log("MineControl.updateForTurn() no crew center tile");return}if(this.activeMode===Ue.MINE_AUTO){let t=this.partyTarget.targetMineSeconds!==this.partyTarget.defaultMineSeconds,i=!this.prevTotalPickDamagePerTurn.equals(this.damage.totalPickDamagePerTurn);(t||i)&&(this.partyTarget.targetMineSeconds=this.partyTarget.defaultMineSeconds,this.prevTotalPickDamagePerTurn.copy(this.damage.totalPickDamagePerTurn),this.partyTarget.calculateTargetRow())}else this.checkForTargetAdjust(e,this.prevMode!==this.activeMode);this.prevMode=this.activeMode,this.vectorField.tileHealthNegligible=this.isTileHealthNegligible(e),this.debugTileHealthNegligible=this.vectorField.tileHealthNegligible,this.applyMiningLogic(e)}isTileHealthNegligible(e){return e.tileType.layerDescription.calculateTileHealth(e.getTileRow(),this.workingHealth),this.workingHealth.div(this.damage.totalPickDamagePerTurn),this.workingHealth.lessThan(this.tileHealthPerDamageThreshold)}checkForTargetAdjust(e,t){let i=e.getTileRow();if(t){this.activeMode===Ue.MINE_CURRENT?this.applyMineCurrentTargetAdjust(i):this.activeMode===Ue.MINE_SHALLOWER?this.applyMineShallowerTargetAdjust(i):this.activeMode===Ue.MINE_DEEPER&&this.applyMineDeeperTargetAdjust(i);return}let s=this.partyTarget.targetRow,r=s-15,o=s+15;i<r?this.activeMode===Ue.MINE_SHALLOWER&&this.applyMineShallowerTargetAdjust(i):i>o?this.activeMode===Ue.MINE_DEEPER&&this.applyMineDeeperTargetAdjust(i):this.activeMode===Ue.MINE_DEEPER?this.applyMineDeeperTargetAdjust(i):this.activeMode===Ue.MINE_SHALLOWER&&this.applyMineShallowerTargetAdjust(i)}applyMineCurrentTargetAdjust(e){this.partyTarget.deriveTargetSecondsForRow(e),this.partyTarget.calculateTargetRow()}applyMineShallowerTargetAdjust(e){let t=Math.max(n.target.minTargetRow,e-this.mineTileStep);this.partyTarget.deriveTargetSecondsForRow(t),this.partyTarget.calculateTargetRow()}applyMineDeeperTargetAdjust(e){this.partyTarget.deriveTargetSecondsForRow(e+this.mineTileStep),this.partyTarget.calculateTargetRow()}applyMiningLogic(e){let i=(this.vectorField.centerTile?this.vectorField.centerTile:e).getTileRow(),s=e.getTileRow(),r=this.partyTarget.targetRow,o=this.vectorField.isPriorityTileVisible(),a=0;if(this.activeMode===Ue.MINE_CURRENT)s<-5?a=Pe.MOVE_DOWN_LARGE:a=Pe.CURRENT;else if(this.activeMode===Ue.MINE_SHALLOWER)a=i>n.target.minTargetRow?Pe.MOVE_UP_LARGE:Pe.CURRENT;else if(this.activeMode===Ue.MINE_DEEPER)a=Pe.MOVE_DOWN_LARGE;else{let A=Math.max(n.target.minTargetRow,r-15),N=Math.max(n.target.minTargetRow,r-25),P=r+15,M=r+25;i<N?a=Pe.MOVE_DOWN_LARGE:i<A?a=Pe.MOVE_DOWN_SMALL:i>M?a=Pe.MOVE_UP_LARGE:i>P?a=Pe.MOVE_UP_SMALL:a=Pe.CURRENT}o&&a!==Pe.MOVE_DOWN_LARGE&&a!==Pe.MOVE_UP_LARGE&&(a=Pe.LOCKED_NO_MOVE);let h=!0,m=!0,p=!1,f=!1,S=!1,E=this.vectorField.tileHealthNegligible,w=!1;a===Pe.LOCKED_NO_MOVE?this.debugGoalDescription="mine priority tiles":a===Pe.MOVE_DOWN_LARGE?(h=!1,m=i<s+6,p=!0,S=this.vectorField.tileHealthNegligible,E=!0,w=!0,this.debugGoalDescription="mine downwards"):a===Pe.MOVE_DOWN_SMALL?(h=!1,m=i<s+10,this.debugGoalDescription="mine down a little"):a===Pe.MOVE_UP_LARGE?(m=!1,p=!0,h=i>s-6,S=this.vectorField.tileHealthNegligible,E=!0,w=!0,this.debugGoalDescription="mine upwards"):a===Pe.MOVE_UP_SMALL?(m=!1,h=i>s-10,this.debugGoalDescription="mine up a little"):(m=i<r,h=i>r,f=this.vectorField.tileHealthNegligible,this.debugGoalDescription="mine around target depth"),this.crew.values.fallSpeedBonusActive.setValue(S&&a===Pe.MOVE_DOWN_LARGE);let C=this.calculateVectorFieldCenterTile(e,this.vectorField.centerTile,a,h,m,p,f);this.debugSearchGridSmall=w,this.debugIgnorePremium=S,this.debugIgnoreCommon=E;let T=0;switch(a){case Pe.CURRENT:T=3;break;case Pe.LOCKED_NO_MOVE:T=0;break;case Pe.MOVE_DOWN_LARGE:case Pe.MOVE_DOWN_SMALL:T=1;break;case Pe.MOVE_UP_LARGE:case Pe.MOVE_UP_SMALL:T=2;break}this.vectorFieldGenerator.generateVectorField(C,E,S,w,T)}calculateVectorFieldCenterTile(e,t,i,s,r,o,a){if(!t)return console.log("MineControl.calculateVectorFieldCenterTile() - no vector field center tile"),e;if(i===Pe.LOCKED_NO_MOVE)return t;let h=a?4*n.tile.size:n.tile.size,m=e.origin.x-t.origin.x,p=m==0?e.origin.x:m<0?t.origin.x-n.tile.size:t.origin.x+h,f=t.origin.y;if(i===Pe.MOVE_UP_LARGE||i===Pe.MOVE_UP_SMALL){if(s){let E=o?4*n.tile.size:n.tile.size;f=t.origin.y-E}}else if(i===Pe.MOVE_DOWN_LARGE||i===Pe.MOVE_DOWN_SMALL){if(r){let E=e.origin.y-t.origin.y,w=o?this.calculateBigYStep(E):n.tile.size;f=t.origin.y+w}}else{let E=e.origin.y-t.origin.y,w=o?this.calculateBigYStep(E):n.tile.size;E<0&&s?f=t.origin.y-w:E>0&&r&&(f=t.origin.y+w)}let S=this.worldGrid.findGridTileXY(p,f);return S||t}calculateBigYStep(e){return e<=0?4*n.tile.size:e>4*n.tile.size?e:4*n.tile.size}resetFull(){this.setModeActive(Ue.MINE_AUTO)}resetForPrestige(){}};var ds=class{constructor(){}static generateSave(e){let t={};return t.activeId=e.activeMode.id,t}static loadSave(e,t){if(!t)return;let i=t.activeId;i?e.setActiveModeById(i):(console.log("MineControlSave.loadSave() Failed to load mine mode."),e.setModeActive(Ue.MINE_AUTO))}};var hs=class{constructor(){}static generateSave(e){let t={};return t.crewBrainDebugEnabled=e.crewBrainDebugEnabled,t.maxFps=e.maxFps,t.displayFps=e.displayFps,t}static loadSave(e,t){t&&(e.crewBrainDebugEnabled=!1,t.crewBrainDebugEnabled&&(e.crewBrainDebugEnabled=!0),t.maxFps&&(e.maxFps=t.maxFps),e.displayFps=!1,t.displayFps&&(e.displayFps=!0))}};var xn=class{constructor(e){this.gridSaveManager=e,this.modelsSaveKey="modelsSaveV1"}loadSave(e){return this.loadModels(e)}saveGame(e){this.saveAllLoadedGrids(e),this.saveModels(e)}deleteSave(){localStorage.removeItem(this.modelsSaveKey),this.gridSaveManager.deleteAllGrids()}saveModels(e){let t=this.generateModelState(e);if(!t){console.log("SaveManager.saveModels() Failed to generate models save state");return}let i=JSON.stringify(t);if(!i){console.log("SaveManager.saveModels() Failed to stringify models state");return}let s=ri.compressToUTF16(i);if(!s){console.log("SaveManager.saveModels() Failed to compress state for models");return}localStorage.setItem(this.modelsSaveKey,s)}loadModels(e){let t=localStorage.getItem(this.modelsSaveKey);if(!t)return console.log("SaveManager.loadModels() No save found."),!1;let i=ri.decompressFromUTF16(t);if(!i)return console.log("SaveManager.loadModels() Failed to decompress save."),!1;let s=JSON.parse(i);return s?this.loadModelState(e,s):(console.log("SaveManager.loadModels() Failed to parse save as JSON."),!1)}generateModelState(e){let t={};return t.state=Xi.generateSave(e),t.gridSaveManager=es.generateSave(e.gridSaveManager),t.time=Zi.generateSave(e.gameTime),t.projection=Ki.generateSave(e.projection),t.partyTarget=$i.generateSave(e.partyTarget),t.gameOptions=hs.generateSave(e.gameOptions),t.crew=Qi.generateSave(e.crew),t.totals=ji.generateSave(e.totals),t.damage=os.generateSave(e.damage),t.values=qi.generateSave(e.values),t.runStats=ii.generateSave(e.runStatistics),t.globalStats=ii.generateSave(e.globalStatistics),t.minedUpgradeCollection=Ji.generateSave(e.minedUpgradeCollection),t.pickUpgradeCollection=is.generateSave(e.pickUpgradeCollection),t.goldUpgradeCollection=ls.generateSave(e.goldUpgradeCollection),t.bonusCollection=ns.generateSave(e.bonusCollection),t.automation=as.generateSave(e.automationManager),t.mineControl=ds.generateSave(e.mineControl),t.skillTree=rs.generateSave(e.skillTreeGraph),t}loadModelState(e,t){if(!t)return!1;let i=!0;try{Xi.loadSave(e,t.state)}catch(s){console.error("SaveManager.loadModelState() Failed to load State:",s.message),i=!1}try{es.loadSave(e.gridSaveManager,t.gridSaveManager)}catch(s){console.error("SaveManager.loadModelState() Failed to load GridSaveManager:",s.message),i=!1}try{Zi.loadSave(e.gameTime,t.time)}catch(s){console.error("SaveManager.loadModelState() Failed to load GameTime:",s.message),i=!1}try{Ki.loadSave(e.projection,t.projection)}catch(s){console.error("SaveManager.loadModelState() Failed to load Projection:",s.message),i=!1}try{Qi.loadSave(e.crew,t.crew)}catch(s){console.error("SaveManager.loadModelState() Failed to load Crew:",s.message),i=!1}try{ji.loadSave(e.totals,t.totals)}catch(s){console.error("SaveManager.loadModelState() Failed to load Totals:",s.message),i=!1}try{os.loadSave(e.damage,t.damage)}catch(s){console.error("SaveManager.loadModelState() Failed to load Damage:",s.message),i=!1}try{qi.loadSave(e.values,t.values)}catch(s){console.error("SaveManager.loadModelState() Failed to load Values:",s.message),i=!1}try{ii.loadSave(e.runStatistics,t.runStats)}catch(s){console.error("SaveManager.loadModelState() Failed to load Statistics (run):",s.message),i=!1}try{ii.loadSave(e.globalStatistics,t.globalStats)}catch(s){console.error("SaveManager.loadModelState() Failed to load Statistics (global):",s.message),i=!1}try{$i.loadSave(e.partyTarget,t.partyTarget)}catch(s){console.error("SaveManager.loadModelState() Failed to load PartyTarget:",s.message),i=!1}try{hs.loadSave(e.gameOptions,t.gameOptions)}catch(s){console.error("SaveManager.loadModelState() Failed to load PartyTarget:",s.message),i=!1}try{Ji.loadSave(e.minedUpgradeCollection,e.upgradeCreators,t.minedUpgradeCollection)}catch(s){console.error("SaveManager.loadModelState() Failed to load MinedUpgradeCollection:",s.message),i=!1}try{is.loadSave(e.pickUpgradeCollection,t.pickUpgradeCollection)}catch(s){console.error("SaveManager.loadModelState() Failed to load PickUpgradeCollection:",s.message),i=!1}try{ls.loadSave(e.goldUpgradeCollection,t.goldUpgradeCollection)}catch(s){console.error("SaveManager.loadModelState() Failed to load GoldUpgradeCollection:",s.message),i=!1}try{ns.loadSave(e.bonusCollection,t.bonusCollection)}catch(s){console.error("SaveManager.loadModelState() Failed to load BonusCollection:",s.message),i=!1}try{as.loadSave(e.automationManager,t.automation)}catch(s){console.error("SaveManager.loadModelState() Failed to load AutomationSave:",s.message),i=!1}try{ds.loadSave(e.mineControl,t.mineControl)}catch(s){console.error("SaveManager.loadModelState() Failed to load MineControlSave:",s.message),i=!1}try{rs.loadSave(e.skillTreeGraph,t.skillTree)}catch(s){console.error("SaveManager.loadModelState() Failed to load SkillTreeSave:",s.message),i=!1}return i}saveAllLoadedGrids(e){let t=e.worldGrid.grids;for(let i=0;i<t.length;i++){let s=t[i];s&&s.isLoaded()&&this.gridSaveManager.saveGridState(s)}}getSaveStateForExport(e){let t=this.generateModelState(e);if(!t)return console.log("SaveManager.getSaveState() Failed to generate models save state"),null;let i=this.gridSaveManager.generateGridStateForExport(e.worldGrid);i||console.log("SaveManager.getSaveState() Failed to generate grid state");let r=JSON.stringify({model:t,grid:i});if(!r)return console.log("SaveManager.getSaveState() Failed to stringify state"),null;let o=ri.compressToBase64(r);return o||(console.log("SaveManager.getSaveState() Failed to compress state"),null)}importSave(e,t){if(!t)return console.log("SaveManager.importSave() No save found."),!1;let i=ri.decompressFromBase64(t);if(!i)return console.log("SaveManager.importSave() Failed to decompress save."),!1;let s=JSON.parse(i);if(!s)return console.log("SaveManager.importSave() Failed to parse save as JSON."),!1;let r=s.model,o=s.grid,a=this.loadModelState(e,r);if(console.log("SaveManager.importSave() load model state:"+a),!a)return!1;this.gridSaveManager.deleteAllGrids();let h=this.gridSaveManager.importGridState(e.worldGrid,o);if(console.log("SaveManager.importSave() import grid state:"+h),h){console.log("SaveManager.importSave() saving newly imported state.");let m=e.worldGrid.grids;for(let p=0;p<m.length;p++){let f=m[p];f&&(console.log("SaveManager.importSave() SAVING GRID STATE."),this.gridSaveManager.saveGridState(f))}this.saveModels(e)}else console.log("SaveManager.importSave() FAIL modelStateLoaded="+a+" worldGridStateLoaded="+h);return h}};var On=class{constructor(){}playSound(e){}};var vn=class extends K{constructor(e,t){super(),this.projection=e,this.crew=t,this.animating=!1,this.workingCenter=new v(0,0),this.deltaThreshold=1.5,this.targetAnimationMillis=200}startAnimation(){if(this.animating)return;if(this.crew.calculateCrewCenterCoordinate(this.workingCenter),q.dist(this.workingCenter,this.projection.gridCenter)>n.grid.gridPixelWidth*2){this.projection.setGridCenter(this.workingCenter.x,this.workingCenter.y),this.projection.stayCenteredOnCharacter=!0;return}let t=this.workingCenter.x-this.projection.gridCenter.x,i=this.workingCenter.y-this.projection.gridCenter.y;if(t===0&&i===0){this.animating=!1,this.projection.stayCenteredOnCharacter=!0;return}this.animating=!0}updateForFrame(e){if(!this.animating)return!1;this.crew.calculateCrewCenterCoordinate(this.workingCenter);let t=this.workingCenter.x-this.projection.gridCenter.x,i=this.workingCenter.y-this.projection.gridCenter.y;if(t===0&&i===0)return this.animating=!1,!0;let s=Math.abs(t),r=Math.abs(i),o=t/this.targetAnimationMillis*n.time.defaultMillisPerFrame,a=i/this.targetAnimationMillis*n.time.defaultMillisPerFrame,h=o*e,m=a*e,p,f,S,E;return s<this.deltaThreshold||s<h?(p=this.workingCenter.x,S=!0):(p=this.projection.gridCenter.x+h,S=!1),r<this.deltaThreshold||r<m?(f=this.workingCenter.y,E=!0):(f=this.projection.gridCenter.y+m,E=!1),this.projection.setGridCenter(p,f),S&&E?(this.projection.stayCenteredOnCharacter=!0,this.animating=!1,!0):!1}resetFull(){this.animating=!1}resetForPrestige(){this.resetFull()}};var Dn=class extends ci{constructor(e){super(),this.tileMinedLogic=e}performAction(e,t,i){let s=e.position.tile;if(!s){e.resetTurnState();return}let r=e.target.mineTile;if(!r){e.resetTurnState();return}if(r.open){e.resetTurnState();return}if(!s.isNeighborTile(r)){e.resetTurnState();return}e.setCharacterAction($.MINE),e.position.worldCoordinateOrigin.x!==r.origin.x&&(e.position.facingLeft=e.position.worldCoordinateOrigin.x>r.origin.x),i&&this.tileMinedLogic.mineTileForTurn(e,r)&&e.resetTurnState()}toString(){return"MineTurnAction"}};var Bn=class extends Ai{constructor(e,t){super(),this.statisticsIncrementor=e,this.mineDamageLogic=t}performAction(e,t,i){super.performAction(e,t,i);let s=e.position.tile;if(!s)return;let r=this.statisticsIncrementor.globalStatitics.maxDepth,o=s.getTileRow();this.statisticsIncrementor.tileDepth(o),r<o&&this.mineDamageLogic.calculateTotalMineDamagePerTurn()}};var kn=class{constructor(e,t,i,s,r,o,a){this.crew=e,this.vectorField=t,this.partyTarget=i,this.pathPlanFinder=s,this.mineTurnAction=new Dn(r),this.moveTurnAction=new Bn(a,o),this.unassignedMiners=[],this.unassignedMinerCount=0,this.claimedTiles=[],this.bestTiles=[],this.workingPosition=new v(0,0),this.nearDistance2=5*n.tile.size*(5*n.tile.size)}updateForTurn(){this.vectorField.ignoreCommonTiles&&this.vectorField.ignorePremiumTiles?this.assignTurnsForDestinationTiles():this.vectorField.isVectorFieldMineTargetsEmpty()?this.assignTurnsForDestinationTiles():this.assignTurnsForVectorField(),this.setTurnActions()}assignTurnsForDestinationTiles(){let e=this.crew.miners,t=this.vectorField.destinationTileCandidates;for(let i=0;i<e.length;i++){let s=e[i],r=this.findClosestTile(s.position.worldCoordinateOrigin,t);if(r){if(this.evaluateMinerDestination(s,r))continue;this.assignMinerTarget(s,r,null);continue}s.resetTurnState()}}assignTurnsForVectorField(){let e=this.crew.miners,t=this.vectorField.priorityMiningCandidates,i=this.vectorField.currencyMiningCandidates,s=this.vectorField.commonMiningCandidates;this.claimedTiles.length=0,this.unassignedMiners.fill(null),this.unassignedMinerCount=0;for(let r=0;r<e.length;r++)this.evaluateMinerTarget(e[r]);for(let r=0;r<this.unassignedMiners.length;r++){let o=this.unassignedMiners[r];o&&(t.length>0&&this.assignMinerToClosestAvailableTile(o,r,t)||i.length>0&&this.assignMinerToClosestAvailableTile(o,r,i)||s.length>0&&this.assignMinerToClosestAvailableTile(o,r,s))}if(this.unassignedMinerCount>0)for(let r=this.unassignedMiners.length-1;r>=0;r--){let o=this.unassignedMiners[r];o&&this.assignMinerToHelpOthers(o,r)}if(this.unassignedMinerCount>0)for(let r=0;r<this.unassignedMiners.length;r++){let o=this.unassignedMiners[r];o&&(o.resetTurnState(),o.setCharacterAction($.STAND))}}assignMinerToHelpOthers(e,t){let i=this.findClosestTargetedMineTile(e.position.tile.origin);if(!i)return;let s=this.findBestNeighborTile(i,e.position.tile);if(!s){console.log("CrewBrain.assignMinerToHelpOthers() failed to find miner for tile.");return}this.unassignedMiners[t]=null,this.unassignedMinerCount--,this.assignMinerTarget(e,s,i)}assignMinerToClosestAvailableTile(e,t,i){let s=this.findClosestUnclaimedTile(e.position.worldCoordinateOrigin,i);return!s||!this.claimTargetForMiner(e,s)?!1:(this.unassignedMiners[t]=null,this.unassignedMinerCount--,!0)}claimTargetForMiner(e,t){let i=this.findBestNeighborTile(t,e.position.tile);return i?(this.assignMinerTarget(e,i,t),this.claimedTiles.push(t),!0):(console.log("CrewBrain.assignTargetForMiner() failed to find miner for tile."),!1)}evaluateMinerTarget(e){if(!e.position.tile)return;let t=e.target.mineTile;if(t&&this.isCurrentMineTargetValid(t)){this.claimedTiles.push(e.target.mineTile);return}this.unassignedMiners[this.unassignedMinerCount]=e,this.unassignedMinerCount++}evaluateMinerDestination(e,t){if(!e.position.tile)return!0;let i=e.target.targetTile;return!!(i&&e.position.pathPlan.length>0&&i.origin.distanceSquared(t.origin)<=this.nearDistance2)}isCurrentMineTargetValid(e){if(!e||e.open)return!1;let t=this.vectorField.priorityMiningCandidates,i=this.vectorField.currencyMiningCandidates;if(e.isCommon()&&(t.length>0||i.length>0)||e.pathData.getMineScore(this.vectorField.vectorFieldNumber)<=at.WORTHLESS)return!1;if(e.isPriority()&&t.length>0&&t.indexOf(e)!==-1||e.isCurrency()&&i.length>0&&i.indexOf(e)!==-1)return!0;let s=this.vectorField.commonMiningCandidates;return!!(e.isCommon()&&s.length>0&&s.indexOf(e)!==-1)}findClosestTargetedMineTile(e){let t=this.crew.miners,i=null,s=1e6;for(let r=0;r<t.length;r++){let o=t[r].target.mineTile;if(!o)continue;let a=e.distanceSquared(o.origin);(!i||s>a)&&(i=o,s=a)}return i}findClosestUnclaimedTile(e,t){let i=null,s=1e6;for(let r=0;r<t.length;r++){let o=t[r],a=e.distanceSquared(o.origin);if(!i||s>a){if(this.claimedTiles.indexOf(o)!==-1)continue;i=o,s=a}}return i}findClosestTile(e,t){let i=null,s=1e6;for(let r=0;r<t.length;r++){let o=t[r];if(!o)continue;let a=e.distanceSquared(o.origin);(!i||s>a)&&(i=o,s=a)}return i}findClosestOpenTile(e,t){let i=null,s=1e6;for(let r=0;r<t.length;r++){let o=t[r];if(!o||!o.open)continue;let a=e.distanceSquared(o.origin);(!i||s>a)&&(i=o,s=a)}return i}setTurnActions(){let e=this.crew.miners;for(let t=0;t<e.length;t++)this.setMinerTurnAction(e[t])}setMinerTurnAction(e){let t=e.target.mineTile;e.position.pathPlan.length>0?e.turnAction=this.moveTurnAction:t&&!t.open&&e.position.tile.isNeighborTile(t)?e.turnAction=this.mineTurnAction:e.resetTurnState()}findBestNeighborTile(e,t){if(e.isNeighborTile(t))return t;let i=e.getNeighbors(),s=this.findClosestOpenTile(t.origin,i);if(s&&s.open)return s;for(let a=0;a<i.length;a++){let h=i[a];if(!(!h||!h.open)&&h.isNeighborTile(t))return h}let r=null,o=1e6;for(let a=0;a<i.length;a++){let h=i[a];if(!h)continue;let m=h.origin.distanceSquared(t.origin);(!r||o>m)&&(r=h,o=m)}return r}assignMinerTarget(e,t,i){if(e.target.setTargetTile(t,i,"crewBrain"),t!==e.position.tile){let s=!0;e.position.isCenteredOnTile()||(e.position.isNearTileOrigin()?(e.position.setPositionToTileOrigin(),e.resetTurnState()):s=!1),this.pathPlanFinder.findPartyCharacterPathPlan(e.position.tile,t,e.position.pathPlan,s)}}};var Fn=class extends Ei{constructor(){super()}resetForPrestige(){}};var Gn=class{constructor(e,t){this.totals=e,this.values=t,this.tempFormatValue=new d(0),this.workingOre=new d(0),this.workingPrestige=new d(0),this.workingGold=new d(0),this.workingRuby=new d(0)}calculateOfflineEarnings(){let e=this.totals.offlineSeconds;if(e<=0)return;console.log("OfflineLogic.calculateOfflineEarnings() offlineSeconds="+nt.formatElapsedTime(e*1e3));let t=e*n.time.turnsPerSecond,i=n.offline.defaultOfflineTurns+this.values.offlineTimeUpgrades.getValue()*n.offline.turnsPerUpgrade,s=Math.min(i,t);if(s<=0){this.totals.offlineSeconds=0,this.totals.countedOfflineSeconds=0;return}this.calculateOfflineCurrency(s,this.totals.prestigePerTurn,this.workingPrestige),this.workingPrestige.greaterThanZero()&&this.totals.incrementOfflinePrestige(this.workingPrestige),this.calculateOfflineCurrency(s,this.totals.goldPerTurn,this.workingGold),this.workingGold.greaterThanZero()&&this.totals.incrementOfflineGold(this.workingGold),this.calculateOfflineCurrency(s,this.totals.rubyPerTurn,this.workingRuby),this.workingRuby.greaterThanZero()&&this.totals.incrementOfflineRuby(this.workingRuby),this.calculateOfflineCurrency(s,this.totals.orePerTurn,this.workingOre),this.workingOre.greaterThanZero()&&this.totals.incrementOfflineOre(this.workingOre),this.totals.countedOfflineSeconds=s*n.time.secondsPerTurn|0,this.totals.offlineSeconds=0}calculateOfflineCurrency(e,t,i){if(t.equalsZero()){i.setZero();return}i.copy(t),i.mulNumber(e),i.floor()}};var Vn=class{constructor(){this.crewBrainDebugEnabled=!1,this.maxFps=120,this.displayFps=!1}};var Un=class extends K{constructor(e){super(),this.gameModels=[],this.sprites=new Ds,this.worldGrid=new Bs,this.gameModels.push(this.worldGrid),this.projection=new zs,this.gameModels.push(this.projection),this.gameTime=new Js,this.gameModels.push(this.gameTime),this.globalStatistics=new Fn,this.gameModels.push(this.globalStatistics),this.runStatistics=new Ei,this.gameModels.push(this.runStatistics),this.gameOptions=new Vn,this.statisticsIncrementor=new Tr(this.globalStatistics,this.runStatistics),this.values=new $s,this.gameModels.push(this.values),this.crew=new er(this.worldGrid,this.gameTime,this.sprites.characterSpritesheet,this.sprites.itemOverlaySpritesheet,this.values),this.gameModels.push(this.crew),this.gridLoadingManager=new Mo(this.worldGrid,this.projection),this.gameModels.push(this.gridLoadingManager),this.gameVisible=!0,this.gamePaused=!1,this.worldSeed=1,this.currentFps=0,this.vectorField=new yr,this.gameModels.push(this.vectorField),this.totals=new ir(this.gameTime),this.gameModels.push(this.totals),this.damage=new tr,this.gameModels.push(this.damage),this.effectManager=new mr(this.projection),this.gameModels.push(this.effectManager),this.lightSourceCreators=new ar,this.gameModels.push(this.lightSourceCreators),this.effectCreators=new cr(this.lightSourceCreators,this.sprites.spellFxSpritesheet),this.gameModels.push(this.effectCreators),this.lightingCalculator=new xo(this.worldGrid,this.projection),this.gameModels.push(this.lightingCalculator),this.physicsManager=new vo(this.worldGrid,this.projection,this.gameTime),this.soundEffectManager=new On,this.infoTextProcessor=new fr(this.projection),this.gameModels.push(this.infoTextProcessor),this.partyTarget=new Do(this.totals,this.damage),this.gameModels.push(this.partyTarget),this.mineDamageLogic=new Er(this.values,this.totals,this.damage,this.globalStatistics),this.offlineLogic=new Gn(this.totals,this.values),this.minedUpgradeCollection=new Mr,this.gameModels.push(this.minedUpgradeCollection),this.pickUpgradeCollection=new ko(this.totals,this.values,this.mineDamageLogic),this.gameModels.push(this.pickUpgradeCollection),this.goldUpgradeCollection=new Ln(this.totals,this.values,this.mineDamageLogic,this.damage),this.gameModels.push(this.goldUpgradeCollection),this.bonusCollection=new Sn(this.gameTime,this.totals,this.values),this.gameModels.push(this.bonusCollection),this.vectorFieldGenerator=new bn(this.worldGrid,this.projection,this.vectorField,this.partyTarget,this.crew),this.gameModels.push(this.vectorFieldGenerator),this.oreCalculationLogic=new Cr(this.values),this.upgradeCreators=new _r(this.values,this.totals,this.oreCalculationLogic,this.mineDamageLogic,this.minedUpgradeCollection,this.statisticsIncrementor),this.tileMinedLogic=new Rr(this.crew,this.totals,this.damage,this.values,this.statisticsIncrementor,this.minedUpgradeCollection,this.upgradeCreators,this.infoTextProcessor,this.effectCreators,this.effectManager,this.oreCalculationLogic,this.mineDamageLogic),this.skillTreeGraph=new fn(this.gameTime,this.worldGrid,this.totals,this.values,this.tileMinedLogic,this.mineDamageLogic,this.crew,this.vectorField,this.sprites.spellFxSpritesheet),this.gameModels.push(this.skillTreeGraph),this.automationManager=new _n(this.minedUpgradeCollection,this.pickUpgradeCollection,e,this.values,this.totals,this.gameTime),this.gameModels.push(this.automationManager),this.pathPlanFinder=new lo(this.vectorField,this.tileMinedLogic),this.gameModels.push(this.pathPlanFinder),this.crewBrain=new kn(this.crew,this.vectorField,this.partyTarget,this.pathPlanFinder,this.tileMinedLogic,this.mineDamageLogic,this.statisticsIncrementor),this.mineControl=new In(this.crew,this.partyTarget,this.damage,this.worldGrid,this.vectorFieldGenerator,this.vectorField),this.gameModels.push(this.mineControl),this.characterBrains=new uo(this.pathPlanFinder),this.characterCreator=new co(this.sprites.monsterSpritesheet,this.characterBrains),this.gameModels.push(this.characterCreator),this.gridSave=new No(this.characterCreator),this.gridSaveManager=new Po(this.gridSave),this.gameModels.push(this.gridSaveManager),this.saveManager=new xn(this.gridSaveManager),this.panAnimation=new vn(this.projection,this.crew),this.gameModels.push(this.panAnimation)}initializeState(e){let t=new So(this.worldSeed,this.characterCreator),i=new Ao(this.gridSaveManager,t,this.worldGrid,this.crew,this.vectorField);if(this.gridLoadingManager.initializeLoadingManager(i,this.crew),this.crew.main){let s=this.worldGrid.findGridTile(this.crew.main.position.worldCoordinateOrigin);s&&this.crew.main.position.setTileAndOriginPosition(s,s.origin.x,s.origin.y)}else{let s=this.crew.createMainMiner(),r=null;e?r=this.worldGrid.findGridTile(s.position.worldCoordinateOrigin):r=this.worldGrid.findGridTileXY(n.start.startX,n.start.startY),r?s.position.setTileAndOriginPosition(r,r.origin.x,r.origin.y):e||s.position.setWorldCoordinateOriginXY(n.start.startX,n.start.startY)}if(e){let s=Date.now(),r=this.gameTime.saveTime,a=(s-r)/1e3|0;a>0&&(this.totals.offlineSeconds+=a,this.offlineLogic.calculateOfflineEarnings())}this.mineDamageLogic.calculateTotalMineDamagePerTurn()}beforeImportSave(){for(let e=0;e<this.gameModels.length;e++)this.gameModels[e].resetFull()}afterImportSave(){this.initializeState(!0),this.projection.setGridCenter(n.start.startX,n.start.startY),this.gridLoadingManager.manageLoadedGridsForFrame()}resetForPrestige(){for(let e=0;e<this.gameModels.length;e++)this.gameModels[e].resetForPrestige();this.worldSeed++,this.initializeState(!1),this.projection.setGridCenter(n.start.startX,n.start.startY),this.gridLoadingManager.manageLoadedGridsForFrame()}resetFull(){for(let e=0;e<this.gameModels.length;e++)this.gameModels[e].resetFull();this.worldSeed++,this.initializeState(!1),this.projection.setGridCenter(n.start.startX,n.start.startY),this.gridLoadingManager.manageLoadedGridsForFrame()}};var c=class l{constructor(){}static getElement(e){return document.getElementById(e)}static createTextElement(e){return document.createTextNode(e)}static setInnerHtml(e,t){var i=l.getElement(e);i&&(i.innerHTML=t)}static createElement(e,t,i,s){var r=document.createElement(e);return s&&(r.className=s),i&&(r.id=i),t&&t.appendChild(r),r}static createInputElement(e,t,i,s){var r=document.createElement("input");return r.type=e,s&&(r.className=s),i&&(r.id=i),t&&t.appendChild(r),r}static clearChildren(e){var t=l.getElement(e);if(t)for(;t.firstChild;)t.removeChild(t.firstChild)}static removeElementById(e,t){this.removeElement(e,l.getElement(t))}static removeElement(e,t){var i=l.getElement(e);if(!(!i||!t))try{i.removeChild(t)}catch(s){s instanceof DOMException?(console.error("Caught a DOMException. parentId="+e+" elementId="+t.id,s.name,s.message),s.name==="SyntaxError"&&console.warn("Invalid CSS selector used.")):console.error("Caught a non-DOMException error.  parentId="+e+" elementId="+t.id,s)}}static hideElement(e){e&&(e.style.display="none")}static showElement(e){this.showElementWithValue(e,"block")}static showElementIdWithValue(e,t){l.showElementWithValue(l.getElement(e),t)}static showElementWithValue(e,t){e&&(e.style.display=t)}static hideElementId(e){l.hideElement(l.getElement(e))}static showElementId(e){l.showElement(l.getElement(e))}};var z=class{constructor(e,t){this.parentId=e,this.elementId=t,this.viewVisible=!0,this.currentlyVisible=!1,this.inialized=!1}getElementId(){return this.elementId}setCurrentlyVisible(e){this.currentlyVisible=e}isViewVisible(){return this.viewVisible}setViewVisible(e){this.viewVisible=e}setInitialVisibility(e){this.currentlyVisible=!e,this.viewVisible=e}clearChildViews(){}updateView(){if(this.inialized||console.log("View.updateView() Not initialized: "+this.constructor.name),this.elementId){var e=this.isViewVisible();this.currentlyVisible!==e&&(this.currentlyVisible=e,e?c.showElementIdWithValue(this.elementId,this.getVisibileDisplayValue()):c.hideElementId(this.elementId)),e&&this.updateViewContents()}}getVisibileDisplayValue(){return"block"}initializeView(){this.inialized=!0}updateViewContents(){}removeAll(){this.parentId&&c.removeElementById(this.parentId,this.elementId)}};var J=class extends z{constructor(e,t){super(e,t),this.childViews=null}getChildViews(){return this.childViews}clearChildViews(){if(this.childViews&&this.childViews.length>0){for(let e=0;e<this.childViews.length;e++)this.childViews[e].clearChildViews();this.childViews.length=0}}removeAll(){if(this.childViews)for(let e=0;e<this.childViews.length;e++)this.childViews[e].removeAll();this.childViews=null,super.removeAll()}removeChildViewElements(){if(!this.childViews||this.childViews.length===0)return;let e=this.getElementId();for(let t=0;t<this.childViews.length;t++)c.removeElementById(e,this.childViews[t].getElementId());this.clearChildViews()}removeViewAtIndex(e){if(!this.childViews||this.childViews.length===0)return;let t=this.childViews[e],i=this.getElementId();c.removeElementById(i,t.getElementId()),this.childViews.splice(e,1)}removeView(e){if(!this.childViews||this.childViews.length===0)return;let t=this.getElementId(),i=-1;for(let r=0;r<this.childViews.length;r++)if(this.childViews[r].getElementId()===e){i=r;break}if(i===-1){console.log("ParentView.removeView() Failed to find child id: "+e);return}let s=this.childViews[i];c.removeElementById(t,s.getElementId()),this.childViews.splice(i,1)}addView(e){e&&(this.childViews||(this.childViews=[]),this.childViews.push(e))}initializeView(){if(this.childViews)for(let e=0;e<this.childViews.length;e++)this.childViews[e].initializeView();super.initializeView()}updateViewContents(){this.updateChildViews()}updateChildViews(){if(this.childViews)for(let e=0;e<this.childViews.length;e++)this.childViews[e].updateView()}};var ee={GAME_VIEW_CONTAINER:"gameViewContainer",GAME_VIEW_OVERLAY_CONTAINER:"gameViewOverlayContainer",GAME_SKILL_TOGGLE_CONTAINER:"gameSkillToggleContainer",GAME_CANVAS:"gameCanvas",SKILL_TREE_GRAPH:"skillTreeGraph",CENTER_ON_CHARACTER_BUTTON:"centerOnCharacterButton",AUTO_PLAY_BUTTON:"autoPlayButton",ACTIVE_SKILLS_PANEL:"activeSkillsPanel",ACTIVE_BONUSES_PANEL:"activeBonusesPanel",PRIMARY_UPGRADE_PANEL:"primaryUpgradePanel",PRIMARY_UPGRADE_PANEL_TAB_BAR:"primaryUpgradePanelTabBar",UPGRADE_TAB_MENU_ITEM_CREW:"crewUpgradesMenuItem",SKILL_TREE_TAB_MENU_ITEM:"skillTreeMenuItem",FREE_UPGRADES_PANEL:"freeUpgradesPanel",MINED_UPGRADES_PANEL:"minedUpgradesPanel",PICK_UPGRADES_PANEL:"pickUpgradesPanel",GOLD_UPGRADES_PANEL:"goldUpgradesPanel",BONUS_PANEL:"bonusPanel",POINT_UPGRADES_PANEL:"pointUpgradesPanel",CREW_UPGRADES_PANEL:"crewUpgradesPanel",SKILL_SELECTION_PANEL:"skillSelectionPanel",SKILL_TREE_PANEL:"skillTreePanel",MENU_PANEL:"menuPanel",CREW_TAB_UPGRADE_COLLECTION:"upgradeCollection",CREW_PICK_UPGRADE_CONTENTS:"pickUpgradeBody",MINE_DAMAGE_VIEW:"mineDamageDisplay",MAX_DEPTH_VIEW:"maxDepth",MAX_LAYER_VIEW:"maxLayer",CURRENT_LAYER_VIEW:"currentLayer",CREW_MODE_VIEW:"crewMode",CURRENCY_VIEW:"currencyView",PRESTIGE_POPUP:"prestigePopup",OFFLINE_POPUP:"offlinePopup",STATISTICS_POPUP:"statisticsPopup",SAVE_POPUP:"savePopup",CLOSE_SKILL_TREE_POPUP:"closeSkillTree",PERFORMANCE_POPUP:"performancePopup"};var us=class{constructor(){this.firstMovement=!0,this.leftMouseDown=!1,this.prevMouseX=0,this.prevMouseY=0,this.mouseX=0,this.mouseY=0,this.mouseDeltaX=0,this.mouseDeltaY=0,this.mouseDownTime=0,this.mouseDownX=0,this.mouseDownY=0,this.leftMouseClick=!1,this.clickX=0,this.clickY=0,this.mouseWheelMotion=0,this.mouseMoved=!1}attachListeners(e,t){let i=this;t.onmouseover=function(s){return t.focus(),i.mouseX=s.clientX,i.mouseY=s.clientY,!1},t.onmouseout=function(s){i.leftMouseDown=!1,i.mouseX=s.clientX,i.mouseY=s.clientY,i.firstMovement=!0},e&&(e.onmouseout=function(s){i.leftMouseDown=!1,i.mouseX=s.clientX,i.mouseY=s.clientY,i.firstMovement=!0}),t.addEventListener("mousewheel",function(s){return i.mouseWheelMotion=-(s.wheelDelta||s.detail),!1},!1),t.addEventListener("DOMMouseScroll",function(s){return i.mouseWheelMotion=s.wheelDelta||s.detail,!1},!1),t.onmousedown=function(s){return i.mouseX=s.clientX,i.mouseY=s.clientY,i.prevMouseX=s.clientX,i.prevMouseY=s.clientY,i.mouseMoved=!1,i.mouseDeltaX=0,i.mouseDeltaY=0,i.mouseDownX=s.clientX,i.mouseDownY=s.clientY,i.mouseDownTime=Date.now(),(s.button===0||s.button===1)&&(i.leftMouseDown=!0),!1},t.onmouseup=function(s){if(i.mouseX=s.clientX,i.mouseY=s.clientY,i.mouseDeltaX=i.mouseX-i.prevMouseX,i.mouseDeltaY=i.mouseY-i.prevMouseY,i.prevMouseX=i.mouseX,i.prevMouseY=i.mouseY,s.button===0||s.button===1){i.leftMouseDown=!1;let r=i.mouseX-i.mouseDownX,o=i.mouseY-i.mouseDownY;Math.abs(r)<5&&Math.abs(o)<5&&Date.now()-i.mouseDownTime<250&&(i.leftMouseClick=!0,i.clickX=s.clientX,i.clickY=s.clientY)}return!1},t.onmousemove=function(s){return i.onMouseMove(s.clientX,s.clientY),!1}}onMouseMove(e,t){this.mouseX=e,this.mouseY=t,this.mouseMoved=!0,this.firstMovement?this.firstMovement=!1:(this.mouseDeltaX+=this.mouseX-this.prevMouseX,this.mouseDeltaY+=this.mouseY-this.prevMouseY),this.prevMouseX=this.mouseX,this.prevMouseY=this.mouseY}resetInputState(){this.leftMouseClick=!1,this.mouseWheelMotion=0,this.mouseDeltaX=0,this.mouseDeltaY=0,this.mouseMoved=!1}};var Hn=class extends z{constructor(e,t,i){super(e,ee.GAME_CANVAS),this.canvas=null,this.context=null,this.userInput=i,this.projection=t.projection,this.sprites=t.sprites,this.tileDamageSpriteOverlay=this.sprites.tileDamageSpriteOverlay,this.oreSpriteOverlay=this.sprites.oreSpriteOverlay,this.upgradeSpriteOverlay=this.sprites.tileSpriteOverlaySpritesheet.upgradeSpriteOverlay,this.crew=t.crew,this.partyTarget=t.partyTarget,this.state=t,this.worldGrid=t.worldGrid,this.vectorField=t.vectorField,this.infoTextProcessor=t.infoTextProcessor,this.spriteSize=0,this.scaledSize=0,this.screenCoordinate=new v(0,0),this.screenCoordinate2=new v(0,0),this.worldCoordinate=new v(0,0),this.tileHealthNum=new d(0),this.crewBrain=t.crewBrain;let s=this;this.renderRegionBorderDebugCallback=r=>{r.vectorFieldNumber==this.vectorField.vectorFieldNumber&&s.renderRegionBorder(r)},this.renderTilesCallback=r=>{s.renderTile(r)},this.renderMonstersCallback=r=>{s.renderMonsterCharacters(r)}}initializeView(){let e=c.getElement(this.parentId);this.canvas=c.createElement("canvas",e,ee.GAME_CANVAS,"game-canvas"),this.context=this.canvas.getContext("2d"),this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.userInput.attachListeners(document,this.canvas),this.projection.setCanvas(this.canvas),this.setInitialVisibility(!0),super.initializeView()}getCanvas(){return this.canvas}updateViewContents(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.font="12pt helvetica",this.context.imageSmoothingEnabled=!1,ne.startTime("Render-total"),this.renderWorld(),ne.endTime("Render-total")}renderWorld(){this.spriteSize=this.sprites.tileSpritesheet.spriteSize,this.scaledSize=this.spriteSize*this.projection.zoom;let e=this;ne.startTime("Render-blocks"),be.allVisibleTiles(this.worldGrid,this.projection,this.renderTilesCallback),ne.endTime("Render-blocks"),this.renderInfoText(),be.allVisibleGrids(this.worldGrid,this.projection,this.renderMonstersCallback),this.state.gameOptions.crewBrainDebugEnabled&&(this.renderRegionBordersDebug(),this.renderVectorFieldTargets()),this.renderTileDepths(),ne.startTime("Render-effects"),this.renderEffects(),this.renderSkills(),ne.endTime("Render-effects"),ne.startTime("Render-crew"),this.renderCrew(),ne.endTime("Render-crew"),this.state.gameOptions.crewBrainDebugEnabled&&this.renderPaths(),this.state.gameOptions.displayFps&&(this.context.fillStyle="white",this.context.fillText("FPS: "+this.state.currentFps,350,this.canvas.height-160))}renderPaths(){let e=this.crew.miners;for(let t=0;t<e.length;t++)this.renderPath(e[t])}renderPath(e){if(e.position.tile&&!(e.position.pathPlan.length<2)){this.context.strokeStyle=e.target.invalidated?"#F114":"#F834",this.context.lineWidth=4,this.context.beginPath();for(let t=0;t<e.position.pathPlan.length;t++){let i=e.position.pathPlan[t];this.screenCoordinate.copy(i.startTile.origin),this.screenCoordinate.addXY(n.tile.halfSize,n.tile.halfSize),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.context.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),this.screenCoordinate.copy(i.endTile.origin),this.screenCoordinate.addXY(n.tile.halfSize,n.tile.halfSize),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.context.lineTo(this.screenCoordinate.x,this.screenCoordinate.y)}this.context.stroke()}}renderCrew(){let e=this.crew.miners;this.spriteSize=this.sprites.itemOverlaySpritesheet.spriteSize,this.scaledSize=this.spriteSize*this.projection.zoom;for(let t=0;t<e.length;t++)this.renderThruster(e[t]);this.spriteSize=this.sprites.tileSpritesheet.spriteSize,this.scaledSize=this.spriteSize*this.projection.zoom;for(let t=0;t<e.length;t++)this.renderCharacter(e[t]);this.spriteSize=this.sprites.itemOverlaySpritesheet.spriteSize,this.scaledSize=this.spriteSize*this.projection.zoom;for(let t=0;t<e.length;t++)this.renderItemOverlay(e[t])}renderTileNeighborScores(e){let t=e.neighbors;this.screenCoordinate.copy(e.origin),this.screenCoordinate.addXY(n.tile.halfSize,n.tile.halfSize);for(let i=0;i<t.length;i++){let s=t[i];s&&(s.lighting.everVisibleToCharacter||s.tileType===ge.SKY||(this.screenCoordinate2.copy(s.origin),this.screenCoordinate2.subtract(e.origin),this.screenCoordinate2.scale(.5),this.screenCoordinate2.add(this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),s.open?this.context.fillRect(this.screenCoordinate2.x-3,this.screenCoordinate2.y-3,6,6):this.context.fillRect(this.screenCoordinate2.x-2,this.screenCoordinate2.y-2,4,4)))}}renderInfoText(){let e=this.infoTextProcessor.infoTextArray;if(e.length!==0){this.context.fillStyle="white";for(let t=0;t<e.length;t++){let i=e[t];this.context.fillText(i.text,i.textX,i.textY)}}}renderRegionBordersDebug(){if(!this.state.vectorField.centerTile)return;let e=this.state.vectorField.centerTile.origin,t=25*n.tile.size;be.allNearbyRegions(this.worldGrid,this.projection,e,t,this.renderRegionBorderDebugCallback)}renderRegionBorder(e){this.screenCoordinate.copy(e.origin),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.screenCoordinate2.copy(e.origin),this.screenCoordinate2.addXY(n.grid.regionPixelWidth,n.grid.regionPixelHeight),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2);let t=Math.abs(this.screenCoordinate2.x-this.screenCoordinate.x),i=Math.abs(this.screenCoordinate2.y-this.screenCoordinate.y);this.context.strokeStyle="#22222288",this.context.lineWidth=2,this.context.strokeRect(this.screenCoordinate.x,this.screenCoordinate.y,t,i)}renderVectorFieldTargets(){this.context.fillStyle="#FF0000",this.renderTargetList(this.vectorField.priorityMiningCandidates),this.context.fillStyle="#FFFF00",this.renderTargetList(this.vectorField.currencyMiningCandidates),this.context.fillStyle="#FF00FF",this.renderTargetList(this.vectorField.commonMiningCandidates);for(let s=0;s<this.crew.miners.length;s++){let r=this.crew.miners[s],o=r.target.targetTile,a=r.target.mineTile;this.renderMineTarget(r.position.tile,o,a)}let e=this.vectorField.centerTile;e&&(this.screenCoordinate.copy(e.origin),this.screenCoordinate.addXY(4,4),this.screenCoordinate2.copy(e.origin),this.screenCoordinate2.addXY(n.tile.size-4,n.tile.size-4),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),this.context.fillStyle="#FFFFFF",this.context.fillRect(this.screenCoordinate.x,this.screenCoordinate.y,this.screenCoordinate2.x-this.screenCoordinate.x,this.screenCoordinate2.y-this.screenCoordinate.y));let t=this.crew.centerTile;t&&(this.screenCoordinate.copy(t.origin),this.screenCoordinate.addXY(4,4),this.screenCoordinate2.copy(t.origin),this.screenCoordinate2.addXY(n.tile.size-4,n.tile.size-4),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),this.context.fillStyle="#00FFFF",this.context.fillRect(this.screenCoordinate.x,this.screenCoordinate.y,this.screenCoordinate2.x-this.screenCoordinate.x,this.screenCoordinate2.y-this.screenCoordinate.y));let i=this.vectorField.destinationTileCandidates;if(i.length>0){this.context.strokeStyle="#FF02",this.context.lineWidth=2;for(let s=0;s<i.length;s++){let r=i[s];if(!r)break;this.screenCoordinate.copy(r.origin),this.screenCoordinate.addXY(4,4),this.screenCoordinate2.copy(r.origin),this.screenCoordinate2.addXY(n.tile.size-4,n.tile.size-4),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),this.context.strokeRect(this.screenCoordinate.x,this.screenCoordinate.y,this.screenCoordinate2.x-this.screenCoordinate.x,this.screenCoordinate2.y-this.screenCoordinate.y)}}this.context.fillStyle="#888",this.context.fillText("瓷砖生命值: "+(this.state.mineControl.debugTileHealthNegligible?"negligible":"normal"),250,this.canvas.height-280),this.context.fillText("搜索网格: "+(this.state.mineControl.debugSearchGridSmall?"small":"normal"),250,this.canvas.height-260),this.context.fillText("高级瓷砖: "+(this.state.mineControl.debugIgnorePremium?"ignored":"targeted"),250,this.canvas.height-240),this.context.fillText("普通瓷砖: "+(this.state.mineControl.debugIgnoreCommon?"ignored":"targeted"),250,this.canvas.height-220),this.context.fillText("目标介绍: "+this.state.mineControl.debugGoalDescription,250,this.canvas.height-200)}renderMineTarget(e,t,i){e&&(i&&(this.screenCoordinate.copy(i.origin),this.screenCoordinate.addXY(n.tile.quarterSize+2,n.tile.quarterSize+2),this.screenCoordinate2.copy(i.origin),this.screenCoordinate2.addXY(n.tile.threeQuarterSize-2,n.tile.threeQuarterSize-2),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),this.context.fillStyle="#4444FF",this.context.fillRect(this.screenCoordinate.x,this.screenCoordinate.y,this.screenCoordinate2.x-this.screenCoordinate.x,this.screenCoordinate2.y-this.screenCoordinate.y)),t&&(this.screenCoordinate.copy(t.origin),this.screenCoordinate.addXY(n.tile.quarterSize+2,n.tile.quarterSize+2),this.screenCoordinate2.copy(t.origin),this.screenCoordinate2.addXY(n.tile.threeQuarterSize-2,n.tile.threeQuarterSize-2),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),this.context.fillStyle="#FF4444",this.context.fillRect(this.screenCoordinate.x,this.screenCoordinate.y,this.screenCoordinate2.x-this.screenCoordinate.x,this.screenCoordinate2.y-this.screenCoordinate.y),this.renderLineDebug(e,t,"#AAF4")))}renderLineDebug(e,t,i){this.context.strokeStyle=i,this.context.lineWidth=4,this.context.beginPath(),this.screenCoordinate.copy(e.origin),this.screenCoordinate.addXY(n.tile.halfSize,n.tile.halfSize),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.context.moveTo(this.screenCoordinate.x,this.screenCoordinate.y),this.screenCoordinate.copy(t.origin),this.screenCoordinate.addXY(n.tile.halfSize,n.tile.halfSize),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.context.lineTo(this.screenCoordinate.x,this.screenCoordinate.y),this.context.stroke()}renderTargetList(e){for(let t=0;t<e.length;t++){let i=e[t];this.screenCoordinate.copy(i.origin),this.screenCoordinate.addXY(n.tile.quarterSize,n.tile.quarterSize),this.screenCoordinate2.copy(i.origin),this.screenCoordinate2.addXY(n.tile.threeQuarterSize,n.tile.threeQuarterSize),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),this.context.fillRect(this.screenCoordinate.x,this.screenCoordinate.y,this.screenCoordinate2.x-this.screenCoordinate.x,this.screenCoordinate2.y-this.screenCoordinate.y)}}renderGridBorders(){this.context.strokeStyle="#11111122",this.context.lineWidth=1;let e=this.spriteSize*this.projection.zoom*n.grid.gridTileWidth,t=this.worldGrid.grids;for(let i=0;i<t.length;i++){let s=t[i];this.projection.isVisibleGridBox(s)&&(this.projection.worldToScreen(s.origin,this.screenCoordinate),this.context.strokeRect(this.screenCoordinate.x,this.screenCoordinate.y,e,e))}}renderTileDepths(){this.context.fillStyle="#22222211",this.context.fillRect(0,0,190,this.canvas.height);let t=this.worldGrid.findGridTile(this.projection.gridCenter);if(!t)return;this.context.fillStyle="#666666FF";let i=t;for(this.renderTileDepth(i),this.renderTileHealth(i),i=t.getNeighborTop();i&&this.projection.isVisibleGridBox(i);)this.renderTileDepth(i),this.renderTileHealth(i),i=i.getNeighborTop();for(i=t.getNeighborBottom();i&&this.projection.isVisibleGridBox(i);)this.renderTileDepth(i),this.renderTileHealth(i),i=i.getNeighborBottom();this.context.fillStyle="#111111EE",this.context.fillRect(0,this.canvas.height-30,190,30),this.context.fillStyle="#666666FF",this.context.fillText("深度",5,this.canvas.height-10),this.context.fillText("生命值",100,this.canvas.height-10)}renderTileDepth(e){let i=e.getTileRow();i===this.partyTarget.targetRow?(this.screenCoordinate.copy(e.origin),this.screenCoordinate.y+=n.tile.size,this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.context.fillStyle="#FF8822FF",this.context.fillRect(0,this.screenCoordinate.y,80,3),this.context.fillText(""+this.partyTarget.targetRow+" target",5,this.screenCoordinate.y-5)):i%5===0&&(this.screenCoordinate.copy(e.origin),this.screenCoordinate.y+=n.tile.size,this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.context.fillStyle="#666666FF",this.context.fillRect(0,this.screenCoordinate.y,80,2),this.context.fillText(""+i,5,this.screenCoordinate.y-5))}renderTileHealth(e){let t=e.getTileRow();if(t<0)return;this.screenCoordinate.copy(e.origin),this.screenCoordinate.y+=n.tile.size,this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),e.tileType.layerDescription.calculateTileHealth(t,this.tileHealthNum),this.context.fillStyle="#666666FF",this.context.fillText(I.formatBigNum(this.tileHealthNum),100,this.screenCoordinate.y-5)}renderMonsterCharacters(e){let t=e.characters;for(let i=0;i<t.length;i++)t[i].isMonster()&&this.renderCharacter(t[i])}renderCharacter(e){if(!this.projection.isVisible(e.position.worldCoordinateOrigin,n.tile.size))return;let t=e.position.tile;if(!t)return;let i=t.lighting;if(!i.everVisibleToCharacter||t.tileType.lightingSupported&&i.shadowColor.a===0)return;let s=e.getCharacterSprite();e.position.facingLeft?(this.projection.worldToScreen(e.position.worldCoordinateOrigin,this.screenCoordinate),this.renderSprite(s,this.screenCoordinate)):(this.worldCoordinate.copy(e.position.worldCoordinateOrigin),this.worldCoordinate.addXY(this.spriteSize,0),this.projection.worldToScreen(this.worldCoordinate,this.screenCoordinate),this.context.save(),this.context.translate(this.screenCoordinate.x,this.screenCoordinate.y),this.context.scale(-1,1),this.screenCoordinate.set(0,0),this.renderSprite(s,this.screenCoordinate),this.context.restore())}renderItemOverlay(e){this.projection.isVisible(e.position.worldCoordinateOrigin,n.tile.size)&&this.renderOverlaySprite(e,e.getItemOverlaySprite())}renderThruster(e){this.projection.isVisible(e.position.worldCoordinateOrigin,n.tile.size)&&this.renderOverlaySprite(e,e.getThrusterOverlaySprite())}renderOverlaySprite(e,t){t&&(e.position.facingLeft?(this.worldCoordinate.copy(e.position.worldCoordinateOrigin),this.worldCoordinate.subtractXY(n.tile.size,n.tile.size),this.projection.worldToScreen(this.worldCoordinate,this.screenCoordinate),this.renderSprite(t,this.screenCoordinate)):(this.worldCoordinate.copy(e.position.worldCoordinateOrigin),this.worldCoordinate.subtractXY(n.tile.size,n.tile.size),this.worldCoordinate.addXY(this.spriteSize,0),this.projection.worldToScreen(this.worldCoordinate,this.screenCoordinate),this.context.save(),this.context.translate(this.screenCoordinate.x,this.screenCoordinate.y),this.context.scale(-1,1),this.screenCoordinate.set(0,0),this.renderSprite(t,this.screenCoordinate),this.context.restore()))}renderTile(e){if(e){if(!e.tileType.lightingSupported)this.projection.worldToScreen(e.origin,this.screenCoordinate),e.open?this.renderSprite(e.backgroundSprite,this.screenCoordinate):this.renderSprite(e.sprite,this.screenCoordinate);else{let t=e.lighting;if(!t.everVisibleToCharacter)return;this.projection.worldToScreen(e.origin,this.screenCoordinate);let i=t.calculateShadowColor();if(i.a>0){if(e.open?(this.renderSprite(e.backgroundSprite,this.screenCoordinate),e.fixtureDescription&&(e.fixtureDescription.sprite||(e.fixtureDescription.sprite=this.sprites.staticFixtureSpritesheet.getSprite(e.fixtureDescription.spriteName)),this.renderSprite(e.fixtureDescription.sprite,this.screenCoordinate))):this.renderSprite(e.sprite,this.screenCoordinate),!e.open&&e.healthPercent!=100){let s=this.tileDamageSpriteOverlay.getDamageSprite(e);s&&(this.context.globalAlpha=.7,this.renderSprite(s,this.screenCoordinate),this.context.globalAlpha=1)}if(!e.open&&e.tileType.rarityModifier!==_.COMMON)if(e.tileType.rarityModifier===_.UPGRADE){let s=this.upgradeSpriteOverlay.getCurrentSpriteDefault();s&&this.renderSprite(s,this.screenCoordinate)}else{let s=this.oreSpriteOverlay.getOreSprite(e);s&&this.renderSprite(s,this.screenCoordinate)}i.a<1&&(this.context.fillStyle=i.getFillColor(),this.context.fillRect(this.screenCoordinate.x,this.screenCoordinate.y,this.scaledSize,this.scaledSize))}}this.state.gameOptions.crewBrainDebugEnabled&&this.renderTileDebug(e)}}renderTileDebug(e){let t=this.vectorField.vectorFieldNumber,i=e.pathData.getMineScore(t);i!==at.UNSET&&(this.screenCoordinate.copy(e.origin),this.screenCoordinate.addXY(n.tile.quarterSize,n.tile.quarterSize),this.screenCoordinate2.copy(e.origin),this.screenCoordinate2.addXY(n.tile.threeQuarterSize,n.tile.threeQuarterSize),this.projection.worldToScreen(this.screenCoordinate,this.screenCoordinate),this.projection.worldToScreen(this.screenCoordinate2,this.screenCoordinate2),i===at.IN_RANGE_UNSEEN?this.context.fillStyle="#8665":i===at.WORTHLESS&&(this.context.fillStyle="#8885"),this.context.fillRect(this.screenCoordinate.x,this.screenCoordinate.y,this.screenCoordinate2.x-this.screenCoordinate.x,this.screenCoordinate2.y-this.screenCoordinate.y))}renderSkills(){let e=this.state.skillTreeGraph.skills;for(let t=0;t<e.length;t++){let i=e[t];if(!i.isUnlocked())continue;let s=i.getRenderer();s&&s.renderSkill(this.context,this.projection)}}renderEffects(){this.renderSpriteEffects()}renderSpriteEffects(){let e=this.state.effectManager.spriteEffects;e.length!==0&&this.renderEffectList(e)}renderEffectList(e){for(let t=0;t<e.length;t++){let i=e[t];if(!i||i.isEffectFinished()||i.isNotStarted())continue;let s=i.getSprite();if(!s)continue;let r=i.getPosition();this.projection.isVisible(r,n.tile.size)&&(this.projection.worldToScreen(r,this.screenCoordinate),this.renderScaledSprite(s,this.screenCoordinate))}}renderScaledSprite(e,t){if(e){let i=e.getSize();this.context.drawImage(e.getImage(),e.spriteX,e.spriteY,i,i,t.x,t.y,this.scaledSize,this.scaledSize)}}renderSprite(e,t){e&&this.context.drawImage(e.getImage(),e.spriteX,e.spriteY,this.spriteSize,this.spriteSize,t.x,t.y,this.scaledSize,this.scaledSize)}};var Gd=-1,cs=class extends z{constructor(e,t,i){super(e,t),this.bonus=i,this.mainElement=null,this.activeProgressElement=null,this.titleElement=null,this.descriptionElement=null,this.displayedTitle=null,this.displayedDescription=null,this.displayState=Gd}initializeView(){let e=this.getElementId(),t=c.getElement(this.parentId);if(!t){console.log("ActiveSkillView.initializeView() No parent element found! parentId="+this.parentId);return}this.mainElement=c.createElement("div",t,e,"active-skill-button-outer-active"),this.activeProgressElement=c.createElement("div",this.mainElement,null,"active-skill-panel-activated");let i=c.createElement("div",this.mainElement,null,"active-skill-button-body"),s=c.createElement("div",i,null,"icon-container"),r=c.createElement("div",i,null,"active-skill-title-description-container"),o=c.createElement("img",s,null,null);o.src=this.bonus.spriteFileName,this.titleElement=c.createElement("div",r,null,"skill-panel-row1-title"),this.titleElement.innerHTML="",this.descriptionElement=c.createElement("div",r,null,"skill-panel-row2-description"),this.descriptionElement.innerHTML="",this.setInitialVisibility(!0),super.initializeView()}updateViewContents(){let e=this.bonus.getTitle();e!==this.displayedTitle&&(this.displayedTitle=e,this.titleElement.innerHTML=e);let t=this.bonus.getDescription();t&&t!==this.displayedDescription&&(this.displayedDescription=t,this.descriptionElement&&(this.descriptionElement.innerHTML=t));let i=this.bonus.getActivationPercent();this.activeProgressElement.style.width=i+"%"}};var zn=class extends J{constructor(e,t){super(e,ee.ACTIVE_BONUSES_PANEL);let i=this.getElementId(),s=t.activeBonuses;for(let r=0;r<s.length;r++){let o=new cs(i,i+"_"+r,s[r]);this.addView(o)}this.bonusCollection=t,this.displayedChangeCount=-1}initializeView(){let e=c.getElement(this.parentId);c.createElement("div",e,this.getElementId(),"active-skills-panel"),super.initializeView()}updateViewContents(){if(this.displayedChangeCount!==this.bonusCollection.activeChangeCount){this.displayedChangeCount=this.bonusCollection.activeChangeCount,console.log("-------------------------------"),console.log("active change count: "+this.bonusCollection.activeChangeCount),console.log("   active bonuses:  "+this.bonusCollection.activeBonuses.length),this.removeChildViewElements();let e=this.getElementId(),t=this.bonusCollection.activeBonuses;for(let i=0;i<t.length;i++){let s=new cs(e,e+"_"+i,t[i]);this.addView(s),console.log("  adding view: "+t[i].id),s.initializeView()}}super.updateViewContents()}getVisibileDisplayValue(){return"flex"}};var Wn=class extends z{constructor(e,t,i){super(e,ee.CENTER_ON_CHARACTER_BUTTON),this.projection=t,this.panAnimation=i,this.setInitialVisibility(!1)}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,this.elementId,"center-on-character-button");t.style.display="none";let i=c.createElement("img",t,null,null);i.src="images/ui_center_button.png",i.title="Center on Crew";let s=this;t.onclick=function(){s.panAnimation.startAnimation()},super.initializeView()}updateView(){let e=!this.projection.stayCenteredOnCharacter&&!this.panAnimation.animating;e!==this.isViewVisible()&&this.setViewVisible(e),super.updateView()}};var Yn=class extends J{constructor(e,t,i,s){super(e,t),this.addView(new Wn(t,i,s))}initializeView(){let e=c.getElement(this.parentId);c.createElement("div",e,this.getElementId(),"bottom-row-button-container"),super.initializeView()}};var Kn=class extends z{constructor(e,t,i){super(e,e+"_base_ore"),this.damage=t,this.values=i,this.displayedBasePickDamage=new d(0),this.basePickDamageString=null,this.workingNum=new d(0),this.turnsPerSecond=new d(n.time.turnsPerSecond),this.baseAdditiveBody=null,this.setInitialVisibility(!0)}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,null,"mine-damage-panel-main-section"),i=c.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Base",this.baseAdditiveBody=c.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.basePickDamagePerTurn,t=this.values.baseAdditiveBonusPerTurn.getValue();(!this.basePickDamageString||!t.equals(this.displayedBasePickDamage))&&(this.displayedBasePickDamage.copy(t),this.workingNum.copy(e),this.workingNum.add(t),this.workingNum.mul(this.turnsPerSecond),this.basePickDamageString=I.formatBigNum(this.workingNum)+"/s",this.baseAdditiveBody.innerHTML=this.basePickDamageString),super.updateViewContents()}};var Xn=class extends z{constructor(e,t){super(e,e+"_depth"),this.damage=t,this.displayedDamageMultiplier=new d(-10),this.bonusString=null,this.body=null,this.setInitialVisibility(!0)}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,this.getElementId(),"mine-damage-panel-main-section"),i=c.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Depth",this.body=c.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.depthDamageMultiplier;(!this.bonusString||!e.equals(this.displayedDamageMultiplier))&&(this.displayedDamageMultiplier.copy(e),this.bonusString=I.formatBigNum(e),this.body.innerHTML=this.bonusString),super.updateViewContents()}getVisibileDisplayValue(){return"inline-block"}};var jn=class extends z{constructor(e,t){super(e,e+"_gold"),this.damage=t,this.displayedGoldDamageMultiplier=new d(-1),this.goldBonusString=null,this.body=null,this.setInitialVisibility(!0)}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,this.getElementId(),"mine-damage-panel-main-section"),i=c.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Gold",this.body=c.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.goldDamageMultiplier;(!this.goldBonusString||!e.equals(this.displayedGoldDamageMultiplier))&&(this.displayedGoldDamageMultiplier.copy(e),this.goldBonusString=I.formatBigNum(e),this.body.innerHTML=this.goldBonusString),super.updateViewContents()}getVisibileDisplayValue(){return"inline-block"}};var Zn=class extends z{constructor(e){super(e,null),this.setInitialVisibility(!0)}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,null,"mine-damage-panel-operator-section"),i=c.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML+="Mine";let s=c.createElement("div",t,null,"mine-damage-panel-section-body");s.innerHTML="Damage:",super.initializeView()}};var qn=class extends z{constructor(e,t){super(e,e+"_multore"),this.values=t,this.displayedBonus=new d(0),this.displayedValue=null,this.workingNum=new d(0),this.oneBigNum=new d(1),this.body=null,this.setInitialVisibility(!0)}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,null,"mine-damage-panel-main-section"),i=c.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Ore Multi",this.body=c.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.values.baseMultiplicativeBonusValue.getValue();(!this.displayedValue||!e.equals(this.displayedBonus))&&(this.displayedBonus.copy(e),this.workingNum.copy(this.oneBigNum),this.workingNum.add(e),this.displayedValue=I.formatBigNum(this.workingNum),this.body.innerHTML=this.displayedValue),super.updateViewContents()}};var Jn=class extends z{constructor(e,t){super(e,e+"_ruby"),this.damage=t,this.displayedDamageMultiplier=new d(-1),this.damageBonusString=null,this.body=null,this.setInitialVisibility(!0)}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,this.getElementId(),"mine-damage-panel-main-section"),i=c.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Ruby",this.body=c.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.rubyDamageMultiplier;(!this.damageBonusString||!e.equals(this.displayedDamageMultiplier))&&(this.displayedDamageMultiplier.copy(e),this.damageBonusString=I.formatBigNum(e),this.body.innerHTML=this.damageBonusString),super.updateViewContents()}getVisibileDisplayValue(){return"inline-block"}};var ft=class extends z{constructor(e,t,i){super(e,t),this.operator=i,this.setInitialVisibility(!0)}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,this.getElementId(),"mine-damage-panel-operator-section"),i=c.createElement("div",t,null,null);i.innerHTML+="&nbsp;";let s=c.createElement("div",t,null,null);s.innerHTML=this.operator,super.initializeView()}getVisibileDisplayValue(){return"inline-block"}};var Qn=class extends z{constructor(e,t){super(e,e+"_prestige"),this.damage=t,this.displayedPrestigeDamageMultiplier=new d(0),this.prestigeBonusString=null,this.body=null,this.setInitialVisibility(!0)}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,this.getElementId(),"mine-damage-panel-main-section"),i=c.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Prestige",this.body=c.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.prestigeDamageMultiplier;(!this.prestigeBonusString||!e.equals(this.displayedPrestigeDamageMultiplier))&&(this.displayedPrestigeDamageMultiplier.copy(e),this.prestigeBonusString=I.formatBigNum(e),this.body.innerHTML=this.prestigeBonusString),super.updateViewContents()}getVisibileDisplayValue(){return"inline-block"}};var $n=class extends z{constructor(e,t){super(e,e+"_tot"),this.damage=t,this.displayedTotalDamage=new d(0),this.totalDamageString=null,this.workingNum=new d(0),this.turnsPerSecond=new d(n.time.turnsPerSecond),this.baseTotalBody=null,this.setInitialVisibility(!0)}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,null,"mine-damage-panel-main-section"),i=c.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Total Damage",this.baseTotalBody=c.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.totalPickDamagePerTurn;(!this.totalDamageString||!e.equals(this.displayedTotalDamage))&&(this.displayedTotalDamage.copy(e),this.workingNum.copy(e),this.workingNum.mul(this.turnsPerSecond),this.totalDamageString=I.formatBigNum(this.workingNum),this.baseTotalBody.innerHTML=this.totalDamageString+"/Sec")}};var ea=class extends z{constructor(e,t){super(e,e+"_mined"),this.damage=t,this.displayedDamageMultiplier=new d(0),this.bonusString=null,this.body=null,this.setInitialVisibility(!0)}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,this.getElementId(),"mine-damage-panel-main-section"),i=c.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Mined",this.body=c.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.minedDamageMultiplier;(!this.bonusString||!e.equals(this.displayedDamageMultiplier))&&(this.displayedDamageMultiplier.copy(e),this.bonusString=I.formatBigNum(e),this.body.innerHTML=this.bonusString),super.updateViewContents()}getVisibileDisplayValue(){return"inline-block"}};var ta=class extends z{constructor(e,t){super(e,e+"_blocks"),this.damage=t,this.displayedDamageMultiplier=new d(-1),this.damageBonusString=null,this.body=null,this.setInitialVisibility(!0)}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,this.getElementId(),"mine-damage-panel-main-section"),i=c.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Blocks",this.body=c.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.damage.blockDamageMultiplier;(!this.damageBonusString||!e.equals(this.displayedDamageMultiplier))&&(this.displayedDamageMultiplier.copy(e),this.damageBonusString=I.formatBigNum(e),this.body.innerHTML=this.damageBonusString),super.updateViewContents()}getVisibileDisplayValue(){return"inline-block"}};var ia=class extends J{constructor(e,t,i,s){super(e,ee.MINE_DAMAGE_VIEW),this.one=new d(1),this.damage=t,this.minedDamageVisible=!1,this.prestigeDamageVisible=!1,this.goldDamageVisible=!1,this.depthDamageVisible=!1,this.rubyDamageVisible=!1,this.blocksDamageVisible=!1,this.addView(new Zn(this.elementId)),this.addView(new Kn(this.elementId,t,i)),this.addView(new ft(this.elementId,this.elementId+"3"," x ")),this.addView(new qn(this.elementId,i)),this.minedDamageOperator=new ft(this.elementId,this.elementId+"6"," x "),this.minedDamageView=new ea(this.elementId,t),this.addView(this.minedDamageOperator),this.addView(this.minedDamageView),this.minedDamageOperator.setInitialVisibility(!1),this.minedDamageView.setInitialVisibility(!1),this.prestigeOperator=new ft(this.elementId,this.elementId+"7"," x "),this.prestigeDamageView=new Qn(this.elementId,t),this.addView(this.prestigeOperator),this.addView(this.prestigeDamageView),this.prestigeOperator.setInitialVisibility(!1),this.prestigeDamageView.setInitialVisibility(!1),this.goldOperator=new ft(this.elementId,this.elementId+"8"," x "),this.goldDamageView=new jn(this.elementId,t),this.addView(this.goldOperator),this.addView(this.goldDamageView),this.goldOperator.setInitialVisibility(!1),this.goldDamageView.setInitialVisibility(!1),this.depthOperator=new ft(this.elementId,this.elementId+"9"," x "),this.depthDamageView=new Xn(this.elementId,t),this.addView(this.depthOperator),this.addView(this.depthDamageView),this.depthOperator.setInitialVisibility(!1),this.depthDamageView.setInitialVisibility(!1),this.rubyOperator=new ft(this.elementId,this.elementId+"10"," x "),this.rubyDamageView=new Jn(this.elementId,t),this.addView(this.rubyOperator),this.addView(this.rubyDamageView),this.rubyOperator.setInitialVisibility(!1),this.rubyDamageView.setInitialVisibility(!1),this.blocksOperator=new ft(this.elementId,this.elementId+"11"," x "),this.blocksDamageView=new ta(this.elementId,t),this.addView(this.blocksOperator),this.addView(this.blocksDamageView),this.blocksOperator.setInitialVisibility(!1),this.blocksDamageView.setInitialVisibility(!1),this.addView(new ft(this.elementId,this.elementId+"12"," = ")),this.addView(new $n(this.elementId,t)),this.setInitialVisibility(!0)}initializeView(){let e=c.getElement(this.parentId);c.createElement("div",e,this.getElementId(),"mine-damage-panel"),super.initializeView()}updateView(){let e=this.damage.minedDamageMultiplier.greaterThan(this.one),t=this.damage.prestigeDamageMultiplier.greaterThan(this.one),i=this.damage.goldDamageMultiplier.greaterThan(this.one),s=this.damage.depthDamageMultiplier.greaterThan(this.one),r=this.damage.rubyDamageMultiplier.greaterThan(this.one),o=this.damage.blockDamageMultiplier.greaterThan(this.one);this.minedDamageVisible!==e&&(this.minedDamageVisible=e,this.minedDamageOperator.setViewVisible(e),this.minedDamageView.setViewVisible(e)),this.prestigeDamageVisible!==t&&(this.prestigeDamageVisible=t,this.prestigeOperator.setViewVisible(t),this.prestigeDamageView.setViewVisible(t)),this.goldDamageVisible!==i&&(this.goldDamageVisible=i,this.goldOperator.setViewVisible(i),this.goldDamageView.setViewVisible(i)),this.depthDamageVisible!==s&&(this.depthDamageVisible=s,this.depthOperator.setViewVisible(s),this.depthDamageView.setViewVisible(s)),this.rubyDamageVisible!==r&&(this.rubyDamageVisible=r,this.rubyOperator.setViewVisible(r),this.rubyDamageView.setViewVisible(r)),this.blocksDamageVisible!==o&&(this.blocksDamageVisible=o,this.blocksOperator.setViewVisible(o),this.blocksDamageView.setViewVisible(o)),super.updateView()}getVisibileDisplayValue(){return"inline-block"}};var sa=class extends J{constructor(e,t,i,s,r){super(e,t),this.addView(new ia(t,i,s,r))}initializeView(){let e=c.getElement(this.parentId);c.createElement("div",e,this.getElementId(),"bottom-row-damage"),super.initializeView()}};var ra=class extends z{constructor(e,t){super(e,e+"_target"),this.partyTarget=t,this.displayedTargetRow=-10,this.baseBody=null,this.setInitialVisibility(!0)}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,null,"mine-damage-panel-main-section"),i=c.createElement("div",t,null,"mine-damage-panel-section-header");i.innerHTML="Target Depth",this.baseBody=c.createElement("div",t,null,"mine-damage-panel-section-body"),super.initializeView()}updateViewContents(){let e=this.partyTarget.targetRow;this.displayedTargetRow!=e&&(this.displayedTargetRow=e,this.baseBody.innerHTML=I.formatNumber(e))}};var oi=class extends z{constructor(e,t,i,s,r,o){super(e,t),this.mineControl=i,this.mineMode=s,this.topRowText=r,this.bottomRowText=o,this.mainElement=null,this.displayedActive=!1}initializeView(){let e=this.getElementId(),t=c.getElement(this.parentId);if(!t){console.log("MineModeOption.initializeView() No parent element found! parentId="+this.parentId);return}this.displayedActive=this.mineControl.activeMode===this.mineMode,this.mainElement=c.createElement("div",t,e,this.displayedActive?"mine-mode-button-outer-active":"mine-mode-button-outer-not-active");let i=c.createElement("div",this.mainElement,null,"mine-mode-button-row"),s=c.createElement("div",i,null,"icon-container"),r=c.createElement("img",s,null,"icon-container");r.src=u.pick;let o=c.createElement("div",i,null,"pick-upgrade-title-description-container"),a=c.createElement("div",o,null,null);a.innerHTML=this.topRowText;let h=c.createElement("div",o,null,"mined-upgrade-button-description");h.innerHTML=this.bottomRowText;let m=this;this.mainElement.onclick=function(){console.log("MineModeOption click mode="+m.mineMode.id),m.mineControl.setModeActive(m.mineMode)},super.initializeView()}updateViewContents(){let e=this.mineControl.activeMode===this.mineMode;this.displayedActive!==e&&(this.displayedActive=e,e?this.mainElement.className="mine-mode-button-outer-active":this.mainElement.className="mine-mode-button-outer-not-active")}getVisibileDisplayValue(){return"inline-block"}};var oa=class extends J{constructor(e,t,i){super(e,"mineControl"),this.addView(new oi(this.elementId,this.elementId+"_up",t,Ue.MINE_SHALLOWER,"Mine","Shallower")),this.addView(new oi(this.elementId,this.elementId+"_down",t,Ue.MINE_DEEPER,"Mine","Deeper")),this.addView(new oi(this.elementId,this.elementId+"_current",t,Ue.MINE_CURRENT,"Mine","Current")),this.addView(new oi(this.elementId,this.elementId+"_auto",t,Ue.MINE_AUTO,"Mine","Auto")),this.addView(new ra(this.elementId,i))}initializeView(){let e=c.getElement(this.parentId);c.createElement("div",e,this.getElementId(),"mine-control-panel"),super.initializeView()}getVisibileDisplayValue(){return"inline-block"}};var na=class extends J{constructor(e,t,i,s){super(e,t),this.addView(new oa(t,i,s))}initializeView(){let e=c.getElement(this.parentId);c.createElement("div",e,this.getElementId(),"bottom-row-mine-control"),super.initializeView()}};var aa=class extends J{constructor(e,t,i,s,r,o,a,h,m,p){super(e,t),this.addView(new na(t,"bottomRowMineControl",o,r)),this.addView(new sa(t,"bottomRowDamage",i,s,r)),this.addView(new Yn(t,"bottomRowButtonContainer",h,m))}initializeView(){let e=c.getElement(this.parentId);c.createElement("div",e,this.getElementId(),"bottom-row"),super.initializeView()}};var la=class extends z{constructor(e){super(e,e+"_title")}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,null,"game-title-container"),i=c.createElement("div",t,null,"game-title-body"),s=c.createElement("div",i,null,"game-title-display");s.innerHTML="Mining";let r=c.createElement("div",i,null,"game-title-display");r.innerHTML="Crew",super.initializeView()}};var yt=class extends z{constructor(e,t,i,s,r){super(e,t),this.title=i,this.iconFileName=s,this.totals=r,this.displayedDescription=null,this.valueElement=null,this.setInitialVisibility(!0)}initializeView(){let e=this.getElementId(),t=c.getElement(this.parentId);if(!t){console.log("CurrencyContainerSectionView.initializeView() No parent element found! parentId="+this.parentId);return}let i=c.createElement("div",t,e,"currency-container-section"),s=c.createElement("div",i,null,"currency-container-body"),r=c.createElement("div",s,null,"icon-container"),o=c.createElement("img",r,null,"icon-container");o.src=this.iconFileName;let a=c.createElement("div",s,this.elementId+"_text","mined-upgrade-title-description-container"),h=c.createElement("div",a,null,null);h.innerHTML=this.title,this.valueElement=c.createElement("div",a,null,"mined-upgrade-button-description"),this.valueElement.innerHTML="",this.setInitialVisibility(!0),super.initializeView()}getVisibileDisplayValue(){return"inline-block"}};var da=class extends yt{constructor(e,t){super(e,e+"gold_section","Gold",u.currency.gold,t),this.displayedValue=new d(0),this.formattedValue=null}updateViewContents(){let e=this.totals.gold;(!this.formattedValue||!e.equals(this.displayedValue))&&(this.displayedValue.copy(e),this.formattedValue=I.formatBigNum(e),this.valueElement.innerHTML=this.formattedValue)}};var ha=class extends yt{constructor(e,t){super(e,e+"ruby_section","Ruby",u.currency.ruby,t),this.displayedValue=new d(0),this.formattedValue=null}updateViewContents(){let e=this.totals.ruby;(!this.formattedValue||!e.equals(this.displayedValue))&&(this.displayedValue.copy(e),this.formattedValue=I.formatBigNum(e),this.valueElement.innerHTML=this.formattedValue)}};var ua=class extends yt{constructor(e,t){super(e,e+"ore_section","Mined Ore",u.currency.ore,t),this.displayedValue=new d(0),this.formattedValue=null}updateViewContents(){let e=this.totals.ore;(!this.formattedValue||!e.equals(this.displayedValue))&&(this.displayedValue.copy(e),this.formattedValue=I.formatBigNum(e),this.valueElement.innerHTML=this.formattedValue)}};var ca=class extends yt{constructor(e,t){super(e,e+"prestige_section","Prestige",u.currency.prestige,t),this.displayedPrestige=new d(0),this.displayedUnclaimedPrestige=new d(0),this.formattedPrestigeValue=null}updateViewContents(){let e=this.totals.prestige,t=this.totals.unclaimedPrestige;(!this.formattedValue||!e.equals(this.displayedPrestige)||!t.equals(this.displayedUnclaimedPrestige))&&(this.displayedPrestige.copy(e),this.displayedUnclaimedPrestige.copy(t),t.equalsZero()?this.formattedValue=I.formatBigNum(e):this.formattedValue=I.formatBigNum(e)+" ("+I.formatBigNum(t)+")",this.valueElement.innerHTML=this.formattedValue)}};var ma=class extends J{constructor(e,t){super(e,ee.CURRENCY_VIEW),this.addView(new ua(this.elementId,t)),this.addView(new da(this.elementId,t)),this.addView(new ca(this.elementId,t)),this.addView(new ha(this.elementId,t)),this.setInitialVisibility(!0)}initializeView(){let e=c.getElement(this.parentId);c.createElement("div",e,this.getElementId(),"currency-container-view"),super.initializeView()}getVisibileDisplayValue(){return"inline-block"}};var pa=class extends J{constructor(e,t){super(e,e+"_one"),this.addView(new ma(this.elementId,t))}initializeView(){let e=c.getElement(this.parentId);c.createElement("div",e,this.getElementId(),"top-row-one"),super.initializeView()}};var ga=class extends z{constructor(e,t,i,s){super(e,t),this.partyTarget=i,this.statistics=s,this.displayedLayerDescription=null,this.mainElement=null,this.imgElement=null,this.titleElement=null,this.progressElement=null,this.displayedTitle=null,this.displayedDescription=null,this.descriptionElement=null,this.displayedIconFileName=null,this.displayPercent=-1,this.displayMaxDepth=-1}initializeView(){let e=this.getElementId(),t=c.getElement(this.parentId);if(!t){console.log("UnlockTerrainLayerView.initializeView() No parent element found! parentId="+this.parentId);return}this.mainElement=c.createElement("div",t,e,"terrain-layer-progress-outer");let i=c.createElement("div",this.mainElement,null,"mined-upgrade-button-body"),s=c.createElement("div",i,null,"icon-container"),r=c.createElement("div",i,this.elementId+"_text","mined-upgrade-title-description-container");this.imgElement=c.createElement("img",s,null,"icon-container"),this.imgElement.src=u.pick,this.titleElement=c.createElement("div",r,null,null),this.titleElement.innerHTML="",this.descriptionElement=c.createElement("div",r,null,"mined-upgrade-button-description"),this.descriptionElement.innerHTML="",this.progressElement=c.createElement("div",this.mainElement,null,"terrain-layer-progress-slider"),this.setInitialVisibility(!0),super.initializeView()}getVisibileDisplayValue(){return"inline-block"}generateDescription(){return"Depth: "+I.formatNumber(this.statistics.maxDepth)+" / "+I.formatNumber(this.displayedLayerDescription.maxDepth)}updateViewContents(){let e=this.partyTarget.layerDescription,t=this.partyTarget.nextLayerDescription,i=this.statistics.maxDepth;if(!t)return;if(this.displayedLayerDescription!==e||this.displayMaxDepth!=i){this.displayedLayerDescription=e,this.displayMaxDepth=i;let o=e.nominalIndex;o>0?this.titleElement.innerHTML=e.name+" ("+o+"/"+(et.length-2)+")":this.titleElement.innerHTML=e.name,this.descriptionElement.innerHTML=this.generateDescription()}if(!this.displayedLayerDescription)return;let s=this.displayedLayerDescription.iconFileName;this.displayedIconFileName!==s&&(this.displayedIconFileName=s,this.imgElement.src="images/layers/"+s);let r=e.getDepthPercent(i);r!=this.displayPercent&&(this.displayPercent=r,r>=100?this.progressElement.style.width="0px":this.progressElement.style.width=r+"%")}};var fa=class extends J{constructor(e,t,i){super(e,e+"_layer"),this.addView(new ga(this.elementId,this.elementId+"_progress",t,i))}initializeView(){let e=c.getElement(this.parentId);c.createElement("div",e,this.getElementId(),"top-row-two"),super.initializeView()}};var Ta=class extends J{constructor(e,t,i,s){super(e,e+"_panel"),this.addView(new pa(this.elementId,t)),this.addView(new fa(this.elementId,i,s))}initializeView(){let e=c.getElement(this.parentId);c.createElement("div",e,this.getElementId(),"top-row-panel"),super.initializeView()}};var Ea=class extends J{constructor(e,t,i,s,r){super(e,t),this.addView(new la(t)),this.addView(new Ta(t,i,s,r))}initializeView(){let e=c.getElement(this.parentId);c.createElement("div",e,this.getElementId(),"top-row"),super.initializeView()}};var Ca=class{constructor(){this.popupViews=[],this.popupById={}}addPopupView(e){this.popupViews.push(e),this.popupById[e.getElementId()]=e}isPopupVisible(e){let t=this.popupById[e];return t?t.isViewVisible():(console.log("PopupViewController.isPopupVisible() UNKNOWN VIEW. viewId="+e),!1)}setPopupVisible(e){for(let t=0;t<this.popupViews.length;t++){let i=this.popupViews[t];i.setViewVisible(i.getElementId()===e)}}setDoublePopupVisible(e,t){for(let i=0;i<this.popupViews.length;i++){let s=this.popupViews[i];s.setViewVisible(s.getElementId()===e||s.getElementId()===t)}}hideAllPopups(){for(let e=0;e<this.popupViews.length;e++)this.popupViews[e].setViewVisible(!1)}setPopupHidden(e){let t=this.popupById[e];if(!t){console.log("PopupViewController.setPopupHidden() UNKNOWN VIEW. viewId="+e);return}t.setViewVisible(!1)}};var Lt=class extends z{constructor(e,t,i,s,r){super(e,t),this.popupViewController=i,this.popupViewId=s,this.secondaryPopupViewId=null,this.title=r,this.mainElement=null,this.displayedVisible=!1}initializeView(){let e=this.getElementId(),t=c.getElement(this.parentId);if(!t){console.log("PopupViewToggle.initializeView() No parent element found! parentId="+this.parentId);return}this.mainElement=c.createElement("div",t,e,"upgrade-button-outer");let i=c.createElement("div",this.mainElement,null,"button-row-icon-text"),s=c.createElement("img",i,null,"pick-upgrade-icon");s.src=u.pick;let r=c.createElement("div",i,null,"pick-upgrade-title-description-container"),o=c.createElement("div",r,null,"pick-upgrade-button-title-single-row");o.innerHTML=this.title;let a=this;this.mainElement.onclick=function(){a.popupViewController.isPopupVisible(a.popupViewId)?a.popupViewController.hideAllPopups():a.secondaryPopupViewId?a.popupViewController.setDoublePopupVisible(a.popupViewId,a.secondaryPopupViewId):a.popupViewController.setPopupVisible(a.popupViewId)},super.initializeView()}updateViewContents(){let e=this.popupViewController.isPopupVisible(this.popupViewId);this.displayedVisible!==e&&(this.displayedVisible=e,e?this.mainElement.className="popup-toggle-button-outer-open":this.mainElement.className="upgrade-button-outer")}};var wa=class extends J{constructor(e,t){super(e,ee.CLOSE_SKILL_TREE_POPUP),this.addView(new Lt(this.elementId,this.elementId+"_skill",t,ee.SKILL_TREE_GRAPH,"Close Skill Tree"))}initializeView(){let e=c.getElement(this.parentId);c.createElement("div",e,this.getElementId(),"popup-window-close-skill-tree"),this.setInitialVisibility(!1),super.initializeView()}};var Sa=class extends z{constructor(e,t){super(e,ee.OFFLINE_POPUP),this.totals=t,this.container=null,this.offlineTimeInfo=null,this.prestigeEarnedInfo=null,this.goldEarnedInfo=null,this.oreEarnedInfo=null,this.rubyEarnedInfo=null,this.displayedPrestige=new d(-10),this.displayedGold=new d(-10),this.displayedOre=new d(-10),this.displayedRuby=new d(-10),this.displayedOfflineSeconds=0,this.working=new d(0),this.one=new d(1)}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,this.getElementId(),"popup-window-prestige"),i=c.createElement("div",t,null,null),s=c.createElement("div",i,null,"popup-window-header");s.innerHTML="Offline Progress";let r=this;s.onclick=function(){return r.totals.claimOfflineEarnings(),r.setViewVisible(!1),!1};let o=c.createElement("div",i,null,"menu-section-body");this.container=c.createElement("div",o,null,null);let a=c.createElement("div",this.container,null,"offline-info");a.innerHTML="You have offline earnings!",this.offlineTimeInfo=c.createElement("div",this.container,null,"offline-info"),this.offlineTimeInfo.innerHTML="",this.prestigeEarnedInfo=c.createElement("div",this.container,null,"offline-info"),this.prestigeEarnedInfo.innerHTML="",this.goldEarnedInfo=c.createElement("div",this.container,null,"offline-info"),this.goldEarnedInfo.innerHTML="",this.oreEarnedInfo=c.createElement("div",this.container,null,"offline-info"),this.oreEarnedInfo.innerHTML="",this.rubyEarnedInfo=c.createElement("div",this.container,null,"offline-info"),this.rubyEarnedInfo.innerHTML="";let h=c.createElement("div",this.container,null,"save-popup-button-row"),m=c.createElement("div",h,"prestigeButton","game-button prestige-button");m.style.marginTop="10px",m.innerHTML="Claim Earnings",m.onclick=function(){return r.totals.claimOfflineEarnings(),r.setViewVisible(!1),!1},this.setInitialVisibility(!1),super.initializeView()}getPrestigeRate(){return this.getRate(this.totals.prestigePerTurn)}getGoldRate(){return this.getRate(this.totals.goldPerTurn)}getOreRate(){return this.getRate(this.totals.orePerTurn)}getRubyRate(){return this.getRate(this.totals.rubyPerTurn)}getRate(e){return this.working.copy(e),this.working.mulNumber(n.time.turnsPerSecond),this.working.lessThan(this.one)?this.working.toNumber().toFixed(4)+" / second":I.formatBigNum(this.working)+" / second"}updateViewContents(){let e=this.totals.offlinePrestige,t=this.totals.offlineGold,i=this.totals.offlineOre,s=this.totals.offlineRuby,r=this.totals.countedOfflineSeconds;this.displayedOfflineSeconds!==r&&(this.displayedOfflineSeconds=r,this.offlineTimeInfo.innerHTML="Offline time: "+nt.formatElapsedTime(r*1e3)),this.displayedPrestige.equals(e)||(this.displayedPrestige.copy(e),this.prestigeEarnedInfo.innerHTML="Prestige earned: "+I.formatBigNum(e)+" ("+this.getPrestigeRate()+")"),this.displayedGold.equals(t)||(this.displayedGold.copy(t),this.goldEarnedInfo.innerHTML="Gold earned: "+I.formatBigNum(t)+" ("+this.getGoldRate()+")"),this.displayedOre.equals(i)||(this.displayedOre.copy(i),this.oreEarnedInfo.innerHTML="Ore earned: "+I.formatBigNum(i)+" ("+this.getOreRate()+")"),this.displayedRuby.equals(s)||(this.displayedRuby.copy(s),this.rubyEarnedInfo.innerHTML="Ruby earned: "+I.formatBigNum(s)+" ("+this.getRubyRate()+")")}};var Na=class extends z{constructor(e,t,i){super(e,t),this.performanceTrack=i,this.countSpan=null,this.averageSpan=null,this.totalSpan=null,this.displayedCount=-1,this.displayedAverage=-1,this.displayedTotal=-1}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,null,"performance-row"),i=c.createElement("span",t,null,null);i.innerHTML=this.performanceTrack.subject,this.countSpan=c.createElement("span",t,null,"performance-value"),this.countSpan.innerHTML="",this.averageSpan=c.createElement("span",t,null,"performance-value"),this.averageSpan.innerHTML="",this.totalSpan=c.createElement("span",t,null,"performance-value"),this.totalSpan.innerHTML="",this.setInitialVisibility(!0),super.initializeView()}updateViewContents(){let e=this.performanceTrack.count,t=this.performanceTrack.elapsed,i=e>0?t/e:0;this.displayedCount!=e&&(this.displayedCount=e,this.countSpan.innerHTML=I.formatNumber(e)),this.displayedAverage!=i&&(this.displayedAverage=i,this.averageSpan.innerHTML=I.formatNumber(i)),this.displayedTotal!=t&&(this.displayedTotal!=t,this.totalSpan.innerHTML=I.formatNumber(t)),super.updateViewContents()}};var Pa=class extends J{constructor(e){super(e,ee.PERFORMANCE_POPUP),this.container=null,this.contentElement=null,this.displayedContent=null,this.prevTimestamp=Date.now()-1e3,this.currentKeys={}}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,this.getElementId(),"popup-window-prestige"),i=c.createElement("div",t,null,null),s=c.createElement("div",i,null,"popup-window-header");s.innerHTML="Performance Info";let r=this;s.onclick=function(){return r.setViewVisible(!1),!1};let o=c.createElement("div",i,null,"menu-section-body");this.container=c.createElement("div",o,null,null),this.contentElement=c.createElement("div",this.container,"performanceContent","offline-info");let a=c.createElement("div",this.contentElement,null,"performance-row"),h=c.createElement("span",a,null,null);h.innerHTML="Activity";let m=c.createElement("span",a,null,"performance-value");m.innerHTML="Count";let p=c.createElement("span",a,null,"performance-value");p.innerHTML="Ave Millis";let f=c.createElement("span",a,null,"performance-value");f.innerHTML="Tot Millis";let S=c.createElement("div",this.container,null,"save-popup-button-row"),E=c.createElement("div",S,"resetButton","game-button prestige-button");E.style.marginTop="10px",E.innerHTML="Reset",E.onclick=function(){return ne.reset(),this.displayedContent=null,!1},this.setInitialVisibility(!1),super.initializeView()}updateViewContents(){let e=Date.now();if(e-this.prevTimestamp>1e3){this.prevTimestamp=e;let i=ne.getKeys();for(let s=0;s<i.length;s++){let r=i[s];if(!this.currentKeys[r]){this.currentKeys[r]=!0;let o=ne.getPerformanceTrack(r);if(o){let a=new Na("performanceContent","performanceContent_"+s,o);this.addView(a),a.initializeView()}else console.log("PerformanceMetricsPopupView.updateViewContents() failed to find: "+r)}}}super.updateViewContents()}};var Aa=class extends z{constructor(e,t,i){super(e,ee.PRESTIGE_POPUP),this.totals=t,this.gameStateControl=i,this.prestigeContainer=null,this.confirmContainer=null,this.prestigeEarnedInfo=null,this.prestigeEarnedInfo2=null,this.displayedPrestige=new d(0)}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,this.getElementId(),"popup-window-prestige"),i=c.createElement("div",t,null,null),s=c.createElement("div",i,null,"popup-window-header");s.innerHTML="Prestige";let r=this;s.onclick=function(){return r.setViewVisible(!1),!1};let o=c.createElement("div",i,null,"menu-section-body");this.prestigeContainer=c.createElement("div",o,null,null),this.confirmContainer=c.createElement("div",o,null,null),this.confirmContainer.style.display="none";let a=c.createElement("div",this.prestigeContainer,null,"prestige-info");a.innerHTML="Prestige the game and start over at the surface.",this.prestigeEarnedInfo=c.createElement("div",this.prestigeContainer,null,"prestige-info"),this.prestigeEarnedInfo.innerHTML=this.getEarnedPrestigeText(),this.displayedPrestige.copy(this.totals.unclaimedPrestige);let h=c.createElement("div",this.prestigeContainer,null,"prestige-info");h.innerHTML="You earn 1 prestige point per terrain layer cleared.";let m=c.createElement("div",this.prestigeContainer,null,"prestige-info");m.innerHTML="Spend your points on skills in the skill tree.";let p=c.createElement("div",this.prestigeContainer,null,"save-popup-button-row"),f=c.createElement("div",p,"prestigeButton","game-button prestige-button");f.style.marginTop="10px",f.innerHTML="Prestige Game",f.onclick=function(){return r.displayConfirmation(),!1};let S=c.createElement("div",this.confirmContainer,null,"prestige-info");S.innerHTML="Prestige Confirmation";let E=c.createElement("div",this.confirmContainer,null,"prestige-info");E.innerHTML="If you prestige you will be placed back on the surface.";let w=c.createElement("div",this.confirmContainer,null,"prestige-info");w.innerHTML="Your ore and mine power will be reset.";let C=c.createElement("div",this.confirmContainer,null,"prestige-info");C.innerHTML="Your can spend points to expand your crew and learn skills.",this.prestigeEarnedInfo2=c.createElement("div",this.confirmContainer,null,"prestige-info"),this.prestigeEarnedInfo2.innerHTML=this.getEarnedPrestigeText();let T=c.createElement("div",this.confirmContainer,null,"save-popup-button-row"),A=c.createElement("div",T,"cancelButton","game-button prestige-button");A.style.marginTop="10px",A.innerHTML="Cancel",A.onclick=function(){return r.onPrestigeCancel(),!1};let N=c.createElement("div",T,"realPrestigeButton","game-button prestige-button");N.style.marginTop="10px",N.innerHTML="Prestige Game",N.onclick=function(){return r.gameStateControl.prestigeGame(),!1},this.setInitialVisibility(!1),super.initializeView()}getEarnedPrestigeText(){return"Prestige points earned: "+I.formatBigNum(this.totals.unclaimedPrestige)}displayConfirmation(){c.hideElement(this.prestigeContainer),c.showElement(this.confirmContainer)}onPrestigeCancel(){c.hideElement(this.confirmContainer),c.showElement(this.prestigeContainer)}updateViewContents(){let e=this.totals.unclaimedPrestige;if(!this.displayedPrestige.equals(e)){this.displayedPrestige.copy(e);let t=this.getEarnedPrestigeText();this.prestigeEarnedInfo.innerHTML=t,this.prestigeEarnedInfo2.innerHTML=t}}};var Ma=class extends z{constructor(e,t){super(e,ee.SAVE_POPUP),this.gameStateControl=t,this.setCurrentlyVisible(!0),this.setViewVisible(!1)}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,this.elementId,"popup-window-save"),i=c.createElement("div",t,null,null),s=c.createElement("div",i,null,"popup-window-header");s.innerHTML="Save Controls",s.onclick=function(){return X.setViewVisible(!1),!1};let r=c.createElement("div",i,null,"menu-section-body"),o=c.createElement("div",r,"saveButtonsContainer","save-popup-buttons-container"),a=c.createElement("div",o,"exportSaveButton","game-button");a.innerHTML="Export Save";let h=c.createElement("div",o,"importSaveButton","game-button");h.innerHTML="Import Save";let m=c.createElement("div",o,"resetGameButton","game-button");m.innerHTML="Reset Game";let p=c.createElement("div",o,"deleteSaveButton","game-button");p.innerHTML="Delete Save";let f=c.createElement("div",r,"importContainer","save-popup-content-container");f.style.display="none";let S=c.createElement("div",f,null,null),E=c.createElement("textarea",S,"importTextArea","import-export-textarea");E.title="Paste exported save here and click import.";let w=c.createElement("div",S,null,"save-popup-button-row"),C=c.createElement("div",w,"importButtonActual","game-button save-button");C.innerHTML="Import";let T=c.createElement("div",w,"closeImportButton","game-button save-button");T.innerHTML="Close";let A=c.createElement("div",r,"exportContainer","save-popup-content-container");A.style.display="none";let N=c.createElement("div",A,null,null),P=c.createElement("textarea",N,"exportTextArea","import-export-textarea"),M=c.createElement("div",A,null,"save-popup-button-row"),y=c.createElement("div",M,"copyToClipboardButton","game-button save-button");y.style.width="130px",y.innerHTML="Copy to Clipboard";let V=c.createElement("div",M,"closeExportButton","game-button save-button");V.innerHTML="Close";let O=c.createElement("div",r,"resetConfirmationContainer","save-popup-content-container");O.style.display="none";let Z=c.createElement("div",O,null,null);Z.style.padding="10px",Z.innerHTML="Are you sure you want to reset? You will not lose your victory count.";let Q=c.createElement("div",O,null,"save-popup-button-row"),D=c.createElement("div",Q,"resetButtonActual","game-button save-button");D.innerHTML="Reset";let k=c.createElement("div",Q,"closeResetButton","game-button save-button");k.innerHTML="Close";let L=c.createElement("div",r,"deleteConfirmationContainer","save-popup-content-container");L.style.display="none";let b=c.createElement("div",L,null,null);b.style.padding="10px",b.innerHTML="Are you sure you want to delete? You will lose everything and start over.";let Ee=c.createElement("div",L,null,"save-popup-button-row"),pe=c.createElement("div",Ee,"deleteButtonActual","game-button save-button");pe.innerHTML="Delete";let _e=c.createElement("div",Ee,"closeDeleteButton","game-button save-button");_e.innerHTML="Close",this.setInitialVisibility(!1),super.initializeView();let X=this;this.saveTimeDiv=c.getElement("lastSaveTime"),this.displayedSaveTime=-1,a.onclick=function(){return X.displayExportSave(),!1},h.onclick=function(){return X.displayImportSave(),!1},T.onclick=function(){return X.closeImportContainer(),!1},C.onclick=function(){return X.handleImportSave(),!1},V.onclick=function(){return X.closeExportContainer(),!1},y.onclick=function(){P.select(),navigator.clipboard.writeText(P.value).then(()=>{console.log("clipboard successfully set")},()=>{console.error("clipboard write failed")})},m.onclick=function(){return X.displayResetConfirmation(),!1},p.onclick=function(){return X.displayDeleteConfirmation(),!1},D.onclick=function(){return X.handleGameReset(),!1},pe.onclick=function(){return X.handleGameDelete(),!1},k.onclick=function(){return X.closeResetConfirmation(),!1},_e.onclick=function(){return X.closeDeleteConfirmation(),!1}}displayExportSave(){c.hideElementId("saveButtonsContainer"),c.showElementId("exportContainer");var e=c.getElement("exportTextArea");let t=this.gameStateControl.getState();e.value=t.saveManager.getSaveStateForExport(t)}displayImportSave(){c.hideElementId("saveButtonsContainer"),c.showElementId("importContainer"),c.showElementId("importButtonActual")}closeImportContainer(){var e=c.getElement("importTextArea");e.value="",c.hideElementId("importContainer"),c.showElementIdWithValue("saveButtonsContainer","grid")}closeExportContainer(){var e=c.getElement("exportTextArea");e.value="",c.hideElementId("exportContainer"),c.showElementIdWithValue("saveButtonsContainer","grid")}handleImportSave(){console.log("SavePopupView.handleImportSave()");let e=c.getElement("importTextArea").value;this.gameStateControl.importSave(e)}handleGameReset(){this.gameStateControl.resetGame()}handleGameDelete(){this.gameStateControl.deleteGame()}displayResetConfirmation(){c.hideElementId("saveButtonsContainer"),c.showElementId("resetConfirmationContainer")}displayDeleteConfirmation(){c.hideElementId("saveButtonsContainer"),c.showElementId("deleteConfirmationContainer")}closeResetConfirmation(){c.hideElementId("resetConfirmationContainer"),c.showElementIdWithValue("saveButtonsContainer","grid")}closeDeleteConfirmation(){c.hideElementId("deleteConfirmationContainer"),c.showElementIdWithValue("saveButtonsContainer","grid")}};var ms=class extends z{constructor(e,t,i,s){super(e,t),this.statistics=i,this.headerText=s,this.displayedSeconds=-1,this.displayedTotalOre=new d(-1),this.displayedTotalGold=new d(-1),this.displayedTotalRuby=new d(-1),this.displayedTotalPrestigePoints=new d(-1),this.displayedUpgradeOre=new d(-1),this.displayedMaxDepth=-1,this.displayedTilesMined=new d(-1),this.displayedTilesMinedCommon=new d(-1),this.displayedTilesMinedOre=new d(-1),this.displayedTilesMinedGold=new d(-1),this.displayedTilesMinedRuby=new d(-1),this.displayedTilesMinedUpgrade=new d(-1),this.displayedTilesMinedLaser=new d(-1),this.displayedTilesMinedDrill=new d(-1),this.displayedTilesMinedOrbit=new d(-1),this.displayedTilesMinedMissile=new d(-1),this.totalTurnsElement=null,this.totalOreElement=null,this.totalGoldElement=null,this.totalRubyElement=null,this.totalPrestigePointsElement=null,this.upgradeOreElement=null,this.maxDepthElement=null,this.tilesMinedElement=null,this.tilesMinedCommonElement=null,this.tilesMinedOreElement=null,this.tilesMinedGoldElement=null,this.tilesMinedRubyElement=null,this.tilesMinedUpgradeElement=null,this.tilesMinedLaserElement=null,this.tilesMinedDrillElement=null,this.tilesMinedOrbitElement=null,this.tilesMinedMissileElement=null,this.setViewVisible(!1)}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,null,"stats-view"),i=c.createElement("div",t,null,"stats-header");i.innerHTML=this.headerText;let s=c.createElement("div",t,null,"menu-section-body");this.totalTurnsElement=this.createStatsSection(s,"Time","Time",!1),this.totalOreElement=this.createStatsSection(s,"Total Ore","Ore",!1),this.totalGoldElement=this.createStatsSection(s,"Total Gold","Gold",!1),this.totalRubyElement=this.createStatsSection(s,"Total Ruby","Ruby",!1),this.totalPrestigePointsElement=this.createStatsSection(s,"Total Prestige","Points",!1),this.maxDepthElement=this.createStatsSection(s,"Max Depth","Blocks",!1),this.upgradeOreElement=this.createStatsSection(s,"Upgrade Ore","Ore",!1),this.tilesMinedElement=this.createStatsSection(s,"Type: Any","Blocks",!0),this.tilesMinedCommonElement=this.createStatsSection(s,"Type: Common","Blocks",!1),this.tilesMinedOreElement=this.createStatsSection(s,"Type: Ore","Blocks",!1),this.tilesMinedGoldElement=this.createStatsSection(s,"Type: Gold","Blocks",!1),this.tilesMinedRubyElement=this.createStatsSection(s,"Type: Ruby","Blocks",!1),this.tilesMinedUpgradeElement=this.createStatsSection(s,"Type: Upgrade","Blocks",!1),this.tilesMinedLaserElement=this.createStatsSection(s,"Skill: Laser","Blocks",!0),this.tilesMinedDrillElement=this.createStatsSection(s,"Skill: Drill","Blocks",!1),this.tilesMinedOrbitElement=this.createStatsSection(s,"Skill: Orbit","Blocks",!1),this.tilesMinedMissileElement=this.createStatsSection(s,"Skill: Missile","Blocks",!1),this.setInitialVisibility(!0),super.initializeView()}createStatsSection(e,t,i,s){let r=c.createElement("div",e,null,"numbers-section-row");s&&(r.style.marginTop="10px");let o=c.createElement("div",r,null,"numbers-section-label");o.innerHTML=t;let a=c.createElement("div",r,null,"numbers-section-unit");return a.innerHTML=i,c.createElement("div",r,null,"numbers-section-value")}updateViewContents(){let e=this.statistics.totalTurns*n.time.secondsPerTurn|0;this.displayedSeconds!==e&&(this.displayedSeconds=e,this.totalTurnsElement.innerHTML=nt.formatElapsedTime(e*1e3));let t=this.statistics.totalOre;this.displayedTotalOre.equals(t)||(this.displayedTotalOre.copy(t),this.totalOreElement.innerHTML=I.formatBigNum(t));let i=this.statistics.totalGold;this.displayedTotalGold.equals(i)||(this.displayedTotalGold.copy(i),this.totalGoldElement.innerHTML=I.formatBigNum(i));let s=this.statistics.totalRuby;this.displayedTotalRuby.equals(s)||(this.displayedTotalRuby.copy(s),this.totalRubyElement.innerHTML=I.formatBigNum(s));let r=this.statistics.totalPrestigePoints;this.displayedTotalPrestigePoints.equals(r)||(this.displayedTotalPrestigePoints.compare(r),this.totalPrestigePointsElement.innerHTML=I.formatBigNum(r));let o=this.statistics.upgradeOre;this.displayedUpgradeOre.equals(o)||(this.displayedUpgradeOre.copy(o),this.upgradeOreElement.innerHTML=I.formatBigNum(o));let a=this.statistics.maxDepth;this.displayedMaxDepth!==a&&(this.displayedMaxDepth=a,this.maxDepthElement.innerHTML=I.formatNumber(a));let h=this.statistics.tilesMined;this.displayedTilesMined.equals(h)||(this.displayedTilesMined.copy(h),this.tilesMinedElement.innerHTML=I.formatBigNum(h));let m=this.statistics.tilesMinedCommon;this.displayedTilesMinedCommon.equals(m)||(this.displayedTilesMinedCommon.copy(m),this.tilesMinedCommonElement.innerHTML=I.formatBigNum(m));let p=this.statistics.tilesMinedOre;this.displayedTilesMinedOre.equals(p)||(this.displayedTilesMinedOre.copy(p),this.tilesMinedOreElement.innerHTML=I.formatBigNum(p));let f=this.statistics.tilesMinedGold;this.displayedTilesMinedGold.equals(f)||(this.displayedTilesMinedGold.copy(f),this.tilesMinedGoldElement.innerHTML=I.formatBigNum(f));let S=this.statistics.tilesMinedRuby;this.displayedTilesMinedRuby.equals(S)||(this.displayedTilesMinedRuby.copy(S),this.tilesMinedRubyElement.innerHTML=I.formatBigNum(S));let E=this.statistics.tilesMinedUpgrade;this.displayedTilesMinedUpgrade.equals(E)||(this.displayedTilesMinedUpgrade.copy(E),this.tilesMinedUpgradeElement.innerHTML=I.formatBigNum(E));let w=this.statistics.tilesMinedLaser;this.displayedTilesMinedLaser.equals(w)||(this.displayedTilesMinedLaser.copy(w),this.tilesMinedLaserElement.innerHTML=I.formatBigNum(w));let C=this.statistics.tilesMinedDrill;this.displayedTilesMinedDrill.equals(C)||(this.displayedTilesMinedDrill.copy(C),this.tilesMinedDrillElement.innerHTML=I.formatBigNum(C));let T=this.statistics.tilesMinedOrbit;this.displayedTilesMinedOrbit.equals(T)||(this.displayedTilesMinedOrbit.copy(T),this.tilesMinedOrbitElement.innerHTML=I.formatBigNum(T));let A=this.statistics.tilesMinedMissile;this.displayedTilesMinedMissile.equals(A)||(this.displayedTilesMinedMissile.copy(A),this.tilesMinedMissileElement.innerHTML=I.formatBigNum(A))}};var _a=class extends J{constructor(e,t,i){super(e,e+"_container");let s=this.getElementId();this.addView(new ms(s,s+"_run",t,"Current Run Statistics")),this.addView(new ms(s,s+"_global",i,"Cumulative Statistics"))}initializeView(){let e=c.getElement(this.parentId);c.createElement("div",e,this.getElementId(),"stats-container"),this.setInitialVisibility(!0),super.initializeView()}getVisibileDisplayValue(){return"grid"}};var Ra=class extends J{constructor(e,t,i){super(e,ee.STATISTICS_POPUP),this.addView(new _a(this.getElementId(),t,i))}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,this.getElementId(),"popup-window-statistics"),i=c.createElement("div",t,null,"popup-window-header");i.innerHTML="Statistics";let s=this;i.onclick=function(){return s.setViewVisible(!1),!1},this.setInitialVisibility(!1),super.initializeView()}};var ya=class extends J{constructor(e,t,i,s,r,o,a){super(e,t),this.totals=r,this.popupViewController=a;let h=new Ra(t,i,s),m=new Ma(t,o),p=new Aa(t,r,o),f=new wa(t,a),S=new Sa(t,r),E=new Pa(t);a.addPopupView(h),a.addPopupView(m),a.addPopupView(p),a.addPopupView(f),a.addPopupView(S),a.addPopupView(E),this.addView(h),this.addView(m),this.addView(p),this.addView(f),this.addView(S),this.addView(E)}initializeView(){let e=c.getElement(this.parentId);c.createElement("div",e,this.getElementId(),"popup-container"),super.initializeView()}updateView(){this.totals.countedOfflineSeconds>0&&!this.popupViewController.isPopupVisible(ee.OFFLINE_POPUP)&&this.popupViewController.setPopupVisible(ee.OFFLINE_POPUP),super.updateView()}};var Tt=class extends z{constructor(e,t,i){super(e,t),this.headerText=i,this.headerElement=null,this.setInitialVisibility(!0)}initializeView(){let e=c.getElement(this.parentId);if(!e){console.log("HeaderView.initializeView() No parent element found! parentId="+this.parentId);return}this.headerElement=c.createElement("div",e,this.elementId,"header-panel"),this.headerElement.innerHTML=this.headerText,super.initializeView()}};var jt=class extends z{constructor(e,t,i,s){super(e,t),this.headerText=i,this.automation=s,this.mainElement=null,this.activeProgressElement=null,this.titleElement=null,this.descriptionElement=null,this.displayedActive=s.active,this.displayedPercent=-1,this.setInitialVisibility(!0)}initializeView(){let e=c.getElement(this.parentId);if(!e){console.log("AutomationView.initializeView() No parent element found! parentId="+this.parentId);return}let t=this.automation.active?"automation-button-outer-active":"automation-button-outer-not-active";this.mainElement=c.createElement("div",e,this.elementId,t),this.activeProgressElement=c.createElement("div",this.mainElement,null,this.getProgressElementClassName());let i=c.createElement("div",this.mainElement,null,"active-skill-button-body"),s=c.createElement("div",i,null,"icon-container"),r=c.createElement("div",i,null,null),o=c.createElement("img",s,null,null);o.src=u.pick,this.titleElement=c.createElement("div",r,null,null),this.titleElement.innerHTML=this.headerText,this.descriptionElement=c.createElement("div",r,null,"skill-panel-row2-description"),this.descriptionElement.innerHTML=this.getDescription(),this.setInitialVisibility(!1);let a=this;this.mainElement.onclick=function(){a.automation.toggleActiveFlag()},super.initializeView()}getProgressElementClassName(){return"automation-progress-panel"}updateView(){let e=this.automation.isUnlocked();e!==this.isViewVisible()&&this.setViewVisible(e),super.updateView()}updateViewContents(){let e=this.automation.active;if(this.displayedActive!==e){this.displayedActive=e;let i=e?"automation-button-outer-active":"automation-button-outer-not-active";this.mainElement.className=i,this.descriptionElement.innerHTML=this.getDescription()}let t=this.automation.getActivationPercent();this.displayedPercent!==t&&(this.displayedPercent=t,this.activeProgressElement.style.width=t+"%")}getDescription(){return this.automation.active?"Active":"Not Active"}};var La=class extends jt{constructor(e,t,i,s){super(e,t,i,s),this.prestigeAutomation=s,this.displayedPrestigePossible=s.prestigePossible,this.displayedElapsedSeconds=-1,this.waitingDescription="Waiting..."}getProgressElementClassName(){return this.prestigeAutomation.prestigePossible?"automation-progress-panel":"prestige-automation-criteria-progress-panel"}updateViewContents(){let e=this.automation.active,t=this.prestigeAutomation.prestigePossible;if(this.displayedActive!==e){this.displayedActive=e;let i=e?"automation-button-outer-active":"automation-button-outer-not-active";this.mainElement.className=i,this.descriptionElement.innerHTML=this.getDescription()}if(e){if(this.displayedPrestigePossible!=t&&(this.displayedPrestigePossible=t,this.activeProgressElement.className=t?"automation-progress-panel":"prestige-automation-criteria-progress-panel",this.descriptionElement.innerHTML=this.getDescription()),!t){let s=this.prestigeAutomation.getElapsedTurnsSincePrestige(),r=s*n.time.secondsPerTurn|0;if(this.displayedElapsedSeconds!==r){this.displayedElapsedSeconds=r;let a=Math.max(0,n.automation.prestigeMinTurnsSinceLastChange-s)*n.time.millisPerTurn|0;this.descriptionElement.innerHTML="Layer Clear Countdown: "+nt.formatElapsedTimeNoHours(a)}}let i=t?this.automation.getActivationPercent():this.prestigeAutomation.getCriteriaPercent();this.displayedPercent!==i&&(this.displayedPercent=i,this.activeProgressElement.style.width=i+"%")}}getDescription(){return this.automation.active?this.prestigeAutomation.prestigePossible?"Active":"Waiting...":"Not Active"}};var ba=class extends z{constructor(e,t,i,s){super(e,t),this.title=i,this.gameOptions=s,this.mainElement=null,this.displayedEnabled=!1}initializeView(){let e=this.getElementId(),t=c.getElement(this.parentId);if(!t){console.log("GameOptionsToggle.initializeView() No parent element found! parentId="+this.parentId);return}this.mainElement=c.createElement("div",t,e,"upgrade-button-outer");let i=c.createElement("div",this.mainElement,null,"button-row-icon-text"),s=c.createElement("img",i,null,"pick-upgrade-icon");s.src=u.pick;let r=c.createElement("div",i,null,"pick-upgrade-title-description-container"),o=c.createElement("div",r,null,"pick-upgrade-button-title-single-row");o.innerHTML=this.title;let a=this;this.mainElement.onclick=function(){a.gameOptions.crewBrainDebugEnabled=!a.gameOptions.crewBrainDebugEnabled},super.initializeView()}updateViewContents(){let e=this.gameOptions.crewBrainDebugEnabled;this.displayedEnabled!==e&&(this.displayedEnabled=e,e?this.mainElement.className="popup-toggle-button-outer-open":this.mainElement.className="upgrade-button-outer")}};var Ia=class extends J{constructor(e,t,i,s){super(e,ee.MENU_PANEL),this.addView(new Tt(this.elementId,this.elementId+"_header","Menu")),this.addView(new Lt(this.elementId,this.elementId+"_prestige",t,ee.PRESTIGE_POPUP,"Prestige"));let r=new Lt(this.elementId,this.elementId+"_skill",t,ee.SKILL_TREE_GRAPH,"Skill Tree");r.secondaryPopupViewId=ee.CLOSE_SKILL_TREE_POPUP,this.addView(r),this.addView(new Lt(this.elementId,this.elementId+"_stats",t,ee.STATISTICS_POPUP,"Statistics View")),this.addView(new Lt(this.elementId,this.elementId+"_save",t,ee.SAVE_POPUP,"Save View")),this.addView(new Lt(this.elementId,this.elementId+"_performance",t,ee.PERFORMANCE_POPUP,"Performance View (Dev tool)")),this.addView(new ba(this.elementId,this.elementId+"_debug","Crew Brain Debug (Dev tool)",s)),this.addView(new La(this.elementId,this.elementId+"_auto_prestige","Auto Prestige",i))}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,this.elementId,null);t.style.display="none",this.setViewVisible(!1),this.setCurrentlyVisible(!0),super.initializeView()}};var xa=class extends z{constructor(e,t,i,s,r){super(e,t),this.tabContentsView=i,this.tabContainerView=s,this.tabIconPath=r,this.tabItem=null}getVisibileDisplayValue(){return"inline-block"}initializeView(){let e=this,t=this.getElementId(),i=c.getElement(this.parentId);this.tabItem=c.createElement("button",i,t,"upgrade-tab-menu-item");let s=c.createElement("img",this.tabItem,null,"icon-container");s.src=this.tabIconPath,this.tabItem.onclick=function(){e.tabContainerView.onTabItemViewClicked(e)},super.initializeView()}setTabSelected(e){e?this.tabItem.className="upgrade-tab-menu-item-selected":this.tabItem.className="upgrade-tab-menu-item"}};var Oa=class extends J{constructor(e){super(e,ee.PRIMARY_UPGRADE_PANEL_TAB_BAR),this.tabItemViews=[],this.setViewVisible(!0),this.setCurrentlyVisible(!1)}addPanelView(e,t){let i=e.elementId+"_tab",s=new xa(this.elementId,i,e,this,t);this.tabItemViews.push(s),this.addView(s)}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,this.getElementId(),"upgrade-tab-menu-bar");super.initializeView(),c.createElement("div",t,null,"upgrade-tab-menu-bar-fill-remaining"),this.tabItemViews.length>0&&this.onTabItemViewClicked(this.tabItemViews[0])}onTabItemViewClicked(e){for(let t=0;t<this.tabItemViews.length;t++){let i=this.tabItemViews[t],s=i===e;i.setTabSelected(s),i.tabContentsView.setViewVisible(s)}}getVisibileDisplayValue(){return"flex"}};var va=class extends z{constructor(e,t,i){super(e,t),this.upgradeCollection=i,this.purchaseOneButton=null,this.purchaseFiveButton=null,this.purchaseTenButton=null,this.purchaseMaxButton=null,this.displayedPurchaseCount=He.purchaseOne,this.setCurrentlyVisible(!1),this.setViewVisible(!0)}getVisibileDisplayValue(){return"grid"}initializeView(){super.initializeView();let e=this.getElementId(),t=c.getElement(this.parentId);if(!t){console.log("CountToPurchaseView.initializeView() No element found! id="+e);return}let i=c.createElement("div",t,e,"purchase-count-button-container");this.purchaseOneButton=c.createElement("div",i,e+"_one","purchase-count-button-selected"),this.purchaseFiveButton=c.createElement("div",i,e+"_five","purchase-count-button"),this.purchaseTenButton=c.createElement("div",i,e+"_ten","purchase-count-button"),this.purchaseMaxButton=c.createElement("div",i,e+"_max","purchase-count-button"),this.purchaseOneButton.innerHTML="1",this.purchaseFiveButton.innerHTML="5",this.purchaseTenButton.innerHTML="10",this.purchaseMaxButton.innerHTML="Max";let s=this;this.purchaseOneButton.onclick=function(){s.upgradeCollection.setCountToPurchase(He.purchaseOne)},this.purchaseFiveButton.onclick=function(){s.upgradeCollection.setCountToPurchase(He.purchaseFive)},this.purchaseTenButton.onclick=function(){s.upgradeCollection.setCountToPurchase(He.purchaseTen)},this.purchaseMaxButton.onclick=function(){s.upgradeCollection.setCountToPurchase(He.purchaseMax)}}updateViewContents(){let e=this.upgradeCollection.countToPurchase;this.displayedPurchaseCount!==e&&(this.displayedPurchaseCount===He.purchaseOne?this.purchaseOneButton.className="purchase-count-button":this.displayedPurchaseCount===He.purchaseFive?this.purchaseFiveButton.className="purchase-count-button":this.displayedPurchaseCount===He.purchaseTen?this.purchaseTenButton.className="purchase-count-button":this.displayedPurchaseCount===He.purchaseMax&&(this.purchaseMaxButton.className="purchase-count-button"),e===He.purchaseOne?this.purchaseOneButton.className="purchase-count-button-selected":e===He.purchaseFive?this.purchaseFiveButton.className="purchase-count-button-selected":e===He.purchaseTen?this.purchaseTenButton.className="purchase-count-button-selected":e===He.purchaseMax&&(this.purchaseMaxButton.className="purchase-count-button-selected"),this.displayedPurchaseCount=e)}};var Di=class extends z{constructor(e,t,i,s){super(e,t),this.upgrade=i,this.displayDescriptionRow=s,this.mainElement=null,this.titleElement=null,this.descriptionElement=null,this.costElement=null,this.displayedCost=new d(-10),this.countElement=null,this.displayedCount=-10,this.displayedNextActualPurchaseCount=-10,this.displayedTitle=null,this.displayedDescription=null,this.displayedPurchasable=!this.upgrade.isPurchasable()}setClassicUpgrade(e){this.upgrade=e}initializeView(){let e=this.getElementId(),t=c.getElement(this.parentId);if(!t){console.log("PickUpgradeView.initializeView() No parent element found! parentId="+this.parentId);return}this.displayedPurchasable=this.upgrade.isPurchasable();let i=this.displayedPurchasable?"upgrade-button-outer":"upgrade-button-outer-not-purchasable";this.mainElement=c.createElement("div",t,e,i);let s=c.createElement("div",this.mainElement,null,"pick-upgrade-button-row1"),r=c.createElement("img",s,null,"pick-upgrade-icon");r.src=u.pick;let o=c.createElement("div",s,null,"pick-upgrade-title-description-container");this.displayDescriptionRow?(this.titleElement=c.createElement("div",o,null,"pick-upgrade-button-title-double-row"),this.descriptionElement=c.createElement("div",o,null,"pick-upgrade-button-description"),this.descriptionElement.innerHTML=""):this.titleElement=c.createElement("div",o,null,"pick-upgrade-button-title-single-row"),this.titleElement.innerHTML="";let a=c.createElement("div",s,null,null);this.countElement=c.createElement("div",a,null,"pick-upgrade-count"),this.costElement=c.createElement("div",a,null,"pick-upgrade-cost"),this.setInitialVisibility(this.upgrade.isVisible());let h=this;this.mainElement.onclick=function(){h.upgrade.isPurchasable()&&h.upgrade.purchase()},super.initializeView()}updateView(){this.setViewVisible(this.upgrade&&this.upgrade.isVisible()),super.updateView()}updateViewContents(){let e=this.upgrade.getCost(),t=this.upgrade.purchasedCount,i=this.upgrade.isPurchasable(),s=this.upgrade.getCountToPurchaseSetting(),r=this.upgrade.nextActualPurchaseCount;e.equals(this.displayedCost)||(this.displayedCost.copy(e),this.costElement.innerHTML=I.formatBigNum(e)+" "+this.upgrade.getCostUnit()),(t!==this.displayedCount||r!==this.displayedNextActualPurchaseCount)&&(this.displayedCount=t,this.displayedNextActualPurchaseCount=r,s===He.purchaseOne?this.countElement.innerHTML=""+t:this.countElement.innerHTML=""+t+"+"+r);let o=this.upgrade.title;if(o!==this.displayedTitle&&(this.displayedTitle=o,this.titleElement.innerHTML=o),this.displayDescriptionRow){let a=this.upgrade.getDescription();a&&a!==this.displayedDescription&&(this.displayedDescription=a,this.descriptionElement.innerHTML=a)}i!==this.displayedPurchasable&&(this.displayedPurchasable=i,i?this.mainElement.className="upgrade-button-outer":this.mainElement.className="upgrade-button-outer-not-purchasable")}};var Bi=class extends J{constructor(e,t,i){super(e,t),this.upgradeCollection=i,this.upgradeViews=[],this.idSequence=0;let s=this.upgradeCollection.upgrades;for(let r=0;r<s.length;r++){let o=s[r];if(!o||!o.isVisible())continue;let a=this.createUpgradeView(s[r]);this.upgradeViews.push(a),this.addView(a)}}getNextId(){return++this.idSequence}initializeView(){let e=c.getElement(this.parentId);c.createElement("div",e,this.elementId,null),super.initializeView()}updateViewContents(){let e=this.upgradeCollection.upgrades,t=0,i=0;for(;t<e.length&&i<this.upgradeViews.length;t++){let s=e[t];!s||!s.isVisible()||(this.upgradeViews[i].setClassicUpgrade(s),i++)}if(t<e.length)for(;t<e.length;t++){let s=e[t];if(!s||!s.isVisible())continue;let r=this.createUpgradeView(e[t]);this.upgradeViews.push(r),this.addView(r),r.initializeView()}else if(i<this.upgradeViews.length)for(;i<this.upgradeViews.length;i++)this.upgradeViews[i].setClassicUpgrade(null);super.updateViewContents()}createUpgradeView(e){return new Di(this.elementId,this.elementId+"_"+this.getNextId(),e,!1)}};var Da=class extends J{constructor(e,t,i,s){super(e,t),this.addView(new Tt(this.elementId,this.elementId+"_header","Ore Upgrades")),this.addView(new Bi(this.elementId,this.elementId+"_upgrades",i)),this.addView(new Tt(this.elementId,this.elementId+"_settings_header","Purchase Settings")),this.addView(new va(this.elementId,this.elementId+"_ctp",i)),this.addView(new jt(this.elementId,this.elementId+"_auto","Auto Purchase",s))}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,this.elementId,"primary-upgrade-panel-body");t.style.display="none",this.setViewVisible(!1),this.setCurrentlyVisible(!0),super.initializeView()}};var Ba=class extends Bi{constructor(e,t,i){super(e,t,i)}createUpgradeView(e){return new Di(this.elementId,this.elementId+"_"+this.getNextId(),e,!0)}};var ka=class extends J{constructor(e,t,i){super(e,t),this.addView(new Tt(this.elementId,this.elementId+"_header","Gold Upgrades")),this.addView(new Ba(this.elementId,this.elementId+"_gold_upgrades",i))}initializeView(){let e=c.getElement(this.parentId),t=c.createElement("div",e,this.elementId,"primary-upgrade-panel-body");t.style.display="none",this.setInitialVisibility(!1),super.initializeView()}};var Fa=class extends z{constructor(e,t,i){super(e,t),this.titleDescriptionContainerId=t+"_text",this.minedUpgradeCollection=i,this.upgrade=null,this.mainElement=null,this.titleDescriptionContainer=null,this.imgElement=null,this.titleElement=null,this.displayedTitle=null,this.displayedDescription=null,this.descriptionElement=null,this.displayedIconFileName=null,this.displayedPurchasable=!0}setUpgrade(e){if(this.upgrade!==e)if(this.upgrade=e,e){let t=this.upgrade.getDescription();this.displayedDescription=null,t?this.descriptionElement||(this.descriptionElement=c.createElement("div",this.titleDescriptionContainer,null,"mined-upgrade-button-description"),this.descriptionElement.innerHTML="",this.titleElement.className="mined-upgrade-button-title-double-row"):(this.descriptionElement&&(c.removeElement(this.titleDescriptionContainerId,this.descriptionElement),this.descriptionElement=null),this.titleElement.className="mined-upgrade-button-title-single-row"),this.displayedPurchasable=!this.upgrade.isPurchasable(),this.setViewVisible(!0)}else this.setViewVisible(!1)}initializeView(){let e=this.getElementId(),t=c.getElement(this.parentId);if(!t){console.log("UpgradeView.initializeView() No parent element found! parentId="+this.parentId);return}this.mainElement=c.createElement("div",t,e,"upgrade-button-outer");let i=c.createElement("div",this.mainElement,null,"mined-upgrade-button-body"),s=c.createElement("div",i,null,"icon-container");this.titleDescriptionContainer=c.createElement("div",i,this.titleDescriptionContainerId,"mined-upgrade-title-description-container"),this.imgElement=c.createElement("img",s,null,null),this.imgElement.src=u.pick,this.titleElement=c.createElement("div",this.titleDescriptionContainer,null,"mined-upgrade-button-title-single-row"),this.titleElement.innerHTML="",c.hideElement(this.mainElement),this.setViewVisible(!1);let r=this;this.mainElement.onclick=function(){!r.upgrade||!r.upgrade.isPurchasable()||r.upgrade.purchase()&&(r.minedUpgradeCollection.remove(r.upgrade),r.upgrade=null,r.setViewVisible(!1))},super.initializeView()}updateViewContents(){if(!this.upgrade)return;let e=this.upgrade.title;e!==this.displayedTitle&&(this.displayedTitle=e,this.titleElement.innerHTML=e);let t=this.upgrade.getDescription();t&&t!==this.displayedDescription&&(this.displayedDescription=t,this.descriptionElement?this.descriptionElement.innerHTML=t:console.log("MinedUpgradeView.updateViewContents() null description element"));let i=this.upgrade.iconFileName;this.displayedIconFileName!==i&&(this.displayedIconFileName=i,this.imgElement.src=i);let s=this.upgrade.isPurchasable();this.displayedPurchasable!==s&&(this.displayedPurchasable=s,s?this.mainElement.className="upgrade-button-outer":this.mainElement.className="upgrade-button-outer-not-purchasable")}};var Ga=class extends J{constructor(e,t,i){super(e,t),this.minedUpgradeCollection=i,this.displayedChangeCount=-1,this.maxDisplayCount=15,this.upgradeViews=[],this.addView(new Tt(this.elementId,this.elementId+"_header","Mined Upgrades"));for(let s=0;s<this.maxDisplayCount;s++){let r=new Fa(t,t+"_"+s,i);this.upgradeViews.push(r),this.addView(r)}this.setCurrentlyVisible(!0)}initializeView(){let e=c.getElement(this.parentId);c.createElement("div",e,this.elementId,null),super.initializeView()}updateView(){super.updateView()}updateViewContents(){this.displayedChangeCount!==this.minedUpgradeCollection.changeCount&&(this.displayedChangeCount=this.minedUpgradeCollection.changeCount,this.updateUpgrades()),super.updateViewContents()}updateUpgrades(){let e=this.minedUpgradeCollection.upgrades,t=Math.min(e.length,this.maxDisplayCount),i=0;for(;i<t;i++)i<this.upgradeViews.length&&this.upgradeViews[i].setUpgrade(e[i]);for(;i<this.upgradeViews.length;i++)this.upgradeViews[i].setUpgrade(null)}};var Va=class extends J{constructor(e,t,i){super(e,ee.FREE_UPGRADES_PANEL),this.addView(new Ga(this.elementId,ee.MINED_UPGRADES_PANEL,t)),this.addView(new jt(this.elementId,this.elementId+"_auto","Auto Claim",i))}initializeView(){let e=c.getElement(this.parentId);c.createElement("div",e,this.elementId,"primary-upgrade-panel-body"),super.initializeView()}};var Ua=class extends J{constructor(e,t,i,s,r,o,a,h,m){super(e,ee.PRIMARY_UPGRADE_PANEL);let p=new Oa(this.elementId);this.addView(p);let f=new Va(this.elementId,t,i),S=new Da(this.elementId,ee.PICK_UPGRADES_PANEL,s,r),E=new ka(this.elementId,ee.GOLD_UPGRADES_PANEL,o),w=new Ia(this.elementId,h,a,m);this.addView(f),this.addView(S),this.addView(E),this.addView(w),p.addPanelView(f,u.currency.upgrades),p.addPanelView(S,u.currency.ore),p.addPanelView(E,u.currency.gold),p.addPanelView(w,u.pick),this.setViewVisible(!0),this.setCurrentlyVisible(!0)}initializeView(){let e=c.getElement(this.parentId);c.createElement("div",e,this.getElementId(),"primary-upgrade-panel"),super.initializeView()}getVisibileDisplayValue(){return"flex"}};var Ha=class extends J{constructor(e,t,i,s){super(e,ee.GAME_VIEW_OVERLAY_CONTAINER);let r=this.getElementId();this.addView(new Ea(r,"topRowContainer",t.totals,t.partyTarget,t.runStatistics)),this.addView(new zn(r,t.bonusCollection)),this.addView(new ya(r,"popupContainer",t.runStatistics,t.globalStatistics,t.totals,i,s)),this.addView(new Ua(r,t.minedUpgradeCollection,t.automationManager.minedUpgradeAutomation,t.pickUpgradeCollection,t.automationManager.pickUpgradeAutomation,t.goldUpgradeCollection,t.automationManager.prestigeAutomation,s,t.gameOptions)),this.addView(new aa(r,"bottomRowContainer",t.damage,t.values,t.partyTarget,t.mineControl,t.crew,t.projection,t.panAnimation,t.runStatistics))}initializeView(){let e=c.getElement(this.parentId);c.createElement("div",e,this.elementId,"view-overlay-container"),this.setInitialVisibility(!0),super.initializeView()}};var za=class extends z{constructor(e,t,i){super(e,e+"_"+t.id+"_"+i.id+"_con"),this.parentNode=t,this.childNode=i,this.originNode=this.getTopLeftNode(),this.mainElement=null,this.displayCoordinate=new v(0,0)}initializeView(){super.initializeView();let e=c.getElement(this.parentId);if(!e){console.log("NodeConnectionView.initializeView() No parent element found! parentId="+this.parentId);return}let t=this.isConnectionVertical(),i=this.isConnectionVertical()?"connection-vertical":"connection-horizontal";this.mainElement=c.createElement("div",e,this.elementId,i),t?this.mainElement.style.height=Math.abs(this.parentNode.graphCoordinate.y-this.childNode.graphCoordinate.y)+"px":this.mainElement.style.width=Math.abs(this.parentNode.graphCoordinate.x-this.childNode.graphCoordinate.x)+"px",this.setInitialVisibility(!0),this.updatePosition()}updateViewContents(){this.updatePosition()}updatePosition(){if(this.displayCoordinate.equals(this.originNode.viewCoordinate))return;this.displayCoordinate.copy(this.originNode.viewCoordinate);let e=n.skillGraph.connectorOffsetX,t=n.skillGraph.connectorOffsetY;this.mainElement.style.left=this.originNode.viewCoordinate.x+e+"px",this.mainElement.style.top=this.originNode.viewCoordinate.y+t+"px"}isConnectionVertical(){let e=this.originNode===this.childNode?this.parentNode:this.childNode,t=this.originNode.graphCoordinate,i=e.graphCoordinate;return t.x===i.x}getTopLeftNode(){let e=this.parentNode.graphCoordinate,t=this.childNode.graphCoordinate;return e.x===t.x?e.y<t.y?this.parentNode:this.childNode:e.y===t.y?e.x<t.x?this.parentNode:this.childNode:e.x<t.x?this.parentNode:this.childNode}};var ps=class extends z{constructor(e,t){super(e,e+"_"+t.id),this.node=t,this.mainElement=null,this.titleElement=null,this.displayedTitle=null,this.descriptionElement=null,this.displayedDescription=null,this.costElement=null,this.displayedCost=new d(-10),this.displayCoordinate=new v(0,0),this.displayedPurchaseState=0}getPurchaseStateValue(e,t){return t?2:e?1:0}initializeView(){super.initializeView();let e=this.getElementId(),t=this.node.description,i=c.getElement(this.parentId);if(!i){console.log("SkillNodeView.initializeView() No parent element found! parentId="+this.parentId);return}this.mainElement=c.createElement("div",i,e,"skill-tree-button-outer-not-purchasable"),this.displayedPurchaseState=-1;let s=c.createElement("div",this.mainElement,null,"skill-tree-button-row1"),r=c.createElement("img",s,null,"icon-container");r.src=this.node.iconFileName;let o=c.createElement("div",s,null,"pick-upgrade-title-description-container");this.titleElement=c.createElement("div",o,null,null),this.titleElement.innerHTML="",this.costElement=c.createElement("div",o,null,"pick-upgrade-button-title-double-row"),this.descriptionElement=c.createElement("div",this.mainElement,null,"skill-tree-button-description"),this.descriptionElement.innerHTML=t,this.displayedDescription=t;let a=this;this.mainElement.onclick=function(){a.node.isPurchasable()&&a.node.onPurchase()},this.setInitialVisibility(!1),this.updatePosition()}updateView(){this.setViewVisible(this.node.nodeVisible),super.updateView()}updateViewContents(){this.updatePosition();let e=this.node.getCost(),t=this.node.isPurchasable(),i=this.node.purchased,s=this.getPurchaseStateValue(t,i);e.equals(this.displayedCost)||(this.displayedCost.copy(e),this.costElement.innerHTML=I.formatBigNum(e)+" Prestige");let r=this.node.getTitle();r!==this.displayedTitle&&(this.displayedTitle=r,this.titleElement.innerHTML=r);let o=this.node.getDescription();o!==this.displayedDescription&&(this.displayedDescription=o,this.descriptionElement.innerHTML=o),this.displayedPurchaseState!==s&&(this.displayedPurchaseState=s,s===0?this.mainElement.className="skill-tree-button-outer-not-purchasable":s===1?this.mainElement.className="skill-tree-button-outer":this.mainElement.className="skill-tree-button-outer-purchased")}updatePosition(){this.displayCoordinate.equals(this.node.viewCoordinate)||(this.displayCoordinate.copy(this.node.viewCoordinate),this.mainElement.style.left=this.node.viewCoordinate.x+"px",this.mainElement.style.top=this.node.viewCoordinate.y+"px")}};var Wa=class extends J{constructor(e,t,i){super(e,ee.SKILL_TREE_GRAPH),this.skillTreeGraph=t,this.userInput=i,this.mainElement=null,this.displayCenterOffset=new v(-50,-50),this.displayedZoom=0;let s=this.skillTreeGraph.skills;for(let r=0;r<s.length;r++)this.addNodeConnectionViews(s[r].rootNode);for(let r=0;r<s.length;r++)this.addNodeAndChildViews(s[r].rootNode)}addNodeAndChildViews(e){let t=this.getElementId();this.addView(new ps(t,e));let i=e.children;if(!i)return;let s={},r=[];for(r.push(...i);r.length>0;){let o=r.shift();if(!s[o.id]&&(s[o.id]=!0,this.addView(new ps(t,o)),o.children))for(let a=0;a<o.children.length;a++){let h=o.children[a];s[h.id]||r.push(h)}}}addNodeConnectionViews(e){let t=this.getElementId(),i=[];i.push(e);let s={};for(;i.length>0;){let r=i.shift();if(s[r.id])continue;s[r.id]=!0;let o=r.children;if(o)for(let a=0;a<o.length;a++){let h=o[a];this.addView(new za(t,r,h)),!(s[h.id]||!h.children)&&i.push(h)}}}initializeView(){let e=c.getElement(this.parentId);this.mainElement=c.createElement("div",e,this.elementId,"skill-tree-graph"),this.setInitialVisibility(!1),this.userInput.attachListeners(document,this.mainElement),super.initializeView()}updateViewContents(){let e=!1,t=this.skillTreeGraph.zoom;this.displayedZoom!==t&&(this.mainElement.style.zoom=t+"%",this.displayedZoom=t,e=!0);let i=this.skillTreeGraph.centerOffset;this.displayCenterOffset.equals(i)||(this.displayCenterOffset.copy(i),e=!0),e&&this.updateNodeCoordinates(),super.updateViewContents()}updateNodeCoordinates(){let e=this.mainElement.clientWidth,t=this.mainElement.clientHeight,i=e/2,s=t/2,r=this.skillTreeGraph.centerOffset;for(let o=0;o<this.skillTreeGraph.skills.length;o++){let a=this.skillTreeGraph.skills[o];for(let h=0;h<a.nodes.length;h++){let m=a.nodes[h],p=i+r.x+m.graphCoordinate.x,f=s+r.y+m.graphCoordinate.y;m.viewCoordinate.set(p,f)}}}};var Ya=class extends J{constructor(e,t,i){super(null,ee.GAME_VIEW_CONTAINER),this.canvasView=null,this.skillTreeView=null,this.mineCanvasUserInput=t,this.skillTreeUserInput=i,this.gameStateControl=e}createChildren(e){let t=this.getElementId();this.removeChildViewElements(),c.clearChildren(t),this.canvasView=new Hn(t,e,this.mineCanvasUserInput),this.addView(this.canvasView),this.skillTreeView=new Wa(t,e.skillTreeGraph,this.skillTreeUserInput),this.addView(this.skillTreeView);let i=new Ca;i.addPopupView(this.skillTreeView),this.addView(new Ha(t,e,this.gameStateControl,i)),this.initializeView()}getCanvas(){return this.canvasView.getCanvas()}resetGameView(){this.removeAll()}};var Ka=class{constructor(e,t,i,s){this.userInput=e,this.projection=t,this.worldGrid=i,this.panAnimation=s,this.mapPanned=!1,this.mapPannedTime=0,this.delta=new v(0,0),this.screenCoordinate=new v(0,0),this.clickWorldCoordinate=new v(0,0),this.hoverWorldCoordinate=new v(0,0)}handleInput(){this.userInput.leftMouseClick?this.handleMouseClick():(this.handlePanning(),this.handleZoomInput())}resetInputHandler(){this.userInput.resetInputState()}handleMouseClick(){this.screenCoordinate.set(this.userInput.clickX,this.userInput.clickY),this.projection.screenToWorld(this.screenCoordinate,this.clickWorldCoordinate)}handlePanning(){this.userInput.leftMouseDown?(this.delta.x=this.userInput.mouseDeltaX,this.delta.y=this.userInput.mouseDeltaY):(this.delta.x*=n.input.panning.decayFactor,this.delta.y*=n.input.panning.decayFactor,Math.abs(this.delta.x)<1&&(this.delta.x=0),Math.abs(this.delta.y)<1&&(this.delta.y=0)),this.delta.x!==0||this.delta.y!==0?(this.mapPanned=!0,this.mapPannedTime=Date.now(),this.projection.updateSpaceCenter(this.projection.screenToWorldDistance(-this.delta.x),this.projection.screenToWorldDistance(-this.delta.y)),this.projection.stayCenteredOnCharacter=!1,this.panAnimation.animating=!1):this.mapPanned=!1}handleZoomInput(){var e=this.userInput.mouseWheelMotion;e<0?this.projection.zoomIn():e>0&&this.projection.zoomOut()}};var Xa=class{constructor(e,t){this.userInput=e,this.skillTreeGraph=t,this.mapPanned=!1,this.mapPannedTime=0,this.delta=new v(0,0)}handleInput(){this.userInput.leftMouseClick||(this.handlePanning(),this.handleZoomInput())}resetInputHandler(){this.userInput.resetInputState()}handlePanning(){this.userInput.leftMouseDown?(this.delta.x=this.userInput.mouseDeltaX,this.delta.y=this.userInput.mouseDeltaY):(this.delta.x*=n.input.panning.decayFactor,this.delta.y*=n.input.panning.decayFactor,Math.abs(this.delta.x)<1&&(this.delta.x=0),Math.abs(this.delta.y)<1&&(this.delta.y=0)),this.delta.x!==0||this.delta.y!==0?(this.mapPanned=!0,this.mapPannedTime=Date.now(),this.skillTreeGraph.updateCenter(this.delta.x,this.delta.y)):this.mapPanned=!1}handleZoomInput(){var e=this.userInput.mouseWheelMotion;e<0?this.skillTreeGraph.zoomIn():e>0&&this.skillTreeGraph.zoomOut()}};var ja=class{constructor(e,t){this.inputHandler=e,this.skillTreeInputHandler=t,this.elapsedTurnFrames=0,this.prevWorldGridShiftCount=-1,this.frameTimeRatio=1,this.turnStart=!1,this.lastSaveTime=Date.now(),this.workingGridCenter=new v(0,0),this.elapsedSaveThreshold=1e3*60*2;let i=this;this.performMonsterFrameActionsForGrid=function(s){let r=s.characters;for(let o=0;o<r.length;o++)r[o].isMonster()&&r[o].performFrameActions(i.frameTimeRatio,i.turnStart)},this.processMonsterTurnsForGrid=function(s){let r=s.characters;for(let o=0;o<r.length;o++){let a=r[o],h=a.position.tile;a.isMonster()&&h&&h.lighting.everVisibleToCharacter&&a.chooseTurn()}}}processFrameLogic(e,t){e.gameTime.frameNumber+=t,e.gameTime.frameNumber>1e10&&(e.gameTime.frameNumber=0),this.inputHandler.handleInput(),this.skillTreeInputHandler.handleInput();let i=!1;this.elapsedTurnFrames+=t,this.elapsedTurnFrames>=n.time.turnFrames&&(i=!0,this.elapsedTurnFrames-=n.time.turnFrames);let s=e.worldGrid.shiftCount;this.prevWorldGridShiftCount!==s&&(this.prevWorldGridShiftCount=s),i&&this.processTurnLogic(e),this.performCharacterActions(e,t,i),e.partyTarget.nextLayerDescription&&e.partyTarget.nextLayerDescription.minDepth<=e.runStatistics.maxDepth&&e.partyTarget.unlockNextLayer(),e.physicsManager.updatePhysicsForFrame(t),e.effectManager.updateEffectsForFrame(t),this.updateGridCenter(e,t),e.projection.updateProjectionForFrame(),e.gridLoadingManager.manageLoadedGridsForFrame(),i&&(this.updateDynamicLighting(e.lightingCalculator,e.crew,t),e.skillTreeGraph.updateSkillsForTurn()),e.skillTreeGraph.updateSkillsForFrame(t),e.sprites.spriteAnimationManager.updateForFrame(t),e.infoTextProcessor.updateTextForFrame(t);let r=Date.now();r-this.lastSaveTime>this.elapsedSaveThreshold&&(e.saveManager.saveGame(e),this.lastSaveTime=r)}updateDynamicLighting(e,t,i){ne.startTime("LightingReset"),e.resetForFrame(),ne.endTime("LightingReset");let s=t.miners;ne.startTime("DynamicLighting");for(let r=0;r<s.length;r++){let o=s[r].position.tile;o&&(r===0?e.calculatePrimaryPositionalLighting(o):e.calculateSecondaryPositionalLighting(o))}ne.endTime("DynamicLighting")}updateGridCenter(e,t){if(!e.panAnimation.animating&&!e.projection.stayCenteredOnCharacter&&Date.now()-this.inputHandler.mapPannedTime>1e3*10&&e.panAnimation.startAnimation(),e.panAnimation.animating){e.panAnimation.updateForFrame(t);return}e.projection.stayCenteredOnCharacter&&(e.crew.calculateCrewCenterCoordinate(this.workingGridCenter),e.projection.setGridCenter(this.workingGridCenter.x+n.tile.halfSize,this.workingGridCenter.y+n.tile.halfSize))}performCharacterActions(e,t,i){let s=e.crew.miners;for(let r=0;r<s.length;r++){let o=s[r];o.position.tile&&o.performFrameActions(t,i)}this.frameTimeRatio=t,this.turnStart=i,be.allVisibleGrids(e.worldGrid,e.projection,this.performMonsterFrameActionsForGrid)}validateCrewTiles(e,t){let i=t.calculateCrewCenterTile();if(!i)return!1;let s=t.miners;for(let r=0;r<s.length;r++){let o=s[r];if(!this.validateCharacterTile(e,o)){let h=pi.findAvailableNearbyTile(o,t,i);h?(console.log("FrameLogic.validateCrewTiles() moving miner to valid grid near crew center."),o.position.setTileAndOriginPosition(h,h.origin.x,h.origin.y)):console.log("FrameLogic.validateCrewTiles() failed to move miner near crew center")}}return!0}validateCharacterTile(e,t){let i=e.findGridTile(t.position.worldCoordinateOrigin);return t.position.tile?i&&i!==t.position.tile?(t.onInvalidGrid(),t.position.setTileAndOriginPosition(i,i.origin.x,i.origin.y),!0):i?!0:(t.onInvalidGrid(),!1):i?(t.onInvalidGrid(),t.position.setTileAndOriginPosition(i,i.origin.x,i.origin.y),!0):!1}processTurnLogic(e){if(e.gameTime.turnNumber++,e.statisticsIncrementor.incrementTurns(1),!this.validateCrewTiles(e.worldGrid,e.crew)){e.vectorField.reset();return}e.automationManager.updateForTurn(),e.mineControl.updateForTurn(),e.crewBrain.updateForTurn(),be.allVisibleGrids(e.worldGrid,e.projection,this.processMonsterTurnsForGrid)}};var Za=class{constructor(e,t,i,s){this.state=e,this.gameView=t,this.inputHandler=i,this.skillTreeInputHandler=s,this.prevTimeStamp=performance.now(),this.frameLogic=new ja(i,s);let r=this;this.gameLoopReference=function(){r.gameLoop()},this.fpsFrameCount=0,this.fpsMillis=0,this.offlineThresholdMillis=1e3*60*30,this.gameStateControl=null,this.callbackCode=-1,this.prevFrameVisible=!1,this.fpsIntervalMillis=1e3/150}requestGameStateCallback(e,t){this.gameStateControl=e,this.callbackCode=t}startGameLoop(){this.fpsFrameCount=0,this.fpsMillis=0,this.prevTimeStamp=performance.now(),window.requestAnimationFrame(this.gameLoopReference)}gameLoop(){window.requestAnimationFrame(this.gameLoopReference);let e=performance.now(),t=e-this.prevTimeStamp;if(t<this.fpsIntervalMillis)return;this.prevTimeStamp=e;let i=t>0?t:this.state.currentFps>0?1e3/this.state.currentFps:1e3/60;if(!this.state.gameVisible||!this.prevFrameVisible){let s=t/1e3|0;s>0&&(console.log("GameLoop.gameLoop() earned offline credit: "+nt.formatElapsedTime(s*1e3)),this.state.totals.offlineSeconds+=s),this.state.gameVisible&&!this.prevFrameVisible&&this.state.totals.offlineSeconds>0&&this.state.offlineLogic.calculateOfflineEarnings()}if(this.prevFrameVisible=this.state.gameVisible,this.gameStateControl)this.gameStateControl.modelLoadCallback(this.callbackCode),this.gameStateControl=null,this.callbackCode=0;else if(this.state.gameVisible&&!this.state.gamePaused){let s=i/n.time.defaultMillisPerFrame;this.frameLogic.processFrameLogic(this.state,s),this.gameView.updateView()}this.inputHandler.resetInputHandler(),this.skillTreeInputHandler.resetInputHandler(),this.fpsFrameCount++,this.fpsMillis+=t,this.fpsFrameCount>=60&&(this.state.currentFps=this.fpsFrameCount/(this.fpsMillis/1e3)|0,this.fpsFrameCount=0,this.fpsMillis=0)}};var qa=class extends Nn{constructor(){super(),this.state=new Un(this),this.mineCanvasUserInput=new us,this.skillTreeUserInput=new us,this.gameView=new Ya(this,this.mineCanvasUserInput,this.skillTreeUserInput),this.inputHandler=new Ka(this.mineCanvasUserInput,this.state.projection,this.state.worldGrid,this.state.panAnimation),this.skillTreeInputHandler=new Xa(this.skillTreeUserInput,this.state.skillTreeGraph),this.gameLoop=new Za(this.state,this.gameView,this.inputHandler,this.skillTreeInputHandler),this.started=!1,this.gameInitialized=!1,this.saveStateText=null}onVisibilityChange(e){this.state.gameVisible=e}onWindowResize(e,t){let i=this.gameView.getCanvas();i&&(i.width=e,i.height=t)}saveGame(){this.state.saveManager.saveGame(this.state)}getState(){return this.state}isStarted(){return this.started}startGame(){this.started||(this.gameInitialized||this.initialize(),this.gameLoop.startGameLoop(),this.started=!0)}initialize(){if(this.gameInitialized)return;this.state.sprites.isInitialized()||console.log("GameState.initialize() ERROR The sprites have not been initialed yet.");let e=this.state.saveManager.loadSave(this.state);this.state.initializeState(e),this.gameView.createChildren(this.state),this.gameInitialized=!0}prestigeGame(){this.gameLoop.requestGameStateCallback(this,this.CALLBACK_GAME_PRESTIGE)}resetGame(){this.gameLoop.requestGameStateCallback(this,this.CALLBACK_GAME_RESET)}deleteGame(){this.gameLoop.requestGameStateCallback(this,this.CALLBACK_GAME_DELETE)}importSave(e){this.saveStateText=e,this.gameLoop.requestGameStateCallback(this,this.CALLBACK_GAME_IMPORT)}modelLoadCallback(e){e===this.CALLBACK_GAME_RESET?this.resetInternal():e===this.CALLBACK_GAME_DELETE?this.deleteInternal():e===this.CALLBACK_GAME_IMPORT?this.importInternal():e===this.CALLBACK_GAME_PRESTIGE?this.prestigeInternal():console.log("GameState.modelLoadCallback(callbackCode) Invalid callback code: "+e)}resetInternal(){let e=this.state.saveManager;e.deleteSave(),this.state.resetForPrestige(),this.gameView.resetGameView(),this.gameView.createChildren(this.state),e.saveGame(this.state)}deleteInternal(){let e=this.state.saveManager;e.deleteSave(),this.state.resetFull(),this.gameView.resetGameView(),this.gameView.createChildren(this.state),e.saveGame(this.state)}prestigeInternal(){this.state.statisticsIncrementor.incrementPrestigePoints(this.state.totals.unclaimedPrestige),this.state.totals.onPrestige(),this.resetInternal()}importInternal(){console.log("GameState.importInternal() START");let e=this.state.saveManager,t=e.getSaveStateForExport(this.state);this.state.beforeImportSave(),e.importSave(this.state,this.saveStateText)||(console.log("GameState.importInternal() IMPORT FAILED. REVERTING TO PREV SAVE"),this.state.beforeImportSave(),e.importSave(this.state,t)),this.saveStateText=null,this.state.afterImportSave(),this.gameView.resetGameView(),this.gameView.createChildren(this.state),console.log("GameState.importInternal() DONE")}};var Ja=class{constructor(){this.gameState=new qa;let e=this;this.resourceLoadingLoop=function(){e.waitForResourcesToLoad()}}onResize(e){this.gameState.onWindowResize(e.innerWidth,e.innerHeight)}onVisibilityChange(){typeof document.hidden<"u"&&(console.log("Game.onVisibilityChange() hidden="+document.hidden),this.gameState.onVisibilityChange(!document.hidden))}onLoad(e,t){if(this.gameState.isStarted())return;console.log("Game.onLoad() Loading game.");let i=this;t.addEventListener("visibilitychange",function(s){i.onVisibilityChange()},!1),this.waitForResourcesToLoad()}onUnload(){console.log("Game.onUnload()"),this.gameState.saveGame()}waitForResourcesToLoad(){this.gameState.state.sprites.isInitialized()?(console.log("Game.waitForResourcesToLoad() Resources are loaded. Starting game."),this.gameState.startGame()):(console.log("Game.waitForResourcesToLoad() Resources not yet loaded. Waiting..."),window.requestAnimationFrame(this.resourceLoadingLoop))}};(()=>{let l=new Ja;window.onresize=function(){l.onResize(window)},window.onload=function(){l.onLoad(window,document)},window.onbeforeunload=function(){l.onUnload()}})();})();
//# sourceMappingURL=out.js.map
